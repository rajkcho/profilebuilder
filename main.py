"""
Orbital â€” M&A Intelligence Platform

Professional-grade company research platform with Sky.money-inspired UI.
Generates an 8-slide investment-banker-grade PowerPoint tear sheet.

Run:  streamlit run main.py

v6.5 - Full Feature Suite:
- Watchlist with session persistence & notes
- Excel/CSV export for all financial data
- DCF Valuation with sensitivity analysis
- Quick Compare mode with correlation matrix
- Merger Analysis with deal books
- Technical Analysis (RSI, MACD, Bollinger Bands)
- Options overview with put/call ratio
- Dividend analysis & financial health scorecard
- Institutional ownership breakdown
- Market sentiment gauge & sector heatmap
- Earnings calendar & news feed
- Search history & keyboard shortcuts
- Enhanced visualizations & print-friendly styles
"""

import streamlit as st
import plotly.graph_objects as go
import plotly.express as px
import pandas as pd
import numpy as np
import os
import random
import time
import json
import io
from datetime import datetime, timedelta
from dotenv import load_dotenv

load_dotenv()

from data_engine import (
    fetch_company_data, fetch_peer_data,
    format_number, format_pct, format_multiple,
    calculate_piotroski_score, calculate_intrinsic_value, get_key_ratios_summary,
    get_sector_benchmarks, discover_peers, get_upcoming_earnings, SECTOR_BENCHMARKS,
)
from ai_insights import generate_insights, generate_merger_insights
from pptx_generator import generate_presentation, generate_deal_book
from merger_analysis import MergerAssumptions, calculate_pro_forma, build_football_field
from comps_analysis import run_comps_analysis, generate_comps_table, format_comps_for_display, CompsAnalysis
import yfinance as yf

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WATCHLIST MANAGEMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _init_watchlist():
    """Initialize watchlist in session state."""
    if "watchlist" not in st.session_state:
        st.session_state.watchlist = []
    if "watchlist_data" not in st.session_state:
        st.session_state.watchlist_data = {}

def _add_to_watchlist(ticker: str):
    """Add a ticker to the watchlist."""
    _init_watchlist()
    ticker = ticker.upper().strip()
    if ticker and ticker not in st.session_state.watchlist:
        st.session_state.watchlist.append(ticker)
        # Fetch basic data
        info = _quick_ticker_lookup(ticker)
        if info.get("valid"):
            st.session_state.watchlist_data[ticker] = info
        return True
    return False

def _remove_from_watchlist(ticker: str):
    """Remove a ticker from the watchlist."""
    _init_watchlist()
    ticker = ticker.upper().strip()
    if ticker in st.session_state.watchlist:
        st.session_state.watchlist.remove(ticker)
        st.session_state.watchlist_data.pop(ticker, None)
        return True
    return False

def _is_in_watchlist(ticker: str) -> bool:
    """Check if ticker is in watchlist."""
    _init_watchlist()
    return ticker.upper().strip() in st.session_state.watchlist

def _get_watchlist() -> list:
    """Get current watchlist."""
    _init_watchlist()
    return st.session_state.watchlist

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VMS SCREENER UNIVERSE & DATA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VMS_UNIVERSE = [
    {"ticker": "OTEX.TO", "name": "Open Text Corp", "vertical": "Legal Tech", "geo": "North America"},
    {"ticker": "DSGX", "name": "Descartes Systems", "vertical": "Transportation", "geo": "North America"},
    {"ticker": "CSGP", "name": "CoStar Group", "vertical": "Real Estate Tech", "geo": "North America"},
    {"ticker": "ENV", "name": "Envestnet", "vertical": "Financial Services Tech", "geo": "North America"},
    {"ticker": "PCTY", "name": "Paylocity", "vertical": "Financial Services Tech", "geo": "North America"},
    {"ticker": "PAYC", "name": "Paycom Software", "vertical": "Financial Services Tech", "geo": "North America"},
    {"ticker": "GWRE", "name": "Guidewire Software", "vertical": "Financial Services Tech", "geo": "North America"},
    {"ticker": "BSY", "name": "Bentley Systems", "vertical": "Construction Tech", "geo": "North America"},
    {"ticker": "ALRM", "name": "Alarm.com", "vertical": "Real Estate Tech", "geo": "North America"},
    {"ticker": "CCSI", "name": "Consensus Cloud", "vertical": "Healthcare IT", "geo": "North America"},
    {"ticker": "POWI", "name": "Power Integrations", "vertical": "Utilities", "geo": "North America"},
    {"ticker": "TYLT.TO", "name": "Tyler Technologies", "vertical": "GovTech", "geo": "North America"},
    {"ticker": "TYL", "name": "Tyler Technologies", "vertical": "GovTech", "geo": "North America"},
    {"ticker": "SSNC", "name": "SS&C Technologies", "vertical": "Financial Services Tech", "geo": "North America"},
    {"ticker": "APPF", "name": "AppFolio", "vertical": "Real Estate Tech", "geo": "North America"},
    {"ticker": "PRGS", "name": "Progress Software", "vertical": "Education Tech", "geo": "North America"},
    {"ticker": "IIIV", "name": "i3 Verticals", "vertical": "Financial Services Tech", "geo": "North America"},
    {"ticker": "RNG", "name": "RingCentral", "vertical": "Utilities", "geo": "North America"},
    {"ticker": "ADSK", "name": "Autodesk", "vertical": "Construction Tech", "geo": "North America"},
    {"ticker": "POWL", "name": "Powell Industries", "vertical": "Utilities", "geo": "North America"},
]

@st.cache_data(ttl=600, show_spinner=False)
def _fetch_vms_screening_data(tickers_tuple):
    """Fetch financial data for VMS screening candidates."""
    results = []
    for item in tickers_tuple:
        try:
            t = yf.Ticker(item["ticker"])
            info = t.info or {}
            revenue = info.get("totalRevenue", 0) or 0
            ebitda = info.get("ebitda", 0) or 0
            rev_growth = info.get("revenueGrowth", None)
            ev = info.get("enterpriseValue", 0) or 0
            ebitda_margin = (ebitda / revenue * 100) if revenue > 0 else 0
            ev_rev = (ev / revenue) if revenue > 0 else 0
            ev_ebitda = (ev / ebitda) if ebitda > 0 else 0
            rev_growth_pct = (rev_growth * 100) if rev_growth is not None else 0
            # Rule of 40 = Revenue Growth % + EBITDA Margin %
            rule_of_40 = round(rev_growth_pct + ebitda_margin, 1)

            # Acquisition Attractiveness Score (0-100)
            _attr_score = 0
            # Recurring revenue / SaaS premium (up to 25 pts)
            _sector = (info.get("sector", "") or "").lower()
            _industry = (info.get("industry", "") or "").lower()
            if "software" in _industry or "saas" in _industry or "cloud" in _industry:
                _attr_score += 25
            elif "tech" in _sector:
                _attr_score += 15
            else:
                _attr_score += 8
            # Rule of 40 component (up to 25 pts)
            _attr_score += max(0, min(25, rule_of_40 * 0.625))
            # Market cap / revenue ratio - lower = cheaper = more attractive (up to 25 pts)
            mcap = info.get("marketCap", 0) or 0
            rev_m = revenue / 1e6 if revenue > 0 else 0
            if rev_m > 0:
                _ps = mcap / revenue
                _attr_score += max(0, min(25, (5 - _ps) * 5))
            # Revenue size sweet spot $5-200M (up to 25 pts)
            if 5 <= rev_m <= 200:
                _attr_score += 25
            elif rev_m < 5:
                _attr_score += max(0, rev_m * 5)
            else:
                _attr_score += max(0, 25 - (rev_m - 200) * 0.05)
            _attr_score = round(max(0, min(100, _attr_score)), 0)

            results.append({
                "Company": item["name"],
                "Ticker": item["ticker"],
                "Vertical": item["vertical"],
                "Geography": item["geo"],
                "Revenue ($M)": round(revenue / 1e6, 1),
                "EBITDA Margin (%)": round(ebitda_margin, 1),
                "Revenue Growth (%)": round(rev_growth_pct, 1),
                "EV/Revenue": round(ev_rev, 2),
                "EV/EBITDA": round(ev_ebitda, 1),
                "Rule of 40": rule_of_40,
                "Attractiveness": int(_attr_score),
            })
        except Exception:
            pass
    return results

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SEARCH HISTORY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _init_search_history():
    """Initialize search history in session state."""
    if "search_history" not in st.session_state:
        st.session_state.search_history = []

def _add_to_search_history(ticker: str):
    """Add a ticker to search history."""
    _init_search_history()
    ticker = ticker.upper().strip()
    if ticker:
        # Remove if already exists (to move to front)
        if ticker in st.session_state.search_history:
            st.session_state.search_history.remove(ticker)
        # Add to front
        st.session_state.search_history.insert(0, ticker)
        # Keep only last 10
        st.session_state.search_history = st.session_state.search_history[:10]

def _get_search_history() -> list:
    """Get search history."""
    _init_search_history()
    return st.session_state.search_history

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MARKET INDICES OVERVIEW
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
@st.cache_data(ttl=300, show_spinner=False)
def _fetch_market_indices() -> list:
    """Fetch major market indices data."""
    indices = [
        ("^GSPC", "S&P 500"),
        ("^DJI", "Dow Jones"),
        ("^IXIC", "NASDAQ"),
        ("^RUT", "Russell 2000"),
        ("^VIX", "VIX"),
        ("^GSPTSE", "TSX"),
    ]
    
    results = []
    for symbol, name in indices:
        try:
            tk = yf.Ticker(symbol)
            info = tk.info or {}
            price = info.get("regularMarketPrice") or info.get("previousClose") or 0
            change = info.get("regularMarketChange") or 0
            change_pct = info.get("regularMarketChangePercent") or 0
            results.append({
                "symbol": symbol,
                "name": name,
                "price": price,
                "change": change,
                "change_pct": change_pct,
            })
        except Exception:
            continue
    
    return results

def _render_market_ticker(indices: list):
    """Render a scrolling market ticker."""
    if not indices:
        return
    
    ticker_items = []
    for idx in indices:
        color = "#10B981" if idx["change_pct"] >= 0 else "#EF4444"
        arrow = "â–²" if idx["change_pct"] >= 0 else "â–¼"
        ticker_items.append(
            f'<span style="margin-right:2rem;">'
            f'<span style="color:#F9FAFB; font-weight:600;">{idx["name"]}</span> '
            f'<span style="color:{color};">{idx["price"]:,.2f} {arrow} {idx["change_pct"]:+.2f}%</span>'
            f'</span>'
        )
    
    # Duplicate for seamless scroll
    ticker_html = "".join(ticker_items) * 2
    
    st.markdown(
        f'<div style="overflow:hidden; background:rgba(37,99,235,0.05); '
        f'border-top:1px solid rgba(37,99,235,0.15); border-bottom:1px solid rgba(37,99,235,0.15); '
        f'padding:0.5rem 0; margin-bottom:1rem;">'
        f'<div style="display:inline-block; white-space:nowrap; animation:ticker-scroll 30s linear infinite;">'
        f'{ticker_html}'
        f'</div></div>',
        unsafe_allow_html=True,
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCREENER - Quick filter for stocks by criteria
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTOR_TICKERS = {
    "Technology": ["AAPL", "MSFT", "GOOGL", "META", "NVDA", "AMZN", "CRM", "ADBE", "INTC", "AMD", 
                   "CSCO", "ORCL", "IBM", "QCOM", "TXN", "AVGO", "NOW", "SHOP", "SNOW", "PLTR"],
    "Healthcare": ["JNJ", "UNH", "PFE", "ABBV", "MRK", "TMO", "ABT", "LLY", "BMY", "AMGN",
                   "GILD", "MDT", "CVS", "CI", "ISRG", "VRTX", "REGN", "ZTS", "BDX", "EW"],
    "Financials": ["JPM", "BAC", "WFC", "GS", "MS", "BLK", "C", "AXP", "SCHW", "USB",
                   "PNC", "TFC", "COF", "BK", "STT", "SPGI", "CME", "ICE", "MMC", "AON"],
    "Consumer": ["WMT", "PG", "KO", "PEP", "COST", "NKE", "MCD", "SBUX", "TGT", "HD",
                 "LOW", "TJX", "DG", "DLTR", "ROST", "YUM", "CMG", "DPZ", "EL", "CL"],
    "Industrials": ["CAT", "HON", "UNP", "UPS", "BA", "RTX", "DE", "GE", "LMT", "MMM",
                    "EMR", "ETN", "ITW", "PH", "ROK", "FDX", "CSX", "NSC", "WM", "RSG"],
    "Energy": ["XOM", "CVX", "COP", "SLB", "EOG", "OXY", "MPC", "VLO", "PSX", "DVN",
               "HAL", "BKR", "FANG", "HES", "PXD", "KMI", "WMB", "OKE", "TRGP", "LNG"],
}

@st.cache_data(ttl=300, show_spinner=False)
def _fetch_top_movers() -> dict:
    """Fetch top gainers and losers from major stocks."""
    major_stocks = [
        "AAPL", "MSFT", "GOOGL", "AMZN", "META", "NVDA", "TSLA", "BRK-B", "JPM", "V",
        "JNJ", "WMT", "PG", "MA", "UNH", "HD", "DIS", "PYPL", "NFLX", "ADBE",
        "CRM", "INTC", "AMD", "CSCO", "PFE", "ABT", "KO", "PEP", "MRK", "VZ"
    ]
    
    results = []
    for ticker in major_stocks[:20]:
        try:
            tk = yf.Ticker(ticker)
            info = tk.info or {}
            change_pct = info.get("regularMarketChangePercent") or 0
            price = info.get("currentPrice") or info.get("regularMarketPrice") or 0
            results.append({
                "ticker": ticker,
                "name": info.get("shortName", ticker)[:20],
                "price": price,
                "change_pct": change_pct,
            })
        except Exception:
            continue
    
    # Sort by change percentage
    gainers = sorted([r for r in results if r["change_pct"] > 0], 
                     key=lambda x: x["change_pct"], reverse=True)[:5]
    losers = sorted([r for r in results if r["change_pct"] < 0], 
                    key=lambda x: x["change_pct"])[:5]
    
    return {"gainers": gainers, "losers": losers}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SPARKLINE - Mini inline charts
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _render_sparkline_svg(values: list, color: str = "#2563EB", width: int = 80, height: int = 24) -> str:
    """Generate an SVG sparkline from a list of values."""
    if not values or len(values) < 2:
        return ""
    
    # Normalize values to fit in the height
    min_val = min(values)
    max_val = max(values)
    range_val = max_val - min_val if max_val != min_val else 1
    
    # Calculate points
    step = width / (len(values) - 1)
    points = []
    for i, v in enumerate(values):
        x = i * step
        y = height - ((v - min_val) / range_val * (height - 4) + 2)  # 2px padding
        points.append(f"{x:.1f},{y:.1f}")
    
    path = " ".join(points)
    
    # Determine if trend is up or down
    trend_color = "#10B981" if values[-1] > values[0] else "#EF4444" if values[-1] < values[0] else color
    
    return (
        f'<svg width="{width}" height="{height}" viewBox="0 0 {width} {height}" '
        f'style="display:inline-block; vertical-align:middle;">'
        f'<polyline fill="none" stroke="{trend_color}" stroke-width="2" '
        f'stroke-linecap="round" stroke-linejoin="round" points="{path}" '
        f'style="animation: sparklinePulse 2s ease-in-out infinite;"/>'
        f'<circle cx="{(len(values)-1)*step:.1f}" cy="{height - ((values[-1] - min_val) / range_val * (height - 4) + 2):.1f}" '
        f'r="3" fill="{trend_color}"/>'
        f'</svg>'
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STATUS BADGES - Colored status indicators
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _kpi_color(metric_name, value, sector=None):
    """Return (border_color, glow_color) for color-coded KPI cards.
    
    P/E: green < industry median, yellow within 20%, red > 20% above
    ROE: green > 15%, yellow 8-15%, red < 8%
    Debt/Equity: green < 0.5, yellow 0.5-1.5, red > 1.5
    EV/EBITDA: green < industry median, yellow within 20%, red > 20% above
    """
    _GREEN = ("rgba(16,185,129,0.4)", "rgba(16,185,129,0.08)")
    _YELLOW = ("rgba(245,166,35,0.4)", "rgba(245,166,35,0.08)")
    _RED = ("rgba(239,68,68,0.4)", "rgba(239,68,68,0.08)")
    _DEFAULT = ("rgba(37,99,235,0.15)", "transparent")
    if value is None:
        return _DEFAULT
    if metric_name in ("P/E (TTM)", "P/E"):
        _bench = get_sector_benchmarks(sector) if sector else None
        _med = _bench["pe"]["median"] if _bench else 20
        if value < _med:
            return _GREEN
        elif value < _med * 1.2:
            return _YELLOW
        return _RED
    elif metric_name == "EV/EBITDA":
        _bench = get_sector_benchmarks(sector) if sector else None
        _med = _bench["ev_ebitda"]["median"] if _bench else 12
        if value < _med:
            return _GREEN
        elif value < _med * 1.2:
            return _YELLOW
        return _RED
    elif metric_name == "ROE":
        roe_pct = value * 100 if abs(value) < 1 else value
        if roe_pct > 15:
            return _GREEN
        elif roe_pct >= 8:
            return _YELLOW
        return _RED
    elif metric_name in ("Debt/Equity", "D/E"):
        de = value / 100 if value > 5 else value
        if de < 0.5:
            return _GREEN
        elif de <= 1.5:
            return _YELLOW
        return _RED
    return _DEFAULT


def _render_status_badge(text: str, status: str = "neutral") -> str:
    """Render a colored status badge."""
    colors = {
        "positive": ("#10B981", "rgba(16,185,129,0.15)"),
        "negative": ("#EF4444", "rgba(239,68,68,0.15)"),
        "warning": ("#F5A623", "rgba(245,166,35,0.15)"),
        "neutral": ("#9CA3AF", "rgba(138,133,173,0.15)"),
        "info": ("#2563EB", "rgba(37,99,235,0.15)"),
    }
    text_color, bg_color = colors.get(status, colors["neutral"])
    
    return (
        f'<span style="display:inline-block; padding:0.25rem 0.6rem; border-radius:12px; '
        f'font-size:0.7rem; font-weight:600; letter-spacing:0.5px; '
        f'color:{text_color}; background:{bg_color}; '
        f'animation: badgePop 0.3s ease-out;">{text}</span>'
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KEYBOARD SHORTCUTS OVERLAY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _render_keyboard_shortcuts():
    """Render keyboard shortcuts help section."""
    shortcuts = [
        ("âŒ˜/Ctrl + K", "Quick search"),
        ("âŒ˜/Ctrl + B", "Toggle sidebar"),
        ("âŒ˜/Ctrl + D", "Download PPTX"),
        ("âŒ˜/Ctrl + E", "Export Excel"),
        ("âŒ˜/Ctrl + W", "Add to watchlist"),
        ("?", "Show shortcuts"),
    ]
    
    st.markdown(
        '<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
        'border-radius:12px; padding:1rem; margin:1rem 0;">'
        '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
        'letter-spacing:1px; margin-bottom:0.8rem;">âŒ¨ï¸ Keyboard Shortcuts</div>',
        unsafe_allow_html=True,
    )
    
    for key, desc in shortcuts:
        st.markdown(
            f'<div style="display:flex; justify-content:space-between; padding:0.3rem 0; '
            f'border-bottom:1px solid rgba(255,255,255,0.05);">'
            f'<kbd style="background:rgba(0,0,0,0.3); padding:0.2rem 0.5rem; border-radius:4px; '
            f'font-family:monospace; font-size:0.75rem; color:#F9FAFB;">{key}</kbd>'
            f'<span style="color:#D1D5DB; font-size:0.8rem;">{desc}</span>'
            f'</div>',
            unsafe_allow_html=True,
        )
    
    st.markdown('</div>', unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# METRIC CARD WITH SPARKLINE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _render_metric_with_sparkline(label: str, value: str, sparkline_data: list = None, 
                                   delta: str = None, delta_color: str = None):
    """Render a metric card with optional sparkline."""
    sparkline_html = ""
    if sparkline_data and len(sparkline_data) >= 2:
        sparkline_html = _render_sparkline_svg(sparkline_data)
    
    delta_html = ""
    if delta:
        d_color = delta_color or ("#10B981" if delta.startswith("+") else "#EF4444")
        delta_html = f'<span style="color:{d_color}; font-size:0.75rem; margin-left:0.5rem;">{delta}</span>'
    
    st.markdown(
        f'<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border:1px solid rgba(37,99,235,0.15); '
        f'border-radius:12px; padding:1rem; position:relative; overflow:hidden;">'
        f'<div style="font-size:0.7rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; '
        f'letter-spacing:0.5px; margin-bottom:0.3rem;">{label}</div>'
        f'<div style="display:flex; align-items:center; justify-content:space-between;">'
        f'<div style="font-size:1.3rem; font-weight:700; color:#F9FAFB;">{value}{delta_html}</div>'
        f'{sparkline_html}'
        f'</div></div>',
        unsafe_allow_html=True,
    )

def _render_movers_cards(movers: dict):
    """Render top gainers and losers cards."""
    if not movers or (not movers.get("gainers") and not movers.get("losers")):
        return
    
    st.markdown(
        '<div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem;">',
        unsafe_allow_html=True,
    )
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown(
            '<div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); '
            'border-radius:12px; padding:1rem;">'
            '<div style="font-size:0.75rem; font-weight:700; color:#10B981; text-transform:uppercase; '
            'letter-spacing:1px; margin-bottom:0.8rem;">ğŸš€ Top Gainers</div>',
            unsafe_allow_html=True,
        )
        for stock in movers.get("gainers", [])[:5]:
            st.markdown(
                f'<div style="display:flex; justify-content:space-between; padding:0.3rem 0; '
                f'border-bottom:1px solid rgba(255,255,255,0.05);">'
                f'<span style="color:#F9FAFB; font-weight:600;">{stock["ticker"]}</span>'
                f'<span style="color:#10B981; font-weight:700;">+{stock["change_pct"]:.2f}%</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
        st.markdown('</div>', unsafe_allow_html=True)
    
    with col2:
        st.markdown(
            '<div style="background:rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.2); '
            'border-radius:12px; padding:1rem;">'
            '<div style="font-size:0.75rem; font-weight:700; color:#EF4444; text-transform:uppercase; '
            'letter-spacing:1px; margin-bottom:0.8rem;">ğŸ“‰ Top Losers</div>',
            unsafe_allow_html=True,
        )
        for stock in movers.get("losers", [])[:5]:
            st.markdown(
                f'<div style="display:flex; justify-content:space-between; padding:0.3rem 0; '
                f'border-bottom:1px solid rgba(255,255,255,0.05);">'
                f'<span style="color:#F9FAFB; font-weight:600;">{stock["ticker"]}</span>'
                f'<span style="color:#EF4444; font-weight:700;">{stock["change_pct"]:.2f}%</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
        st.markdown('</div>', unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EARNINGS CALENDAR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
@st.cache_data(ttl=1800, show_spinner=False)
def _fetch_earnings_calendar() -> list:
    """Fetch upcoming earnings for popular tickers."""
    watchlist_tickers = ["AAPL", "MSFT", "GOOGL", "AMZN", "META", "NVDA", "TSLA", "JPM",
                         "V", "MA", "CRM", "ADBE", "NFLX", "DIS", "PYPL", "SQ", "SHOP",
                         "RY.TO", "TD.TO", "BNS.TO", "CSU.TO", "BAM.TO"]
    earnings = []
    now = datetime.now()
    
    for ticker in watchlist_tickers[:15]:  # Limit API calls
        try:
            tk = yf.Ticker(ticker)
            cal = tk.calendar
            if cal is not None and not (isinstance(cal, pd.DataFrame) and cal.empty):
                if isinstance(cal, dict):
                    ed = cal.get("Earnings Date")
                    if ed:
                        # ed can be a list of dates or a single date
                        if isinstance(ed, list) and len(ed) > 0:
                            earn_date = ed[0]
                        else:
                            earn_date = ed
                        if hasattr(earn_date, 'date'):
                            earn_date = earn_date.date() if hasattr(earn_date, 'date') else earn_date
                        earnings.append({
                            "ticker": ticker,
                            "date": str(earn_date),
                            "estimate_eps": cal.get("Earnings Average"),
                            "revenue_est": cal.get("Revenue Average"),
                        })
                elif isinstance(cal, pd.DataFrame):
                    if "Earnings Date" in cal.columns or "Earnings Date" in cal.index:
                        try:
                            ed = cal.loc["Earnings Date"] if "Earnings Date" in cal.index else None
                            if ed is not None:
                                earn_date = ed.iloc[0] if hasattr(ed, 'iloc') else ed
                                earnings.append({
                                    "ticker": ticker,
                                    "date": str(earn_date),
                                    "estimate_eps": None,
                                    "revenue_est": None,
                                })
                        except Exception:
                            pass
        except Exception:
            continue
    
    # Sort by date
    earnings.sort(key=lambda x: x["date"])
    return earnings


def _render_earnings_calendar(earnings: list):
    """Render an earnings calendar widget TradingView-style."""
    if not earnings:
        return
    
    st.markdown(
        '<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
        'border-radius:16px; padding:1.5rem; margin-top:1rem;">'
        '<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:1rem;">'
        '<span style="font-size:1.2rem;">ğŸ“…</span>'
        '<span style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
        'letter-spacing:1.5px;">Upcoming Earnings</span>'
        '</div>',
        unsafe_allow_html=True,
    )
    
    # Group by date
    from itertools import groupby
    for date_str, group in groupby(earnings[:12], key=lambda x: x["date"]):
        try:
            dt = datetime.strptime(date_str[:10], "%Y-%m-%d")
            date_label = dt.strftime("%b %d, %Y")
            day_name = dt.strftime("%A")
        except Exception:
            date_label = date_str
            day_name = ""
        
        st.markdown(
            f'<div style="font-size:0.7rem; color:#2563EB; font-weight:600; margin-top:0.8rem; '
            f'margin-bottom:0.3rem; padding-bottom:0.2rem; border-bottom:1px solid rgba(37,99,235,0.15);">'
            f'{day_name} â€” {date_label}</div>',
            unsafe_allow_html=True,
        )
        
        for item in group:
            eps_str = ""
            if item.get("estimate_eps"):
                eps_str = f'<span style="color:#9CA3AF; font-size:0.65rem;"> Est EPS: ${item["estimate_eps"]:.2f}</span>'
            st.markdown(
                f'<div style="display:flex; justify-content:space-between; align-items:center; '
                f'padding:0.35rem 0.5rem; border-radius:6px; margin:0.15rem 0; '
                f'background:rgba(255,255,255,0.02); transition:background 0.2s;">'
                f'<span style="color:#F9FAFB; font-weight:600; font-size:0.8rem;">{item["ticker"]}</span>'
                f'{eps_str}'
                f'</div>',
                unsafe_allow_html=True,
            )
    
    st.markdown('</div>', unsafe_allow_html=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NEWS FEED
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
@st.cache_data(ttl=900, show_spinner=False)
def _fetch_news_feed(tickers: list = None) -> list:
    """Fetch recent news for given tickers or market-wide."""
    if not tickers:
        tickers = ["AAPL", "MSFT", "NVDA", "GOOGL", "TSLA"]
    
    all_news = []
    seen_titles = set()
    
    for ticker in tickers[:5]:
        try:
            tk = yf.Ticker(ticker)
            news = tk.news or []
            for item in news[:3]:
                title = item.get("title", "")
                if title and title not in seen_titles:
                    seen_titles.add(title)
                    all_news.append({
                        "title": title,
                        "publisher": item.get("publisher", ""),
                        "link": item.get("link", ""),
                        "ticker": ticker,
                        "published": item.get("providerPublishTime", 0),
                        "type": item.get("type", ""),
                    })
        except Exception:
            continue
    
    # Sort by publish time descending
    all_news.sort(key=lambda x: x.get("published", 0), reverse=True)
    return all_news[:15]


def _render_news_feed(news: list):
    """Render a news feed widget."""
    if not news:
        return
    
    st.markdown(
        '<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
        'border-radius:16px; padding:1.5rem; margin-top:1rem;">'
        '<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:1rem;">'
        '<span style="font-size:1.2rem;">ğŸ“°</span>'
        '<span style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
        'letter-spacing:1.5px;">Market News</span>'
        '</div>',
        unsafe_allow_html=True,
    )
    
    for item in news[:10]:
        # Time ago
        time_str = ""
        if item.get("published"):
            try:
                delta = datetime.now() - datetime.fromtimestamp(item["published"])
                if delta.days > 0:
                    time_str = f'{delta.days}d ago'
                elif delta.seconds > 3600:
                    time_str = f'{delta.seconds // 3600}h ago'
                else:
                    time_str = f'{delta.seconds // 60}m ago'
            except Exception:
                pass
        
        link_html = f'href="{item["link"]}" target="_blank"' if item.get("link") else ""
        
        st.markdown(
            f'<a {link_html} style="display:block; padding:0.6rem 0.5rem; border-radius:8px; '
            f'margin:0.2rem 0; background:rgba(255,255,255,0.02); text-decoration:none; '
            f'transition:background 0.2s; border-bottom:1px solid rgba(255,255,255,0.03);">'
            f'<div style="font-size:0.78rem; color:#F9FAFB; font-weight:500; line-height:1.35;">{item["title"]}</div>'
            f'<div style="display:flex; justify-content:space-between; margin-top:0.25rem;">'
            f'<span style="font-size:0.65rem; color:#2563EB; font-weight:600;">{item["ticker"]}</span>'
            f'<span style="font-size:0.6rem; color:#9CA3AF;">{item.get("publisher", "")} Â· {time_str}</span>'
            f'</div>'
            f'</a>',
            unsafe_allow_html=True,
        )
    
    st.markdown('</div>', unsafe_allow_html=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WATCHLIST NOTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _init_watchlist_notes():
    """Initialize watchlist notes in session state."""
    if "watchlist_notes" not in st.session_state:
        st.session_state.watchlist_notes = {}


def _set_watchlist_note(ticker: str, note: str):
    """Set a note for a watchlist ticker."""
    _init_watchlist_notes()
    st.session_state.watchlist_notes[ticker.upper().strip()] = note


def _get_watchlist_note(ticker: str) -> str:
    """Get note for a watchlist ticker."""
    _init_watchlist_notes()
    return st.session_state.watchlist_notes.get(ticker.upper().strip(), "")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FEAR & GREED INDEX (Simplified Market Sentiment)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
@st.cache_data(ttl=1800, show_spinner=False)
def _calculate_market_sentiment() -> dict:
    """Calculate a simplified market sentiment score based on market data."""
    try:
        spy = yf.Ticker("SPY")
        hist = spy.history(period="1mo")
        if hist.empty:
            return {"score": 50, "label": "Neutral", "color": "#F59E0B"}
        
        # Simple sentiment factors
        current_price = hist["Close"].iloc[-1]
        sma_20 = hist["Close"].rolling(20).mean().iloc[-1]
        
        # Price vs SMA
        price_signal = (current_price / sma_20 - 1) * 100  # % above/below 20-day SMA
        
        # Recent momentum (5-day return)
        if len(hist) >= 5:
            momentum = (hist["Close"].iloc[-1] / hist["Close"].iloc[-5] - 1) * 100
        else:
            momentum = 0
        
        # Volatility (higher = more fearful)
        volatility = hist["Close"].pct_change().std() * 100
        vol_signal = max(0, 2 - volatility) * 25  # Lower vol = higher score
        
        # Combine signals (0-100 scale)
        raw_score = 50 + (price_signal * 5) + (momentum * 3) + (vol_signal - 25)
        score = max(0, min(100, raw_score))
        
        if score >= 80:
            return {"score": round(score), "label": "Extreme Greed", "color": "#10B981"}
        elif score >= 60:
            return {"score": round(score), "label": "Greed", "color": "#34D399"}
        elif score >= 40:
            return {"score": round(score), "label": "Neutral", "color": "#F59E0B"}
        elif score >= 20:
            return {"score": round(score), "label": "Fear", "color": "#F97316"}
        else:
            return {"score": round(score), "label": "Extreme Fear", "color": "#EF4444"}
    except Exception:
        return {"score": 50, "label": "Neutral", "color": "#F59E0B"}


def _render_sentiment_gauge(sentiment: dict):
    """Render a CNN-style fear & greed gauge."""
    score = sentiment["score"]
    label = sentiment["label"]
    color = sentiment["color"]
    
    # SVG gauge
    angle = (score / 100) * 180 - 90  # -90 to 90 degrees
    
    gauge_svg = f'''
    <div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15);
        border-radius:16px; padding:1.5rem; margin-top:1rem; text-align:center;">
        <div style="display:flex; align-items:center; justify-content:center; gap:0.5rem; margin-bottom:1rem;">
            <span style="font-size:1.2rem;">ğŸ¯</span>
            <span style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase;
            letter-spacing:1.5px;">Market Sentiment</span>
        </div>
        <svg viewBox="0 0 200 120" width="200" height="120" style="margin:0 auto; display:block;">
            <!-- Background arc -->
            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12" stroke-linecap="round"/>
            <!-- Colored segments -->
            <path d="M 20 100 A 80 80 0 0 1 52 40" fill="none" stroke="#EF4444" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
            <path d="M 52 40 A 80 80 0 0 1 100 20" fill="none" stroke="#F97316" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
            <path d="M 100 20 A 80 80 0 0 1 148 40" fill="none" stroke="#F59E0B" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
            <path d="M 148 40 A 80 80 0 0 1 180 100" fill="none" stroke="#10B981" stroke-width="12" stroke-linecap="round" opacity="0.6"/>
            <!-- Needle -->
            <line x1="100" y1="100" x2="{100 + 60 * np.cos(np.radians(angle + 180))}" y2="{100 + 60 * np.sin(np.radians(angle + 180))}"
                stroke="{color}" stroke-width="3" stroke-linecap="round"/>
            <circle cx="100" cy="100" r="5" fill="{color}"/>
        </svg>
        <div style="font-size:2rem; font-weight:800; color:{color}; margin-top:0.5rem;">{score}</div>
        <div style="font-size:0.85rem; font-weight:700; color:{color}; text-transform:uppercase; letter-spacing:1px;">{label}</div>
        <div style="font-size:0.6rem; color:#9CA3AF; margin-top:0.3rem;">Based on SPY momentum, trend & volatility</div>
    </div>
    '''
    st.markdown(gauge_svg, unsafe_allow_html=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTOR HEATMAP (TradingView-inspired)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
@st.cache_data(ttl=900, show_spinner=False)
def _fetch_sector_performance() -> list:
    """Fetch sector ETF performance for heatmap."""
    sector_etfs = {
        "Technology": "XLK",
        "Healthcare": "XLV",
        "Financials": "XLF",
        "Consumer Disc.": "XLY",
        "Consumer Stpl.": "XLP",
        "Energy": "XLE",
        "Industrials": "XLI",
        "Materials": "XLB",
        "Utilities": "XLU",
        "Real Estate": "XLRE",
        "Comm. Services": "XLC",
    }
    
    results = []
    for name, etf in sector_etfs.items():
        try:
            tk = yf.Ticker(etf)
            info = tk.info or {}
            change = info.get("regularMarketChangePercent") or 0
            results.append({"name": name, "etf": etf, "change_pct": change})
        except Exception:
            results.append({"name": name, "etf": etf, "change_pct": 0})
    
    return results


def _render_sector_heatmap(sectors: list):
    """Render a TradingView-style sector heatmap."""
    if not sectors:
        return
    
    st.markdown(
        '<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
        'border-radius:16px; padding:1.5rem; margin-top:1rem;">'
        '<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:1rem;">'
        '<span style="font-size:1.2rem;">ğŸ—ºï¸</span>'
        '<span style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
        'letter-spacing:1.5px;">Sector Performance</span>'
        '</div>'
        '<div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:0.5rem;">',
        unsafe_allow_html=True,
    )
    
    for sector in sectors:
        pct = sector["change_pct"]
        if pct >= 2:
            bg = "rgba(16,185,129,0.35)"
        elif pct >= 0.5:
            bg = "rgba(16,185,129,0.2)"
        elif pct >= 0:
            bg = "rgba(16,185,129,0.08)"
        elif pct >= -0.5:
            bg = "rgba(239,68,68,0.08)"
        elif pct >= -2:
            bg = "rgba(239,68,68,0.2)"
        else:
            bg = "rgba(239,68,68,0.35)"
        
        color = "#10B981" if pct >= 0 else "#EF4444"
        arrow = "â–²" if pct >= 0 else "â–¼"
        
        st.markdown(
            f'<div style="background:{bg}; border-radius:10px; padding:0.7rem 0.5rem; text-align:center; '
            f'border:1px solid rgba(255,255,255,0.05);">'
            f'<div style="font-size:0.65rem; color:#C4BFE0; font-weight:600; white-space:nowrap; '
            f'overflow:hidden; text-overflow:ellipsis;">{sector["name"]}</div>'
            f'<div style="font-size:0.95rem; font-weight:800; color:{color}; margin-top:0.2rem;">'
            f'{arrow} {pct:+.2f}%</div>'
            f'</div>',
            unsafe_allow_html=True,
        )
    
    st.markdown('</div></div>', unsafe_allow_html=True)


@st.cache_data(ttl=600, show_spinner=False)
def _screen_sector(sector: str, sort_by: str = "market_cap", top_n: int = 10) -> list:
    """Screen stocks in a sector by various criteria."""
    tickers = SECTOR_TICKERS.get(sector, [])
    results = []
    
    for ticker in tickers[:20]:  # Limit API calls
        try:
            tk = yf.Ticker(ticker)
            info = tk.info or {}
            results.append({
                "ticker": ticker,
                "name": info.get("shortName", ticker)[:30],
                "price": info.get("currentPrice") or info.get("regularMarketPrice") or 0,
                "market_cap": info.get("marketCap") or 0,
                "pe_ratio": info.get("trailingPE") or 0,
                "change_pct": info.get("regularMarketChangePercent") or 0,
            })
        except Exception:
            continue
    
    # Sort by specified criteria
    if sort_by == "market_cap":
        results.sort(key=lambda x: x["market_cap"], reverse=True)
    elif sort_by == "pe_ratio":
        results.sort(key=lambda x: x["pe_ratio"] if x["pe_ratio"] > 0 else 9999)
    elif sort_by == "change_pct":
        results.sort(key=lambda x: x["change_pct"], reverse=True)
    
    return results[:top_n]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXCEL/CSV EXPORT UTILITIES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _export_to_excel(cd) -> bytes:
    """Export company data to Excel with multiple sheets."""
    output = io.BytesIO()
    
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        # Summary sheet
        summary_data = {
            'Metric': ['Company Name', 'Ticker', 'Sector', 'Industry', 'Market Cap', 
                      'Enterprise Value', 'Current Price', 'P/E Ratio', 'Forward P/E',
                      'EV/EBITDA', 'EV/Revenue', 'Gross Margin', 'Operating Margin',
                      'Net Margin', 'ROE', 'ROA', 'Debt/Equity', 'Current Ratio'],
            'Value': [cd.name, cd.ticker, cd.sector, cd.industry, 
                     format_number(cd.market_cap, currency_symbol=cd.currency_symbol),
                     format_number(cd.enterprise_value, currency_symbol=cd.currency_symbol),
                     f"{cd.currency_symbol}{cd.current_price:,.2f}",
                     format_multiple(cd.trailing_pe), format_multiple(cd.forward_pe),
                     format_multiple(cd.ev_to_ebitda), format_multiple(cd.ev_to_revenue),
                     format_pct(cd.gross_margins), format_pct(cd.operating_margins),
                     format_pct(cd.profit_margins), format_pct(cd.return_on_equity),
                     format_pct(cd.return_on_assets), format_multiple(cd.debt_to_equity),
                     format_multiple(cd.current_ratio)]
        }
        pd.DataFrame(summary_data).to_excel(writer, sheet_name='Summary', index=False)
        
        # Income Statement
        if cd.revenue is not None and len(cd.revenue) > 0:
            income_data = {'Year': [str(idx.year) if hasattr(idx, 'year') else str(idx) for idx in cd.revenue.index]}
            income_data['Revenue'] = cd.revenue.values
            if cd.gross_profit is not None:
                income_data['Gross Profit'] = cd.gross_profit.values[:len(cd.revenue)]
            if cd.operating_income is not None:
                income_data['Operating Income'] = cd.operating_income.values[:len(cd.revenue)]
            if cd.net_income is not None:
                income_data['Net Income'] = cd.net_income.values[:len(cd.revenue)]
            if cd.ebitda is not None:
                income_data['EBITDA'] = cd.ebitda.values[:len(cd.revenue)]
            pd.DataFrame(income_data).to_excel(writer, sheet_name='Income Statement', index=False)
        
        # Balance Sheet
        if cd.total_assets is not None and len(cd.total_assets) > 0:
            bs_data = {'Year': [str(idx.year) if hasattr(idx, 'year') else str(idx) for idx in cd.total_assets.index]}
            bs_data['Total Assets'] = cd.total_assets.values
            if cd.total_equity is not None:
                bs_data['Total Equity'] = cd.total_equity.values[:len(cd.total_assets)]
            if cd.total_debt is not None:
                bs_data['Total Debt'] = cd.total_debt.values[:len(cd.total_assets)]
            if cd.cash_and_equivalents is not None:
                bs_data['Cash'] = cd.cash_and_equivalents.values[:len(cd.total_assets)]
            pd.DataFrame(bs_data).to_excel(writer, sheet_name='Balance Sheet', index=False)
        
        # Cash Flow
        if cd.operating_cashflow_series is not None and len(cd.operating_cashflow_series) > 0:
            cf_data = {'Year': [str(idx.year) if hasattr(idx, 'year') else str(idx) for idx in cd.operating_cashflow_series.index]}
            cf_data['Operating Cash Flow'] = cd.operating_cashflow_series.values
            if cd.capital_expenditure is not None:
                cf_data['CapEx'] = cd.capital_expenditure.values[:len(cd.operating_cashflow_series)]
            if cd.free_cashflow_series is not None:
                cf_data['Free Cash Flow'] = cd.free_cashflow_series.values[:len(cd.operating_cashflow_series)]
            pd.DataFrame(cf_data).to_excel(writer, sheet_name='Cash Flow', index=False)
        
        # Key Ratios
        try:
            ratios_data = {
                'Ratio': ['Gross Margin', 'Operating Margin', 'Net Margin', 'ROE', 'ROA', 'ROIC',
                          'Current Ratio', 'Quick Ratio', 'Debt/Equity', 'Interest Coverage',
                          'Asset Turnover', 'Inventory Turnover', 'Revenue Growth', 'Earnings Growth',
                          'Dividend Yield', 'Payout Ratio', 'Beta'],
                'Value': [
                    format_pct(cd.gross_margins), format_pct(cd.operating_margins), format_pct(cd.profit_margins),
                    format_pct(cd.return_on_equity), format_pct(cd.return_on_assets),
                    format_pct(getattr(cd, 'return_on_invested_capital', None)),
                    format_multiple(cd.current_ratio), format_multiple(getattr(cd, 'quick_ratio', None)),
                    format_multiple(cd.debt_to_equity), format_multiple(getattr(cd, 'interest_coverage', None)),
                    format_multiple(getattr(cd, 'asset_turnover', None)),
                    format_multiple(getattr(cd, 'inventory_turnover', None)),
                    format_pct(cd.revenue_growth), format_pct(getattr(cd, 'earnings_growth', None)),
                    format_pct(cd.dividend_yield), format_pct(getattr(cd, 'payout_ratio', None)),
                    f"{cd.beta:.2f}" if cd.beta else "N/A",
                ]
            }
            pd.DataFrame(ratios_data).to_excel(writer, sheet_name='Key Ratios', index=False)
        except Exception:
            pass

        # Valuation Multiples
        try:
            val_data = {
                'Multiple': ['Trailing P/E', 'Forward P/E', 'PEG Ratio', 'Price/Book', 'Price/Sales',
                             'EV/Revenue', 'EV/EBITDA', 'EV/EBIT', 'Price/FCF', 'Dividend Yield'],
                'Value': [
                    format_multiple(cd.trailing_pe), format_multiple(cd.forward_pe),
                    format_multiple(getattr(cd, 'peg_ratio', None)), format_multiple(cd.price_to_book),
                    format_multiple(getattr(cd, 'price_to_sales', None)),
                    format_multiple(cd.ev_to_revenue), format_multiple(cd.ev_to_ebitda),
                    format_multiple(getattr(cd, 'ev_to_ebit', None)),
                    format_multiple(getattr(cd, 'price_to_fcf', None)),
                    format_pct(cd.dividend_yield),
                ]
            }
            pd.DataFrame(val_data).to_excel(writer, sheet_name='Valuation Multiples', index=False)
        except Exception:
            pass

        # Peer Comparison
        if cd.peer_data:
            peer_df = pd.DataFrame(cd.peer_data)
            peer_df.to_excel(writer, sheet_name='Peer Comparison', index=False)

        # Format headers on all sheets
        try:
            from openpyxl.styles import Font, PatternFill, Alignment, numbers
            header_font = Font(bold=True, color="FFFFFF", size=11)
            header_fill = PatternFill(start_color="6B5CE7", end_color="6B5CE7", fill_type="solid")
            for ws in writer.book.worksheets:
                for cell in ws[1]:
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.alignment = Alignment(horizontal="center")
                # Auto-width columns
                for col in ws.columns:
                    max_len = max((len(str(c.value or "")) for c in col), default=10)
                    ws.column_dimensions[col[0].column_letter].width = min(max_len + 4, 30)
        except Exception:
            pass
    
    return output.getvalue()


def _export_comps_to_excel(comps_analysis) -> bytes:
    """Export comps analysis to Excel with conditional formatting."""
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        comps_df = generate_comps_table(comps_analysis)
        comps_df.to_excel(writer, sheet_name='Comps Table', index=False)
        # Summary sheet
        tc = comps_analysis.target_comps
        summary = {
            'Metric': ['Target Company', 'Ticker', 'Sector', 'Industry', 'Peers Analyzed',
                       'Median EV/Revenue', 'Median EV/EBITDA', 'Median P/E'],
            'Value': [tc.name, tc.ticker, tc.sector, tc.industry, len(comps_analysis.peers),
                      f"{comps_analysis.median_ev_revenue:.1f}x" if hasattr(comps_analysis, 'median_ev_revenue') else "N/A",
                      f"{comps_analysis.median_ev_ebitda:.1f}x" if hasattr(comps_analysis, 'median_ev_ebitda') else "N/A",
                      f"{comps_analysis.median_pe:.1f}x" if hasattr(comps_analysis, 'median_pe') else "N/A"]
        }
        pd.DataFrame(summary).to_excel(writer, sheet_name='Summary', index=False)
        # Format
        try:
            from openpyxl.styles import Font, PatternFill, Alignment
            header_font = Font(bold=True, color="FFFFFF", size=11)
            header_fill = PatternFill(start_color="6B5CE7", end_color="6B5CE7", fill_type="solid")
            for ws in writer.book.worksheets:
                for cell in ws[1]:
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.alignment = Alignment(horizontal="center")
                for col in ws.columns:
                    max_len = max((len(str(c.value or "")) for c in col), default=10)
                    ws.column_dimensions[col[0].column_letter].width = min(max_len + 4, 30)
        except Exception:
            pass
    return output.getvalue()


def _export_dcf_to_excel(dcf_cd, dcf_result, assumptions) -> bytes:
    """Export DCF model to Excel."""
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        # Assumptions
        cs = dcf_cd.currency_symbol
        assumptions_data = {
            'Parameter': ['Company', 'Ticker', 'Current Price', 'Shares Outstanding',
                         'FCF Growth Rate', 'Terminal Growth Rate', 'Discount Rate (WACC)',
                         'Projection Years'],
            'Value': [dcf_cd.name, dcf_cd.ticker, f"{cs}{dcf_cd.current_price:,.2f}",
                     f"{dcf_result.get('shares_outstanding', 0):,.0f}",
                     f"{assumptions['growth_rate']*100:.1f}%", f"{assumptions['terminal_growth']*100:.1f}%",
                     f"{assumptions['discount_rate']*100:.1f}%", str(assumptions['years'])]
        }
        pd.DataFrame(assumptions_data).to_excel(writer, sheet_name='Assumptions', index=False)
        # Projected FCF
        years = list(range(1, dcf_result.get("projection_years", 5) + 1))
        proj_data = {
            'Year': years,
            'Projected FCF': dcf_result.get("projected_fcf", []),
            'PV of FCF': dcf_result.get("pv_fcf", []),
        }
        pd.DataFrame(proj_data).to_excel(writer, sheet_name='Projections', index=False)
        # Valuation Summary
        val_data = {
            'Component': ['PV of Projected FCFs', 'Terminal Value', 'PV of Terminal Value',
                         'Enterprise Value', 'Less: Net Debt', 'Equity Value',
                         'Implied Share Price', 'Current Price', 'Upside/Downside'],
            'Value': [
                f"{cs}{dcf_result.get('pv_fcf_total', 0):,.0f}",
                f"{cs}{dcf_result.get('terminal_value', 0):,.0f}",
                f"{cs}{dcf_result.get('pv_terminal_value', 0):,.0f}",
                f"{cs}{dcf_result.get('enterprise_value', 0):,.0f}",
                f"{cs}{dcf_result.get('net_debt', 0):,.0f}",
                f"{cs}{dcf_result.get('equity_value', 0):,.0f}",
                f"{cs}{dcf_result.get('implied_share_price', 0):,.2f}",
                f"{cs}{dcf_result.get('current_price', 0):,.2f}",
                f"{dcf_result.get('upside_pct', 0):+.1f}%",
            ]
        }
        pd.DataFrame(val_data).to_excel(writer, sheet_name='Valuation', index=False)
        # Format
        try:
            from openpyxl.styles import Font, PatternFill, Alignment
            header_font = Font(bold=True, color="FFFFFF", size=11)
            header_fill = PatternFill(start_color="6B5CE7", end_color="6B5CE7", fill_type="solid")
            for ws in writer.book.worksheets:
                for cell in ws[1]:
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.alignment = Alignment(horizontal="center")
                for col in ws.columns:
                    max_len = max((len(str(c.value or "")) for c in col), default=10)
                    ws.column_dimensions[col[0].column_letter].width = min(max_len + 4, 30)
        except Exception:
            pass
    return output.getvalue()

def _generate_pdf_html(cd) -> str:
    """Generate an HTML summary document that can be printed/saved as PDF."""
    cs = cd.currency_symbol
    _fetch_ts = datetime.now().strftime("%B %d, %Y at %H:%M UTC")

    # Key metrics
    metrics_rows = ""
    metric_list = [
        ("Market Cap", format_number(cd.market_cap, currency_symbol=cs)),
        ("Enterprise Value", format_number(cd.enterprise_value, currency_symbol=cs)),
        ("P/E (TTM)", f"{cd.trailing_pe:.1f}x" if cd.trailing_pe else "N/A"),
        ("Forward P/E", f"{cd.forward_pe:.1f}x" if cd.forward_pe else "N/A"),
        ("EV/EBITDA", f"{cd.ev_to_ebitda:.1f}x" if cd.ev_to_ebitda else "N/A"),
        ("EV/Revenue", f"{cd.ev_to_revenue:.1f}x" if cd.ev_to_revenue else "N/A"),
        ("P/B", f"{cd.price_to_book:.1f}x" if cd.price_to_book else "N/A"),
        ("Gross Margin", f"{cd.gross_margins*100:.1f}%" if cd.gross_margins else "N/A"),
        ("Operating Margin", f"{cd.operating_margins*100:.1f}%" if cd.operating_margins else "N/A"),
        ("Net Margin", f"{cd.profit_margins*100:.1f}%" if cd.profit_margins else "N/A"),
        ("ROE", f"{cd.return_on_equity*100:.1f}%" if cd.return_on_equity else "N/A"),
        ("Debt/Equity", f"{cd.debt_to_equity:.0f}%" if cd.debt_to_equity else "N/A"),
        ("Dividend Yield", f"{cd.dividend_yield*100:.2f}%" if cd.dividend_yield else "N/A"),
        ("Beta", f"{cd.beta:.2f}" if cd.beta else "N/A"),
        ("52-Week Range", f"{cs}{cd.fifty_two_week_low:,.2f} â€” {cs}{cd.fifty_two_week_high:,.2f}" if cd.fifty_two_week_low and cd.fifty_two_week_high else "N/A"),
    ]
    for name, val in metric_list:
        metrics_rows += f"<tr><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#D1D5DB; font-weight:600;'>{name}</td><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#F9FAFB; text-align:right;'>{val}</td></tr>"

    # Valuation summary
    valuation_html = ""
    try:
        from data_engine import calculate_intrinsic_value as _calc_iv
        iv = _calc_iv(cd)
        if iv:
            valuation_html = f"""
            <h3 style="color:#60A5FA; margin-top:24px;">Valuation Summary (DCF)</h3>
            <table style="width:100%; border-collapse:collapse; margin-bottom:16px;">
            <tr><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#D1D5DB;'>Intrinsic Value / Share</td><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#F9FAFB; text-align:right;'>{cs}{iv['intrinsic_value_per_share']:.2f}</td></tr>
            <tr><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#D1D5DB;'>Upside / (Downside)</td><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:{"#10B981" if iv["upside_pct"] > 0 else "#EF4444"}; text-align:right; font-weight:700;'>{iv['upside_pct']:+.1f}%</td></tr>
            <tr><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#D1D5DB;'>Margin of Safety</td><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#F9FAFB; text-align:right;'>{iv['margin_of_safety']:.1f}%</td></tr>
            </table>"""
    except Exception:
        pass

    # Analyst targets
    analyst_html = ""
    if cd.analyst_price_targets:
        t = cd.analyst_price_targets
        analyst_html = f"""
        <h3 style="color:#60A5FA; margin-top:24px;">Analyst Price Targets</h3>
        <table style="width:100%; border-collapse:collapse; margin-bottom:16px;">
        <tr><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#D1D5DB;'>Low</td><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#F9FAFB; text-align:right;'>{cs}{t.get("low",0):.2f}</td></tr>
        <tr><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#D1D5DB;'>Mean</td><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#F9FAFB; text-align:right;'>{cs}{t.get("mean",0):.2f}</td></tr>
        <tr><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#F9FAFB;'>High</td><td style='padding:6px 12px; border-bottom:1px solid #1F2937; color:#F9FAFB; text-align:right;'>{cs}{t.get("high",0):.2f}</td></tr>
        </table>"""

    # Description
    _raw_desc = getattr(cd, 'description', None) or getattr(cd, 'long_business_summary', None) or ""
    if hasattr(_raw_desc, 'iloc'):
        _raw_desc = str(_raw_desc.iloc[0]) if len(_raw_desc) > 0 else ""
    desc = str(_raw_desc)[:800] if _raw_desc else "Company description not available."

    html = f"""<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>{cd.name} ({cd.ticker}) â€” Orbital Profile</title>
<style>
body {{ font-family: 'Inter', 'Segoe UI', sans-serif; background: #0C0F1A; color: #F9FAFB; max-width: 900px; margin: 0 auto; padding: 40px 30px; }}
h1 {{ color: #fff; margin-bottom: 4px; }}
h2 {{ color: #60A5FA; border-bottom: 2px solid #2563EB; padding-bottom: 6px; margin-top: 32px; }}
h3 {{ color: #60A5FA; }}
.subtitle {{ color: #9CA3AF; font-size: 14px; margin-bottom: 24px; }}
.price {{ font-size: 28px; font-weight: 800; color: #fff; }}
.meta {{ color: #9CA3AF; font-size: 12px; margin-top: 8px; }}
table {{ width: 100%; border-collapse: collapse; margin-bottom: 16px; }}
th {{ background: #2563EB; color: white; padding: 8px 12px; text-align: left; font-size: 12px; }}
@media print {{ body {{ background: white; color: #333; }} h1, .price {{ color: #333; }} h2, h3 {{ color: #2563EB; }} }}
</style></head><body>
<h1>{cd.name} ({cd.ticker})</h1>
<div class="subtitle">{cd.sector} | {cd.industry} | {cd.exchange}</div>
<div class="price">{cs}{cd.current_price:,.2f}</div>
<div class="meta">Data as of {_fetch_ts} | Generated by Orbital</div>

<h2>Company Overview</h2>
<p style="color:#D1D5DB; line-height:1.6;">{desc}</p>

<h2>Key Metrics</h2>
<table>{metrics_rows}</table>

{valuation_html}
{analyst_html}

<div class="meta" style="margin-top:40px; text-align:center; border-top:1px solid #1F2937; padding-top:16px;">
CONFIDENTIAL â€” {cd.ticker} Orbital Profile â€” {_fetch_ts}
</div>
</body></html>"""
    return html


def _export_to_csv(cd) -> str:
    """Export key metrics to CSV."""
    data = {
        'Metric': ['Company', 'Ticker', 'Price', 'Market Cap', 'P/E', 'EV/EBITDA', 
                  'Gross Margin', 'Net Margin', 'ROE', 'Debt/Equity'],
        'Value': [cd.name, cd.ticker, cd.current_price, cd.market_cap, 
                 cd.trailing_pe, cd.ev_to_ebitda, cd.gross_margins, 
                 cd.profit_margins, cd.return_on_equity, cd.debt_to_equity]
    }
    return pd.DataFrame(data).to_csv(index=False)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DCF VALUATION MODULE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _calculate_dcf(cd, growth_rate: float = 0.05, terminal_growth: float = 0.025, 
                   discount_rate: float = 0.10, projection_years: int = 5) -> dict:
    """
    Calculate a simple DCF valuation.
    
    Args:
        cd: Company data object
        growth_rate: Revenue/FCF growth rate for projection period
        terminal_growth: Perpetual growth rate for terminal value
        discount_rate: WACC or required return
        projection_years: Number of years to project
    
    Returns:
        dict with DCF valuation results
    """
    # Get base FCF
    base_fcf = None
    if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) > 0:
        base_fcf = cd.free_cashflow_series.iloc[0]
    elif (cd.operating_cashflow_series is not None and len(cd.operating_cashflow_series) > 0 and 
          cd.capital_expenditure is not None and len(cd.capital_expenditure) > 0):
        base_fcf = cd.operating_cashflow_series.iloc[0] + cd.capital_expenditure.iloc[0]  # CapEx is negative
    
    if base_fcf is None or base_fcf <= 0:
        return {"error": "Insufficient FCF data for DCF valuation"}
    
    # Project FCF
    projected_fcf = []
    current_fcf = base_fcf
    for year in range(1, projection_years + 1):
        current_fcf = current_fcf * (1 + growth_rate)
        projected_fcf.append(current_fcf)
    
    # Calculate PV of projected FCF
    pv_fcf = []
    for i, fcf in enumerate(projected_fcf):
        pv = fcf / ((1 + discount_rate) ** (i + 1))
        pv_fcf.append(pv)
    
    # Terminal Value (Gordon Growth Model)
    terminal_fcf = projected_fcf[-1] * (1 + terminal_growth)
    terminal_value = terminal_fcf / (discount_rate - terminal_growth)
    pv_terminal = terminal_value / ((1 + discount_rate) ** projection_years)
    
    # Enterprise Value
    dcf_enterprise_value = sum(pv_fcf) + pv_terminal
    
    # Equity Value
    net_debt = (cd.total_debt.iloc[0] if cd.total_debt is not None and len(cd.total_debt) > 0 else 0) - \
               (cd.cash_and_equivalents.iloc[0] if cd.cash_and_equivalents is not None and len(cd.cash_and_equivalents) > 0 else 0)
    
    equity_value = dcf_enterprise_value - net_debt
    
    # Per Share Value
    shares_outstanding = cd.shares_outstanding or (cd.market_cap / cd.current_price if cd.current_price > 0 else 1)
    implied_share_price = equity_value / shares_outstanding if shares_outstanding > 0 else 0
    
    # Upside/Downside
    upside = ((implied_share_price / cd.current_price) - 1) * 100 if cd.current_price > 0 else 0
    
    return {
        "base_fcf": base_fcf,
        "projected_fcf": projected_fcf,
        "pv_fcf": pv_fcf,
        "terminal_value": terminal_value,
        "pv_terminal": pv_terminal,
        "enterprise_value": dcf_enterprise_value,
        "net_debt": net_debt,
        "equity_value": equity_value,
        "shares_outstanding": shares_outstanding,
        "implied_share_price": implied_share_price,
        "current_price": cd.current_price,
        "upside_pct": upside,
        "growth_rate": growth_rate,
        "terminal_growth": terminal_growth,
        "discount_rate": discount_rate,
        "projection_years": projection_years,
    }

def _build_dcf_chart(dcf_result: dict, currency_symbol: str = "$", key: str = "dcf_chart"):
    """Build a visualization for DCF results."""
    if "error" in dcf_result:
        st.warning(f"âš ï¸ {dcf_result['error']} â€” Try adjusting growth assumptions or use a company with positive free cash flow.")
        return
    
    years = list(range(1, dcf_result["projection_years"] + 1))
    
    fig = go.Figure()
    
    # Projected FCF bars
    fig.add_trace(go.Bar(
        x=[f"Year {y}" for y in years],
        y=dcf_result["projected_fcf"],
        name="Projected FCF",
        marker=dict(color="rgba(37,99,235,0.7)", line=dict(color="rgba(255,255,255,0.15)", width=1)),
        text=[format_number(v, currency_symbol=currency_symbol) for v in dcf_result["projected_fcf"]],
        textposition="outside",
        textfont=dict(size=9, color="#D1D5DB"),
    ))
    
    # PV of FCF line
    fig.add_trace(go.Scatter(
        x=[f"Year {y}" for y in years],
        y=dcf_result["pv_fcf"],
        name="PV of FCF",
        mode="lines+markers",
        line=dict(color="#10B981", width=3),
        marker=dict(size=8, line=dict(color="#fff", width=1.5)),
    ))
    
    fig.update_layout(
        paper_bgcolor="rgba(0,0,0,0)",
        plot_bgcolor="rgba(0,0,0,0)",
        font=dict(family="Inter", size=14, color="#D1D5DB"),
        height=400,
        margin=dict(t=40, b=40, l=60, r=60),
        xaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
        yaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), gridcolor="rgba(37,99,235,0.1)", griddash="dot"),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
        barmode="group",
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

def _build_dcf_sensitivity(cd, base_dcf: dict, key: str = "dcf_sensitivity"):
    """Build a Plotly heatmap sensitivity analysis for DCF valuation."""
    if "error" in base_dcf:
        return

    base_wacc = base_dcf["discount_rate"]
    current_price = base_dcf["current_price"]

    # X-axis: Discount Rate (WACC Â± 3%, in 0.5% steps)
    wacc_min = max(0.01, base_wacc - 0.03)
    wacc_max = base_wacc + 0.03
    discount_rates = [round(wacc_min + i * 0.005, 4) for i in range(int((wacc_max - wacc_min) / 0.005) + 1)]

    # Y-axis: Terminal Growth Rate (1% to 4%, in 0.5% steps)
    terminal_rates = [round(0.01 + i * 0.005, 4) for i in range(7)]  # 1.0% to 4.0%

    # Build price matrix
    z_vals = []
    annotations_text = []
    base_i, base_j = 0, 0
    min_dist = float('inf')

    for i, tg in enumerate(terminal_rates):
        row = []
        text_row = []
        for j, dr in enumerate(discount_rates):
            if dr <= tg:
                row.append(None)
                text_row.append("")
                continue
            result = _calculate_dcf(
                cd, growth_rate=base_dcf["growth_rate"],
                terminal_growth=tg, discount_rate=dr,
                projection_years=base_dcf["projection_years"]
            )
            if "error" not in result:
                price = result["implied_share_price"]
                row.append(price)
                text_row.append(f"${price:,.0f}")
                dist = abs(dr - base_wacc) + abs(tg - base_dcf["terminal_growth"])
                if dist < min_dist:
                    min_dist = dist
                    base_i, base_j = i, j
            else:
                row.append(None)
                text_row.append("")
        z_vals.append(row)
        annotations_text.append(text_row)

    x_labels = [f"{r*100:.1f}%" for r in discount_rates]
    y_labels = [f"{r*100:.1f}%" for r in terminal_rates]

    # Custom colorscale: green (undervalued) to red (overvalued)
    fig = go.Figure(data=go.Heatmap(
        z=z_vals, x=x_labels, y=y_labels,
        text=annotations_text, texttemplate="%{text}", textfont=dict(size=9, color="#F9FAFB"),
        colorscale=[[0, "#EF4444"], [0.45, "#F59E0B"], [0.55, "#F5A623"], [1, "#10B981"]],
        colorbar=dict(title=dict(text="Price", font=dict(size=10, color="#9CA3AF")),
                      tickprefix="$", tickfont=dict(size=9, color="#9CA3AF")),
        hovertemplate="WACC: %{x}<br>Terminal Growth: %{y}<br>Implied Price: %{text}<extra></extra>",
    ))

    # Mark base case cell
    fig.add_shape(
        type="rect",
        x0=base_j - 0.5, x1=base_j + 0.5, y0=base_i - 0.5, y1=base_i + 0.5,
        line=dict(color="#FFD700", width=3), xref="x", yref="y",
    )
    fig.add_annotation(
        x=base_j, y=base_i, text="â˜…", showarrow=False,
        font=dict(size=16, color="#FFD700"), yshift=12,
    )

    # Current price reference
    fig.add_annotation(
        x=0.5, y=-0.15, xref="paper", yref="paper",
        text=f"Current Price: ${current_price:,.2f} Â· â˜… = Base Case Â· Green = Undervalued Â· Red = Overvalued",
        showarrow=False, font=dict(size=9, color="#9CA3AF"),
    )

    fig.update_layout(
        paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)",
        font=dict(family="Inter", size=12, color="#D1D5DB"),
        height=420, margin=dict(t=30, b=50, l=70, r=30),
        xaxis=dict(title="Discount Rate (WACC)", tickfont=dict(size=9, color="#9CA3AF"),
                   side="bottom"),
        yaxis=dict(title="Terminal Growth Rate", tickfont=dict(size=9, color="#9CA3AF")),
    )

    st.plotly_chart(fig, use_container_width=True, key=key)


def _build_dcf_assumptions_audit(cd, dcf_result: dict):
    """Show a checklist-style audit of DCF assumptions."""
    if "error" in dcf_result:
        return

    st.markdown(
        '<div style="font-size:1.1rem; font-weight:700; color:#F9FAFB; margin-bottom:0.8rem;">'
        'ğŸ” DCF Assumptions Audit</div>',
        unsafe_allow_html=True,
    )

    checks = []

    # 1. Terminal value as % of total EV
    pv_fcf_total = sum(dcf_result.get("pv_fcf", []))
    pv_terminal = dcf_result.get("pv_terminal", 0)
    ev = dcf_result.get("enterprise_value", 1)
    tv_pct = (pv_terminal / ev * 100) if ev > 0 else 0
    tv_ok = tv_pct < 75
    checks.append((
        "âœ…" if tv_ok else "âš ï¸",
        f"Terminal Value = {tv_pct:.1f}% of Enterprise Value",
        "Healthy (<75%)" if tv_ok else "High (>75%) â€” model relies heavily on terminal value",
        "#10B981" if tv_ok else "#F59E0B",
    ))

    # 2. WACC reasonableness
    wacc = dcf_result["discount_rate"] * 100
    wacc_ok = 6 <= wacc <= 15
    checks.append((
        "âœ…" if wacc_ok else "âš ï¸",
        f"WACC = {wacc:.1f}%",
        "Reasonable range (6-15%)" if wacc_ok else f"{'Unusually low' if wacc < 6 else 'Unusually high'} â€” verify inputs",
        "#10B981" if wacc_ok else "#F59E0B",
    ))

    # 3. Terminal growth reasonableness
    tg = dcf_result["terminal_growth"] * 100
    tg_ok = 1 <= tg <= 4
    checks.append((
        "âœ…" if tg_ok else "âš ï¸",
        f"Terminal Growth = {tg:.1f}%",
        "Within typical range (1-4%)" if tg_ok else "Outside normal range â€” should approximate GDP growth",
        "#10B981" if tg_ok else "#F59E0B",
    ))

    # 4. Growth rate vs historical FCF CAGR
    hist_cagr = None
    if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) >= 2:
        fcf_vals = cd.free_cashflow_series.dropna()
        if len(fcf_vals) >= 2 and fcf_vals.iloc[-1] > 0 and fcf_vals.iloc[0] > 0:
            n_years = len(fcf_vals) - 1
            hist_cagr = ((fcf_vals.iloc[0] / fcf_vals.iloc[-1]) ** (1 / n_years) - 1) * 100 if n_years > 0 else None

    assumed_gr = dcf_result["growth_rate"] * 100
    if hist_cagr is not None:
        gr_ok = abs(assumed_gr - hist_cagr) < 10
        checks.append((
            "âœ…" if gr_ok else "âš ï¸",
            f"FCF Growth Assumption = {assumed_gr:.1f}% vs Historical CAGR = {hist_cagr:.1f}%",
            "Aligned with history" if gr_ok else "Significant deviation from historical trend",
            "#10B981" if gr_ok else "#F59E0B",
        ))
    else:
        checks.append((
            "âš ï¸", f"FCF Growth Assumption = {assumed_gr:.1f}%",
            "Historical FCF CAGR unavailable for comparison", "#F59E0B",
        ))

    # 5. Implied exit multiple
    terminal_growth = dcf_result["terminal_growth"]
    discount_rate = dcf_result["discount_rate"]
    if discount_rate > terminal_growth:
        implied_exit_mult = (1 + terminal_growth) / (discount_rate - terminal_growth)
        mult_ok = implied_exit_mult < 30
        checks.append((
            "âœ…" if mult_ok else "âš ï¸",
            f"Implied Exit EV/FCF Multiple = {implied_exit_mult:.1f}x",
            "Reasonable" if mult_ok else "Very high â€” suggests aggressive terminal assumptions",
            "#10B981" if mult_ok else "#F59E0B",
        ))

    # Render checks
    for icon, title, detail, color in checks:
        st.markdown(
            f'<div style="display:flex; align-items:flex-start; gap:0.6rem; margin-bottom:0.6rem; '
            f'padding:0.6rem 0.8rem; background:rgba(255,255,255,0.03); border-radius:8px; '
            f'border-left:3px solid {color};">'
            f'<span style="font-size:1.1rem;">{icon}</span>'
            f'<div><div style="font-size:0.85rem; font-weight:600; color:#F9FAFB;">{title}</div>'
            f'<div style="font-size:0.72rem; color:#9CA3AF;">{detail}</div></div></div>',
            unsafe_allow_html=True,
        )

def _build_terminal_value_sensitivity(cd, base_dcf: dict, key: str = "tv_sensitivity"):
    """Build terminal growth vs WACC sensitivity chart."""
    if "error" in base_dcf:
        return
    
    terminal_rates = [0.015, 0.020, 0.025, 0.030, 0.035]
    discount_rates = [0.08, 0.10, 0.12]
    
    fig = go.Figure()
    colors = ["#2563EB", "#10B981", "#10B981"]
    
    for i, dr in enumerate(discount_rates):
        prices = []
        for tr in terminal_rates:
            result = _calculate_dcf(
                cd,
                growth_rate=base_dcf["growth_rate"],
                terminal_growth=tr,
                discount_rate=dr,
                projection_years=base_dcf["projection_years"]
            )
            if "error" not in result:
                prices.append(result["implied_share_price"])
            else:
                prices.append(0)
        
        fig.add_trace(go.Scatter(
            x=[f"{r*100:.1f}%" for r in terminal_rates],
            y=prices,
            mode="lines+markers",
            name=f"WACC {dr*100:.0f}%",
            line=dict(color=colors[i], width=3),
            marker=dict(size=8),
        ))
    
    # Add current price reference line
    fig.add_hline(
        y=base_dcf["current_price"],
        line_dash="dash",
        line_color="rgba(255,255,255,0.3)",
        annotation_text=f"Current: ${base_dcf['current_price']:,.2f}",
        annotation_position="right",
    )
    
    fig.update_layout(
        paper_bgcolor="rgba(0,0,0,0)",
        plot_bgcolor="rgba(0,0,0,0)",
        font=dict(family="Inter", size=14, color="#D1D5DB"),
        height=350,
        margin=dict(t=40, b=40, l=60, r=80),
        xaxis=dict(title="Terminal Growth Rate", tickfont=dict(size=10, color="#9CA3AF")),
        yaxis=dict(title="Implied Share Price", tickfont=dict(size=9, color="#9CA3AF"), 
                  gridcolor="rgba(37,99,235,0.1)", griddash="dot", tickprefix="$"),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STOCK PRICE PERFORMANCE CHART
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def _build_price_performance_chart(tickers: list, period: str = "1y", key: str = "price_perf"):
    """Build a normalized price performance chart for multiple tickers."""
    if not tickers:
        return
    
    fig = go.Figure()
    colors = ["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6", 
              "#8B5CF6", "#EC4899", "#14B8A6", "#F59E0B", "#6366F1"]
    
    for i, ticker in enumerate(tickers[:10]):
        try:
            tk = yf.Ticker(ticker)
            hist = tk.history(period=period)
            if hist.empty:
                continue
            
            # Normalize to 100 at start
            normalized = (hist["Close"] / hist["Close"].iloc[0]) * 100
            
            fig.add_trace(go.Scatter(
                x=hist.index,
                y=normalized,
                mode="lines",
                name=ticker,
                line=dict(color=colors[i % len(colors)], width=2),
            ))
        except Exception:
            continue
    
    # Add 100 reference line
    fig.add_hline(y=100, line_dash="dot", line_color="rgba(255,255,255,0.2)")
    
    fig.update_layout(
        paper_bgcolor="rgba(0,0,0,0)",
        plot_bgcolor="rgba(0,0,0,0)",
        font=dict(family="Inter", size=14, color="#D1D5DB"),
        height=400,
        margin=dict(t=40, b=40, l=60, r=60),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
        yaxis=dict(title="Indexed (100 = Start)", tickfont=dict(size=9, color="#9CA3AF"), 
                  gridcolor="rgba(37,99,235,0.1)", griddash="dot"),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
        hovermode="x unified",
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# QUICK COMPARE - Side-by-side company comparison
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
@st.cache_data(ttl=600, show_spinner=False)
def _fetch_comparison_data(tickers: list) -> list:
    """Fetch data for multiple companies for comparison."""
    results = []
    for ticker in tickers:
        try:
            cd = fetch_company_data(ticker)
            results.append(cd)
        except Exception:
            continue
    return results

def _build_comparison_table(companies: list) -> pd.DataFrame:
    """Build a comparison table for multiple companies."""
    if not companies:
        return pd.DataFrame()
    
    metrics = [
        ("Ticker", lambda cd: cd.ticker),
        ("Name", lambda cd: cd.name[:25] + "..." if len(cd.name) > 25 else cd.name),
        ("Price", lambda cd: f"{cd.currency_symbol}{cd.current_price:,.2f}"),
        ("Market Cap", lambda cd: format_number(cd.market_cap, currency_symbol=cd.currency_symbol)),
        ("P/E", lambda cd: format_multiple(cd.trailing_pe)),
        ("Fwd P/E", lambda cd: format_multiple(cd.forward_pe)),
        ("EV/EBITDA", lambda cd: format_multiple(cd.ev_to_ebitda)),
        ("EV/Revenue", lambda cd: format_multiple(cd.ev_to_revenue)),
        ("Gross Margin", lambda cd: format_pct(cd.gross_margins)),
        ("Op Margin", lambda cd: format_pct(cd.operating_margins)),
        ("Net Margin", lambda cd: format_pct(cd.profit_margins)),
        ("ROE", lambda cd: format_pct(cd.return_on_equity)),
        ("ROA", lambda cd: format_pct(cd.return_on_assets)),
        ("Debt/Equity", lambda cd: format_multiple(cd.debt_to_equity)),
        ("Dividend Yield", lambda cd: format_pct(cd.dividend_yield) if cd.dividend_yield else "N/A"),
    ]
    
    data = {}
    for metric_name, getter in metrics:
        data[metric_name] = []
        for cd in companies:
            try:
                data[metric_name].append(getter(cd))
            except Exception:
                data[metric_name].append("N/A")
    
    return pd.DataFrame(data)

def _build_comparison_radar(companies: list, key: str = "compare_radar"):
    """Build a radar chart comparing multiple companies."""
    if len(companies) < 2:
        return
    
    metrics = ["P/E", "EV/EBITDA", "Gross Margin", "ROE", "Debt/Equity"]
    
    fig = go.Figure()
    
    colors = ["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6"]
    
    for i, cd in enumerate(companies[:5]):  # Max 5 companies
        values = []
        for metric in metrics:
            if metric == "P/E":
                val = cd.trailing_pe if cd.trailing_pe and cd.trailing_pe > 0 else 0
            elif metric == "EV/EBITDA":
                val = cd.ev_to_ebitda if cd.ev_to_ebitda and cd.ev_to_ebitda > 0 else 0
            elif metric == "Gross Margin":
                val = (cd.gross_margins or 0) * 100
            elif metric == "ROE":
                val = (cd.return_on_equity or 0) * 100
            elif metric == "Debt/Equity":
                val = cd.debt_to_equity if cd.debt_to_equity else 0
            values.append(val)
        
        # Normalize values to 0-100 scale
        max_vals = [50, 30, 100, 50, 200]  # Reasonable max for each metric
        norm_values = [min(v / m * 100, 120) for v, m in zip(values, max_vals)]
        
        fig.add_trace(go.Scatterpolar(
            r=norm_values + [norm_values[0]],
            theta=metrics + [metrics[0]],
            fill='toself',
            name=cd.ticker,
            fillcolor=f"rgba({int(colors[i][1:3], 16)},{int(colors[i][3:5], 16)},{int(colors[i][5:7], 16)},0.1)",
            line=dict(color=colors[i], width=2),
            marker=dict(size=6),
        ))
    
    fig.update_layout(
        paper_bgcolor="rgba(0,0,0,0)",
        plot_bgcolor="rgba(0,0,0,0)",
        font=dict(family="Inter", size=12, color="#D1D5DB"),
        polar=dict(
            radialaxis=dict(visible=True, range=[0, 120], tickfont=dict(size=8, color="#9CA3AF"),
                           gridcolor="rgba(37,99,235,0.1)"),
            angularaxis=dict(tickfont=dict(size=10, color="#9CA3AF"),
                            gridcolor="rgba(37,99,235,0.08)"),
            bgcolor="rgba(0,0,0,0)",
        ),
        showlegend=True,
        height=450,
        margin=dict(t=50, b=50, l=70, r=70),
        legend=dict(font=dict(size=11, color="#D1D5DB")),
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTOR SCREENING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SECTOR â†’ PEER MAPPING (for Smart Peer Suggestions)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTOR_PEER_MAP = {
    "Technology": ["AAPL", "MSFT", "GOOGL", "META", "NVDA", "CRM", "ADBE", "ORCL", "IBM", "INTC", "AMD", "CSCO", "TXN", "AVGO", "NOW"],
    "Communication Services": ["GOOGL", "META", "NFLX", "DIS", "CMCSA", "T", "VZ", "TMUS", "CHTR", "EA"],
    "Consumer Cyclical": ["AMZN", "TSLA", "HD", "NKE", "MCD", "SBUX", "TGT", "LOW", "TJX", "BKNG"],
    "Consumer Defensive": ["WMT", "PG", "KO", "PEP", "COST", "PM", "CL", "MDLZ", "KHC", "GIS"],
    "Healthcare": ["JNJ", "UNH", "PFE", "ABBV", "MRK", "TMO", "ABT", "LLY", "BMY", "AMGN", "GILD", "ISRG"],
    "Financial Services": ["JPM", "BAC", "WFC", "GS", "MS", "BLK", "C", "AXP", "SCHW", "USB", "PNC", "BK"],
    "Financials": ["JPM", "BAC", "WFC", "GS", "MS", "BLK", "C", "AXP", "SCHW", "USB"],
    "Energy": ["XOM", "CVX", "COP", "SLB", "EOG", "OXY", "MPC", "VLO", "PSX", "DVN", "HES", "HAL"],
    "Industrials": ["HON", "UNP", "UPS", "CAT", "DE", "RTX", "BA", "LMT", "GE", "MMM", "WM", "ETN"],
    "Basic Materials": ["LIN", "APD", "ECL", "SHW", "DD", "NEM", "FCX", "NUE", "DOW", "PPG"],
    "Real Estate": ["AMT", "PLD", "CCI", "EQIX", "SPG", "O", "WELL", "DLR", "PSA", "AVB"],
    "Utilities": ["NEE", "DUK", "SO", "D", "AEP", "SRE", "EXC", "XEL", "ED", "WEC"],
    "Softwareâ€”Infrastructure": ["MSFT", "ORCL", "CRM", "NOW", "ADBE", "INTU", "PLTR", "SNOW", "DDOG", "NET"],
    "Softwareâ€”Application": ["CRM", "ADBE", "WDAY", "TEAM", "ZS", "CRWD", "OKTA", "MDB", "HUBS", "VEEV"],
    "Semiconductors": ["NVDA", "AMD", "INTC", "QCOM", "AVGO", "TXN", "MU", "AMAT", "LRCX", "KLAC"],
    "Internet Content & Information": ["GOOGL", "META", "SNAP", "PINS", "TWTR", "ZG", "IAC", "TTGT"],
    "Biotechnology": ["AMGN", "GILD", "REGN", "VRTX", "BIIB", "MRNA", "BNTX", "ILMN", "SGEN", "ALNY"],
    "Drug Manufacturers": ["JNJ", "PFE", "ABBV", "MRK", "LLY", "BMY", "AZN", "NVS", "GSK", "SNY"],
    "Banksâ€”Diversified": ["JPM", "BAC", "WFC", "C", "USB", "PNC", "TFC", "FITB", "CFG", "KEY"],
    "Insurance": ["BRK-B", "PRU", "MET", "AFL", "AIG", "TRV", "ALL", "CB", "HIG", "PGR"],
}

POPULAR_TICKERS = {
    "Technology": ["AAPL", "MSFT", "GOOGL", "META", "NVDA", "AMZN", "CRM", "ADBE", "INTC", "AMD"],
    "Healthcare": ["JNJ", "UNH", "PFE", "ABBV", "MRK", "TMO", "ABT", "LLY", "BMY", "AMGN"],
    "Financials": ["JPM", "BAC", "WFC", "GS", "MS", "BLK", "C", "AXP", "SCHW", "USB"],
    "Consumer": ["WMT", "PG", "KO", "PEP", "COST", "NKE", "MCD", "SBUX", "TGT", "HD"],
    "Energy": ["XOM", "CVX", "COP", "SLB", "EOG", "OXY", "MPC", "VLO", "PSX", "DVN"],
    "Canadian": ["RY.TO", "TD.TO", "BNS.TO", "BMO.TO", "CM.TO", "ENB.TO", "CNQ.TO", "SU.TO", "TRP.TO", "BCE.TO"],
    "VMS/Software": ["DDOG", "SNOW", "PLTR", "NET", "CRWD", "ZS", "OKTA", "MDB", "TEAM", "ESTC"],
}

# â”€â”€ Quick Ticker Lookup (for sidebar previews) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data(ttl=300, show_spinner=False)
def _quick_ticker_lookup(ticker: str) -> dict:
    """Lightweight ticker lookup for sidebar preview cards."""
    if not ticker or len(ticker) < 1:
        return {}
    try:
        tk = yf.Ticker(ticker)
        info = tk.info or {}
        name = info.get("shortName") or info.get("longName") or ticker
        price = info.get("currentPrice") or info.get("regularMarketPrice")
        currency = info.get("currency", "USD")
        market_cap = info.get("marketCap")
        change_pct = info.get("regularMarketChangePercent")
        w52_high = info.get("fiftyTwoWeekHigh")
        w52_low = info.get("fiftyTwoWeekLow")
        return {
            "name": name,
            "price": price,
            "currency": currency,
            "market_cap": market_cap,
            "change_pct": change_pct,
            "52w_high": w52_high,
            "52w_low": w52_low,
            "valid": True,
        }
    except Exception:
        return {"valid": False}

# â”€â”€ Page Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Orbital â€” M&A Intelligence",
    page_icon="https://img.icons8.com/fluency/48/combo-chart.png",
    layout="wide",
    initial_sidebar_state="collapsed",
)

# â”€â”€ Generate star box-shadow strings (deterministic seed) â”€â”€â”€â”€â”€â”€
random.seed(42)
def _gen_stars(count, spread=2000):
    return ", ".join(f"{random.randint(0,spread)}px {random.randint(0,spread)}px #FFF" for _ in range(count))
_STARS1 = _gen_stars(80)
_STARS2 = _gen_stars(50)
_STARS3 = _gen_stars(30)

# â”€â”€ Chart visual helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_CHART_LAYOUT_BASE = dict(
    paper_bgcolor="rgba(0,0,0,0)",
    plot_bgcolor="rgba(0,0,0,0)",
    font=dict(family="Inter", size=12, color="#9CA3AF"),
    title=dict(text=""),  # Explicitly no title (prevents "undefined" rendering)
    hoverlabel=dict(
        bgcolor="rgba(17,24,39,0.95)",
        bordercolor="rgba(37,99,235,0.3)",
        font=dict(size=13, color="#F9FAFB", family="Inter"),
    ),
    hovermode="x unified",
    dragmode="zoom",  # Enable zoom by default
    modebar=dict(
        bgcolor="rgba(0,0,0,0)",
        color="#2563EB",
        activecolor="#60A5FA",
    ),
    margin=dict(l=60, r=40, t=40, b=50),
)

def _apply_space_grid(fig, show_x_grid=False, show_y_grid=True):
    """Apply subtle grid for professional look."""
    if show_y_grid:
        fig.update_yaxes(gridcolor="rgba(255,255,255,0.05)", gridwidth=0.5, griddash="dot")
    if show_x_grid:
        fig.update_xaxes(gridcolor="rgba(255,255,255,0.05)", gridwidth=0.5, griddash="dot")

def _glow_line_traces(fig, x, y, color, name, width=2.5, glow_width=8, yaxis=None):
    """Add a neon glow effect: wide transparent underlay + sharp main line."""
    # Parse hex color to rgba for glow
    glow_color = color
    if color.startswith("#") and len(color) == 7:
        r, g, b = int(color[1:3], 16), int(color[3:5], 16), int(color[5:7], 16)
        glow_color = f"rgba({r},{g},{b},0.15)"
    # Glow underlay
    fig.add_trace(go.Scatter(
        x=x, y=y, mode="lines", name=name,
        line=dict(color=glow_color, width=glow_width),
        showlegend=False, hoverinfo="skip",
        yaxis=yaxis,
    ))
    # Main line
    fig.add_trace(go.Scatter(
        x=x, y=y, mode="lines+markers", name=name,
        line=dict(color=color, width=width),
        marker=dict(size=7, line=dict(color="#fff", width=1.5)),
        yaxis=yaxis,
    ))

# â”€â”€ Global animated starfield (visible on ALL pages) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    '<div class="global-starfield">'
    '<div class="global-star-1">&#8203;</div>'
    '<div class="global-star-2">&#8203;</div>'
    '<div class="global-star-3">&#8203;</div>'
    '<div class="global-nebula">&#8203;</div>'
    '</div>',
    unsafe_allow_html=True,
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMPREHENSIVE CUSTOM CSS â€” Immersive space theme
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.markdown(f"""
<style>
/* â”€â”€ GLOBAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

html, body, [class*="css"] {{
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}}

[data-testid="stApp"] {{
    background: linear-gradient(180deg, #0C0F1A 0%, #111827 100%) !important;
}}

.block-container {{
    padding-top: 0 !important;
    padding-bottom: 2rem;
    max-width: 1440px;
    position: relative;
    z-index: 1;
}}

/* â”€â”€ GLOBAL STARFIELD (subtle, polished) â”€â”€â”€â”€â”€â”€â”€â”€ */
.global-starfield {{
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 0; pointer-events: none; overflow: hidden;
}}
.global-star-1 {{
    position: absolute; top: 0; left: 0; width: 1px; height: 1px;
    box-shadow: {_STARS1};
    opacity: 0.15;
    animation: starDrift1 200s linear infinite;
}}
.global-star-1::after {{
    content: ''; position: absolute; top: 2000px; left: 0;
    width: 1px; height: 1px;
    box-shadow: {_STARS1};
}}
.global-star-2 {{
    position: absolute; top: 0; left: 0; width: 1.5px; height: 1.5px;
    box-shadow: {_STARS2};
    opacity: 0.2;
    animation: starDrift2 150s linear infinite;
}}
.global-star-2::after {{
    content: ''; position: absolute; top: 2000px; left: 0;
    width: 1.5px; height: 1.5px;
    box-shadow: {_STARS2};
}}
.global-star-3 {{
    position: absolute; top: 0; left: 0; width: 2px; height: 2px;
    box-shadow: {_STARS3};
    opacity: 0.25;
    animation: starDrift3 120s linear infinite;
}}
.global-star-3::after {{
    content: ''; position: absolute; top: 2000px; left: 0;
    width: 2px; height: 2px;
    box-shadow: {_STARS3};
}}
.global-nebula {{
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background:
        radial-gradient(ellipse at 30% 40%, rgba(37,99,235,0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 60%, rgba(16,185,129,0.02) 0%, transparent 50%);
    animation: nebulaPulse 40s ease-in-out infinite;
}}

/* â”€â”€ GLOBAL TEXT OVERRIDES FOR NATIVE STREAMLIT ELEMENTS â”€ */
[data-testid="stAppViewContainer"] {{ color: #F9FAFB; }}
[data-testid="stAlert"] {{ 
    background: rgba(17, 24, 39, 0.7) !important;
    backdrop-filter: blur(16px) !important;
    border: 1px solid rgba(255,255,255,0.08) !important;
    border-left: 3px solid rgba(37,99,235,0.5) !important;
    color: #F9FAFB !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2) !important;
}}
[data-testid="stAlert"] p {{ color: #F9FAFB !important; }}
[data-testid="stExpanderDetails"] {{ background: rgba(255,255,255,0.02) !important; }}

/* â”€â”€ TYPOGRAPHY SYSTEM (Bloomberg Terminal meets Stripe) â”€â”€â”€ */
h1 {{
    font-size: 2rem !important;
    font-weight: 800 !important;
    letter-spacing: -0.03em !important;
    color: #F9FAFB !important;
    margin-bottom: 0.75rem !important;
    line-height: 1.2 !important;
}}
h2 {{
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    letter-spacing: -0.02em !important;
    color: #F9FAFB !important;
    margin-top: 2rem !important;
    margin-bottom: 0.75rem !important;
    line-height: 1.3 !important;
}}
h3 {{
    font-size: 1.125rem !important;
    font-weight: 600 !important;
    color: #E5E7EB !important;
    margin-top: 1.5rem !important;
    margin-bottom: 0.5rem !important;
    line-height: 1.4 !important;
}}
h4 {{
    font-size: 1rem !important;
    font-weight: 600 !important;
    color: #D1D5DB !important;
}}
p {{
    line-height: 1.6 !important;
    color: #D1D5DB !important;
}}

/* â”€â”€ HIDE STREAMLIT DEFAULT CHROME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#MainMenu {{ visibility: hidden; }}
header {{ visibility: hidden; }}
footer {{ visibility: hidden; }}
[data-testid="stToolbar"] {{ display: none !important; }}

/* â”€â”€ CUSTOM SCROLLBAR (thinner, more subtle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar {{ width: 4px; height: 4px; }}
::-webkit-scrollbar-track {{ background: rgba(0,0,0,0.2); }}
::-webkit-scrollbar-thumb {{ background: rgba(37,99,235,0.4); border-radius: 2px; }}
::-webkit-scrollbar-thumb:hover {{ background: rgba(37,99,235,0.6); }}
* {{ scrollbar-width: thin; scrollbar-color: rgba(37,99,235,0.4) rgba(0,0,0,0.2); }}

/* â”€â”€ TAB STYLING (prominent, polished) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-testid="stTabs"] {{
    gap: 0.5rem !important;
}}
[data-testid="stTabs"] button[role="tab"] {{
    border-radius: 8px 8px 0 0 !important;
    padding: 0.75rem 1.5rem !important;
    font-weight: 600 !important;
    font-size: 0.9rem !important;
    color: #9CA3AF !important;
    border: none !important;
    background: transparent !important;
    transition: all 0.2s ease !important;
    position: relative !important;
}}
[data-testid="stTabs"] button[role="tab"][aria-selected="true"] {{
    color: #F9FAFB !important;
    background: rgba(37,99,235,0.15) !important;
    border-bottom: 3px solid #2563EB !important;
    box-shadow: 0 2px 8px rgba(37,99,235,0.2) !important;
}}
[data-testid="stTabs"] button[role="tab"]:hover {{
    color: #E5E7EB !important;
    background: rgba(37,99,235,0.08) !important;
}}

/* â”€â”€ METRIC CARDS (dense, information-rich) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-testid="stMetric"] {{
    background: rgba(17, 24, 39, 0.7) !important;
    backdrop-filter: blur(16px) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-left: 3px solid rgba(37,99,235,0.5) !important;
    border-radius: 12px !important;
    padding: 0.75rem 1rem !important;
    transition: all 0.2s ease !important;
}}
[data-testid="stMetric"]:hover {{
    border-color: rgba(37, 99, 235, 0.2) !important;
    border-left-color: #2563EB !important;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3) !important;
}}
[data-testid="stMetric"] label {{
    color: #9CA3AF !important;
    font-weight: 600 !important;
    font-size: 0.75rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
}}
[data-testid="stMetric"] [data-testid="stMetricValue"] {{
    color: #F9FAFB !important;
    font-size: 1.5rem !important;
    font-weight: 700 !important;
}}

/* â”€â”€ GLASS CARD BASE STYLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.glass-card {{
    background: rgba(17, 24, 39, 0.7) !important;
    backdrop-filter: blur(16px) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 12px !important;
    padding: 1.25rem !important;
    transition: all 0.2s ease !important;
}}
.glass-card:hover {{
    border-color: rgba(37, 99, 235, 0.2) !important;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3) !important;
}}

/* â”€â”€ BUTTON STYLING (modern gradient) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stButton > button {{
    background: linear-gradient(135deg, #2563EB, #1D4ED8) !important;
    color: white !important;
    border: none !important;
    border-radius: 8px !important;
    font-weight: 600 !important;
    padding: 0.5rem 1.5rem !important;
    transition: all 0.2s ease !important;
    font-size: 0.9rem !important;
}}
.stButton > button:hover {{
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4) !important;
    background: linear-gradient(135deg, #1D4ED8, #1E40AF) !important;
}}
.stButton > button:active {{
    transform: translateY(0) scale(0.98) !important;
    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3) !important;
}}

/* â”€â”€ DATAFRAME / TABLE STYLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-testid="stDataFrame"] {{
    border-radius: 8px !important;
    overflow: hidden !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
}}
[data-testid="stDataFrame"] table {{
    background: rgba(17, 24, 39, 0.5) !important;
}}
[data-testid="stDataFrame"] thead tr {{
    background: rgba(37, 99, 235, 0.1) !important;
}}
[data-testid="stDataFrame"] tbody tr:nth-child(even) {{
    background: rgba(255, 255, 255, 0.02) !important;
}}
[data-testid="stDataFrame"] tbody tr {{
    transition: all 0.2s ease !important;
}}
[data-testid="stDataFrame"] tbody tr:hover {{
    background: rgba(37, 99, 235, 0.08) !important;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1) !important;
}}

/* â”€â”€ SECTION HEADERS (with left accent bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-header {{
    font-size: 1.25rem !important;
    font-weight: 700 !important;
    color: #F9FAFB !important;
    margin: 2rem 0 1rem !important;
    padding-left: 1rem !important;
    border-left: 3px solid #2563EB !important;
    background: rgba(37, 99, 235, 0.05) !important;
    padding: 0.75rem 0 0.75rem 1rem !important;
    border-radius: 0 8px 8px 0 !important;
}}

/* â”€â”€ EXPANDER STYLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-testid="stExpander"] {{
    border: 1px solid rgba(37,99,235,0.15) !important;
    border-radius: 16px !important;
    overflow: hidden;
    transition: border-color 0.3s ease !important;
}}
[data-testid="stExpander"]:hover {{
    border-color: rgba(37,99,235,0.35) !important;
}}
[data-testid="stExpander"] summary {{
    border-radius: 16px !important;
    transition: background 0.3s ease !important;
}}
[data-testid="stExpanderDetails"] {{
    animation: fadeInUp 0.2s ease-out !important;
}}

/* â”€â”€ ANIMATIONS (15+ keyframes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes ticker-scroll {{
    from {{ transform: translateX(0); }}
    to {{ transform: translateX(-50%); }}
}}
@keyframes fadeInUp {{
    from {{ opacity: 0; transform: translateY(30px) scale(0.98); }}
    to {{ opacity: 1; transform: translateY(0) scale(1); }}
}}
@keyframes fadeInScale {{
    from {{ opacity: 0; transform: scale(0.9); }}
    to {{ opacity: 1; transform: scale(1); }}
}}
@keyframes starDrift1 {{
    from {{ transform: translateY(0); }}
    to {{ transform: translateY(-2000px); }}
}}
@keyframes starDrift2 {{
    from {{ transform: translateY(0); }}
    to {{ transform: translateY(-2000px); }}
}}
@keyframes starDrift3 {{
    from {{ transform: translateY(0); }}
    to {{ transform: translateY(-2000px); }}
}}
@keyframes shootingStar {{
    0% {{ transform: translate(0, 0) rotate(-45deg); opacity: 0; }}
    5% {{ opacity: 1; }}
    40% {{ opacity: 1; }}
    100% {{ transform: translate(-600px, 600px) rotate(-45deg); opacity: 0; }}
}}
@keyframes nebulaPulse {{
    0%, 100% {{ opacity: 0.15; transform: scale(1); }}
    50% {{ opacity: 0.3; transform: scale(1.05); }}
}}
@keyframes float1 {{
    0%, 100% {{ transform: translate(0, 0); }}
    25% {{ transform: translate(15px, -20px); }}
    50% {{ transform: translate(-10px, -35px); }}
    75% {{ transform: translate(-20px, -10px); }}
}}
@keyframes float2 {{
    0%, 100% {{ transform: translate(0, 0); }}
    25% {{ transform: translate(-20px, 15px); }}
    50% {{ transform: translate(10px, 25px); }}
    75% {{ transform: translate(25px, -15px); }}
}}
@keyframes float3 {{
    0%, 100% {{ transform: translate(0, 0); }}
    33% {{ transform: translate(20px, -25px); }}
    66% {{ transform: translate(-15px, 20px); }}
}}
@keyframes float4 {{
    0%, 100% {{ transform: translate(0, 0); }}
    20% {{ transform: translate(-15px, -10px); }}
    40% {{ transform: translate(10px, -30px); }}
    60% {{ transform: translate(25px, -5px); }}
    80% {{ transform: translate(-5px, 15px); }}
}}
@keyframes titleGlow {{
    0%, 100% {{ opacity: 0.3; transform: scale(1); }}
    50% {{ opacity: 0.25; transform: scale(1.1); }}
}}
@keyframes gradientShift {{
    0% {{ background-position: 0% 50%; }}
    50% {{ background-position: 100% 50%; }}
    100% {{ background-position: 0% 50%; }}
}}
@keyframes shimmerLine {{
    0% {{ background-position: -200% 0; }}
    100% {{ background-position: 200% 0; }}
}}
@keyframes gentlePulse {{
    0%, 100% {{ opacity: 1; }}
    50% {{ opacity: 0.8; }}
}}
@keyframes glowPulse {{
    0%, 100% {{ box-shadow: 0 0 5px rgba(37,99,235,0.3); }}
    50% {{ box-shadow: 0 0 15px rgba(37,99,235,0.6); }}
}}
@keyframes twinkle {{
    0%, 100% {{ opacity: 0.3; }}
    50% {{ opacity: 1; }}
}}
@keyframes pulse-glow {{
    0%, 100% {{ opacity: 0.6; }}
    50% {{ opacity: 1; }}
}}
@keyframes shimmer {{
    0% {{ background-position: -200% 0; }}
    100% {{ background-position: 200% 0; }}
}}
@keyframes borderGlow {{
    0%, 100% {{ border-color: rgba(37,99,235,0.3); }}
    50% {{ border-color: rgba(155,138,255,0.6); }}
}}
@keyframes rocketLaunch {{
    0% {{ transform: translateY(0) scale(1); opacity: 1; }}
    60% {{ transform: translateY(-120px) scale(0.9); opacity: 0.8; }}
    100% {{ transform: translateY(-300px) scale(0.6); opacity: 0; }}
}}
@keyframes flameFlicker {{
    0%, 100% {{ transform: scaleY(1) scaleX(1); opacity: 0.9; }}
    25% {{ transform: scaleY(1.3) scaleX(0.85); opacity: 1; }}
    50% {{ transform: scaleY(0.8) scaleX(1.15); opacity: 0.85; }}
    75% {{ transform: scaleY(1.15) scaleX(0.9); opacity: 1; }}
}}
@keyframes exhaustTrail {{
    0% {{ opacity: 0.6; transform: translateY(0); }}
    100% {{ opacity: 0; transform: translateY(40px); }}
}}
@keyframes missionPulse {{
    0%, 100% {{ box-shadow: 0 0 8px rgba(37,99,235,0.2); }}
    50% {{ box-shadow: 0 0 20px rgba(37,99,235,0.5), 0 0 40px rgba(37,99,235,0.15); }}
}}
@keyframes checkPop {{
    0% {{ transform: scale(0); }}
    60% {{ transform: scale(1.25); }}
    100% {{ transform: scale(1); }}
}}
@keyframes progressGlow {{
    0% {{ background-position: -200% 0; }}
    100% {{ background-position: 200% 0; }}
}}
@keyframes spin {{
    from {{ transform: rotate(0deg); }}
    to {{ transform: rotate(360deg); }}
}}
@keyframes slideInLeft {{
    from {{ opacity: 0; transform: translateX(-20px); }}
    to {{ opacity: 1; transform: translateX(0); }}
}}
@keyframes slideInRight {{
    from {{ opacity: 0; transform: translateX(20px); }}
    to {{ opacity: 1; transform: translateX(0); }}
}}
@keyframes countUp {{
    from {{ opacity: 0; transform: translateY(8px); }}
    to {{ opacity: 1; transform: translateY(0); }}
}}
@keyframes sparklinePulse {{
    0%, 100% {{ stroke-opacity: 0.8; }}
    50% {{ stroke-opacity: 1; }}
}}
@keyframes numberGrow {{
    from {{ transform: scale(0.5); opacity: 0; }}
    to {{ transform: scale(1); opacity: 1; }}
}}
@keyframes badgePop {{
    0% {{ transform: scale(0); }}
    70% {{ transform: scale(1.1); }}
    100% {{ transform: scale(1); }}
}}
@keyframes borderShimmer {{
    0% {{ background-position: 0% 0%; }}
    100% {{ background-position: 100% 100%; }}
}}
@keyframes cardReveal {{
    from {{ opacity: 0; transform: translateY(15px) scale(0.98); }}
    to {{ opacity: 1; transform: none; }}
}}
@keyframes pulseRing {{
    0% {{ transform: scale(1); opacity: 0.6; }}
    100% {{ transform: scale(1.5); opacity: 0; }}
}}
@keyframes sb-fill {{
    from {{ max-width: 0; }}
    to {{ max-width: 100%; }}
}}
@keyframes sb-btn-pulse {{
    0%, 100% {{ box-shadow: 0 4px 20px rgba(37,99,235,0.3); }}
    50% {{ box-shadow: 0 4px 30px rgba(37,99,235,0.55); }}
}}
@keyframes orbBreath1 {{
    0%, 100% {{ filter: blur(80px) hue-rotate(0deg); }}
    50% {{ filter: blur(80px) hue-rotate(30deg); }}
}}
@keyframes orbBreath4 {{
    0%, 100% {{ filter: blur(90px) hue-rotate(0deg); }}
    50% {{ filter: blur(90px) hue-rotate(30deg); }}
}}
@keyframes bounceIn {{
    0%   {{ opacity: 0; transform: scale(0.85) translateY(30px); }}
    50%  {{ opacity: 1; transform: scale(1.03) translateY(-5px); }}
    70%  {{ transform: scale(0.98) translateY(2px); }}
    100% {{ opacity: 1; transform: scale(1) translateY(0); }}
}}
@keyframes slideUpBounce {{
    0%   {{ opacity: 0; transform: translateY(40px); }}
    60%  {{ opacity: 1; transform: translateY(-8px); }}
    80%  {{ transform: translateY(3px); }}
    100% {{ transform: translateY(0); }}
}}
@keyframes chartGlow {{
    0%, 100% {{ box-shadow: 0 2px 15px rgba(37,99,235,0.15); }}
    50%      {{ box-shadow: 0 8px 35px rgba(37,99,235,0.3); }}
}}
/* Elastic bounce for chart containers â€” chartscss.org inspired */
@keyframes chartBounceIn {{
    0%   {{ transform: scale(0.92) translateY(20px); opacity: 0; }}
    40%  {{ transform: scale(1.03) translateY(-4px); opacity: 1; }}
    60%  {{ transform: scaleY(0.97) scaleX(1.02); }}
    80%  {{ transform: scaleY(1.01) scaleX(0.99); }}
    100% {{ transform: scale(1); }}
}}
/* Glow pulse on chart data */
@keyframes dataGlowPulse {{
    0%, 100% {{ box-shadow: none; }}
    50%      {{ box-shadow: 0 0 4px 0 rgba(37,99,235,0.4), 0 0 20px 5px rgba(37,99,235,0.15); }}
}}
/* Scanner keyframes (profile loading) */
@keyframes scannerSweep {{
    0%, 100% {{ transform: rotate(-15deg); }}
    50%      {{ transform: rotate(15deg); }}
}}
@keyframes scannerLock {{
    0%   {{ transform: scale(1); filter: drop-shadow(0 0 12px rgba(6,182,212,0.5)); }}
    50%  {{ transform: scale(1.15); filter: drop-shadow(0 0 25px rgba(16,185,129,0.7)); }}
    100% {{ transform: scale(1); filter: drop-shadow(0 0 15px rgba(16,185,129,0.5)); }}
}}
@keyframes scannerBeamSweep {{
    0%   {{ transform: scaleX(0.3) rotate(-20deg); opacity: 0.3; }}
    50%  {{ transform: scaleX(1) rotate(0deg); opacity: 0.8; }}
    100% {{ transform: scaleX(0.3) rotate(20deg); opacity: 0.3; }}
}}
@keyframes scannerRingPulse {{
    0%   {{ transform: translate(-50%, -50%) scale(1); opacity: 0.4; }}
    100% {{ transform: translate(-50%, -50%) scale(2); opacity: 0; }}
}}
@keyframes scannerPhasePulse {{
    0%, 100% {{ box-shadow: 0 0 8px rgba(6,182,212,0.2); }}
    50%      {{ box-shadow: 0 0 20px rgba(6,182,212,0.5), 0 0 40px rgba(6,182,212,0.15); }}
}}

/* â”€â”€ ORBITAL LOGO ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes orbitRotate {{
    0%   {{ transform: rotate(0deg); }}
    100% {{ transform: rotate(360deg); }}
}}
@keyframes orbitRotateReverse {{
    0%   {{ transform: rotate(360deg); }}
    100% {{ transform: rotate(0deg); }}
}}
@keyframes orbitPulse {{
    0%, 100% {{ opacity: 0.15; transform: scale(1); }}
    50%      {{ opacity: 1; transform: scale(1.1); }}
}}
@keyframes particleGlow {{
    0%, 100% {{ box-shadow: 0 0 4px currentColor, 0 0 8px currentColor; }}
    50%      {{ box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; }}
}}
@keyframes coreGlow {{
    0%, 100% {{ box-shadow: 0 0 15px rgba(37,99,235,0.6), 0 0 30px rgba(37,99,235,0.3); }}
    50%      {{ box-shadow: 0 0 25px rgba(37,99,235,0.9), 0 0 50px rgba(37,99,235,0.5), 0 0 80px rgba(37,99,235,0.2); }}
}}
@keyframes ringFlash {{
    0%, 90%, 100% {{ opacity: 0.3; }}
    95%           {{ opacity: 1; }}
}}

/* â”€â”€ ORBITAL LOGO COMPONENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orbital-logo {{
    position: relative;
    width: 140px; height: 140px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}}
.orbital-text {{
    position: absolute;
    font-size: 1.4rem;
    font-weight: 900;
    letter-spacing: 3px;
    color: #fff;
    z-index: 5;
    text-shadow: 0 0 25px rgba(37,99,235,1), 0 0 50px rgba(37,99,235,0.6), 0 0 80px rgba(37,99,235,0.3);
    font-family: 'Inter', 'Arial Black', sans-serif;
}}
.orbital-ring {{
    position: absolute;
    border: 2.5px solid transparent;
    border-radius: 50%;
}}
.orbital-ring-1 {{
    width: 70px; height: 70px;
    border-top-color: #2563EB;
    border-right-color: rgba(37,99,235,0.4);
    border-bottom-color: rgba(37,99,235,0.1);
    animation: orbitRotate 12s linear infinite;
}}
.orbital-ring-2 {{
    width: 100px; height: 100px;
    border-top-color: #10B981;
    border-right-color: rgba(16,185,129,0.3);
    animation: orbitRotateReverse 18s linear infinite;
}}
.orbital-ring-3 {{
    width: 130px; height: 130px;
    border-top-color: #60A5FA;
    border-left-color: rgba(155,138,255,0.2);
    animation: orbitRotate 24s linear infinite, ringFlash 6s ease-in-out infinite;
}}
.orbital-particle {{
    position: absolute;
    width: 10px; height: 10px;
    border-radius: 50%;
}}
.orbital-particle-1 {{
    background: #2563EB;
    color: #2563EB;
    top: 5px; left: 50%;
    transform: translateX(-50%);
    animation: particleGlow 1.5s ease-in-out infinite;
}}
.orbital-particle-2 {{
    background: #10B981;
    color: #10B981;
    bottom: 14px; right: 14px;
    animation: particleGlow 1.5s ease-in-out infinite 0.5s;
}}
.orbital-particle-3 {{
    background: #10B981;
    color: #10B981;
    bottom: 14px; left: 14px;
    animation: particleGlow 1.5s ease-in-out infinite 1s;
}}

/* Small orbital logo for sidebar */
.orbital-logo-sm {{
    width: 70px; height: 70px;
}}
.orbital-logo-sm .orbital-text {{
    font-size: 0.6rem;
    letter-spacing: 1.5px;
    font-weight: 900;
}}
.orbital-logo-sm .orbital-ring-1 {{ width: 34px; height: 34px; border-width: 2px; }}
.orbital-logo-sm .orbital-ring-2 {{ width: 48px; height: 48px; border-width: 2px; }}
.orbital-logo-sm .orbital-ring-3 {{ width: 64px; height: 64px; border-width: 2px; }}
.orbital-logo-sm .orbital-particle {{ width: 5px; height: 5px; }}
.orbital-logo-sm .orbital-particle-1 {{ top: 3px; }}
.orbital-logo-sm .orbital-particle-2 {{ bottom: 6px; right: 6px; }}
.orbital-logo-sm .orbital-particle-3 {{ bottom: 6px; left: 6px; }}

/* Large orbital logo for splash */
.orbital-logo-lg {{
    width: 200px; height: 200px;
}}
.orbital-logo-lg .orbital-text {{
    font-size: 1.8rem;
    letter-spacing: 4px;
    font-weight: 900;
    text-shadow: 0 0 30px rgba(37,99,235,1), 0 0 60px rgba(37,99,235,0.7), 0 0 100px rgba(37,99,235,0.4);
}}
.orbital-logo-lg .orbital-ring-1 {{ width: 100px; height: 100px; border-width: 3px; }}
.orbital-logo-lg .orbital-ring-2 {{ width: 145px; height: 145px; border-width: 3px; }}
.orbital-logo-lg .orbital-ring-3 {{ width: 190px; height: 190px; border-width: 3px; }}
.orbital-logo-lg .orbital-particle {{ width: 12px; height: 12px; }}
.orbital-logo-lg .orbital-particle-1 {{ top: 5px; }}
.orbital-logo-lg .orbital-particle-2 {{ bottom: 18px; right: 18px; }}
.orbital-logo-lg .orbital-particle-3 {{ bottom: 18px; left: 18px; }}

/* Orbital brand container */
.orbital-brand {{
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}}
.orbital-tagline {{
    font-size: 1rem;
    color: #A8A3C7;
    font-weight: 500;
    margin-top: -0.3rem;
    letter-spacing: 0.5px;
}}

/* â”€â”€ Deal Terms & Consideration animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes dealCardPulse {{
    0%, 100% {{ box-shadow: 0 0 15px rgba(37,99,235,0.2), inset 0 0 20px rgba(37,99,235,0.05); }}
    50%      {{ box-shadow: 0 0 30px rgba(37,99,235,0.4), inset 0 0 40px rgba(37,99,235,0.1); }}
}}
@keyframes dealIconSpin {{
    0%   {{ transform: rotate(0deg) scale(1); }}
    50%  {{ transform: rotate(10deg) scale(1.1); }}
    100% {{ transform: rotate(0deg) scale(1); }}
}}
@keyframes dealRowSlide {{
    from {{ opacity: 0; transform: translateX(-20px); }}
    to   {{ opacity: 1; transform: translateX(0); }}
}}
@keyframes barFillLeft {{
    from {{ width: 0; }}
    to   {{ width: var(--fill-pct); }}
}}
@keyframes barFillRight {{
    from {{ width: 0; }}
    to   {{ width: var(--fill-pct); }}
}}
@keyframes pfRowReveal {{
    from {{ opacity: 0; transform: translateY(10px); }}
    to   {{ opacity: 1; transform: translateY(0); }}
}}
@keyframes suBarGrow {{
    from {{ transform: scaleX(0); }}
    to   {{ transform: scaleX(1); }}
}}
@keyframes valueCountUp {{
    from {{ opacity: 0; transform: scale(0.8); }}
    to   {{ opacity: 1; transform: scale(1); }}
}}

/* â”€â”€ DEAL TERMS CONSIDERATION CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.deal-consideration-card {{
    background: linear-gradient(145deg, rgba(37,99,235,0.08), rgba(16,185,129,0.04));
    border: 1px solid rgba(37,99,235,0.25);
    border-radius: 20px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
    animation: bounceIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both,
               dealCardPulse 3s ease-in-out 0.5s infinite;
}}
.deal-consideration-card::before {{
    content: '';
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 30%, rgba(37,99,235,0.06) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(16,185,129,0.04) 0%, transparent 50%);
    animation: nebulaPulse 15s ease-in-out infinite;
    pointer-events: none;
}}
.deal-consideration-card .deal-header {{
    font-size: 0.7rem; font-weight: 700; color: #60A5FA;
    text-transform: uppercase; letter-spacing: 1.5px;
    margin-bottom: 1rem;
    display: flex; align-items: center; gap: 0.5rem;
}}
.deal-consideration-card .deal-header-icon {{
    font-size: 1rem;
    animation: dealIconSpin 3s ease-in-out infinite;
}}
.deal-consideration-row {{
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.8rem 1rem;
    margin: 0.4rem 0;
    background: rgba(17,24,39,0.7); backdrop-filter: blur(16px);
    border-radius: 12px;
    border-left: 3px solid;
    animation: dealRowSlide 0.3s ease-out both;
    transition: all 0.2s ease;
}}
.deal-consideration-row:hover {{
    background: rgba(37,99,235,0.08);
    transform: translateX(5px);
}}
.deal-consideration-row.cash {{ border-left-color: #10B981; }}
.deal-consideration-row.stock {{ border-left-color: #2563EB; }}
.deal-consideration-row.offer {{ border-left-color: #10B981; }}
.deal-consideration-row .deal-label {{
    font-size: 0.8rem; color: #9CA3AF; font-weight: 600;
    display: flex; align-items: center; gap: 0.4rem;
}}
.deal-consideration-row .deal-label .emoji {{ font-size: 1.1rem; }}
.deal-consideration-row .deal-value {{
    font-size: 1rem; font-weight: 700; color: #F9FAFB;
    animation: valueCountUp 0.6s ease-out both;
}}
.deal-consideration-row .deal-sub {{
    font-size: 0.7rem; color: #9CA3AF; margin-top: 2px;
}}

/* â”€â”€ PRO FORMA FINANCIALS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pf-table-wrapper {{
    background: linear-gradient(145deg, rgba(37,99,235,0.06), rgba(16,185,129,0.02));
    border: 1px solid rgba(37,99,235,0.2);
    border-radius: 20px;
    padding: 1.5rem;
    overflow: hidden;
    animation: bounceIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}}
.pf-table {{
    width: 100%; border-collapse: separate; border-spacing: 0;
}}
.pf-table th {{
    background: rgba(37,99,235,0.12);
    color: #60A5FA; font-size: 0.75rem;
    text-transform: uppercase; letter-spacing: 1px;
    padding: 0.8rem 1rem; font-weight: 700;
    border-bottom: 2px solid rgba(37,99,235,0.25);
}}
.pf-table th:first-child {{ border-radius: 12px 0 0 0; }}
.pf-table th:last-child {{ border-radius: 0 12px 0 0; background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(37,99,235,0.12)); }}
.pf-table td {{
    padding: 0.7rem 1rem; font-size: 0.85rem; color: #C8C3E3;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    animation: pfRowReveal 0.4s ease-out both;
}}
.pf-table tr:nth-child(1) td {{ animation-delay: 0.1s; }}
.pf-table tr:nth-child(2) td {{ animation-delay: 0.15s; }}
.pf-table tr:nth-child(3) td {{ animation-delay: 0.2s; }}
.pf-table tr:nth-child(4) td {{ animation-delay: 0.25s; }}
.pf-table tr:nth-child(5) td {{ animation-delay: 0.3s; }}
.pf-table td:first-child {{
    font-weight: 700; color: #D1D5DB;
    border-left: 3px solid rgba(37,99,235,0.3);
    background: rgba(37,99,235,0.03);
}}
.pf-table td:last-child {{
    font-weight: 700; color: #10B981;
    background: linear-gradient(90deg, transparent, rgba(16,185,129,0.08));
}}
.pf-table tr:hover td {{
    background: rgba(37,99,235,0.06);
}}
.pf-table tr:last-child td {{ border-bottom: none; }}
.pf-table tr:last-child td:first-child {{ border-radius: 0 0 0 12px; }}
.pf-table tr:last-child td:last-child {{ border-radius: 0 0 12px 0; }}
.pf-adj {{ color: #F5A623 !important; font-style: italic; }}

/* â”€â”€ SOURCES & USES VISUAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.su-container {{
    display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;
    animation: bounceIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}}
.su-panel {{
    background: linear-gradient(145deg, rgba(37,99,235,0.05), rgba(0,0,0,0.2));
    border: 1px solid rgba(37,99,235,0.2);
    border-radius: 20px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
}}
.su-panel::before {{
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 3px;
    border-radius: 20px 20px 0 0;
}}
.su-panel.sources::before {{ background: linear-gradient(90deg, #10B981, #2563EB); }}
.su-panel.uses::before {{ background: linear-gradient(90deg, #10B981, #F5A623); }}
.su-panel-header {{
    font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.5px; margin-bottom: 1rem;
    display: flex; align-items: center; gap: 0.6rem;
}}
.su-panel.sources .su-panel-header {{ color: #10B981; }}
.su-panel.uses .su-panel-header {{ color: #10B981; }}
.su-panel-header .su-icon {{ font-size: 1.2rem; }}
.su-row {{
    margin: 0.6rem 0;
    animation: dealRowSlide 0.4s ease-out both;
}}
.su-row:nth-child(2) {{ animation-delay: 0.1s; }}
.su-row:nth-child(3) {{ animation-delay: 0.15s; }}
.su-row:nth-child(4) {{ animation-delay: 0.2s; }}
.su-row:nth-child(5) {{ animation-delay: 0.25s; }}
.su-row-header {{
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.3rem;
}}
.su-row-label {{ font-size: 0.8rem; color: #D1D5DB; }}
.su-row-value {{ font-size: 0.9rem; font-weight: 700; color: #F9FAFB; }}
.su-bar {{
    height: 8px; border-radius: 4px;
    background: rgba(255,255,255,0.08);
    overflow: hidden;
}}
.su-bar-fill {{
    height: 100%; border-radius: 4px;
    transform-origin: left;
    animation: suBarGrow 0.8s ease-out both;
}}
.su-panel.sources .su-bar-fill {{ background: linear-gradient(90deg, #10B981, #2563EB); }}
.su-panel.uses .su-bar-fill {{ background: linear-gradient(90deg, #10B981, #F5A623); }}
.su-row.total {{
    margin-top: 1rem; padding-top: 1rem;
    border-top: 2px solid rgba(37,99,235,0.2);
}}
.su-row.total .su-row-label {{ font-weight: 700; color: #F9FAFB; }}
.su-row.total .su-row-value {{ font-size: 1.1rem; }}
.su-row.total .su-bar {{ height: 12px; }}
.su-row.total .su-bar-fill {{
    background: linear-gradient(90deg, #2563EB, #60A5FA);
    box-shadow: 0 0 15px rgba(37,99,235,0.5);
}}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
section[data-testid="stSidebar"] {{
    background: linear-gradient(180deg, #0C0F1A 0%, #10132A 50%, #151933 100%);
    border-right: 1px solid rgba(37,99,235,0.2);
    box-shadow: 4px 0 30px rgba(37,99,235,0.08);
    min-width: 340px !important;
}}
section[data-testid="stSidebar"] > div:first-child {{
    padding: 1rem 1.5rem !important;
}}
section[data-testid="stSidebar"] * {{
    color: #C8C3E3 !important;
}}
/* Hide default radio labels */
section[data-testid="stSidebar"] .stRadio > label {{
    display: none !important;
}}
section[data-testid="stSidebar"] .stRadio > div {{
    flex-direction: column !important;
    gap: 4px !important;
    background: rgba(37,99,235,0.06);
    border-radius: 16px;
    padding: 6px;
    border: 1px solid rgba(37,99,235,0.15);
}}
section[data-testid="stSidebar"] .stRadio > div > label {{
    margin: 0 !important;
    padding: 0.55rem 0.8rem !important;
    border-radius: 10px !important;
    font-weight: 600 !important;
    font-size: 0.78rem !important;
    text-align: left !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
    background: transparent !important;
    border: 1px solid transparent !important;
}}
section[data-testid="stSidebar"] .stRadio > div > label:hover {{
    background: rgba(37,99,235,0.08) !important;
    border-color: rgba(37,99,235,0.2) !important;
}}
section[data-testid="stSidebar"] .stRadio > div > label[data-checked="true"] {{
    background: linear-gradient(135deg, #2563EB 0%, #60A5FA 100%) !important;
    box-shadow: 0 4px 15px rgba(37,99,235,0.4) !important;
    border-color: transparent !important;
}}
section[data-testid="stSidebar"] .stRadio > div > label[data-checked="true"] span,
section[data-testid="stSidebar"] .stRadio > div > label[data-checked="true"] p {{
    color: #fff !important;
}}
section[data-testid="stSidebar"] .stTextInput > div > div > input {{
    background: rgba(37,99,235,0.08);
    border: 1px solid rgba(37,99,235,0.3);
    border-radius: 12px;
    color: #fff !important;
    font-weight: 700;
    font-size: 1.2rem;
    letter-spacing: 3px;
    text-align: center;
    padding: 0.9rem;
    text-transform: uppercase;
}}
section[data-testid="stSidebar"] .stTextInput > div > div > input:focus {{
    border-color: #2563EB;
    box-shadow: 0 0 20px rgba(37,99,235,0.4);
}}
section[data-testid="stSidebar"] .stTextInput > div > div > input::placeholder {{
    color: #2563EB !important;
    opacity: 0.5;
    letter-spacing: 1px;
    font-size: 0.85rem;
}}
section[data-testid="stSidebar"] .stButton > button {{
    background: linear-gradient(135deg, #2563EB 0%, #60A5FA 100%) !important;
    color: #fff !important;
    font-weight: 700 !important;
    border: none !important;
    border-radius: 16px !important;
    padding: 0.9rem 2rem !important;
    font-size: 1rem !important;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 20px rgba(37,99,235,0.3);
    animation: sb-btn-pulse 2s ease-in-out infinite;
    margin-top: 0.5rem !important;
    transition: all 0.3s ease !important;
}}
section[data-testid="stSidebar"] .stButton > button:hover {{
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 10px 36px rgba(37,99,235,0.6);
    background: linear-gradient(135deg, #1D4ED8 0%, #2563EB 100%) !important;
}}
/* â”€â”€ SIDEBAR SELECTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
section[data-testid="stSidebar"] .stSelectbox > div > div {{
    background: rgba(37,99,235,0.08) !important;
    border: 1px solid rgba(37,99,235,0.25) !important;
    border-radius: 10px !important;
    color: #F9FAFB !important;
    font-size: 0.82rem !important;
}}
section[data-testid="stSidebar"] .stSelectbox > div > div:hover {{
    border-color: rgba(37,99,235,0.5) !important;
}}
section[data-testid="stSidebar"] .stSelectbox > label {{
    color: #9CA3AF !important;
    font-size: 0.72rem !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.8px !important;
}}
/* â”€â”€ SIDEBAR SLIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
section[data-testid="stSidebar"] .stSlider > div > div > div {{
    color: #2563EB !important;
}}
section[data-testid="stSidebar"] .stSlider > label {{
    color: #9CA3AF !important;
    font-size: 0.72rem !important;
    font-weight: 600 !important;
}}
/* â”€â”€ SIDEBAR NUMBER INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
section[data-testid="stSidebar"] .stNumberInput > div > div > input {{
    background: rgba(37,99,235,0.08) !important;
    border: 1px solid rgba(37,99,235,0.25) !important;
    border-radius: 10px !important;
    color: #F9FAFB !important;
}}
section[data-testid="stSidebar"] .stNumberInput > label {{
    color: #9CA3AF !important;
    font-size: 0.72rem !important;
    font-weight: 600 !important;
}}
/* â”€â”€ SIDEBAR CHECKBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
section[data-testid="stSidebar"] .stCheckbox > label {{
    color: #D1D5DB !important;
    font-size: 0.78rem !important;
}}
/* â”€â”€ SIDEBAR EXPANDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
section[data-testid="stSidebar"] .streamlit-expanderHeader {{
    background: rgba(37,99,235,0.06) !important;
    border-radius: 10px !important;
    color: #D1D5DB !important;
    font-size: 0.82rem !important;
    font-weight: 600 !important;
}}
section[data-testid="stSidebar"] hr {{
    border-color: rgba(37,99,235,0.2) !important;
}}
/* Company preview card */
.sb-company-card {{
    background: linear-gradient(135deg, rgba(37,99,235,0.12), rgba(16,185,129,0.05));
    border: 1px solid rgba(37,99,235,0.25);
    border-radius: 16px;
    padding: 0.9rem 1rem;
    margin: 0.6rem 0;
    display: flex;
    align-items: center;
    gap: 0.9rem;
    animation: cardReveal 0.5s ease-out;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    cursor: pointer;
}}
.sb-company-card:hover {{
    border-color: rgba(37,99,235,0.6);
    box-shadow: 0 6px 24px rgba(37,99,235,0.3), 0 0 0 1px rgba(37,99,235,0.1);
    transform: translateY(-3px) scale(1.01);
    background: linear-gradient(135deg, rgba(37,99,235,0.15), rgba(16,185,129,0.08));
}}
.sb-logo-fallback {{
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, #2563EB, #60A5FA);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    font-weight: 800;
    color: #fff !important;
    text-transform: uppercase;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(37,99,235,0.3);
}}
.sb-company-info {{
    flex: 1;
    min-width: 0;
}}
.sb-company-name {{
    font-size: 0.9rem;
    font-weight: 700;
    color: #fff !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
    line-height: 1.3;
}}
.sb-company-ticker {{
    font-size: 0.7rem;
    color: #60A5FA !important;
    font-weight: 600;
    letter-spacing: 1px;
}}
.sb-company-price {{
    text-align: right;
    flex-shrink: 0;
}}
.sb-company-price-value {{
    font-size: 1rem;
    font-weight: 800;
    color: #fff !important;
}}
.sb-company-price-change {{
    font-size: 0.7rem;
    font-weight: 600;
}}
.sb-company-price-change.up {{ color: #10B981 !important; }}
.sb-company-price-change.down {{ color: #EF4444 !important; }}
.sb-company-invalid {{
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3);
    border-radius: 12px;
    padding: 0.6rem 0.9rem;
    margin: 0.5rem 0;
    font-size: 0.75rem;
    color: #EF4444 !important;
    text-align: center;
}}
/* Role label styling */
.sb-role-label {{
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #2563EB !important;
    margin-bottom: 0.3rem;
    display: block;
}}
.sb-role-label.acquirer {{ color: #60A5FA !important; }}
.sb-role-label.target {{ color: #10B981 !important; }}
}}

/* â”€â”€ SIDEBAR SECTIONS (merger mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sb-section {{
    background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(16,185,129,0.03));
    border-left: 3px solid #2563EB;
    border-radius: 0 8px 8px 0;
    padding: 0.45rem 0.75rem;
    margin: 0.9rem 0 0.4rem 0;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.8px;
    color: #A8A3C7 !important;
    animation: slideInLeft 0.4s ease-out both;
}}
.sb-section-icon {{
    color: #60A5FA !important;
    margin-right: 0.3rem;
    font-size: 0.55rem;
}}
section[data-testid="stSidebar"] .stSlider [data-baseweb="slider"] [role="slider"] {{
    background: #60A5FA !important;
    border-color: #2563EB !important;
    box-shadow: 0 0 8px rgba(37,99,235,0.4);
    width: 14px !important; height: 14px !important;
}}
section[data-testid="stSidebar"] .stSlider label p {{
    font-size: 0.72rem !important;
    color: #9CA3AF !important;
}}
.sb-split-bar {{
    display: flex;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    margin: 0.5rem 0 0.3rem 0;
    background: rgba(255,255,255,0.05);
}}
.sb-split-cash {{
    background: linear-gradient(90deg, #2563EB, #60A5FA);
    border-radius: 4px 0 0 4px;
    transition: width 0.4s ease;
    overflow: hidden;
    animation: sb-fill 0.6s ease-out;
}}
.sb-split-stock {{
    background: linear-gradient(90deg, #10B981, #F5A4BD);
    border-radius: 0 4px 4px 0;
    transition: width 0.4s ease;
    overflow: hidden;
    animation: sb-fill 0.6s ease-out;
}}
.sb-split-labels {{
    display: flex;
    justify-content: space-between;
    font-size: 0.65rem;
    font-weight: 600;
    margin-top: 0.15rem;
}}
.sb-split-labels .cash-label {{ color: #60A5FA !important; }}
.sb-split-labels .stock-label {{ color: #10B981 !important; }}
.sb-divider {{
    height: 1px;
    border: none;
    margin: 0.6rem 0;
    background: linear-gradient(90deg, transparent, rgba(37,99,235,0.3), transparent);
}}

/* â”€â”€ HERO / HEADER (profile view - clean professional) â”€â”€â”€â”€ */
.hero-header {{
    background: rgba(17, 24, 39, 0.7);
    backdrop-filter: blur(16px);
    border-radius: 12px;
    padding: 2rem 2.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-bottom: 3px solid #2563EB;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
}}
.hero-title {{
    font-size: 2.2rem;
    font-weight: 800;
    color: #ffffff;
    margin: 0;
    letter-spacing: -0.5px;
    position: relative; z-index: 1;
}}
.hero-accent {{ color: #60A5FA; }}
.hero-sub {{
    font-size: 1rem;
    color: #A8A3C7;
    margin-top: 0.3rem;
    font-weight: 400;
    position: relative; z-index: 1;
}}
.hero-tagline {{
    display: inline-block;
    background: rgba(37,99,235,0.15);
    color: #60A5FA;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 0.5rem;
    position: relative; z-index: 1;
}}

/* â”€â”€ COMPANY HEADER CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.company-card {{
    background: rgba(17, 24, 39, 0.7);
    border-radius: 12px;
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    padding: 1.8rem 2rem;
    transition: all 0.3s ease;
    margin-bottom: 1.2rem;
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-left: 3px solid #2563EB;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    animation: cardReveal 0.4s ease-out both;
}}
.company-card:hover {{
    border-color: rgba(37,99,235,0.15);
    border-left-color: #60A5FA;
    box-shadow: 0 6px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(37,99,235,0.1);
    transform: translateY(-2px);
}}
.company-card::before {{
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(ellipse at 80% 20%, rgba(37,99,235,0.08) 0%, transparent 60%);
    pointer-events: none;
}}
.company-card::after {{
    content: '';
    position: absolute;
    width: 80px; height: 80px; border-radius: 50%;
    background: rgba(37,99,235,0.06);
    filter: blur(40px);
    top: -20px; right: 40px;
    animation: float1 20s ease-in-out infinite;
    pointer-events: none;
}}
.company-name {{
    font-size: 1.8rem;
    font-weight: 800;
    color: #ffffff;
    margin: 0;
    letter-spacing: -0.3px;
}}
.company-meta {{
    font-size: 0.85rem;
    color: #A8A3C7;
    margin-top: 0.25rem;
}}
.company-meta span {{ color: #60A5FA; font-weight: 600; }}
.price-tag {{ font-size: 1.5rem; font-weight: 700; margin: 0; }}
.price-up {{ color: #10B981; }}
.price-down {{ color: #EF4444; }}
.price-change {{
    font-size: 0.85rem; font-weight: 600;
    padding: 0.15rem 0.5rem; border-radius: 6px;
    display: inline-block; margin-left: 0.5rem;
}}
.change-up {{ 
    background: rgba(16,185,129,0.15); 
    color: #10B981; 
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    border: 1px solid rgba(16,185,129,0.3);
}}
.change-down {{ 
    background: rgba(239,68,68,0.15); 
    color: #EF4444; 
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    border: 1px solid rgba(239,68,68,0.3);
}}

/* â”€â”€ SECTION STYLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-header {{
    display: flex; align-items: center; gap: 0.8rem;
    margin: 2.5rem 0 1rem 0; padding-bottom: 0.6rem;
    position: relative;
    animation: slideUpBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}}
.section-header::after {{
    content: '';
    position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, #2563EB, #10B981, transparent);
    animation: glowPulse 3s ease-in-out infinite;
    border-radius: 2px;
}}
.section-header h3 {{
    font-size: 1.3rem; font-weight: 800; color: #F9FAFB; margin: 0; letter-spacing: -0.3px;
}}
.section-header .accent-bar {{
    width: 5px; height: 26px; background: linear-gradient(180deg, #2563EB, #10B981); border-radius: 3px;
}}

/* â”€â”€ GRADIENT DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gradient-divider {{
    height: 1px; border: none; margin: 1.5rem 0;
    background: linear-gradient(90deg, transparent, rgba(37,99,235,0.3), rgba(16,185,129,0.2), transparent);
    position: relative;
}}
.gradient-divider::after {{
    content: '';
    position: absolute;
    top: -2px; left: 0; right: 0;
    height: 5px;
    background: linear-gradient(90deg, transparent, rgba(37,99,235,0.15), rgba(16,185,129,0.1), transparent);
    filter: blur(4px);
    animation: glowPulse 3s ease-in-out infinite;
}}

/* â”€â”€ METRIC CARDS (defined earlier, this section removed for cleanup) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    background: linear-gradient(90deg, #2563EB, #60A5FA, #10B981);
    opacity: 0; transition: opacity 0.3s ease;
}}
div[data-testid="stMetric"]:hover {{
    border-color: rgba(37,99,235,0.4);
    box-shadow: 0 10px 30px rgba(37,99,235,0.25);
    transform: translateY(-5px);
}}
div[data-testid="stMetric"]:hover::before {{
    opacity: 1;
}}
div[data-testid="stMetric"] label {{
    font-size: 0.75rem !important; font-weight: 600 !important;
    text-transform: uppercase; letter-spacing: 0.8px; color: #9CA3AF !important;
}}
div[data-testid="stMetric"] div[data-testid="stMetricValue"] {{
    font-size: 1.25rem !important; font-weight: 700 !important; color: #F9FAFB !important;
}}

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stTabs [data-baseweb="tab-list"] {{
    gap: 0; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px;
}}
.stTabs [data-baseweb="tab"] {{
    border-radius: 10px; font-weight: 600; font-size: 0.82rem;
    padding: 0.5rem 1.2rem; color: #9CA3AF;
}}
.stTabs [data-baseweb="tab"][aria-selected="true"] {{
    background: linear-gradient(135deg, #2563EB, #60A5FA);
    color: #ffffff;
    box-shadow: 0 2px 12px rgba(37,99,235,0.4);
}}
.stTabs [data-baseweb="tab-highlight"] {{ display: none; }}
.stTabs [data-baseweb="tab-border"] {{ display: none; }}

/* â”€â”€ EXPANDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.streamlit-expanderHeader {{
    font-weight: 600 !important; font-size: 0.95rem !important;
    color: #F9FAFB !important; background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
}}

/* â”€â”€ DATAFRAMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stDataFrame {{
    border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden;
}}

/* â”€â”€ DOWNLOAD BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stDownloadButton > button {{
    background: linear-gradient(135deg, #2563EB, #10B981, #F5A623) !important;
    background-size: 200% 200% !important;
    animation: gradientShift 6s ease infinite !important;
    color: white !important; font-weight: 700 !important;
    border: none !important; border-radius: 16px !important;
    padding: 0.8rem 2rem !important; font-size: 1rem !important;
    width: 100% !important; transition: all 0.2s ease;
    box-shadow: 0 4px 25px rgba(37,99,235,0.3);
}}
.stDownloadButton > button:hover {{
    transform: translateY(-2px);
    box-shadow: 0 8px 35px rgba(37,99,235,0.5);
}}

/* â”€â”€ NEWS CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.news-item {{
    padding: 0.65rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: background 0.15s;
}}
.news-item:hover {{ background: rgba(17,24,39,0.7); backdrop-filter: blur(16px); }}
.news-title {{
    font-weight: 600; color: #F9FAFB; font-size: 0.88rem; text-decoration: none;
}}
.news-title:hover {{ color: #60A5FA; }}
.news-pub {{ font-size: 0.72rem; color: #9CA3AF; font-weight: 500; }}

/* â”€â”€ PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pill {{
    display: inline-block; padding: 0.2rem 0.7rem; border-radius: 20px;
    font-size: 0.72rem; font-weight: 600; letter-spacing: 0.5px;
}}
.pill-purple {{ background: rgba(37,99,235,0.12); color: #2563EB; }}
.pill-dark {{ background: rgba(26,29,46,0.08); color: #1A1D2E; }}
.pill-green {{ background: rgba(16,185,129,0.12); color: #10B981; }}

/* â”€â”€ PLOTLY CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stPlotlyChart {{
    border: 1px solid rgba(37,99,235,0.25);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(37,99,235,0.18);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    background: rgba(37,99,235,0.04);
    animation: chartBounceIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    filter: saturate(0.9);
    padding: 0.5rem;
}}
.stPlotlyChart:hover {{
    border-color: rgba(37,99,235,0.6);
    box-shadow: 0 16px 48px rgba(37,99,235,0.35), 0 0 80px rgba(37,99,235,0.1);
    transform: translateY(-4px) scale(1.008);
    filter: saturate(1.15);
}}
/* Ensure chart modebar is visible and styled */
.stPlotlyChart .modebar {{
    top: 10px !important;
    right: 10px !important;
}}
.stPlotlyChart .modebar-btn {{
    font-size: 16px !important;
}}

/* â”€â”€ RADIO BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stRadio > div {{ gap: 0.3rem; }}
.stRadio > div > label {{
    background: rgba(255,255,255,0.05); border-radius: 8px; padding: 0.3rem 1rem;
    font-weight: 600; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.1); color: #D1D5DB;
}}
.stRadio > div > label[data-checked="true"] {{
    background: linear-gradient(135deg, #2563EB, #60A5FA); color: #ffffff;
}}

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar {{ width: 6px; height: 6px; }}
::-webkit-scrollbar-track {{ background: rgba(17,24,39,0.7); backdrop-filter: blur(16px); border-radius: 10px; }}
::-webkit-scrollbar-thumb {{ background: rgba(37,99,235,0.4); border-radius: 10px; }}
::-webkit-scrollbar-thumb:hover {{ background: #60A5FA; }}

/* â”€â”€ SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stSpinner > div > div {{ border-top-color: #2563EB !important; }}

/* â”€â”€ HIDE BRANDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#MainMenu {{ visibility: hidden; }}
footer {{ visibility: hidden; }}
header {{ visibility: hidden; }}

/* â”€â”€ LOADING SKELETON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes shimmer {{
    0% {{ background-position: -200% 0; }}
    100% {{ background-position: 200% 0; }}
}}
.skeleton {{
    background: linear-gradient(90deg, rgba(37,99,235,0.05) 25%, rgba(37,99,235,0.12) 50%, rgba(37,99,235,0.05) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
    border-radius: 8px;
}}
.skeleton-text {{ height: 14px; margin-bottom: 8px; width: 80%; }}
.skeleton-card {{ height: 100px; margin-bottom: 12px; }}
.skeleton-chart {{ height: 200px; margin-bottom: 12px; }}

/* â”€â”€ CARD HOVER EFFECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hover-lift {{
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}}
.hover-lift:hover {{
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(37,99,235,0.15);
}}

/* â”€â”€ CUSTOM FOOTER (minimal, clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orbital-footer {{
    margin-top: 4rem;
    padding: 1.5rem 1rem;
    text-align: center;
    border-top: 1px solid rgba(255,255,255,0.06);
}}
.orbital-footer-brand {{
    font-size: 0.9rem;
    font-weight: 700;
    color: #60A5FA;
    letter-spacing: 1px;
}}
.orbital-footer-links {{
    margin-top: 0.5rem;
    display: flex;
    justify-content: center;
    gap: 1.5rem;
}}
.orbital-footer-links a {{
    color: #6B7280;
    text-decoration: none;
    font-size: 0.7rem;
    font-weight: 500;
    transition: color 0.2s;
}}
.orbital-footer-links a:hover {{
    color: #9CA3AF;
}}
.orbital-footer-version {{
    font-size: 0.65rem;
    color: #6B7280;
    margin-top: 0.5rem;
}}

/* â”€â”€ PRINT STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media print {{
    .stSidebar, .stToolbar, .orbital-footer, header, #MainMenu {{ display: none !important; }}
    .main .block-container {{ padding: 0 !important; max-width: 100% !important; }}
    * {{ color: #333 !important; background: white !important; }}
}}

/* â”€â”€ PRICE DISPLAY BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.price-bar {{
    background: rgba(17, 24, 39, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 16px; padding: 1rem 1.5rem; margin-bottom: 1rem;
    display: flex; gap: 1.5rem; align-items: center;
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    transition: all 0.3s ease;
}}
.price-bar:hover {{
    border-color: rgba(37,99,235,0.2);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}}

/* â”€â”€ MERGER CHART WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.merger-chart-wrapper {{
    background: rgba(17, 24, 39, 0.7);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px; padding: 2rem; margin: 1rem 0 1.5rem 0;
    animation: fadeInUp 0.4s ease-out both;
}}

/* â”€â”€ PRECEDENT & INSIDER TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.precedent-table, .insider-table {{
    width: 100%; border-collapse: separate; border-spacing: 0;
    border-radius: 16px; overflow: hidden;
    animation: bounceIn 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}}
.precedent-table th, .insider-table th {{
    background: rgba(37,99,235,0.15); color: #60A5FA; font-size: 0.7rem;
    text-transform: uppercase; letter-spacing: 1px;
    padding: 0.7rem 0.8rem; font-weight: 700;
    border-bottom: 2px solid rgba(37,99,235,0.3);
}}
.precedent-table td, .insider-table td {{
    padding: 0.55rem 0.8rem; font-size: 0.8rem; color: #C8C3E3;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background 0.2s ease;
}}
.precedent-table tr:hover td, .insider-table tr:hover td {{
    background: rgba(37,99,235,0.12);
}}

/* â”€â”€ NEWS SENTIMENT CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.news-card {{
    background: rgba(17,24,39,0.7); backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px; padding: 0.8rem 1rem; margin-bottom: 0.6rem;
    animation: slideUpBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    transition: all 0.3s ease;
    cursor: pointer;
}}
.news-card:hover {{
    border-color: rgba(37,99,235,0.35);
    transform: translateY(-3px) scale(1.01);
    box-shadow: 0 8px 24px rgba(37,99,235,0.2), 0 0 0 1px rgba(37,99,235,0.08);
}}
.news-sentiment-bullish {{ border-left: 3px solid #10B981; }}
.news-sentiment-bearish {{ border-left: 3px solid #EF4444; }}
.news-sentiment-neutral {{ border-left: 3px solid #9CA3AF; }}

/* â”€â”€ EARNINGS SURPRISE CHART CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.earnings-beat {{ color: #10B981; font-weight: 700; }}
.earnings-miss {{ color: #EF4444; font-weight: 700; }}

/* â”€â”€ PROFILE CHART WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-chart-wrapper {{
    background: rgba(17, 24, 39, 0.7);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px; padding: 2rem; margin: 1rem 0 1.5rem 0;
    position: relative; overflow: hidden;
    animation: fadeInUp 0.4s ease-out both;
}}
.profile-chart-wrapper::before {{
    content: '';
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 40%, rgba(37,99,235,0.03) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(6,182,212,0.02) 0%, transparent 50%);
    pointer-events: none;
    animation: nebulaPulse 20s ease-in-out infinite;
}}

/* â”€â”€ SCANNER LOADING (profile mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scanner-control {{
    background: linear-gradient(170deg, #020515 0%, #0C0F1A 40%, #151933 100%);
    border-radius: 24px;
    padding: 2.5rem;
    min-height: 360px;
    position: relative;
    overflow: hidden;
    animation: fadeInScale 0.5s ease-out both;
    border: 1px solid rgba(6,182,212,0.2);
}}
.scanner-control::before {{
    content: '';
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background:
        radial-gradient(ellipse at 25% 30%, rgba(6,182,212,0.08) 0%, transparent 55%),
        radial-gradient(ellipse at 75% 70%, rgba(59,130,246,0.05) 0%, transparent 55%);
    pointer-events: none;
}}
.scanner-control::after {{
    content: '';
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: transparent;
    box-shadow: {_gen_stars(40, 600)};
    width: 1px; height: 1px;
    opacity: 0.4;
    pointer-events: none;
}}
.scanner-dish-container {{
    text-align: center;
    height: 100px;
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}}
.scanner-dish {{
    font-size: 3.5rem;
    filter: drop-shadow(0 0 12px rgba(6,182,212,0.5));
    position: relative;
    z-index: 2;
}}
.scanner-dish-scanning {{
    animation: scannerSweep 2s ease-in-out infinite;
}}
.scanner-dish-locked {{
    animation: scannerLock 1.5s ease-in-out infinite;
}}
.scanner-beam {{
    width: 60px; height: 3px;
    background: linear-gradient(90deg, transparent, rgba(6,182,212,0.6), transparent);
    border-radius: 2px;
    margin: -6px auto 0 auto;
    animation: scannerBeamSweep 1.5s ease-in-out infinite;
}}
.scanner-ring {{
    position: absolute;
    top: 50%; left: 50%;
    width: 40px; height: 40px;
    border-radius: 50%;
    border: 1px solid rgba(6,182,212,0.3);
    transform: translate(-50%, -50%);
    animation: scannerRingPulse 2s ease-out infinite;
}}
.scanner-ring-2 {{
    animation-delay: 0.7s;
}}
.scanner-ring-3 {{
    animation-delay: 1.4s;
}}
/* Cyan accent overrides for scanner */
.scanner-control .phase-indicator-active {{
    border-color: rgba(6,182,212,0.5);
    color: #06B6D4;
}}
.scanner-control .phase-indicator-active::after {{
    border-top-color: #06B6D4;
}}
.scanner-control .mission-phase-active {{
    background: rgba(6,182,212,0.1);
    border-color: rgba(6,182,212,0.25);
    animation: scannerPhasePulse 2s ease-in-out infinite;
}}
.scanner-control .mission-progress-fill {{
    background: linear-gradient(90deg, #06B6D4, #3B82F6, #2563EB, #06B6D4);
    background-size: 200% 100%;
}}
.scanner-control .mission-progress-fill::after {{
    box-shadow: 0 0 10px rgba(6,182,212,0.8), 0 0 20px rgba(6,182,212,0.4);
}}
.scanner-ticker {{
    text-align: center;
    margin-top: 1.2rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.06);
    position: relative;
    z-index: 1;
}}
.scanner-ticker span {{
    font-size: 1rem;
    font-weight: 800;
    color: #06B6D4;
    letter-spacing: 3px;
    text-shadow: 0 0 15px rgba(6,182,212,0.4);
}}
.scanner-dots {{
    display: inline-block;
    margin-left: 4px;
}}
.scanner-dots span {{
    display: inline-block;
    width: 4px; height: 4px;
    border-radius: 50%;
    background: #06B6D4;
    margin: 0 2px;
    animation: gentlePulse 1.5s ease-in-out infinite;
}}
.scanner-dots span:nth-child(2) {{ animation-delay: 0.3s; }}
.scanner-dots span:nth-child(3) {{ animation-delay: 0.6s; }}
</style>
""", unsafe_allow_html=True)

# â”€â”€ Space-specific CSS (starfield, nebula, orbs, glass cards) â”€â”€
st.markdown(f"""
<style>
/* â”€â”€ SPLASH HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.splash-hero {{
    background: transparent;
    border-radius: 0; padding: 5rem 3rem 4rem; text-align: center;
    margin: -1rem calc(-50vw + 50%); width: 100vw;
    position: relative; overflow: hidden;
    min-height: 90vh;
}}

/* Star Layer 1 â€” small distant stars */
.star-layer-1 {{
    position: absolute; top: 0; left: 0; width: 1px; height: 1px;
    box-shadow: {_STARS1};
    opacity: 0.6;
    animation: starDrift1 150s linear infinite;
}}
.star-layer-1::after {{
    content: ''; position: absolute; top: 2000px; left: 0;
    width: 1px; height: 1px;
    box-shadow: {_STARS1};
}}

/* Star Layer 2 â€” medium stars */
.star-layer-2 {{
    position: absolute; top: 0; left: 0; width: 1.5px; height: 1.5px;
    box-shadow: {_STARS2};
    opacity: 0.8;
    animation: starDrift2 100s linear infinite;
}}
.star-layer-2::after {{
    content: ''; position: absolute; top: 2000px; left: 0;
    width: 1.5px; height: 1.5px;
    box-shadow: {_STARS2};
}}

/* Star Layer 3 â€” large close stars */
.star-layer-3 {{
    position: absolute; top: 0; left: 0; width: 2px; height: 2px;
    box-shadow: {_STARS3};
    opacity: 1.0;
    animation: starDrift3 75s linear infinite;
}}
.star-layer-3::after {{
    content: ''; position: absolute; top: 2000px; left: 0;
    width: 2px; height: 2px;
    box-shadow: {_STARS3};
}}

/* Nebula overlay */
.nebula-overlay {{
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background:
        radial-gradient(ellipse at 20% 50%, rgba(37,99,235,0.10) 0%, transparent 50%),
        radial-gradient(ellipse at 75% 20%, rgba(16,185,129,0.06) 0%, transparent 45%),
        radial-gradient(ellipse at 50% 80%, rgba(59,130,246,0.05) 0%, transparent 50%);
    animation: nebulaPulse 30s ease-in-out infinite;
    pointer-events: none;
}}

/* Floating luminous orbs */
.orb {{
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
}}
.orb-1 {{
    width: 200px; height: 200px;
    background: rgba(37,99,235,0.06);
    filter: blur(80px);
    top: 10%; left: 5%;
    animation: float1 30s ease-in-out infinite;
}}
.orb-2 {{
    width: 160px; height: 160px;
    background: rgba(16,185,129,0.05);
    filter: blur(70px);
    top: 60%; right: 10%;
    animation: float2 35s ease-in-out infinite;
}}
.orb-3 {{
    width: 120px; height: 120px;
    background: rgba(59,130,246,0.04);
    filter: blur(60px);
    top: 30%; right: 25%;
    animation: float3 28s ease-in-out infinite;
}}

/* Shooting stars (subtle, elegant) */
.shooting-star {{
    position: absolute;
    width: 100px; height: 1px;
    background: linear-gradient(90deg, rgba(255,255,255,0.4), transparent);
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
}}
.shooting-star-1 {{ top: 15%; left: 70%; animation: shootingStar 12s ease-in-out 3s infinite; }}
.shooting-star-2 {{ top: 35%; left: 85%; animation: shootingStar 15s ease-in-out 7s infinite; }}
.shooting-star-3 {{ top: 55%; left: 60%; animation: shootingStar 18s ease-in-out 11s infinite; }}

/* Noise/grain overlay */
.noise-overlay {{
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    opacity: 0.03;
    pointer-events: none;
}}

/* Title glow halo */
.title-glow {{
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(37,99,235,0.15) 0%, transparent 70%);
    animation: titleGlow 6s ease-in-out infinite;
    pointer-events: none;
}}

/* Content layer */
.splash-content {{
    position: relative; z-index: 10;
}}

.splash-title {{
    font-size: 4.5rem; font-weight: 900; color: #ffffff; margin: 0;
    letter-spacing: -2px; animation: fadeInUp 0.6s ease-out;
    text-shadow: 0 0 60px rgba(37,99,235,0.3);
}}
.splash-accent {{
    background: linear-gradient(135deg, #60A5FA, #10B981, #F5A623, #60A5FA);
    background-size: 200% auto;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: shimmer 3s linear infinite;
}}
.splash-subtitle {{
    font-size: 1.2rem; color: #D1D5DB; margin-top: 0.8rem;
    font-weight: 300; animation: fadeInUp 0.8s ease-out;
    letter-spacing: 0.5px;
    text-shadow: 0 0 15px rgba(37,99,235,0.15);
}}
.splash-stats {{
    display: flex; justify-content: center; gap: 3rem; margin-top: 2.5rem;
    animation: fadeInUp 1s ease-out;
}}
.splash-stat-value {{
    font-size: 1.8rem; font-weight: 800; color: #fff;
    animation: gentlePulse 3s ease-in-out infinite;
    position: relative;
    text-shadow: 0 0 20px rgba(37,99,235,0.4), 0 0 40px rgba(37,99,235,0.2);
}}
.splash-stat {{
    position: relative;
}}
.splash-stat:nth-child(1) .splash-stat-value {{ animation-delay: 0s; }}
.splash-stat:nth-child(2) .splash-stat-value {{ animation-delay: 0.5s; }}
.splash-stat:nth-child(3) .splash-stat-value {{ animation-delay: 1.0s; }}
.splash-stat-icon {{
    position: relative;
    display: inline-block;
}}
.splash-stat-icon::before {{
    content: '';
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    border: 2px solid rgba(37,99,235,0.4);
    animation: pulseRing 2s ease-out infinite;
    pointer-events: none;
}}
.splash-stat-label {{
    font-size: 0.7rem; color: #A8A3C7; text-transform: uppercase;
    letter-spacing: 1px; font-weight: 500;
}}
.pill-row {{
    display: flex; justify-content: center; gap: 0.7rem; margin-top: 1.8rem;
    flex-wrap: wrap;
    animation: fadeInUp 1.2s ease-out;
}}
.feature-pill {{
    border: 1px solid rgba(37,99,235,0.3); border-radius: 24px;
    padding: 0.4rem 1.1rem; font-size: 0.75rem; font-weight: 600;
    color: #D1D5DB; background: rgba(37,99,235,0.06);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    cursor: pointer;
}}
.feature-pill:hover {{
    border-color: rgba(37,99,235,0.6);
    box-shadow: 0 0 20px rgba(37,99,235,0.35), 0 4px 12px rgba(0,0,0,0.2);
    color: #fff;
    background: rgba(37,99,235,0.12);
    transform: translateY(-2px) scale(1.02);
}}

/* â”€â”€ SPACE SECTION (dark container for glass cards) â”€â”€â”€â”€ */
.space-section {{
    background: rgba(11,14,26,0.5);
    border-radius: 0;
    padding: 2.5rem 3rem;
    margin: 0 calc(-50vw + 50%); width: 100vw;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}}
.space-section-title {{
    font-size: 0.75rem; font-weight: 600; color: #9CA3AF;
    text-transform: uppercase; letter-spacing: 2px;
    text-align: center; margin-bottom: 1.5rem;
    position: relative;
    padding-bottom: 0.75rem;
}}
.space-section-title::after {{
    content: '';
    position: absolute;
    bottom: 0; left: 50%; transform: translateX(-50%);
    width: 60px; height: 2px;
    background: linear-gradient(90deg, transparent, #2563EB, transparent);
    border-radius: 2px;
}}

/* â”€â”€ GLASS STEP CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.step-grid {{
    display: flex; gap: 1.2rem; margin: 0 0 2rem 0;
    position: relative;
}}
.step-card {{
    flex: 1;
    background: rgba(17,24,39,0.7); backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 18px; padding: 1.5rem; text-align: center;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    position: relative; overflow: hidden;
    animation: fadeInUp 0.6s ease-out both;
    cursor: pointer;
}}
.step-card:nth-child(1) {{ animation-delay: 0.1s; }}
.step-card:nth-child(2) {{ animation-delay: 0.2s; }}
.step-card:nth-child(3) {{ animation-delay: 0.3s; }}
.step-card:nth-child(4) {{ animation-delay: 0.4s; }}
.step-card::before {{
    content: '';
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 18px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(37,99,235,0.3), rgba(16,185,129,0.1), transparent);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0; transition: opacity 0.3s;
    pointer-events: none;
}}
.step-card:hover {{
    border-color: rgba(37,99,235,0.4); transform: translateY(-6px) scale(1.02);
    box-shadow: 0 12px 36px rgba(37,99,235,0.25), 0 0 0 1px rgba(37,99,235,0.1);
}}
.step-card:hover::before {{ opacity: 1; }}
.step-num {{
    background: linear-gradient(135deg, #2563EB, #60A5FA);
    color: #fff; width: 38px; height: 38px; border-radius: 50%;
    display: inline-flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 1rem; margin-bottom: 0.6rem;
    box-shadow: 0 4px 15px rgba(37,99,235,0.3);
    transition: transform 0.3s ease;
}}
.step-card:hover .step-num {{
    transform: scale(1.1);
}}
.step-label {{ font-size: 0.88rem; font-weight: 700; color: #F9FAFB; }}
.step-detail {{ font-size: 0.72rem; color: #9CA3AF; margin-top: 0.3rem; }}

/* Connector lines between steps */
.step-connector {{
    position: absolute; top: 50%; height: 2px; z-index: 0;
    background: linear-gradient(90deg, rgba(37,99,235,0.2), rgba(16,185,129,0.2), rgba(37,99,235,0.2));
    background-size: 200% 100%;
    animation: shimmerLine 3s linear infinite;
}}

/* â”€â”€ GLASS FEATURE CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feature-grid {{
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 1rem; margin-top: 0.5rem;
}}
.feature-card {{
    background: rgba(17, 24, 39, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px; padding: 1.5rem 1.2rem; text-align: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    animation: fadeInScale 0.4s ease-out both;
    position: relative; overflow: hidden;
    cursor: pointer;
}}
.feature-card:nth-child(1) {{ animation-delay: 0.05s; }}
.feature-card:nth-child(2) {{ animation-delay: 0.1s; }}
.feature-card:nth-child(3) {{ animation-delay: 0.15s; }}
.feature-card:nth-child(4) {{ animation-delay: 0.2s; }}
.feature-card:nth-child(5) {{ animation-delay: 0.25s; }}
.feature-card:nth-child(6) {{ animation-delay: 0.3s; }}
.feature-card:nth-child(7) {{ animation-delay: 0.35s; }}
.feature-card:nth-child(8) {{ animation-delay: 0.4s; }}
.feature-card::before {{
    content: '';
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 18px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(37,99,235,0.3), rgba(16,185,129,0.1), transparent);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0; transition: opacity 0.3s;
    pointer-events: none;
}}
.feature-card:hover {{
    border-color: rgba(37,99,235,0.3); transform: translateY(-6px) scale(1.03);
    box-shadow: 0 12px 32px rgba(37,99,235,0.25), 0 0 0 1px rgba(37,99,235,0.1);
}}
.feature-card:hover::before {{ opacity: 1; }}
.feature-icon {{ 
    font-size: 2.2rem; margin-bottom: 0.5rem;
    transition: transform 0.3s ease;
}}
.feature-card:hover .feature-icon {{
    transform: scale(1.15);
}}
.feature-title {{ font-size: 0.88rem; font-weight: 700; color: #F9FAFB; margin-bottom: 0.3rem; }}
.feature-desc {{ font-size: 0.72rem; color: #9CA3AF; line-height: 1.6; }}

/* â”€â”€ MISSION CONTROL (Merger Loading) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mission-control {{
    background: linear-gradient(170deg, #020515 0%, #0C0F1A 40%, #151933 100%);
    border-radius: 24px;
    padding: 2.5rem;
    min-height: 420px;
    position: relative;
    overflow: hidden;
    animation: fadeInScale 0.5s ease-out both;
    border: 1px solid rgba(37,99,235,0.2);
}}
.mission-control::before {{
    content: '';
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background:
        radial-gradient(ellipse at 25% 30%, rgba(37,99,235,0.08) 0%, transparent 55%),
        radial-gradient(ellipse at 75% 70%, rgba(16,185,129,0.05) 0%, transparent 55%);
    pointer-events: none;
}}
.mission-control::after {{
    content: '';
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: transparent;
    box-shadow: {_gen_stars(40, 600)};
    width: 1px; height: 1px;
    opacity: 0.4;
    pointer-events: none;
}}
.mission-header {{
    text-align: center;
    margin-bottom: 1.5rem;
    position: relative;
    z-index: 1;
}}
.mission-title {{
    font-size: 1.1rem;
    font-weight: 800;
    color: #F9FAFB;
    text-transform: uppercase;
    letter-spacing: 3px;
    margin: 0;
    text-shadow: 0 0 20px rgba(37,99,235,0.4);
}}
.mission-subtitle {{
    font-size: 0.72rem;
    color: #9CA3AF;
    margin-top: 0.3rem;
    text-transform: uppercase;
    letter-spacing: 2px;
}}
.rocket-container {{
    text-align: center;
    height: 120px;
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}}
.rocket {{
    font-size: 3.5rem;
    filter: drop-shadow(0 0 12px rgba(37,99,235,0.5));
    position: relative;
    z-index: 2;
}}
.rocket-idle {{
    animation: float1 6s ease-in-out infinite;
}}
.rocket-launching {{
    animation: rocketLaunch 2s ease-in forwards;
}}
.rocket-flame {{
    font-size: 1.5rem;
    filter: drop-shadow(0 0 8px rgba(255,165,0,0.7));
    animation: flameFlicker 0.3s ease-in-out infinite;
    margin-top: -8px;
}}
.exhaust-trail {{
    width: 4px;
    height: 30px;
    background: linear-gradient(to bottom, rgba(255,165,0,0.4), rgba(37,99,235,0.2), transparent);
    filter: blur(2px);
    margin: 0 auto;
    animation: exhaustTrail 0.8s ease-out infinite;
}}
.mission-progress-track {{
    height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    margin: 1.2rem 0;
    overflow: hidden;
    position: relative;
    z-index: 1;
}}
.mission-progress-fill {{
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, #2563EB, #60A5FA, #10B981, #2563EB);
    background-size: 200% 100%;
    animation: progressGlow 2s linear infinite;
    transition: width 0.6s ease;
    position: relative;
}}
.mission-progress-fill::after {{
    content: '';
    position: absolute;
    right: 0; top: 50%;
    transform: translateY(-50%);
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 0 10px rgba(155,138,255,0.8), 0 0 20px rgba(37,99,235,0.4);
}}
.mission-phases {{
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    position: relative;
    z-index: 1;
}}
.mission-phase {{
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.6rem 1rem;
    border-radius: 12px;
    transition: all 0.2s ease;
}}
.mission-phase-active {{
    background: rgba(37,99,235,0.1);
    border: 1px solid rgba(37,99,235,0.25);
    animation: missionPulse 2s ease-in-out infinite;
}}
.mission-phase-complete {{
    background: rgba(16,185,129,0.06);
    border: 1px solid rgba(16,185,129,0.15);
}}
.mission-phase-pending {{
    opacity: 0.4;
    border: 1px solid transparent;
}}
.phase-indicator {{
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    flex-shrink: 0;
}}
.phase-indicator-active {{
    border: 2px solid rgba(37,99,235,0.5);
    color: #60A5FA;
    position: relative;
}}
.phase-indicator-active::after {{
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: #60A5FA;
    animation: spin 1s linear infinite;
}}
.phase-indicator-complete {{
    background: rgba(16,185,129,0.2);
    color: #10B981;
    animation: checkPop 0.4s ease-out both;
}}
.phase-indicator-pending {{
    border: 1px solid rgba(255,255,255,0.15);
    color: #555;
}}
.phase-label {{
    font-size: 0.82rem;
    font-weight: 600;
    color: #F9FAFB;
}}
.phase-sublabel {{
    font-size: 0.68rem;
    color: #9CA3AF;
    margin-top: 0.1rem;
}}
.mission-stats {{
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.8rem;
    margin-top: 1.2rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.06);
    position: relative;
    z-index: 1;
}}
.mission-stats span {{
    font-size: 0.85rem;
    font-weight: 700;
    color: #60A5FA;
    letter-spacing: 1px;
}}
.mission-stats .mission-x {{
    font-size: 1.2rem;
    color: #10B981;
    font-weight: 300;
}}
</style>
""", unsafe_allow_html=True)


# â”€â”€ HELPER: Mission Control loading screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _render_mission_control(acquirer: str, target: str, current_phase: int, total_phases: int = 5) -> str:
    """Return HTML for the animated mission control loading UI."""
    phases = [
        (f"Acquiring Target Intel: {acquirer}", "Scanning financial databases..."),
        (f"Locking Signal: {target}", "Establishing secure data link..."),
        ("Mapping Sector Constellation", "Triangulating peer coordinates..."),
        ("Computing Orbital Mechanics", "Pro forma trajectory analysis..."),
        ("Synthesizing Mission Report", "AI engines generating insights..."),
    ]
    completed = min(current_phase, total_phases)
    pct = int((completed / total_phases) * 100)

    # Rocket state
    if current_phase >= total_phases:
        rocket_cls = "rocket rocket-launching"
        flame_html = ""
        exhaust_html = ""
    else:
        rocket_cls = "rocket rocket-idle"
        flame_html = '<div class="rocket-flame">ğŸ”¥</div>'
        exhaust_html = '<div class="exhaust-trail"></div>'

    # Build phase rows
    phase_rows = ""
    for i, (label, sublabel) in enumerate(phases):
        if i < current_phase:
            row_cls = "mission-phase mission-phase-complete"
            ind_cls = "phase-indicator phase-indicator-complete"
            ind_content = "âœ“"
        elif i == current_phase:
            row_cls = "mission-phase mission-phase-active"
            ind_cls = "phase-indicator phase-indicator-active"
            ind_content = str(i + 1)
        else:
            row_cls = "mission-phase mission-phase-pending"
            ind_cls = "phase-indicator phase-indicator-pending"
            ind_content = str(i + 1)
        phase_rows += (
            f'<div class="{row_cls}">'
            f'<div class="{ind_cls}">{ind_content}</div>'
            f'<div><div class="phase-label">{label}</div>'
            f'<div class="phase-sublabel">{sublabel}</div></div>'
            f'</div>'
        )

    return (
        f'<div class="mission-control">'
        f'<div class="mission-header">'
        f'<div class="mission-title">Merger Analysis Mission Control</div>'
        f'<div class="mission-subtitle">Phase {completed} of {total_phases}</div>'
        f'</div>'
        f'<div class="rocket-container">'
        f'<div class="{rocket_cls}">ğŸš€</div>'
        f'{flame_html}'
        f'{exhaust_html}'
        f'</div>'
        f'<div class="mission-progress-track">'
        f'<div class="mission-progress-fill" style="width:{pct}%;"></div>'
        f'</div>'
        f'<div class="mission-phases">{phase_rows}</div>'
        f'<div class="mission-stats">'
        f'<span>{acquirer}</span>'
        f'<span class="mission-x">Ã—</span>'
        f'<span>{target}</span>'
        f'</div>'
        f'</div>'
    )


# â”€â”€ HELPER: Profile scanner loading screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _render_profile_scanner(ticker: str, current_phase: int, total_phases: int = 3) -> str:
    """Return HTML for the animated scanner loading UI for company profiles."""
    phases = [
        ("Scanning Financial Databases", "Fetching market data & fundamentals..."),
        ("Analyzing Financials & Peers", "Comparing against sector peers..."),
        ("Generating AI Insights", "Building investment thesis..."),
    ]
    completed = min(current_phase, total_phases)
    pct = int((completed / total_phases) * 100)

    # Dish state
    if current_phase >= total_phases:
        dish_cls = "scanner-dish scanner-dish-locked"
        beam_html = ""
        ring_html = ""
    else:
        dish_cls = "scanner-dish scanner-dish-scanning"
        beam_html = '<div class="scanner-beam"></div>'
        ring_html = (
            '<div class="scanner-ring"></div>'
            '<div class="scanner-ring scanner-ring-2"></div>'
            '<div class="scanner-ring scanner-ring-3"></div>'
        )

    # Build phase rows (reuse mission-phase classes)
    phase_rows = ""
    for i, (label, sublabel) in enumerate(phases):
        if i < current_phase:
            row_cls = "mission-phase mission-phase-complete"
            ind_cls = "phase-indicator phase-indicator-complete"
            ind_content = "\u2713"
        elif i == current_phase:
            row_cls = "mission-phase mission-phase-active"
            ind_cls = "phase-indicator phase-indicator-active"
            ind_content = str(i + 1)
        else:
            row_cls = "mission-phase mission-phase-pending"
            ind_cls = "phase-indicator phase-indicator-pending"
            ind_content = str(i + 1)
        phase_rows += (
            f'<div class="{row_cls}">'
            f'<div class="{ind_cls}">{ind_content}</div>'
            f'<div><div class="phase-label">{label}</div>'
            f'<div class="phase-sublabel">{sublabel}</div></div>'
            f'</div>'
        )

    dots = '<span class="scanner-dots"><span></span><span></span><span></span></span>'

    return (
        f'<div class="scanner-control">'
        f'<div class="mission-header">'
        f'<div class="mission-title">Company Scanner</div>'
        f'<div class="mission-subtitle">Phase {completed} of {total_phases}</div>'
        f'</div>'
        f'<div class="scanner-dish-container">'
        f'<div class="{dish_cls}">\U0001F4E1</div>'
        f'{beam_html}'
        f'{ring_html}'
        f'</div>'
        f'<div class="mission-progress-track">'
        f'<div class="mission-progress-fill" style="width:{pct}%;"></div>'
        f'</div>'
        f'<div class="mission-phases">{phase_rows}</div>'
        f'<div class="scanner-ticker">'
        f'<span>{ticker}</span>{dots}'
        f'</div>'
        f'</div>'
    )


# â”€â”€ HELPER: Section header with accent bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _section(title, icon=""):
    st.markdown(
        f'<div class="section-header">'
        f'<div class="accent-bar"></div>'
        f'<h3>{icon}  {title}</h3>'
        f'</div>',
        unsafe_allow_html=True,
    )


# â”€â”€ HELPER: Gradient divider between sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _divider():
    st.markdown('<div class="gradient-divider"></div>', unsafe_allow_html=True)


from contextlib import contextmanager
@contextmanager
def _safe_section(name=""):
    """Wrap a section in try/except to prevent one section from crashing the whole profile."""
    try:
        yield
    except Exception as e:
        st.warning(f"âš ï¸ {name} section encountered an issue â€” data may be unavailable for this security. Try a different ticker or check back later.")
        import traceback
        with st.expander("Show error details", expanded=False):
            st.code(traceback.format_exc())


# â”€â”€ HELPER: Peer radar chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_peer_radar_chart(cd):
    """Build a Plotly radar chart comparing target vs peer median."""
    if not cd.peer_data:
        return

    metrics = ["P/E", "Fwd P/E", "EV/EBITDA", "Gross Margin", "Op Margin", "ROE"]

    target_vals = [
        cd.trailing_pe, cd.forward_pe, cd.ev_to_ebitda,
        (cd.gross_margins or 0) * 100, (cd.operating_margins or 0) * 100,
        (cd.return_on_equity or 0) * 100,
    ]

    peer_keys = ["trailing_pe", "forward_pe", "ev_to_ebitda",
                 "gross_margins", "operating_margins", "return_on_equity"]
    pct_keys = {"gross_margins", "operating_margins", "return_on_equity"}

    peer_medians = []
    for key in peer_keys:
        vals = [p.get(key) for p in cd.peer_data if p.get(key) is not None]
        if key in pct_keys:
            vals = [v * 100 for v in vals]
        peer_medians.append(float(np.median(vals)) if vals else 0)

    # Normalize to 0-100 scale
    norm_target, norm_peer = [], []
    for t, p in zip(target_vals, peer_medians):
        t = t if t is not None else 0
        mx = max(abs(t), abs(p), 1)
        norm_target.append(min(t / mx * 100, 120))
        norm_peer.append(min(p / mx * 100, 120))

    fig = go.Figure()
    fig.add_trace(go.Scatterpolar(
        r=norm_target + [norm_target[0]],
        theta=metrics + [metrics[0]],
        fill='toself', name=cd.ticker,
        fillcolor='rgba(37,99,235,0.15)',
        line=dict(color='#2563EB', width=3),
        marker=dict(size=8, line=dict(color="#fff", width=1.5)),
    ))
    fig.add_trace(go.Scatterpolar(
        r=norm_peer + [norm_peer[0]],
        theta=metrics + [metrics[0]],
        fill='toself', name='Peer Median',
        fillcolor='rgba(16,185,129,0.08)',
        line=dict(color='#10B981', width=3),
        marker=dict(size=7, line=dict(color="#fff", width=1.5)),
    ))
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        polar=dict(
            radialaxis=dict(visible=True, range=[0, 120], tickfont=dict(size=8, color="#9CA3AF"),
                            gridcolor="rgba(37,99,235,0.1)"),
            angularaxis=dict(tickfont=dict(size=10, color="#9CA3AF"),
                             gridcolor="rgba(37,99,235,0.08)"),
            bgcolor="rgba(0,0,0,0)",
        ),
        showlegend=True, height=520,
        margin=dict(t=50, b=50, l=70, r=70),
        legend=dict(font=dict(size=11, color="#D1D5DB")),
    )
    st.plotly_chart(fig, use_container_width=True)


# â”€â”€ CHART: Revenue & Margins â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_revenue_margin_chart(cd, key="rev_margin"):
    """Revenue bars with gross/EBITDA/net margin lines on secondary y-axis."""
    if cd.revenue is None or len(cd.revenue) == 0:
        st.info("Revenue data not available for chart.")
        return
    rev = cd.revenue.dropna().sort_index()
    years = [idx.strftime("%Y") if hasattr(idx, "strftime") else str(idx) for idx in rev.index]
    n = len(years)
    # Progressive alpha â€” older bars dimmer, newest brightest
    bar_alphas = [0.35 + 0.45 * (i / max(n - 1, 1)) for i in range(n)]
    bar_colors = [f"rgba(37,99,235,{a:.2f})" for a in bar_alphas]
    fig = go.Figure()
    fig.add_trace(go.Bar(
        x=years, y=rev.values, name="Revenue",
        marker=dict(color=bar_colors, line=dict(color="rgba(255,255,255,0.15)", width=1)),
        text=[format_number(v, currency_symbol=cd.currency_symbol) for v in rev.values],
        textposition="outside", textfont=dict(size=9, color="#D1D5DB"),
    ))
    for series, name, color in [
        (cd.gross_margin_series, "Gross Margin", "#10B981"),
        (cd.ebitda_margin, "EBITDA Margin", "#10B981"),
        (cd.net_margin_series, "Net Margin", "#F5A623"),
    ]:
        if series is not None and len(series) > 0:
            s = series.dropna().sort_index()
            yrs = [idx.strftime("%Y") if hasattr(idx, "strftime") else str(idx) for idx in s.index]
            _glow_line_traces(fig, yrs, s.values, color, name, yaxis="y2")
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=500, margin=dict(t=40, b=40, l=60, r=60),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
        yaxis=dict(title=dict(text="Revenue", font=dict(size=10, color="#9CA3AF")),
                   tickfont=dict(size=9, color="#9CA3AF")),
        yaxis2=dict(title=dict(text="Margin %", font=dict(size=10, color="#9CA3AF")),
                    overlaying="y", side="right", showgrid=False,
                    tickfont=dict(size=9, color="#9CA3AF"), ticksuffix="%"),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
        barmode="group",
    )
    _apply_space_grid(fig)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Cash Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_cashflow_chart(cd, key="cashflow"):
    """Grouped bars: OCF, CapEx (negative), FCF, dividends."""
    series_map = [
        (cd.operating_cashflow_series, "Operating CF", "#2563EB"),
        (cd.capital_expenditure, "CapEx", "#EF4444"),
        (cd.free_cashflow_series, "Free CF", "#10B981"),
        (cd.dividends_paid, "Dividends", "#F5A623"),
    ]
    has_data = any(s is not None and len(s) > 0 for s, _, _ in series_map)
    if not has_data:
        st.info("Cash flow data not available for chart.")
        return
    fig = go.Figure()
    for series, name, color in series_map:
        if series is not None and len(series) > 0:
            s = series.dropna().sort_index()
            years = [idx.strftime("%Y") if hasattr(idx, "strftime") else str(idx) for idx in s.index]
            nc = len(years)
            bar_alphas = [0.4 + 0.5 * (i / max(nc - 1, 1)) for i in range(nc)]
            # Parse hex to build progressive rgba
            r, g, b = int(color[1:3], 16), int(color[3:5], 16), int(color[5:7], 16)
            bar_cols = [f"rgba({r},{g},{b},{a:.2f})" for a in bar_alphas]
            fig.add_trace(go.Bar(
                x=years, y=s.values, name=name,
                marker=dict(color=bar_cols, line=dict(color="rgba(255,255,255,0.15)", width=1)),
            ))
    fig.add_hline(y=0, line_dash="dot", line_color="rgba(255,255,255,0.15)", line_width=1)
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=500, margin=dict(t=40, b=40, l=60, r=60),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
        yaxis=dict(title=dict(text="Amount", font=dict(size=10, color="#9CA3AF")),
                   tickfont=dict(size=9, color="#9CA3AF")),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
        barmode="group",
    )
    _apply_space_grid(fig)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Balance Sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_balance_sheet_chart(cd, key="balance_sheet"):
    """Stacked equity+debt bars with cash and total assets overlay lines."""
    has_data = any(
        s is not None and len(s) > 0
        for s in [cd.total_equity, cd.total_debt, cd.cash_and_equivalents, cd.total_assets]
    )
    if not has_data:
        st.info("Balance sheet data not available for chart.")
        return
    fig = go.Figure()
    # Stacked bars: equity + debt with progressive alpha
    for series, name, base_rgba in [
        (cd.total_equity, "Equity", (107, 92, 231)),
        (cd.total_debt, "Debt", (239, 68, 68)),
    ]:
        if series is not None and len(series) > 0:
            s = series.dropna().sort_index()
            years = [idx.strftime("%Y") if hasattr(idx, "strftime") else str(idx) for idx in s.index]
            nc = len(years)
            bar_alphas = [0.3 + 0.45 * (i / max(nc - 1, 1)) for i in range(nc)]
            bar_colors = [f"rgba({base_rgba[0]},{base_rgba[1]},{base_rgba[2]},{a:.2f})" for a in bar_alphas]
            fig.add_trace(go.Bar(
                x=years, y=s.values, name=name,
                marker=dict(color=bar_colors, line=dict(color="rgba(255,255,255,0.15)", width=1)),
            ))
    # Overlay lines with glow
    for series, name, color in [
        (cd.cash_and_equivalents, "Cash", "#10B981"),
        (cd.total_assets, "Total Assets", "#F5A623"),
    ]:
        if series is not None and len(series) > 0:
            s = series.dropna().sort_index()
            years = [idx.strftime("%Y") if hasattr(idx, "strftime") else str(idx) for idx in s.index]
            _glow_line_traces(fig, years, s.values, color, name)
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=500, margin=dict(t=40, b=40, l=60, r=60),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
        yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
        barmode="stack",
    )
    _apply_space_grid(fig)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Peer Valuation Comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_peer_valuation_chart(cd, key="peer_val"):
    """Horizontal grouped bars: company vs peer median on key multiples."""
    if not cd.peer_data:
        st.info("Peer data not available for valuation comparison.")
        return
    metrics = [
        ("P/E", "trailing_pe", cd.trailing_pe),
        ("Fwd P/E", "forward_pe", cd.forward_pe),
        ("EV/EBITDA", "ev_to_ebitda", cd.ev_to_ebitda),
        ("P/S", "price_to_sales", cd.price_to_sales),
    ]
    labels, company_vals, peer_vals = [], [], []
    for label, key, company_val in metrics:
        if company_val is None:
            continue
        peer_raw = [p.get(key) for p in cd.peer_data if p.get(key) is not None]
        if not peer_raw:
            continue
        labels.append(label)
        company_vals.append(company_val)
        peer_vals.append(float(np.median(peer_raw)))
    if not labels:
        st.info("Insufficient data for peer valuation chart.")
        return
    fig = go.Figure()
    fig.add_trace(go.Bar(
        y=labels, x=company_vals, orientation="h", name=cd.ticker,
        marker=dict(color="#2563EB", line=dict(color="rgba(255,255,255,0.15)", width=1)),
        text=[f"{v:.1f}x" for v in company_vals],
        textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
    ))
    fig.add_trace(go.Bar(
        y=labels, x=peer_vals, orientation="h", name="Peer Median",
        marker=dict(color="#10B981", line=dict(color="rgba(255,255,255,0.15)", width=1)),
        text=[f"{v:.1f}x" for v in peer_vals],
        textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
    ))
    # Premium/discount annotations
    for i, (cv, pv) in enumerate(zip(company_vals, peer_vals)):
        if pv != 0:
            pct = (cv - pv) / abs(pv) * 100
            color = "#10B981" if pct < 0 else "#EF4444"
            sign = "+" if pct >= 0 else ""
            fig.add_annotation(
                y=labels[i], x=max(cv, pv) * 1.15,
                text=f"{sign}{pct:.0f}%", showarrow=False,
                font=dict(size=9, color=color, family="Inter"),
            )
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=400, margin=dict(t=40, b=30, l=90, r=90),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
        yaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), autorange="reversed"),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
        barmode="group",
    )
    _apply_space_grid(fig, show_x_grid=True)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Earnings Surprise â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_earnings_surprise_chart(cd, key="earnings_surprise"):
    """Color-coded bars: green for beats, red for misses."""
    if cd.earnings_dates is None or cd.earnings_dates.empty:
        st.info("Earnings data not available for surprise chart.")
        return
    df = cd.earnings_dates.copy()
    # Try to find EPS columns
    est_col = None
    act_col = None
    for c in df.columns:
        cl = str(c).lower()
        if "estimate" in cl or "eps estimate" in cl:
            est_col = c
        if "reported" in cl or "actual" in cl or "eps actual" in cl:
            act_col = c
    if est_col is None or act_col is None:
        st.info("Earnings surprise data not available.")
        return
    df = df.dropna(subset=[est_col, act_col])
    if df.empty:
        st.info("No earnings surprise data to display.")
        return
    df = df.head(8).sort_index()
    surprises = df[act_col].astype(float) - df[est_col].astype(float)
    labels = [f"{s:+.2f}" for s in surprises]
    dates = [idx.strftime("%b %Y") if hasattr(idx, "strftime") else str(idx) for idx in df.index]
    # Intensity-proportional alpha: bigger surprise = brighter
    max_abs = max(abs(s) for s in surprises) if len(surprises) > 0 else 1
    bar_colors = []
    for s in surprises:
        intensity = 0.4 + 0.6 * (abs(s) / max(max_abs, 0.01))
        if s >= 0:
            bar_colors.append(f"rgba(16,185,129,{intensity:.2f})")
        else:
            bar_colors.append(f"rgba(239,68,68,{intensity:.2f})")

    fig = go.Figure(go.Bar(
        x=dates, y=surprises.values,
        marker=dict(color=bar_colors, line=dict(color="rgba(255,255,255,0.15)", width=1)),
        text=labels, textposition="outside",
        textfont=dict(size=10, color="#D1D5DB"),
    ))
    fig.add_hline(y=0, line_dash="dot", line_color="rgba(255,255,255,0.15)", line_width=1)
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=400, margin=dict(t=40, b=40, l=60, r=40),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
        yaxis=dict(title=dict(text="EPS Surprise", font=dict(size=10, color="#9CA3AF")),
                   tickfont=dict(size=9, color="#9CA3AF")),
    )
    _apply_space_grid(fig)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Accretion/Dilution Waterfall â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_accretion_waterfall(pro_forma, key="accretion_waterfall"):
    """Waterfall chart showing EPS bridge from standalone to pro forma."""
    steps = pro_forma.waterfall_steps
    if not steps:
        st.info("Waterfall data not available.")
        return

    labels = [s["label"] for s in steps]
    values = [s["value"] for s in steps]
    types = [s["type"] for s in steps]

    # Build Plotly waterfall measure types
    measures = []
    for t in types:
        if t == "absolute":
            measures.append("absolute")
        elif t == "total":
            measures.append("total")
        else:
            measures.append("relative")

    colors = []
    for i, (v, t) in enumerate(zip(values, types)):
        if t == "absolute":
            colors.append("#2563EB")
        elif t == "total":
            colors.append("#60A5FA" if v >= values[0] else "#EF4444")
        else:
            colors.append("#10B981" if v >= 0 else "#EF4444")

    # Determine totals marker outline
    totals_color = "#60A5FA" if values[-1] >= values[0] else "#EF4444"
    fig = go.Figure(go.Waterfall(
        x=labels, y=values, measure=measures,
        text=[f"${v:.2f}" for v in values],
        textposition="outside",
        textfont=dict(size=10, color="#D1D5DB"),
        connector=dict(line=dict(color="rgba(37,99,235,0.2)", width=1, dash="dot")),
        increasing=dict(marker=dict(color="#10B981", line=dict(color="rgba(255,255,255,0.15)", width=1))),
        decreasing=dict(marker=dict(color="#EF4444", line=dict(color="rgba(255,255,255,0.15)", width=1))),
        totals=dict(marker=dict(color=totals_color, line=dict(color="#fff", width=1.5))),
    ))

    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=600, margin=dict(t=40, b=40, l=60, r=60),
        xaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
        yaxis=dict(title=dict(text="EPS ($)", font=dict(size=10, color="#9CA3AF")),
                   tickfont=dict(size=9, color="#9CA3AF"),
                   tickprefix="$"),
    )
    _apply_space_grid(fig)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Football Field Valuation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_football_field_chart(football_field, currency_symbol="$", key="football_field"):
    """Horizontal range bars with offer price reference line."""
    offer_price = football_field.get("_offer_price", 0)
    methods = {k: v for k, v in football_field.items() if not k.startswith("_")}

    if not methods:
        st.info("Insufficient data for football field chart.")
        return

    labels = list(methods.keys())
    lows = [methods[m]["low"] for m in labels]
    highs = [methods[m]["high"] for m in labels]

    colors = ["#2563EB", "#10B981", "#F5A623", "#10B981", "#3B82F6"]

    fig = go.Figure()
    for i, label in enumerate(labels):
        fig.add_trace(go.Bar(
            y=[label], x=[highs[i] - lows[i]],
            base=[lows[i]], orientation="h",
            marker=dict(
                color=colors[i % len(colors)], opacity=0.85,
                line=dict(color="rgba(255,255,255,0.15)", width=1),
            ),
            name=label,
            text=[f"{label}: {format_number(lows[i], currency_symbol=currency_symbol)} \u2014 {format_number(highs[i], currency_symbol=currency_symbol)}"],
            textposition="inside",
            textfont=dict(size=9, color="#fff"),
            hoverinfo="text",
            showlegend=False,
        ))

    if offer_price > 0:
        # Shaded band around offer price (+-5%)
        band_lo = offer_price * 0.95
        band_hi = offer_price * 1.05
        fig.add_vrect(
            x0=band_lo, x1=band_hi,
            fillcolor="rgba(239,68,68,0.06)", line_width=0,
        )
        fig.add_vline(
            x=offer_price, line_dash="dash", line_color="#EF4444", line_width=2,
            annotation_text=f"Offer: {format_number(offer_price, currency_symbol=currency_symbol)}",
            annotation_position="top",
            annotation_font=dict(size=10, color="#EF4444"),
        )

    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=550, margin=dict(t=50, b=40, l=130, r=70),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
        yaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), autorange="reversed"),
        barmode="stack",
    )
    _apply_space_grid(fig, show_x_grid=True)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Deal Structure Donut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_deal_structure_donut(assumptions, key="deal_donut"):
    """Pie chart with hole showing cash/stock split."""
    # Pull the larger slice
    pull_vals = [0.05, 0] if assumptions.pct_cash >= assumptions.pct_stock else [0, 0.05]
    fig = go.Figure(go.Pie(
        labels=["Cash", "Stock"],
        values=[assumptions.pct_cash, assumptions.pct_stock],
        hole=0.55,
        pull=pull_vals,
        marker=dict(
            colors=["#2563EB", "#10B981"],
            line=dict(color="#fff", width=1.5),
        ),
        textinfo="label+percent",
        textfont=dict(size=12, color="#fff"),
        hoverinfo="label+percent+value",
    ))
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=450, margin=dict(t=40, b=40, l=40, r=40),
        showlegend=False,
        annotations=[dict(text="Deal<br>Mix", x=0.5, y=0.5, font_size=14,
                         font_color="#F9FAFB", showarrow=False)],
    )
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ CHART: Company Comparison Bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_company_comparison_bars(acq_cd, tgt_cd, key="company_compare"):
    """Grouped horizontal bars comparing acquirer vs target on key metrics."""
    metrics = []
    acq_vals = []
    tgt_vals = []

    for label, acq_v, tgt_v in [
        ("Gross Margin %", (acq_cd.gross_margins or 0) * 100, (tgt_cd.gross_margins or 0) * 100),
        ("Op Margin %", (acq_cd.operating_margins or 0) * 100, (tgt_cd.operating_margins or 0) * 100),
        ("Net Margin %", (acq_cd.profit_margins or 0) * 100, (tgt_cd.profit_margins or 0) * 100),
        ("ROE %", (acq_cd.return_on_equity or 0) * 100, (tgt_cd.return_on_equity or 0) * 100),
    ]:
        metrics.append(label)
        acq_vals.append(acq_v)
        tgt_vals.append(tgt_v)

    fig = go.Figure()
    fig.add_trace(go.Bar(
        y=metrics, x=acq_vals, orientation="h", name=acq_cd.ticker,
        marker=dict(color="#2563EB", line=dict(color="rgba(255,255,255,0.15)", width=1)),
        text=[f"{v:.1f}%" for v in acq_vals],
        textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
    ))
    fig.add_trace(go.Bar(
        y=metrics, x=tgt_vals, orientation="h", name=tgt_cd.ticker,
        marker=dict(color="#10B981", line=dict(color="rgba(255,255,255,0.15)", width=1)),
        text=[f"{v:.1f}%" for v in tgt_vals],
        textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
    ))
    # Star annotation on winning metric
    for i, (av, tv) in enumerate(zip(acq_vals, tgt_vals)):
        winner_x = max(av, tv) * 1.12
        fig.add_annotation(
            y=metrics[i], x=winner_x,
            text="\u2605", showarrow=False,
            font=dict(size=10, color="#F5A623"),
        )
    fig.update_layout(
        **_CHART_LAYOUT_BASE,
        height=500, margin=dict(t=40, b=30, l=110, r=80),
        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), ticksuffix="%"),
        yaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), autorange="reversed"),
        legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
        barmode="group",
    )
    _apply_space_grid(fig, show_x_grid=True)
    st.plotly_chart(fig, use_container_width=True, key=key)


# â”€â”€ RENDER: SWOT Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _render_swot_grid(swot):
    """2x2 CSS grid with color-coded SWOT cards."""
    if not swot:
        st.info("SWOT analysis not available.")
        return
    quadrants = [
        ("Strengths", swot.get("strengths", []), "#10B981", "rgba(16,185,129,0.08)", "rgba(16,185,129,0.25)"),
        ("Weaknesses", swot.get("weaknesses", []), "#EF4444", "rgba(239,68,68,0.08)", "rgba(239,68,68,0.25)"),
        ("Opportunities", swot.get("opportunities", []), "#2563EB", "rgba(37,99,235,0.08)", "rgba(37,99,235,0.25)"),
        ("Threats", swot.get("threats", []), "#F5A623", "rgba(245,166,35,0.08)", "rgba(245,166,35,0.25)"),
    ]
    html = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">'
    for title, items, color, bg, border_color in quadrants:
        bullets = "".join(
            f'<div style="font-size:0.84rem; color:#D1D5DB; line-height:1.7; padding:0.15rem 0;">&bull; {item}</div>'
            for item in items
        ) if items else '<div style="font-size:0.84rem; color:#9CA3AF;">No data available</div>'
        html += (
            f'<div style="background:{bg}; border:1px solid {border_color}; border-radius:14px; padding:1.2rem;">'
            f'<div style="font-size:0.85rem; font-weight:700; color:{color}; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.5px;">{title}</div>'
            f'{bullets}'
            f'</div>'
        )
    html += '</div>'
    st.markdown(html, unsafe_allow_html=True)


# â”€â”€ RENDER: Growth Outlook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _render_growth_outlook(growth, cd):
    """Rating badge + thesis sub-sections + catalyst/risk columns."""
    if not growth:
        st.info("Growth outlook not available.")
        return
    rating = growth.get("growth_rating", "MODERATE")
    rating_colors = {"STRONG": "#10B981", "MODERATE": "#F5A623", "WEAK": "#EF4444"}
    rating_color = rating_colors.get(rating, "#9CA3AF")
    rating_bg = {"STRONG": "rgba(16,185,129,0.12)", "MODERATE": "rgba(245,166,35,0.12)", "WEAK": "rgba(239,68,68,0.12)"}

    st.markdown(
        f'<div style="display:inline-block; background:{rating_bg.get(rating, "rgba(138,133,173,0.12)")}; '
        f'color:{rating_color}; padding:0.4rem 1.2rem; border-radius:12px; font-weight:700; '
        f'font-size:0.9rem; letter-spacing:1px; margin-bottom:1rem;">Growth Rating: {rating}</div>',
        unsafe_allow_html=True,
    )

    for key, title in [("revenue_thesis", "Revenue Thesis"), ("margin_thesis", "Margin Thesis"), ("earnings_path", "Earnings Path")]:
        text = growth.get(key, "")
        if text:
            # Clean bullet prefix
            clean = text.strip()
            if clean.startswith("- "):
                clean = clean[2:]
            st.markdown(
                f'<div style="margin-bottom:0.8rem;">'
                f'<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.2rem;">{title}</div>'
                f'<div style="font-size:0.85rem; color:#D1D5DB; line-height:1.7;">{clean}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )

    # Catalysts & Risks in two columns
    cat_col, risk_col = st.columns(2)
    with cat_col:
        st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#10B981; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem;">Key Catalysts</div>', unsafe_allow_html=True)
        for item in growth.get("key_catalysts", []):
            st.markdown(f'<div style="font-size:0.84rem; color:#D1D5DB; line-height:1.7; padding:0.1rem 0;">&bull; {item}</div>', unsafe_allow_html=True)
    with risk_col:
        st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#EF4444; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem;">Key Risks to Growth</div>', unsafe_allow_html=True)
        for item in growth.get("key_risks_to_growth", []):
            st.markdown(f'<div style="font-size:0.84rem; color:#D1D5DB; line-height:1.7; padding:0.1rem 0;">&bull; {item}</div>', unsafe_allow_html=True)


# â”€â”€ RENDER: Capital Allocation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _render_capital_allocation(ca, cd):
    """Letter grade badge + border-left styled sub-section cards."""
    if not ca:
        st.info("Capital allocation analysis not available.")
        return
    grade = ca.get("capital_allocation_grade", "B")
    grade_colors = {"A": "#10B981", "B": "#2563EB", "C": "#F5A623", "D": "#EF4444"}
    grade_color = grade_colors.get(grade, "#9CA3AF")
    grade_bg = {"A": "rgba(16,185,129,0.12)", "B": "rgba(37,99,235,0.12)", "C": "rgba(245,166,35,0.12)", "D": "rgba(239,68,68,0.12)"}

    st.markdown(
        f'<div style="display:inline-block; background:{grade_bg.get(grade, "rgba(138,133,173,0.12)")}; '
        f'color:{grade_color}; padding:0.4rem 1.2rem; border-radius:12px; font-weight:700; '
        f'font-size:0.9rem; letter-spacing:1px; margin-bottom:1rem;">Capital Allocation Grade: {grade}</div>',
        unsafe_allow_html=True,
    )

    sections = [
        ("Strategy Summary", ca.get("strategy_summary", ""), "#2563EB"),
        ("CapEx Assessment", ca.get("capex_assessment", ""), "#10B981"),
        ("Shareholder Returns", ca.get("shareholder_returns", ""), "#10B981"),
        ("M&A Strategy", ca.get("ma_strategy", ""), "#F5A623"),
        ("Debt Management", ca.get("debt_management", ""), "#9CA3AF"),
    ]
    for title, text, color in sections:
        if text:
            clean = text.strip()
            if clean.startswith("- "):
                clean = clean[2:]
            st.markdown(
                f'<div style="border-left:3px solid {color}; padding:0.6rem 0 0.6rem 1rem; margin-bottom:0.6rem;">'
                f'<div style="font-size:0.8rem; font-weight:700; color:{color}; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.15rem;">{title}</div>'
                f'<div style="font-size:0.85rem; color:#D1D5DB; line-height:1.7;">{clean}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )


# â”€â”€ Sidebar Helper: Render Company Preview Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _render_company_card(ticker: str, role: str = "") -> None:
    """Render a company preview card in the sidebar."""
    if not ticker or len(ticker) < 1:
        return

    info = _quick_ticker_lookup(ticker)
    if not info or not info.get("valid"):
        st.markdown(
            f'<div class="sb-company-invalid">âš ï¸ Could not find: {ticker}</div>',
            unsafe_allow_html=True,
        )
        return

    name = info.get("name", ticker)
    price = info.get("price")
    currency = info.get("currency", "USD")
    change_pct = info.get("change_pct")

    # Currency symbol
    curr_sym = {"USD": "$", "EUR": "â‚¬", "GBP": "Â£", "JPY": "Â¥", "CAD": "C$"}.get(currency, "$")

    # Price display
    price_str = f"{curr_sym}{price:,.2f}" if price else "â€”"

    # Change display
    if change_pct is not None:
        change_class = "up" if change_pct >= 0 else "down"
        change_str = f'<div class="sb-company-price-change {change_class}">{change_pct:+.2f}%</div>'
    else:
        change_str = ""

    # Logo - show ticker initial with gradient background (reliable, no external deps)
    initial = ticker[0] if ticker else "?"
    logo_html = f'<div class="sb-logo-fallback">{initial}</div>'

    # Role label
    role_html = f'<span class="sb-role-label {role.lower()}">{role}</span>' if role else ""

    st.markdown(
        f'{role_html}'
        f'<div class="sb-company-card">'
        f'{logo_html}'
        f'<div class="sb-company-info">'
        f'<div class="sb-company-name">{name}</div>'
        f'<div class="sb-company-ticker">{ticker}</div>'
        f'</div>'
        f'<div class="sb-company-price">'
        f'<div class="sb-company-price-value">{price_str}</div>'
        f'{change_str}'
        f'</div>'
        f'</div>',
        unsafe_allow_html=True,
    )


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HIDE SIDEBAR & TICKER AUTOCOMPLETE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.markdown("""
<style>
[data-testid="stSidebar"] {
    display: none !important;
}
</style>
""", unsafe_allow_html=True)

@st.cache_data(ttl=86400, show_spinner=False)
def get_ticker_list():
    """Get a list of common tickers for autocomplete."""
    tickers = {
        "AAPL": "Apple Inc.",
        "MSFT": "Microsoft Corporation",
        "GOOGL": "Alphabet Inc.",
        "AMZN": "Amazon.com Inc.",
        "META": "Meta Platforms Inc.",
        "NVDA": "NVIDIA Corporation",
        "TSLA": "Tesla Inc.",
        "JPM": "JPMorgan Chase & Co.",
        "V": "Visa Inc.",
        "JNJ": "Johnson & Johnson",
        "WMT": "Walmart Inc.",
        "PG": "Procter & Gamble Co.",
        "MA": "Mastercard Inc.",
        "UNH": "UnitedHealth Group Inc.",
        "HD": "The Home Depot Inc.",
        "DIS": "The Walt Disney Co.",
        "NFLX": "Netflix Inc.",
        "ADBE": "Adobe Inc.",
        "CRM": "Salesforce Inc.",
        "INTC": "Intel Corporation",
        "AMD": "Advanced Micro Devices",
        "CSCO": "Cisco Systems Inc.",
        "ORCL": "Oracle Corporation",
        "IBM": "IBM Corporation",
        "QCOM": "Qualcomm Inc.",
        "TXN": "Texas Instruments",
        "AVGO": "Broadcom Inc.",
        "NOW": "ServiceNow Inc.",
        "SHOP": "Shopify Inc.",
        "SNOW": "Snowflake Inc.",
        "PLTR": "Palantir Technologies",
        "BA": "Boeing Co.",
        "GS": "Goldman Sachs Group",
        "MS": "Morgan Stanley",
        "BLK": "BlackRock Inc.",
        "C": "Citigroup Inc.",
        "BAC": "Bank of America Corp.",
        "WFC": "Wells Fargo & Co.",
        "PFE": "Pfizer Inc.",
        "ABBV": "AbbVie Inc.",
        "MRK": "Merck & Co. Inc.",
        "LLY": "Eli Lilly and Co.",
        "TMO": "Thermo Fisher Scientific",
        "ABT": "Abbott Laboratories",
        "KO": "Coca-Cola Co.",
        "PEP": "PepsiCo Inc.",
        "COST": "Costco Wholesale Corp.",
        "NKE": "Nike Inc.",
        "MCD": "McDonald's Corp.",
        "SBUX": "Starbucks Corp.",
        "CAT": "Caterpillar Inc.",
        "DE": "Deere & Company",
        "GE": "GE Aerospace",
        "XOM": "Exxon Mobil Corp.",
        "CVX": "Chevron Corporation",
        # Canadian
        "RY.TO": "Royal Bank of Canada",
        "TD.TO": "Toronto-Dominion Bank",
        "BNS.TO": "Bank of Nova Scotia",
        "BMO.TO": "Bank of Montreal",
        "CM.TO": "CIBC",
        "SHOP.TO": "Shopify Inc. (TSX)",
        "ENB.TO": "Enbridge Inc.",
        "CNR.TO": "Canadian National Railway",
        "CP.TO": "Canadian Pacific Kansas City",
        "SU.TO": "Suncor Energy",
        "CSU.TO": "Constellation Software",
        "MFC.TO": "Manulife Financial",
        "SLF.TO": "Sun Life Financial",
        "T.TO": "TELUS Corp.",
        "BCE.TO": "BCE Inc.",
        "OTEX.TO": "Open Text Corp.",
        "DSG.TO": "Descartes Systems",
        # Constellation family
        "DSGX": "Descartes Systems (US)",
        "TYL": "Tyler Technologies",
        "SSNC": "SS&C Technologies",
        "BSY": "Bentley Systems",
        "GWRE": "Guidewire Software",
        "PCTY": "Paylocity",
        "PAYC": "Paycom Software",
        "CSGP": "CoStar Group",
        "APPF": "AppFolio Inc.",
    }
    return tickers

def ticker_autocomplete(label="Search ticker or company", key="ticker_search"):
    """Yahoo Finance-style ticker search with autocomplete."""
    tickers = get_ticker_list()
    
    # Create search options: "AAPL â€” Apple Inc."
    options = [""] + [f"{t} â€” {n}" for t, n in sorted(tickers.items())]
    
    selected = st.selectbox(
        label,
        options=options,
        key=key,
        placeholder="Type ticker or company name...",
        label_visibility="collapsed",
    )
    
    if selected and " â€” " in selected:
        return selected.split(" â€” ")[0].strip()
    return selected.strip().upper() if selected else ""


# â”€â”€ Sidebar (LEGACY - will be replaced with tabs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    # Animated Orbital Logo
    st.markdown(
        '<div style="text-align:center; padding: 1rem 0 0.5rem 0;">'
        '<div class="orbital-logo orbital-logo-sm" style="margin:0 auto;">'
        '<span class="orbital-text">ORBITAL</span>'
        '<div class="orbital-ring orbital-ring-1"></div>'
        '<div class="orbital-ring orbital-ring-2"></div>'
        '<div class="orbital-ring orbital-ring-3"></div>'
        '<div class="orbital-particle orbital-particle-1"></div>'
        '<div class="orbital-particle orbital-particle-2"></div>'
        '<div class="orbital-particle orbital-particle-3"></div>'
        '</div>'
        '<div style="font-size:0.6rem; color:#9CA3AF; margin-top:0.5rem; letter-spacing:1.5px; text-transform:uppercase;">M&amp;A Intelligence</div>'
        '</div>',
        unsafe_allow_html=True,
    )

    st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)

    # What's New expander
    with st.expander("ğŸ†• What's New in v6.5"):
        st.markdown(
            "- ğŸ” **VMS Screener** â€” Acquisition attractiveness scoring & Rule of 40 analysis\n"
            "- ğŸ“Š **Options P/L Simulator** â€” Visual payoff diagrams for calls & puts\n"
            "- ğŸ”„ **Sector Rotation Tracker** â€” ETF performance heatmap & momentum signals\n"
            "- âš¡ **Enhanced Comps** â€” Expanded peer benchmarking with correlation matrix",
        )

    st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)

    # Mode Toggle - Enhanced with colored indicators and hover effects
    _mode_colors = {
        "ğŸ“Š Company Profile": "#2563EB",
        "ğŸ“ˆ Comps Analysis": "#10B981",
        "ğŸ’¹ DCF Valuation": "#F5A623",
        "âš–ï¸ Quick Compare": "#3B82F6",
        "ğŸ¤ Merger Analysis": "#EF4444",
        "ğŸ” VMS Screener": "#8B5CF6",
        "ğŸ“Š Options P/L": "#EC4899",
        "ğŸ”„ Sector Rotation": "#14B8A6",
    }
    st.markdown(
        '<style>'
        '[data-testid="stSidebar"] .stRadio > div { gap: 2px !important; }'
        '[data-testid="stSidebar"] .stRadio > div > label {'
        '  border-left: 3px solid transparent;'
        '  padding: 0.35rem 0.6rem !important;'
        '  border-radius: 0 6px 6px 0;'
        '  transition: all 0.2s ease;'
        '  margin: 1px 0;'
        '}'
        '[data-testid="stSidebar"] .stRadio > div > label:hover {'
        '  background: rgba(37,99,235,0.12);'
        '  border-left-color: #2563EB;'
        '}'
        '[data-testid="stSidebar"] .stRadio > div > label[data-checked="true"],'
        '[data-testid="stSidebar"] .stRadio > div > label:has(input:checked) {'
        '  background: rgba(37,99,235,0.15);'
        '  border-left-color: #2563EB;'
        '  border-left-width: 3px;'
        '}'
        '</style>',
        unsafe_allow_html=True,
    )
    st.markdown(
        '<div style="font-size:0.65rem; font-weight:700; color:#9CA3AF; text-transform:uppercase; '
        'letter-spacing:1.5px; margin-bottom:0.3rem;">Analysis Mode</div>',
        unsafe_allow_html=True,
    )
    _mode_options = [
        "ğŸ“Š Company Profile", 
        "ğŸ“ˆ Comps Analysis", 
        "ğŸ’¹ DCF Valuation", 
        "âš–ï¸ Quick Compare", 
        "ğŸ¤ Merger Analysis",
        "ğŸ“‹ Due Diligence",
        "ğŸ”— Synergy Model",
        "ğŸ“… Integration Plan",
        "ğŸ’¼ Deal Structure",
        "ğŸ“Š Fairness Opinion",
        "ğŸ” VMS Screener", 
        "ğŸ“Š Options P/L", 
        "ğŸ”„ Sector Rotation"
    ]
    _mode_selection = st.radio(
        "Mode", 
        _mode_options, 
        horizontal=False, 
        label_visibility="collapsed"
    )
    # Strip emoji prefix for internal use
    analysis_mode = _mode_selection.split(" ", 1)[1] if " " in _mode_selection else _mode_selection

    st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)

    # Quick Stats â€” S&P 500 mini-card
    try:
        import yfinance as _yf_sp
        _sp500 = _yf_sp.Ticker("^GSPC")
        _sp_info = _sp500.fast_info
        _sp_price = getattr(_sp_info, 'last_price', None) or 0
        _sp_prev = getattr(_sp_info, 'previous_close', None) or _sp_price
        _sp_chg = _sp_price - _sp_prev
        _sp_chg_pct = (_sp_chg / _sp_prev * 100) if _sp_prev else 0
        _sp_color = "#10B981" if _sp_chg >= 0 else "#EF4444"
        _sp_arrow = "â–²" if _sp_chg >= 0 else "â–¼"
        st.markdown(
            f'<div style="background:rgba(37,99,235,0.08); border:1px solid rgba(37,99,235,0.15); border-radius:8px; padding:0.5rem 0.6rem; margin-bottom:0.5rem;">'
            f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:700; letter-spacing:1px; margin-bottom:0.2rem;">S&P 500</div>'
            f'<div style="display:flex; justify-content:space-between; align-items:baseline;">'
            f'<span style="font-size:0.85rem; font-weight:700; color:#F9FAFB;">{_sp_price:,.1f}</span>'
            f'<span style="font-size:0.72rem; color:{_sp_color}; font-weight:600;">{_sp_arrow} {_sp_chg:+,.1f} ({_sp_chg_pct:+.2f}%)</span>'
            f'</div>'
            f'</div>',
            unsafe_allow_html=True,
        )
    except Exception:
        pass

    st.markdown('<div style="height:0.3rem;"></div>', unsafe_allow_html=True)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # WATCHLIST SECTION (shown in all modes)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _init_watchlist()
    watchlist = _get_watchlist()
    
    if watchlist:
        with st.expander(f"ğŸ“‹ Watchlist ({len(watchlist)})", expanded=False):
            _init_watchlist_notes()

            # â”€â”€ Watchlist Dashboard â”€â”€
            try:
                total_mcap = 0
                best_perf = ("", -999)
                worst_perf = ("", 999)
                for _wt in watchlist:
                    _wi = st.session_state.watchlist_data.get(_wt, {})
                    _wmc = _wi.get("market_cap", 0) or 0
                    total_mcap += _wmc
                    _wch = _wi.get("change_pct", 0) or 0
                    if _wch > best_perf[1]:
                        best_perf = (_wt, _wch)
                    if _wch < worst_perf[1]:
                        worst_perf = (_wt, _wch)
                _mcap_str = f"${total_mcap/1e9:,.1f}B" if total_mcap >= 1e9 else f"${total_mcap/1e6:,.0f}M" if total_mcap >= 1e6 else "N/A"
                st.markdown(
                    f'<div style="background:rgba(37,99,235,0.06); border-radius:8px; padding:0.6rem; margin-bottom:0.5rem; font-size:0.72rem;">'
                    f'<div style="color:#9CA3AF; font-weight:700; margin-bottom:0.3rem;">ğŸ“Š PORTFOLIO SNAPSHOT</div>'
                    f'<div style="color:#D1D5DB;">Total Mkt Cap: <b style="color:#F9FAFB;">{_mcap_str}</b></div>'
                    f'<div style="color:#10B981;">Best: <b>{best_perf[0]}</b> ({best_perf[1]:+.2f}%)</div>'
                    f'<div style="color:#EF4444;">Worst: <b>{worst_perf[0]}</b> ({worst_perf[1]:+.2f}%)</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            except Exception:
                pass

            for wl_ticker in watchlist:
                wl_col1, wl_col2 = st.columns([4, 1])
                with wl_col1:
                    wl_info = st.session_state.watchlist_data.get(wl_ticker, {})
                    wl_price = wl_info.get("price", 0)
                    wl_change = wl_info.get("change_pct", 0)
                    change_color = "#10B981" if wl_change and wl_change >= 0 else "#EF4444"

                    # 52-week high/low alert
                    _52h = wl_info.get("52w_high", 0) or 0
                    _52l = wl_info.get("52w_low", 0) or 0
                    _alert_html = ""
                    if wl_price and _52l and _52l > 0:
                        _pct_from_low = (wl_price - _52l) / _52l * 100
                        _pct_from_high = (_52h - wl_price) / _52h * 100 if _52h > 0 else 100
                        if _pct_from_low <= 5:
                            _alert_html = '<span style="font-size:0.6rem; color:#10B981; margin-left:4px;">ğŸŸ¢ Near 52w Low</span>'
                        elif _pct_from_high <= 5:
                            _alert_html = '<span style="font-size:0.6rem; color:#F59E0B; margin-left:4px;">ğŸŸ¡ Near 52w High</span>'

                    st.markdown(
                        f'<div style="display:flex; justify-content:space-between; align-items:center; padding:0.3rem 0;">'
                        f'<span style="font-weight:700; color:#F9FAFB;">{wl_ticker}{_alert_html}</span>'
                        f'<span style="color:{change_color}; font-size:0.8rem;">${wl_price:,.2f}</span>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
                with wl_col2:
                    if st.button("âœ•", key=f"remove_{wl_ticker}", help=f"Remove {wl_ticker}"):
                        _remove_from_watchlist(wl_ticker)
                        st.rerun()
                # Inline note for this ticker
                current_note = _get_watchlist_note(wl_ticker)
                new_note = st.text_input(
                    "Note", value=current_note, key=f"note_{wl_ticker}",
                    placeholder="Add a note...", label_visibility="collapsed"
                )
                if new_note != current_note:
                    _set_watchlist_note(wl_ticker, new_note)

            # â”€â”€ Watchlist Heat Map & Correlation (3+ items) â”€â”€
            if len(watchlist) >= 3:
                st.markdown(
                    '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin:0.5rem 0 0.3rem;">ğŸ“Š WATCHLIST INTELLIGENCE</div>',
                    unsafe_allow_html=True,
                )

                wl_intel_tab1, wl_intel_tab2 = st.tabs(["ğŸ—ºï¸ Heat Map", "ğŸ”— Correlation"])

                with wl_intel_tab1:
                    try:
                        _hm_labels = []
                        _hm_values = []
                        _hm_colors = []
                        _hm_sizes = []
                        for _wt in watchlist:
                            _wi = st.session_state.watchlist_data.get(_wt, {})
                            _chg = _wi.get("change_pct", 0) or 0
                            _mcap = _wi.get("market_cap", 1e9) or 1e9
                            _hm_labels.append(_wt)
                            _hm_values.append(_mcap)
                            _hm_colors.append(_chg)
                            _hm_sizes.append(_mcap)

                        if _hm_labels:
                            _hm_text = [f"{l}<br>{c:+.2f}%" for l, c in zip(_hm_labels, _hm_colors)]
                            fig_hm = go.Figure(go.Treemap(
                                labels=_hm_labels,
                                parents=[""] * len(_hm_labels),
                                values=_hm_sizes,
                                marker=dict(
                                    colors=_hm_colors,
                                    colorscale=[[0, "#EF4444"], [0.5, "#1a1a2e"], [1, "#10B981"]],
                                    cmid=0,
                                    line=dict(width=1, color="rgba(255,255,255,0.1)"),
                                ),
                                text=_hm_text,
                                textinfo="text",
                                textfont=dict(size=11, color="#F9FAFB"),
                                hovertemplate="<b>%{label}</b><br>Change: %{color:+.2f}%<extra></extra>",
                            ))
                            fig_hm.update_layout(
                                **_CHART_LAYOUT_BASE, height=220,
                                margin=dict(t=5, b=5, l=5, r=5),
                            )
                            st.plotly_chart(fig_hm, use_container_width=True, key="wl_heatmap")
                    except Exception:
                        st.caption("Heat map unavailable")

                with wl_intel_tab2:
                    try:
                        _corr_data = {}
                        for _wt in watchlist:
                            try:
                                _tk = yf.Ticker(_wt)
                                _h = _tk.history(period="3mo")
                                if _h is not None and not _h.empty and len(_h) > 5:
                                    _corr_data[_wt] = _h["Close"].pct_change().dropna()
                            except Exception:
                                pass
                        if len(_corr_data) >= 2:
                            _corr_df = pd.DataFrame(_corr_data)
                            _corr_matrix = _corr_df.corr()

                            fig_corr = go.Figure(go.Heatmap(
                                z=_corr_matrix.values,
                                x=_corr_matrix.columns.tolist(),
                                y=_corr_matrix.index.tolist(),
                                colorscale=[[0, "#EF4444"], [0.5, "#1a1a2e"], [1, "#10B981"]],
                                zmin=-1, zmax=1,
                                text=np.round(_corr_matrix.values, 2),
                                texttemplate="%{text}",
                                textfont=dict(size=9, color="#F9FAFB"),
                                hovertemplate="%{x} vs %{y}: %{z:.2f}<extra></extra>",
                                colorbar=dict(tickfont=dict(size=8, color="#9CA3AF"), thickness=10),
                            ))
                            fig_corr.update_layout(
                                **_CHART_LAYOUT_BASE, height=250,
                                margin=dict(t=10, b=30, l=60, r=10),
                                xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                                yaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), autorange="reversed"),
                            )
                            st.plotly_chart(fig_corr, use_container_width=True, key="wl_correlation")
                        else:
                            st.caption("Need 2+ valid tickers for correlation")
                    except Exception:
                        st.caption("Correlation unavailable")

    st.markdown('<div class="sb-divider"></div>', unsafe_allow_html=True)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # PORTFOLIO SIMULATOR (shown in all modes)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with st.expander("ğŸ“Š Portfolio Simulator", expanded=False):
        st.markdown('<div style="font-size:0.68rem; color:#9CA3AF; margin-bottom:0.5rem;">Enter up to 5 tickers with weights (must sum to 100%)</div>', unsafe_allow_html=True)
        _ps_tickers = []
        _ps_weights = []
        for _pi in range(5):
            _pc1, _pc2 = st.columns([2, 1])
            with _pc1:
                _pt = st.text_input(f"Ticker {_pi+1}", value="", key=f"ps_ticker_{_pi}", placeholder="e.g. AAPL", label_visibility="collapsed").strip().upper()
            with _pc2:
                _pw = st.number_input(f"Wt {_pi+1}", min_value=0.0, max_value=100.0, value=0.0, step=5.0, key=f"ps_weight_{_pi}", label_visibility="collapsed")
            if _pt and _pw > 0:
                _ps_tickers.append(_pt)
                _ps_weights.append(_pw / 100.0)

        if len(_ps_tickers) >= 2 and abs(sum(_ps_weights) - 1.0) < 0.02:
            try:
                _ps_data = yf.download(_ps_tickers, period="1y", progress=False)["Close"]
                if _ps_data is not None and not _ps_data.empty:
                    _ps_returns = _ps_data.pct_change().dropna()
                    _w = np.array(_ps_weights)

                    # Individual stats
                    _ann_ret = _ps_returns.mean() * 252
                    _ann_vol = _ps_returns.std() * np.sqrt(252)

                    # Portfolio stats
                    _port_ret = float(np.dot(_w, _ann_ret.values))
                    _cov_matrix = _ps_returns.cov() * 252
                    _port_vol = float(np.sqrt(np.dot(_w.T, np.dot(_cov_matrix.values, _w))))
                    _rf = 0.0425
                    _sharpe = (_port_ret - _rf) / _port_vol if _port_vol > 0 else 0

                    _sr_color = "#10B981" if _sharpe > 1 else "#F59E0B" if _sharpe > 0.5 else "#EF4444"
                    st.markdown(
                        f'<div style="background:rgba(37,99,235,0.06); border-radius:8px; padding:0.6rem; margin:0.3rem 0; font-size:0.72rem;">'
                        f'<div style="color:#60A5FA; font-weight:700; margin-bottom:0.3rem;">PORTFOLIO METRICS</div>'
                        f'<div style="color:#D1D5DB;">Expected Return: <b style="color:#10B981;">{_port_ret*100:.1f}%</b></div>'
                        f'<div style="color:#D1D5DB;">Volatility: <b style="color:#F59E0B;">{_port_vol*100:.1f}%</b></div>'
                        f'<div style="color:#D1D5DB;">Sharpe Ratio: <b style="color:{_sr_color};">{_sharpe:.2f}</b></div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

                    # Mini scatter: portfolio vs individual stocks
                    fig_ps = go.Figure()
                    _colors_ps = ["#10B981", "#3B82F6", "#F5A623", "#8B5CF6", "#14B8A6"]
                    for _si, _st in enumerate(_ps_tickers):
                        fig_ps.add_trace(go.Scatter(
                            x=[float(_ann_vol.iloc[_si]) * 100], y=[float(_ann_ret.iloc[_si]) * 100],
                            mode="markers+text", name=_st, text=[_st], textposition="top center",
                            marker=dict(size=8, color=_colors_ps[_si % 5]),
                            textfont=dict(size=8, color="#D1D5DB"),
                        ))
                    fig_ps.add_trace(go.Scatter(
                        x=[_port_vol * 100], y=[_port_ret * 100],
                        mode="markers+text", name="Portfolio", text=["Portfolio"], textposition="top center",
                        marker=dict(size=14, color="#2563EB", symbol="star", line=dict(width=2, color="#fff")),
                        textfont=dict(size=9, color="#F9FAFB", weight="bold" if hasattr(dict, 'weight') else None),
                    ))
                    fig_ps.update_layout(
                        paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)",
                        height=200, margin=dict(t=15, b=25, l=35, r=10), showlegend=False,
                        xaxis=dict(title="Volatility %", titlefont=dict(size=9, color="#9CA3AF"), tickfont=dict(size=8, color="#9CA3AF"), gridcolor="rgba(37,99,235,0.08)"),
                        yaxis=dict(title="Return %", titlefont=dict(size=9, color="#9CA3AF"), tickfont=dict(size=8, color="#9CA3AF"), gridcolor="rgba(37,99,235,0.08)"),
                        font=dict(family="Inter"),
                    )
                    st.plotly_chart(fig_ps, use_container_width=True, key="portfolio_sim_chart")
            except Exception as _ps_err:
                st.caption(f"Could not compute: {str(_ps_err)[:80]}")
        elif len(_ps_tickers) >= 1 and abs(sum(_ps_weights) - 1.0) >= 0.02:
            st.caption(f"Weights sum to {sum(_ps_weights)*100:.0f}% â€” adjust to 100%")

    st.markdown('<div class="sb-divider"></div>', unsafe_allow_html=True)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # MODE-SPECIFIC SIDEBAR CONTENT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # â”€â”€ Global Exchange Detection â”€â”€
    _EXCHANGE_MAP = {
        ".TO": ("Toronto Stock Exchange (TSX)", "CAD", "C$"),
        ".V": ("TSX Venture Exchange", "CAD", "C$"),
        ".L": ("London Stock Exchange", "GBP", "Â£"),
        ".T": ("Tokyo Stock Exchange", "JPY", "Â¥"),
        ".HK": ("Hong Kong Stock Exchange", "HKD", "HK$"),
        ".DE": ("Frankfurt Stock Exchange", "EUR", "â‚¬"),
        ".PA": ("Euronext Paris", "EUR", "â‚¬"),
        ".AX": ("Australian Securities Exchange", "AUD", "A$"),
        ".MI": ("Borsa Italiana", "EUR", "â‚¬"),
        ".AS": ("Euronext Amsterdam", "EUR", "â‚¬"),
        ".SW": ("SIX Swiss Exchange", "CHF", "CHF "),
        ".SI": ("Singapore Exchange", "SGD", "S$"),
    }

    def _detect_exchange(ticker_str):
        """Detect exchange from ticker suffix. Returns (exchange_name, currency_code, currency_symbol) or None."""
        if not ticker_str:
            return None
        for suffix, info in _EXCHANGE_MAP.items():
            if ticker_str.upper().endswith(suffix.upper()):
                return info
        return ("US Exchange (NYSE/NASDAQ)", "USD", "$")

    def _show_exchange_info(ticker_str):
        """Show detected exchange info in sidebar."""
        if not ticker_str:
            return
        exch = _detect_exchange(ticker_str)
        if exch:
            st.markdown(
                f'<div style="background:rgba(37,99,235,0.06); border-radius:8px; padding:0.5rem; '
                f'margin:0.3rem 0; font-size:0.72rem; color:#D1D5DB;">'
                f'ğŸ¦ <b>{exch[0]}</b> Â· {exch[1]} ({exch[2]})</div>',
                unsafe_allow_html=True,
            )

    # Exchange Guide (shown once in sidebar)
    with st.expander("ğŸŒ Exchange Guide", expanded=False):
        st.markdown(
            '<div style="font-size:0.7rem; color:#9CA3AF; line-height:1.8;">'
            '<b>Common ticker suffixes:</b><br>'
            'ğŸ‡¨ğŸ‡¦ <code>.TO</code> â†’ TSX (Toronto) Â· CAD<br>'
            'ğŸ‡¬ğŸ‡§ <code>.L</code> â†’ LSE (London) Â· GBP<br>'
            'ğŸ‡¯ğŸ‡µ <code>.T</code> â†’ JPX (Tokyo) Â· JPY<br>'
            'ğŸ‡­ğŸ‡° <code>.HK</code> â†’ HKEX Â· HKD<br>'
            'ğŸ‡©ğŸ‡ª <code>.DE</code> â†’ Frankfurt Â· EUR<br>'
            'ğŸ‡«ğŸ‡· <code>.PA</code> â†’ Paris Â· EUR<br>'
            'ğŸ‡¦ğŸ‡º <code>.AX</code> â†’ ASX (Sydney) Â· AUD<br>'
            'ğŸ‡¨ğŸ‡­ <code>.SW</code> â†’ SIX (Zurich) Â· CHF<br>'
            'ğŸ‡ºğŸ‡¸ No suffix â†’ NYSE/NASDAQ Â· USD'
            '</div>',
            unsafe_allow_html=True,
        )

    st.markdown('<div class="sb-divider"></div>', unsafe_allow_html=True)

    # Initialize all variables with defaults
    ticker_input = ""
    generate_btn = False
    acquirer_input = ""
    target_input = ""
    merger_btn = False
    merger_assumptions = MergerAssumptions()
    comps_ticker_input = ""
    comps_btn = False
    max_peers = 10
    include_saas = False
    dcf_ticker_input = ""
    dcf_btn = False
    dcf_growth_rate = 0.05
    dcf_terminal_growth = 0.025
    dcf_discount_rate = 0.10
    dcf_years = 5
    compare_tickers = []
    compare_btn = False

    if analysis_mode == "Company Profile":
        # â”€â”€ Company Profile Mode â”€â”€
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ“Š</span> COMPANY</div>',
            unsafe_allow_html=True,
        )

        ticker_input = st.text_input(
            "Stock Ticker", value="", max_chars=10,
            placeholder="Enter ticker (e.g. AAPL)",
            label_visibility="collapsed",
        ).strip().upper()

        # Show company preview card
        if ticker_input:
            _show_exchange_info(ticker_input)
            _render_company_card(ticker_input)
            # Add to watchlist button
            if not _is_in_watchlist(ticker_input):
                if st.button("â­ Add to Watchlist", key="add_wl_profile", use_container_width=True):
                    _add_to_watchlist(ticker_input)
                    st.rerun()

        # â”€â”€ Natural Language Search â”€â”€
        if ticker_input and not ticker_input.replace(".", "").replace("-", "").isalpha() is False:
            pass  # normal ticker
        if ticker_input and len(ticker_input) > 5 and " " not in ticker_input:
            pass  # could be a long ticker like BRK.B
        if ticker_input and (" " in ticker_input or (len(ticker_input) > 6 and ticker_input.isalpha())):
            # User may have typed a company name instead of ticker
            _nlq = ticker_input
            _nl_suggestions = []
            try:
                import yfinance as _yf_search
                _nl_result = _yf_search.Ticker(_nlq)
                _nl_info = _nl_result.info
                if _nl_info and _nl_info.get("symbol"):
                    _nl_suggestions.append((_nl_info["symbol"], _nl_info.get("shortName", "")))
            except Exception:
                pass
            if not _nl_suggestions:
                # Try common name mappings
                _name_map = {
                    "APPLE": "AAPL", "MICROSOFT": "MSFT", "GOOGLE": "GOOGL", "ALPHABET": "GOOGL",
                    "AMAZON": "AMZN", "META": "META", "FACEBOOK": "META", "TESLA": "TSLA",
                    "NVIDIA": "NVDA", "NETFLIX": "NFLX", "DISNEY": "DIS", "WALMART": "WMT",
                    "JPMORGAN": "JPM", "BERKSHIRE": "BRK-B", "JOHNSON": "JNJ",
                    "VISA": "V", "MASTERCARD": "MA", "PAYPAL": "PYPL", "ADOBE": "ADBE",
                    "SALESFORCE": "CRM", "ORACLE": "ORCL", "INTEL": "INTC", "AMD": "AMD",
                    "COCA COLA": "KO", "PEPSI": "PEP", "MCDONALDS": "MCD", "STARBUCKS": "SBUX",
                    "BOEING": "BA", "GOLDMAN SACHS": "GS", "MORGAN STANLEY": "MS",
                    "BANK OF AMERICA": "BAC", "WELLS FARGO": "WFC", "CHEVRON": "CVX",
                    "EXXON": "XOM", "PROCTER": "PG", "UNITEDHEALTH": "UNH",
                }
                for _nm_key, _nm_val in _name_map.items():
                    if _nm_key in _nlq.upper():
                        try:
                            _nm_tk = _yf_search.Ticker(_nm_val)
                            _nm_name = _nm_tk.info.get("shortName", _nm_key.title())
                        except Exception:
                            _nm_name = _nm_key.title()
                        _nl_suggestions.append((_nm_val, _nm_name))
                        break
            if _nl_suggestions:
                st.markdown(
                    f'<div style="background:rgba(37,99,235,0.1); border:1px solid rgba(37,99,235,0.2); '
                    f'border-radius:8px; padding:0.5rem 0.8rem; margin-bottom:0.5rem;">'
                    f'<span style="font-size:0.75rem; color:#D1D5DB;">Did you mean:</span><br>'
                    f'<span style="font-size:0.85rem; font-weight:700; color:#60A5FA;">'
                    f'{_nl_suggestions[0][0]} ({_nl_suggestions[0][1]})</span></div>',
                    unsafe_allow_html=True,
                )
                if st.button(f"Load {_nl_suggestions[0][0]}", key="nl_load_suggestion", use_container_width=True):
                    st.session_state["load_ticker"] = _nl_suggestions[0][0]
                    # Store in recent searches
                    if "nl_recent_searches" not in st.session_state:
                        st.session_state["nl_recent_searches"] = []
                    st.session_state["nl_recent_searches"] = [_nlq] + [s for s in st.session_state["nl_recent_searches"] if s != _nlq][:9]
                    st.rerun()
            else:
                st.markdown(
                    f'<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.3rem;">'
                    f'ğŸ’¡ Tip: Enter a stock ticker (e.g. AAPL) instead of a company name</div>',
                    unsafe_allow_html=True,
                )

        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        generate_btn = st.button("ğŸš€ Generate Profile", type="primary", use_container_width=True)

        # â”€â”€ ğŸ”” Smart Alerts (sidebar) â”€â”€
        if ticker_input and generate_btn is False:
            # Show alerts for the ticker even before generating full profile
            pass
        if ticker_input:
            _sa_alerts = []
            try:
                import yfinance as _yf_sa
                _sa_tk = _yf_sa.Ticker(ticker_input)
                _sa_info = _sa_tk.info or {}
                _sa_price = _sa_info.get("currentPrice") or _sa_info.get("regularMarketPrice", 0)
                _sa_52h = _sa_info.get("fiftyTwoWeekHigh", 0)
                _sa_52l = _sa_info.get("fiftyTwoWeekLow", 0)

                # Price near 52-week high/low
                if _sa_52h and _sa_price and _sa_52h > 0:
                    if _sa_price >= _sa_52h * 0.95:
                        _sa_alerts.append(("ğŸŸ¡", f"Within 5% of 52W High ({_sa_price:.2f} vs {_sa_52h:.2f})"))
                if _sa_52l and _sa_price and _sa_52l > 0:
                    if _sa_price <= _sa_52l * 1.05:
                        _sa_alerts.append(("ğŸŸ¢", f"Within 5% of 52W Low â€” potential value ({_sa_price:.2f} vs {_sa_52l:.2f})"))

                # RSI
                try:
                    _sa_hist = _sa_tk.history(period="3mo")
                    if _sa_hist is not None and len(_sa_hist) >= 14:
                        _sa_delta = _sa_hist["Close"].diff()
                        _sa_gain = _sa_delta.where(_sa_delta > 0, 0).rolling(14).mean()
                        _sa_loss = (-_sa_delta.where(_sa_delta < 0, 0)).rolling(14).mean()
                        _sa_rs = _sa_gain / _sa_loss
                        _sa_rsi = (100 - (100 / (1 + _sa_rs))).dropna()
                        if len(_sa_rsi) > 0:
                            _sa_rsi_val = float(_sa_rsi.iloc[-1])
                            if _sa_rsi_val > 70:
                                _sa_alerts.append(("ğŸ”´", f"RSI Overbought ({_sa_rsi_val:.0f})"))
                            elif _sa_rsi_val < 30:
                                _sa_alerts.append(("ğŸŸ¢", f"RSI Oversold ({_sa_rsi_val:.0f})"))
                except Exception:
                    pass

                # Golden Cross / Death Cross
                try:
                    _sa_hist_1y = _sa_tk.history(period="1y")
                    if _sa_hist_1y is not None and len(_sa_hist_1y) >= 200:
                        _sa_sma50 = _sa_hist_1y["Close"].rolling(50).mean()
                        _sa_sma200 = _sa_hist_1y["Close"].rolling(200).mean()
                        _sa_cross_df = _sa_sma50.dropna() - _sa_sma200.dropna()
                        if len(_sa_cross_df) >= 2:
                            if _sa_cross_df.iloc[-1] > 0 and _sa_cross_df.iloc[-2] <= 0:
                                _sa_alerts.append(("ğŸŸ¢", "Golden Cross â€” bullish signal"))
                            elif _sa_cross_df.iloc[-1] < 0 and _sa_cross_df.iloc[-2] >= 0:
                                _sa_alerts.append(("ğŸ”´", "Death Cross â€” bearish signal"))
                            elif _sa_cross_df.iloc[-1] > 0:
                                _sa_alerts.append(("ğŸŸ¡", "50d SMA above 200d SMA (bullish trend)"))
                            else:
                                _sa_alerts.append(("ğŸŸ¡", "50d SMA below 200d SMA (bearish trend)"))
                except Exception:
                    pass

                # Unusual Volume
                try:
                    _sa_vol = _sa_info.get("volume", 0)
                    _sa_avg_vol = _sa_info.get("averageVolume", 0)
                    if _sa_vol and _sa_avg_vol and _sa_avg_vol > 0:
                        _sa_vol_ratio = _sa_vol / _sa_avg_vol
                        if _sa_vol_ratio > 2:
                            _sa_alerts.append(("ğŸŸ¡", f"Unusual Volume ({_sa_vol_ratio:.1f}x average)"))
                except Exception:
                    pass

                # Dividend yield vs ~4.3% (proxy for 10Y treasury)
                _sa_div_yield = _sa_info.get("dividendYield", 0) or 0
                # Normalize: if > 0.2 it's already a percentage
                if _sa_div_yield > 0.2:
                    _sa_div_yield = _sa_div_yield / 100.0
                if _sa_div_yield > 0.043:
                    _sa_alerts.append(("ğŸŸ¢", f"Dividend yield ({_sa_div_yield*100:.1f}%) above 10Y Treasury"))

                # Earnings date within 14 days
                try:
                    from datetime import datetime as _dt_sa, timedelta as _td_sa
                    _sa_cal = _sa_tk.calendar
                    if _sa_cal is not None:
                        _sa_earnings = None
                        if isinstance(_sa_cal, dict):
                            _sa_earnings = _sa_cal.get("Earnings Date", [None])[0] if "Earnings Date" in _sa_cal else None
                        if _sa_earnings:
                            import pandas as _pd_sa
                            _sa_ed = _pd_sa.Timestamp(_sa_earnings)
                            _sa_days = (_sa_ed - _pd_sa.Timestamp.now()).days
                            if 0 <= _sa_days <= 14:
                                _sa_alerts.append(("ğŸŸ¡", f"Earnings in {_sa_days} days"))
                except Exception:
                    pass

                # Piotroski F-Score (simplified check)
                try:
                    from data_engine import calculate_piotroski_score as _cps_sa
                    from data_engine import CompanyData as _CD_sa
                    _sa_cd_stub = _CD_sa(ticker=ticker_input)
                    _sa_cd_stub.info = _sa_info
                    _pf_score = _cps_sa(_sa_cd_stub)
                    if isinstance(_pf_score, (int, float)) and _pf_score < 3:
                        _sa_alerts.append(("ğŸ”´", f"Piotroski F-Score: {_pf_score} (weak fundamentals)"))
                except Exception:
                    pass

                # Insider buying (from info)
                try:
                    _sa_insider_buy = _sa_info.get("netSharePurchaseActivity", _sa_info.get("heldPercentInsiders", None))
                    if _sa_insider_buy and isinstance(_sa_insider_buy, (int, float)) and _sa_insider_buy > 0:
                        _sa_alerts.append(("ğŸŸ¢", "Net insider buying detected"))
                except Exception:
                    pass

            except Exception:
                pass

            if _sa_alerts:
                st.markdown(
                    '<div class="sb-section"><span class="sb-section-icon">ğŸ””</span> SMART ALERTS</div>',
                    unsafe_allow_html=True,
                )
                _alert_html = ""
                _alert_colors = {"ğŸŸ¢": "rgba(16,185,129,0.15)", "ğŸ”´": "rgba(239,68,68,0.15)", "ğŸŸ¡": "rgba(245,158,11,0.15)"}
                _alert_text_colors = {"ğŸŸ¢": "#10B981", "ğŸ”´": "#EF4444", "ğŸŸ¡": "#F59E0B"}
                for _sa_icon, _sa_msg in _sa_alerts:
                    _bg = _alert_colors.get(_sa_icon, "rgba(255,255,255,0.05)")
                    _tc = _alert_text_colors.get(_sa_icon, "#D1D5DB")
                    _alert_html += (
                        f'<div style="background:{_bg}; border-radius:8px; padding:0.35rem 0.6rem; '
                        f'margin-bottom:0.3rem; font-size:0.7rem; color:{_tc}; font-weight:600;">'
                        f'{_sa_icon} {_sa_msg}</div>'
                    )
                st.markdown(_alert_html, unsafe_allow_html=True)

        # Search History
        search_history = _get_search_history()
        if search_history:
            st.markdown('<div class="sb-section"><span class="sb-section-icon">ğŸ•</span> RECENT</div>', unsafe_allow_html=True)
            recent_cols = st.columns(5)
            for i, hist_ticker in enumerate(search_history[:5]):
                with recent_cols[i % 5]:
                    if st.button(hist_ticker, key=f"hist_{hist_ticker}", use_container_width=True):
                        st.session_state["load_ticker"] = hist_ticker
                        st.rerun()
        
        # Quick sector picks
        st.markdown('<div class="sb-section"><span class="sb-section-icon">ğŸ”¥</span> QUICK PICKS</div>', unsafe_allow_html=True)
        sector_choice = st.selectbox("Sector", list(POPULAR_TICKERS.keys()), label_visibility="collapsed")
        selected_quick = st.selectbox("Popular Tickers", POPULAR_TICKERS[sector_choice], label_visibility="collapsed")
        if st.button("Load Ticker", key="load_quick"):
            st.session_state["load_ticker"] = selected_quick
            st.rerun()

    elif analysis_mode == "Comps Analysis":
        # â”€â”€ Comps Analysis Mode â”€â”€
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ“Š</span> TARGET COMPANY</div>',
            unsafe_allow_html=True,
        )

        comps_ticker_input = st.text_input(
            "Stock Ticker", value="", max_chars=10,
            placeholder="Enter ticker (e.g. AAPL)",
            label_visibility="collapsed",
            key="comps_ticker"
        ).strip().upper()

        if comps_ticker_input:
            _show_exchange_info(comps_ticker_input)
            _render_company_card(comps_ticker_input)

        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        
        # Comps settings
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">âš™ï¸</span> SETTINGS</div>',
            unsafe_allow_html=True,
        )
        
        max_peers = st.slider("Number of Peers", 5, 20, 10, 1)
        include_saas = st.checkbox("Include SaaS/Software peers", value=False)

        # â”€â”€ Visual Peer Group Builder â”€â”€
        if comps_ticker_input:
            with st.expander("ğŸ§  Peer Group Builder", expanded=True):
                st.markdown(
                    '<div style="font-size:0.7rem; color:#D1D5DB; margin-bottom:0.5rem;">'
                    'Click peers to add/remove. Highlighted = selected.</div>',
                    unsafe_allow_html=True,
                )
                # Try to get sector for this ticker
                _sps_sector = None
                _sps_industry = None
                _sps_info = {}
                try:
                    _sps_info = _quick_ticker_lookup(comps_ticker_input) or {}
                    _sps_sector = _sps_info.get("sector", "")
                    _sps_industry = _sps_info.get("industry", "")
                except Exception:
                    pass

                # Find matching peers
                _sps_candidates = []
                try:
                    from data_engine import CompanyData as _CD, discover_peers as _dp
                    _stub_cd = _CD(ticker=comps_ticker_input, sector=_sps_sector or "", industry=_sps_industry or "")
                    _stub_cd.market_cap = _sps_info.get("marketCap", 0) if _sps_info else 0
                    _sps_candidates = _dp(_stub_cd, max_peers=12)
                except Exception:
                    pass

                # Fallback to SECTOR_PEER_MAP
                if not _sps_candidates:
                    if _sps_industry and _sps_industry in SECTOR_PEER_MAP:
                        _sps_candidates = SECTOR_PEER_MAP[_sps_industry]
                    elif _sps_sector and _sps_sector in SECTOR_PEER_MAP:
                        _sps_candidates = SECTOR_PEER_MAP[_sps_sector]
                    else:
                        for _sk, _sv in SECTOR_PEER_MAP.items():
                            if _sps_sector and _sps_sector.lower() in _sk.lower():
                                _sps_candidates = _sv
                                break
                            if _sps_industry and _sps_industry.lower() in _sk.lower():
                                _sps_candidates = _sv
                                break

                _sps_suggestions = [t for t in _sps_candidates if t.upper() != comps_ticker_input.upper()][:12]

                if _sps_suggestions:
                    if _sps_sector:
                        st.markdown(f'<div style="font-size:0.65rem; color:#60A5FA; margin-bottom:0.4rem;">Sector: {_sps_sector} Â· Industry: {_sps_industry or "N/A"}</div>', unsafe_allow_html=True)

                    # Initialize session state
                    _sps_key = f"smart_peers_{comps_ticker_input}"
                    if _sps_key not in st.session_state:
                        st.session_state[_sps_key] = list(_sps_suggestions)

                    # Select All / Clear All buttons
                    _sa_col, _ca_col = st.columns(2)
                    with _sa_col:
                        if st.button("âœ… Select All", key=f"sps_selall_{comps_ticker_input}", use_container_width=True):
                            st.session_state[_sps_key] = list(_sps_suggestions)
                            st.rerun()
                    with _ca_col:
                        if st.button("ğŸ—‘ï¸ Clear All", key=f"sps_clrall_{comps_ticker_input}", use_container_width=True):
                            st.session_state[_sps_key] = []
                            st.rerun()

                    # Visual chip/pill display with toggle buttons
                    _peer_infos = {}
                    for _pt in _sps_suggestions:
                        try:
                            _pi = _quick_ticker_lookup(_pt)
                            if _pi:
                                _peer_infos[_pt] = _pi
                        except Exception:
                            pass

                    # Render peer chips as rows of toggle buttons
                    _chip_cols_per_row = 3
                    for _row_start in range(0, len(_sps_suggestions), _chip_cols_per_row):
                        _row_peers = _sps_suggestions[_row_start:_row_start + _chip_cols_per_row]
                        _chip_cols = st.columns(len(_row_peers))
                        for _ci, _peer_t in enumerate(_row_peers):
                            with _chip_cols[_ci]:
                                _is_sel = _peer_t in st.session_state[_sps_key]
                                _pi = _peer_infos.get(_peer_t, {})
                                _p_mcap = _pi.get("marketCap", 0)
                                _p_mcap_str = format_number(_p_mcap) if _p_mcap else "?"
                                _p_name = _pi.get("name", _peer_t)[:15]
                                # Chip button
                                _chip_label = f"{'âœ“ ' if _is_sel else ''}{_peer_t}"
                                if st.button(
                                    _chip_label,
                                    key=f"sps_chip_{comps_ticker_input}_{_peer_t}",
                                    use_container_width=True,
                                    type="primary" if _is_sel else "secondary",
                                    help=f"{_p_name} Â· MCap: {_p_mcap_str} Â· {_sps_sector or 'N/A'}",
                                ):
                                    if _is_sel:
                                        st.session_state[_sps_key].remove(_peer_t)
                                    else:
                                        st.session_state[_sps_key].append(_peer_t)
                                    st.rerun()

                    _sps_selected = st.session_state[_sps_key]

                    # Manual override
                    _sps_manual = st.text_input(
                        "Add custom peers (comma-separated)",
                        placeholder="TICKER1, TICKER2",
                        key=f"sps_manual_{comps_ticker_input}",
                        label_visibility="collapsed",
                    )
                    if _sps_manual:
                        _sps_custom = [t.strip().upper() for t in _sps_manual.split(",") if t.strip()]
                        for _ct in _sps_custom:
                            if _ct not in _sps_selected:
                                _sps_selected.append(_ct)
                        st.session_state[_sps_key] = _sps_selected

                    st.markdown(
                        f'<div style="font-size:0.7rem; color:{"#10B981" if len(_sps_selected) >= 3 else "#F5A623"}; '
                        f'margin-top:0.3rem; font-weight:600;">'
                        f'ğŸ“Š {len(_sps_selected)} peers selected</div>',
                        unsafe_allow_html=True,
                    )
                else:
                    st.markdown(
                        '<div style="font-size:0.7rem; color:#9CA3AF;">'
                        'No auto-suggestions available. The comps engine will find peers automatically.'
                        '</div>',
                        unsafe_allow_html=True,
                    )
        
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        comps_btn = st.button("ğŸ” Run Comps Analysis", type="primary", use_container_width=True)

    elif analysis_mode == "DCF Valuation":
        # â”€â”€ DCF Valuation Mode â”€â”€
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ’°</span> TARGET COMPANY</div>',
            unsafe_allow_html=True,
        )
        
        dcf_ticker_input = st.text_input(
            "Stock Ticker", value="", max_chars=10,
            placeholder="Enter ticker (e.g. AAPL)",
            label_visibility="collapsed",
            key="dcf_ticker"
        ).strip().upper()
        
        if dcf_ticker_input:
            _show_exchange_info(dcf_ticker_input)
            _render_company_card(dcf_ticker_input)
        
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        
        # DCF Assumptions
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ“ˆ</span> GROWTH ASSUMPTIONS</div>',
            unsafe_allow_html=True,
        )
        
        dcf_growth_rate = st.slider("FCF Growth Rate (%)", 0, 30, 8, 1, 
                                     help="Expected annual free cash flow growth rate â€” how fast the company's cash generation will grow") / 100
        dcf_terminal_growth = st.slider("Terminal Growth (%)", 0.0, 4.0, 2.5, 0.5,
                                        help="Long-term perpetuity growth rate after projection period â€” typically matches GDP growth (~2-3%). Must be below WACC.") / 100
        dcf_years = st.slider("Projection Years", 3, 10, 5, 1,
                              help="Number of years to explicitly project FCF before applying a terminal value. Longer = more speculative.")
        
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¯</span> DISCOUNT RATE</div>',
            unsafe_allow_html=True,
        )
        
        dcf_auto_wacc = st.checkbox("ğŸ¤– Auto-Calculate WACC", value=False,
                                     help="Weighted Average Cost of Capital (WACC) â€” the discount rate reflecting the blended cost of equity and debt financing. Auto-calc uses CAPM for equity cost + actual debt cost from financials.")
        
        if dcf_auto_wacc and dcf_ticker_input:
            try:
                _wacc_cd = fetch_company_data(dcf_ticker_input)
                _w_beta = _wacc_cd.beta if _wacc_cd.beta else 1.0
                _w_rf = 0.0425  # 10Y Treasury
                _w_erp = 0.055  # Equity risk premium
                _w_ke = _w_rf + _w_beta * _w_erp  # CAPM
                
                # Cost of Debt
                _w_ie = float(_wacc_cd.interest_expense.iloc[0]) if _wacc_cd.interest_expense is not None and len(_wacc_cd.interest_expense) > 0 else 0
                _w_td = float(_wacc_cd.total_debt.iloc[0]) if _wacc_cd.total_debt is not None and len(_wacc_cd.total_debt) > 0 else 0
                _w_ie = abs(_w_ie)  # interest expense may be negative
                _w_kd = (_w_ie / _w_td) if _w_td > 0 else 0.05
                
                # Tax Rate
                _w_tp = float(_wacc_cd.tax_provision.iloc[0]) if _wacc_cd.tax_provision is not None and len(_wacc_cd.tax_provision) > 0 else 0
                _w_oi = float(_wacc_cd.operating_income.iloc[0]) if _wacc_cd.operating_income is not None and len(_wacc_cd.operating_income) > 0 else 0
                _w_pretax = _w_oi - _w_ie
                _w_tax_rate = (abs(_w_tp) / abs(_w_pretax)) if abs(_w_pretax) > 0 else 0.21
                _w_tax_rate = max(0, min(_w_tax_rate, 0.50))
                
                # Capital Structure
                _w_mcap = _wacc_cd.market_cap or 0
                _w_ev = _w_mcap + _w_td
                _w_we = (_w_mcap / _w_ev) if _w_ev > 0 else 0.7
                _w_wd = (_w_td / _w_ev) if _w_ev > 0 else 0.3
                
                _w_wacc = _w_we * _w_ke + _w_wd * _w_kd * (1 - _w_tax_rate)
                _w_wacc_pct = round(_w_wacc * 100, 1)
                
                st.markdown(
                    f'<div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.25); '
                    f'border-radius:10px; padding:0.6rem; margin:0.3rem 0; font-size:0.7rem; color:#D1D5DB; line-height:1.7;">'
                    f'<b style="color:#10B981;">Calculated WACC: {_w_wacc_pct:.1f}%</b><br>'
                    f'Ke={_w_ke*100:.1f}% (Î²={_w_beta:.2f}) Â· Kd={_w_kd*100:.1f}% Â· Tax={_w_tax_rate*100:.0f}%<br>'
                    f'E/V={_w_we*100:.0f}% Â· D/V={_w_wd*100:.0f}%'
                    f'</div>',
                    unsafe_allow_html=True,
                )
                # Store for WACC breakdown section
                st.session_state["_auto_wacc_data"] = {
                    "rf": _w_rf, "beta": _w_beta, "erp": _w_erp, "ke": _w_ke,
                    "kd": _w_kd, "tax_rate": _w_tax_rate, "we": _w_we, "wd": _w_wd,
                    "wacc": _w_wacc, "mcap": _w_mcap, "debt": _w_td,
                }
                
                # Suggested FCF Growth (historical CAGR)
                if _wacc_cd.free_cashflow_series is not None and len(_wacc_cd.free_cashflow_series) >= 2:
                    _fcf_vals = _wacc_cd.free_cashflow_series.dropna()
                    if len(_fcf_vals) >= 2:
                        _fcf_latest = float(_fcf_vals.iloc[0])
                        _fcf_oldest = float(_fcf_vals.iloc[-1])
                        _n_yrs = len(_fcf_vals) - 1
                        if _fcf_oldest > 0 and _fcf_latest > 0 and _n_yrs > 0:
                            _fcf_cagr = (_fcf_latest / _fcf_oldest) ** (1 / _n_yrs) - 1
                            st.markdown(
                                f'<div style="font-size:0.65rem; color:#9CA3AF; margin:0.2rem 0;">'
                                f'ğŸ“ˆ Suggested FCF Growth: <b style="color:#60A5FA;">{_fcf_cagr*100:.1f}%</b> '
                                f'({_n_yrs}Y CAGR)</div>',
                                unsafe_allow_html=True,
                            )
                
                _auto_wacc_int = max(5, min(20, int(round(_w_wacc_pct))))
            except Exception:
                _auto_wacc_int = 10
        else:
            _auto_wacc_int = 10
        
        dcf_discount_rate = st.slider("WACC / Discount Rate (%)", 5, 20, _auto_wacc_int, 1,
                                      help="Weighted average cost of capital â€” higher = more conservative") / 100
        
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        dcf_btn = st.button("ğŸ’¹ Calculate DCF", type="primary", use_container_width=True)
        
        st.markdown(
            '<div style="font-size:0.65rem; color:#9CA3AF; margin-top:0.5rem; line-height:1.6;">'
            'ğŸ’¡ <b>Tip:</b> Use historical growth rates and peer WACC as starting points. '
            'Higher risk = higher discount rate.'
            '</div>',
            unsafe_allow_html=True,
        )

    elif analysis_mode == "Quick Compare":
        # â”€â”€ Quick Compare Mode â”€â”€
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">âš–ï¸</span> COMPANIES TO COMPARE</div>',
            unsafe_allow_html=True,
        )
        
        compare_input = st.text_area(
            "Enter tickers (comma-separated)",
            placeholder="AAPL, MSFT, GOOGL, META",
            height=80,
            label_visibility="collapsed",
            key="compare_input"
        )
        
        compare_tickers = [t.strip().upper() for t in compare_input.split(",") if t.strip()]
        
        if compare_tickers:
            st.markdown(
                f'<div style="font-size:0.75rem; color:#60A5FA; margin:0.5rem 0;">'
                f'ğŸ“Š Comparing {len(compare_tickers)} companies: {", ".join(compare_tickers[:5])}'
                f'{"..." if len(compare_tickers) > 5 else ""}'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        
        # Preset comparisons
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ”¥</span> PRESET COMPARISONS</div>',
            unsafe_allow_html=True,
        )
        
        preset_options = {
            "FAANG": "META, AAPL, AMZN, NFLX, GOOGL",
            "Big Tech": "AAPL, MSFT, GOOGL, AMZN, META, NVDA",
            "Canadian Banks": "RY.TO, TD.TO, BNS.TO, BMO.TO, CM.TO",
            "Software/SaaS": "CRM, ADBE, NOW, WDAY, TEAM",
            "Semiconductors": "NVDA, AMD, INTC, QCOM, AVGO",
            "Healthcare Giants": "JNJ, UNH, PFE, ABBV, MRK",
        }
        
        preset_choice = st.selectbox("Load Preset", ["Custom"] + list(preset_options.keys()), label_visibility="collapsed")
        if preset_choice != "Custom":
            if st.button("Load Preset", key="load_preset"):
                st.session_state["compare_input"] = preset_options[preset_choice]
                st.rerun()
        
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        compare_btn = st.button("âš–ï¸ Compare Companies", type="primary", use_container_width=True)

    elif analysis_mode == "Merger Analysis":
        # â”€â”€ Merger Analysis Mode â”€â”€
        # Acquirer
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¢</span> ACQUIRER</div>',
            unsafe_allow_html=True,
        )
        acquirer_input = st.text_input(
            "Acquirer", value="", max_chars=10,
            placeholder="Enter ticker (e.g. MSFT)",
            label_visibility="collapsed",
        ).strip().upper()
        if acquirer_input:
            _render_company_card(acquirer_input, "Acquirer")

        # Target
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¯</span> TARGET</div>',
            unsafe_allow_html=True,
        )
        target_input = st.text_input(
            "Target", value="", max_chars=10,
            placeholder="Enter ticker (e.g. ATVI)",
            label_visibility="collapsed",
        ).strip().upper()
        if target_input:
            _render_company_card(target_input, "Target")

        # â”€â”€ Section: Deal Structure â”€â”€
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ’°</span> DEAL STRUCTURE</div>',
            unsafe_allow_html=True,
        )
        offer_premium = st.slider("Offer Premium (%)", 0, 100, 30, 5,
                                  help="Premium over current market price. Typical M&A premiums: 20-40%")
        pct_cash = st.slider("Cash Consideration (%)", 0, 100, 50, 5,
                             help="% of deal funded by cash (remainder is stock)")
        pct_stock = 100 - pct_cash
        st.markdown(
            f'<div class="sb-split-bar">'
            f'<div class="sb-split-cash" style="width:{pct_cash}%"></div>'
            f'<div class="sb-split-stock" style="width:{pct_stock}%"></div>'
            f'</div>'
            f'<div class="sb-split-labels">'
            f'<span class="cash-label">Cash {pct_cash}%</span>'
            f'<span class="stock-label">Stock {pct_stock}%</span>'
            f'</div>',
            unsafe_allow_html=True,
        )

        # â”€â”€ Section: Synergies â”€â”€
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">âš¡</span> SYNERGIES</div>',
            unsafe_allow_html=True,
        )
        cost_syn = st.slider("Cost Synergies (% of Target SG&A)", 0, 30, 10, 1,
                             help="Expected cost savings from eliminating redundancies. 10-15% is typical")
        rev_syn = st.slider("Revenue Synergies (% of Target Rev)", 0, 10, 2, 1,
                            help="Expected revenue uplift from cross-selling, market access. Usually conservative (1-3%)")

        # â”€â”€ Section: Financing & Fees â”€â”€
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¦</span> FINANCING &amp; FEES</div>',
            unsafe_allow_html=True,
        )
        txn_fees = st.slider("Transaction Fees (%)", 0.5, 5.0, 2.0, 0.5,
                             help="Advisory, legal, and other transaction costs. Typical: 1-3%")
        adv_cost_of_debt = st.slider("Cost of Debt (%)", 2.0, 10.0, 5.0, 0.5,
                                     help="Interest rate on new debt to fund the acquisition")
        adv_tax_rate = st.slider("Tax Rate (%)", 10, 40, 25, 1,
                                 help="Corporate tax rate for calculating after-tax synergies and interest")

        merger_assumptions = MergerAssumptions(
            offer_premium_pct=offer_premium,
            pct_cash=pct_cash,
            pct_stock=pct_stock,
            cost_synergies_pct=cost_syn,
            revenue_synergies_pct=rev_syn,
            transaction_fees_pct=txn_fees,
            tax_rate=adv_tax_rate,
            cost_of_debt=adv_cost_of_debt,
        )

        st.markdown('<div style="height:0.8rem;"></div>', unsafe_allow_html=True)
        merger_btn = st.button("ğŸš€ Analyze Deal", type="primary", use_container_width=True)

    # â”€â”€ Due Diligence Mode â”€â”€
    elif analysis_mode == "Due Diligence":
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¯</span> TARGET COMPANY</div>',
            unsafe_allow_html=True,
        )
        dd_ticker = st.text_input(
            "Ticker", value="", max_chars=10,
            placeholder="e.g., AAPL",
            label_visibility="collapsed",
        ).strip().upper()
        if dd_ticker:
            _render_company_card(dd_ticker, "Target")
        
        dd_btn = st.button("ğŸ“‹ Start DD Tracker", type="primary", use_container_width=True)
    
    # â”€â”€ Synergy Model Mode â”€â”€
    elif analysis_mode == "Synergy Model":
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¢</span> ACQUIRER</div>',
            unsafe_allow_html=True,
        )
        syn_acquirer = st.text_input(
            "Acquirer", value="", max_chars=10,
            placeholder="e.g., MSFT",
            label_visibility="collapsed",
        ).strip().upper()
        
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¯</span> TARGET</div>',
            unsafe_allow_html=True,
        )
        syn_target = st.text_input(
            "Target", value="", max_chars=10,
            placeholder="e.g., ATVI",
            label_visibility="collapsed",
        ).strip().upper()
        
        syn_btn = st.button("ğŸ”— Model Synergies", type="primary", use_container_width=True)
    
    # â”€â”€ Integration Planning Mode â”€â”€
    elif analysis_mode == "Integration Plan":
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¯</span> ACQUISITION</div>',
            unsafe_allow_html=True,
        )
        int_acquirer = st.text_input(
            "Acquirer", value="", max_chars=10,
            placeholder="e.g., MSFT",
            label_visibility="collapsed",
        ).strip().upper()
        int_target = st.text_input(
            "Target", value="", max_chars=10,
            placeholder="e.g., ATVI",
            label_visibility="collapsed",
        ).strip().upper()
        
        int_btn = st.button("ğŸ“… Generate 100-Day Plan", type="primary", use_container_width=True)
    
    # â”€â”€ Deal Structuring Mode â”€â”€
    elif analysis_mode == "Deal Structure":
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ’¼</span> DEAL PARAMETERS</div>',
            unsafe_allow_html=True,
        )
        ds_acquirer = st.text_input(
            "Acquirer", value="", max_chars=10,
            placeholder="e.g., GOOGL",
            label_visibility="collapsed",
        ).strip().upper()
        ds_target = st.text_input(
            "Target", value="", max_chars=10,
            placeholder="e.g., WDAY",
            label_visibility="collapsed",
        ).strip().upper()
        
        ds_equity_val = st.number_input("Target Equity Value ($M)", min_value=0, value=10000, step=1000)
        
        ds_btn = st.button("ğŸ’¼ Optimize Structure", type="primary", use_container_width=True)
    
    # â”€â”€ Fairness Opinion Mode â”€â”€
    elif analysis_mode == "Fairness Opinion":
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ“Š</span> TRANSACTION</div>',
            unsafe_allow_html=True,
        )
        fo_ticker = st.text_input(
            "Target Ticker", value="", max_chars=10,
            placeholder="e.g., TWTR",
            label_visibility="collapsed",
        ).strip().upper()
        fo_offer_price = st.number_input("Offer Price ($)", min_value=0.0, value=50.0, step=1.0)
        
        fo_btn = st.button("ğŸ“Š Generate Opinion", type="primary", use_container_width=True)

    # VMS Screener variables
    vms_screen_btn = False
    vms_rev_min = 1
    vms_rev_max = 500
    vms_ebitda_min = 0
    vms_growth_min = 0
    vms_rule40_min = -50
    vms_industries = []
    vms_geographies = []
    vms_target_profile = "Custom"

    # â”€â”€ Options P/L variables â”€â”€
    options_pl_ticker = ""
    options_pl_btn = False
    if analysis_mode == "Options P/L":
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ“Š</span> OPTIONS P/L</div>',
            unsafe_allow_html=True,
        )
        options_pl_ticker = st.text_input(
            "Ticker", value="", max_chars=10,
            placeholder="Enter ticker (e.g. AAPL)",
            key="options_pl_ticker",
            label_visibility="collapsed",
        ).strip().upper()
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        options_pl_btn = st.button("ğŸ“Š Analyze Options", type="primary", use_container_width=True)

    # â”€â”€ Sector Rotation variables â”€â”€
    sector_rotation_btn = False
    if analysis_mode == "Sector Rotation":
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ”„</span> SECTOR ROTATION</div>',
            unsafe_allow_html=True,
        )
        st.markdown(
            '<div style="font-size:0.72rem; color:#D1D5DB; margin-bottom:0.5rem;">'
            'Analyze sector momentum and rotation patterns across S&P 500 sectors.'
            '</div>',
            unsafe_allow_html=True,
        )
        sector_rotation_btn = st.button("ğŸ”„ Run Sector Analysis", type="primary", use_container_width=True)

    if analysis_mode == "VMS Screener":
        # â”€â”€ VMS Screener Mode â”€â”€

        # Target Profiles â€” pre-built screens
        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ¯</span> TARGET PROFILE</div>',
            unsafe_allow_html=True,
        )
        vms_target_profile = st.selectbox(
            "Target Profile",
            ["Custom", "Classic CSU Target", "Growth VMS", "Turnaround Opportunity", "Cash Cow"],
            key="vms_target_profile_sel",
            label_visibility="collapsed",
        )

        # Set defaults based on profile
        _vms_defaults = {
            "Custom": {"rev_min": 1, "rev_max": 500, "ebitda_min": 0, "growth_min": -20, "rule40_min": -50},
            "Classic CSU Target": {"rev_min": 5, "rev_max": 50, "ebitda_min": 15, "growth_min": -20, "rule40_min": -50},
            "Growth VMS": {"rev_min": 1, "rev_max": 500, "ebitda_min": 0, "growth_min": 20, "rule40_min": 40},
            "Turnaround Opportunity": {"rev_min": 1, "rev_max": 500, "ebitda_min": 10, "growth_min": -20, "rule40_min": -50},
            "Cash Cow": {"rev_min": 1, "rev_max": 500, "ebitda_min": 25, "growth_min": -20, "rule40_min": -50},
        }
        _vd = _vms_defaults.get(vms_target_profile, _vms_defaults["Custom"])

        if vms_target_profile != "Custom":
            st.markdown(
                f'<div style="background:rgba(37,99,235,0.08); border-radius:8px; padding:0.6rem; '
                f'font-size:0.72rem; color:#60A5FA; margin-bottom:0.5rem;">'
                f'ğŸ¯ <b>{vms_target_profile}</b> preset applied. Adjust sliders to customize.</div>',
                unsafe_allow_html=True,
            )

        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ”</span> SCREENING CRITERIA</div>',
            unsafe_allow_html=True,
        )
        st.markdown('<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.5rem;">Revenue Range ($M)</div>', unsafe_allow_html=True)
        vms_rev_min = st.slider("Min Revenue ($M)", 1, 500, _vd["rev_min"], 1, key="vms_rev_min_sl")
        vms_rev_max = st.slider("Max Revenue ($M)", 1, 500, min(500, max(_vd["rev_max"], _vd["rev_min"] + 1)), 1, key="vms_rev_max_sl")
        if vms_rev_min > vms_rev_max:
            vms_rev_min, vms_rev_max = vms_rev_max, vms_rev_min

        st.markdown('<div style="font-size:0.7rem; color:#9CA3AF; margin-top:0.5rem;">Profitability & Growth</div>', unsafe_allow_html=True)
        vms_ebitda_min = st.slider("Min EBITDA Margin (%)", 0, 50, _vd["ebitda_min"], 1, key="vms_ebitda_sl")
        vms_growth_min = st.slider("Min Revenue Growth (%)", -20, 50, max(-20, _vd["growth_min"]), 1, key="vms_growth_sl")
        vms_rule40_min = st.slider("Min Rule of 40", -50, 80, _vd["rule40_min"], 1, key="vms_rule40_sl",
                                    help="Rule of 40 = Revenue Growth % + EBITDA Margin %")

        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸ­</span> INDUSTRY FILTER</div>',
            unsafe_allow_html=True,
        )
        _vms_verticals = [
            "Healthcare IT", "GovTech", "Legal Tech", "Education Tech",
            "Real Estate Tech", "Construction Tech", "Utilities",
            "Transportation", "Agriculture Tech", "Financial Services Tech",
        ]
        vms_industries = st.multiselect("VMS Verticals", _vms_verticals, default=[], key="vms_ind_ms")

        st.markdown(
            '<div class="sb-section"><span class="sb-section-icon">ğŸŒ</span> GEOGRAPHY</div>',
            unsafe_allow_html=True,
        )
        vms_geographies = st.multiselect("Geography", ["North America", "Europe", "Asia-Pacific", "Other"], default=[], key="vms_geo_ms")

        st.markdown('<div style="height:0.8rem;"></div>', unsafe_allow_html=True)
        vms_screen_btn = st.button("ğŸš€ Run Screen", type="primary", use_container_width=True)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“Š FULL DATA EXPORT (available in all modes)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    st.markdown('<div class="sb-divider"></div>', unsafe_allow_html=True)
    with st.expander("ğŸ“Š Full Data Export", expanded=False):
        st.markdown(
            '<div style="font-size:0.72rem; color:#D1D5DB; margin-bottom:0.5rem;">'
            'Export financial data for the last analyzed company as a multi-sheet Excel workbook.'
            '</div>',
            unsafe_allow_html=True,
        )
        if "last_cd" in st.session_state and st.session_state["last_cd"] is not None:
            _exp_cd = st.session_state["last_cd"]
            try:
                _exp_excel = _export_to_excel(_exp_cd)
                st.download_button(
                    label=f"ğŸ“¥ {_exp_cd.ticker} Full Export (.xlsx)",
                    data=_exp_excel,
                    file_name=f"{_exp_cd.ticker}_Full_Financial_Data.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    use_container_width=True,
                    key="sidebar_full_export",
                )
                st.markdown(
                    '<div style="font-size:0.6rem; color:#9CA3AF; margin-top:0.3rem;">'
                    '6 sheets: Summary Â· Income Statement Â· Balance Sheet Â· Cash Flow Â· Key Ratios Â· Valuation Multiples'
                    '</div>',
                    unsafe_allow_html=True,
                )
            except Exception as _exp_e:
                st.warning(f"âš ï¸ Export failed â€” please try analyzing the company again before exporting.")
        else:
            st.info("Analyze a company first to enable export.", icon="â„¹ï¸")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âŒ¨ï¸ KEYBOARD SHORTCUTS PANEL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with st.expander("âŒ¨ï¸ Shortcuts & Reference", expanded=False):
        _shortcuts_data = [
            ("âŒ˜/Ctrl + K", "Quick search (Streamlit native)"),
            ("âŒ˜/Ctrl + B", "Toggle sidebar"),
            ("âŒ˜/Ctrl + E", "Export data"),
            ("âŒ˜/Ctrl + D", "Download report"),
            ("âŒ˜/Ctrl + W", "Add to watchlist"),
            ("R", "Rerun app"),
            ("?", "Show this panel"),
        ]
        for _sk, _sd in _shortcuts_data:
            st.markdown(
                f'<div style="display:flex; justify-content:space-between; padding:0.25rem 0; '
                f'border-bottom:1px solid rgba(255,255,255,0.04);">'
                f'<kbd style="background:rgba(0,0,0,0.3); padding:0.15rem 0.4rem; border-radius:4px; '
                f'font-family:monospace; font-size:0.7rem; color:#F9FAFB;">{_sk}</kbd>'
                f'<span style="color:#D1D5DB; font-size:0.72rem;">{_sd}</span></div>',
                unsafe_allow_html=True,
            )
        st.markdown(
            '<div style="font-size:0.6rem; color:#6B6B80; margin-top:0.5rem; line-height:1.5;">'
            'ğŸ’¡ <b>Quick Actions:</b><br>'
            'â€¢ Use sidebar radio buttons to switch modes<br>'
            'â€¢ Click any watchlist ticker to load it<br>'
            'â€¢ Use preset comparisons for quick benchmarks<br>'
            'â€¢ All exports support .xlsx, .csv, and .json formats'
            '</div>',
            unsafe_allow_html=True,
        )

    # Sidebar Footer with version badge
    st.markdown('<div class="sb-divider" style="margin-top:1.5rem;"></div>', unsafe_allow_html=True)
    st.markdown(
        '<div style="text-align:center; padding: 0.5rem 0;">'
        '<div style="font-size:0.55rem; font-weight:800; background:linear-gradient(135deg, #2563EB, #10B981); '
        '-webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:2px; margin-bottom:0.3rem;">'
        'ORBITAL v6.5</div>'
        '<div style="font-size:0.55rem; color:#4B5563; letter-spacing:0.5px; line-height:1.8;">'
        'DATA: YAHOO FINANCE â€¢ CHARTS: PLOTLY<br>'
        'AI: OPENAI (OPT.) â€¢ LOGOS: CLEARBIT'
        '</div>'
        '<div style="margin-top:0.5rem; padding:0.3rem 0.5rem; background:rgba(37,99,235,0.08); '
        'border:1px solid rgba(37,99,235,0.15); border-radius:6px; display:inline-block;">'
        '<span style="font-size:0.5rem; color:#9CA3AF; letter-spacing:0.5px;">'
        'ProfileBuilder v6.5 â€¢ 16,689 lines â€¢ 150+ data points</span>'
        '</div>'
        '<div style="margin-top:0.4rem;">'
        '<a href="https://github.com/rajkcho/profilebuilder" target="_blank" '
        'style="font-size:0.55rem; color:#2563EB; text-decoration:none; font-weight:600;">GitHub â†—</a>'
        '</div>'
        '</div>',
        unsafe_allow_html=True,
    )


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NEW TAB-BASED NAVIGATION (v6.6)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Show Orbital logo at the top
st.markdown(
    '<div style="text-align:center; padding: 2rem 0 1.5rem 0;">'
    '<div class="orbital-logo" style="margin:0 auto;">'
    '<span class="orbital-text">ORBITAL</span>'
    '<div class="orbital-ring orbital-ring-1"></div>'
    '<div class="orbital-ring orbital-ring-2"></div>'
    '<div class="orbital-ring orbital-ring-3"></div>'
    '<div class="orbital-particle orbital-particle-1"></div>'
    '<div class="orbital-particle orbital-particle-2"></div>'
    '<div class="orbital-particle orbital-particle-3"></div>'
    '</div>'
    '<div style="font-size:0.8rem; color:#9CA3AF; margin-top:1rem; letter-spacing:2px; text-transform:uppercase;">M&A Intelligence Platform</div>'
    '</div>',
    unsafe_allow_html=True,
)

# Create tabs for different analysis modes
tab_labels = [
    "ğŸ“Š Profile",
    "ğŸ“ˆ Comps",
    "ğŸ’¹ DCF",
    "âš–ï¸ Compare",
    "ğŸ¤ M&A",
    "ğŸ“‹ DD",
    "ğŸ”— Synergy",
    "ğŸ“… Integration",
    "ğŸ’¼ Deal Structure",
    "ğŸ“Š Fairness",
    "ğŸ” VMS",
    "ğŸ“Š Options",
    "ğŸ”„ Sectors"
]

tabs = st.tabs(tab_labels)

# Initialize all variables with defaults to prevent NameErrors
ticker_input = ""
generate_btn = False
comps_ticker_input = ""
comps_btn = False
max_peers = 10
include_saas = False
dcf_ticker_input = ""
dcf_btn = False
dcf_growth_rate = 0.08
dcf_terminal_growth = 0.025
dcf_years = 5
dcf_auto_wacc = False
dcf_discount_rate = 0.10
compare_input = ""
compare_tickers = []
compare_btn = False
acquirer_input = ""
target_input = ""
offer_premium = 30
pct_cash = 50
pct_stock = 50
merger_btn = False
cost_syn = 10
rev_syn = 2
txn_fees = 2.0
adv_cost_of_debt = 5.0
adv_tax_rate = 25
dd_ticker = ""
dd_btn = False
syn_acquirer = ""
syn_target = ""
syn_btn = False
int_acquirer = ""
int_target = ""
int_btn = False
ds_acquirer = ""
ds_target = ""
ds_equity_val = 10000
ds_btn = False
fo_ticker = ""
fo_offer_price = 50.0
fo_btn = False
vms_target_profile = "Custom"
vms_rev_min = 1
vms_rev_max = 500
vms_ebitda_min = 0
vms_growth_min = 0
vms_rule40_min = -50
vms_industries = []
vms_geographies = []
vms_screen_btn = False
options_pl_ticker = ""
options_pl_btn = False
sector_rotation_btn = False
analysis_mode = "Company Profile"  # Default

# â”€â”€â”€ TAB 0: Company Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[0]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([3, 1])
    with col1:
        ticker_input = ticker_autocomplete("Search ticker or company", key="profile_ticker_auto")
    with col2:
        generate_btn = st.button("ğŸš€ Generate Profile", type="primary", use_container_width=True)
    
    # Allow manual ticker entry as fallback
    if not ticker_input:
        manual_ticker = st.text_input("Or enter ticker manually", placeholder="e.g., AAPL", label_visibility="collapsed", key="profile_ticker_manual")
        ticker_input = manual_ticker.strip().upper() if manual_ticker else ""
    
    st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
    
    if generate_btn or ticker_input:
        analysis_mode = "Company Profile"

# â”€â”€â”€ TAB 1: Comps Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[1]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([2, 1, 1])
    with col1:
        comps_ticker_input = ticker_autocomplete("Target company", key="comps_ticker_auto")
    with col2:
        max_peers = st.number_input("# Peers", 5, 20, 10, 1, label_visibility="collapsed")
    with col3:
        comps_btn = st.button("ğŸ“ˆ Analyze", type="primary", use_container_width=True)
    
    if not comps_ticker_input:
        manual_comps = st.text_input("Or enter ticker manually", placeholder="e.g., AAPL", label_visibility="collapsed", key="comps_ticker_manual")
        comps_ticker_input = manual_comps.strip().upper() if manual_comps else ""
    
    include_saas = st.checkbox("Include SaaS/Software peers", value=False)
    
    st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
    
    if comps_btn or comps_ticker_input:
        analysis_mode = "Comps Analysis"

# â”€â”€â”€ TAB 2: DCF Valuation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[2]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([3, 1])
    with col1:
        dcf_ticker_input = ticker_autocomplete("Company to value", key="dcf_ticker_auto")
    with col2:
        dcf_btn = st.button("ğŸ’¹ Calculate DCF", type="primary", use_container_width=True)
    
    if not dcf_ticker_input:
        manual_dcf = st.text_input("Or enter ticker manually", placeholder="e.g., AAPL", label_visibility="collapsed", key="dcf_ticker_manual")
        dcf_ticker_input = manual_dcf.strip().upper() if manual_dcf else ""
    
    st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
    
    # DCF assumptions in columns
    col1, col2, col3 = st.columns(3)
    with col1:
        dcf_growth_rate = st.slider("FCF Growth (%)", 0, 30, 8, 1) / 100
    with col2:
        dcf_terminal_growth = st.slider("Terminal Growth (%)", 0.0, 4.0, 2.5, 0.5) / 100
    with col3:
        dcf_years = st.slider("Projection Years", 3, 10, 5, 1)
    
    col1, col2 = st.columns(2)
    with col1:
        dcf_auto_wacc = st.checkbox("ğŸ¤– Auto-Calculate WACC", value=False)
    with col2:
        if not dcf_auto_wacc:
            dcf_discount_rate = st.slider("Discount Rate (%)", 5.0, 20.0, 10.0, 0.5) / 100
        else:
            dcf_discount_rate = 0.10  # Will be calculated if auto
    
    if dcf_btn or dcf_ticker_input:
        analysis_mode = "DCF Valuation"

# â”€â”€â”€ TAB 3: Quick Compare â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[3]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    compare_input = st.text_area(
        "Enter tickers (comma-separated)",
        placeholder="AAPL, MSFT, GOOGL, META",
        height=80,
        label_visibility="collapsed",
        key="compare_input"
    )
    
    compare_tickers = [t.strip().upper() for t in compare_input.split(",") if t.strip()]
    
    if compare_tickers:
        st.markdown(
            f'<div style="font-size:0.75rem; color:#60A5FA; margin:0.5rem 0;">'
            f'ğŸ“Š Comparing {len(compare_tickers)} companies: {", ".join(compare_tickers[:5])}'
            f'{"..." if len(compare_tickers) > 5 else ""}'
            f'</div>',
            unsafe_allow_html=True,
        )
    
    compare_btn = st.button("âš–ï¸ Compare", type="primary", use_container_width=True)
    
    if compare_btn or compare_tickers:
        analysis_mode = "Quick Compare"

# â”€â”€â”€ TAB 4: Merger Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[4]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([2, 2, 1])
    with col1:
        acquirer_input = ticker_autocomplete("Acquirer", key="acquirer_auto")
        if not acquirer_input:
            acquirer_input = st.text_input("Or manual", placeholder="e.g., MSFT", label_visibility="collapsed", key="acquirer_manual").strip().upper()
    with col2:
        target_input = ticker_autocomplete("Target", key="target_auto")
        if not target_input:
            target_input = st.text_input("Or manual", placeholder="e.g., ATVI", label_visibility="collapsed", key="target_manual").strip().upper()
    with col3:
        offer_premium = st.slider("Premium %", 0, 100, 30, 5)
    
    col1, col2 = st.columns([3, 1])
    with col1:
        pct_cash = st.slider("Cash %", 0, 100, 50, 5)
        pct_stock = 100 - pct_cash
    with col2:
        merger_btn = st.button("ğŸ¤ Analyze Deal", type="primary", use_container_width=True)
    
    # Additional merger params in expander
    with st.expander("âš™ï¸ Advanced Settings"):
        cost_syn = st.slider("Cost Synergies (% of Target SG&A)", 0, 30, 10, 1)
        rev_syn = st.slider("Revenue Synergies (% of Target Rev)", 0, 10, 2, 1)
        txn_fees = st.slider("Transaction Fees (%)", 0.5, 5.0, 2.0, 0.5)
        adv_cost_of_debt = st.slider("Cost of Debt (%)", 2.0, 10.0, 5.0, 0.5)
        adv_tax_rate = st.slider("Tax Rate (%)", 10, 40, 25, 1)
    
    # Set defaults if not in expander
    if 'cost_syn' not in locals():
        cost_syn, rev_syn, txn_fees, adv_cost_of_debt, adv_tax_rate = 10, 2, 2.0, 5.0, 25
    
    merger_assumptions = MergerAssumptions(
        offer_premium_pct=offer_premium,
        pct_cash=pct_cash,
        pct_stock=pct_stock,
        cost_synergies_pct=cost_syn,
        revenue_synergies_pct=rev_syn,
        transaction_fees_pct=txn_fees,
        tax_rate=adv_tax_rate,
        cost_of_debt=adv_cost_of_debt,
    )
    
    if merger_btn or (acquirer_input and target_input):
        analysis_mode = "Merger Analysis"

# â”€â”€â”€ TAB 5: Due Diligence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[5]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([3, 1])
    with col1:
        dd_ticker = ticker_autocomplete("Target company", key="dd_ticker_auto")
        if not dd_ticker:
            dd_ticker = st.text_input("Or manual", placeholder="e.g., AAPL", label_visibility="collapsed", key="dd_ticker_manual").strip().upper()
    with col2:
        dd_btn = st.button("ğŸ“‹ Start DD", type="primary", use_container_width=True)
    
    if dd_btn or dd_ticker:
        analysis_mode = "Due Diligence"

# â”€â”€â”€ TAB 6: Synergy Model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[6]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([2, 2, 1])
    with col1:
        syn_acquirer = ticker_autocomplete("Acquirer", key="syn_acquirer_auto")
        if not syn_acquirer:
            syn_acquirer = st.text_input("Or manual", placeholder="e.g., MSFT", label_visibility="collapsed", key="syn_acquirer_manual").strip().upper()
    with col2:
        syn_target = ticker_autocomplete("Target", key="syn_target_auto")
        if not syn_target:
            syn_target = st.text_input("Or manual", placeholder="e.g., ATVI", label_visibility="collapsed", key="syn_target_manual").strip().upper()
    with col3:
        syn_btn = st.button("ğŸ”— Model", type="primary", use_container_width=True)
    
    if syn_btn or (syn_acquirer and syn_target):
        analysis_mode = "Synergy Model"

# â”€â”€â”€ TAB 7: Integration Plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[7]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([2, 2, 1])
    with col1:
        int_acquirer = ticker_autocomplete("Acquirer", key="int_acquirer_auto")
        if not int_acquirer:
            int_acquirer = st.text_input("Or manual", placeholder="e.g., MSFT", label_visibility="collapsed", key="int_acquirer_manual").strip().upper()
    with col2:
        int_target = ticker_autocomplete("Target", key="int_target_auto")
        if not int_target:
            int_target = st.text_input("Or manual", placeholder="e.g., ATVI", label_visibility="collapsed", key="int_target_manual").strip().upper()
    with col3:
        int_btn = st.button("ğŸ“… Plan", type="primary", use_container_width=True)
    
    if int_btn or (int_acquirer and int_target):
        analysis_mode = "Integration Plan"

# â”€â”€â”€ TAB 8: Deal Structure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[8]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([2, 2])
    with col1:
        ds_acquirer = ticker_autocomplete("Acquirer", key="ds_acquirer_auto")
        if not ds_acquirer:
            ds_acquirer = st.text_input("Or manual", placeholder="e.g., GOOGL", label_visibility="collapsed", key="ds_acquirer_manual").strip().upper()
    with col2:
        ds_target = ticker_autocomplete("Target", key="ds_target_auto")
        if not ds_target:
            ds_target = st.text_input("Or manual", placeholder="e.g., WDAY", label_visibility="collapsed", key="ds_target_manual").strip().upper()
    
    col1, col2 = st.columns([3, 1])
    with col1:
        ds_equity_val = st.number_input("Target Equity Value ($M)", min_value=0, value=10000, step=1000)
    with col2:
        ds_btn = st.button("ğŸ’¼ Optimize", type="primary", use_container_width=True)
    
    if ds_btn or (ds_acquirer and ds_target):
        analysis_mode = "Deal Structure"

# â”€â”€â”€ TAB 9: Fairness Opinion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[9]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([2, 1, 1])
    with col1:
        fo_ticker = ticker_autocomplete("Target", key="fo_ticker_auto")
        if not fo_ticker:
            fo_ticker = st.text_input("Or manual", placeholder="e.g., TWTR", label_visibility="collapsed", key="fo_ticker_manual").strip().upper()
    with col2:
        fo_offer_price = st.number_input("Offer Price ($)", min_value=0.0, value=50.0, step=1.0)
    with col3:
        fo_btn = st.button("ğŸ“Š Opinion", type="primary", use_container_width=True)
    
    if fo_btn or fo_ticker:
        analysis_mode = "Fairness Opinion"

# â”€â”€â”€ TAB 10: VMS Screener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[10]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    vms_target_profile = st.selectbox(
        "Target Profile",
        ["Custom", "Classic CSU Target", "Growth VMS", "Turnaround Opportunity", "Cash Cow"],
        key="vms_target_profile_sel",
    )
    
    col1, col2, col3 = st.columns(3)
    with col1:
        vms_rev_min = st.slider("Min Revenue ($M)", 1, 500, 5, 1)
    with col2:
        vms_rev_max = st.slider("Max Revenue ($M)", 1, 500, 50, 1)
    with col3:
        vms_ebitda_min = st.slider("Min EBITDA Margin (%)", 0, 50, 15, 1)
    
    col1, col2 = st.columns([3, 1])
    with col1:
        vms_growth_min = st.slider("Min Revenue Growth (%)", -20, 50, 0, 1)
        vms_rule40_min = st.slider("Min Rule of 40", -50, 80, -50, 1)
    with col2:
        vms_screen_btn = st.button("ğŸ” Screen", type="primary", use_container_width=True)
    
    vms_industries = []
    vms_geographies = []
    
    if vms_screen_btn:
        analysis_mode = "VMS Screener"

# â”€â”€â”€ TAB 11: Options P/L â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[11]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([3, 1])
    with col1:
        options_pl_ticker = ticker_autocomplete("Stock", key="options_ticker_auto")
        if not options_pl_ticker:
            options_pl_ticker = st.text_input("Or manual", placeholder="e.g., AAPL", label_visibility="collapsed", key="options_ticker_manual").strip().upper()
    with col2:
        options_pl_btn = st.button("ğŸ“Š Analyze Options", type="primary", use_container_width=True)
    
    if options_pl_btn or options_pl_ticker:
        analysis_mode = "Options P/L"

# â”€â”€â”€ TAB 12: Sector Rotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tabs[12]:
    st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
    
    st.markdown(
        '<div style="font-size:0.85rem; color:#D1D5DB; margin-bottom:1rem;">'
        'Analyze sector momentum and rotation patterns across S&P 500 sectors.'
        '</div>',
        unsafe_allow_html=True,
    )
    sector_rotation_btn = st.button("ğŸ”„ Run Sector Analysis", type="primary", use_container_width=True)
    
    if sector_rotation_btn:
        analysis_mode = "Sector Rotation"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# END OF TAB DEFINITIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


# â”€â”€ Options P/L Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_options_pl_page(ticker):
    """Render options P/L analysis for a given ticker."""
    import yfinance as yf
    st.markdown(
        '<div class="space-section">'
        '<div class="space-section-title">ğŸ“Š Options P/L Analysis</div>'
        '</div>',
        unsafe_allow_html=True,
    )
    try:
        tk = yf.Ticker(ticker)
        expirations = tk.options
        if not expirations:
            st.warning(f"ğŸ˜• No options data available for **{ticker}**. This security may not have listed options. Try a different ticker.")
            return
        st.markdown(f'<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:1rem;">Found **{len(expirations)}** expiration dates for **{ticker}**</div>', unsafe_allow_html=True)
        selected_exp = st.selectbox("Expiration Date", expirations, key="opt_pl_exp")
        chain = tk.option_chain(selected_exp)
        tab_calls, tab_puts = st.tabs(["ğŸ“ˆ Calls", "ğŸ“‰ Puts"])
        with tab_calls:
            if chain.calls is not None and len(chain.calls) > 0:
                calls_df = chain.calls[["strike", "lastPrice", "bid", "ask", "volume", "openInterest", "impliedVolatility"]].copy()
                calls_df["impliedVolatility"] = (calls_df["impliedVolatility"] * 100).round(1)
                calls_df.columns = ["Strike", "Last", "Bid", "Ask", "Volume", "Open Int", "IV %"]
                st.dataframe(calls_df, use_container_width=True, hide_index=True)
                # P/L chart for ATM call
                info = tk.fast_info
                spot = getattr(info, 'last_price', None) or 0
                if spot > 0:
                    atm_idx = (calls_df["Strike"] - spot).abs().idxmin()
                    atm_call = chain.calls.iloc[atm_idx]
                    premium = atm_call["lastPrice"]
                    strikes_range = [spot * (1 + x/100) for x in range(-20, 41, 2)]
                    pnl = [max(0, s - atm_call["strike"]) - premium for s in strikes_range]
                    import plotly.graph_objects as go
                    fig = go.Figure()
                    fig.add_trace(go.Scatter(x=strikes_range, y=pnl, mode='lines', name='P/L', line=dict(color='#2563EB', width=2)))
                    fig.add_hline(y=0, line_dash="dash", line_color="#9CA3AF")
                    fig.add_vline(x=spot, line_dash="dash", line_color="#10B981", annotation_text="Spot")
                    fig.update_layout(template="plotly_dark", paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)",
                                      title=f"ATM Call P/L (Strike: ${atm_call['strike']:.0f}, Premium: ${premium:.2f})",
                                      xaxis_title="Stock Price at Expiry", yaxis_title="Profit / Loss ($)")
                    st.plotly_chart(fig, use_container_width=True, key="opt_pl_call_chart")
            else:
                st.info("No call options data available for this expiration.")
        with tab_puts:
            if chain.puts is not None and len(chain.puts) > 0:
                puts_df = chain.puts[["strike", "lastPrice", "bid", "ask", "volume", "openInterest", "impliedVolatility"]].copy()
                puts_df["impliedVolatility"] = (puts_df["impliedVolatility"] * 100).round(1)
                puts_df.columns = ["Strike", "Last", "Bid", "Ask", "Volume", "Open Int", "IV %"]
                st.dataframe(puts_df, use_container_width=True, hide_index=True)
            else:
                st.info("No put options data available for this expiration.")
    except Exception as e:
        st.error(f"ğŸ˜• Could not load options data for **{ticker}**: {e}. Please verify the ticker and try again.")


# â”€â”€ Sector Rotation Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_sector_rotation_page():
    """Render sector rotation analysis using S&P 500 sector ETFs."""
    import yfinance as yf
    import plotly.graph_objects as go
    st.markdown(
        '<div class="space-section">'
        '<div class="space-section-title">ğŸ”„ Sector Rotation Analysis</div>'
        '</div>',
        unsafe_allow_html=True,
    )
    sector_etfs = {
        "Technology": "XLK", "Healthcare": "XLV", "Financials": "XLF",
        "Consumer Disc.": "XLY", "Consumer Staples": "XLP", "Energy": "XLE",
        "Industrials": "XLI", "Materials": "XLB", "Real Estate": "XLRE",
        "Utilities": "XLU", "Comm. Services": "XLC",
    }
    try:
        import pandas as pd
        from datetime import datetime, timedelta
        periods = {"1W": 5, "1M": 21, "3M": 63, "6M": 126, "1Y": 252}
        results = []
        for sector, etf in sector_etfs.items():
            try:
                tk = yf.Ticker(etf)
                hist = tk.history(period="1y")
                if hist is None or len(hist) < 5:
                    continue
                row = {"Sector": sector, "ETF": etf}
                for label, days in periods.items():
                    if len(hist) >= days:
                        row[label] = ((hist["Close"].iloc[-1] / hist["Close"].iloc[-days]) - 1) * 100
                    else:
                        row[label] = None
                results.append(row)
            except Exception:
                pass
        if not results:
            st.warning("ğŸ˜• Could not fetch sector ETF data. Please check your internet connection and try again.")
            return
        df = pd.DataFrame(results)
        # Performance heatmap
        st.subheader("Sector Performance Heatmap")
        perf_cols = [c for c in ["1W", "1M", "3M", "6M", "1Y"] if c in df.columns]
        fig = go.Figure(data=go.Heatmap(
            z=df[perf_cols].values,
            x=perf_cols,
            y=df["Sector"],
            colorscale=[[0, "#EF4444"], [0.5, "#1F1D2B"], [1, "#10B981"]],
            text=[[f"{v:.1f}%" if v is not None else "" for v in row] for row in df[perf_cols].values],
            texttemplate="%{text}",
            textfont={"size": 11},
            zmid=0,
        ))
        fig.update_layout(template="plotly_dark", paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)",
                          height=450, margin=dict(l=120, r=20, t=30, b=30))
        st.plotly_chart(fig, use_container_width=True, key="sector_heatmap")
        # Momentum ranking
        st.subheader("Momentum Ranking (3M)")
        if "3M" in df.columns:
            df_sorted = df.sort_values("3M", ascending=False)
            for _, row in df_sorted.iterrows():
                val = row.get("3M", 0) or 0
                color = "#10B981" if val >= 0 else "#EF4444"
                arrow = "â–²" if val >= 0 else "â–¼"
                st.markdown(
                    f'<div style="display:flex; justify-content:space-between; padding:0.3rem 0.5rem; '
                    f'border-left:3px solid {color}; margin-bottom:0.3rem; background:rgba(37,99,235,0.04); border-radius:0 6px 6px 0;">'
                    f'<span style="color:#F9FAFB; font-weight:600;">{row["Sector"]}</span>'
                    f'<span style="color:{color}; font-weight:700;">{arrow} {val:+.1f}%</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
    except Exception as e:
        st.error(f"ğŸ˜• Sector rotation analysis failed: {e}. Please try again later.")


# â”€â”€ Main Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Orbital animated logo HTML (text inside orbit)
def _orbital_logo(size="", text="ORBITAL"):
    size_class = f" orbital-logo-{size}" if size else ""
    return (
        f'<div class="orbital-logo{size_class}">'
        f'<span class="orbital-text">{text}</span>'
        '<div class="orbital-ring orbital-ring-1"></div>'
        '<div class="orbital-ring orbital-ring-2"></div>'
        '<div class="orbital-ring orbital-ring-3"></div>'
        '<div class="orbital-particle orbital-particle-1"></div>'
        '<div class="orbital-particle orbital-particle-2"></div>'
        '<div class="orbital-particle orbital-particle-3"></div>'
        '</div>'
    )

if analysis_mode == "Company Profile":
    st.markdown(
        '<div class="hero-header">'
        '<div class="orbital-brand">'
        f'{_orbital_logo()}'
        '<p class="orbital-tagline">Company Intelligence & Tear Sheet Generator</p>'
        '</div>'
        '<span class="hero-tagline">Powered by Live Market Data</span>'
        '</div>',
        unsafe_allow_html=True,
    )
else:
    st.markdown(
        '<div class="hero-header">'
        '<div class="orbital-brand">'
        f'{_orbital_logo()}'
        '<p class="orbital-tagline">M&A Simulator & Deal Book Generator</p>'
        '</div>'
        '<span class="hero-tagline">Powered by Live Market Data</span>'
        '</div>',
        unsafe_allow_html=True,
    )

if analysis_mode == "Company Profile" and generate_btn and ticker_input:
    # â”€â”€ Data Fetching (with scanner loading animation) â”€â”€â”€
    _scanner_slot = st.empty()

    try:
        _scanner_slot.markdown(_render_profile_scanner(ticker_input.upper(), 0), unsafe_allow_html=True)
    except Exception:
        pass  # Scanner rendering is non-critical

    _loading_msg = st.empty()
    _loading_msg.info(f"ğŸ”­ Analyzing **{ticker_input.upper()}**... Fetching 150+ data points")
    try:
        cd = fetch_company_data(ticker_input)
        st.session_state["last_cd"] = cd
        # Add to search history on successful fetch
        _add_to_search_history(ticker_input)
    except Exception as e:
        _scanner_slot.empty()
        _loading_msg.empty()
        st.error(f"ğŸ˜• Failed to fetch data for **{ticker_input}**: {e}")
        st.info("ğŸ’¡ **Try these fixes:** Check the ticker symbol is correct (e.g., AAPL, MSFT) Â· Verify your internet connection Â· Try again in a few seconds", icon="ğŸ”§")
        st.stop()
    _loading_msg.empty()

    try:
        _scanner_slot.markdown(_render_profile_scanner(ticker_input.upper(), 1), unsafe_allow_html=True)
    except Exception:
        pass

    try:
        cd = fetch_peer_data(cd)
    except Exception:
        pass  # Peer data is non-critical

    try:
        _scanner_slot.markdown(_render_profile_scanner(ticker_input.upper(), 2), unsafe_allow_html=True)
    except Exception:
        pass

    try:
        cd = generate_insights(cd)
    except Exception as e:
        print(f"Insights generation warning: {e}")  # Non-fatal

    try:
        _scanner_slot.markdown(_render_profile_scanner(ticker_input.upper(), 3), unsafe_allow_html=True)
        time.sleep(1.2)
    except Exception:
        pass

    _scanner_slot.empty()

    cs = cd.currency_symbol  # shorthand
    _fetch_timestamp = datetime.now().strftime("%b %d, %Y at %H:%M UTC")
    st.session_state["_data_fetch_timestamp"] = _fetch_timestamp

    # Data freshness indicator + Refresh button
    _fresh_col1, _fresh_col2 = st.columns([4, 1])
    with _fresh_col1:
        st.markdown(
            f'<div style="text-align:right; padding:0.3rem 1rem; margin-bottom:-0.5rem;">'
            f'<span style="font-size:0.6rem; color:#5A567A;">ğŸ”„ Data as of {_fetch_timestamp}</span>'
            f'</div>',
            unsafe_allow_html=True,
        )
    with _fresh_col2:
        if st.button("ğŸ”„ Refresh", key="refresh_data_btn", help="Clear cached data and re-fetch"):
            # Clear all cached data
            for key in list(st.session_state.keys()):
                if key.startswith("last_cd") or key.startswith("_data"):
                    del st.session_state[key]
            st.cache_data.clear()
            st.rerun()

    # â”€â”€ Executive Dashboard Toggle â”€â”€
    _exec_dashboard = st.checkbox("ğŸ“‹ Executive Dashboard (1-Pager)", value=False, key="exec_dashboard_toggle",
                                   help="Condensed CIM cover page view with key metrics only")

    if _exec_dashboard:
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # EXECUTIVE DASHBOARD - Condensed 1-page view
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        st.markdown(
            f'<div style="background:rgba(37,99,235,0.08); border:2px solid rgba(37,99,235,0.3); '
            f'border-radius:16px; padding:1.5rem; margin:1rem 0;">'
            f'<div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">'
            f'<div style="font-size:1.6rem; font-weight:900; color:#fff;">{cd.name}</div>'
            f'<span style="background:#2563EB; color:white; padding:0.2rem 0.8rem; border-radius:12px; '
            f'font-size:0.7rem; font-weight:700;">{cd.ticker}</span>'
            f'</div>'
            f'<div style="font-size:2rem; font-weight:800; color:#fff;">{cs}{cd.current_price:,.2f}</div>'
            f'<div style="color:#9CA3AF; font-size:0.8rem; margin-top:0.3rem;">'
            f'52W: {cs}{cd.fifty_two_week_low:,.2f} â€” {cs}{cd.fifty_two_week_high:,.2f}</div>'
            f'</div>',
            unsafe_allow_html=True,
        )

        # Key ratios row
        _ed_cols = st.columns(4)
        _ed_metrics = [
            ("P/E (TTM)", f"{cd.trailing_pe:.1f}x" if cd.trailing_pe else "N/A", cd.trailing_pe),
            ("EV/EBITDA", f"{cd.ev_to_ebitda:.1f}x" if cd.ev_to_ebitda else "N/A", cd.ev_to_ebitda),
            ("ROE", f"{cd.return_on_equity*100:.1f}%" if cd.return_on_equity else "N/A", cd.return_on_equity),
            ("Div Yield", f"{cd.dividend_yield*100:.2f}%" if cd.dividend_yield else "N/A", None),
        ]
        for i, (label, val, raw_val) in enumerate(_ed_metrics):
            _bdr, _glow = _kpi_color(label, raw_val, sector=cd.sector)
            with _ed_cols[i]:
                st.markdown(
                    f'<div style="background:linear-gradient(135deg, {_glow}, rgba(255,255,255,0.04)); border:1px solid {_bdr}; '
                    f'border-radius:12px; padding:0.8rem; text-align:center; transition: transform 0.2s ease;">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">{label}</div>'
                    f'<div style="font-size:1.3rem; font-weight:700; color:#F9FAFB; margin-top:0.2rem;">{val}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

        # Valuation summary row
        _ed_val_cols = st.columns(2)
        with _ed_val_cols[0]:
            try:
                iv = calculate_intrinsic_value(cd)
                if iv:
                    _iv_color = "#10B981" if iv['upside_pct'] > 0 else "#EF4444"
                    st.markdown(
                        f'<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border:1px solid rgba(37,99,235,0.15); '
                        f'border-radius:12px; padding:1rem; margin-top:0.5rem;">'
                        f'<div style="font-size:0.7rem; color:#9CA3AF; text-transform:uppercase;">DCF Implied Price</div>'
                        f'<div style="font-size:1.5rem; font-weight:800; color:#F9FAFB;">{cs}{iv["intrinsic_value_per_share"]:.2f}</div>'
                        f'<div style="font-size:0.85rem; color:{_iv_color}; font-weight:700;">{iv["upside_pct"]:+.1f}% vs Current</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
                else:
                    st.markdown(
                        '<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border:1px solid rgba(37,99,235,0.15); '
                        'border-radius:12px; padding:1rem; margin-top:0.5rem;">'
                        '<div style="font-size:0.7rem; color:#9CA3AF;">DCF: Insufficient data</div></div>',
                        unsafe_allow_html=True,
                    )
            except Exception:
                pass

        with _ed_val_cols[1]:
            if cd.analyst_price_targets and cd.analyst_price_targets.get('mean'):
                _apt = cd.analyst_price_targets
                _apt_upside = ((_apt['mean'] / cd.current_price) - 1) * 100 if cd.current_price else 0
                _apt_color = "#10B981" if _apt_upside > 0 else "#EF4444"
                st.markdown(
                    f'<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border:1px solid rgba(37,99,235,0.15); '
                    f'border-radius:12px; padding:1rem; margin-top:0.5rem;">'
                    f'<div style="font-size:0.7rem; color:#9CA3AF; text-transform:uppercase;">Analyst Consensus</div>'
                    f'<div style="font-size:1.5rem; font-weight:800; color:#F9FAFB;">{cs}{_apt["mean"]:.2f}</div>'
                    f'<div style="font-size:0.85rem; color:{_apt_color}; font-weight:700;">{_apt_upside:+.1f}% Implied Upside</div>'
                    f'<div style="font-size:0.65rem; color:#9CA3AF;">{cs}{_apt.get("low",0):.2f} â€” {cs}{_apt.get("high",0):.2f}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

        # Mini price chart
        try:
            _ed_tk = yf.Ticker(cd.ticker)
            _ed_hist = _ed_tk.history(period="1y")
            if not _ed_hist.empty:
                _ed_fig = go.Figure()
                _ed_fig.add_trace(go.Scatter(
                    x=_ed_hist.index, y=_ed_hist["Close"], mode="lines",
                    line=dict(color="#2563EB", width=2), fill="tozeroy",
                    fillcolor="rgba(37,99,235,0.1)", showlegend=False,
                ))
                _ed_fig.update_layout(
                    paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)",
                    height=200, margin=dict(t=10, b=20, l=40, r=10),
                    xaxis=dict(showgrid=False, tickfont=dict(size=8, color="#9CA3AF")),
                    yaxis=dict(gridcolor="rgba(37,99,235,0.1)", griddash="dot",
                              tickfont=dict(size=8, color="#9CA3AF"), tickprefix=cs),
                )
                st.plotly_chart(_ed_fig, use_container_width=True, key="exec_dash_chart")
        except Exception:
            pass

        st.markdown(
            f'<div style="text-align:center; font-size:0.6rem; color:#5A567A; margin-top:0.5rem;">'
            f'Executive Dashboard â€” {cd.ticker} â€” {_fetch_timestamp}</div>',
            unsafe_allow_html=True,
        )

        st.markdown("---")
        st.markdown(
            '<div style="font-size:0.75rem; color:#9CA3AF; text-align:center; margin-bottom:1rem;">'
            'â†“ Full analysis below â†“</div>',
            unsafe_allow_html=True,
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 1. COMPANY HEADER CARD (with logo)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _cd_price_change = getattr(cd, 'price_change', None) or 0
    _cd_price_change_pct = getattr(cd, 'price_change_pct', None) or 0
    chg_class = "price-up" if _cd_price_change >= 0 else "price-down"
    chg_badge = "change-up" if _cd_price_change >= 0 else "change-down"
    arrow = "&#9650;" if _cd_price_change >= 0 else "&#9660;"

    logo_html = ""
    if cd.logo_url:
        _ld = getattr(cd, 'logo_domain', '')
        _logo_initial = (cd.name or "?")[0].upper()
        logo_fallback = (
            f"this.onerror=null; this.style.display='none'; "
            f"this.parentNode.querySelector('.logo-fallback').style.display='flex';"
        )
        logo_html = (
            f'<img src="{cd.logo_url}" '
            f'style="width:48px; height:48px; border-radius:50%; object-fit:contain; '
            f'background:white; padding:4px; margin-right:1.2rem; flex-shrink:0;" '
            f'onerror="{logo_fallback}">'
            f'<div class="logo-fallback" style="display:none; width:48px; height:48px; border-radius:50%; '
            f'background:linear-gradient(135deg, #2563EB, #10B981); color:white; font-size:1.4rem; font-weight:800; '
            f'align-items:center; justify-content:center; margin-right:1.2rem; flex-shrink:0;">{_logo_initial}</div>'
        )
    else:
        _logo_initial = (cd.name or "?")[0].upper()
        logo_html = (
            f'<div style="width:48px; height:48px; border-radius:50%; '
            f'background:linear-gradient(135deg, #2563EB, #10B981); color:white; font-size:1.4rem; font-weight:800; '
            f'display:flex; align-items:center; justify-content:center; margin-right:1.2rem; flex-shrink:0;">{_logo_initial}</div>'
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # PREMIUM COMPANY SUMMARY CARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Company Summary Card"):
        try:
            # Sector-derived accent colors
            _sector_colors = {
                "Technology": ("#2563EB", "#60A5FA"), "Healthcare": ("#10B981", "#F093B0"),
                "Financial Services": ("#F5A623", "#F7C574"), "Financials": ("#F5A623", "#F7C574"),
                "Consumer Cyclical": ("#10B981", "#6EE7B7"), "Consumer Defensive": ("#34D399", "#A7F3D0"),
                "Energy": ("#EF4444", "#FCA5A5"), "Industrials": ("#3B82F6", "#93C5FD"),
                "Real Estate": ("#8B5CF6", "#C4B5FD"), "Communication Services": ("#EC4899", "#F9A8D4"),
                "Basic Materials": ("#D97706", "#FCD34D"), "Utilities": ("#06B6D4", "#67E8F9"),
            }
            _sc_accent1, _sc_accent2 = _sector_colors.get(cd.sector, ("#2563EB", "#60A5FA"))

            # Logo or initials
            _sc_initial = (cd.name or "?")[0].upper()
            if cd.logo_url:
                _sc_logo = (
                    f'<img src="{cd.logo_url}" style="width:64px; height:64px; border-radius:16px; '
                    f'object-fit:contain; background:white; padding:6px; flex-shrink:0;" '
                    f'onerror="this.onerror=null; this.style.display=\'none\'; '
                    f'this.nextElementSibling.style.display=\'flex\';">'
                    f'<div style="display:none; width:64px; height:64px; border-radius:16px; '
                    f'background:linear-gradient(135deg, {_sc_accent1}, {_sc_accent2}); color:white; '
                    f'font-size:1.8rem; font-weight:800; align-items:center; justify-content:center; flex-shrink:0;">{_sc_initial}</div>'
                )
            else:
                _sc_logo = (
                    f'<div style="width:64px; height:64px; border-radius:16px; '
                    f'background:linear-gradient(135deg, {_sc_accent1}, {_sc_accent2}); color:white; '
                    f'font-size:1.8rem; font-weight:800; display:flex; align-items:center; justify-content:center; flex-shrink:0;">{_sc_initial}</div>'
                )

            # Business summary snippet
            _sc_summary = (getattr(cd, 'long_business_summary', '') or '')[:200]
            if _sc_summary and len(getattr(cd, 'long_business_summary', '') or '') > 200:
                _sc_summary = _sc_summary.rsplit(' ', 1)[0] + 'â€¦'

            # Badges
            _sc_badges = []
            if cd.sector:
                _sc_badges.append(f'<span style="display:inline-block; padding:0.2rem 0.6rem; border-radius:12px; font-size:0.65rem; font-weight:600; background:rgba({int(_sc_accent1[1:3],16)},{int(_sc_accent1[3:5],16)},{int(_sc_accent1[5:7],16)},0.15); color:{_sc_accent2}; letter-spacing:0.3px;">âš¡ {cd.sector}</span>')
            if cd.industry:
                _sc_badges.append(f'<span style="display:inline-block; padding:0.2rem 0.6rem; border-radius:12px; font-size:0.65rem; font-weight:600; background:rgba(37,99,235,0.1); color:#60A5FA; letter-spacing:0.3px;">ğŸ­ {cd.industry}</span>')
            _sc_country = getattr(cd, 'country', '') or ''
            if _sc_country:
                _sc_badges.append(f'<span style="display:inline-block; padding:0.2rem 0.6rem; border-radius:12px; font-size:0.65rem; font-weight:600; background:rgba(16,185,129,0.1); color:#34D399; letter-spacing:0.3px;">ğŸŒ {_sc_country}</span>')
            _sc_emp = getattr(cd, 'full_time_employees', None)
            if _sc_emp:
                _sc_badges.append(f'<span style="display:inline-block; padding:0.2rem 0.6rem; border-radius:12px; font-size:0.65rem; font-weight:600; background:rgba(245,166,35,0.1); color:#F7C574; letter-spacing:0.3px;">ğŸ‘¥ {_sc_emp:,} employees</span>')
            _sc_badges_html = ' '.join(_sc_badges)

            # Extra details (CEO, website, founded)
            _sc_details = []
            _sc_officers = getattr(cd, 'officers', []) or []
            _sc_ceo = ''
            for _off in _sc_officers:
                _title = (_off.get('title', '') or '').lower()
                if 'ceo' in _title or 'chief executive' in _title:
                    _sc_ceo = _off.get('name', '')
                    break
            if _sc_ceo:
                _sc_details.append(f'<span style="color:#D1D5DB; font-size:0.75rem;">ğŸ‘¤ <strong style="color:#F9FAFB;">{_sc_ceo}</strong> â€” CEO</span>')
            _sc_web = getattr(cd, 'website', '') or ''
            if _sc_web:
                _sc_details.append(f'<a href="{_sc_web}" target="_blank" style="color:{_sc_accent2}; font-size:0.75rem; text-decoration:none;">ğŸ”— {_sc_web.replace("https://","").replace("http://","").rstrip("/")}</a>')
            _sc_details_html = '&nbsp;&nbsp;Â·&nbsp;&nbsp;'.join(_sc_details) if _sc_details else ''

            st.markdown(
                f'<div style="background:linear-gradient(135deg, rgba(20,18,35,0.95), rgba(30,27,50,0.95)); '
                f'border:2px solid transparent; border-image:linear-gradient(135deg, {_sc_accent1}, {_sc_accent2}, {_sc_accent1}) 1; '
                f'border-radius:0px; padding:1.8rem 2rem; margin:1rem 0 1.5rem 0; position:relative; overflow:hidden; '
                f'box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 60px {_sc_accent1}15;">'
                # Decorative gradient orb
                f'<div style="position:absolute; top:-40px; right:-40px; width:160px; height:160px; '
                f'border-radius:50%; background:radial-gradient(circle, {_sc_accent1}20, transparent 70%); pointer-events:none;"></div>'
                # Header row: logo + name/ticker
                f'<div style="display:flex; align-items:center; gap:1.2rem; margin-bottom:1rem;">'
                f'{_sc_logo}'
                f'<div>'
                f'<div style="font-size:1.5rem; font-weight:900; color:#FFFFFF; letter-spacing:-0.5px;">{cd.name}</div>'
                f'<div style="display:flex; align-items:center; gap:0.6rem; margin-top:0.2rem;">'
                f'<span style="background:{_sc_accent1}; color:white; padding:0.15rem 0.6rem; border-radius:12px; '
                f'font-size:0.7rem; font-weight:700; letter-spacing:0.5px;">{cd.ticker}</span>'
                f'<span style="color:#9CA3AF; font-size:0.75rem;">{cd.exchange}</span>'
                f'</div></div></div>'
                # Business summary
                + (f'<div style="color:#D1D5DB; font-size:0.82rem; line-height:1.5; margin-bottom:1rem; '
                   f'padding-left:0.5rem; border-left:3px solid {_sc_accent1}40;">{_sc_summary}</div>' if _sc_summary else '')
                # Badges row
                + (f'<div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.8rem;">{_sc_badges_html}</div>' if _sc_badges_html else '')
                # Details row (CEO, website)
                + (f'<div style="margin-top:0.5rem;">{_sc_details_html}</div>' if _sc_details_html else '')
                + '</div>',
                unsafe_allow_html=True,
            )
        except Exception:
            pass  # Non-critical decorative element

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # VALUATION AT A GLANCE DASHBOARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Valuation Dashboard"):
        try:
            _vd_price = cd.current_price or 0
            _vd_dcf = None
            try:
                _vd_iv = calculate_intrinsic_value(cd)
                if _vd_iv and _vd_iv.get("intrinsic_value_per_share"):
                    _vd_dcf = _vd_iv["intrinsic_value_per_share"]
            except Exception:
                pass
            _vd_comps_median = None
            try:
                _vd_ca = run_comps_analysis(cd.ticker)
                if _vd_ca and hasattr(_vd_ca, 'implied_price_median'):
                    _vd_comps_median = _vd_ca.implied_price_median
                elif _vd_ca and hasattr(_vd_ca, 'median_ev_ebitda') and cd.ev_to_ebitda and cd.ev_to_ebitda > 0:
                    _vd_comps_median = _vd_price * (_vd_ca.median_ev_ebitda / cd.ev_to_ebitda)
            except Exception:
                pass
            _vd_52h = cd.fifty_two_week_high or _vd_price
            _vd_52l = cd.fifty_two_week_low or _vd_price
            _vd_range = _vd_52h - _vd_52l if _vd_52h != _vd_52l else 1
            _vd_pos = max(0, min(100, ((_vd_price - _vd_52l) / _vd_range) * 100))

            # Determine verdict
            _vd_signals = []
            if _vd_dcf and _vd_price > 0:
                _vd_dcf_upside = ((_vd_dcf - _vd_price) / _vd_price) * 100
                _vd_signals.append(_vd_dcf_upside)
            else:
                _vd_dcf_upside = None
            if _vd_comps_median and _vd_price > 0:
                _vd_comps_prem = ((_vd_price - _vd_comps_median) / _vd_comps_median) * 100
                _vd_signals.append(-_vd_comps_prem)
            else:
                _vd_comps_prem = None
            _vd_avg = np.mean(_vd_signals) if _vd_signals else 0
            if _vd_avg > 15:
                _vd_verdict, _vd_vcolor = "Undervalued", "#10B981"
            elif _vd_avg < -15:
                _vd_verdict, _vd_vcolor = "Overvalued", "#EF4444"
            else:
                _vd_verdict, _vd_vcolor = "Fair Value", "#F5A623"

            # Build the dashboard row
            _vd_cols = st.columns(4)
            with _vd_cols[0]:
                if _vd_dcf and _vd_dcf_upside is not None:
                    _vd_arr = "â–²" if _vd_dcf_upside > 0 else "â–¼"
                    _vd_dc = "#10B981" if _vd_dcf_upside > 0 else "#EF4444"
                    st.markdown(f'<div style="background:rgba(37,99,235,0.06); border:1px solid rgba(37,99,235,0.15); border-radius:12px; padding:0.7rem; text-align:center;">'
                                f'<div style="font-size:0.55rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">Price vs DCF</div>'
                                f'<div style="font-size:1.1rem; font-weight:700; color:#F9FAFB;">{cs}{_vd_dcf:,.2f}</div>'
                                f'<div style="font-size:0.75rem; font-weight:700; color:{_vd_dc};">{_vd_arr} {_vd_dcf_upside:+.1f}%</div></div>', unsafe_allow_html=True)
                else:
                    st.markdown(f'<div style="background:rgba(37,99,235,0.06); border:1px solid rgba(37,99,235,0.15); border-radius:12px; padding:0.7rem; text-align:center;">'
                                f'<div style="font-size:0.55rem; color:#9CA3AF; text-transform:uppercase;">Price vs DCF</div>'
                                f'<div style="font-size:0.9rem; color:#5A567A;">N/A</div></div>', unsafe_allow_html=True)
            with _vd_cols[1]:
                if _vd_comps_median and _vd_comps_prem is not None:
                    _vd_cp_label = "Premium" if _vd_comps_prem > 0 else "Discount"
                    _vd_cp_c = "#EF4444" if _vd_comps_prem > 10 else "#10B981" if _vd_comps_prem < -10 else "#F5A623"
                    st.markdown(f'<div style="background:rgba(16,185,129,0.06); border:1px solid rgba(16,185,129,0.15); border-radius:12px; padding:0.7rem; text-align:center;">'
                                f'<div style="font-size:0.55rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">vs Comps Median</div>'
                                f'<div style="font-size:1.1rem; font-weight:700; color:#F9FAFB;">{cs}{_vd_comps_median:,.2f}</div>'
                                f'<div style="font-size:0.75rem; font-weight:700; color:{_vd_cp_c};">{_vd_comps_prem:+.1f}% {_vd_cp_label}</div></div>', unsafe_allow_html=True)
                else:
                    st.markdown(f'<div style="background:rgba(16,185,129,0.06); border:1px solid rgba(16,185,129,0.15); border-radius:12px; padding:0.7rem; text-align:center;">'
                                f'<div style="font-size:0.55rem; color:#9CA3AF; text-transform:uppercase;">vs Comps Median</div>'
                                f'<div style="font-size:0.9rem; color:#5A567A;">N/A</div></div>', unsafe_allow_html=True)
            with _vd_cols[2]:
                st.markdown(f'<div style="background:rgba(16,185,129,0.06); border:1px solid rgba(16,185,129,0.15); border-radius:12px; padding:0.7rem; text-align:center;">'
                            f'<div style="font-size:0.55rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">52-Week Range</div>'
                            f'<div style="font-size:0.7rem; color:#9CA3AF; margin:0.3rem 0;">{cs}{_vd_52l:,.2f} â€” {cs}{_vd_52h:,.2f}</div>'
                            f'<div style="background:rgba(255,255,255,0.08); border-radius:6px; height:8px; position:relative; overflow:hidden;">'
                            f'<div style="position:absolute; left:0; top:0; height:100%; width:{_vd_pos:.0f}%; '
                            f'background:linear-gradient(90deg, #EF4444, #F5A623, #10B981); border-radius:6px;"></div>'
                            f'<div style="position:absolute; left:{_vd_pos:.0f}%; top:-3px; width:3px; height:14px; '
                            f'background:#fff; border-radius:2px; transform:translateX(-50%);"></div></div></div>', unsafe_allow_html=True)
            with _vd_cols[3]:
                st.markdown(f'<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border:2px solid {_vd_vcolor}40; border-radius:12px; padding:0.7rem; text-align:center;">'
                            f'<div style="font-size:0.55rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">Verdict</div>'
                            f'<div style="font-size:1.1rem; font-weight:800; color:{_vd_vcolor}; margin-top:0.2rem;">{_vd_verdict}</div>'
                            f'<div style="font-size:0.6rem; color:#9CA3AF;">DCF + Comps + Range</div></div>', unsafe_allow_html=True)
        except Exception:
            pass

    st.markdown(
        f'<div class="company-card">'
        f'<div style="display:flex; align-items:center; position:relative;">'
        f'{logo_html}'
        f'<div>'
        f'<p class="company-name">{cd.name}</p>'
        f'<p class="company-meta"><span>{cd.ticker}</span> &nbsp;&middot;&nbsp; {cd.exchange} &nbsp;&middot;&nbsp; {cd.sector} &rarr; {cd.industry}</p>'
        f'</div>'
        f'</div>'
        f'<div style="display:flex; align-items:baseline; gap:1rem; margin-top:0.8rem; position:relative;">'
        f'<p class="price-tag {chg_class}">{cs}{getattr(cd, "current_price", 0):,.2f}</p>'
        f'<span class="price-change {chg_badge}">{arrow} {_cd_price_change:+.2f} ({_cd_price_change_pct:+.2f}%)</span>'
        f'<span style="font-size:0.75rem; color:#A8A3C7; margin-left:0.5rem;">{cd.currency_code}</span>'
        f'</div>'
        f'</div>',
        unsafe_allow_html=True,
    )

    # â”€â”€ Quick Facts Pills â”€â”€
    # Add CSS for pill hover effects
    st.markdown("""
    <style>
    .qf-pill {
        display: inline-block;
        padding: 0.25rem 0.7rem;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 600;
        margin-right: 0.4rem;
        margin-bottom: 0.3rem;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid transparent;
    }
    .qf-pill:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .qf-pill-sector { background: rgba(37,99,235,0.15); color: #60A5FA; }
    .qf-pill-sector:hover { background: rgba(37,99,235,0.2); border-color: rgba(37,99,235,0.3); }
    .qf-pill-industry { background: rgba(16,185,129,0.15); color: #10B981; }
    .qf-pill-industry:hover { background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); }
    .qf-pill-exchange { background: rgba(16,185,129,0.15); color: #10B981; }
    .qf-pill-exchange:hover { background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); }
    .qf-pill-country { background: rgba(245,158,11,0.15); color: #F59E0B; }
    .qf-pill-country:hover { background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); }
    </style>
    """, unsafe_allow_html=True)
    
    _qf_pills = []
    if cd.sector:
        _qf_pills.append(f'<span class="qf-pill qf-pill-sector">ğŸ¢ {cd.sector}</span>')
    if cd.industry:
        _qf_pills.append(f'<span class="qf-pill qf-pill-industry">âš™ï¸ {cd.industry}</span>')
    if cd.exchange:
        _qf_pills.append(f'<span class="qf-pill qf-pill-exchange">ğŸ“ {cd.exchange}</span>')
    _cd_country = getattr(cd, 'country', None)
    if _cd_country:
        _qf_pills.append(f'<span class="qf-pill qf-pill-country">ğŸŒ {_cd_country}</span>')
    if _qf_pills:
        st.markdown(
            f'<div style="padding:0.3rem 0 0.5rem 0;">{"".join(_qf_pills)}</div>',
            unsafe_allow_html=True,
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # INDUSTRY SNAPSHOT PANEL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Industry Snapshot"):
        _ind_sector = cd.sector or ""
        _ind_industry = cd.industry or ""
        _ind_bench = get_sector_benchmarks(_ind_sector) if _ind_sector else None
        if _ind_sector and _ind_bench:
            _ind_pe_med = _ind_bench["pe"]["median"]
            _ind_ev_med = _ind_bench["ev_ebitda"]["median"]
            _ind_gr_med = _ind_bench["revenue_growth"]["median"]
            # Discover top peers
            _ind_peers = []
            if cd.peer_data:
                _sorted_peers = sorted(cd.peer_data, key=lambda p: p.get("market_cap", 0) or 0, reverse=True)
                _ind_peers = _sorted_peers[:3]
            _ind_peer_count = len(cd.peer_data) if cd.peer_data else 0
            _ind_mcap_str = ""
            if cd.market_cap:
                if cd.market_cap >= 200e9:
                    _ind_mcap_str = "Mega Cap"
                elif cd.market_cap >= 10e9:
                    _ind_mcap_str = "Large Cap"
                elif cd.market_cap >= 2e9:
                    _ind_mcap_str = "Mid Cap"
                elif cd.market_cap >= 300e6:
                    _ind_mcap_str = "Small Cap"
                else:
                    _ind_mcap_str = "Micro Cap"

            _ind_peers_html = ""
            for _ip in _ind_peers:
                _ip_name = _ip.get("name", _ip.get("ticker", "?"))
                _ip_mcap = _ip.get("market_cap", 0)
                _ip_mcap_fmt = f"${_ip_mcap/1e9:.1f}B" if _ip_mcap >= 1e9 else f"${_ip_mcap/1e6:.0f}M" if _ip_mcap >= 1e6 else "N/A"
                _ind_peers_html += (
                    f'<div style="display:flex; justify-content:space-between; padding:0.15rem 0; '
                    f'font-size:0.72rem; color:#D1D5DB;">'
                    f'<span>{_ip_name}</span><span style="color:#60A5FA;">{_ip_mcap_fmt}</span></div>'
                )

            st.markdown(
                f'<div style="background:rgba(37,99,235,0.04); border:1px solid rgba(37,99,235,0.12); '
                f'border-radius:12px; padding:0.8rem 1rem; margin:0.3rem 0 0.6rem 0;">'
                f'<div style="font-size:0.65rem; font-weight:700; color:#2563EB; text-transform:uppercase; '
                f'letter-spacing:1.5px; margin-bottom:0.5rem;">ğŸ­ Industry Snapshot</div>'
                f'<div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem 1rem; font-size:0.75rem;">'
                f'<div style="color:#9CA3AF;">Sector</div><div style="color:#F9FAFB;">{_ind_sector}</div>'
                f'<div style="color:#9CA3AF;">Industry</div><div style="color:#F9FAFB;">{_ind_industry}</div>'
                f'<div style="color:#9CA3AF;">Market Position</div><div style="color:#F9FAFB;">{_ind_mcap_str}</div>'
                f'<div style="color:#9CA3AF;">Sector Median P/E</div><div style="color:#F9FAFB;">{_ind_pe_med:.1f}x</div>'
                f'<div style="color:#9CA3AF;">Sector Median EV/EBITDA</div><div style="color:#F9FAFB;">{_ind_ev_med:.1f}x</div>'
                f'<div style="color:#9CA3AF;">Sector Growth Rate</div><div style="color:#F9FAFB;">{_ind_gr_med*100:.1f}%</div>'
                f'<div style="color:#9CA3AF;">Tracked Peers</div><div style="color:#F9FAFB;">{_ind_peer_count} companies</div>'
                f'</div>'
                + (f'<div style="margin-top:0.5rem; border-top:1px solid rgba(37,99,235,0.1); padding-top:0.4rem;">'
                   f'<div style="font-size:0.62rem; color:#2563EB; font-weight:600; margin-bottom:0.2rem;">Top Peers by Market Cap</div>'
                   f'{_ind_peers_html}</div>' if _ind_peers_html else '')
                + f'</div>',
                unsafe_allow_html=True,
            )

    # â”€â”€ Price Context Bar (52-week range with MA markers) â”€â”€
    _pc_low = getattr(cd, 'fifty_two_week_low', None) or 0
    _pc_high = getattr(cd, 'fifty_two_week_high', None) or 0
    _pc_price = getattr(cd, 'current_price', 0) or 0
    if _pc_high > _pc_low > 0:
        _pc_range = _pc_high - _pc_low
        _pc_pct = max(0, min(100, ((_pc_price - _pc_low) / _pc_range) * 100))
        # Try to get 50d and 200d SMA
        _pc_sma50_pct = None
        _pc_sma200_pct = None
        try:
            _pc_hist = yf.Ticker(cd.ticker).history(period="1y")
            if _pc_hist is not None and len(_pc_hist) >= 50:
                _pc_sma50 = float(_pc_hist["Close"].rolling(50).mean().iloc[-1])
                _pc_sma50_pct = max(0, min(100, ((_pc_sma50 - _pc_low) / _pc_range) * 100))
            if _pc_hist is not None and len(_pc_hist) >= 200:
                _pc_sma200 = float(_pc_hist["Close"].rolling(200).mean().iloc[-1])
                _pc_sma200_pct = max(0, min(100, ((_pc_sma200 - _pc_low) / _pc_range) * 100))
        except Exception:
            pass
        _pc_gradient_color = f"hsl({_pc_pct * 1.2}, 70%, 50%)"
        _pc_markers = ""
        if _pc_sma50_pct is not None:
            _pc_markers += (f'<div style="position:absolute; left:{_pc_sma50_pct}%; top:-2px; width:2px; height:18px; '
                           f'background:#F59E0B; border-radius:1px;" title="50-day SMA"></div>'
                           f'<div style="position:absolute; left:{_pc_sma50_pct}%; top:18px; font-size:0.5rem; '
                           f'color:#F59E0B; transform:translateX(-50%);">50d</div>')
        if _pc_sma200_pct is not None:
            _pc_markers += (f'<div style="position:absolute; left:{_pc_sma200_pct}%; top:-2px; width:2px; height:18px; '
                           f'background:#3B82F6; border-radius:1px;" title="200-day SMA"></div>'
                           f'<div style="position:absolute; left:{_pc_sma200_pct}%; top:18px; font-size:0.5rem; '
                           f'color:#3B82F6; transform:translateX(-50%);">200d</div>')
        st.markdown(
            f'<div style="background:rgba(255,255,255,0.03); border:1px solid rgba(37,99,235,0.1); '
            f'border-radius:10px; padding:0.6rem 1rem 1.2rem 1rem; margin-bottom:0.8rem;">'
            f'<div style="display:flex; justify-content:space-between; font-size:0.6rem; color:#9CA3AF; margin-bottom:0.3rem;">'
            f'<span>52W Low: {cs}{_pc_low:,.2f}</span>'
            f'<span style="font-weight:700; color:#F9FAFB;">PRICE CONTEXT</span>'
            f'<span>52W High: {cs}{_pc_high:,.2f}</span></div>'
            f'<div style="position:relative; height:14px; background:linear-gradient(90deg, #EF4444, #F59E0B, #10B981); '
            f'border-radius:7px; margin-top:0.2rem;">'
            f'<div style="position:absolute; left:{_pc_pct}%; top:-3px; width:4px; height:20px; '
            f'background:white; border-radius:2px; transform:translateX(-50%); box-shadow:0 0 6px rgba(255,255,255,0.5);" '
            f'title="Current: {cs}{_pc_price:,.2f}"></div>'
            f'{_pc_markers}'
            f'</div></div>',
            unsafe_allow_html=True,
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2. PROMINENT PRICE / VOLUME DISPLAY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    price_color = "#10B981" if _cd_price_change >= 0 else "#EF4444"
    price_bg = "rgba(16,185,129,0.05)" if _cd_price_change >= 0 else "rgba(239,68,68,0.05)"

    st.markdown(
        f'<div class="price-bar" style="background:{price_bg}; border:1px solid {"rgba(16,185,129,0.15)" if _cd_price_change >= 0 else "rgba(239,68,68,0.15)"};">'
        f'<div style="flex:1;">'
        f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Current Price</div>'
        f'<div style="font-size:2rem; font-weight:800; color:{price_color};">'
        f'{cs}{getattr(cd, "current_price", 0):,.2f}'
        f'<span style="font-size:0.9rem; margin-left:0.5rem;">{arrow} {_cd_price_change:+.2f} ({_cd_price_change_pct:+.2f}%)</span></div>'
        f'</div>'
        f'<div style="flex:0 0 180px; text-align:center; border-left:1px solid rgba(255,255,255,0.1); padding-left:1rem;">'
        f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Volume</div>'
        f'<div style="font-size:1.3rem; font-weight:700; color:#F9FAFB;">{format_number(getattr(cd, "volume", None), prefix="", decimals=0)}</div>'
        f'<div style="font-size:0.6rem; color:#9CA3AF;">Avg: {format_number(getattr(cd, "avg_volume", None), prefix="", decimals=0)}</div>'
        f'</div>'
        f'<div style="flex:0 0 220px; text-align:center; border-left:1px solid rgba(255,255,255,0.1); padding-left:1rem;">'
        f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">52W Range</div>'
        f'<div style="font-size:1.1rem; font-weight:600; color:#F9FAFB;">'
        f'{cs}{getattr(cd, "fifty_two_week_low", 0):,.2f} &mdash; {cs}{getattr(cd, "fifty_two_week_high", 0):,.2f}</div>'
        f'</div>'
        f'</div>',
        unsafe_allow_html=True,
    )

    # Quick KPI strip with sparklines
    def _make_sparkline(data, color="#2563EB", height=40):
        """Create a minimal sparkline figure."""
        if data is None or (hasattr(data, '__len__') and len(data) < 2):
            return None
        try:
            import plotly.graph_objects as _sp_go
            vals = list(data) if not isinstance(data, list) else data
            vals = [v for v in vals if v is not None and not (isinstance(v, float) and (v != v))]
            if len(vals) < 2:
                return None
            fig = _sp_go.Figure(_sp_go.Scatter(
                y=vals, mode='lines', line=dict(color=color, width=1.5),
                fill='tozeroy', fillcolor=color.replace(')', ',0.1)').replace('rgb', 'rgba') if 'rgb' in color else f"rgba(37,99,235,0.1)",
            ))
            fig.update_layout(
                height=height, margin=dict(t=0, b=0, l=0, r=0),
                paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)",
                xaxis=dict(visible=False), yaxis=dict(visible=False),
                showlegend=False,
            )
            return fig
        except Exception:
            return None

    def _yoy_delta(series):
        """Return YoY delta string from a Series (most recent vs prior)."""
        if series is None or not hasattr(series, 'iloc') or len(series) < 2:
            return None
        try:
            curr = float(series.iloc[0])
            prev = float(series.iloc[1])
            if prev == 0:
                return None
            pct = (curr / prev - 1) * 100
            return f"{pct:+.1f}% YoY"
        except Exception:
            return None

    k1, k2, k3, k4, k5, k6 = st.columns(6)
    k1.metric("Market Cap", format_number(getattr(cd, 'market_cap', None), currency_symbol=cs), help="Total market value of outstanding shares (share price Ã— shares outstanding)")
    k2.metric("Enterprise Value", format_number(getattr(cd, 'enterprise_value', None), currency_symbol=cs), help="Market Cap + Total Debt âˆ’ Cash â€” represents the total cost to acquire the business")

    _rev_val = "N/A"
    _rev_delta = None
    if cd.revenue is not None and len(cd.revenue) > 0:
        _rev_val = format_number(cd.revenue.iloc[0], currency_symbol=cs)
        _rev_delta = _yoy_delta(cd.revenue)
    k3.metric("Revenue (TTM)", _rev_val, delta=_rev_delta, help="Trailing twelve months total revenue")

    _ni_val = "N/A"
    _ni_delta = None
    if cd.net_income is not None and len(cd.net_income) > 0:
        _ni_val = format_number(cd.net_income.iloc[0], currency_symbol=cs)
        _ni_delta = _yoy_delta(cd.net_income)
    k4.metric("Net Income", _ni_val, delta=_ni_delta)

    _fcf_val = "N/A"
    _fcf_delta = None
    if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) > 0:
        _fcf_val = format_number(cd.free_cashflow_series.iloc[0], currency_symbol=cs)
        _fcf_delta = _yoy_delta(cd.free_cashflow_series)
    k5.metric("Free Cash Flow", _fcf_val, delta=_fcf_delta, help="Operating cash flow minus capital expenditures â€” cash available to shareholders and debtholders")

    # dividend_yield: yfinance may return as decimal (0.009) or already as pct-like (0.9)
    _div_yield = getattr(cd, 'dividend_yield', None)
    k6.metric("Dividend Yield", format_pct(_div_yield) if _div_yield else "N/A", help="Annual dividend per share Ã· share price â€” income return on investment")

    # Sparkline row under KPIs
    _price_hist = getattr(cd, 'price_history', None)
    _spark_price = _make_sparkline(_price_hist, color="#2563EB") if _price_hist is not None else None
    _spark_rev = _make_sparkline(cd.revenue[::-1] if cd.revenue is not None and len(cd.revenue) > 1 else None, color="#10B981")
    if _spark_price or _spark_rev:
        sp1, sp2 = st.columns(2)
        if _spark_price:
            with sp1:
                st.markdown('<div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Price Trend (30d)</div>', unsafe_allow_html=True)
                st.plotly_chart(_spark_price, use_container_width=True, key="spark_price")
        if _spark_rev:
            with sp2:
                st.markdown('<div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Revenue Trend</div>', unsafe_allow_html=True)
                st.plotly_chart(_spark_rev, use_container_width=True, key="spark_rev")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“ˆ HISTORICAL VALUATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Historical Valuation"):
        _divider()
        _section("Historical Valuation", "ğŸ“ˆ")
        try:
            _hv_hist = getattr(cd, 'price_history', None)
            _hv_pe = getattr(cd, 'trailing_pe', None)
            _hv_ps = getattr(cd, 'price_to_sales', None)
            _hv_earnings = getattr(cd, 'quarterly_earnings', None)
            _hv_revenue = getattr(cd, 'quarterly_revenue', None) or getattr(cd, 'revenue', None)

            if _hv_hist is not None and len(_hv_hist) > 30:
                _hv_prices = _hv_hist if isinstance(_hv_hist, pd.Series) else (
                    _hv_hist['Close'] if hasattr(_hv_hist, 'columns') and 'Close' in _hv_hist.columns else None
                )
                if _hv_prices is not None:
                    # Try to compute trailing P/E over time using quarterly earnings
                    _hv_pe_series = None
                    _hv_label = "P/E"
                    if _hv_earnings is not None and hasattr(_hv_earnings, '__len__') and len(_hv_earnings) >= 4:
                        try:
                            # quarterly_earnings may be a DataFrame with 'Earnings' column
                            if hasattr(_hv_earnings, 'columns'):
                                _hv_eps_vals = _hv_earnings['Earnings'] if 'Earnings' in _hv_earnings.columns else _hv_earnings.iloc[:, 0]
                            else:
                                _hv_eps_vals = _hv_earnings
                            # trailing 4Q EPS
                            _hv_ttm_eps = float(_hv_eps_vals.rolling(4).sum().iloc[-1]) if hasattr(_hv_eps_vals, 'rolling') else float(sum(list(_hv_eps_vals)[-4:]))
                            if _hv_ttm_eps and _hv_ttm_eps > 0:
                                _hv_pe_series = _hv_prices / _hv_ttm_eps
                        except Exception:
                            pass

                    # Fallback to P/S if P/E not available
                    if _hv_pe_series is None and _hv_ps is not None and _hv_ps > 0:
                        # Approximate P/S over time using current P/S as ratio anchor
                        _hv_current_price = _hv_prices.iloc[-1] if len(_hv_prices) > 0 else 1
                        _hv_sps = _hv_current_price / _hv_ps if _hv_ps > 0 else 1  # sales per share
                        if _hv_sps > 0:
                            _hv_pe_series = _hv_prices / _hv_sps
                            _hv_label = "P/S"

                    if _hv_pe_series is not None and len(_hv_pe_series) > 10:
                        # Filter out extreme values
                        _hv_pe_clean = _hv_pe_series.replace([np.inf, -np.inf], np.nan).dropna()
                        _hv_pe_clean = _hv_pe_clean[(_hv_pe_clean > 0) & (_hv_pe_clean < _hv_pe_clean.quantile(0.98))]

                        if len(_hv_pe_clean) > 10:
                            _hv_mean = _hv_pe_clean.mean()
                            _hv_std = _hv_pe_clean.std()

                            fig_hv = go.Figure()

                            # Â±1 std band
                            fig_hv.add_trace(go.Scatter(
                                x=list(_hv_pe_clean.index) + list(_hv_pe_clean.index[::-1]),
                                y=[_hv_mean + _hv_std] * len(_hv_pe_clean) + [_hv_mean - _hv_std] * len(_hv_pe_clean),
                                fill="toself", fillcolor="rgba(37,99,235,0.1)",
                                line=dict(width=0), showlegend=True, name="Â±1Ïƒ Band",
                            ))

                            # Mean line
                            fig_hv.add_trace(go.Scatter(
                                x=_hv_pe_clean.index, y=[_hv_mean] * len(_hv_pe_clean),
                                mode="lines", line=dict(color="#F5A623", dash="dash", width=1.5),
                                name=f"Mean ({_hv_mean:.1f}x)",
                            ))

                            # Actual P/E line
                            fig_hv.add_trace(go.Scatter(
                                x=_hv_pe_clean.index, y=_hv_pe_clean.values,
                                mode="lines", line=dict(color="#2563EB", width=2),
                                name=f"Trailing {_hv_label}",
                            ))

                            fig_hv.update_layout(
                                **_CHART_LAYOUT_BASE, height=350,
                                margin=dict(t=30, b=40, l=50, r=30),
                                yaxis=dict(title=dict(text=f"{_hv_label} Ratio", font=dict(size=11, color="#9CA3AF")),
                                          tickfont=dict(size=10, color="#9CA3AF")),
                                xaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
                                legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1,
                                           font=dict(size=9, color="#9CA3AF")),
                            )
                            _apply_space_grid(fig_hv)
                            st.plotly_chart(fig_hv, use_container_width=True, key="hist_valuation_chart")

                            # Summary stats
                            _hv_current = _hv_pe_clean.iloc[-1] if len(_hv_pe_clean) > 0 else 0
                            _hv_pctile = ((_hv_pe_clean < _hv_current).sum() / len(_hv_pe_clean)) * 100
                            _hv_status = "EXPENSIVE" if _hv_current > _hv_mean + _hv_std else "CHEAP" if _hv_current < _hv_mean - _hv_std else "FAIR"
                            _hv_scolor = "#EF4444" if _hv_status == "EXPENSIVE" else "#10B981" if _hv_status == "CHEAP" else "#F5A623"
                            _hvc1, _hvc2, _hvc3, _hvc4 = st.columns(4)
                            _hvc1.metric(f"Current {_hv_label}", f"{_hv_current:.1f}x")
                            _hvc2.metric(f"Mean {_hv_label}", f"{_hv_mean:.1f}x")
                            _hvc3.metric("Percentile", f"{_hv_pctile:.0f}th")
                            _hvc4.markdown(
                                f'<div style="text-align:center; padding:0.5rem;">'
                                f'<div style="font-size:0.7rem; color:#9CA3AF;">Valuation</div>'
                                f'<div style="font-size:1.2rem; font-weight:800; color:{_hv_scolor};">{_hv_status}</div></div>',
                                unsafe_allow_html=True,
                            )
                    else:
                        st.info(f"Insufficient data for historical {_hv_label if '_hv_label' in dir() else 'valuation'} chart.")
                else:
                    st.info("Price history data not in expected format.")
            else:
                st.info("Insufficient price history for historical valuation analysis (need 30+ data points).")
        except Exception as _hv_e:
            st.info(f"Historical valuation analysis unavailable: {str(_hv_e)[:80]}")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2b. AT A GLANCE CARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    glance_signals = []
    
    # Analyst rating â€” derive from recommendations_summary if no direct attribute
    rec = getattr(cd, 'analyst_recommendation', None) or getattr(cd, 'recommendation_key', None)
    if not rec and cd.recommendations_summary is not None and not cd.recommendations_summary.empty:
        try:
            row = cd.recommendations_summary.iloc[0]
            cats = {"strongBuy": 5, "buy": 4, "hold": 3, "sell": 2, "strongSell": 1}
            def _get_rec_val(row, k):
                try:
                    v = row.get(k, 0) if hasattr(row, 'get') else row[k] if k in row.index else 0
                    return int(v) if pd.notna(v) else 0
                except Exception:
                    return 0
            weighted = sum(_get_rec_val(row, k) * v for k, v in cats.items())
            total = sum(_get_rec_val(row, k) for k in cats)
            if total > 0:
                avg = weighted / total
                if avg >= 4.5: rec = "strong_buy"
                elif avg >= 3.5: rec = "buy"
                elif avg >= 2.5: rec = "hold"
                elif avg >= 1.5: rec = "sell"
                else: rec = "strong_sell"
        except Exception:
            pass
    rec_str = rec.replace("_", " ").title() if rec else "N/A"
    rec_color = "#10B981" if rec and "buy" in rec.lower() else "#EF4444" if rec and "sell" in rec.lower() else "#F59E0B"
    
    # Quick valuation check
    pe_status = "N/A"
    pe_color = "#9CA3AF"
    if cd.trailing_pe and cd.trailing_pe > 0:
        if cd.trailing_pe < 15:
            pe_status = "Undervalued"
            pe_color = "#10B981"
        elif cd.trailing_pe < 25:
            pe_status = "Fair Value"
            pe_color = "#F59E0B"
        else:
            pe_status = "Premium"
            pe_color = "#10B981"
    
    # Momentum
    mom_str = "N/A"
    mom_color = "#9CA3AF"
    if _cd_price_change_pct:
        if _cd_price_change_pct > 2:
            mom_str = "Strong Bullish"
            mom_color = "#10B981"
        elif _cd_price_change_pct > 0:
            mom_str = "Bullish"
            mom_color = "#34D399"
        elif _cd_price_change_pct > -2:
            mom_str = "Bearish"
            mom_color = "#F97316"
        else:
            mom_str = "Strong Bearish"
            mom_color = "#EF4444"
    
    st.markdown(
        f'<div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:0.8rem; margin:1rem 0;">'
        f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.1); '
        f'border-radius:12px; padding:0.8rem; text-align:center;">'
        f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase; letter-spacing:1px;">Analyst Rating</div>'
        f'<div style="font-size:1rem; font-weight:800; color:{rec_color}; margin-top:0.2rem;">{rec_str}</div>'
        f'</div>'
        f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.1); '
        f'border-radius:12px; padding:0.8rem; text-align:center;">'
        f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase; letter-spacing:1px;">Valuation</div>'
        f'<div style="font-size:1rem; font-weight:800; color:{pe_color}; margin-top:0.2rem;">{pe_status}</div>'
        f'<div style="font-size:0.6rem; color:#9CA3AF;">P/E: {cd.trailing_pe:.1f}x</div>'
        f'</div>' if cd.trailing_pe else
        f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.1); '
        f'border-radius:12px; padding:0.8rem; text-align:center;">'
        f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Valuation</div>'
        f'<div style="font-size:1rem; font-weight:800; color:#9CA3AF; margin-top:0.2rem;">N/A</div></div>'
        f''
        f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.1); '
        f'border-radius:12px; padding:0.8rem; text-align:center;">'
        f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase; letter-spacing:1px;">Today\'s Momentum</div>'
        f'<div style="font-size:1rem; font-weight:800; color:{mom_color}; margin-top:0.2rem;">{mom_str}</div>'
        f'</div>'
        f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.1); '
        f'border-radius:12px; padding:0.8rem; text-align:center;">'
        f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase; letter-spacing:1px;">Sector</div>'
        f'<div style="font-size:0.85rem; font-weight:700; color:#2563EB; margin-top:0.2rem;">{cd.sector or "N/A"}</div>'
        f'</div>'
        f'</div>',
        unsafe_allow_html=True,
    )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2b-iii. SECTOR BENCHMARK COMPARISON
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _sector_bench = get_sector_benchmarks(cd.sector) if cd.sector else None
    if _sector_bench:
        with _safe_section("Sector Benchmark Comparison"):
            _sb_rows = []
            # P/E
            _sb_pe = cd.trailing_pe
            _sb_b = _sector_bench["pe"]
            if _sb_pe and _sb_pe > 0:
                _sb_pos = "Below" if _sb_pe < _sb_b["low"] else "Above" if _sb_pe > _sb_b["high"] else "In Range"
                _sb_color = "#10B981" if _sb_pe <= _sb_b["median"] else "#F59E0B" if _sb_pe <= _sb_b["high"] else "#EF4444"
                _sb_rows.append(("P/E Ratio", f"{_sb_pe:.1f}x", f'{_sb_b["low"]:.0f}x â€“ {_sb_b["median"]:.0f}x â€“ {_sb_b["high"]:.0f}x', _sb_pos, _sb_color))

            # EV/EBITDA
            _sb_eve = cd.ev_to_ebitda
            _sb_b2 = _sector_bench["ev_ebitda"]
            if _sb_eve and _sb_eve > 0:
                _sb_pos2 = "Below" if _sb_eve < _sb_b2["low"] else "Above" if _sb_eve > _sb_b2["high"] else "In Range"
                _sb_color2 = "#10B981" if _sb_eve <= _sb_b2["median"] else "#F59E0B" if _sb_eve <= _sb_b2["high"] else "#EF4444"
                _sb_rows.append(("EV/EBITDA", f"{_sb_eve:.1f}x", f'{_sb_b2["low"]:.0f}x â€“ {_sb_b2["median"]:.0f}x â€“ {_sb_b2["high"]:.0f}x', _sb_pos2, _sb_color2))

            # Gross Margin
            _sb_gm = cd.gross_margins
            _sb_b3 = _sector_bench["gross_margin"]
            if _sb_gm is not None:
                _sb_gm_pct = _sb_gm if _sb_gm > 1 else _sb_gm * 100
                _sb_pos3 = "Below" if _sb_gm < _sb_b3["low"] else "Above" if _sb_gm > _sb_b3["high"] else "In Range"
                _sb_color3 = "#EF4444" if _sb_gm < _sb_b3["low"] else "#10B981" if _sb_gm >= _sb_b3["median"] else "#F59E0B"
                _sb_rows.append(("Gross Margin", f"{_sb_gm_pct:.1f}%", f'{_sb_b3["low"]*100:.0f}% â€“ {_sb_b3["median"]*100:.0f}% â€“ {_sb_b3["high"]*100:.0f}%', _sb_pos3, _sb_color3))

            # Revenue Growth
            _sb_rg = cd.revenue_growth
            _sb_b4 = _sector_bench["revenue_growth"]
            if _sb_rg is not None:
                _sb_rg_dec = _sb_rg / 100 if abs(_sb_rg) > 5 else _sb_rg  # normalize
                _sb_rg_pct = _sb_rg if abs(_sb_rg) > 5 else _sb_rg * 100
                _sb_pos4 = "Below" if _sb_rg_dec < _sb_b4["low"] else "Above" if _sb_rg_dec > _sb_b4["high"] else "In Range"
                _sb_color4 = "#EF4444" if _sb_rg_dec < _sb_b4["low"] else "#10B981" if _sb_rg_dec >= _sb_b4["median"] else "#F59E0B"
                _sb_rows.append(("Revenue Growth", f"{_sb_rg_pct:.1f}%", f'{_sb_b4["low"]*100:.0f}% â€“ {_sb_b4["median"]*100:.0f}% â€“ {_sb_b4["high"]*100:.0f}%', _sb_pos4, _sb_color4))

            # Debt/Equity
            _sb_de = cd.debt_to_equity
            _sb_b5 = _sector_bench["debt_equity"]
            if _sb_de is not None:
                _sb_de_val = _sb_de / 100 if _sb_de > 10 else _sb_de  # yfinance returns as percentage sometimes
                _sb_pos5 = "Below" if _sb_de_val < _sb_b5["low"] else "Above" if _sb_de_val > _sb_b5["high"] else "In Range"
                _sb_color5 = "#10B981" if _sb_de_val <= _sb_b5["median"] else "#F59E0B" if _sb_de_val <= _sb_b5["high"] else "#EF4444"
                _sb_rows.append(("Debt/Equity", f"{_sb_de_val:.2f}x", f'{_sb_b5["low"]:.1f}x â€“ {_sb_b5["median"]:.1f}x â€“ {_sb_b5["high"]:.1f}x', _sb_pos5, _sb_color5))

            if _sb_rows:
                _sb_table = (
                    '<table style="width:100%; border-collapse:collapse; font-size:0.78rem;">'
                    '<tr style="border-bottom:1px solid rgba(37,99,235,0.2);">'
                    '<th style="text-align:left; padding:0.4rem; color:#60A5FA; font-weight:700;">Metric</th>'
                    '<th style="text-align:center; padding:0.4rem; color:#60A5FA; font-weight:700;">Company</th>'
                    '<th style="text-align:center; padding:0.4rem; color:#60A5FA; font-weight:700;">Sector (Lowâ€“Medâ€“High)</th>'
                    '<th style="text-align:center; padding:0.4rem; color:#60A5FA; font-weight:700;">Position</th>'
                    '</tr>'
                )
                for metric, company_val, sector_range, position, color in _sb_rows:
                    _sb_table += (
                        f'<tr style="border-bottom:1px solid rgba(255,255,255,0.03);">'
                        f'<td style="padding:0.4rem; color:#F9FAFB;">{metric}</td>'
                        f'<td style="padding:0.4rem; text-align:center; color:#F9FAFB; font-weight:700;">{company_val}</td>'
                        f'<td style="padding:0.4rem; text-align:center; color:#9CA3AF;">{sector_range}</td>'
                        f'<td style="padding:0.4rem; text-align:center; color:{color}; font-weight:700;">{position}</td>'
                        f'</tr>'
                    )
                _sb_table += '</table>'

                st.markdown(
                    f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
                    f'border-radius:12px; padding:1rem 1.2rem; margin:0.8rem 0;">'
                    f'<div style="font-size:0.7rem; font-weight:800; color:#60A5FA; text-transform:uppercase; '
                    f'letter-spacing:2px; margin-bottom:0.6rem;">ğŸ“Š Sector Benchmark Comparison â€” {cd.sector}</div>'
                    f'{_sb_table}'
                    f'</div>',
                    unsafe_allow_html=True,
                )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2b-iv. HISTORICAL VALUATION TRENDS (5Y)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Historical Valuation Trends"):
        _section("Historical Valuation Trends (5Y)", "ğŸ“‰")
        try:
            _hvt_tk = yf.Ticker(cd.ticker)
            _hvt_hist = _hvt_tk.history(period="5y")

            if _hvt_hist is not None and len(_hvt_hist) > 60:
                # Get quarterly financials for computing trailing multiples
                _hvt_qe = _hvt_tk.quarterly_earnings
                _hvt_qf = _hvt_tk.quarterly_financials if hasattr(_hvt_tk, 'quarterly_financials') else None
                _hvt_qi = _hvt_tk.quarterly_income_stmt if hasattr(_hvt_tk, 'quarterly_income_stmt') else None

                _hvt_close = _hvt_hist['Close']
                _hvt_shares = cd.shares_outstanding or _hvt_tk.info.get("sharesOutstanding", 1)

                # Compute trailing P/E series (using current TTM EPS as approximation scaled by price)
                _hvt_pe_series = None
                _hvt_ps_series = None
                _hvt_ev_ebitda_series = None

                _hvt_current_pe = cd.trailing_pe
                _hvt_current_ps = cd.price_to_sales
                _hvt_current_ev_ebitda = cd.ev_to_ebitda
                _hvt_current_price = cd.current_price or _hvt_close.iloc[-1]

                # Approximate historical multiples by scaling current multiple with price ratio
                # P/E(t) â‰ˆ P/E(now) * [Price(t) / Price(now)] â€” assumes roughly stable earnings over short periods
                # More accurate: use quarterly earnings to compute rolling TTM EPS
                if _hvt_current_pe and _hvt_current_pe > 0 and _hvt_current_price > 0:
                    # Try to use quarterly earnings for real P/E computation
                    _hvt_pe_computed = False
                    if _hvt_qe is not None and hasattr(_hvt_qe, 'columns'):
                        try:
                            _eps_col = 'Earnings' if 'Earnings' in _hvt_qe.columns else _hvt_qe.columns[0]
                            _eps_series = _hvt_qe[_eps_col].sort_index()
                            if len(_eps_series) >= 4:
                                _ttm_eps = _eps_series.rolling(4).sum().dropna()
                                if len(_ttm_eps) > 0:
                                    _latest_ttm_eps = float(_ttm_eps.iloc[-1])
                                    if _latest_ttm_eps > 0:
                                        _hvt_pe_series = _hvt_close / _latest_ttm_eps
                                        _hvt_pe_series = _hvt_pe_series[(_hvt_pe_series > 0) & (_hvt_pe_series < _hvt_pe_series.quantile(0.98))]
                                        _hvt_pe_computed = True
                        except Exception:
                            pass
                    if not _hvt_pe_computed:
                        _hvt_eps_now = _hvt_current_price / _hvt_current_pe
                        if _hvt_eps_now > 0:
                            _hvt_pe_series = _hvt_close / _hvt_eps_now
                            _hvt_pe_series = _hvt_pe_series[(_hvt_pe_series > 0) & (_hvt_pe_series < _hvt_pe_series.quantile(0.98))]

                if _hvt_current_ps and _hvt_current_ps > 0 and _hvt_current_price > 0:
                    _hvt_sps = _hvt_current_price / _hvt_current_ps
                    if _hvt_sps > 0:
                        _hvt_ps_series = _hvt_close / _hvt_sps
                        _hvt_ps_series = _hvt_ps_series[(_hvt_ps_series > 0) & (_hvt_ps_series < _hvt_ps_series.quantile(0.98))]

                if _hvt_current_ev_ebitda and _hvt_current_ev_ebitda > 0 and _hvt_current_price > 0:
                    # Approximate EV/EBITDA using EV â‰ˆ MCap (simplified) scaled by price
                    _hvt_ebitda_implied = (_hvt_current_price * _hvt_shares) / _hvt_current_ev_ebitda if _hvt_shares else None
                    if _hvt_ebitda_implied and _hvt_ebitda_implied > 0:
                        _hvt_ev_ebitda_series = (_hvt_close * _hvt_shares) / _hvt_ebitda_implied
                        _hvt_ev_ebitda_series = _hvt_ev_ebitda_series[(_hvt_ev_ebitda_series > 0) & (_hvt_ev_ebitda_series < _hvt_ev_ebitda_series.quantile(0.98))]

                # Build multi-line chart
                _hvt_fig = go.Figure()
                _hvt_has_data = False

                if _hvt_pe_series is not None and len(_hvt_pe_series) > 10:
                    _hvt_fig.add_trace(go.Scatter(x=_hvt_pe_series.index, y=_hvt_pe_series.values, name="P/E (TTM)", line=dict(color="#2563EB", width=2)))
                    if _hvt_current_pe:
                        _hvt_fig.add_trace(go.Scatter(x=[_hvt_pe_series.index[-1]], y=[_hvt_current_pe], name=f"Current P/E: {_hvt_current_pe:.1f}x", mode="markers", marker=dict(color="#2563EB", size=10, symbol="diamond")))
                    _hvt_has_data = True

                if _hvt_ev_ebitda_series is not None and len(_hvt_ev_ebitda_series) > 10:
                    _hvt_fig.add_trace(go.Scatter(x=_hvt_ev_ebitda_series.index, y=_hvt_ev_ebitda_series.values, name="EV/EBITDA", line=dict(color="#10B981", width=2)))
                    if _hvt_current_ev_ebitda:
                        _hvt_fig.add_trace(go.Scatter(x=[_hvt_ev_ebitda_series.index[-1]], y=[_hvt_current_ev_ebitda], name=f"Current EV/EBITDA: {_hvt_current_ev_ebitda:.1f}x", mode="markers", marker=dict(color="#10B981", size=10, symbol="diamond")))
                    _hvt_has_data = True

                if _hvt_ps_series is not None and len(_hvt_ps_series) > 10:
                    _hvt_fig.add_trace(go.Scatter(x=_hvt_ps_series.index, y=_hvt_ps_series.values, name="P/S (TTM)", line=dict(color="#10B981", width=2)))
                    if _hvt_current_ps:
                        _hvt_fig.add_trace(go.Scatter(x=[_hvt_ps_series.index[-1]], y=[_hvt_current_ps], name=f"Current P/S: {_hvt_current_ps:.1f}x", mode="markers", marker=dict(color="#10B981", size=10, symbol="diamond")))
                    _hvt_has_data = True

                if _hvt_has_data:
                    _hvt_fig.update_layout(
                        **_CHART_LAYOUT_BASE, height=380,
                        title=dict(text="Trailing 5Y Valuation Multiples", font=dict(size=12, color="#D1D5DB")),
                        yaxis=dict(title=dict(text="Multiple (x)", font=dict(size=10, color="#9CA3AF")), ticksuffix="x", tickfont=dict(size=9, color="#9CA3AF")),
                        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                        legend=dict(font=dict(size=9, color="#9CA3AF"), orientation="h", yanchor="bottom", y=-0.25, xanchor="center", x=0.5),
                    )
                    _apply_space_grid(_hvt_fig)
                    st.plotly_chart(_hvt_fig, use_container_width=True, key="hvt_5y_chart")

                    # â”€â”€ Valuation Percentile â”€â”€
                    _hvt_pctiles = []
                    if _hvt_pe_series is not None and len(_hvt_pe_series) > 10 and _hvt_current_pe:
                        _pct = ((_hvt_pe_series < _hvt_current_pe).sum() / len(_hvt_pe_series)) * 100
                        _hvt_pctiles.append(("P/E", _hvt_current_pe, _pct, "#2563EB"))
                    if _hvt_ev_ebitda_series is not None and len(_hvt_ev_ebitda_series) > 10 and _hvt_current_ev_ebitda:
                        _pct = ((_hvt_ev_ebitda_series < _hvt_current_ev_ebitda).sum() / len(_hvt_ev_ebitda_series)) * 100
                        _hvt_pctiles.append(("EV/EBITDA", _hvt_current_ev_ebitda, _pct, "#10B981"))
                    if _hvt_ps_series is not None and len(_hvt_ps_series) > 10 and _hvt_current_ps:
                        _pct = ((_hvt_ps_series < _hvt_current_ps).sum() / len(_hvt_ps_series)) * 100
                        _hvt_pctiles.append(("P/S", _hvt_current_ps, _pct, "#10B981"))

                    if _hvt_pctiles:
                        st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; margin:0.8rem 0 0.5rem 0;">ğŸ“Š Valuation Percentile (vs Own 5Y History)</div>', unsafe_allow_html=True)
                        _pct_cols = st.columns(len(_hvt_pctiles))
                        for _pi, (_p_label, _p_val, _p_pct, _p_color) in enumerate(_hvt_pctiles):
                            _p_interp = "Cheap" if _p_pct < 25 else "Below Avg" if _p_pct < 40 else "Fair" if _p_pct < 60 else "Above Avg" if _p_pct < 75 else "Expensive"
                            _p_interp_color = "#10B981" if _p_pct < 30 else "#F5A623" if _p_pct < 70 else "#EF4444"
                            with _pct_cols[_pi]:
                                st.markdown(
                                    f'<div style="background:rgba(255,255,255,0.03); border:1px solid {_p_color}33; border-radius:12px; padding:0.8rem; text-align:center;">'
                                    f'<div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">{_p_label}</div>'
                                    f'<div style="font-size:1.3rem; font-weight:800; color:#F9FAFB;">{_p_val:.1f}x</div>'
                                    f'<div style="margin:0.4rem 0; height:6px; background:rgba(255,255,255,0.06); border-radius:3px; overflow:hidden;">'
                                    f'<div style="width:{_p_pct:.0f}%; height:100%; background:{_p_color}; border-radius:3px;"></div></div>'
                                    f'<div style="font-size:0.7rem; font-weight:700; color:{_p_interp_color};">{_p_pct:.0f}th percentile â€” {_p_interp}</div>'
                                    f'</div>',
                                    unsafe_allow_html=True,
                                )
                else:
                    st.info("Insufficient historical data for valuation trend chart.")
            else:
                st.info("Need at least 60 days of price history for valuation trends.")
        except Exception as _hvt_e:
            st.info(f"Historical valuation trends unavailable: {_hvt_e}")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2b-ii. EXECUTIVE SUMMARY (IB Pitch Book style)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Executive Summary"):
        _es_bullets = []

        # Valuation bullet: EV/EBITDA with sector benchmark context
        _es_ev = getattr(cd, 'enterprise_value', None) or 0
        _es_ebitda_s = getattr(cd, 'ebitda', None)
        _es_ebitda = None
        if _es_ebitda_s is not None:
            if hasattr(_es_ebitda_s, 'iloc'):
                _es_ebitda = float(_es_ebitda_s.iloc[0]) if len(_es_ebitda_s) > 0 else None
            else:
                try:
                    _es_ebitda = float(_es_ebitda_s)
                except (TypeError, ValueError):
                    _es_ebitda = None
        _es_ev_ebitda = (_es_ev / _es_ebitda) if _es_ebitda and _es_ebitda > 0 else None
        _es_peer_ev_ebitda = getattr(cd, 'peer_ev_ebitda_median', None)
        _es_sector_bench = get_sector_benchmarks(cd.sector) if cd.sector else None
        if _es_ev_ebitda is not None:
            _val_str = f"Trading at **{_es_ev_ebitda:.1f}x EV/EBITDA**"
            # Use sector benchmark median for context (preferred), fall back to peer median
            _es_bench_median = _es_sector_bench["ev_ebitda"]["median"] if _es_sector_bench else None
            if _es_bench_median:
                _pct_diff = (_es_ev_ebitda / _es_bench_median - 1) * 100
                _val_tag = "discount to sector" if _pct_diff < -15 else "premium to sector" if _pct_diff > 15 else "in-line with sector"
                _val_str += f" vs sector median of {_es_bench_median:.1f}x ({_val_tag})"
            elif _es_peer_ev_ebitda and _es_peer_ev_ebitda > 0:
                _pct_diff = (_es_ev_ebitda / _es_peer_ev_ebitda - 1) * 100
                _val_tag = "cheap" if _pct_diff < -15 else "rich" if _pct_diff > 15 else "in-line"
                _val_str += f" vs peer median of {_es_peer_ev_ebitda:.1f}x ({_val_tag})"
            _es_bullets.append(("ğŸ“Š", _val_str))
        elif cd.trailing_pe and cd.trailing_pe > 0:
            _pe_str = f"Trading at **{cd.trailing_pe:.1f}x P/E**"
            _es_pe_bench = _es_sector_bench["pe"]["median"] if _es_sector_bench else None
            if _es_pe_bench:
                _pe_diff = (cd.trailing_pe / _es_pe_bench - 1) * 100
                _pe_tag = "discount to sector" if _pe_diff < -15 else "premium to sector" if _pe_diff > 15 else "in-line with sector"
                _pe_str += f" vs sector median of {_es_pe_bench:.0f}x ({_pe_tag})"
            _es_bullets.append(("ğŸ“Š", _pe_str))

        # Growth bullet
        _es_rg = getattr(cd, 'revenue_growth', None)
        if _es_rg is not None:
            _rg_pct = _es_rg * 100 if abs(_es_rg) < 5 else _es_rg
            _es_bullets.append(("ğŸ“ˆ", f"Revenue growing at **{_rg_pct:.1f}%** YoY"))

        # Profitability bullet
        _es_pm = getattr(cd, 'profit_margins', None)
        _es_om = getattr(cd, 'operating_margins', None)
        if _es_pm is not None:
            _pm_pct = _es_pm * 100 if abs(_es_pm) < 5 else _es_pm
            _pm_qual = "above peers" if _pm_pct > 15 else "below peers" if _pm_pct < 5 else "moderate"
            _es_bullets.append(("ğŸ’°", f"Net margins **{_pm_pct:.1f}%** ({_pm_qual})"))
        elif _es_om is not None:
            _om_pct = _es_om * 100 if abs(_es_om) < 5 else _es_om
            _es_bullets.append(("ğŸ’°", f"Operating margins **{_om_pct:.1f}%**"))

        # Balance sheet bullet
        _es_nd = None
        _es_td_s = getattr(cd, 'total_debt', None)
        _es_cash_s = getattr(cd, 'cash_and_equivalents', None)
        _es_td_v = _safe_val(_es_td_s) if callable(_safe_val) else None
        try:
            _es_td_v = float(_es_td_s.iloc[0]) if hasattr(_es_td_s, 'iloc') and len(_es_td_s) > 0 else (float(_es_td_s) if _es_td_s is not None else None)
        except Exception:
            _es_td_v = None
        try:
            _es_cash_v = float(_es_cash_s.iloc[0]) if hasattr(_es_cash_s, 'iloc') and len(_es_cash_s) > 0 else (float(_es_cash_s) if _es_cash_s is not None else None)
        except Exception:
            _es_cash_v = None
        if _es_td_v is not None and _es_cash_v is not None and _es_ebitda and _es_ebitda > 0:
            _es_nd = (_es_td_v - _es_cash_v) / _es_ebitda
            _cr_val = getattr(cd, 'current_ratio', None)
            _bs_str = f"Net debt/EBITDA of **{_es_nd:.1f}x**"
            if _cr_val:
                _bs_str += f", current ratio **{_cr_val:.1f}x**"
            _es_bullets.append(("ğŸ¦", _bs_str))

        if _es_bullets:
            _es_html = "".join(
                f'<div style="padding:0.35rem 0; font-size:0.85rem; color:#F9FAFB; line-height:1.7;">'
                f'{icon} {text}</div>'
                for icon, text in _es_bullets
            )
            st.markdown(
                f'<div style="background:linear-gradient(135deg, rgba(37,99,235,0.08), rgba(16,185,129,0.06)); '
                f'border:2px solid rgba(37,99,235,0.35); '
                f'border-radius:12px; padding:1.2rem 1.5rem; margin:1rem 0; '
                f'box-shadow:0 0 0 1px rgba(16,185,129,0.15);">'
                f'<div style="font-size:0.7rem; font-weight:800; color:#60A5FA; text-transform:uppercase; '
                f'letter-spacing:2px; margin-bottom:0.6rem;">Executive Summary</div>'
                f'{_es_html}'
                f'</div>',
                unsafe_allow_html=True,
            )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2c. KEY TAKEAWAYS (auto-generated)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    try:
        takeaways = []
        
        # Market cap context
        if cd.market_cap:
            if cd.market_cap >= 200e9:
                takeaways.append(f"**Mega-cap** company (${cd.market_cap/1e12:.1f}T) in {cd.sector}")
            elif cd.market_cap >= 10e9:
                takeaways.append(f"**Large-cap** company (${cd.market_cap/1e9:.0f}B) in {cd.sector}")
            elif cd.market_cap >= 2e9:
                takeaways.append(f"**Mid-cap** company (${cd.market_cap/1e9:.1f}B) in {cd.sector}")
            else:
                takeaways.append(f"**Small-cap** company (${cd.market_cap/1e9:.1f}B) in {cd.sector}")
        
        # Valuation
        if cd.trailing_pe and cd.trailing_pe > 0:
            if cd.trailing_pe > 30:
                takeaways.append(f"Trading at a **premium valuation** ({cd.trailing_pe:.0f}x P/E)")
            elif cd.trailing_pe < 15:
                takeaways.append(f"Trading at an **attractive valuation** ({cd.trailing_pe:.0f}x P/E)")
        
        # Growth
        if cd.revenue_growth:
            if cd.revenue_growth > 20:
                takeaways.append(f"**High-growth** â€” revenue up {cd.revenue_growth:.0f}% YoY")
            elif cd.revenue_growth > 0:
                takeaways.append(f"Revenue growing at {cd.revenue_growth:.0f}% YoY")
            else:
                takeaways.append(f"Revenue declined {cd.revenue_growth:.0f}% YoY")
        
        # Profitability
        if cd.profit_margins:
            pm = cd.profit_margins * 100
            if pm > 20:
                takeaways.append(f"**Highly profitable** â€” {pm:.0f}% net margin")
            elif pm > 0:
                takeaways.append(f"Profitable with {pm:.0f}% net margin")
            else:
                takeaways.append(f"Currently unprofitable ({pm:.0f}% net margin)")
        
        # Analyst
        if rec:
            takeaways.append(f"Analyst consensus: **{rec_str}**")
        
        if takeaways:
            bullets = "".join(f'<div style="padding:0.2rem 0; font-size:0.82rem; color:#D1D5DB; line-height:1.6;">â€¢ {t}</div>' for t in takeaways[:4])
            st.markdown(
                f'<div style="background:rgba(37,99,235,0.04); border:1px solid rgba(37,99,235,0.12); '
                f'border-radius:12px; padding:1rem 1.2rem; margin:0.5rem 0 1rem 0;">'
                f'<div style="font-size:0.65rem; font-weight:700; color:#2563EB; text-transform:uppercase; '
                f'letter-spacing:1.5px; margin-bottom:0.4rem;">Key Takeaways</div>'
                f'{bullets}'
                f'</div>',
                unsafe_allow_html=True,
            )
    except Exception:
        pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ° ECONOMIC MOAT ASSESSMENT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Economic Moat Assessment"):
        try:
            # â”€â”€ Calculate 5 moat dimensions (0-100 each) â”€â”€
            _moat_scores = {}
            _moat_details = {}

            # 1) Pricing Power: gross margin stability & level
            _pp_score = 0
            _pp_detail = "Insufficient margin data"
            if cd.gross_margin_series is not None and len(cd.gross_margin_series) >= 2:
                _gm_vals = [v for v in cd.gross_margin_series.values if v is not None and not (isinstance(v, float) and v != v)]
                if _gm_vals:
                    _gm_avg = sum(_gm_vals) / len(_gm_vals)
                    _gm_std = (sum((v - _gm_avg)**2 for v in _gm_vals) / len(_gm_vals)) ** 0.5
                    _gm_stability = max(0, 1 - _gm_std * 10)  # Low std = high stability
                    _gm_level = min(1, _gm_avg)  # Higher margin = better
                    _pp_score = int(min(100, (_gm_level * 60 + _gm_stability * 40)))
                    _pp_detail = f"Avg gross margin {_gm_avg*100:.1f}% with {'stable' if _gm_std < 0.03 else 'variable'} trend"
            elif cd.gross_margins is not None:
                _gm_single = cd.gross_margins
                _pp_score = int(min(100, max(0, _gm_single * 100)))
                _pp_detail = f"Current gross margin {_gm_single*100:.1f}%"
            _moat_scores["Pricing Power"] = _pp_score
            _moat_details["Pricing Power"] = _pp_detail

            # 2) Switching Costs: revenue growth consistency (proxy for retention)
            _sc_score = 0
            _sc_detail = "Insufficient revenue data"
            if cd.revenue is not None and len(cd.revenue) >= 3:
                _rev_vals = [float(v) for v in cd.revenue.values if v is not None and float(v) > 0]
                if len(_rev_vals) >= 3:
                    _rev_growths = [(_rev_vals[i] / _rev_vals[i+1] - 1) for i in range(len(_rev_vals)-1)]
                    _pos_growth = sum(1 for g in _rev_growths if g > 0) / len(_rev_growths)
                    _avg_growth = sum(_rev_growths) / len(_rev_growths)
                    _sc_score = int(min(100, max(0, _pos_growth * 50 + min(1, max(0, _avg_growth * 5)) * 50)))
                    # Boost for industries with inherently high switching costs
                    _high_switch_industries = ["software", "saas", "cloud", "banking", "insurance", "enterprise"]
                    if any(kw in (cd.industry or "").lower() for kw in _high_switch_industries):
                        _sc_score = min(100, _sc_score + 15)
                    _sc_detail = f"{'Consistent' if _pos_growth > 0.7 else 'Mixed'} revenue growth ({_avg_growth*100:.1f}% avg)"
            _moat_scores["Switching Costs"] = _sc_score
            _moat_details["Switching Costs"] = _sc_detail

            # 3) Scale Advantage: market cap vs industry, size
            _sa_score = 0
            _sa_detail = "No market cap data"
            if cd.market_cap and cd.market_cap > 0:
                if cd.market_cap >= 200e9:
                    _sa_score = 90
                    _sa_detail = "Mega-cap with dominant scale"
                elif cd.market_cap >= 50e9:
                    _sa_score = 70
                    _sa_detail = "Large-cap with significant scale advantages"
                elif cd.market_cap >= 10e9:
                    _sa_score = 50
                    _sa_detail = "Mid-to-large cap with moderate scale"
                elif cd.market_cap >= 2e9:
                    _sa_score = 30
                    _sa_detail = "Mid-cap with limited scale advantages"
                else:
                    _sa_score = 15
                    _sa_detail = "Small-cap, minimal scale advantage"
                # Boost if significantly larger than peers
                if cd.peer_data:
                    _peer_mcaps = [p.get("market_cap", 0) for p in cd.peer_data if p.get("market_cap", 0) > 0]
                    if _peer_mcaps:
                        _peer_median = sorted(_peer_mcaps)[len(_peer_mcaps)//2]
                        if cd.market_cap > _peer_median * 3:
                            _sa_score = min(100, _sa_score + 15)
                            _sa_detail += " â€” dominant vs peers"
            _moat_scores["Scale Advantage"] = _sa_score
            _moat_details["Scale Advantage"] = _sa_detail

            # 4) Intangible Assets: R&D intensity + brand proxy (profit margins)
            _ia_score = 0
            _ia_detail = "Limited intangible asset signals"
            _ia_rd_pct = None
            if cd.income_stmt is not None:
                try:
                    _rd_row = None
                    for _rd_label in ["ResearchAndDevelopment", "Research And Development", "ResearchDevelopment"]:
                        if _rd_label in cd.income_stmt.index:
                            _rd_row = cd.income_stmt.loc[_rd_label]
                            break
                    if _rd_row is not None and cd.revenue is not None and len(cd.revenue) > 0:
                        _rd_val = float(_rd_row.iloc[0]) if len(_rd_row) > 0 else 0
                        _rev_val = float(cd.revenue.iloc[0])
                        if _rev_val > 0 and _rd_val > 0:
                            _ia_rd_pct = _rd_val / _rev_val
                except Exception:
                    pass
            _pm_score = 0
            if cd.profit_margins is not None and cd.profit_margins > 0:
                _pm_score = min(50, int(cd.profit_margins * 200))  # 25% margin = 50 pts
            _rd_score = 0
            if _ia_rd_pct is not None:
                _rd_score = min(50, int(_ia_rd_pct * 300))  # ~17% R&D = 50 pts
                _ia_detail = f"R&D at {_ia_rd_pct*100:.1f}% of revenue"
            else:
                _ia_detail = "No R&D data available"
            if cd.profit_margins and cd.profit_margins > 0.15:
                _ia_detail += f"; strong brand proxy ({cd.profit_margins*100:.1f}% net margin)"
            _ia_score = min(100, _pm_score + _rd_score)
            _moat_scores["Intangible Assets"] = _ia_score
            _moat_details["Intangible Assets"] = _ia_detail

            # 5) Network Effects: industry-based scoring
            _ne_score = 10  # baseline
            _ne_detail = "No strong network effect signals"
            _ne_keywords = {
                "social": 40, "platform": 35, "marketplace": 35, "payment": 30,
                "exchange": 30, "network": 25, "advertising": 20, "media": 15,
                "software": 10, "internet": 20,
            }
            _ind_lower = (cd.industry or "").lower() + " " + (cd.sector or "").lower()
            for _ne_kw, _ne_boost in _ne_keywords.items():
                if _ne_kw in _ind_lower:
                    _ne_score = min(100, _ne_score + _ne_boost)
                    _ne_detail = f"Industry ({cd.industry}) has network effect characteristics"
            # Revenue growth as network effect proxy
            if cd.revenue_growth and cd.revenue_growth > 0.15:
                _ne_score = min(100, _ne_score + 10)
            _moat_scores["Network Effects"] = _ne_score
            _moat_details["Network Effects"] = _ne_detail

            # â”€â”€ Overall Moat Rating â”€â”€
            _moat_threshold = 50
            _strong_moats = sum(1 for s in _moat_scores.values() if s >= _moat_threshold)
            if _strong_moats >= 3:
                _moat_rating = "Wide"
                _moat_color = "#10B981"
                _moat_emoji = "ğŸ°ğŸ°ğŸ°"
                _moat_width = 90
            elif _strong_moats >= 1:
                _moat_rating = "Narrow"
                _moat_color = "#F59E0B"
                _moat_emoji = "ğŸ°ğŸ°"
                _moat_width = 55
            else:
                _moat_rating = "None"
                _moat_color = "#EF4444"
                _moat_emoji = "ğŸ°"
                _moat_width = 20

            # â”€â”€ Render â”€â”€
            with st.expander(f"ğŸ° Economic Moat Assessment â€” {_moat_rating} Moat", expanded=False):
                # Castle with moat width visual
                _moat_castle_html = (
                    f'<div style="text-align:center; margin:0.5rem 0 1rem 0;">'
                    f'<div style="font-size:2.5rem; margin-bottom:0.3rem;">ğŸ°</div>'
                    f'<div style="display:inline-block; width:80%; position:relative; height:18px; '
                    f'background:rgba(255,255,255,0.05); border-radius:10px; overflow:hidden;">'
                    f'<div style="width:{_moat_width}%; height:100%; border-radius:10px; '
                    f'background:linear-gradient(90deg, {_moat_color}44, {_moat_color}); '
                    f'transition:width 0.5s;"></div></div>'
                    f'<div style="font-size:0.9rem; font-weight:700; color:{_moat_color}; margin-top:0.4rem;">'
                    f'{_moat_emoji} {_moat_rating} Moat</div>'
                    f'<div style="font-size:0.68rem; color:#9CA3AF; margin-top:0.15rem;">'
                    f'{_strong_moats} of 5 moat dimensions above threshold</div>'
                    f'</div>'
                )
                st.markdown(_moat_castle_html, unsafe_allow_html=True)

                # Radar chart
                try:
                    _moat_cats = list(_moat_scores.keys())
                    _moat_vals = [_moat_scores[c] for c in _moat_cats]
                    _moat_cats_r = _moat_cats + [_moat_cats[0]]
                    _moat_vals_r = _moat_vals + [_moat_vals[0]]
                    _moat_fig = go.Figure()
                    _moat_fig.add_trace(go.Scatterpolar(
                        r=_moat_vals_r, theta=_moat_cats_r,
                        fill='toself',
                        fillcolor=f'{_moat_color}22',
                        line=dict(color=_moat_color, width=2),
                        marker=dict(size=6, color=_moat_color),
                        name="Moat Score",
                    ))
                    _moat_fig.update_layout(
                        **_CHART_LAYOUT_BASE, height=320,
                        margin=dict(t=30, b=30, l=60, r=60),
                        polar=dict(
                            bgcolor="rgba(0,0,0,0)",
                            radialaxis=dict(visible=True, range=[0, 100], showticklabels=True,
                                           tickfont=dict(size=8, color="#6B6B80"),
                                           gridcolor="rgba(255,255,255,0.06)"),
                            angularaxis=dict(tickfont=dict(size=10, color="#D1D5DB"),
                                            gridcolor="rgba(255,255,255,0.06)"),
                        ),
                        showlegend=False,
                    )
                    st.plotly_chart(_moat_fig, use_container_width=True, key="moat_radar")
                except Exception:
                    pass

                # Dimension details
                for _md_name, _md_score in _moat_scores.items():
                    _md_color = "#10B981" if _md_score >= 60 else "#F59E0B" if _md_score >= 40 else "#EF4444"
                    _md_bar_w = max(5, _md_score)
                    st.markdown(
                        f'<div style="display:flex; align-items:center; margin:0.3rem 0; gap:0.5rem;">'
                        f'<div style="width:120px; font-size:0.72rem; color:#D1D5DB; flex-shrink:0;">{_md_name}</div>'
                        f'<div style="flex:1; background:rgba(255,255,255,0.05); border-radius:6px; height:14px; overflow:hidden;">'
                        f'<div style="width:{_md_bar_w}%; height:100%; background:{_md_color}; border-radius:6px;"></div></div>'
                        f'<div style="width:35px; font-size:0.72rem; color:{_md_color}; font-weight:600; text-align:right;">{_md_score}</div>'
                        f'</div>'
                        f'<div style="font-size:0.65rem; color:#6B6B80; margin-left:120px; padding-left:0.5rem; margin-bottom:0.3rem;">'
                        f'{_moat_details[_md_name]}</div>',
                        unsafe_allow_html=True,
                    )
        except Exception:
            pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ¯ M&A TARGET SCREENING SCORE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("M&A Target Screening Score"):
        try:
            _ma_score = 0
            _ma_bull = []
            _ma_bear = []

            # 1) Recurring Revenue % estimate (0-20 pts)
            _ma_sector_lower = (cd.sector or "").lower()
            _ma_industry_lower = (cd.industry or "").lower()
            _ma_recurring_est = 0.3  # default
            if any(kw in _ma_industry_lower for kw in ["software", "saas", "cloud", "subscription"]):
                _ma_recurring_est = 0.85
            elif any(kw in _ma_industry_lower for kw in ["internet", "platform", "digital"]):
                _ma_recurring_est = 0.60
            elif "tech" in _ma_sector_lower:
                _ma_recurring_est = 0.45
            elif any(kw in _ma_industry_lower for kw in ["insurance", "utility", "telecom"]):
                _ma_recurring_est = 0.70
            _ma_rec_pts = _ma_recurring_est * 20
            _ma_score += _ma_rec_pts
            if _ma_recurring_est >= 0.6:
                _ma_bull.append(f"High estimated recurring revenue (~{_ma_recurring_est*100:.0f}%) provides predictable cash flows")
            else:
                _ma_bear.append(f"Low recurring revenue (~{_ma_recurring_est*100:.0f}%) increases integration risk")

            # 2) EBITDA Margins (0-20 pts)
            _ma_ebitda_margin = None
            if cd.ebitda is not None and cd.revenue is not None:
                try:
                    _ma_eb = float(cd.ebitda.iloc[0]) if hasattr(cd.ebitda, 'iloc') and len(cd.ebitda) > 0 else (float(cd.ebitda) if isinstance(cd.ebitda, (int, float)) else None)
                    _ma_rv = float(cd.revenue.iloc[0]) if len(cd.revenue) > 0 else None
                    if _ma_eb and _ma_rv and _ma_rv > 0:
                        _ma_ebitda_margin = _ma_eb / _ma_rv
                except Exception:
                    pass
            if _ma_ebitda_margin is not None:
                _ma_margin_pts = max(0, min(20, _ma_ebitda_margin * 60))
                _ma_score += _ma_margin_pts
                if _ma_ebitda_margin > 0.25:
                    _ma_bull.append(f"Strong EBITDA margins ({_ma_ebitda_margin*100:.1f}%) â€” high cash conversion potential")
                elif _ma_ebitda_margin < 0.10:
                    _ma_bear.append(f"Thin EBITDA margins ({_ma_ebitda_margin*100:.1f}%) limit synergy extraction")

            # 3) Revenue Growth Consistency (0-20 pts)
            _ma_rev_std = None
            if cd.revenue is not None and len(cd.revenue) >= 3:
                _ma_rv_vals = [float(v) for v in cd.revenue.values if v is not None and float(v) > 0]
                if len(_ma_rv_vals) >= 3:
                    _ma_growths = [(_ma_rv_vals[i] / _ma_rv_vals[i+1] - 1) for i in range(len(_ma_rv_vals)-1)]
                    _ma_rev_std = np.std(_ma_growths)
                    _ma_avg_growth = np.mean(_ma_growths)
                    _ma_consistency_pts = max(0, min(20, (0.15 - _ma_rev_std) * 133))
                    _ma_score += _ma_consistency_pts
                    if _ma_rev_std < 0.05 and _ma_avg_growth > 0:
                        _ma_bull.append(f"Highly consistent revenue growth (Ïƒ={_ma_rev_std*100:.1f}%) â€” predictable trajectory")
                    elif _ma_rev_std > 0.15:
                        _ma_bear.append(f"Volatile revenue growth (Ïƒ={_ma_rev_std*100:.1f}%) adds forecasting risk")

            # 4) Market Position â€” mcap relative to sector (0-20 pts)
            if cd.market_cap and cd.market_cap > 0:
                # Sweet spot: $1B-$50B (acquirable but meaningful)
                _ma_mcap_b = cd.market_cap / 1e9
                if 1 <= _ma_mcap_b <= 50:
                    _ma_pos_pts = 20
                    _ma_bull.append(f"Market cap (${_ma_mcap_b:.1f}B) in acquisition sweet spot â€” large enough to be meaningful, small enough to acquire")
                elif _ma_mcap_b < 1:
                    _ma_pos_pts = max(5, 15 * _ma_mcap_b)
                    _ma_bear.append(f"Small market cap (${_ma_mcap_b:.1f}B) may lack scale for strategic acquirers")
                else:
                    _ma_pos_pts = max(5, 20 - (_ma_mcap_b - 50) * 0.15)
                    _ma_bear.append(f"Large market cap (${_ma_mcap_b:.1f}B) limits potential acquirer pool")
                _ma_score += _ma_pos_pts

            # 5) Debt Levels (0-20 pts)
            _ma_de = cd.debt_to_equity
            if _ma_de is not None:
                _ma_de_norm = _ma_de / 100 if _ma_de > 5 else _ma_de
                _ma_debt_pts = max(0, min(20, (2.0 - _ma_de_norm) * 10))
                _ma_score += _ma_debt_pts
                if _ma_de_norm < 0.5:
                    _ma_bull.append(f"Low leverage (D/E={_ma_de_norm:.2f}x) â€” clean balance sheet for acquirer")
                elif _ma_de_norm > 1.5:
                    _ma_bear.append(f"High leverage (D/E={_ma_de_norm:.2f}x) complicates acquisition financing")
            else:
                _ma_score += 10  # neutral

            _ma_score = round(max(0, min(100, _ma_score)))

            # Rating
            if _ma_score >= 75:
                _ma_label = "Highly Attractive"
                _ma_color = "#10B981"
            elif _ma_score >= 55:
                _ma_label = "Attractive"
                _ma_color = "#34D399"
            elif _ma_score >= 35:
                _ma_label = "Moderate"
                _ma_color = "#F59E0B"
            else:
                _ma_label = "Unattractive"
                _ma_color = "#EF4444"

            with st.expander(f"ğŸ¯ M&A Target Screening â€” {_ma_label} ({_ma_score}/100)", expanded=False):
                # Large gauge
                _ma_angle = (_ma_score / 100) * 180 - 90
                _ma_gauge_html = f'''
                <div style="text-align:center; margin:0.5rem 0 1.5rem 0;">
                    <svg viewBox="0 0 220 130" width="220" height="130" style="margin:0 auto; display:block;">
                        <defs>
                            <linearGradient id="maGaugeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#EF4444"/>
                                <stop offset="35%" style="stop-color:#F59E0B"/>
                                <stop offset="55%" style="stop-color:#34D399"/>
                                <stop offset="100%" style="stop-color:#10B981"/>
                            </linearGradient>
                        </defs>
                        <path d="M 20 110 A 90 90 0 0 1 200 110" fill="none" stroke="url(#maGaugeGrad)" stroke-width="16" stroke-linecap="round"/>
                        <line x1="110" y1="110" x2="{110 + 70 * np.cos(np.radians(_ma_angle + 180))}" y2="{110 + 70 * np.sin(np.radians(_ma_angle + 180))}"
                            stroke="{_ma_color}" stroke-width="3" stroke-linecap="round"/>
                        <circle cx="110" cy="110" r="6" fill="{_ma_color}"/>
                        <text x="20" y="125" font-size="7" fill="#9CA3AF">Unattractive</text>
                        <text x="145" y="125" font-size="7" fill="#9CA3AF">Highly Attractive</text>
                    </svg>
                    <div style="font-size:2.5rem; font-weight:800; color:{_ma_color}; margin-top:0.3rem;">{_ma_score}</div>
                    <div style="font-size:1rem; font-weight:700; color:{_ma_color}; text-transform:uppercase; letter-spacing:1.5px;">{_ma_label}</div>
                    <div style="font-size:0.65rem; color:#9CA3AF; margin-top:0.2rem;">Acquisition Attractiveness Score</div>
                </div>
                '''
                st.markdown(_ma_gauge_html, unsafe_allow_html=True)

                # Bull/Bear bullets
                if _ma_bull:
                    st.markdown(
                        '<div style="font-size:0.72rem; font-weight:700; color:#10B981; margin-bottom:0.3rem;">âœ… Attractive Factors</div>',
                        unsafe_allow_html=True,
                    )
                    for _b in _ma_bull:
                        st.markdown(
                            f'<div style="font-size:0.75rem; color:#D1D5DB; padding:0.15rem 0;">â€¢ {_b}</div>',
                            unsafe_allow_html=True,
                        )
                if _ma_bear:
                    st.markdown(
                        '<div style="font-size:0.72rem; font-weight:700; color:#EF4444; margin-top:0.5rem; margin-bottom:0.3rem;">âš ï¸ Risk Factors</div>',
                        unsafe_allow_html=True,
                    )
                    for _b in _ma_bear:
                        st.markdown(
                            f'<div style="font-size:0.75rem; color:#D1D5DB; padding:0.15rem 0;">â€¢ {_b}</div>',
                            unsafe_allow_html=True,
                        )
        except Exception:
            pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ›¡ï¸ COMPETITIVE MOAT ANALYSIS (5 dimensions, radar with sector overlay)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Competitive Moat Analysis"):
        try:
            _cm_scores = {}
            _cm_sector_avg = {}

            # Sector benchmarks for overlay
            _cm_bench = get_sector_benchmarks(cd.sector) if cd.sector else None

            # 1) Gross Margins vs Sector (Pricing Power) â€” 0-5
            _cm_gm = cd.gross_margins or 0
            _cm_sector_gm = (_cm_bench["gross_margin"]["median"] if _cm_bench and "gross_margin" in _cm_bench else 0.35)
            _cm_gm_score = min(5, max(0, (_cm_gm / max(_cm_sector_gm, 0.01)) * 2.5))
            _cm_scores["Pricing Power"] = round(_cm_gm_score, 1)
            _cm_sector_avg["Pricing Power"] = 2.5  # sector median = midpoint by definition

            # 2) R&D Intensity (Innovation Moat) â€” 0-5
            _cm_rd_pct = 0
            if cd.income_stmt is not None:
                try:
                    for _rdl in ["ResearchAndDevelopment", "Research And Development", "ResearchDevelopment"]:
                        if _rdl in cd.income_stmt.index:
                            _rd_row = cd.income_stmt.loc[_rdl]
                            _rd_v = float(_rd_row.iloc[0]) if len(_rd_row) > 0 else 0
                            _rv_v = float(cd.revenue.iloc[0]) if cd.revenue is not None and len(cd.revenue) > 0 else 0
                            if _rv_v > 0 and _rd_v > 0:
                                _cm_rd_pct = _rd_v / _rv_v
                            break
                except Exception:
                    pass
            _cm_rd_score = min(5, _cm_rd_pct * 25)  # 20% R&D = 5.0
            _cm_scores["Innovation"] = round(_cm_rd_score, 1)
            _cm_sector_avg["Innovation"] = 1.5  # typical sector avg

            # 3) Market Share Proxy (revenue vs sector peers) â€” 0-5
            _cm_ms_score = 1.0
            if cd.peer_data and cd.revenue is not None and len(cd.revenue) > 0:
                _cm_my_rev = float(cd.revenue.iloc[0])
                _cm_peer_revs = [p.get("revenue", 0) for p in cd.peer_data if p.get("revenue", 0) > 0]
                if _cm_peer_revs:
                    _cm_total_rev = sum(_cm_peer_revs) + _cm_my_rev
                    _cm_share = _cm_my_rev / _cm_total_rev if _cm_total_rev > 0 else 0
                    _cm_ms_score = min(5, _cm_share * 25)  # 20% share = 5
            _cm_scores["Market Share"] = round(_cm_ms_score, 1)
            _cm_sector_avg["Market Share"] = 1.5

            # 4) Customer Concentration Risk (inverse of revenue volatility) â€” 0-5
            _cm_cc_score = 2.5
            if cd.revenue is not None and len(cd.revenue) >= 3:
                _cm_rv = [float(v) for v in cd.revenue.values if v is not None and float(v) > 0]
                if len(_cm_rv) >= 3:
                    _cm_rv_growths = [(_cm_rv[i] / _cm_rv[i+1] - 1) for i in range(len(_cm_rv)-1)]
                    _cm_rv_std = np.std(_cm_rv_growths)
                    _cm_cc_score = min(5, max(0, (0.20 - _cm_rv_std) * 25))
            _cm_scores["Revenue Stability"] = round(_cm_cc_score, 1)
            _cm_sector_avg["Revenue Stability"] = 2.5

            # 5) Switching Costs Proxy (SG&A efficiency) â€” 0-5
            _cm_sw_score = 2.0
            if cd.income_stmt is not None and cd.revenue is not None and len(cd.revenue) > 0:
                try:
                    _sga_val = None
                    for _sga_label in ["SellingGeneralAndAdministration", "Selling General And Administration", "SGA"]:
                        if _sga_label in cd.income_stmt.index:
                            _sga_row = cd.income_stmt.loc[_sga_label]
                            _sga_val = float(_sga_row.iloc[0]) if len(_sga_row) > 0 else None
                            break
                    if _sga_val and _sga_val > 0:
                        _cm_sga_ratio = _sga_val / float(cd.revenue.iloc[0])
                        # Lower SGA/Rev = higher switching costs (customers come organically)
                        _cm_sw_score = min(5, max(0, (0.5 - _cm_sga_ratio) * 10))
                except Exception:
                    pass
            _cm_scores["Switching Costs"] = round(_cm_sw_score, 1)
            _cm_sector_avg["Switching Costs"] = 2.0

            _cm_total = sum(_cm_scores.values())
            _cm_max = 25
            if _cm_total >= 17:
                _cm_rating = "Wide"
                _cm_r_color = "#10B981"
            elif _cm_total >= 10:
                _cm_rating = "Narrow"
                _cm_r_color = "#F59E0B"
            else:
                _cm_rating = "None"
                _cm_r_color = "#EF4444"

            with st.expander(f"ğŸ›¡ï¸ Competitive Moat Analysis â€” {_cm_rating} Moat ({_cm_total:.1f}/25)", expanded=False):
                # Radar chart with sector overlay
                _cm_cats = list(_cm_scores.keys())
                _cm_vals = [_cm_scores[c] for c in _cm_cats]
                _cm_sect = [_cm_sector_avg[c] for c in _cm_cats]
                _cm_cats_r = _cm_cats + [_cm_cats[0]]
                _cm_vals_r = _cm_vals + [_cm_vals[0]]
                _cm_sect_r = _cm_sect + [_cm_sect[0]]

                _cm_fig = go.Figure()
                _cm_fig.add_trace(go.Scatterpolar(
                    r=_cm_sect_r, theta=_cm_cats_r,
                    fill='toself', fillcolor='rgba(138,133,173,0.1)',
                    line=dict(color='#9CA3AF', width=1, dash='dash'),
                    marker=dict(size=4, color='#9CA3AF'),
                    name='Sector Average',
                ))
                _cm_fig.add_trace(go.Scatterpolar(
                    r=_cm_vals_r, theta=_cm_cats_r,
                    fill='toself', fillcolor=f'{_cm_r_color}22',
                    line=dict(color=_cm_r_color, width=2),
                    marker=dict(size=6, color=_cm_r_color),
                    name=cd.ticker,
                ))
                _cm_fig.update_layout(
                    **_CHART_LAYOUT_BASE, height=340,
                    margin=dict(t=40, b=30, l=60, r=60),
                    polar=dict(
                        bgcolor="rgba(0,0,0,0)",
                        radialaxis=dict(visible=True, range=[0, 5], showticklabels=True,
                                       tickfont=dict(size=8, color="#6B6B80"),
                                       gridcolor="rgba(255,255,255,0.06)"),
                        angularaxis=dict(tickfont=dict(size=10, color="#D1D5DB"),
                                        gridcolor="rgba(255,255,255,0.06)"),
                    ),
                    showlegend=True,
                    legend=dict(font=dict(size=10, color="#D1D5DB"), bgcolor="rgba(0,0,0,0)"),
                )
                st.plotly_chart(_cm_fig, use_container_width=True, key="competitive_moat_radar")

                # Overall rating badge
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba({",".join(str(int(c, 16)) for c in [_cm_r_color[1:3], _cm_r_color[3:5], _cm_r_color[5:7]])},0.1); '
                    f'border-radius:12px; margin:0.5rem 0;">'
                    f'<div style="font-size:1.4rem; font-weight:800; color:{_cm_r_color};">{_cm_rating} Moat</div>'
                    f'<div style="font-size:0.75rem; color:#9CA3AF;">Total Score: {_cm_total:.1f} / {_cm_max}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

                # Dimension bars
                for _cm_d, _cm_v in _cm_scores.items():
                    _cm_d_color = "#10B981" if _cm_v >= 3.5 else "#F59E0B" if _cm_v >= 2 else "#EF4444"
                    _cm_d_w = max(5, _cm_v / 5 * 100)
                    st.markdown(
                        f'<div style="display:flex; align-items:center; margin:0.3rem 0; gap:0.5rem;">'
                        f'<div style="width:110px; font-size:0.72rem; color:#D1D5DB; flex-shrink:0;">{_cm_d}</div>'
                        f'<div style="flex:1; background:rgba(255,255,255,0.05); border-radius:6px; height:14px; overflow:hidden;">'
                        f'<div style="width:{_cm_d_w}%; height:100%; background:{_cm_d_color}; border-radius:6px;"></div></div>'
                        f'<div style="width:35px; font-size:0.72rem; color:{_cm_d_color}; font-weight:600; text-align:right;">{_cm_v:.1f}</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
        except Exception:
            pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2c-ii. WHAT-IF SIMULATOR
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("What-If Simulator"):
        try:
            _wif_revenue = None
            _wif_ebitda = None
            _wif_ev_ebitda = cd.ev_to_ebitda if cd.ev_to_ebitda and cd.ev_to_ebitda > 0 else None
            _wif_shares = cd.shares_outstanding if hasattr(cd, 'shares_outstanding') and cd.shares_outstanding else None
            if _wif_shares is None and cd.market_cap and cd.current_price and cd.current_price > 0:
                _wif_shares = cd.market_cap / cd.current_price
            if cd.revenue is not None and len(cd.revenue) > 0:
                _wif_revenue = float(cd.revenue.iloc[0])
            if cd.ebitda is not None:
                if hasattr(cd.ebitda, 'iloc') and len(cd.ebitda) > 0:
                    _wif_ebitda = float(cd.ebitda.iloc[0])
                elif isinstance(cd.ebitda, (int, float)):
                    _wif_ebitda = float(cd.ebitda)
            _wif_margin = (_wif_ebitda / _wif_revenue * 100) if _wif_revenue and _wif_ebitda and _wif_revenue > 0 else None

            if _wif_revenue and _wif_shares and _wif_shares > 0 and _wif_ev_ebitda:
                with st.expander("ğŸ¯ What-If Simulator", expanded=False):
                    st.markdown(
                        '<div style="font-size:0.75rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                        'Adjust assumptions to see implied share price changes in real time.</div>',
                        unsafe_allow_html=True,
                    )
                    _wif_c1, _wif_c2, _wif_c3 = st.columns(3)
                    with _wif_c1:
                        _wif_rev_growth = st.slider("Revenue Growth (%)", -20, 20, 0, 1, key="wif_rev_growth",
                                                     help="Adjust revenue growth from base")
                    with _wif_c2:
                        _wif_margin_adj = st.slider("Margin Î” (bps)", -500, 500, 0, 25, key="wif_margin_adj",
                                                     help="EBITDA margin expansion/compression in basis points")
                    with _wif_c3:
                        _wif_mult_adj = st.slider("Multiple Î” (x)", -5.0, 5.0, 0.0, 0.5, key="wif_mult_adj",
                                                   help="EV/EBITDA multiple re-rating")

                    # Calculate implied price
                    _wif_adj_revenue = _wif_revenue * (1 + _wif_rev_growth / 100)
                    _wif_base_margin = _wif_margin if _wif_margin else 20.0
                    _wif_adj_margin = (_wif_base_margin + _wif_margin_adj / 100) / 100
                    _wif_adj_ebitda = _wif_adj_revenue * _wif_adj_margin
                    _wif_adj_multiple = _wif_ev_ebitda + _wif_mult_adj
                    _wif_adj_ev = _wif_adj_ebitda * _wif_adj_multiple
                    _wif_net_debt = (cd.enterprise_value or 0) - (cd.market_cap or 0)
                    _wif_eq_value = _wif_adj_ev - _wif_net_debt
                    _wif_implied_price = _wif_eq_value / _wif_shares if _wif_shares > 0 else 0
                    _wif_upside = ((_wif_implied_price / cd.current_price) - 1) * 100 if cd.current_price > 0 else 0

                    # Bull case: +10% rev, +200bps margin, +2x multiple
                    _wif_bull_rev = _wif_revenue * 1.10
                    _wif_bull_ebitda = _wif_bull_rev * ((_wif_base_margin + 2) / 100)
                    _wif_bull_ev = _wif_bull_ebitda * (_wif_ev_ebitda + 2)
                    _wif_bull_price = (_wif_bull_ev - _wif_net_debt) / _wif_shares if _wif_shares > 0 else 0

                    # Bear case: -10% rev, -200bps margin, -2x multiple
                    _wif_bear_rev = _wif_revenue * 0.90
                    _wif_bear_ebitda = _wif_bear_rev * (max(0, _wif_base_margin - 2) / 100)
                    _wif_bear_ev = _wif_bear_ebitda * max(1, _wif_ev_ebitda - 2)
                    _wif_bear_price = (_wif_bear_ev - _wif_net_debt) / _wif_shares if _wif_shares > 0 else 0

                    # Display metrics
                    _wm1, _wm2, _wm3 = st.columns(3)
                    _wif_color = "#10B981" if _wif_upside >= 0 else "#EF4444"
                    _wm1.metric("Current Price", f"{cd.currency_symbol}{cd.current_price:,.2f}")
                    _wm2.metric("Implied Price", f"{cd.currency_symbol}{_wif_implied_price:,.2f}",
                               delta=f"{_wif_upside:+.1f}%")
                    _wm3.metric("Adj. EV/EBITDA", f"{_wif_adj_multiple:.1f}x",
                               delta=f"{_wif_mult_adj:+.1f}x" if _wif_mult_adj != 0 else None)

                    # Plotly bar chart: Current vs Implied vs Bull vs Bear
                    try:
                        _wif_fig = go.Figure()
                        _wif_labels = ["Bear Case", "Current", "Your Scenario", "Bull Case"]
                        _wif_values = [_wif_bear_price, cd.current_price, _wif_implied_price, _wif_bull_price]
                        _wif_colors = ["#EF4444", "#9CA3AF", "#2563EB", "#10B981"]
                        _wif_fig.add_trace(go.Bar(
                            x=_wif_labels, y=_wif_values,
                            marker_color=_wif_colors,
                            text=[f"{cd.currency_symbol}{v:,.2f}" for v in _wif_values],
                            textposition="outside",
                            textfont=dict(size=11, color="#F9FAFB"),
                        ))
                        _wif_fig.update_layout(
                            **_CHART_LAYOUT_BASE, height=300,
                            margin=dict(t=30, b=30, l=40, r=20),
                            yaxis=dict(title=dict(text="Implied Price", font=dict(size=10, color="#9CA3AF")),
                                      tickprefix=cd.currency_symbol, tickfont=dict(size=9, color="#9CA3AF"),
                                      showgrid=True, gridcolor="rgba(255,255,255,0.05)"),
                            xaxis=dict(tickfont=dict(size=10, color="#D1D5DB")),
                            showlegend=False,
                        )
                        _apply_space_grid(_wif_fig)
                        st.plotly_chart(_wif_fig, use_container_width=True, key="whatif_bar")
                    except Exception:
                        pass

                    st.markdown(
                        '<div style="font-size:0.65rem; color:#6B6B80; margin-top:0.3rem; line-height:1.5;">'
                        'ğŸ’¡ Bull/Bear cases use Â±10% revenue, Â±200bps margin, Â±2x multiple from current levels. '
                        'Your scenario reflects the slider adjustments above.'
                        '</div>',
                        unsafe_allow_html=True,
                    )
        except Exception:
            pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ» BEAR CASE / ğŸ‚ BULL CASE GENERATOR
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Bear Bull Case"):
        try:
            _bb_bull_factors = []
            _bb_bear_factors = []

            # â”€â”€ Gather data points â”€â”€
            _bb_rev_growth = cd.revenue_growth
            _bb_hist_rev_growths = []
            if cd.revenue is not None and len(cd.revenue) >= 3:
                _bb_rv = [float(v) for v in cd.revenue.values if v is not None and float(v) > 0]
                if len(_bb_rv) >= 2:
                    _bb_hist_rev_growths = [(_bb_rv[i] / _bb_rv[i+1] - 1) for i in range(len(_bb_rv)-1)]
            _bb_avg_hist_growth = sum(_bb_hist_rev_growths) / len(_bb_hist_rev_growths) if _bb_hist_rev_growths else None

            _bb_gm = cd.gross_margins
            _bb_om = cd.operating_margins
            _bb_gm_trend = None
            if cd.gross_margin_series is not None and len(cd.gross_margin_series) >= 2:
                _gms = [v for v in cd.gross_margin_series.values if v is not None and v == v]
                if len(_gms) >= 2:
                    _bb_gm_trend = _gms[0] - _gms[-1]  # positive = expanding

            _bb_pe = cd.trailing_pe
            _bb_sector_bench = get_sector_benchmarks(cd.sector) if cd.sector else None
            _bb_hist_pe = _bb_sector_bench["pe"]["median"] if _bb_sector_bench else None

            _bb_fcf = None
            if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) > 0:
                _bb_fcf = float(cd.free_cashflow_series.iloc[0])
            _bb_fcf_trend = None
            if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) >= 2:
                _fcf_vals = [float(v) for v in cd.free_cashflow_series.values]
                _bb_fcf_trend = _fcf_vals[0] - _fcf_vals[-1]

            _bb_de = cd.debt_to_equity
            _bb_price = cd.current_price or 0
            _bb_52h = cd.fifty_two_week_high or 0
            _bb_52l = cd.fifty_two_week_low or 0
            _bb_52_pct = ((_bb_price - _bb_52l) / (_bb_52h - _bb_52l) * 100) if _bb_52h > _bb_52l > 0 else 50

            # â”€â”€ Bull factors â”€â”€
            if _bb_rev_growth and _bb_avg_hist_growth and _bb_rev_growth > _bb_avg_hist_growth:
                _bb_bull_factors.append(("ğŸ“ˆ Revenue Accelerating",
                    f"Recent growth ({_bb_rev_growth*100:.1f}%) exceeds historical avg ({_bb_avg_hist_growth*100:.1f}%)"))
            if _bb_gm_trend is not None and _bb_gm_trend > 0.005:
                _bb_bull_factors.append(("ğŸ“Š Margin Expanding",
                    f"Gross margin expanded {_bb_gm_trend*100:.1f}pp over reported periods"))
            if _bb_pe and _bb_hist_pe and _bb_pe < _bb_hist_pe:
                _bb_bull_factors.append(("ğŸ’° Below Sector P/E",
                    f"Trading at {_bb_pe:.1f}x vs sector median {_bb_hist_pe:.1f}x"))
            if _bb_fcf and _bb_fcf > 0:
                _bb_fcf_yield = (_bb_fcf / cd.market_cap * 100) if cd.market_cap and cd.market_cap > 0 else 0
                if _bb_fcf_yield > 3:
                    _bb_bull_factors.append(("ğŸ’µ Strong FCF Generation",
                        f"FCF yield of {_bb_fcf_yield:.1f}%"))
            if _bb_de is not None and _bb_de < 50:
                _bb_bull_factors.append(("ğŸ›¡ï¸ Low Leverage",
                    f"Debt/Equity of {_bb_de:.1f}% provides financial flexibility"))
            if _bb_52_pct < 30:
                _bb_bull_factors.append(("ğŸ”„ Near 52-Week Low",
                    f"Trading in bottom {_bb_52_pct:.0f}% of range â€” potential rebound"))
            if _bb_rev_growth and _bb_rev_growth > 0.10:
                _bb_bull_factors.append(("ğŸš€ Strong Top-Line Growth",
                    f"Revenue growing at {_bb_rev_growth*100:.1f}%"))

            # â”€â”€ Bear factors â”€â”€
            if _bb_rev_growth and _bb_avg_hist_growth and _bb_rev_growth < _bb_avg_hist_growth:
                _bb_bear_factors.append(("ğŸ“‰ Revenue Decelerating",
                    f"Recent growth ({_bb_rev_growth*100:.1f}%) trails historical avg ({_bb_avg_hist_growth*100:.1f}%)"))
            if _bb_gm_trend is not None and _bb_gm_trend < -0.005:
                _bb_bear_factors.append(("ğŸ“Š Margin Compression",
                    f"Gross margin declined {abs(_bb_gm_trend)*100:.1f}pp over reported periods"))
            if _bb_pe and _bb_hist_pe and _bb_pe > _bb_hist_pe * 1.2:
                _bb_bear_factors.append(("âš ï¸ Above Sector P/E",
                    f"Trading at {_bb_pe:.1f}x vs sector median {_bb_hist_pe:.1f}x"))
            if _bb_de is not None and _bb_de > 150:
                _bb_bear_factors.append(("ğŸ”´ High Leverage",
                    f"Debt/Equity of {_bb_de:.1f}% increases financial risk"))
            if _bb_52_pct > 85:
                _bb_bear_factors.append(("ğŸ“ Near 52-Week High",
                    f"Trading in top {100-_bb_52_pct:.0f}% of range â€” limited upside"))
            if _bb_fcf_trend is not None and _bb_fcf_trend < 0:
                _bb_bear_factors.append(("ğŸ’¸ Negative FCF Trend",
                    f"Free cash flow declining over reported periods"))
            if _bb_rev_growth and _bb_rev_growth < 0:
                _bb_bear_factors.append(("ğŸ”» Revenue Declining",
                    f"Top line shrinking at {_bb_rev_growth*100:.1f}%"))

            _bb_bull_top3 = _bb_bull_factors[:3]
            _bb_bear_top3 = _bb_bear_factors[:3]

            if _bb_bull_top3 or _bb_bear_top3:
                with st.expander("ğŸ» Bear Case / ğŸ‚ Bull Case", expanded=False):
                    _bbc1, _bbc2 = st.columns(2)
                    with _bbc1:
                        _bull_items = ""
                        for _bf_title, _bf_desc in _bb_bull_top3:
                            _bull_items += (
                                f'<div style="padding:0.4rem 0; border-bottom:1px solid rgba(16,185,129,0.1);">'
                                f'<div style="font-size:0.78rem; font-weight:600; color:#10B981;">{_bf_title}</div>'
                                f'<div style="font-size:0.68rem; color:#9CA3AF; margin-top:0.1rem;">{_bf_desc}</div></div>'
                            )
                        if not _bull_items:
                            _bull_items = '<div style="font-size:0.72rem; color:#6B6B80; padding:0.5rem 0;">No strong bull factors identified</div>'
                        st.markdown(
                            f'<div style="background:rgba(16,185,129,0.06); border:1px solid rgba(16,185,129,0.2); '
                            f'border-radius:12px; padding:0.8rem 1rem; height:100%;">'
                            f'<div style="font-size:0.85rem; font-weight:700; color:#10B981; margin-bottom:0.4rem;">'
                            f'ğŸ‚ Bull Case</div>{_bull_items}</div>',
                            unsafe_allow_html=True,
                        )
                    with _bbc2:
                        _bear_items = ""
                        for _br_title, _br_desc in _bb_bear_top3:
                            _bear_items += (
                                f'<div style="padding:0.4rem 0; border-bottom:1px solid rgba(239,68,68,0.1);">'
                                f'<div style="font-size:0.78rem; font-weight:600; color:#EF4444;">{_br_title}</div>'
                                f'<div style="font-size:0.68rem; color:#9CA3AF; margin-top:0.1rem;">{_br_desc}</div></div>'
                            )
                        if not _bear_items:
                            _bear_items = '<div style="font-size:0.72rem; color:#6B6B80; padding:0.5rem 0;">No strong bear factors identified</div>'
                        st.markdown(
                            f'<div style="background:rgba(239,68,68,0.06); border:1px solid rgba(239,68,68,0.2); '
                            f'border-radius:12px; padding:0.8rem 1rem; height:100%;">'
                            f'<div style="font-size:0.85rem; font-weight:700; color:#EF4444; margin-bottom:0.4rem;">'
                            f'ğŸ» Bear Case</div>{_bear_items}</div>',
                            unsafe_allow_html=True,
                        )
        except Exception:
            pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2c-ii. SUM-OF-THE-PARTS (SOTP) VALUATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Sum-of-the-Parts"):
        try:
            _sotp_revenue = None
            if cd.revenue is not None and len(cd.revenue) > 0:
                _sotp_revenue = float(cd.revenue.iloc[0])
            _sotp_mcap = cd.market_cap
            if _sotp_revenue and _sotp_revenue > 0 and _sotp_mcap and _sotp_mcap > 0:
                with st.expander("ğŸ§© Sum-of-the-Parts (SOTP) Valuation", expanded=False):
                    st.markdown(
                        '<div style="font-size:0.75rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                        'Break down the company into business segments and value each separately '
                        'to identify a potential conglomerate discount or premium.</div>',
                        unsafe_allow_html=True,
                    )
                    _sotp_n = st.slider("Number of segments", 2, 4, 2, 1, key="sotp_n_segments")
                    _sotp_segments = []
                    _sotp_cols = st.columns(_sotp_n)
                    _default_names = ["Core Business", "Growth Division", "Services", "Other"]
                    _default_pcts = [60, 40, 0, 0]
                    _remaining = 100
                    for i in range(_sotp_n):
                        with _sotp_cols[i]:
                            _sname = st.text_input("Segment", _default_names[i], key=f"sotp_name_{i}")
                            _dpct = _default_pcts[i] if i < len(_default_pcts) else 0
                            if i == _sotp_n - 1:
                                _dpct = _remaining
                            _spct = st.number_input("Revenue %", 0, 100, min(_dpct, 100), 5, key=f"sotp_pct_{i}")
                            _smult = st.number_input("EV/Revenue", 0.5, 30.0, 3.0, 0.5, key=f"sotp_mult_{i}")
                            _sotp_segments.append({"name": _sname, "pct": _spct, "mult": _smult})
                            _remaining -= _spct

                    _sotp_total_pct = sum(s["pct"] for s in _sotp_segments)
                    if _sotp_total_pct > 0:
                        _sotp_results = []
                        _sotp_total_ev = 0
                        for s in _sotp_segments:
                            _seg_rev = _sotp_revenue * (s["pct"] / 100)
                            _seg_ev = _seg_rev * s["mult"]
                            _sotp_total_ev += _seg_ev
                            _sotp_results.append({"name": s["name"], "revenue": _seg_rev, "ev": _seg_ev, "mult": s["mult"]})

                        _sotp_discount = ((_sotp_total_ev / _sotp_mcap) - 1) * 100

                        # Metrics
                        _sm1, _sm2, _sm3 = st.columns(3)
                        _sm1.metric("SOTP Value", f"{cd.currency_symbol}{_sotp_total_ev / 1e9:.2f}B" if _sotp_total_ev > 1e9 else f"{cd.currency_symbol}{_sotp_total_ev / 1e6:.0f}M")
                        _sm2.metric("Market Cap", f"{cd.currency_symbol}{_sotp_mcap / 1e9:.2f}B" if _sotp_mcap > 1e9 else f"{cd.currency_symbol}{_sotp_mcap / 1e6:.0f}M")
                        _disc_label = "Premium" if _sotp_discount > 0 else "Discount"
                        _sm3.metric(f"Conglomerate {_disc_label}", f"{abs(_sotp_discount):.1f}%",
                                   delta=f"{_sotp_discount:+.1f}%")

                        # Stacked bar chart
                        fig_sotp = go.Figure()
                        _sotp_colors = ["#2563EB", "#10B981", "#F59E0B", "#EF4444"]
                        for idx, sr in enumerate(_sotp_results):
                            fig_sotp.add_trace(go.Bar(
                                x=["SOTP Valuation"], y=[sr["ev"]],
                                name=f'{sr["name"]} ({sr["mult"]:.1f}x)',
                                marker_color=_sotp_colors[idx % len(_sotp_colors)],
                                text=[f'{cd.currency_symbol}{sr["ev"] / 1e9:.1f}B' if sr["ev"] > 1e9 else f'{cd.currency_symbol}{sr["ev"] / 1e6:.0f}M'],
                                textposition="inside", textfont=dict(size=10, color="#F9FAFB"),
                            ))
                        # Market cap comparison bar
                        fig_sotp.add_trace(go.Bar(
                            x=["Market Cap"], y=[_sotp_mcap],
                            name="Market Cap", marker_color="#9CA3AF",
                            text=[f'{cd.currency_symbol}{_sotp_mcap / 1e9:.1f}B' if _sotp_mcap > 1e9 else f'{cd.currency_symbol}{_sotp_mcap / 1e6:.0f}M'],
                            textposition="inside", textfont=dict(size=10, color="#F9FAFB"),
                        ))
                        fig_sotp.update_layout(
                            **_CHART_LAYOUT_BASE, height=320, barmode="stack",
                            margin=dict(t=30, b=30, l=50, r=20),
                            yaxis=dict(tickprefix=cd.currency_symbol, tickfont=dict(size=10, color="#9CA3AF"),
                                      showgrid=True, gridcolor="rgba(255,255,255,0.05)"),
                            xaxis=dict(tickfont=dict(size=11, color="#D1D5DB")),
                            legend=dict(font=dict(size=10, color="#D1D5DB")),
                        )
                        _apply_space_grid(fig_sotp)
                        st.plotly_chart(fig_sotp, use_container_width=True, key="sotp_bar")
        except Exception:
            pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2d. BULL / BEAR INVESTMENT THESIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Investment Thesis"):
        bull_points = []
        bear_points = []

        # Revenue Growth
        if cd.revenue_growth:
            if cd.revenue_growth > 0.10:
                bull_points.append(f"Strong revenue growth ({cd.revenue_growth:.0%}) above market average")
            elif cd.revenue_growth < 0:
                bear_points.append(f"Revenue declining ({cd.revenue_growth:.0%}) â€” top-line contraction risk")

        # Margins
        if cd.profit_margins:
            if cd.profit_margins > 0.20:
                bull_points.append(f"High profit margins ({cd.profit_margins:.0%}) indicate pricing power and moat")
            elif cd.profit_margins < 0.05:
                bear_points.append(f"Thin profit margins ({cd.profit_margins:.0%}) leave little room for error")

        # FCF
        _fcf = cd.free_cashflow_series.iloc[0] if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) > 0 else None
        if _fcf and _fcf > 0:
            _fcf_yield = (_fcf / cd.market_cap * 100) if cd.market_cap else 0
            if _fcf_yield > 5:
                bull_points.append(f"Strong FCF yield ({_fcf_yield:.1f}%) â€” cash generative business")
            elif _fcf_yield > 3:
                bull_points.append(f"Healthy FCF yield ({_fcf_yield:.1f}%)")
        elif _fcf and _fcf < 0:
            bear_points.append("Negative free cash flow â€” burning cash")

        # Debt
        if cd.debt_to_equity:
            if cd.debt_to_equity > 200:
                bear_points.append(f"High leverage (D/E: {cd.debt_to_equity:.0f}%) increases financial risk")
            elif cd.debt_to_equity < 30:
                bull_points.append(f"Conservative balance sheet (D/E: {cd.debt_to_equity:.0f}%)")

        # Beta / Risk
        if cd.beta:
            if cd.beta > 1.5:
                bear_points.append(f"High beta ({cd.beta:.2f}) â€” more volatile than market")
            elif cd.beta < 0.8:
                bull_points.append(f"Low beta ({cd.beta:.2f}) â€” defensive characteristics")

        # Analyst
        if rec and "buy" in rec.lower():
            bull_points.append(f"Analyst consensus is {rec_str}")
        elif rec and "sell" in rec.lower():
            bear_points.append(f"Analyst consensus is {rec_str}")

        # Valuation
        if cd.trailing_pe and cd.trailing_pe < 15:
            bull_points.append(f"Trading at value multiple ({cd.trailing_pe:.0f}x P/E)")
        elif cd.trailing_pe and cd.trailing_pe > 40:
            bear_points.append(f"Expensive valuation ({cd.trailing_pe:.0f}x P/E) â€” priced for perfection")

        # Market position
        if cd.market_cap and cd.market_cap > 100e9:
            bull_points.append("Market leader with significant scale advantages")

        # Dividend
        if cd.dividend_yield and cd.dividend_yield > 0.02:
            _dy = cd.dividend_yield * 100
            bull_points.append(f"Attractive dividend yield ({_dy:.1f}%)")

        if bull_points or bear_points:
            bull_html = "".join(
                f'<div style="padding:0.25rem 0; font-size:0.82rem; color:#D1D5DB; line-height:1.6;">'
                f'<span style="color:#10B981;">â–²</span> {p}</div>'
                for p in bull_points[:4]
            ) or '<div style="font-size:0.8rem; color:#9CA3AF;">No strong bull signals identified</div>'

            bear_html = "".join(
                f'<div style="padding:0.25rem 0; font-size:0.82rem; color:#D1D5DB; line-height:1.6;">'
                f'<span style="color:#EF4444;">â–¼</span> {p}</div>'
                for p in bear_points[:4]
            ) or '<div style="font-size:0.8rem; color:#9CA3AF;">No significant bear signals identified</div>'

            st.markdown(
                f'<div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin:0.5rem 0 1rem 0;">'
                f'<div style="background:rgba(16,185,129,0.04); border:1px solid rgba(16,185,129,0.15); '
                f'border-radius:12px; padding:1rem 1.2rem;">'
                f'<div style="font-size:0.65rem; font-weight:700; color:#10B981; text-transform:uppercase; '
                f'letter-spacing:1.5px; margin-bottom:0.5rem;">ğŸ‚ Bull Case</div>'
                f'{bull_html}</div>'
                f'<div style="background:rgba(239,68,68,0.04); border:1px solid rgba(239,68,68,0.15); '
                f'border-radius:12px; padding:1rem 1.2rem;">'
                f'<div style="font-size:0.65rem; font-weight:700; color:#EF4444; text-transform:uppercase; '
                f'letter-spacing:1.5px; margin-bottom:0.5rem;">ğŸ» Bear Case</div>'
                f'{bear_html}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2c. INVESTMENT THESIS GENERATOR
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Investment Thesis Generator"):
        _section("Investment Thesis Generator", "ğŸ“")
        try:
            _itg_tk = yf.Ticker(cd.ticker)
            _itg_info = _itg_tk.info or {}

            # â”€â”€ Gather financial data â”€â”€
            _itg_rev_growth = cd.revenue_growth
            _itg_gm = cd.gross_margins
            _itg_om = cd.operating_margins
            _itg_pm = cd.profit_margins
            _itg_roe = cd.return_on_equity
            _itg_pe = cd.trailing_pe
            _itg_fwd_pe = cd.forward_pe
            _itg_ev_ebitda = cd.ev_to_ebitda
            _itg_de = cd.debt_to_equity
            _itg_price = cd.current_price or 0
            _itg_mcap = cd.market_cap or 0
            _itg_beta = cd.beta
            _itg_52h = cd.fifty_two_week_high or 0
            _itg_52l = cd.fifty_two_week_low or 0
            _itg_sector = cd.sector or "N/A"
            _itg_short_pct = _itg_info.get("shortPercentOfFloat", 0) or 0

            # FCF
            _itg_fcf = None
            if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) > 0:
                _itg_fcf = float(cd.free_cashflow_series.iloc[0])
            _itg_fcf_yield = (_itg_fcf / _itg_mcap * 100) if _itg_fcf and _itg_mcap > 0 else 0

            # DCF intrinsic value
            _itg_iv = None
            _itg_upside = 0
            try:
                _itg_iv = calculate_intrinsic_value(cd)
                if _itg_iv:
                    _itg_upside = _itg_iv.get("upside_pct", 0)
            except Exception:
                pass

            # Margin trend
            _itg_gm_expanding = False
            if cd.gross_margin_series is not None and len(cd.gross_margin_series) >= 2:
                _gms_vals = [v for v in cd.gross_margin_series.values if v is not None and v == v]
                if len(_gms_vals) >= 2:
                    _itg_gm_expanding = _gms_vals[0] > _gms_vals[-1]

            # Sector benchmark
            _itg_bench = get_sector_benchmarks(cd.sector) if cd.sector else None
            _itg_sector_pe = _itg_bench["pe"]["median"] if _itg_bench else None

            # â”€â”€ Bull Case (3 bullets from actual data) â”€â”€
            _itg_bulls = []
            if _itg_rev_growth and _itg_rev_growth > 0.08:
                _itg_bulls.append(f"<b>Revenue momentum:</b> {_itg_rev_growth*100:.1f}% growth signals strong demand â€” above-market top-line expansion in {_itg_sector}")
            elif _itg_fcf_yield > 4:
                _itg_bulls.append(f"<b>Cash cow profile:</b> {_itg_fcf_yield:.1f}% FCF yield â€” strong cash generation funds buybacks, dividends, or M&A")
            else:
                _itg_bulls.append(f"<b>Market position:</b> {format_number(_itg_mcap)} market cap in {_itg_sector} â€” scale advantages and brand moat")

            if _itg_gm_expanding and _itg_gm:
                _itg_bulls.append(f"<b>Margin expansion:</b> Gross margins trending up to {_itg_gm*100:.1f}% â€” operating leverage kicking in, path to higher profitability")
            elif _itg_om and _itg_om > 0.15:
                _itg_bulls.append(f"<b>Operational efficiency:</b> {_itg_om*100:.1f}% operating margin demonstrates cost discipline and pricing power")
            elif _itg_roe and _itg_roe > 0.15:
                _itg_bulls.append(f"<b>Capital efficiency:</b> {_itg_roe*100:.1f}% ROE â€” management effectively deploying shareholder capital")
            else:
                _itg_bulls.append(f"<b>Valuation upside:</b> Current multiples suggest room for re-rating as fundamentals improve")

            if _itg_pe and _itg_sector_pe and _itg_pe < _itg_sector_pe:
                _itg_bulls.append(f"<b>Undervalued vs peers:</b> {_itg_pe:.1f}x P/E vs sector median {_itg_sector_pe:.1f}x â€” potential re-rating candidate")
            elif _itg_de is not None and _itg_de < 50:
                _itg_bulls.append(f"<b>Balance sheet strength:</b> D/E of {_itg_de:.0f}% â€” financial flexibility for growth investments or shareholder returns")
            else:
                _itg_bulls.append(f"<b>Strategic value:</b> {cd.industry or _itg_sector} positioning provides optionality for strategic acquirers or organic expansion")

            # â”€â”€ Bear Case (3 bullets from actual data) â”€â”€
            _itg_bears = []
            if _itg_rev_growth is not None and _itg_rev_growth < 0:
                _itg_bears.append(f"<b>Top-line decline:</b> Revenue contracting at {_itg_rev_growth*100:.1f}% â€” secular headwinds or market share loss")
            elif _itg_rev_growth is not None and _itg_rev_growth < 0.03:
                _itg_bears.append(f"<b>Stagnant growth:</b> {_itg_rev_growth*100:.1f}% revenue growth barely keeps pace with inflation")
            else:
                _itg_bears.append(f"<b>Growth sustainability:</b> Current growth rate may not be sustainable as comps normalize and market matures")

            if _itg_pe and _itg_pe > 35:
                _itg_bears.append(f"<b>Valuation risk:</b> {_itg_pe:.0f}x P/E prices in perfection â€” any earnings miss could trigger significant multiple compression")
            elif _itg_de is not None and _itg_de > 100:
                _itg_bears.append(f"<b>Leverage concern:</b> D/E of {_itg_de:.0f}% â€” rising rates increase interest burden and limit strategic flexibility")
            elif _itg_beta and _itg_beta > 1.3:
                _itg_bears.append(f"<b>Volatility risk:</b> Beta of {_itg_beta:.2f} means amplified downside in market corrections")
            else:
                _itg_bears.append(f"<b>Competitive pressure:</b> {_itg_sector} sector faces intensifying competition that could pressure margins")

            if _itg_short_pct > 0.05:
                _itg_bears.append(f"<b>Short interest elevated:</b> {_itg_short_pct*100:.1f}% of float shorted â€” market skeptics see near-term downside")
            elif _itg_pm and _itg_pm < 0.05:
                _itg_bears.append(f"<b>Thin margins:</b> {_itg_pm*100:.1f}% net margin leaves minimal buffer â€” execution risk is high")
            else:
                _itg_bears.append(f"<b>Macro sensitivity:</b> Economic slowdown or sector rotation could weigh on valuation and sentiment")

            # â”€â”€ Key Catalysts â”€â”€
            _itg_catalysts = []
            try:
                _itg_cal = _itg_tk.calendar
                if _itg_cal is not None:
                    if isinstance(_itg_cal, dict):
                        _ed = _itg_cal.get("Earnings Date", [])
                        if _ed:
                            _ed_str = _ed[0].strftime("%b %d, %Y") if hasattr(_ed[0], 'strftime') else str(_ed[0])
                            _itg_catalysts.append(f"ğŸ“… <b>Earnings:</b> Next report ~{_ed_str} â€” key test of growth trajectory")
                    elif isinstance(_itg_cal, pd.DataFrame) and not _itg_cal.empty:
                        for col in _itg_cal.columns:
                            if "earnings" in str(col).lower():
                                _ed_val = _itg_cal[col].iloc[0] if len(_itg_cal[col]) > 0 else None
                                if _ed_val:
                                    _ed_str = _ed_val.strftime("%b %d, %Y") if hasattr(_ed_val, 'strftime') else str(_ed_val)
                                    _itg_catalysts.append(f"ğŸ“… <b>Earnings:</b> Next report ~{_ed_str}")
                                    break
            except Exception:
                pass

            if _itg_rev_growth and _itg_rev_growth > 0.15:
                _itg_catalysts.append(f"ğŸš€ <b>Growth inflection:</b> {_itg_rev_growth*100:.1f}% growth could attract momentum investors and analyst upgrades")
            if _itg_fcf_yield > 3:
                _itg_catalysts.append(f"ğŸ’° <b>Capital return:</b> {_itg_fcf_yield:.1f}% FCF yield supports potential buyback or dividend increase announcements")
            if _itg_upside > 20:
                _itg_catalysts.append(f"ğŸ¯ <b>Valuation gap:</b> DCF suggests {_itg_upside:+.0f}% upside â€” catalyst for value investors if market recognizes intrinsic worth")
            elif _itg_upside < -20:
                _itg_catalysts.append(f"âš ï¸ <b>Overvaluation risk:</b> DCF suggests {_itg_upside:+.0f}% â€” any negative news could close the gap quickly")
            if _itg_short_pct > 0.10:
                _itg_catalysts.append(f"ğŸ”¥ <b>Short squeeze potential:</b> {_itg_short_pct*100:.1f}% short interest â€” positive surprise could trigger forced covering")
            if not _itg_catalysts:
                _itg_catalysts.append("ğŸ“Š <b>Steady state:</b> No near-term catalysts identified â€” stock likely trades with sector sentiment")

            # â”€â”€ Verdict â”€â”€
            if _itg_iv and _itg_iv.get("intrinsic_value_per_share"):
                _itg_dcf_price = _itg_iv["intrinsic_value_per_share"]
                if _itg_upside > 15:
                    _itg_verdict = f"BUY at {cs}{_itg_price:,.2f}"
                    _itg_verdict_color = "#10B981"
                    _itg_verdict_detail = f"DCF target: {cs}{_itg_dcf_price:,.2f} ({_itg_upside:+.1f}% upside)"
                elif _itg_upside < -15:
                    _itg_verdict = "SELL"
                    _itg_verdict_color = "#EF4444"
                    _itg_verdict_detail = f"DCF target: {cs}{_itg_dcf_price:,.2f} ({_itg_upside:+.1f}% â€” overvalued)"
                else:
                    _itg_verdict = "HOLD"
                    _itg_verdict_color = "#F5A623"
                    _itg_verdict_detail = f"DCF target: {cs}{_itg_dcf_price:,.2f} ({_itg_upside:+.1f}% â€” fairly valued)"
            else:
                if _itg_pe and _itg_sector_pe and _itg_pe < _itg_sector_pe * 0.8:
                    _itg_verdict = f"BUY at {cs}{_itg_price:,.2f}"
                    _itg_verdict_color = "#10B981"
                    _itg_verdict_detail = f"Trading at significant discount to sector ({_itg_pe:.1f}x vs {_itg_sector_pe:.1f}x)"
                elif _itg_pe and _itg_sector_pe and _itg_pe > _itg_sector_pe * 1.3:
                    _itg_verdict = "SELL"
                    _itg_verdict_color = "#EF4444"
                    _itg_verdict_detail = f"Trading at premium to sector ({_itg_pe:.1f}x vs {_itg_sector_pe:.1f}x)"
                else:
                    _itg_verdict = "HOLD"
                    _itg_verdict_color = "#F5A623"
                    _itg_verdict_detail = "Insufficient DCF data â€” valuation appears fair on relative basis"

            # â”€â”€ Render â”€â”€
            _bull_items = "".join(f'<div style="padding:0.3rem 0; font-size:0.82rem; color:#D1D5DB; line-height:1.6;"><span style="color:#10B981; font-weight:700;">â–²</span> {b}</div>' for b in _itg_bulls[:3])
            _bear_items = "".join(f'<div style="padding:0.3rem 0; font-size:0.82rem; color:#D1D5DB; line-height:1.6;"><span style="color:#EF4444; font-weight:700;">â–¼</span> {b}</div>' for b in _itg_bears[:3])
            _catalyst_items = "".join(f'<div style="padding:0.3rem 0; font-size:0.82rem; color:#D1D5DB; line-height:1.6;">{c}</div>' for c in _itg_catalysts[:4])

            st.markdown(
                f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); border-radius:16px; padding:1.2rem; margin:0.5rem 0;">'
                f'<div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;">'
                f'<div style="background:rgba(16,185,129,0.04); border:1px solid rgba(16,185,129,0.15); border-radius:12px; padding:1rem;">'
                f'<div style="font-size:0.65rem; font-weight:700; color:#10B981; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:0.5rem;">ğŸ‚ Bull Case</div>'
                f'{_bull_items}</div>'
                f'<div style="background:rgba(239,68,68,0.04); border:1px solid rgba(239,68,68,0.15); border-radius:12px; padding:1rem;">'
                f'<div style="font-size:0.65rem; font-weight:700; color:#EF4444; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:0.5rem;">ğŸ» Bear Case</div>'
                f'{_bear_items}</div></div>'
                f'<div style="background:rgba(245,166,35,0.04); border:1px solid rgba(245,166,35,0.15); border-radius:12px; padding:1rem; margin-bottom:1rem;">'
                f'<div style="font-size:0.65rem; font-weight:700; color:#F5A623; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:0.5rem;">âš¡ Key Catalysts</div>'
                f'{_catalyst_items}</div>'
                f'<div style="background:rgba(37,99,235,0.08); border:2px solid {_itg_verdict_color}; border-radius:12px; padding:1rem; text-align:center;">'
                f'<div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:0.3rem;">Investment Verdict</div>'
                f'<div style="font-size:1.5rem; font-weight:900; color:{_itg_verdict_color};">{_itg_verdict}</div>'
                f'<div style="font-size:0.8rem; color:#D1D5DB; margin-top:0.3rem;">{_itg_verdict_detail}</div>'
                f'</div></div>',
                unsafe_allow_html=True,
            )
        except Exception as _itg_e:
            st.info(f"Investment thesis generator unavailable: {_itg_e}")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 3. BUSINESS OVERVIEW
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Business Overview")
    with st.expander("Company Description", expanded=True):
        if cd.long_business_summary:
            st.markdown(f"<div style='line-height:1.7; color:#D1D5DB; font-size:0.9rem;'>{cd.long_business_summary}</div>", unsafe_allow_html=True)
        else:
            st.info("Business description not available.")
        b1, b2, b3 = st.columns(3)
        with b1:
            emp_val = f"{cd.full_time_employees:,}" if cd.full_time_employees else "N/A"
            st.markdown(f'<div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:0.6rem 0.8rem; text-align:center;"><div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; letter-spacing:0.7px; color:#9CA3AF; margin-bottom:0.2rem;">Employees</div><div style="font-size:1rem; font-weight:700; color:#F9FAFB;">{emp_val}</div></div>', unsafe_allow_html=True)
        with b2:
            hq = f"{cd.city}, {cd.state}" if cd.city else "N/A"
            if cd.country and cd.country != "United States":
                hq += f", {cd.country}"
            st.markdown(f'<div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:0.6rem 0.8rem; text-align:center;"><div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; letter-spacing:0.7px; color:#9CA3AF; margin-bottom:0.2rem;">Headquarters</div><div style="font-size:1rem; font-weight:700; color:#F9FAFB;">{hq}</div></div>', unsafe_allow_html=True)
        with b3:
            web_display = cd.website.replace("https://", "").replace("http://", "").rstrip("/") if cd.website else "N/A"
            st.markdown(f'<div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:0.6rem 0.8rem; text-align:center;"><div style="font-size:0.65rem; font-weight:600; text-transform:uppercase; letter-spacing:0.7px; color:#9CA3AF; margin-bottom:0.2rem;">Website</div><div style="font-size:1rem; font-weight:700; color:#F9FAFB;">{web_display}</div></div>', unsafe_allow_html=True)

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 3b. REVENUE SEGMENTATION (if available)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Revenue Segmentation"):
        _seg_data_found = False
        try:
            _tk_seg = yf.Ticker(cd.ticker)
            # yfinance may expose revenue by segment/geography via get_financials or similar
            _seg_rev = getattr(_tk_seg, 'revenue_estimate', None)
            # Try newer yfinance API for segment data
            _seg_by_product = None
            _seg_by_geo = None
            try:
                _seg_by_product = _tk_seg.get_revenue_estimate() if hasattr(_tk_seg, 'get_revenue_estimate') else None
            except Exception:
                pass
            # Check for quarterly financials that might have segment info
            # yfinance doesn't reliably provide segment data, so we check what's available
            if _seg_by_product is not None and hasattr(_seg_by_product, 'empty') and not _seg_by_product.empty:
                _seg_data_found = True
                _section("Revenue Segmentation", "ğŸ“Š")
                st.dataframe(_seg_by_product, use_container_width=True)
        except Exception:
            pass

        if not _seg_data_found:
            # Silently skip â€” don't show anything if no segment data
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4. PRICE CHART
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Price History")

    _price_ctrl_col1, _price_ctrl_col2 = st.columns([1, 1])
    with _price_ctrl_col1:
        period_choice = st.radio("Period", ["1Y", "3Y", "5Y"], horizontal=True, index=2, label_visibility="collapsed")
    with _price_ctrl_col2:
        _chart_type = st.radio("Chart Type", ["ğŸ“ˆ Line", "ğŸ•¯ï¸ Candlestick"], horizontal=True, index=0, label_visibility="collapsed", key="price_chart_type")

    hist = cd.hist_5y if cd.hist_5y is not None and not cd.hist_5y.empty else cd.hist_1y
    if hist is not None and not hist.empty:
        if period_choice == "1Y" and cd.hist_1y is not None:
            plot_hist = cd.hist_1y
        elif period_choice == "3Y" and hist is not None:
            plot_hist = hist.last("3Y") if hasattr(hist, "last") else hist.tail(756)
        else:
            plot_hist = hist

        _is_candlestick = "Candlestick" in _chart_type

        if _is_candlestick:
            from plotly.subplots import make_subplots as _mk_subplots
            fig = _mk_subplots(rows=2, cols=1, shared_xaxes=True, vertical_spacing=0.03,
                               row_heights=[0.75, 0.25])
            fig.add_trace(go.Candlestick(
                x=plot_hist.index,
                open=plot_hist["Open"], high=plot_hist["High"],
                low=plot_hist["Low"], close=plot_hist["Close"],
                increasing_line_color="#10B981", decreasing_line_color="#EF4444",
                increasing_fillcolor="rgba(16,185,129,0.7)", decreasing_fillcolor="rgba(239,68,68,0.7)",
                name="OHLC",
            ), row=1, col=1)
            if "Volume" in plot_hist.columns:
                _cnd_colors = ["#10B981" if plot_hist["Close"].iloc[i] >= plot_hist["Open"].iloc[i] else "#EF4444" for i in range(len(plot_hist))]
                fig.add_trace(go.Bar(
                    x=plot_hist.index, y=plot_hist["Volume"],
                    marker_color=_cnd_colors, marker_opacity=0.4, name="Volume", showlegend=False,
                ), row=2, col=1)
            fig.update_layout(xaxis_rangeslider_visible=False)
        else:
            fig = go.Figure()
            # Glow underlay + main price line
            _glow_line_traces(fig, plot_hist.index, plot_hist["Close"], "#2563EB", "Close")
            # Area fill
            fig.add_trace(go.Scatter(
                x=plot_hist.index, y=plot_hist["Close"],
                mode="lines", line=dict(width=0), fill="tozeroy",
                fillcolor="rgba(37,99,235,0.06)",
                showlegend=False, hoverinfo="skip",
            ))
        # Color-coded volume bars (line mode only)
        if not _is_candlestick and "Volume" in plot_hist.columns:
            close_vals = plot_hist["Close"].values
            vol_colors = []
            for i in range(len(close_vals)):
                if i == 0:
                    vol_colors.append("rgba(37,99,235,0.15)")
                elif close_vals[i] >= close_vals[i - 1]:
                    vol_colors.append("rgba(37,99,235,0.15)")
                else:
                    vol_colors.append("rgba(16,185,129,0.12)")
            fig.add_trace(go.Bar(
                x=plot_hist.index, y=plot_hist["Volume"],
                name="Volume", yaxis="y2",
                marker_color=vol_colors,
            ))
            fig.update_layout(
                yaxis2=dict(overlaying="y", side="right", showgrid=False,
                            title=dict(text="Volume", font=dict(size=10, color="#9CA3AF")),
                            tickformat=".2s", tickfont=dict(size=8, color="#9CA3AF")),
            )
        # Moving Average Overlays
        show_ma = st.checkbox("Show Moving Averages", value=True, key="show_ma")
        if show_ma and len(plot_hist) > 50:
            ma_50 = plot_hist["Close"].rolling(50).mean()
            ma_200 = plot_hist["Close"].rolling(200).mean()
            
            fig.add_trace(go.Scatter(
                x=plot_hist.index, y=ma_50, mode="lines",
                line=dict(color="#F59E0B", width=1.5, dash="dot"),
                name="50-day MA", showlegend=True,
            ))
            if len(plot_hist) > 200:
                fig.add_trace(go.Scatter(
                    x=plot_hist.index, y=ma_200, mode="lines",
                    line=dict(color="#10B981", width=1.5, dash="dash"),
                    name="200-day MA", showlegend=True,
                ))
                
                # Detect Golden/Death Cross with date
                if not ma_50.dropna().empty and not ma_200.dropna().empty:
                    # Find all crossover points
                    _ma_diff = ma_50 - ma_200
                    _ma_diff_clean = _ma_diff.dropna()
                    _cross_type = None
                    _cross_date = None
                    if len(_ma_diff_clean) > 1:
                        for i in range(len(_ma_diff_clean) - 1, 0, -1):
                            if _ma_diff_clean.iloc[i] > 0 and _ma_diff_clean.iloc[i - 1] <= 0:
                                _cross_type = "golden"
                                _cross_date = _ma_diff_clean.index[i]
                                break
                            elif _ma_diff_clean.iloc[i] < 0 and _ma_diff_clean.iloc[i - 1] >= 0:
                                _cross_type = "death"
                                _cross_date = _ma_diff_clean.index[i]
                                break

                    if _cross_type == "golden":
                        _cd_str = _cross_date.strftime("%b %d, %Y") if hasattr(_cross_date, 'strftime') else str(_cross_date)[:10]
                        st.markdown(
                            f'<div style="text-align:center; padding:0.4rem; background:rgba(16,185,129,0.1); '
                            f'border-radius:8px; border:1px solid rgba(16,185,129,0.3); margin-bottom:0.5rem;">'
                            f'<span style="font-size:0.8rem; font-weight:700; color:#10B981;">âœ¨ Golden Cross â€” Bullish Signal</span>'
                            f'<span style="font-size:0.7rem; color:#9CA3AF; margin-left:0.5rem;">({_cd_str})</span>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )
                    elif _cross_type == "death":
                        _cd_str = _cross_date.strftime("%b %d, %Y") if hasattr(_cross_date, 'strftime') else str(_cross_date)[:10]
                        st.markdown(
                            f'<div style="text-align:center; padding:0.4rem; background:rgba(239,68,68,0.1); '
                            f'border-radius:8px; border:1px solid rgba(239,68,68,0.3); margin-bottom:0.5rem;">'
                            f'<span style="font-size:0.8rem; font-weight:700; color:#EF4444;">ğŸ’€ Death Cross â€” Bearish Signal</span>'
                            f'<span style="font-size:0.7rem; color:#9CA3AF; margin-left:0.5rem;">({_cd_str})</span>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )
        
        # Fibonacci Retracement Levels
        show_fib = st.checkbox("Show Fibonacci Retracement", value=False, key="show_fib")
        if show_fib and len(plot_hist) > 10:
            fib_high = plot_hist["Close"].max()
            fib_low = plot_hist["Close"].min()
            fib_diff = fib_high - fib_low
            fib_levels = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0]
            fib_colors = ["#EF4444", "#F59E0B", "#F5A623", "#9CA3AF", "#10B981", "#3B82F6", "#2563EB"]
            for lvl, clr in zip(fib_levels, fib_colors):
                fib_price = fib_high - fib_diff * lvl
                fig.add_hline(
                    y=fib_price, line_dash="dot", line_color=clr, line_width=1,
                    annotation_text=f"Fib {lvl:.1%} ({cs}{fib_price:.2f})",
                    annotation_position="bottom right",
                    annotation_font=dict(size=7, color=clr),
                )

        # Volume Profile (horizontal volume bars)
        show_vol_profile = st.checkbox("Show Volume Profile", value=False, key="show_vol_profile")
        if show_vol_profile and "Volume" in plot_hist.columns and len(plot_hist) > 10:
            price_min = plot_hist["Close"].min()
            price_max = plot_hist["Close"].max()
            n_bins = 30
            bin_edges = np.linspace(price_min, price_max, n_bins + 1)
            vol_profile = np.zeros(n_bins)
            for i in range(n_bins):
                mask = (plot_hist["Close"] >= bin_edges[i]) & (plot_hist["Close"] < bin_edges[i + 1])
                vol_profile[i] = plot_hist.loc[mask, "Volume"].sum()
            # Normalize to fit on right side (max = 15% of date range)
            if vol_profile.max() > 0:
                vol_norm = vol_profile / vol_profile.max()
                x_start = plot_hist.index[-1]
                x_range_days = (plot_hist.index[-1] - plot_hist.index[0]).days
                for i in range(n_bins):
                    bin_mid = (bin_edges[i] + bin_edges[i + 1]) / 2
                    bar_width = (bin_edges[1] - bin_edges[0]) * 0.8
                    opacity = 0.15 + 0.35 * vol_norm[i]
                    fig.add_shape(
                        type="rect",
                        x0=x_start, x1=x_start + pd.Timedelta(days=int(x_range_days * 0.12 * vol_norm[i])),
                        y0=bin_mid - bar_width / 2, y1=bin_mid + bar_width / 2,
                        fillcolor=f"rgba(37,99,235,{opacity:.2f})",
                        line=dict(width=0),
                        layer="below",
                    )

        # Support/Resistance overlay on price chart
        show_sr = st.checkbox("Show Support / Resistance", value=False, key="show_sr_price")
        if show_sr and len(plot_hist) > 30:
            try:
                def _find_extrema(arr, order=5):
                    _mn, _mx = [], []
                    for i in range(order, len(arr) - order):
                        if all(arr[i] <= arr[i-j] for j in range(1, order+1)) and all(arr[i] <= arr[i+j] for j in range(1, order+1)):
                            _mn.append(i)
                        if all(arr[i] >= arr[i-j] for j in range(1, order+1)) and all(arr[i] >= arr[i+j] for j in range(1, order+1)):
                            _mx.append(i)
                    return _mn, _mx
                _sr_close = plot_hist["Close"]
                _sr_supports = []
                _sr_resistances = []
                for _sr_w in [30, 60, 90]:
                    if len(_sr_close) > _sr_w:
                        _sr_seg = _sr_close.iloc[-_sr_w:]
                        _min_i, _max_i = _find_extrema(_sr_seg.values, order=5)
                        for _ii in _min_i:
                            _sr_supports.append(_sr_seg.iloc[_ii])
                        for _ii in _max_i:
                            _sr_resistances.append(_sr_seg.iloc[_ii])
                _sr_cp = _sr_close.iloc[-1]
                _sr_supports = sorted(set(s for s in _sr_supports if s < _sr_cp))[-3:]
                _sr_resistances = sorted(set(r for r in _sr_resistances if r > _sr_cp))[:3]
                for _sv in _sr_supports:
                    fig.add_hline(y=_sv, line_dash="dot", line_color="rgba(16,185,129,0.4)", line_width=1,
                                  annotation_text=f"S:{cs}{_sv:,.1f}", annotation_position="bottom left",
                                  annotation_font=dict(size=7, color="#10B981"))
                for _rv in _sr_resistances:
                    fig.add_hline(y=_rv, line_dash="dot", line_color="rgba(239,68,68,0.4)", line_width=1,
                                  annotation_text=f"R:{cs}{_rv:,.1f}", annotation_position="top left",
                                  annotation_font=dict(size=7, color="#EF4444"))
            except Exception:
                pass

        # 52-week high/low reference lines
        if cd.fifty_two_week_high:
            fig.add_hline(y=cd.fifty_two_week_high, line_dash="dash",
                         line_color="rgba(16,185,129,0.3)", line_width=1,
                         annotation_text="52w High", annotation_position="bottom right",
                         annotation_font=dict(size=8, color="#10B981"))
        if cd.fifty_two_week_low:
            fig.add_hline(y=cd.fifty_two_week_low, line_dash="dash",
                         line_color="rgba(239,68,68,0.3)", line_width=1,
                         annotation_text="52w Low", annotation_position="top right",
                         annotation_font=dict(size=8, color="#EF4444"))
        fig.update_layout(
            **_CHART_LAYOUT_BASE,
            height=550,
            margin=dict(t=20, b=40, l=60, r=60),
            xaxis=dict(showgrid=False, tickfont=dict(size=12, color="#9CA3AF"), rangeslider=dict(visible=False)),
            yaxis=dict(
                title=dict(text=f"Price ({cs})", font=dict(size=13, color="#9CA3AF")),
                tickfont=dict(size=12, color="#9CA3AF"),
                tickprefix=cs,
            ),
            showlegend=True,
            legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1,
                       font=dict(size=9, color="#9CA3AF")),
        )
        _apply_space_grid(fig)
        st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
        st.plotly_chart(fig, use_container_width=True)
        st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.info("Price history not available.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4b. TECHNICAL ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Technical Analysis")
    
    ta_hist = cd.hist_1y if cd.hist_1y is not None and not cd.hist_1y.empty else hist
    if ta_hist is not None and not ta_hist.empty and len(ta_hist) > 20:
        ta_tab1, ta_tab2, ta_tab3, ta_tab4, ta_tab5 = st.tabs(["RSI", "MACD", "Bollinger Bands", "Momentum Score", "Support / Resistance"])
        
        close = ta_hist["Close"]
        
        # RSI
        with ta_tab1:
            delta = close.diff()
            gain = delta.where(delta > 0, 0).rolling(14).mean()
            loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
            rs = gain / loss
            rsi = 100 - (100 / (1 + rs))
            
            fig_rsi = go.Figure()
            fig_rsi.add_trace(go.Scatter(
                x=ta_hist.index, y=rsi, mode="lines",
                line=dict(color="#2563EB", width=2), name="RSI (14)"
            ))
            fig_rsi.add_hline(y=70, line_dash="dash", line_color="rgba(239,68,68,0.5)", line_width=1,
                             annotation_text="Overbought (70)", annotation_font=dict(size=9, color="#EF4444"))
            fig_rsi.add_hline(y=30, line_dash="dash", line_color="rgba(16,185,129,0.5)", line_width=1,
                             annotation_text="Oversold (30)", annotation_font=dict(size=9, color="#10B981"))
            fig_rsi.add_hrect(y0=70, y1=100, fillcolor="rgba(239,68,68,0.05)", line_width=0)
            fig_rsi.add_hrect(y0=0, y1=30, fillcolor="rgba(16,185,129,0.05)", line_width=0)
            fig_rsi.update_layout(
                **_CHART_LAYOUT_BASE, height=300,
                margin=dict(t=20, b=30, l=50, r=30),
                yaxis=dict(range=[0, 100], tickfont=dict(size=10, color="#9CA3AF"),
                          title=dict(text="RSI", font=dict(size=11, color="#9CA3AF"))),
                xaxis=dict(showgrid=False, tickfont=dict(size=10, color="#9CA3AF")),
                showlegend=False,
            )
            _apply_space_grid(fig_rsi)
            
            # Current RSI value
            current_rsi = rsi.dropna().iloc[-1] if not rsi.dropna().empty else 50
            rsi_color = "#EF4444" if current_rsi > 70 else "#10B981" if current_rsi < 30 else "#F59E0B"
            rsi_label = "Overbought" if current_rsi > 70 else "Oversold" if current_rsi < 30 else "Neutral"
            st.markdown(
                f'<div style="text-align:center; margin-bottom:0.5rem;">'
                f'<span style="font-size:1.5rem; font-weight:800; color:{rsi_color};">{current_rsi:.1f}</span>'
                f'<span style="font-size:0.8rem; color:{rsi_color}; margin-left:0.5rem;">{rsi_label}</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
            st.plotly_chart(fig_rsi, use_container_width=True, key="rsi_chart")
        
        # MACD
        with ta_tab2:
            ema_12 = close.ewm(span=12, adjust=False).mean()
            ema_26 = close.ewm(span=26, adjust=False).mean()
            macd_line = ema_12 - ema_26
            signal_line = macd_line.ewm(span=9, adjust=False).mean()
            macd_hist = macd_line - signal_line
            
            fig_macd = go.Figure()
            # Histogram bars
            colors = ["#10B981" if v >= 0 else "#EF4444" for v in macd_hist.values]
            fig_macd.add_trace(go.Bar(
                x=ta_hist.index, y=macd_hist, name="Histogram",
                marker_color=colors, opacity=0.5
            ))
            fig_macd.add_trace(go.Scatter(
                x=ta_hist.index, y=macd_line, mode="lines",
                line=dict(color="#2563EB", width=2), name="MACD"
            ))
            fig_macd.add_trace(go.Scatter(
                x=ta_hist.index, y=signal_line, mode="lines",
                line=dict(color="#10B981", width=1.5), name="Signal"
            ))
            fig_macd.update_layout(
                **_CHART_LAYOUT_BASE, height=300,
                margin=dict(t=20, b=30, l=50, r=30),
                yaxis=dict(tickfont=dict(size=10, color="#9CA3AF"),
                          title=dict(text="MACD", font=dict(size=11, color="#9CA3AF"))),
                xaxis=dict(showgrid=False, tickfont=dict(size=10, color="#9CA3AF")),
                legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1,
                           font=dict(size=9, color="#9CA3AF")),
            )
            _apply_space_grid(fig_macd)
            
            # Signal
            current_macd = macd_line.iloc[-1]
            current_signal = signal_line.iloc[-1]
            macd_verdict = "Bullish" if current_macd > current_signal else "Bearish"
            mv_color = "#10B981" if current_macd > current_signal else "#EF4444"
            st.markdown(
                f'<div style="text-align:center; margin-bottom:0.5rem;">'
                f'<span style="font-size:0.85rem; font-weight:700; color:{mv_color};">Signal: {macd_verdict}</span>'
                f'<span style="font-size:0.7rem; color:#9CA3AF; margin-left:0.5rem;">'
                f'MACD: {current_macd:.3f} | Signal: {current_signal:.3f}</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
            st.plotly_chart(fig_macd, use_container_width=True, key="macd_chart")
        
        # Bollinger Bands
        with ta_tab3:
            sma_20 = close.rolling(20).mean()
            std_20 = close.rolling(20).std()
            upper_band = sma_20 + (std_20 * 2)
            lower_band = sma_20 - (std_20 * 2)
            
            fig_bb = go.Figure()
            fig_bb.add_trace(go.Scatter(
                x=ta_hist.index, y=upper_band, mode="lines",
                line=dict(color="rgba(37,99,235,0.4)", width=1), name="Upper Band",
            ))
            fig_bb.add_trace(go.Scatter(
                x=ta_hist.index, y=lower_band, mode="lines",
                line=dict(color="rgba(37,99,235,0.4)", width=1), name="Lower Band",
                fill="tonexty", fillcolor="rgba(37,99,235,0.05)",
            ))
            fig_bb.add_trace(go.Scatter(
                x=ta_hist.index, y=sma_20, mode="lines",
                line=dict(color="#F59E0B", width=1.5, dash="dash"), name="SMA 20",
            ))
            fig_bb.add_trace(go.Scatter(
                x=ta_hist.index, y=close, mode="lines",
                line=dict(color="#F9FAFB", width=2), name="Price",
            ))
            fig_bb.update_layout(
                **_CHART_LAYOUT_BASE, height=400,
                margin=dict(t=20, b=30, l=50, r=30),
                yaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), tickprefix=cs,
                          title=dict(text=f"Price ({cs})", font=dict(size=11, color="#9CA3AF"))),
                xaxis=dict(showgrid=False, tickfont=dict(size=10, color="#9CA3AF")),
                legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1,
                           font=dict(size=9, color="#9CA3AF")),
            )
            _apply_space_grid(fig_bb)
            
            # Band position
            if not sma_20.dropna().empty and not upper_band.dropna().empty and not lower_band.dropna().empty:
                curr_price = close.iloc[-1]
                curr_upper = upper_band.dropna().iloc[-1]
                curr_lower = lower_band.dropna().iloc[-1]
                band_width = curr_upper - curr_lower
                band_pct = ((curr_price - curr_lower) / band_width * 100) if band_width > 0 else 50
                bp_color = "#EF4444" if band_pct > 80 else "#10B981" if band_pct < 20 else "#F59E0B"
                st.markdown(
                    f'<div style="text-align:center; margin-bottom:0.5rem;">'
                    f'<span style="font-size:0.85rem; font-weight:700; color:{bp_color};">'
                    f'Band Position: {band_pct:.0f}%</span>'
                    f'<span style="font-size:0.7rem; color:#9CA3AF; margin-left:0.5rem;">'
                    f'(0%=Lower, 100%=Upper)</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            st.plotly_chart(fig_bb, use_container_width=True, key="bb_chart")

        # Momentum Score
        with ta_tab4:
            with _safe_section("Momentum Score"):
                # Compute component scores (each 0-100)
                # RSI component
                delta_m = close.diff()
                gain_m = delta_m.where(delta_m > 0, 0).rolling(14).mean()
                loss_m = (-delta_m.where(delta_m < 0, 0)).rolling(14).mean()
                rs_m = gain_m / loss_m
                rsi_m = 100 - (100 / (1 + rs_m))
                current_rsi_m = rsi_m.dropna().iloc[-1] if not rsi_m.dropna().empty else 50
                # RSI score: 0=oversold(strong buy), 100=overbought(strong sell), invert so high=bullish
                rsi_score = max(0, min(100, 100 - current_rsi_m))

                # MACD component
                ema12_m = close.ewm(span=12, adjust=False).mean()
                ema26_m = close.ewm(span=26, adjust=False).mean()
                macd_m = ema12_m - ema26_m
                signal_m = macd_m.ewm(span=9, adjust=False).mean()
                macd_diff = macd_m.iloc[-1] - signal_m.iloc[-1]
                macd_score = max(0, min(100, 50 + macd_diff / (close.iloc[-1] * 0.01) * 25))

                # Price vs moving averages
                ma50_m = close.rolling(50).mean()
                ma200_m = close.rolling(200).mean()
                ma_score = 50.0
                if not ma50_m.dropna().empty:
                    above_50 = 25 if close.iloc[-1] > ma50_m.dropna().iloc[-1] else -25
                else:
                    above_50 = 0
                if not ma200_m.dropna().empty:
                    above_200 = 25 if close.iloc[-1] > ma200_m.dropna().iloc[-1] else -25
                else:
                    above_200 = 0
                ma_score = max(0, min(100, 50 + above_50 + above_200))

                # Volume trend (rising vol = bullish confirmation)
                vol_score = 50.0
                if "Volume" in ta_hist.columns and len(ta_hist) > 20:
                    vol_20 = ta_hist["Volume"].rolling(20).mean()
                    vol_5 = ta_hist["Volume"].rolling(5).mean()
                    if not vol_20.dropna().empty and not vol_5.dropna().empty:
                        vr = vol_5.dropna().iloc[-1] / vol_20.dropna().iloc[-1] if vol_20.dropna().iloc[-1] > 0 else 1
                        # If price rising + vol rising â†’ bullish
                        price_rising = close.iloc[-1] > close.iloc[-5] if len(close) > 5 else True
                        if price_rising:
                            vol_score = max(0, min(100, 50 + (vr - 1) * 50))
                        else:
                            vol_score = max(0, min(100, 50 - (vr - 1) * 50))

                # Composite
                momentum = rsi_score * 0.25 + macd_score * 0.30 + ma_score * 0.30 + vol_score * 0.15
                momentum = max(0, min(100, momentum))

                if momentum >= 80:
                    m_label, m_color = "Strong Buy", "#10B981"
                elif momentum >= 60:
                    m_label, m_color = "Buy", "#34D399"
                elif momentum >= 40:
                    m_label, m_color = "Neutral", "#F59E0B"
                elif momentum >= 20:
                    m_label, m_color = "Sell", "#F87171"
                else:
                    m_label, m_color = "Strong Sell", "#EF4444"

                # Gauge chart
                fig_gauge = go.Figure(go.Indicator(
                    mode="gauge+number",
                    value=momentum,
                    number=dict(font=dict(size=36, color=m_color)),
                    title=dict(text=m_label, font=dict(size=16, color=m_color)),
                    gauge=dict(
                        axis=dict(range=[0, 100], tickwidth=1, tickcolor="#9CA3AF",
                                  tickfont=dict(size=10, color="#9CA3AF")),
                        bar=dict(color=m_color, thickness=0.3),
                        bgcolor="rgba(0,0,0,0)",
                        borderwidth=0,
                        steps=[
                            dict(range=[0, 20], color="rgba(239,68,68,0.15)"),
                            dict(range=[20, 40], color="rgba(248,113,113,0.1)"),
                            dict(range=[40, 60], color="rgba(245,158,11,0.1)"),
                            dict(range=[60, 80], color="rgba(52,211,153,0.1)"),
                            dict(range=[80, 100], color="rgba(16,185,129,0.15)"),
                        ],
                        threshold=dict(line=dict(color=m_color, width=3), thickness=0.75, value=momentum),
                    ),
                ))
                fig_gauge.update_layout(
                    **_CHART_LAYOUT_BASE, height=300,
                    margin=dict(t=40, b=20, l=40, r=40),
                )
                st.plotly_chart(fig_gauge, use_container_width=True, key="momentum_gauge")

                # Component breakdown
                st.markdown(
                    f'<div style="font-size:0.72rem; color:#9CA3AF; text-align:center;">'
                    f'RSI: {rsi_score:.0f} Â· MACD: {macd_score:.0f} Â· MA: {ma_score:.0f} Â· Volume: {vol_score:.0f}'
                    f'</div>',
                    unsafe_allow_html=True,
                )

        # Support / Resistance
        with ta_tab5:
            with _safe_section("Support / Resistance"):
                def _local_extrema(arr, order=5):
                    """Find local min/max indices without scipy."""
                    mins, maxs = [], []
                    for i in range(order, len(arr) - order):
                        if all(arr[i] <= arr[i - j] for j in range(1, order + 1)) and all(arr[i] <= arr[i + j] for j in range(1, order + 1)):
                            mins.append(i)
                        if all(arr[i] >= arr[i - j] for j in range(1, order + 1)) and all(arr[i] >= arr[i + j] for j in range(1, order + 1)):
                            maxs.append(i)
                    return mins, maxs

                curr_price_sr = close.iloc[-1]
                supports = []
                resistances = []

                for window in [30, 60, 90]:
                    if len(close) > window:
                        _seg = close.iloc[-window:]
                        min_idx, max_idx = _local_extrema(_seg.values, order=5)
                        for idx in min_idx:
                            supports.append(_seg.iloc[idx])
                        for idx in max_idx:
                            resistances.append(_seg.iloc[idx])

                # Deduplicate: cluster nearby levels (within 1.5%)
                def _cluster_levels(levels, threshold=0.015):
                    if not levels:
                        return []
                    levels = sorted(set(levels))
                    clustered = [levels[0]]
                    for lv in levels[1:]:
                        if abs(lv - clustered[-1]) / clustered[-1] > threshold:
                            clustered.append(lv)
                        else:
                            clustered[-1] = (clustered[-1] + lv) / 2
                    return clustered

                supports = [s for s in _cluster_levels(supports) if s < curr_price_sr]
                resistances = [r for r in _cluster_levels(resistances) if r > curr_price_sr]

                # Chart with levels
                fig_sr = go.Figure()
                _glow_line_traces(fig_sr, ta_hist.index, close, "#2563EB", "Price")

                for s in supports[-5:]:
                    fig_sr.add_hline(y=s, line_dash="dash", line_color="rgba(16,185,129,0.5)", line_width=1,
                                     annotation_text=f"S: {cs}{s:,.2f}", annotation_position="bottom right",
                                     annotation_font=dict(size=8, color="#10B981"))
                for r in resistances[:5]:
                    fig_sr.add_hline(y=r, line_dash="dash", line_color="rgba(239,68,68,0.5)", line_width=1,
                                     annotation_text=f"R: {cs}{r:,.2f}", annotation_position="top right",
                                     annotation_font=dict(size=8, color="#EF4444"))

                fig_sr.update_layout(
                    **_CHART_LAYOUT_BASE, height=400,
                    margin=dict(t=20, b=30, l=50, r=30),
                    yaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), tickprefix=cs,
                               title=dict(text=f"Price ({cs})", font=dict(size=11, color="#9CA3AF"))),
                    xaxis=dict(showgrid=False, tickfont=dict(size=10, color="#9CA3AF")),
                    showlegend=False,
                )
                _apply_space_grid(fig_sr)
                st.plotly_chart(fig_sr, use_container_width=True, key="sr_chart")

                # Distance summary
                nearest_support = max(supports) if supports else None
                nearest_resistance = min(resistances) if resistances else None

                sr_cols = st.columns(2)
                with sr_cols[0]:
                    if nearest_support:
                        dist_s = (curr_price_sr - nearest_support) / curr_price_sr * 100
                        st.markdown(
                            f'<div style="text-align:center; padding:0.4rem; background:rgba(16,185,129,0.08); border-radius:8px;">'
                            f'<div style="font-size:0.7rem; color:#9CA3AF;">Nearest Support</div>'
                            f'<div style="font-size:1.1rem; font-weight:700; color:#10B981;">{cs}{nearest_support:,.2f}</div>'
                            f'<div style="font-size:0.7rem; color:#10B981;">{dist_s:.1f}% below</div>'
                            f'</div>', unsafe_allow_html=True,
                        )
                    else:
                        st.info("No support levels detected")
                with sr_cols[1]:
                    if nearest_resistance:
                        dist_r = (nearest_resistance - curr_price_sr) / curr_price_sr * 100
                        st.markdown(
                            f'<div style="text-align:center; padding:0.4rem; background:rgba(239,68,68,0.08); border-radius:8px;">'
                            f'<div style="font-size:0.7rem; color:#9CA3AF;">Nearest Resistance</div>'
                            f'<div style="font-size:1.1rem; font-weight:700; color:#EF4444;">{cs}{nearest_resistance:,.2f}</div>'
                            f'<div style="font-size:0.7rem; color:#EF4444;">{dist_r:.1f}% above</div>'
                            f'</div>', unsafe_allow_html=True,
                        )
                    else:
                        st.info("No resistance levels detected")
    else:
        st.info("Insufficient data for technical analysis.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4c. INSTITUTIONAL & INSIDER SUMMARY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Ownership Overview")

    with _safe_section("Ownership Overview"):
        try:
            tk_own = yf.Ticker(cd.ticker)
        except Exception:
            tk_own = None

        own_col1, own_col2 = st.columns(2)

        with own_col1:
            # Institutional holders â€” enhanced
            try:
                inst_holders = tk_own.institutional_holders if tk_own else None
                if inst_holders is not None and not inst_holders.empty:
                    st.markdown(
                        '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; margin-bottom:0.5rem;">'
                        'ğŸ›ï¸ Top 10 Institutional Holders</div>',
                        unsafe_allow_html=True,
                    )

                    # Table display
                    for _, row in inst_holders.head(10).iterrows():
                        holder = row.get("Holder", "Unknown")
                        shares = row.get("Shares", 0)
                        value = row.get("Value", 0)
                        pct = row.get("% Out", row.get("pctHeld", 0))
                        pct_str = f"{pct:.2%}" if isinstance(pct, float) and pct < 1 else f"{pct}"
                        date_rep = row.get("Date Reported", "")
                        date_str = date_rep.strftime("%Y-%m-%d") if hasattr(date_rep, 'strftime') else str(date_rep)[:10] if date_rep else ""
                        val_str = f"${value/1e6:,.0f}M" if value and value >= 1e6 else f"${value:,.0f}" if value else "â€”"
                        st.markdown(
                            f'<div style="display:flex; justify-content:space-between; padding:0.3rem 0; '
                            f'border-bottom:1px solid rgba(255,255,255,0.04); font-size:0.72rem;">'
                            f'<span style="color:#F9FAFB; flex:2.5;">{holder}</span>'
                            f'<span style="color:#9CA3AF; flex:1; text-align:right;">{shares:,.0f}</span>'
                            f'<span style="color:#60A5FA; flex:0.8; text-align:right;">{val_str}</span>'
                            f'<span style="color:#2563EB; flex:0.5; text-align:right; font-weight:600;">{pct_str}</span>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )

                    # Horizontal bar chart of top 10 by % ownership
                    _top10 = inst_holders.head(10).copy()
                    _pct_col = "% Out" if "% Out" in _top10.columns else "pctHeld" if "pctHeld" in _top10.columns else None
                    if _pct_col and _top10[_pct_col].notna().any():
                        fig_inst = go.Figure()
                        _holders = _top10["Holder"].tolist()[::-1]
                        _pcts = _top10[_pct_col].fillna(0).tolist()[::-1]
                        _pcts_display = [p * 100 if p < 1 else p for p in _pcts]
                        fig_inst.add_trace(go.Bar(
                            y=_holders, x=_pcts_display, orientation="h",
                            marker_color="rgba(37,99,235,0.7)",
                            text=[f"{p:.1f}%" for p in _pcts_display],
                            textposition="outside",
                            textfont=dict(size=9, color="#D1D5DB"),
                        ))
                        fig_inst.update_layout(
                            **_CHART_LAYOUT_BASE, height=300,
                            margin=dict(t=10, b=20, l=160, r=50),
                            xaxis=dict(title=dict(text="% Outstanding", font=dict(size=9, color="#9CA3AF")),
                                      ticksuffix="%", tickfont=dict(size=8, color="#9CA3AF"), showgrid=False),
                            yaxis=dict(tickfont=dict(size=8, color="#9CA3AF")),
                            showlegend=False,
                        )
                        _apply_space_grid(fig_inst)
                        st.plotly_chart(fig_inst, use_container_width=True, key="inst_holders_bar")

                    # Total institutional ownership
                    try:
                        major = tk_own.major_holders if tk_own else None
                        if major is not None and not major.empty:
                            for _, row in major.iterrows():
                                val = row.iloc[0] if len(row) > 0 else ""
                                label = str(row.iloc[1]) if len(row) > 1 else ""
                                if "institution" in label.lower() and "hold" in label.lower():
                                    st.markdown(
                                        f'<div style="text-align:center; padding:0.5rem; margin-top:0.5rem; '
                                        f'background:rgba(37,99,235,0.08); border-radius:8px;">'
                                        f'<span style="font-size:0.7rem; color:#9CA3AF;">Total Institutional Ownership: </span>'
                                        f'<span style="font-size:0.9rem; font-weight:700; color:#2563EB;">{val}</span>'
                                        f'</div>',
                                        unsafe_allow_html=True,
                                    )
                                    break
                    except Exception:
                        pass
                else:
                    st.info("No institutional holder data available.")
            except Exception:
                st.info("Could not fetch institutional holders.")

        with own_col2:
            # Major holders summary + Mutual Fund holders + Donut
            try:
                major = tk_own.major_holders if tk_own else None
                if major is not None and not major.empty:
                    st.markdown(
                        '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; margin-bottom:0.5rem;">'
                        'ğŸ“Š Ownership Breakdown</div>',
                        unsafe_allow_html=True,
                    )
                    for _, row in major.iterrows():
                        val = row.iloc[0] if len(row) > 0 else ""
                        label = row.iloc[1] if len(row) > 1 else ""
                        st.markdown(
                            f'<div style="display:flex; justify-content:space-between; padding:0.4rem 0; '
                            f'border-bottom:1px solid rgba(255,255,255,0.04);">'
                            f'<span style="color:#9CA3AF; font-size:0.75rem;">{label}</span>'
                            f'<span style="color:#F9FAFB; font-weight:700; font-size:0.85rem;">{val}</span>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )
                else:
                    st.info("No major holder data available.")
            except Exception:
                st.info("Could not fetch major holders.")

            # Mutual Fund Holders
            try:
                mf_holders = tk_own.mutualfund_holders if tk_own else None
                if mf_holders is not None and not mf_holders.empty:
                    st.markdown(
                        '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; margin-top:1rem; margin-bottom:0.5rem;">'
                        'ğŸ’¼ Top 5 Mutual Fund Holders</div>',
                        unsafe_allow_html=True,
                    )
                    for _, row in mf_holders.head(5).iterrows():
                        holder = row.get("Holder", "Unknown")
                        pct = row.get("% Out", row.get("pctHeld", 0))
                        pct_str = f"{pct:.2%}" if isinstance(pct, float) and pct < 1 else f"{pct}"
                        st.markdown(
                            f'<div style="display:flex; justify-content:space-between; padding:0.25rem 0; '
                            f'border-bottom:1px solid rgba(255,255,255,0.04); font-size:0.72rem;">'
                            f'<span style="color:#F9FAFB; flex:3;">{holder}</span>'
                            f'<span style="color:#2563EB; flex:0.5; text-align:right; font-weight:600;">{pct_str}</span>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )
            except Exception:
                pass

            # Ownership Concentration Donut
            try:
                inst_holders = tk_own.institutional_holders if tk_own else None
                if inst_holders is not None and not inst_holders.empty:
                    _pct_col = "% Out" if "% Out" in inst_holders.columns else "pctHeld" if "pctHeld" in inst_holders.columns else None
                    if _pct_col:
                        _top5_pct = inst_holders.head(5)[_pct_col].fillna(0).tolist()
                        _top5_pct = [p * 100 if p < 1 else p for p in _top5_pct]
                        _top5_names = inst_holders.head(5)["Holder"].tolist()
                        _total_inst = inst_holders[_pct_col].fillna(0).sum()
                        _total_inst = _total_inst * 100 if _total_inst < 1 else _total_inst
                        _rest = max(0, _total_inst - sum(_top5_pct))

                        _labels = [n[:25] for n in _top5_names] + ["Other Institutions"]
                        _values = _top5_pct + [_rest]
                        _colors_donut = ["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6", "#9CA3AF"]

                        fig_donut = go.Figure(data=[go.Pie(
                            labels=_labels, values=_values,
                            hole=0.55, marker=dict(colors=_colors_donut),
                            textinfo="percent", textfont=dict(size=9, color="#F9FAFB"),
                            hovertemplate="%{label}<br>%{value:.1f}%<extra></extra>",
                        )])
                        fig_donut.update_layout(
                            **_CHART_LAYOUT_BASE, height=250,
                            margin=dict(t=10, b=10, l=10, r=10),
                            showlegend=True,
                            legend=dict(font=dict(size=8, color="#9CA3AF"), orientation="h",
                                       yanchor="bottom", y=-0.2, xanchor="center", x=0.5),
                        )
                        st.markdown(
                            '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-top:1rem; margin-bottom:0.3rem;">'
                            'ğŸ© Ownership Concentration (Top 5)</div>',
                            unsafe_allow_html=True,
                        )
                        st.plotly_chart(fig_donut, use_container_width=True, key="ownership_donut")
            except Exception:
                pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4b. SHAREHOLDER ANALYSIS (Deep Dive)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Shareholder Analysis"):
        _section("Shareholder Analysis", "ğŸ›ï¸")
        try:
            _sha_tk = yf.Ticker(cd.ticker)
            _sha_info = _sha_tk.info or {}

            # â”€â”€ Major Holders â”€â”€
            _sha_major = None
            try:
                _sha_major = _sha_tk.major_holders
            except Exception:
                pass

            _sha_insider_pct = None
            _sha_inst_pct = None
            if _sha_major is not None and not _sha_major.empty:
                for _, _sha_row in _sha_major.iterrows():
                    _sha_label = str(_sha_row.iloc[1]).lower() if len(_sha_row) > 1 else ""
                    _sha_val_raw = _sha_row.iloc[0] if len(_sha_row) > 0 else ""
                    try:
                        _sha_val_num = float(str(_sha_val_raw).replace("%", "")) / 100 if "%" in str(_sha_val_raw) else float(_sha_val_raw)
                    except (ValueError, TypeError):
                        _sha_val_num = None
                    if "insider" in _sha_label and _sha_val_num is not None:
                        _sha_insider_pct = _sha_val_num
                    if "institution" in _sha_label and "hold" in _sha_label and _sha_val_num is not None:
                        _sha_inst_pct = _sha_val_num

            # â”€â”€ Short Interest â”€â”€
            _sha_short_pct = _sha_info.get("shortPercentOfFloat", 0) or 0
            _sha_short_ratio = _sha_info.get("shortRatio", 0) or 0
            _sha_shares_short = _sha_info.get("sharesShort", 0) or 0

            # Short interest interpretation
            if _sha_short_pct > 0.20:
                _sha_short_interp = ("ğŸ”´ Very High", "Significant bearish sentiment â€” potential short squeeze candidate", "#EF4444")
            elif _sha_short_pct > 0.10:
                _sha_short_interp = ("ğŸŸ  High", "Elevated bearish positioning â€” watch for squeeze or further downside", "#F5A623")
            elif _sha_short_pct > 0.05:
                _sha_short_interp = ("ğŸŸ¡ Moderate", "Normal level of skepticism â€” not a major concern", "#F5A623")
            else:
                _sha_short_interp = ("ğŸŸ¢ Low", "Minimal bearish positioning â€” market broadly constructive", "#10B981")

            # â”€â”€ Render summary metrics â”€â”€
            _sha_cols = st.columns(4)
            with _sha_cols[0]:
                _v = f"{_sha_inst_pct*100:.1f}%" if _sha_inst_pct else "N/A"
                st.markdown(f'<div style="background:rgba(37,99,235,0.06); border:1px solid rgba(37,99,235,0.15); border-radius:12px; padding:0.8rem; text-align:center;"><div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">Institutional</div><div style="font-size:1.2rem; font-weight:700; color:#2563EB;">{_v}</div></div>', unsafe_allow_html=True)
            with _sha_cols[1]:
                _v = f"{_sha_insider_pct*100:.1f}%" if _sha_insider_pct else "N/A"
                st.markdown(f'<div style="background:rgba(16,185,129,0.06); border:1px solid rgba(16,185,129,0.15); border-radius:12px; padding:0.8rem; text-align:center;"><div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">Insider Ownership</div><div style="font-size:1.2rem; font-weight:700; color:#10B981;">{_v}</div></div>', unsafe_allow_html=True)
            with _sha_cols[2]:
                _v = f"{_sha_short_pct*100:.1f}%" if _sha_short_pct else "N/A"
                st.markdown(f'<div style="background:rgba(239,68,68,0.06); border:1px solid rgba(239,68,68,0.15); border-radius:12px; padding:0.8rem; text-align:center;"><div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">Float Short %</div><div style="font-size:1.2rem; font-weight:700; color:{_sha_short_interp[2]};">{_v}</div></div>', unsafe_allow_html=True)
            with _sha_cols[3]:
                _v = f"{_sha_short_ratio:.1f} days" if _sha_short_ratio else "N/A"
                st.markdown(f'<div style="background:rgba(245,166,35,0.06); border:1px solid rgba(245,166,35,0.15); border-radius:12px; padding:0.8rem; text-align:center;"><div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">Days to Cover</div><div style="font-size:1.2rem; font-weight:700; color:#F5A623;">{_v}</div></div>', unsafe_allow_html=True)

            # Short interest interpretation bar
            st.markdown(
                f'<div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:0.6rem 1rem; margin:0.5rem 0;">'
                f'<span style="font-size:0.75rem; font-weight:700; color:{_sha_short_interp[2]};">{_sha_short_interp[0]}</span>'
                f'<span style="font-size:0.75rem; color:#9CA3AF; margin-left:0.5rem;">{_sha_short_interp[1]}</span></div>',
                unsafe_allow_html=True,
            )

            # â”€â”€ Top 10 Institutional Holders Table â”€â”€
            try:
                _sha_inst = _sha_tk.institutional_holders
                if _sha_inst is not None and not _sha_inst.empty:
                    st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; margin:1rem 0 0.5rem 0;">ğŸ›ï¸ Top 10 Institutional Holders</div>', unsafe_allow_html=True)
                    _sha_header = (
                        '<div style="display:flex; padding:0.4rem 0; border-bottom:2px solid rgba(37,99,235,0.2); font-size:0.65rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:0.5px;">'
                        '<span style="flex:2.5;">Holder</span><span style="flex:1.2; text-align:right;">Shares</span>'
                        '<span style="flex:1; text-align:right;">Value</span><span style="flex:0.8; text-align:right;">% Out</span></div>'
                    )
                    _sha_rows_html = _sha_header
                    for _si, _sha_r in _sha_inst.head(10).iterrows():
                        _h_name = _sha_r.get("Holder", "Unknown")
                        _h_shares = _sha_r.get("Shares", 0)
                        _h_val = _sha_r.get("Value", 0)
                        _h_pct = _sha_r.get("% Out", _sha_r.get("pctHeld", 0))
                        _h_pct_s = f"{_h_pct:.2%}" if isinstance(_h_pct, float) and _h_pct < 1 else f"{_h_pct}"
                        _h_val_s = f"${_h_val/1e9:,.1f}B" if _h_val and _h_val >= 1e9 else f"${_h_val/1e6:,.0f}M" if _h_val and _h_val >= 1e6 else "â€”"
                        _sha_rows_html += (
                            f'<div style="display:flex; padding:0.35rem 0; border-bottom:1px solid rgba(255,255,255,0.04); font-size:0.75rem;">'
                            f'<span style="color:#F9FAFB; flex:2.5;">{_h_name}</span>'
                            f'<span style="color:#D1D5DB; flex:1.2; text-align:right;">{_h_shares:,.0f}</span>'
                            f'<span style="color:#60A5FA; flex:1; text-align:right;">{_h_val_s}</span>'
                            f'<span style="color:#2563EB; flex:0.8; text-align:right; font-weight:600;">{_h_pct_s}</span></div>'
                        )
                    st.markdown(_sha_rows_html, unsafe_allow_html=True)
            except Exception:
                pass

        except Exception as _sha_e:
            st.info(f"Shareholder analysis unavailable: {_sha_e}")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4c. INSTITUTIONAL FLOW TRACKER
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Institutional Flow Tracker"):
        try:
            _ift_tk = yf.Ticker(cd.ticker)
            _ift_inst = _ift_tk.institutional_holders
            if _ift_inst is not None and not _ift_inst.empty and "Date Reported" in _ift_inst.columns:
                _ift_inst["Date Reported"] = pd.to_datetime(_ift_inst["Date Reported"], errors="coerce")
                _ift_inst = _ift_inst.dropna(subset=["Date Reported"])
                if not _ift_inst.empty:
                    _ift_inst["Quarter"] = _ift_inst["Date Reported"].dt.to_period("Q").astype(str)
                    _ift_quarterly = _ift_inst.groupby("Quarter")["Shares"].sum().reset_index()
                    if len(_ift_quarterly) >= 2:
                        _section("Institutional Flow Tracker", "ğŸ“Š")
                        _ift_quarterly["Change"] = _ift_quarterly["Shares"].diff()
                        _ift_quarterly = _ift_quarterly.dropna(subset=["Change"])
                        _ift_colors = ["#10B981" if x >= 0 else "#EF4444" for x in _ift_quarterly["Change"]]
                        fig_ift = go.Figure(go.Bar(
                            x=_ift_quarterly["Quarter"], y=_ift_quarterly["Change"],
                            marker_color=_ift_colors, marker_opacity=0.85,
                            text=[f"{v/1e6:+.1f}M" if abs(v) >= 1e6 else f"{v/1e3:+.0f}K" for v in _ift_quarterly["Change"]],
                            textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
                        ))
                        fig_ift.update_layout(
                            **_CHART_LAYOUT_BASE, height=320,
                            margin=dict(t=30, b=40, l=60, r=30),
                            xaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
                            yaxis=dict(title="Net Share Change", tickfont=dict(size=9, color="#9CA3AF"),
                                      gridcolor="rgba(37,99,235,0.1)", griddash="dot", tickformat=".2s"),
                        )
                        _apply_space_grid(fig_ift)
                        st.plotly_chart(fig_ift, use_container_width=True, key="inst_flow_tracker")
                        _ift_net = _ift_quarterly["Change"].sum()
                        _ift_lbl = "Net Buying" if _ift_net > 0 else "Net Selling"
                        _ift_c = "#10B981" if _ift_net > 0 else "#EF4444"
                        st.markdown(f'<div style="text-align:center; font-size:0.75rem; color:{_ift_c}; font-weight:700;">'
                                    f'{_ift_lbl}: {_ift_net/1e6:+.1f}M shares over period</div>', unsafe_allow_html=True)
        except Exception:
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4d. REVENUE DECOMPOSITION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Revenue Decomposition"):
        try:
            _rd_tk = yf.Ticker(cd.ticker)
            _rd_info = _rd_tk.info or {}
            _rd_summary = _rd_info.get("longBusinessSummary", "") or ""
            _rd_country = _rd_info.get("country", "") or ""

            # Try to get segment revenue from financials
            _rd_shown = False
            try:
                _rd_fin = _rd_tk.financials
                if _rd_fin is not None and not _rd_fin.empty:
                    _rd_revenue_rows = [r for r in _rd_fin.index if "revenue" in str(r).lower() and "total" not in str(r).lower() and "cost" not in str(r).lower()]
                    if len(_rd_revenue_rows) >= 2:
                        _section("Revenue Decomposition", "ğŸ“Š")
                        _rd_seg_data = _rd_fin.loc[_rd_revenue_rows].T
                        _rd_seg_data.index = pd.to_datetime(_rd_seg_data.index, errors="coerce")
                        _rd_seg_data = _rd_seg_data.sort_index()
                        _rd_seg_data.columns = [str(c).replace("Revenue", "").strip() or str(c) for c in _rd_seg_data.columns]
                        fig_rd = go.Figure()
                        _rd_colors = ["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6", "#8B5CF6"]
                        for i, col in enumerate(_rd_seg_data.columns):
                            fig_rd.add_trace(go.Bar(
                                x=_rd_seg_data.index.strftime("%Y"), y=_rd_seg_data[col],
                                name=col, marker_color=_rd_colors[i % len(_rd_colors)],
                            ))
                        fig_rd.update_layout(**_CHART_LAYOUT_BASE, barmode="stack", height=350,
                                            margin=dict(t=30, b=40, l=60, r=30),
                                            xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                                            yaxis=dict(title="Revenue", tickfont=dict(size=9, color="#9CA3AF"),
                                                      gridcolor="rgba(37,99,235,0.1)", tickformat=".2s"),
                                            legend=dict(font=dict(size=9, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02))
                        _apply_space_grid(fig_rd)
                        st.plotly_chart(fig_rd, use_container_width=True, key="rev_decomp")
                        _rd_shown = True
            except Exception:
                pass

            # Fallback: Geographic revenue estimate from business summary
            if not _rd_shown and _rd_summary:
                _rd_regions = []
                _rd_text = _rd_summary.lower()
                if any(w in _rd_text for w in ["united states", "north america", "domestic"]):
                    _rd_regions.append(("North America", 55))
                if any(w in _rd_text for w in ["europe", "emea", "european"]):
                    _rd_regions.append(("Europe", 25))
                if any(w in _rd_text for w in ["asia", "apac", "china", "japan", "pacific"]):
                    _rd_regions.append(("Asia-Pacific", 15))
                if any(w in _rd_text for w in ["latin", "south america", "brazil"]):
                    _rd_regions.append(("Latin America", 5))
                if not _rd_regions:
                    if _rd_country in ["United States", "Canada"]:
                        _rd_regions = [("North America", 60), ("International", 40)]
                    else:
                        _rd_regions = [("Domestic", 55), ("International", 45)]
                if _rd_regions:
                    _section("Geographic Revenue Estimate", "ğŸŒ")
                    st.markdown('<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.5rem;">Estimated based on company description and headquarters location</div>', unsafe_allow_html=True)
                    _rd_total = sum(r[1] for r in _rd_regions)
                    fig_rd_geo = go.Figure(go.Pie(
                        labels=[r[0] for r in _rd_regions],
                        values=[r[1] for r in _rd_regions],
                        hole=0.5,
                        marker=dict(colors=["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6"]),
                        textinfo="label+percent", textfont=dict(size=11, color="#F9FAFB"),
                    ))
                    fig_rd_geo.update_layout(**_CHART_LAYOUT_BASE, height=300, margin=dict(t=20, b=20, l=20, r=20),
                                            showlegend=False)
                    st.plotly_chart(fig_rd_geo, use_container_width=True, key="rev_geo_est")
        except Exception:
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 5. VALUATION DASHBOARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Valuation Dashboard")

    vd1, vd2, vd3, vd4, vd5 = st.columns(5)
    vd1.metric("P/E (TTM)", f"{cd.trailing_pe:.1f}x" if cd.trailing_pe else "N/A")
    vd2.metric("Forward P/E", f"{cd.forward_pe:.1f}x" if cd.forward_pe else "N/A")
    vd3.metric("EV/EBITDA", format_multiple(cd.ev_to_ebitda))
    vd4.metric("P/S (TTM)", f"{cd.price_to_sales:.1f}x" if cd.price_to_sales else "N/A")
    vd5.metric("PEG Ratio", f"{cd.peg_ratio:.2f}" if cd.peg_ratio else "N/A")

    # Premium/Discount vs Peers
    if cd.peer_data:
        st.markdown("<p style='font-size:0.75rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px; margin:0.8rem 0 0.3rem 0;'>Premium / Discount vs. Peer Median</p>", unsafe_allow_html=True)

        def _calc_premium(company_val, peers, key):
            if company_val is None:
                return None
            vals = [p.get(key) for p in peers if p.get(key) is not None]
            if not vals:
                return None
            median = float(np.median(vals))
            if median == 0:
                return None
            return ((company_val - median) / abs(median)) * 100

        premium_items = [
            ("P/E", _calc_premium(cd.trailing_pe, cd.peer_data, "trailing_pe")),
            ("Fwd P/E", _calc_premium(cd.forward_pe, cd.peer_data, "forward_pe")),
            ("EV/EBITDA", _calc_premium(cd.ev_to_ebitda, cd.peer_data, "ev_to_ebitda")),
            ("P/S", _calc_premium(cd.price_to_sales, cd.peer_data, "price_to_sales")),
        ]

        pc_cols = st.columns(4)
        for col, (label, prem) in zip(pc_cols, premium_items):
            if prem is not None:
                word = "Premium" if prem > 0 else "Discount"
                col.metric(f"{label} vs Peers", f"{prem:+.1f}%", delta=word,
                           delta_color="inverse" if prem > 0 else "normal")
            else:
                col.metric(f"{label} vs Peers", "N/A")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 5b. LBO SCREENING METRICS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("LBO Screening Metrics"):
        _section("LBO Screening Metrics", "ğŸ¦")

        # FCF Yield, Debt/EBITDA capacity, Interest Coverage
        _lbo_fcf = None
        if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) > 0:
            _lbo_fcf = float(cd.free_cashflow_series.iloc[0])
        _lbo_mcap = cd.market_cap or 0
        _lbo_fcf_yield = (_lbo_fcf / _lbo_mcap * 100) if _lbo_fcf and _lbo_mcap > 0 else None

        _lbo_ebitda_v = None
        if cd.ebitda is not None:
            if hasattr(cd.ebitda, 'iloc') and len(cd.ebitda) > 0:
                _lbo_ebitda_v = float(cd.ebitda.iloc[0])
            elif isinstance(cd.ebitda, (int, float)) and cd.ebitda > 0:
                _lbo_ebitda_v = float(cd.ebitda)

        _lbo_total_debt = float(cd.total_debt.iloc[0]) if cd.total_debt is not None and len(cd.total_debt) > 0 else 0
        _lbo_debt_ebitda = (_lbo_total_debt / _lbo_ebitda_v) if _lbo_ebitda_v and _lbo_ebitda_v > 0 else None

        _lbo_int_exp = abs(float(cd.interest_expense.iloc[0])) if cd.interest_expense is not None and len(cd.interest_expense) > 0 else 0
        _lbo_op_inc = float(cd.operating_income.iloc[0]) if cd.operating_income is not None and len(cd.operating_income) > 0 else 0
        _lbo_int_cov = (_lbo_op_inc / _lbo_int_exp) if _lbo_int_exp > 0 else None

        _lm1, _lm2, _lm3 = st.columns(3)
        _lm1.metric("FCF Yield", f"{_lbo_fcf_yield:.1f}%" if _lbo_fcf_yield is not None else "N/A",
                     help="Free Cash Flow / Market Cap")
        _lm2.metric("Debt / EBITDA", f"{_lbo_debt_ebitda:.1f}x" if _lbo_debt_ebitda is not None else "N/A",
                     help="Total Debt / LTM EBITDA â€” capacity for leverage")
        _lm3.metric("Interest Coverage", f"{_lbo_int_cov:.1f}x" if _lbo_int_cov is not None else "N/A",
                     help="Operating Income / Interest Expense")

        # LBO Quick Returns Calculator
        if _lbo_ebitda_v and _lbo_ebitda_v > 0:
            with st.expander("ğŸ§® Quick LBO Returns Calculator", expanded=False):
                _lq1, _lq2 = st.columns(2)
                with _lq1:
                    _lq_entry = st.number_input("Entry EV/EBITDA", 4.0, 30.0, float(cd.ev_to_ebitda or 10.0), 0.5, key="prof_lbo_entry")
                    _lq_leverage = st.slider("Debt / Total Capital (%)", 30, 80, 60, 5, key="prof_lbo_lev") / 100.0
                with _lq2:
                    _lq_exit = st.number_input("Exit EV/EBITDA", 4.0, 30.0, float(cd.ev_to_ebitda or 10.0), 0.5, key="prof_lbo_exit")
                    _lq_hold = st.number_input("Hold Period (years)", 3, 10, 5, 1, key="prof_lbo_hold")

                _lq_entry_ev = _lbo_ebitda_v * _lq_entry
                _lq_entry_eq = _lq_entry_ev * (1 - _lq_leverage)
                _lq_exit_ev = _lbo_ebitda_v * 1.05 ** _lq_hold * _lq_exit  # assume 5% EBITDA growth
                _lq_debt = _lq_entry_ev * _lq_leverage
                # Simple: assume 50% of EBITDA as FCF to pay down debt
                _lq_debt_rem = _lq_debt
                _lq_eb = _lbo_ebitda_v
                for _ in range(_lq_hold):
                    _lq_eb *= 1.05
                    _lq_paydown = max(0, _lq_eb * 0.5 - _lq_debt_rem * 0.06)
                    _lq_debt_rem = max(0, _lq_debt_rem - _lq_paydown)
                _lq_exit_eq = _lq_exit_ev - _lq_debt_rem
                _lq_moic = _lq_exit_eq / _lq_entry_eq if _lq_entry_eq > 0 else 0
                _lq_irr = (_lq_moic ** (1.0 / _lq_hold) - 1) if _lq_moic > 0 and _lq_hold > 0 else 0

                _lr1, _lr2, _lr3 = st.columns(3)
                _lr1.metric("MOIC", f"{_lq_moic:.2f}x")
                _irr_c = "#10B981" if _lq_irr > 0.20 else "#F59E0B" if _lq_irr > 0.10 else "#EF4444"
                _lr2.metric("IRR", f"{_lq_irr*100:.1f}%")
                _lr3.metric("Exit Equity", format_number(_lq_exit_eq, currency_symbol=cs))

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 6. PEER COMPARISON
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if cd.peer_data:
        _section("Peer Comparison")

        peer_rows = []
        peer_rows.append({
            "Company": f"{cd.name} \u2605",
            "Ticker": cd.ticker,
            "Mkt Cap": format_number(cd.market_cap, currency_symbol=cs),
            "P/E": f"{cd.trailing_pe:.1f}" if cd.trailing_pe else "N/A",
            "Fwd P/E": f"{cd.forward_pe:.1f}" if cd.forward_pe else "N/A",
            "EV/EBITDA": format_multiple(cd.ev_to_ebitda),
            "P/S": f"{cd.price_to_sales:.1f}" if cd.price_to_sales else "N/A",
            "Gross Margin": format_pct(cd.gross_margins),
            "Op Margin": format_pct(cd.operating_margins),
            "ROE": format_pct(cd.return_on_equity),
        })
        for p in cd.peer_data:
            peer_rows.append({
                "Company": p.get("name", p.get("ticker", "")),
                "Ticker": p.get("ticker", ""),
                "Mkt Cap": format_number(p.get("market_cap"), currency_symbol=cs),
                "P/E": f"{p['trailing_pe']:.1f}" if p.get("trailing_pe") else "N/A",
                "Fwd P/E": f"{p['forward_pe']:.1f}" if p.get("forward_pe") else "N/A",
                "EV/EBITDA": format_multiple(p.get("ev_to_ebitda")),
                "P/S": f"{p['price_to_sales']:.1f}" if p.get("price_to_sales") else "N/A",
                "Gross Margin": format_pct(p.get("gross_margins")),
                "Op Margin": format_pct(p.get("operating_margins")),
                "ROE": format_pct(p.get("return_on_equity")),
            })

        peer_df = pd.DataFrame(peer_rows)

        def _highlight_target(row):
            if row["Ticker"] == cd.ticker:
                return ["background-color: rgba(37,99,235,0.1); font-weight: bold"] * len(row)
            return [""] * len(row)

        styled = peer_df.style.apply(_highlight_target, axis=1)
        st.dataframe(styled, use_container_width=True, hide_index=True, height=300)

        # Radar chart
        rc1, rc2 = st.columns([3, 2])
        with rc1:
            st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
            _build_peer_radar_chart(cd)
            st.markdown('</div>', unsafe_allow_html=True)
        with rc2:
            st.markdown("")
            st.markdown("<p style='font-size:0.85rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;'>Peer Group</p>", unsafe_allow_html=True)
            for p in cd.peer_data:
                st.markdown(
                    f"<div style='font-size:0.82rem; color:#D1D5DB; padding:0.2rem 0;'>"
                    f"<span style='font-weight:600; color:#60A5FA;'>{p['ticker']}</span> &mdash; {p.get('name', '')}"
                    f"</div>",
                    unsafe_allow_html=True,
                )
            st.markdown(f"<div style='font-size:0.7rem; color:#9CA3AF; margin-top:0.5rem;'>Industry: {cd.industry}</div>", unsafe_allow_html=True)

        # Percentile Ranking
        try:
            st.markdown(
                '<div style="font-size:0.85rem; font-weight:700; color:#F9FAFB; margin:1rem 0 0.5rem 0;">'
                'ğŸ“Š Percentile Ranking vs Peers</div>',
                unsafe_allow_html=True,
            )
            
            ranking_metrics = [
                ("Market Cap", cd.market_cap, "market_cap", False),
                ("P/E Ratio", cd.trailing_pe, "trailing_pe", True),  # Lower is better
                ("EV/EBITDA", cd.ev_to_ebitda, "ev_to_ebitda", True),
                ("Gross Margin", cd.gross_margins, "gross_margins", False),
                ("Op Margin", cd.operating_margins, "operating_margins", False),
                ("ROE", cd.return_on_equity, "return_on_equity", False),
                ("Rev Growth", cd.revenue_growth, "revenue_growth", False),
            ]
            
            rank_html = '<div style="display:grid; gap:0.5rem;">'
            for label, company_val, key, lower_better in ranking_metrics:
                if company_val is None:
                    continue
                peer_vals = [p.get(key) for p in cd.peer_data if p.get(key) is not None]
                if not peer_vals:
                    continue
                
                all_vals = sorted(peer_vals + [company_val], reverse=not lower_better)
                rank = all_vals.index(company_val) + 1
                pctile = (1 - (rank - 1) / len(all_vals)) * 100
                
                bar_color = "#10B981" if pctile >= 70 else "#F59E0B" if pctile >= 40 else "#EF4444"
                
                rank_html += (
                    f'<div style="display:flex; align-items:center; gap:0.5rem;">'
                    f'<span style="font-size:0.7rem; color:#9CA3AF; width:80px; flex-shrink:0;">{label}</span>'
                    f'<div style="flex:1; background:rgba(255,255,255,0.05); border-radius:4px; height:14px; overflow:hidden;">'
                    f'<div style="width:{pctile}%; height:100%; background:{bar_color}; border-radius:4px;"></div></div>'
                    f'<span style="font-size:0.65rem; color:{bar_color}; font-weight:700; width:40px; text-align:right;">'
                    f'{pctile:.0f}%</span>'
                    f'</div>'
                )
            
            rank_html += '</div>'
            st.markdown(rank_html, unsafe_allow_html=True)
            st.markdown(
                '<div style="font-size:0.6rem; color:#5A567A; margin-top:0.3rem;">Higher = better ranking among peers</div>',
                unsafe_allow_html=True,
            )
        except Exception:
            pass

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 7. KEY STATISTICS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Key Statistics")

    st.markdown("<p style='font-size:0.75rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px; margin:0.5rem 0 0.3rem 0;'>Valuation</p>", unsafe_allow_html=True)
    v1, v2, v3, v4, v5 = st.columns(5)
    v1.metric("P/E (TTM)", f"{cd.trailing_pe:.1f}" if cd.trailing_pe else "N/A")
    v2.metric("Forward P/E", f"{cd.forward_pe:.1f}" if cd.forward_pe else "N/A")
    v3.metric("PEG Ratio", f"{cd.peg_ratio:.2f}" if cd.peg_ratio else "N/A")
    v4.metric("EV/EBITDA", format_multiple(cd.ev_to_ebitda))
    v5.metric("EV/Revenue", format_multiple(cd.ev_to_revenue))

    st.markdown("<p style='font-size:0.75rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px; margin:0.8rem 0 0.3rem 0;'>Profitability</p>", unsafe_allow_html=True)
    p1, p2, p3, p4, p5 = st.columns(5)
    p1.metric("Gross Margin", format_pct(cd.gross_margins))
    p2.metric("Op. Margin", format_pct(cd.operating_margins))
    p3.metric("Net Margin", format_pct(cd.profit_margins))
    p4.metric("ROE", format_pct(cd.return_on_equity))
    p5.metric("ROA", format_pct(cd.return_on_assets))

    st.markdown("<p style='font-size:0.75rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px; margin:0.8rem 0 0.3rem 0;'>Financial Health</p>", unsafe_allow_html=True)
    f1, f2, f3, f4, f5 = st.columns(5)
    f1.metric("P/S (TTM)", f"{cd.price_to_sales:.2f}" if cd.price_to_sales else "N/A")
    f2.metric("Price/Book", f"{cd.price_to_book:.2f}" if cd.price_to_book else "N/A")
    f3.metric("Current Ratio", f"{cd.current_ratio:.2f}" if cd.current_ratio else "N/A")
    f4.metric("D/E Ratio", f"{cd.debt_to_equity / 100:.2f}x" if cd.debt_to_equity else "N/A")
    f5.metric("Beta", f"{cd.beta:.2f}" if cd.beta else "N/A")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 8. FINANCIAL STATEMENTS (formatted)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Financial Statements")

    # Financial Summary Trend Table (4 years)
    with _safe_section("Financial Summary Trend"):
        _years_avail = min(4, len(cd.revenue)) if cd.revenue is not None and len(cd.revenue) > 0 else 0
        if _years_avail >= 2:
            _trend_rows = []
            _trend_cols = []

            for i in range(_years_avail):
                yr_label = str(cd.revenue.index[i])[:4] if hasattr(cd.revenue.index[i], 'year') else str(cd.revenue.index[i])[:4]
                _trend_cols.append(yr_label)

            def _extract_trend(series, fmt_fn=None, prefix=""):
                vals = []
                if series is None or len(series) == 0:
                    return ["â€”"] * _years_avail
                for i in range(_years_avail):
                    if i < len(series):
                        v = float(series.iloc[i])
                        if fmt_fn:
                            vals.append(fmt_fn(v))
                        elif prefix:
                            vals.append(f"{prefix}{v/1e9:.1f}B" if abs(v) >= 1e9 else f"{prefix}{v/1e6:.0f}M")
                        else:
                            vals.append(f"{v:.1f}")
                    else:
                        vals.append("â€”")
                return vals

            _trend_data = {
                "Revenue": _extract_trend(cd.revenue, prefix=cs),
                "Gross Profit": _extract_trend(cd.gross_profit, prefix=cs),
                "Operating Income": _extract_trend(cd.operating_income, prefix=cs),
                "Net Income": _extract_trend(cd.net_income, prefix=cs),
                "Free Cash Flow": _extract_trend(cd.free_cashflow_series, prefix=cs),
                "Gross Margin": _extract_trend(cd.gross_margin_series, fmt_fn=lambda v: f"{v*100:.1f}%" if abs(v) < 1 else f"{v:.1f}%"),
                "Operating Margin": _extract_trend(cd.operating_margin_series, fmt_fn=lambda v: f"{v*100:.1f}%" if abs(v) < 1 else f"{v:.1f}%"),
                "Net Margin": _extract_trend(cd.net_margin_series, fmt_fn=lambda v: f"{v*100:.1f}%" if abs(v) < 1 else f"{v:.1f}%"),
            }

            _trend_cols.reverse()
            for k in _trend_data:
                _trend_data[k].reverse()

            # Build styled HTML table
            _th_html = "".join(f'<th style="padding:0.4rem 0.6rem; font-weight:700; color:#2563EB; font-size:0.75rem; '
                               f'text-align:right; border-bottom:2px solid rgba(37,99,235,0.3);">{yr}</th>'
                               for yr in _trend_cols)

            _tbody_html = ""
            for metric, vals in _trend_data.items():
                _cells = ""
                for j, v in enumerate(vals):
                    # Color negative values red
                    _neg = v.startswith("-") or v.startswith(f"{cs}-")
                    _c = "#EF4444" if _neg else "#F9FAFB"
                    _fw = "600"
                    _cells += f'<td style="padding:0.35rem 0.6rem; text-align:right; font-size:0.78rem; color:{_c}; font-weight:{_fw};">{v}</td>'
                _tbody_html += (
                    f'<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">'
                    f'<td style="padding:0.35rem 0.6rem; font-size:0.78rem; color:#D1D5DB; font-weight:600;">{metric}</td>'
                    f'{_cells}</tr>'
                )

            st.markdown(
                f'<div style="background:rgba(255,255,255,0.02); border:1px solid rgba(37,99,235,0.1); '
                f'border-radius:10px; overflow:hidden; margin-bottom:1rem;">'
                f'<div style="padding:0.6rem 0.8rem; background:rgba(37,99,235,0.06); '
                f'border-bottom:1px solid rgba(37,99,235,0.1);">'
                f'<span style="font-size:0.7rem; font-weight:700; color:#2563EB; text-transform:uppercase; '
                f'letter-spacing:1px;">ğŸ“Š Financial Summary (Annual)</span></div>'
                f'<table style="width:100%; border-collapse:collapse;">'
                f'<thead><tr><th style="padding:0.4rem 0.6rem; text-align:left; font-size:0.7rem; '
                f'color:#9CA3AF; border-bottom:2px solid rgba(37,99,235,0.3);">Metric</th>{_th_html}</tr></thead>'
                f'<tbody>{_tbody_html}</tbody></table></div>',
                unsafe_allow_html=True,
            )

    def _get_trend_arrow(series_row):
        """Return trend arrow from last 3-4 data points (left=newest)."""
        try:
            vals = [float(v) for v in series_row if pd.notna(v)][:4]
            if len(vals) < 2:
                return ""
            vals = list(reversed(vals))  # oldest to newest
            n = len(vals)
            x = list(range(n))
            x_mean = sum(x) / n
            y_mean = sum(vals) / n
            num = sum((xi - x_mean) * (yi - y_mean) for xi, yi in zip(x, vals))
            den = sum((xi - x_mean) ** 2 for xi in x)
            if den == 0 or y_mean == 0:
                return "â†’"
            slope_pct = (num / den) / abs(y_mean) * 100
            if slope_pct > 10:
                return "â†‘"
            elif slope_pct > 3:
                return "â†—"
            elif slope_pct > -3:
                return "â†’"
            elif slope_pct > -10:
                return "â†˜"
            else:
                return "â†“"
        except Exception:
            return ""

    _KEY_TREND_METRICS = {"total revenue", "revenue", "net income", "free cash flow",
                          "operating cash flow", "ebitda", "gross profit"}

    def _display_financial_df(df, label, quarterly=False, common_size_base=None):
        if df is not None and not df.empty:
            display_df = df.copy()
            fmt = "%b %Y" if quarterly else "%Y"
            new_cols = []
            for c in display_df.columns:
                col_str = c.strftime(fmt) if hasattr(c, "strftime") else str(c)
                base, n = col_str, 1
                while col_str in new_cols:
                    n += 1
                    col_str = f"{base} ({n})"
                new_cols.append(col_str)
            display_df.columns = new_cols

            # Common size conversion
            _do_common_size = st.checkbox(f"ğŸ“Š Common Size Analysis", key=f"cs_{label}", value=False)
            if _do_common_size and common_size_base is not None:
                try:
                    base_row = None
                    for idx_name in df.index:
                        if common_size_base.lower() in str(idx_name).lower():
                            base_row = df.loc[idx_name]
                            break
                    if base_row is not None:
                        for col_orig, col_new in zip(df.columns, new_cols):
                            base_val = float(base_row[col_orig])
                            if base_val != 0:
                                display_df[col_new] = df[col_orig].apply(
                                    lambda v: f"{float(v)/base_val*100:.1f}%" if pd.notna(v) and base_val != 0 else "N/A"
                                )
                        # Add YoY Growth column
                        if len(df.columns) >= 2:
                            yoy_vals = []
                            for idx_name in df.index:
                                try:
                                    curr = float(df.iloc[:, 0].loc[idx_name])
                                    prev = float(df.iloc[:, 1].loc[idx_name])
                                    if prev != 0:
                                        yoy_vals.append(f"{(curr/prev-1)*100:+.1f}%")
                                    else:
                                        yoy_vals.append("N/A")
                                except Exception:
                                    yoy_vals.append("N/A")
                            display_df["YoY Î”%"] = yoy_vals
                        st.dataframe(display_df, use_container_width=True, height=400)
                        return
                except Exception:
                    pass

            # Format numeric values
            def _fmt_cell(val):
                if pd.isna(val):
                    return "N/A"
                try:
                    v = float(val)
                    abs_v = abs(v)
                    sign = "-" if v < 0 else ""
                    if abs_v >= 1e9:
                        return f"{sign}{cs}{abs_v / 1e9:.1f}B"
                    elif abs_v >= 1e6:
                        return f"{sign}{cs}{abs_v / 1e6:.1f}M"
                    elif abs_v >= 1e3:
                        return f"{sign}{cs}{abs_v / 1e3:.1f}K"
                    elif abs_v == 0:
                        return f"{cs}0"
                    else:
                        return f"{sign}{cs}{abs_v:,.2f}"
                except (TypeError, ValueError):
                    return str(val)

            formatted_df = display_df.map(_fmt_cell)

            # Add YoY Growth column (most recent vs prior year)
            if len(df.columns) >= 2:
                yoy_vals = []
                for idx_name in df.index:
                    try:
                        curr = float(df.iloc[:, 0].loc[idx_name])
                        prev = float(df.iloc[:, 1].loc[idx_name])
                        if prev != 0:
                            pct = (curr / prev - 1) * 100
                            yoy_vals.append(f"{pct:+.1f}%")
                        else:
                            yoy_vals.append("â€”")
                    except Exception:
                        yoy_vals.append("â€”")
                formatted_df["YoY Î”%"] = yoy_vals

            # Add Trend Arrows for key metrics
            trend_vals = []
            for idx_name in df.index:
                if str(idx_name).lower().strip() in _KEY_TREND_METRICS:
                    trend_vals.append(_get_trend_arrow(df.loc[idx_name]))
                else:
                    trend_vals.append("")
            if any(t for t in trend_vals):
                formatted_df["Trend"] = trend_vals

            st.dataframe(formatted_df, use_container_width=True, height=400)
        else:
            st.info(f"{label} not available.")

    fin_tab1, fin_tab2, fin_tab3, fin_tab4 = st.tabs([
        "Income Statement", "Balance Sheet", "Cash Flow", "Quarterly Income"
    ])
    with fin_tab1:
        _display_financial_df(cd.income_stmt, "Income Statement", common_size_base="Total Revenue")
    with fin_tab2:
        _display_financial_df(cd.balance_sheet, "Balance Sheet", common_size_base="Total Assets")
    with fin_tab3:
        _display_financial_df(cd.cashflow, "Cash Flow Statement")
    with fin_tab4:
        _display_financial_df(cd.quarterly_income_stmt, "Quarterly Income Statement", quarterly=True)

    # Revenue & Income Growth Trend
    if cd.income_stmt is not None and not cd.income_stmt.empty:
        try:
            is_df = cd.income_stmt
            rev_row = None
            ni_row = None
            for idx_name in is_df.index:
                if "total revenue" in str(idx_name).lower() or "revenue" == str(idx_name).lower().strip():
                    rev_row = is_df.loc[idx_name]
                elif "net income" in str(idx_name).lower():
                    ni_row = is_df.loc[idx_name]
            
            if rev_row is not None and len(rev_row) > 1:
                fig_growth = go.Figure()
                
                years = [c.strftime("%Y") if hasattr(c, "strftime") else str(c) for c in rev_row.index]
                rev_vals = [float(v) / 1e9 if pd.notna(v) else 0 for v in rev_row.values]
                
                fig_growth.add_trace(go.Bar(
                    x=years, y=rev_vals, name="Revenue",
                    marker_color="rgba(37,99,235,0.6)",
                    text=[f"${v:.1f}B" for v in rev_vals],
                    textposition="outside", textfont=dict(size=9, color="#D1D5DB"),
                ))
                
                if ni_row is not None:
                    ni_vals = [float(v) / 1e9 if pd.notna(v) else 0 for v in ni_row.values]
                    fig_growth.add_trace(go.Bar(
                        x=years, y=ni_vals, name="Net Income",
                        marker_color="rgba(16,185,129,0.5)",
                        text=[f"${v:.1f}B" for v in ni_vals],
                        textposition="outside", textfont=dict(size=9, color="#D1D5DB"),
                    ))
                
                # Add YoY growth rate line for revenue
                yoy_growth = []
                for i in range(len(rev_vals)):
                    if i < len(rev_vals) - 1 and rev_vals[i+1] != 0:
                        growth = (rev_vals[i] / rev_vals[i+1] - 1) * 100
                        yoy_growth.append(growth)
                    else:
                        yoy_growth.append(None)
                
                fig_growth.add_trace(go.Scatter(
                    x=years, y=yoy_growth, name="YoY Growth %",
                    mode="lines+markers", yaxis="y2",
                    line=dict(color="#F59E0B", width=2),
                    marker=dict(size=8, color="#F59E0B"),
                ))
                
                fig_growth.update_layout(
                    **_CHART_LAYOUT_BASE, height=350,
                    margin=dict(t=30, b=30, l=60, r=60),
                    xaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
                    yaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), title=dict(text="$ Billions", font=dict(size=10, color="#9CA3AF"))),
                    yaxis2=dict(overlaying="y", side="right", ticksuffix="%", showgrid=False,
                               tickfont=dict(size=9, color="#F59E0B"),
                               title=dict(text="YoY Growth", font=dict(size=10, color="#F59E0B"))),
                    legend=dict(orientation="h", yanchor="bottom", y=1.02, font=dict(size=9, color="#D1D5DB")),
                    barmode="group",
                )
                _apply_space_grid(fig_growth)
                st.plotly_chart(fig_growth, use_container_width=True, key="revenue_growth_trend")
        except Exception:
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 8b. CHART STUDIO
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with st.expander("ğŸ“Š Chart Studio â€” Advanced Visualizations", expanded=False):
        with _safe_section("Chart Studio"):
            cs_tab1, cs_tab2, cs_tab3 = st.tabs(["Correlation Matrix", "Margins Waterfall", "Cash Flow Bridge"])

            with cs_tab1:
                # Correlation matrix heatmap of key financial metrics over time
                try:
                    corr_series = {}
                    if cd.revenue is not None and len(cd.revenue) >= 2:
                        corr_series["Revenue"] = cd.revenue.values[::-1].astype(float)
                    if cd.gross_profit is not None and len(cd.gross_profit) >= 2:
                        corr_series["Gross Profit"] = cd.gross_profit.values[::-1].astype(float)
                    if cd.operating_income is not None and len(cd.operating_income) >= 2:
                        corr_series["Op Income"] = cd.operating_income.values[::-1].astype(float)
                    if cd.net_income is not None and len(cd.net_income) >= 2:
                        corr_series["Net Income"] = cd.net_income.values[::-1].astype(float)
                    if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) >= 2:
                        corr_series["FCF"] = cd.free_cashflow_series.values[::-1].astype(float)

                    if len(corr_series) >= 3:
                        min_len = min(len(v) for v in corr_series.values())
                        corr_dict = {k: v[:min_len] for k, v in corr_series.items()}
                        corr_df = pd.DataFrame(corr_dict)
                        corr_mat = corr_df.corr()

                        fig_cm = go.Figure(data=go.Heatmap(
                            z=corr_mat.values,
                            x=corr_mat.columns.tolist(),
                            y=corr_mat.index.tolist(),
                            colorscale=[[0, "#EF4444"], [0.5, "#1a1625"], [1, "#10B981"]],
                            zmin=-1, zmax=1,
                            text=np.round(corr_mat.values, 2),
                            texttemplate="%{text}",
                            textfont=dict(size=11, color="#F9FAFB"),
                        ))
                        fig_cm.update_layout(
                            **_CHART_LAYOUT_BASE, height=400,
                            margin=dict(t=30, b=30, l=80, r=30),
                            xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                            yaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                        )
                        st.plotly_chart(fig_cm, use_container_width=True, key="cs_corr_matrix")
                    else:
                        st.info("Not enough financial series for correlation analysis.")
                except Exception as e:
                    st.info(f"Correlation matrix not available: {str(e)[:80]}")

            with cs_tab2:
                # Margins waterfall: Revenue â†’ Gross Profit â†’ EBITDA â†’ Net Income
                try:
                    rev_latest = float(cd.revenue.iloc[0]) if cd.revenue is not None and len(cd.revenue) > 0 else 0
                    gp_latest = float(cd.gross_profit.iloc[0]) if cd.gross_profit is not None and len(cd.gross_profit) > 0 else 0
                    oi_latest = float(cd.operating_income.iloc[0]) if cd.operating_income is not None and len(cd.operating_income) > 0 else 0
                    ni_latest = float(cd.net_income.iloc[0]) if cd.net_income is not None and len(cd.net_income) > 0 else 0

                    if rev_latest > 0:
                        cogs = rev_latest - gp_latest
                        opex = gp_latest - oi_latest
                        below_line = oi_latest - ni_latest

                        fig_mw = go.Figure(go.Waterfall(
                            x=["Revenue", "COGS", "Gross Profit", "OpEx", "Operating Income", "Tax/Int/Other", "Net Income"],
                            y=[rev_latest, -cogs, 0, -opex, 0, -below_line, 0],
                            measure=["absolute", "relative", "total", "relative", "total", "relative", "total"],
                            text=[format_number(v, currency_symbol=cs) for v in [rev_latest, -cogs, gp_latest, -opex, oi_latest, -below_line, ni_latest]],
                            textposition="outside",
                            textfont=dict(size=9, color="#D1D5DB"),
                            connector=dict(line=dict(color="rgba(37,99,235,0.2)", width=1, dash="dot")),
                            increasing=dict(marker=dict(color="#10B981")),
                            decreasing=dict(marker=dict(color="#EF4444")),
                            totals=dict(marker=dict(color="#2563EB")),
                        ))
                        fig_mw.update_layout(
                            **_CHART_LAYOUT_BASE, height=400,
                            margin=dict(t=30, b=40, l=60, r=30),
                            xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
                            yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                        )
                        _apply_space_grid(fig_mw)
                        st.plotly_chart(fig_mw, use_container_width=True, key="cs_margins_waterfall")
                    else:
                        st.info("Revenue data not available for margins waterfall.")
                except Exception as e:
                    st.info(f"Margins waterfall not available: {str(e)[:80]}")

            with cs_tab3:
                # Cash flow bridge: Operating CF â†’ CapEx â†’ FCF â†’ Dividends â†’ Net Cash Change
                try:
                    if cd.cashflow is not None and not cd.cashflow.empty:
                        cf = cd.cashflow
                        def _cf_val(names):
                            for n in names:
                                for idx in cf.index:
                                    if n.lower() in str(idx).lower():
                                        v = cf.loc[idx].iloc[0]
                                        return float(v) if pd.notna(v) else 0
                            return 0

                        op_cf = _cf_val(["operating cash flow", "total cash from operating", "cash flow from operations"])
                        capex = _cf_val(["capital expenditure", "capital expenditures"])
                        fcf_val = op_cf + capex  # capex is typically negative
                        dividends = _cf_val(["dividends paid", "cash dividends paid"])
                        buybacks = _cf_val(["repurchase", "buyback", "stock repurchase"])
                        net_change = fcf_val + dividends + buybacks

                        if op_cf != 0:
                            bridge_labels = ["Operating CF", "CapEx", "Free Cash Flow", "Dividends", "Buybacks", "Net Cash"]
                            bridge_values = [op_cf, capex, 0, dividends, buybacks, 0]
                            bridge_measures = ["absolute", "relative", "total", "relative", "relative", "total"]
                            bridge_display = [op_cf, capex, fcf_val, dividends, buybacks, net_change]

                            fig_cfb = go.Figure(go.Waterfall(
                                x=bridge_labels,
                                y=bridge_values,
                                measure=bridge_measures,
                                text=[format_number(v, currency_symbol=cs) for v in bridge_display],
                                textposition="outside",
                                textfont=dict(size=9, color="#D1D5DB"),
                                connector=dict(line=dict(color="rgba(37,99,235,0.2)", width=1, dash="dot")),
                                increasing=dict(marker=dict(color="#10B981")),
                                decreasing=dict(marker=dict(color="#EF4444")),
                                totals=dict(marker=dict(color="#2563EB")),
                            ))
                            fig_cfb.update_layout(
                                **_CHART_LAYOUT_BASE, height=400,
                                margin=dict(t=30, b=40, l=60, r=30),
                                xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
                                yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                            )
                            _apply_space_grid(fig_cfb)
                            st.plotly_chart(fig_cfb, use_container_width=True, key="cs_cashflow_bridge")
                        else:
                            st.info("Operating cash flow data not available.")
                    else:
                        st.info("Cash flow statement not available.")
                except Exception as e:
                    st.info(f"Cash flow bridge not available: {str(e)[:80]}")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 8a. CAPITAL ALLOCATION ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Capital Allocation Framework"):
        _section("Capital Allocation Framework", "ğŸ—ï¸")
        try:
            _ca_ocf = _safe_val(getattr(cd, 'operating_cashflow_series', None))
            _ca_capex = _safe_val(getattr(cd, 'capital_expenditure', None))
            _ca_divs = _safe_val(getattr(cd, 'dividends_paid', None))
            _ca_mcap = getattr(cd, 'market_cap', 0) or 0

            # Try to get buybacks from cashflow statement
            _ca_buybacks = 0
            _ca_debt_repay = 0
            if cd.cashflow is not None and not cd.cashflow.empty:
                _cf = cd.cashflow
                for idx_name in _cf.index:
                    _idx_l = str(idx_name).lower()
                    if "repurchase" in _idx_l and "stock" in _idx_l:
                        try:
                            _ca_buybacks = float(_cf.loc[idx_name].iloc[0]) if pd.notna(_cf.loc[idx_name].iloc[0]) else 0
                        except Exception:
                            pass
                    if "repayment" in _idx_l and "debt" in _idx_l:
                        try:
                            _ca_debt_repay = float(_cf.loc[idx_name].iloc[0]) if pd.notna(_cf.loc[idx_name].iloc[0]) else 0
                        except Exception:
                            pass

            if _ca_ocf and _ca_ocf > 0:
                _ca_capex_abs = abs(_ca_capex) if _ca_capex else 0
                _ca_divs_abs = abs(_ca_divs) if _ca_divs else 0
                _ca_buybacks_abs = abs(_ca_buybacks)
                _ca_debt_abs = abs(_ca_debt_repay)
                _ca_remainder = max(0, _ca_ocf - _ca_capex_abs - _ca_divs_abs - _ca_buybacks_abs - _ca_debt_abs)

                # Waterfall chart
                _ca_labels = ["Operating CF"]
                _ca_values = [_ca_ocf]
                _ca_measures = ["absolute"]
                _ca_display = [_ca_ocf]

                if _ca_capex_abs > 0:
                    _ca_labels.append("CapEx")
                    _ca_values.append(-_ca_capex_abs)
                    _ca_measures.append("relative")
                    _ca_display.append(-_ca_capex_abs)
                if _ca_divs_abs > 0:
                    _ca_labels.append("Dividends")
                    _ca_values.append(-_ca_divs_abs)
                    _ca_measures.append("relative")
                    _ca_display.append(-_ca_divs_abs)
                if _ca_buybacks_abs > 0:
                    _ca_labels.append("Buybacks")
                    _ca_values.append(-_ca_buybacks_abs)
                    _ca_measures.append("relative")
                    _ca_display.append(-_ca_buybacks_abs)
                if _ca_debt_abs > 0:
                    _ca_labels.append("Debt Repayment")
                    _ca_values.append(-_ca_debt_abs)
                    _ca_measures.append("relative")
                    _ca_display.append(-_ca_debt_abs)
                _ca_labels.append("Cash Remaining")
                _ca_values.append(0)
                _ca_measures.append("total")
                _ca_display.append(_ca_remainder)

                fig_ca = go.Figure(go.Waterfall(
                    x=_ca_labels, y=_ca_values, measure=_ca_measures,
                    text=[format_number(v, currency_symbol=cs) for v in _ca_display],
                    textposition="outside",
                    textfont=dict(size=9, color="#D1D5DB"),
                    connector=dict(line=dict(color="rgba(37,99,235,0.2)", width=1, dash="dot")),
                    increasing=dict(marker=dict(color="#10B981")),
                    decreasing=dict(marker=dict(color="#EF4444")),
                    totals=dict(marker=dict(color="#2563EB")),
                ))
                fig_ca.update_layout(
                    **_CHART_LAYOUT_BASE, height=400,
                    margin=dict(t=30, b=40, l=60, r=30),
                    xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
                    yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                )
                _apply_space_grid(fig_ca)
                st.plotly_chart(fig_ca, use_container_width=True, key="capital_allocation_waterfall")

                # Shareholder Yield
                if _ca_mcap > 0:
                    _sh_yield = (_ca_divs_abs + _ca_buybacks_abs) / _ca_mcap * 100
                    _div_yield_only = _ca_divs_abs / _ca_mcap * 100
                    _sy1, _sy2 = st.columns(2)
                    _sy1.metric("Shareholder Yield", f"{_sh_yield:.2f}%",
                                help="(Dividends + Buybacks) / Market Cap")
                    _sy2.metric("Dividend Yield Only", f"{_div_yield_only:.2f}%",
                                delta=f"+{_sh_yield - _div_yield_only:.2f}% from buybacks" if _ca_buybacks_abs > 0 else None)

                # Allocation percentages
                _ca_total_uses = _ca_capex_abs + _ca_divs_abs + _ca_buybacks_abs + _ca_debt_abs + _ca_remainder
                if _ca_total_uses > 0:
                    _alloc_items = []
                    if _ca_capex_abs > 0:
                        _alloc_items.append(("CapEx", _ca_capex_abs / _ca_ocf * 100))
                    if _ca_divs_abs > 0:
                        _alloc_items.append(("Dividends", _ca_divs_abs / _ca_ocf * 100))
                    if _ca_buybacks_abs > 0:
                        _alloc_items.append(("Buybacks", _ca_buybacks_abs / _ca_ocf * 100))
                    if _ca_debt_abs > 0:
                        _alloc_items.append(("Debt Repayment", _ca_debt_abs / _ca_ocf * 100))
                    if _ca_remainder > 0:
                        _alloc_items.append(("Cash Accumulation", _ca_remainder / _ca_ocf * 100))

                    _alloc_text = " Â· ".join([f"**{n}**: {v:.0f}%" for n, v in _alloc_items])
                    st.markdown(f"**OCF Allocation:** {_alloc_text}")
            else:
                st.info("Operating cash flow data not available or negative.")
        except Exception:
            st.info("Could not compute capital allocation analysis.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 8a2. SHAREHOLDER VALUE CREATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Shareholder Value Creation"):
        _section("Shareholder Value Creation", "ğŸ’°")
        try:
            # Gather inputs
            _svc_oi = _safe_val(getattr(cd, 'operating_income', None))
            _svc_ni = _safe_val(getattr(cd, 'net_income', None))
            _svc_mcap = getattr(cd, 'market_cap', 0) or 0
            _svc_price = getattr(cd, 'current_price', 0) or 0
            _svc_shares = getattr(cd, 'shares_outstanding', 0) or 0
            _svc_beta = getattr(cd, 'beta', 1.0) or 1.0
            _svc_total_debt_s = getattr(cd, 'total_debt', None)
            _svc_total_equity_s = getattr(cd, 'total_equity', None)
            _svc_bvps = getattr(cd, 'book_value_per_share', None)

            _svc_total_debt = float(_svc_total_debt_s.iloc[0]) if _svc_total_debt_s is not None and len(_svc_total_debt_s) > 0 and pd.notna(_svc_total_debt_s.iloc[0]) else 0
            _svc_total_equity = float(_svc_total_equity_s.iloc[0]) if _svc_total_equity_s is not None and len(_svc_total_equity_s) > 0 and pd.notna(_svc_total_equity_s.iloc[0]) else 0
            _svc_book_equity = _svc_bvps * _svc_shares if _svc_bvps and _svc_shares else _svc_total_equity

            # Estimate WACC
            _svc_rf = 0.043  # risk-free rate ~4.3%
            _svc_erp = 0.055  # equity risk premium
            _svc_cost_equity = _svc_rf + _svc_beta * _svc_erp
            _svc_cost_debt = 0.05  # assumed
            _svc_tax_rate = 0.21
            _svc_total_capital = _svc_total_debt + _svc_total_equity if (_svc_total_debt + _svc_total_equity) > 0 else 1
            _svc_we = _svc_total_equity / _svc_total_capital
            _svc_wd = _svc_total_debt / _svc_total_capital
            _svc_wacc = _svc_we * _svc_cost_equity + _svc_wd * _svc_cost_debt * (1 - _svc_tax_rate)

            # EVA = NOPAT - (Invested Capital Ã— WACC)
            _svc_nopat = _svc_oi * (1 - _svc_tax_rate) if _svc_oi else None
            _svc_invested_capital = _svc_total_debt + _svc_total_equity
            _svc_eva = (_svc_nopat - (_svc_invested_capital * _svc_wacc)) if _svc_nopat else None

            # MVA = Market Cap - Book Value of Equity
            _svc_mva = (_svc_mcap - _svc_book_equity) if _svc_mcap and _svc_book_equity else None

            # Wealth Created (use 52-week data if available)
            _svc_52w_low = getattr(cd, 'fifty_two_week_low', None)
            _svc_52w_high = getattr(cd, 'fifty_two_week_high', None)
            _svc_price_1y_ago = ((_svc_52w_low + _svc_52w_high) / 2) if _svc_52w_low and _svc_52w_high else None
            _svc_wealth = ((_svc_price - _svc_price_1y_ago) * _svc_shares) if _svc_price_1y_ago and _svc_shares else None

            cs = getattr(cd, 'currency_symbol', '$')

            # Display metric cards
            _svc_c1, _svc_c2, _svc_c3, _svc_c4 = st.columns(4)

            def _svc_card(col, title, value, is_currency=True):
                with col:
                    if value is not None:
                        _creating = value >= 0
                        _color = "#10B981" if _creating else "#EF4444"
                        _indicator = "âœ… Creating Value" if _creating else "âŒ Destroying Value"
                        _val_str = format_number(abs(value), currency_symbol=cs) if is_currency else f"{value:.2f}"
                        _sign = "+" if _creating else "-"
                        st.markdown(
                            f'<div style="text-align:center; padding:0.8rem; background:{"rgba(16,185,129,0.06)" if _creating else "rgba(239,68,68,0.06)"}; '
                            f'border-radius:12px; border:1px solid {"rgba(16,185,129,0.2)" if _creating else "rgba(239,68,68,0.2)"};">'
                            f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">{title}</div>'
                            f'<div style="font-size:1.2rem; font-weight:800; color:{_color};">{_sign}{_val_str}</div>'
                            f'<div style="font-size:0.6rem; color:{_color};">{_indicator}</div>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )
                    else:
                        st.markdown(
                            f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); border-radius:12px;">'
                            f'<div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase;">{title}</div>'
                            f'<div style="color:#9CA3AF;">N/A</div></div>',
                            unsafe_allow_html=True,
                        )

            _svc_card(_svc_c1, "Economic Value Added (EVA)", _svc_eva)
            _svc_card(_svc_c2, "Market Value Added (MVA)", _svc_mva)
            _svc_card(_svc_c3, "Wealth Created (Est. 1Y)", _svc_wealth)
            _svc_card(_svc_c4, f"WACC (Est.)", None if _svc_wacc is None else _svc_wacc * 100, is_currency=False)
            # Override WACC card with custom display
            with _svc_c4:
                if _svc_wacc:
                    st.markdown(
                        f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.06); '
                        f'border-radius:12px; border:1px solid rgba(37,99,235,0.2);">'
                        f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Est. WACC</div>'
                        f'<div style="font-size:1.2rem; font-weight:800; color:#60A5FA;">{_svc_wacc*100:.1f}%</div>'
                        f'<div style="font-size:0.6rem; color:#9CA3AF;">Cost of Capital</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

            # EVA / MVA Trend (multi-year)
            if cd.operating_income is not None and len(cd.operating_income) > 1 and _svc_invested_capital > 0:
                _svc_years = []
                _svc_evas = []
                for _yi in range(min(len(cd.operating_income), 4)):
                    _oi_y = float(cd.operating_income.iloc[_yi]) if pd.notna(cd.operating_income.iloc[_yi]) else None
                    if _oi_y:
                        _nopat_y = _oi_y * (1 - _svc_tax_rate)
                        _eva_y = _nopat_y - (_svc_invested_capital * _svc_wacc)
                        _svc_evas.append(_eva_y)
                        _yr_label = str(cd.operating_income.index[_yi])[:4] if hasattr(cd.operating_income.index[_yi], 'year') else f"Y-{_yi}"
                        _svc_years.append(_yr_label)

                if len(_svc_evas) > 1:
                    _svc_evas.reverse()
                    _svc_years.reverse()
                    fig_eva = go.Figure()
                    fig_eva.add_trace(go.Bar(
                        x=_svc_years, y=_svc_evas,
                        marker_color=["#10B981" if v >= 0 else "#EF4444" for v in _svc_evas],
                        text=[format_number(v, currency_symbol=cs) for v in _svc_evas],
                        textposition="outside", textfont=dict(size=9, color="#D1D5DB"),
                    ))
                    fig_eva.update_layout(
                        **_CHART_LAYOUT_BASE, height=280,
                        margin=dict(t=30, b=30, l=50, r=20),
                        title=dict(text="EVA Trend", font=dict(size=12, color="#D1D5DB")),
                        xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                        yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                        showlegend=False,
                    )
                    _apply_space_grid(fig_eva)
                    st.plotly_chart(fig_eva, use_container_width=True, key="eva_trend_chart")

            st.markdown(
                '<div style="font-size:0.6rem; color:#5A567A; text-align:center; margin-top:0.3rem;">'
                'EVA = NOPAT - (Invested Capital Ã— WACC) Â· MVA = Market Cap - Book Equity Â· '
                'WACC estimated using CAPM with Î² and assumed cost of debt</div>',
                unsafe_allow_html=True,
            )
        except Exception:
            st.info("Shareholder value creation data not available.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 8b. WORKING CAPITAL ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Working Capital Analysis"):
        _section("Working Capital Dashboard", "ğŸ’°")
        try:
            _wc_has_data = False
            _wc_dso_curr = _wc_dso_prev = _wc_dio_curr = _wc_dio_prev = None
            _wc_dpo_curr = _wc_dpo_prev = None

            if cd.balance_sheet is not None and not cd.balance_sheet.empty and cd.income_stmt is not None and not cd.income_stmt.empty:
                _bs = cd.balance_sheet
                _is = cd.income_stmt

                # Extract rows from financial statements
                def _wc_find_row(df, keywords):
                    for idx_name in df.index:
                        _idx_lower = str(idx_name).lower()
                        for kw in keywords:
                            if kw in _idx_lower:
                                return df.loc[idx_name]
                    return None

                _wc_recv = _wc_find_row(_bs, ["accounts receivable", "net receivable", "receivable"])
                _wc_inv = _wc_find_row(_bs, ["inventory"])
                _wc_pay = _wc_find_row(_bs, ["accounts payable", "payable"])
                _wc_rev_row = _wc_find_row(_is, ["total revenue", "revenue"])
                _wc_cogs_row = _wc_find_row(_is, ["cost of revenue", "cost of goods"])

                if _wc_rev_row is not None and len(_wc_rev_row) > 0:
                    _wc_rev_curr = float(_wc_rev_row.iloc[0]) if pd.notna(_wc_rev_row.iloc[0]) else None
                    _wc_rev_prev = float(_wc_rev_row.iloc[1]) if len(_wc_rev_row) > 1 and pd.notna(_wc_rev_row.iloc[1]) else None
                else:
                    _wc_rev_curr = _wc_rev_prev = None

                _wc_cogs_curr = _wc_cogs_prev = None
                if _wc_cogs_row is not None and len(_wc_cogs_row) > 0:
                    _wc_cogs_curr = abs(float(_wc_cogs_row.iloc[0])) if pd.notna(_wc_cogs_row.iloc[0]) else None
                    _wc_cogs_prev = abs(float(_wc_cogs_row.iloc[1])) if len(_wc_cogs_row) > 1 and pd.notna(_wc_cogs_row.iloc[1]) else None

                # DSO
                if _wc_recv is not None and _wc_rev_curr and _wc_rev_curr > 0:
                    _wc_recv_curr = float(_wc_recv.iloc[0]) if pd.notna(_wc_recv.iloc[0]) else 0
                    _wc_dso_curr = (_wc_recv_curr / _wc_rev_curr) * 365
                    if len(_wc_recv) > 1 and _wc_rev_prev and _wc_rev_prev > 0:
                        _wc_recv_prev_v = float(_wc_recv.iloc[1]) if pd.notna(_wc_recv.iloc[1]) else 0
                        _wc_dso_prev = (_wc_recv_prev_v / _wc_rev_prev) * 365

                # DIO
                if _wc_inv is not None and _wc_cogs_curr and _wc_cogs_curr > 0:
                    _wc_inv_curr = float(_wc_inv.iloc[0]) if pd.notna(_wc_inv.iloc[0]) else 0
                    _wc_dio_curr = (_wc_inv_curr / _wc_cogs_curr) * 365
                    if len(_wc_inv) > 1 and _wc_cogs_prev and _wc_cogs_prev > 0:
                        _wc_inv_prev_v = float(_wc_inv.iloc[1]) if pd.notna(_wc_inv.iloc[1]) else 0
                        _wc_dio_prev = (_wc_inv_prev_v / _wc_cogs_prev) * 365

                # DPO
                if _wc_pay is not None and _wc_cogs_curr and _wc_cogs_curr > 0:
                    _wc_pay_curr = float(_wc_pay.iloc[0]) if pd.notna(_wc_pay.iloc[0]) else 0
                    _wc_dpo_curr = (_wc_pay_curr / _wc_cogs_curr) * 365
                    if len(_wc_pay) > 1 and _wc_cogs_prev and _wc_cogs_prev > 0:
                        _wc_pay_prev_v = float(_wc_pay.iloc[1]) if pd.notna(_wc_pay.iloc[1]) else 0
                        _wc_dpo_prev = (_wc_pay_prev_v / _wc_cogs_prev) * 365

                # Display metrics
                _wc_metrics = []
                if _wc_dso_curr is not None:
                    _wc_metrics.append(("DSO", _wc_dso_curr, _wc_dso_prev, "Days Sales Outstanding"))
                    _wc_has_data = True
                if _wc_dio_curr is not None:
                    _wc_metrics.append(("DIO", _wc_dio_curr, _wc_dio_prev, "Days Inventory Outstanding"))
                    _wc_has_data = True
                if _wc_dpo_curr is not None:
                    _wc_metrics.append(("DPO", _wc_dpo_curr, _wc_dpo_prev, "Days Payable Outstanding"))
                    _wc_has_data = True

                if _wc_has_data:
                    _wc_cols = st.columns(len(_wc_metrics) + 1)
                    for i, (_wc_name, _wc_val, _wc_prev, _wc_desc) in enumerate(_wc_metrics):
                        _wc_delta = None
                        if _wc_prev is not None:
                            _wc_delta = f"{_wc_val - _wc_prev:+.1f} days"
                        _wc_cols[i].metric(_wc_desc, f"{_wc_val:.1f} days", delta=_wc_delta, delta_color="inverse" if _wc_name != "DPO" else "normal")

                    # CCC
                    _wc_ccc = (_wc_dso_curr or 0) + (_wc_dio_curr or 0) - (_wc_dpo_curr or 0)
                    _wc_ccc_prev = None
                    if _wc_dso_prev is not None or _wc_dio_prev is not None or _wc_dpo_prev is not None:
                        _wc_ccc_prev = (_wc_dso_prev or 0) + (_wc_dio_prev or 0) - (_wc_dpo_prev or 0)
                    _ccc_delta = f"{_wc_ccc - _wc_ccc_prev:+.1f} days" if _wc_ccc_prev is not None else None
                    _ccc_color = "#10B981" if _wc_ccc < 30 else ("#F5A623" if _wc_ccc < 60 else "#EF4444")
                    _ccc_label = "Good" if _wc_ccc < 30 else ("Moderate" if _wc_ccc < 60 else "Poor")
                    _wc_cols[-1].metric("Cash Conversion Cycle", f"{_wc_ccc:.1f} days", delta=_ccc_delta, delta_color="inverse")
                    _wc_cols[-1].markdown(f'<span style="color:{_ccc_color}; font-weight:600; font-size:0.8rem;">â— {_ccc_label}</span>', unsafe_allow_html=True)

                    # Stacked bar chart
                    _wc_bar_data = []
                    _wc_years = ["Current"]
                    _wc_dso_vals = [_wc_dso_curr or 0]
                    _wc_dio_vals = [_wc_dio_curr or 0]
                    _wc_dpo_vals = [_wc_dpo_curr or 0]
                    if _wc_dso_prev is not None or _wc_dio_prev is not None or _wc_dpo_prev is not None:
                        _wc_years.insert(0, "Prior Year")
                        _wc_dso_vals.insert(0, _wc_dso_prev or 0)
                        _wc_dio_vals.insert(0, _wc_dio_prev or 0)
                        _wc_dpo_vals.insert(0, _wc_dpo_prev or 0)

                    fig_wc = go.Figure()
                    fig_wc.add_trace(go.Bar(name="DSO", x=_wc_years, y=_wc_dso_vals, marker_color="#2563EB"))
                    fig_wc.add_trace(go.Bar(name="DIO", x=_wc_years, y=_wc_dio_vals, marker_color="#10B981"))
                    fig_wc.add_trace(go.Bar(name="DPO", x=_wc_years, y=_wc_dpo_vals, marker_color="#EF4444"))
                    fig_wc.update_layout(
                        **_CHART_LAYOUT_BASE, height=350, barmode="stack",
                        margin=dict(t=30, b=40, l=60, r=30),
                        xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                        yaxis=dict(title="Days", tickfont=dict(size=9, color="#9CA3AF")),
                        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="center", x=0.5,
                                    font=dict(size=10, color="#C4B5FD")),
                    )
                    _apply_space_grid(fig_wc)
                    st.plotly_chart(fig_wc, use_container_width=True, key="working_capital_ccc_chart")
                else:
                    st.info("Insufficient balance sheet data for working capital analysis.")
            else:
                st.info("Financial statements not available for working capital analysis.")
        except Exception:
            st.info("Could not compute working capital metrics.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 9a. ESG RISK DASHBOARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("ESG Risk Dashboard"):
        _section("ESG Risk Dashboard", "ğŸŒ±")
        _esg = cd.esg_scores
        _esg_available = _esg is not None and not (hasattr(_esg, 'empty') and _esg.empty)
        if _esg_available:
            try:
                # Extract scores â€” yfinance sustainability is a DataFrame with Value column or dict-like
                def _esg_val(key):
                    try:
                        if isinstance(_esg, pd.DataFrame):
                            if key in _esg.index:
                                v = _esg.loc[key]
                                return float(v.iloc[0]) if hasattr(v, 'iloc') else float(v)
                            if 'Value' in _esg.columns and key in _esg.index:
                                return float(_esg.loc[key, 'Value'])
                        elif isinstance(_esg, dict):
                            return float(_esg.get(key, 0)) if _esg.get(key) is not None else None
                    except Exception:
                        pass
                    return None

                _total_esg = _esg_val('totalEsg')
                _env_score = _esg_val('environmentScore')
                _soc_score = _esg_val('socialScore')
                _gov_score = _esg_val('governanceScore')
                _controversy = _esg_val('highestControversy')

                # Determine ESG risk rating from total score
                def _esg_risk_label(score):
                    if score is None:
                        return "N/A", "#9CA3AF"
                    if score < 10:
                        return "Negligible", "#10B981"
                    elif score < 20:
                        return "Low", "#34D399"
                    elif score < 30:
                        return "Medium", "#F59E0B"
                    elif score < 40:
                        return "High", "#EF4444"
                    else:
                        return "Severe", "#991B1B"

                _risk_label, _risk_color = _esg_risk_label(_total_esg)

                # Total ESG + Risk Rating header
                _esg_h1, _esg_h2 = st.columns(2)
                with _esg_h1:
                    st.markdown(
                        f'<div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); '
                        f'border-radius:12px; padding:1rem; text-align:center;">'
                        f'<div style="font-size:0.65rem; font-weight:700; color:#9CA3AF; text-transform:uppercase; '
                        f'letter-spacing:1.5px; margin-bottom:0.3rem;">Total ESG Risk Score</div>'
                        f'<div style="font-size:2rem; font-weight:800; color:#F9FAFB;">'
                        f'{_total_esg:.1f}</div></div>' if _total_esg is not None else
                        f'<div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:1rem; text-align:center;">'
                        f'<div style="font-size:0.65rem; font-weight:700; color:#9CA3AF;">TOTAL ESG</div>'
                        f'<div style="font-size:1.2rem; color:#9CA3AF;">N/A</div></div>',
                        unsafe_allow_html=True,
                    )
                with _esg_h2:
                    st.markdown(
                        f'<div style="background:rgba(255,255,255,0.05); border:1px solid {_risk_color}40; '
                        f'border-radius:12px; padding:1rem; text-align:center;">'
                        f'<div style="font-size:0.65rem; font-weight:700; color:#9CA3AF; text-transform:uppercase; '
                        f'letter-spacing:1.5px; margin-bottom:0.3rem;">ESG Risk Rating</div>'
                        f'<div style="font-size:1.5rem; font-weight:800; color:{_risk_color};">'
                        f'{_risk_label}</div>'
                        f'{"<div style=" + chr(34) + "font-size:0.7rem; color:#9CA3AF; margin-top:0.2rem;" + chr(34) + ">Controversy Level: " + str(int(_controversy)) + "/5</div>" if _controversy is not None else ""}'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

                # E / S / G gauge charts
                _esg_scores_list = [
                    ("Environmental", _env_score, "#10B981"),
                    ("Social", _soc_score, "#2563EB"),
                    ("Governance", _gov_score, "#F59E0B"),
                ]
                _has_esg_scores = any(s is not None for _, s, _ in _esg_scores_list)
                if _has_esg_scores:
                    _esg_cols = st.columns(3)
                    for _ei, (_elabel, _eval, _ecolor) in enumerate(_esg_scores_list):
                        with _esg_cols[_ei]:
                            if _eval is not None:
                                _efig = go.Figure(go.Indicator(
                                    mode="gauge+number",
                                    value=_eval,
                                    title=dict(text=_elabel, font=dict(size=14, color="#F9FAFB")),
                                    number=dict(font=dict(size=24, color="#F9FAFB")),
                                    gauge=dict(
                                        axis=dict(range=[0, 50], tickfont=dict(size=10, color="#9CA3AF")),
                                        bar=dict(color=_ecolor),
                                        bgcolor="rgba(255,255,255,0.05)",
                                        bordercolor="rgba(255,255,255,0.1)",
                                        steps=[
                                            dict(range=[0, 10], color="rgba(16,185,129,0.1)"),
                                            dict(range=[10, 20], color="rgba(52,211,153,0.1)"),
                                            dict(range=[20, 30], color="rgba(245,158,11,0.1)"),
                                            dict(range=[30, 40], color="rgba(239,68,68,0.1)"),
                                            dict(range=[40, 50], color="rgba(153,27,27,0.1)"),
                                        ],
                                    ),
                                ))
                                _efig.update_layout(**_CHART_LAYOUT_BASE, height=200, margin=dict(t=40, b=10, l=20, r=20))
                                st.plotly_chart(_efig, use_container_width=True, key=f"esg_gauge_{_elabel}")
                            else:
                                st.markdown(f'<div style="text-align:center; padding:1rem; color:#9CA3AF;">{_elabel}<br>N/A</div>', unsafe_allow_html=True)

                # Peer ESG comparison
                if cd.peer_data:
                    _peer_esg_data = []
                    for _p in cd.peer_data:
                        _ptk = _p.get("ticker", "")
                        try:
                            _ptk_obj = yf.Ticker(_ptk)
                            _psust = _ptk_obj.sustainability
                            if _psust is not None and not _psust.empty:
                                _pt_esg = float(_psust.loc['totalEsg'].iloc[0]) if 'totalEsg' in _psust.index else None
                                if _pt_esg is not None:
                                    _peer_esg_data.append({"ticker": _ptk, "score": _pt_esg})
                        except Exception:
                            pass
                    if _peer_esg_data:
                        _peer_esg_data.append({"ticker": cd.ticker, "score": _total_esg or 0})
                        _peer_esg_data.sort(key=lambda x: x["score"])
                        _esg_peer_fig = go.Figure(go.Bar(
                            x=[d["ticker"] for d in _peer_esg_data],
                            y=[d["score"] for d in _peer_esg_data],
                            marker=dict(
                                color=[_risk_color if d["ticker"] == cd.ticker else "rgba(37,99,235,0.5)" for d in _peer_esg_data],
                                line=dict(color="rgba(255,255,255,0.15)", width=1),
                            ),
                            text=[f'{d["score"]:.1f}' for d in _peer_esg_data],
                            textposition="outside",
                            textfont=dict(size=11, color="#D1D5DB"),
                        ))
                        _esg_peer_fig.update_layout(
                            **_CHART_LAYOUT_BASE, height=300,
                            title=dict(text="ESG Risk Score â€” Peer Comparison (lower is better)", font=dict(size=14, color="#F9FAFB")),
                            margin=dict(t=50, b=30, l=40, r=20),
                            yaxis=dict(title="ESG Risk Score", titlefont=dict(size=12, color="#9CA3AF")),
                        )
                        _apply_space_grid(_esg_peer_fig)
                        st.plotly_chart(_esg_peer_fig, use_container_width=True, key="esg_peer_comparison")
            except Exception:
                st.info("ESG data could not be processed for this security.")
        else:
            st.info("ğŸŒ± ESG data not available for this security.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 9b. MANAGEMENT EFFECTIVENESS SCORE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Management Effectiveness Score"):
        _section("Management Effectiveness Score", "ğŸ†")
        try:
            # Component metrics (each scored 0-20, total 0-100)
            _mgmt_components = []

            # 1. ROE (0-20): 0%=0, 15%+=20
            _roe_val = (cd.return_on_equity or 0) * 100
            _roe_score = min(20, max(0, _roe_val / 15 * 20)) if cd.return_on_equity is not None else None
            if _roe_score is not None:
                _mgmt_components.append(("Return on Equity", _roe_val, _roe_score, "%", 15))

            # 2. ROA (0-20): 0%=0, 10%+=20
            _roa_val = (cd.return_on_assets or 0) * 100
            _roa_score = min(20, max(0, _roa_val / 10 * 20)) if cd.return_on_assets is not None else None
            if _roa_score is not None:
                _mgmt_components.append(("Return on Assets", _roa_val, _roa_score, "%", 10))

            # 3. ROIC proxy (Operating Income / (Total Equity + Total Debt)) (0-20): 0%=0, 12%+=20
            _roic_val = None
            try:
                _oi_0 = cd.operating_income.iloc[0] if cd.operating_income is not None and len(cd.operating_income) > 0 else None
                _eq_0 = cd.total_equity.iloc[0] if cd.total_equity is not None and len(cd.total_equity) > 0 else None
                _td_0 = cd.total_debt.iloc[0] if cd.total_debt is not None and len(cd.total_debt) > 0 else None
                if _oi_0 and _eq_0 and _td_0 and (_eq_0 + _td_0) > 0:
                    _roic_val = (_oi_0 / (_eq_0 + _td_0)) * 100
            except Exception:
                pass
            _roic_score = min(20, max(0, _roic_val / 12 * 20)) if _roic_val is not None else None
            if _roic_score is not None:
                _mgmt_components.append(("ROIC (est.)", _roic_val, _roic_score, "%", 12))

            # 4. Revenue per Employee (0-20): $0=0, $500K+=20
            _rpe_val = None
            try:
                _rev_0 = cd.revenue.iloc[0] if cd.revenue is not None and len(cd.revenue) > 0 else None
                if _rev_0 and cd.full_time_employees and cd.full_time_employees > 0:
                    _rpe_val = _rev_0 / cd.full_time_employees
            except Exception:
                pass
            _rpe_score = min(20, max(0, (_rpe_val or 0) / 500000 * 20)) if _rpe_val is not None else None
            if _rpe_score is not None:
                _mgmt_components.append(("Revenue / Employee", _rpe_val, _rpe_score, "K", 500))

            # 5. Operating Margin Trend (0-20): improving = 20, flat = 10, declining = 0
            _opm_trend_score = None
            _opm_trend_label = "N/A"
            try:
                if cd.operating_margin_series is not None and len(cd.operating_margin_series) >= 2:
                    _opm_recent = cd.operating_margin_series.iloc[0]
                    _opm_older = cd.operating_margin_series.iloc[-1]
                    _opm_chg = _opm_recent - _opm_older
                    if _opm_chg > 0.02:
                        _opm_trend_score = 20
                        _opm_trend_label = "Expanding"
                    elif _opm_chg > -0.02:
                        _opm_trend_score = 10
                        _opm_trend_label = "Stable"
                    else:
                        _opm_trend_score = 0
                        _opm_trend_label = "Contracting"
            except Exception:
                pass
            if _opm_trend_score is not None:
                _mgmt_components.append(("Op. Margin Trend", _opm_trend_label, _opm_trend_score, "", 20))

            if _mgmt_components:
                # Calculate composite score (normalize to 0-100)
                _total_possible = len(_mgmt_components) * 20
                _total_earned = sum(c[2] for c in _mgmt_components)
                _composite = (_total_earned / _total_possible) * 100

                # Letter grade
                def _letter_grade(score):
                    if score >= 90: return "A+", "#10B981"
                    if score >= 80: return "A", "#10B981"
                    if score >= 70: return "B+", "#34D399"
                    if score >= 60: return "B", "#34D399"
                    if score >= 50: return "C+", "#F59E0B"
                    if score >= 40: return "C", "#F59E0B"
                    if score >= 30: return "D", "#EF4444"
                    return "F", "#991B1B"

                _grade, _grade_color = _letter_grade(_composite)

                _mg1, _mg2 = st.columns([1, 2])
                with _mg1:
                    _mgmt_fig = go.Figure(go.Indicator(
                        mode="gauge+number",
                        value=_composite,
                        title=dict(text=f"Grade: {_grade}", font=dict(size=20, color=_grade_color)),
                        number=dict(font=dict(size=32, color="#F9FAFB"), suffix="/100"),
                        gauge=dict(
                            axis=dict(range=[0, 100], tickfont=dict(size=10, color="#9CA3AF")),
                            bar=dict(color=_grade_color),
                            bgcolor="rgba(255,255,255,0.05)",
                            bordercolor="rgba(255,255,255,0.1)",
                            steps=[
                                dict(range=[0, 30], color="rgba(239,68,68,0.08)"),
                                dict(range=[30, 50], color="rgba(245,158,11,0.08)"),
                                dict(range=[50, 70], color="rgba(52,211,153,0.08)"),
                                dict(range=[70, 100], color="rgba(16,185,129,0.08)"),
                            ],
                        ),
                    ))
                    _mgmt_fig.update_layout(**_CHART_LAYOUT_BASE, height=250, margin=dict(t=50, b=10, l=20, r=20))
                    st.plotly_chart(_mgmt_fig, use_container_width=True, key="mgmt_effectiveness_gauge")

                with _mg2:
                    st.markdown("<p style='font-size:0.8rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;'>Component Breakdown</p>", unsafe_allow_html=True)
                    for _cname, _cval, _cscore, _csuffix, _cbench in _mgmt_components:
                        _cpct = (_cscore / 20) * 100
                        _cbar_color = "#10B981" if _cpct >= 70 else "#F59E0B" if _cpct >= 40 else "#EF4444"
                        if isinstance(_cval, str):
                            _cdisp = _cval
                        elif _csuffix == "K":
                            _cdisp = f"{cs}{_cval/1000:,.0f}K (benchmark: {cs}{_cbench}K)"
                        elif _csuffix == "%":
                            _cdisp = f"{_cval:.1f}% (benchmark: {_cbench}%)"
                        else:
                            _cdisp = f"{_cval} (max: {_cbench})"
                        st.markdown(
                            f'<div style="margin-bottom:0.5rem;">'
                            f'<div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#D1D5DB;">'
                            f'<span>{_cname}</span><span>{_cdisp}</span></div>'
                            f'<div style="background:rgba(255,255,255,0.05); border-radius:4px; height:8px; margin-top:2px;">'
                            f'<div style="background:{_cbar_color}; width:{_cpct:.0f}%; height:100%; border-radius:4px;"></div>'
                            f'</div></div>',
                            unsafe_allow_html=True,
                        )
            else:
                st.info("Insufficient financial data to calculate management effectiveness score.")
        except Exception:
            st.info("Management effectiveness data not available for this security.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 9c. DEBT MATURITY PROFILE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Debt Maturity Profile"):
        _section("Debt Maturity Profile", "ğŸ¦")
        try:
            _debt_val = cd.total_debt.iloc[0] if cd.total_debt is not None and len(cd.total_debt) > 0 else (cd.total_debt_info or 0)
            _cash_val = cd.cash_and_equivalents.iloc[0] if cd.cash_and_equivalents is not None and len(cd.cash_and_equivalents) > 0 else (cd.total_cash or 0)
            _ebitda_val = cd.ebitda.iloc[0] if cd.ebitda is not None and len(cd.ebitda) > 0 else None

            if _debt_val or _cash_val:
                _net_debt = (_debt_val or 0) - (_cash_val or 0)

                # Debt vs Cash visual
                _dm1, _dm2 = st.columns([3, 2])
                with _dm1:
                    _dm_fig = go.Figure()
                    _dm_fig.add_trace(go.Bar(
                        x=["Total Debt", "Cash & Equivalents", "Net Debt"],
                        y=[_debt_val or 0, _cash_val or 0, _net_debt],
                        marker=dict(
                            color=["#EF4444", "#10B981", "#F59E0B" if _net_debt > 0 else "#10B981"],
                            line=dict(color="rgba(255,255,255,0.15)", width=1),
                        ),
                        text=[format_number(_debt_val or 0), format_number(_cash_val or 0), format_number(abs(_net_debt))],
                        textposition="outside",
                        textfont=dict(size=12, color="#D1D5DB"),
                    ))
                    _dm_fig.update_layout(
                        **_CHART_LAYOUT_BASE, height=350,
                        title=dict(text="Debt vs Cash Position", font=dict(size=14, color="#F9FAFB")),
                        margin=dict(t=50, b=30, l=40, r=20),
                        yaxis=dict(title="Amount", titlefont=dict(size=12, color="#9CA3AF")),
                    )
                    _apply_space_grid(_dm_fig)
                    st.plotly_chart(_dm_fig, use_container_width=True, key="debt_cash_bars")

                with _dm2:
                    # Net Debt / EBITDA traffic light
                    if _ebitda_val and _ebitda_val > 0:
                        _nd_ebitda = _net_debt / _ebitda_val
                        if _nd_ebitda < 2:
                            _tl_color, _tl_label, _tl_bg = "#10B981", "Low Risk", "rgba(16,185,129,0.08)"
                        elif _nd_ebitda < 4:
                            _tl_color, _tl_label, _tl_bg = "#F59E0B", "Moderate Risk", "rgba(245,158,11,0.08)"
                        else:
                            _tl_color, _tl_label, _tl_bg = "#EF4444", "High Risk", "rgba(239,68,68,0.08)"

                        st.markdown(
                            f'<div style="background:{_tl_bg}; border:1px solid {_tl_color}40; '
                            f'border-radius:12px; padding:1rem; text-align:center; margin-bottom:0.8rem;">'
                            f'<div style="font-size:0.65rem; font-weight:700; color:#9CA3AF; text-transform:uppercase; '
                            f'letter-spacing:1.5px; margin-bottom:0.3rem;">Net Debt / EBITDA</div>'
                            f'<div style="font-size:2rem; font-weight:800; color:{_tl_color};">'
                            f'{_nd_ebitda:.1f}x</div>'
                            f'<div style="font-size:0.75rem; color:{_tl_color}; font-weight:600;">{_tl_label}</div>'
                            f'<div style="font-size:0.6rem; color:#9CA3AF; margin-top:0.3rem;">'
                            f'ğŸŸ¢ &lt;2x&nbsp; ğŸŸ¡ 2-4x&nbsp; ğŸ”´ &gt;4x</div></div>',
                            unsafe_allow_html=True,
                        )
                    else:
                        st.markdown(
                            f'<div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:1rem; text-align:center;">'
                            f'<div style="font-size:0.65rem; font-weight:700; color:#9CA3AF;">NET DEBT</div>'
                            f'<div style="font-size:1.3rem; font-weight:800; color:{"#EF4444" if _net_debt > 0 else "#10B981"};">'
                            f'{cs}{abs(_net_debt)/1e9:.1f}B {"net debt" if _net_debt > 0 else "net cash"}</div></div>',
                            unsafe_allow_html=True,
                        )

                    # Refinancing risk assessment
                    _interest = cd.interest_expense.iloc[0] if cd.interest_expense is not None and len(cd.interest_expense) > 0 else None
                    _ocf = cd.operating_cashflow_series.iloc[0] if cd.operating_cashflow_series is not None and len(cd.operating_cashflow_series) > 0 else None
                    _icr = None
                    if _interest and abs(_interest) > 0 and _ebitda_val:
                        _icr = _ebitda_val / abs(_interest)

                    st.markdown("<p style='font-size:0.75rem; font-weight:700; color:#F9FAFB; margin-top:0.5rem;'>Refinancing Risk Indicators</p>", unsafe_allow_html=True)
                    _refi_items = []
                    if _icr is not None:
                        _icr_color = "#10B981" if _icr > 5 else "#F59E0B" if _icr > 2 else "#EF4444"
                        _refi_items.append(f'<span style="color:{_icr_color};">Interest Coverage: {_icr:.1f}x</span>')
                    _dte = cd.debt_to_equity
                    if _dte is not None:
                        _dte_color = "#10B981" if _dte < 100 else "#F59E0B" if _dte < 200 else "#EF4444"
                        _refi_items.append(f'<span style="color:{_dte_color};">D/E Ratio: {_dte:.0f}%</span>')
                    if _ocf and _debt_val and _debt_val > 0:
                        _debt_payback = _debt_val / _ocf if _ocf > 0 else float('inf')
                        _dp_color = "#10B981" if _debt_payback < 5 else "#F59E0B" if _debt_payback < 10 else "#EF4444"
                        _refi_items.append(f'<span style="color:{_dp_color};">Debt Payback: {_debt_payback:.1f} yrs</span>')
                    if _refi_items:
                        st.markdown('<div style="font-size:0.8rem; line-height:2;">' + '<br>'.join(_refi_items) + '</div>', unsafe_allow_html=True)
                    else:
                        st.info("Insufficient data for refinancing risk assessment.")
            else:
                st.info("Debt position data not available for this security.")
        except Exception:
            st.info("Debt maturity data not available for this security.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 9d. ANALYST CONSENSUS DASHBOARD (enhanced)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Analyst Consensus")
    a1, a2 = st.columns([3, 2])

    with a1:
        if cd.recommendations_summary is not None and not cd.recommendations_summary.empty:
            try:
                row = cd.recommendations_summary.iloc[0]
                cats = ["Strong Buy", "Buy", "Hold", "Sell", "Strong Sell"]
                keys = ["strongBuy", "buy", "hold", "sell", "strongSell"]
                vals = []
                for k in keys:
                    try:
                        v = row.get(k, 0) if hasattr(row, 'get') else row[k] if k in row.index else 0
                        vals.append(int(v) if pd.notna(v) else 0)
                    except Exception:
                        vals.append(0)
                colors = ["#10B981", "#34D399", "#F59E0B", "#EF4444", "#991B1B"]
                total = sum(vals)

                # Wider bar for the majority category
                max_idx = vals.index(max(vals)) if vals else -1
                widths = [0.7 if i == max_idx else 0.5 for i in range(len(vals))]
                fig_rec = go.Figure(go.Bar(
                    x=vals, y=cats, orientation="h",
                    marker=dict(color=colors, line=dict(color="rgba(255,255,255,0.15)", width=1)),
                    width=widths,
                    text=[f"  {v} ({v/total*100:.0f}%)" if total > 0 else f"  {v}" for v in vals],
                    textposition="outside",
                    textfont=dict(size=11, color="#D1D5DB", family="Inter"),
                ))
                fig_rec.update_layout(
                    **_CHART_LAYOUT_BASE,
                    height=400, margin=dict(t=50, b=30, l=130, r=70),
                    title=dict(text="Analyst Recommendation Distribution",
                               font=dict(size=16, color="#F9FAFB", family="Inter")),
                    xaxis=dict(title=dict(text="# Analysts", font=dict(size=13, color="#9CA3AF")),
                               tickfont=dict(size=12, color="#9CA3AF")),
                    yaxis=dict(autorange="reversed", tickfont=dict(size=13, color="#9CA3AF")),
                    bargap=0.3,
                )
                _apply_space_grid(fig_rec, show_x_grid=True)
                st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
                st.plotly_chart(fig_rec, use_container_width=True)
                st.markdown('</div>', unsafe_allow_html=True)
            except Exception:
                st.info("Recommendation data not available.")
        else:
            st.info("Analyst recommendation data not available.")

    with a2:
        if cd.analyst_price_targets:
            pt = cd.analyst_price_targets
            st.markdown("<p style='font-size:0.85rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;'>Price Targets</p>", unsafe_allow_html=True)
            
            # Visual price target range
            pt_low = pt.get('low', 0) or 0
            pt_mean = pt.get('mean', 0) or 0
            pt_median = pt.get('median', 0) or 0
            pt_high = pt.get('high', 0) or 0
            curr = cd.current_price or 0
            
            if pt_low and pt_high and pt_high > pt_low:
                fig_pt = go.Figure()
                
                # Range bar (low to high)
                fig_pt.add_trace(go.Scatter(
                    x=[pt_low, pt_high], y=["Target", "Target"],
                    mode="lines", line=dict(color="rgba(37,99,235,0.4)", width=20),
                    showlegend=False, hoverinfo="skip",
                ))
                
                # Low marker
                fig_pt.add_trace(go.Scatter(
                    x=[pt_low], y=["Target"], mode="markers+text",
                    marker=dict(size=14, color="#EF4444", symbol="diamond"),
                    text=[f"{cs}{pt_low:,.0f}"], textposition="bottom center",
                    textfont=dict(size=10, color="#EF4444"),
                    name="Low", showlegend=False,
                ))
                
                # Mean marker
                fig_pt.add_trace(go.Scatter(
                    x=[pt_mean], y=["Target"], mode="markers+text",
                    marker=dict(size=18, color="#2563EB", symbol="star"),
                    text=[f"Mean: {cs}{pt_mean:,.0f}"], textposition="top center",
                    textfont=dict(size=11, color="#2563EB", weight="bold" if hasattr(dict, 'weight') else None),
                    name="Mean Target", showlegend=False,
                ))
                
                # High marker
                fig_pt.add_trace(go.Scatter(
                    x=[pt_high], y=["Target"], mode="markers+text",
                    marker=dict(size=14, color="#10B981", symbol="diamond"),
                    text=[f"{cs}{pt_high:,.0f}"], textposition="bottom center",
                    textfont=dict(size=10, color="#10B981"),
                    name="High", showlegend=False,
                ))
                
                # Current price line
                fig_pt.add_vline(x=curr, line_dash="dash", line_color="#F59E0B", line_width=2)
                fig_pt.add_annotation(
                    x=curr, y="Target", text=f"Current: {cs}{curr:,.0f}",
                    showarrow=True, arrowhead=2, arrowcolor="#F59E0B",
                    font=dict(size=10, color="#F59E0B"),
                    ax=0, ay=-40,
                )
                
                fig_pt.update_layout(
                    **_CHART_LAYOUT_BASE, height=150,
                    margin=dict(t=40, b=30, l=20, r=20),
                    xaxis=dict(tickprefix=cs, tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
                    yaxis=dict(visible=False),
                    showlegend=False,
                )
                st.plotly_chart(fig_pt, use_container_width=True, key="price_target_range")
            
            # Metrics row
            pt1, pt2 = st.columns(2)
            pt1.metric("Mean", f"{cs}{pt_mean:,.2f}" if pt_mean else "N/A")
            pt2.metric("Median", f"{cs}{pt_median:,.2f}" if pt_median else "N/A")
            
            if pt_mean and curr:
                upside = (pt_mean - curr) / curr * 100
                color = "#10B981" if upside >= 0 else "#EF4444"
                st.markdown(
                    f'<div style="text-align:center; margin-top:0.5rem; padding:0.5rem; '
                    f'background:{"rgba(16,185,129,0.08)" if upside >= 0 else "rgba(239,68,68,0.08)"}; '
                    f'border-radius:10px;">'
                    f'<span style="font-size:0.75rem; color:#9CA3AF; font-weight:600;">IMPLIED UPSIDE</span><br>'
                    f'<span style="font-size:1.3rem; font-weight:800; color:{color};">{upside:+.1f}%</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
        else:
            st.info("Price target data not available.")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10. EARNINGS HISTORY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Earnings History")
    if cd.earnings_dates is not None and not cd.earnings_dates.empty:
        st.dataframe(cd.earnings_dates.head(8), use_container_width=True)
    else:
        st.info("Earnings data not available.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10b. OPTIONS OVERVIEW
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Options Overview")
    try:
        tk_opt = yf.Ticker(cd.ticker)
        exp_dates = tk_opt.options
        if exp_dates and len(exp_dates) > 0:
            # Show nearest expiry options summary
            nearest_exp = exp_dates[0]
            opt_chain = tk_opt.option_chain(nearest_exp)
            
            opt_col1, opt_col2 = st.columns(2)
            
            with opt_col1:
                calls = opt_chain.calls
                if not calls.empty:
                    total_call_vol = calls["volume"].sum() if "volume" in calls.columns else 0
                    total_call_oi = calls["openInterest"].sum() if "openInterest" in calls.columns else 0
                    st.markdown(
                        f'<div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); '
                        f'border-radius:12px; padding:1rem;">'
                        f'<div style="font-size:0.75rem; font-weight:700; color:#10B981; text-transform:uppercase; '
                        f'letter-spacing:1px; margin-bottom:0.5rem;">ğŸ“ˆ Calls</div>'
                        f'<div style="display:flex; justify-content:space-between; padding:0.2rem 0;">'
                        f'<span style="color:#9CA3AF; font-size:0.75rem;">Volume</span>'
                        f'<span style="color:#F9FAFB; font-weight:700;">{total_call_vol:,.0f}</span></div>'
                        f'<div style="display:flex; justify-content:space-between; padding:0.2rem 0;">'
                        f'<span style="color:#9CA3AF; font-size:0.75rem;">Open Interest</span>'
                        f'<span style="color:#F9FAFB; font-weight:700;">{total_call_oi:,.0f}</span></div>'
                        f'<div style="display:flex; justify-content:space-between; padding:0.2rem 0;">'
                        f'<span style="color:#9CA3AF; font-size:0.75rem;">Contracts</span>'
                        f'<span style="color:#F9FAFB; font-weight:700;">{len(calls)}</span></div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
            
            with opt_col2:
                puts = opt_chain.puts
                if not puts.empty:
                    total_put_vol = puts["volume"].sum() if "volume" in puts.columns else 0
                    total_put_oi = puts["openInterest"].sum() if "openInterest" in puts.columns else 0
                    st.markdown(
                        f'<div style="background:rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.2); '
                        f'border-radius:12px; padding:1rem;">'
                        f'<div style="font-size:0.75rem; font-weight:700; color:#EF4444; text-transform:uppercase; '
                        f'letter-spacing:1px; margin-bottom:0.5rem;">ğŸ“‰ Puts</div>'
                        f'<div style="display:flex; justify-content:space-between; padding:0.2rem 0;">'
                        f'<span style="color:#9CA3AF; font-size:0.75rem;">Volume</span>'
                        f'<span style="color:#F9FAFB; font-weight:700;">{total_put_vol:,.0f}</span></div>'
                        f'<div style="display:flex; justify-content:space-between; padding:0.2rem 0;">'
                        f'<span style="color:#9CA3AF; font-size:0.75rem;">Open Interest</span>'
                        f'<span style="color:#F9FAFB; font-weight:700;">{total_put_oi:,.0f}</span></div>'
                        f'<div style="display:flex; justify-content:space-between; padding:0.2rem 0;">'
                        f'<span style="color:#9CA3AF; font-size:0.75rem;">Contracts</span>'
                        f'<span style="color:#F9FAFB; font-weight:700;">{len(puts)}</span></div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
            
            # Put/Call Ratio Gauge
            if total_call_vol and total_call_vol > 0:
                pcr = total_put_vol / total_call_vol
                pcr_color = "#EF4444" if pcr > 1.0 else "#10B981" if pcr < 0.7 else "#F59E0B"
                pcr_label = "Bearish" if pcr > 1.0 else "Bullish" if pcr < 0.7 else "Neutral"
                pcr_zone_desc = "Put heavy â€” hedging/bearish bets" if pcr > 1.0 else "Call heavy â€” bullish sentiment" if pcr < 0.7 else "Balanced sentiment"
                # Gauge visualization
                _gauge_pct = min(100, max(0, pcr / 2.0 * 100))  # scale 0-2 to 0-100
                st.markdown(
                    f'<div style="text-align:center; margin-top:0.8rem; padding:1rem; '
                    f'background:rgba(37,99,235,0.05); border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                    f'<div style="font-size:0.7rem; font-weight:700; color:#9CA3AF; text-transform:uppercase; '
                    f'letter-spacing:1px; margin-bottom:0.6rem;">Put/Call Ratio Gauge</div>'
                    f'<div style="position:relative; height:12px; background:linear-gradient(90deg, #10B981 0%, #10B981 35%, #F59E0B 35%, #F59E0B 50%, #EF4444 50%, #EF4444 100%); '
                    f'border-radius:6px; margin:0 2rem;">'
                    f'<div style="position:absolute; left:{_gauge_pct}%; top:-4px; width:4px; height:20px; '
                    f'background:white; border-radius:2px; transform:translateX(-50%); box-shadow:0 0 8px rgba(255,255,255,0.6);"></div>'
                    f'</div>'
                    f'<div style="display:flex; justify-content:space-between; margin:0.3rem 2rem 0; font-size:0.55rem; color:#9CA3AF;">'
                    f'<span>Bullish (0.0)</span><span>Neutral (0.7-1.0)</span><span>Bearish (2.0+)</span></div>'
                    f'<div style="margin-top:0.6rem;">'
                    f'<span style="font-size:2rem; font-weight:800; color:{pcr_color};">{pcr:.2f}</span>'
                    f'<span style="font-size:0.8rem; color:{pcr_color}; margin-left:0.5rem; font-weight:700;">{pcr_label}</span></div>'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; margin-top:0.2rem;">{pcr_zone_desc}</div>'
                    f'<div style="font-size:0.6rem; color:#5A567A; margin-top:0.3rem;">Expiry: {nearest_exp}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

            # Implied Volatility Smile Chart
            try:
                _iv_calls = opt_chain.calls
                _iv_puts = opt_chain.puts
                if not _iv_calls.empty and "impliedVolatility" in _iv_calls.columns and "strike" in _iv_calls.columns:
                    _iv_call_data = _iv_calls[_iv_calls["impliedVolatility"] > 0][["strike", "impliedVolatility"]].dropna()
                    _iv_put_data = _iv_puts[_iv_puts["impliedVolatility"] > 0][["strike", "impliedVolatility"]].dropna() if not _iv_puts.empty and "impliedVolatility" in _iv_puts.columns else pd.DataFrame()
                    if len(_iv_call_data) >= 3:
                        fig_iv = go.Figure()
                        fig_iv.add_trace(go.Scatter(
                            x=_iv_call_data["strike"], y=_iv_call_data["impliedVolatility"] * 100,
                            mode="lines+markers", name="Calls IV",
                            line=dict(color="#10B981", width=2), marker=dict(size=4),
                        ))
                        if len(_iv_put_data) >= 3:
                            fig_iv.add_trace(go.Scatter(
                                x=_iv_put_data["strike"], y=_iv_put_data["impliedVolatility"] * 100,
                                mode="lines+markers", name="Puts IV",
                                line=dict(color="#EF4444", width=2), marker=dict(size=4),
                            ))
                        # Mark current price
                        fig_iv.add_vline(x=cd.current_price, line_dash="dash", line_color="#2563EB",
                                         annotation_text=f"Current: {cs}{cd.current_price:,.2f}")
                        fig_iv.update_layout(
                            **_CHART_LAYOUT_BASE,
                            height=350,
                            margin=dict(t=30, b=40, l=50, r=30),
                            xaxis=dict(title="Strike Price", tickfont=dict(size=11, color="#9CA3AF")),
                            yaxis=dict(title="Implied Volatility (%)", tickfont=dict(size=11, color="#9CA3AF")),
                            legend=dict(font=dict(size=11, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
                        )
                        _apply_space_grid(fig_iv)
                        st.markdown(
                            '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-top:0.8rem; margin-bottom:0.3rem; '
                            'text-transform:uppercase; letter-spacing:1px;">ğŸ“ˆ Volatility Smile</div>',
                            unsafe_allow_html=True,
                        )
                        st.plotly_chart(fig_iv, use_container_width=True, key="iv_smile_chart")
            except Exception:
                pass

            # Available expiration dates
            st.markdown(
                f'<div style="font-size:0.7rem; color:#9CA3AF; margin-top:0.5rem; text-align:center;">'
                f'{len(exp_dates)} expiration dates available: {", ".join(exp_dates[:6])}'
                f'{"..." if len(exp_dates) > 6 else ""}</div>',
                unsafe_allow_html=True,
            )
        else:
            st.info("Options data not available for this ticker.")
    except Exception:
        st.info("Options data not available for this ticker.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10c. DIVIDEND ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if cd.dividend_yield and cd.dividend_yield > 0:
        _section("Dividend Analysis")
        
        # Fetch ticker info before columns to avoid NameError
        tk_div = None
        info_div = {}
        try:
            tk_div = yf.Ticker(cd.ticker)
            info_div = tk_div.info or {}
        except Exception:
            pass
        
        div_col1, div_col2, div_col3, div_col4 = st.columns(4)
        
        with div_col1:
            # yfinance may return dividendYield as decimal (0.009) or pct-like (0.9)
            dy = cd.dividend_yield * 100
            dy_color = "#10B981" if dy > 3 else "#F59E0B" if dy > 1 else "#9CA3AF"
            st.markdown(
                f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Dividend Yield</div>'
                f'<div style="font-size:1.4rem; font-weight:800; color:{dy_color};">{dy:.2f}%</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        with div_col2:
            try:
                payout = info_div.get("payoutRatio", 0)
                payout_pct = payout * 100 if payout and payout < 5 else payout or 0
                po_color = "#EF4444" if payout_pct > 80 else "#10B981" if payout_pct < 60 else "#F59E0B"
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Payout Ratio</div>'
                    f'<div style="font-size:1.4rem; font-weight:800; color:{po_color};">{payout_pct:.0f}%</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            except Exception:
                st.markdown(
                    '<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    'border-radius:12px;"><div style="color:#9CA3AF;">Payout N/A</div></div>',
                    unsafe_allow_html=True,
                )
        
        with div_col3:
            try:
                fwd_div = info_div.get("dividendRate", 0) or 0
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Annual Dividend</div>'
                    f'<div style="font-size:1.4rem; font-weight:800; color:#F9FAFB;">{cs}{fwd_div:.2f}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            except Exception:
                st.markdown(
                    '<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    'border-radius:12px;"><div style="color:#9CA3AF;">Annual Dividend N/A</div></div>',
                    unsafe_allow_html=True,
                )
        
        with div_col4:
            try:
                ex_date = info_div.get("exDividendDate")
                if ex_date:
                    from datetime import date as date_type
                    ex_dt = datetime.fromtimestamp(ex_date) if isinstance(ex_date, (int, float)) else ex_date
                    ex_str = ex_dt.strftime("%b %d, %Y") if hasattr(ex_dt, 'strftime') else str(ex_dt)
                else:
                    ex_str = "N/A"
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Ex-Dividend Date</div>'
                    f'<div style="font-size:0.95rem; font-weight:700; color:#F9FAFB; margin-top:0.2rem;">{ex_str}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            except Exception:
                st.markdown(
                    '<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    'border-radius:12px;"><div style="color:#9CA3AF;">Date N/A</div></div>',
                    unsafe_allow_html=True,
                )
        
        # Dividend history chart
        try:
            if tk_div:
                divs = tk_div.dividends
            else:
                divs = None
            if divs is not None and not divs.empty:
                # Last 5 years
                divs_recent = divs.last("5Y") if hasattr(divs, "last") else divs.tail(20)
                if len(divs_recent) > 2:
                    fig_div = go.Figure()
                    fig_div.add_trace(go.Bar(
                        x=divs_recent.index, y=divs_recent.values,
                        marker_color="rgba(37,99,235,0.6)",
                        name="Dividend",
                    ))
                    fig_div.update_layout(
                        **_CHART_LAYOUT_BASE, height=250,
                        margin=dict(t=20, b=30, l=50, r=30),
                        yaxis=dict(tickprefix=cs, tickfont=dict(size=10, color="#9CA3AF"),
                                  title=dict(text="Dividend/Share", font=dict(size=11, color="#9CA3AF"))),
                        xaxis=dict(showgrid=False, tickfont=dict(size=10, color="#9CA3AF")),
                        showlegend=False,
                    )
                    _apply_space_grid(fig_div)
                    st.plotly_chart(fig_div, use_container_width=True, key="dividend_history_chart")
        except Exception:
            pass

        # â”€â”€ Dividend Deep Dive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with _safe_section("Dividend Deep Dive"):
            try:
                tk_dd = yf.Ticker(cd.ticker)
                info_dd = tk_dd.info or {}
                divs_dd = tk_dd.dividends
            except Exception:
                divs_dd = None
                info_dd = {}

            if divs_dd is not None and len(divs_dd) > 4:
                st.markdown(
                    '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
                    'letter-spacing:0.5px; margin:1.2rem 0 0.5rem;">ğŸ“ˆ Dividend Growth Analysis</div>',
                    unsafe_allow_html=True,
                )

                # Calculate annual dividends
                _div_series = divs_dd.copy()
                _div_series.index = pd.to_datetime(_div_series.index)
                _annual_divs = _div_series.resample('YE').sum()
                _annual_divs = _annual_divs[_annual_divs > 0]

                # CAGR calculations
                def _div_cagr(series, years):
                    if len(series) < years + 1:
                        return None
                    end_val = series.iloc[-1]
                    start_val = series.iloc[-years - 1]
                    if start_val <= 0 or end_val <= 0:
                        return None
                    return (end_val / start_val) ** (1.0 / years) - 1

                cagr_3 = _div_cagr(_annual_divs, 3)
                cagr_5 = _div_cagr(_annual_divs, 5)
                cagr_10 = _div_cagr(_annual_divs, 10)

                cagr_cols = st.columns(3)
                for i, (label, val) in enumerate([("3Y CAGR", cagr_3), ("5Y CAGR", cagr_5), ("10Y CAGR", cagr_10)]):
                    with cagr_cols[i]:
                        if val is not None:
                            _c = "#10B981" if val > 0.05 else "#F59E0B" if val > 0 else "#EF4444"
                            st.markdown(
                                f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); border-radius:10px;">'
                                f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">{label}</div>'
                                f'<div style="font-size:1.2rem; font-weight:800; color:{_c};">{val*100:.1f}%</div></div>',
                                unsafe_allow_html=True,
                            )
                        else:
                            st.markdown(
                                f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); border-radius:10px;">'
                                f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600;">{label}</div>'
                                f'<div style="font-size:1.2rem; color:#9CA3AF;">N/A</div></div>',
                                unsafe_allow_html=True,
                            )

                # Payout ratio & FCF coverage trends
                _payout_ratios = []
                _fcf_coverage = []
                try:
                    _inc_stmt = tk_dd.income_stmt
                    _cf_stmt = tk_dd.cashflow
                    if _inc_stmt is not None and _cf_stmt is not None:
                        for col in _inc_stmt.columns[:5]:
                            yr = str(col.year) if hasattr(col, 'year') else str(col)[:4]
                            net_income = _inc_stmt[col].get("Net Income", None) or _inc_stmt[col].get("Net Income Common Stockholders", None)
                            divs_paid = None
                            fcf_val = None
                            for row_name in _cf_stmt.index:
                                if "dividend" in str(row_name).lower():
                                    divs_paid = _cf_stmt[col].get(row_name, None)
                                if "free cash flow" in str(row_name).lower():
                                    fcf_val = _cf_stmt[col].get(row_name, None)
                            if divs_paid is not None and net_income and net_income != 0:
                                _payout_ratios.append({"Year": yr, "Payout Ratio": abs(float(divs_paid)) / abs(float(net_income)) * 100})
                            if divs_paid is not None and fcf_val and fcf_val != 0:
                                _fcf_coverage.append({"Year": yr, "FCF Coverage": abs(float(fcf_val)) / abs(float(divs_paid))})
                except Exception:
                    pass

                if _payout_ratios or _fcf_coverage:
                    pr_cols = st.columns(2)
                    if _payout_ratios:
                        with pr_cols[0]:
                            _pr_df = pd.DataFrame(_payout_ratios[::-1])
                            fig_pr = go.Figure(go.Bar(x=_pr_df["Year"], y=_pr_df["Payout Ratio"],
                                marker_color=["#EF4444" if v > 80 else "#F59E0B" if v > 60 else "#10B981" for v in _pr_df["Payout Ratio"]]))
                            fig_pr.update_layout(**_CHART_LAYOUT_BASE, height=220, margin=dict(t=25, b=25, l=40, r=15),
                                title=dict(text="Payout Ratio %", font=dict(size=11, color="#60A5FA")),
                                yaxis=dict(ticksuffix="%", tickfont=dict(size=9, color="#9CA3AF")),
                                xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")), showlegend=False)
                            _apply_space_grid(fig_pr)
                            st.plotly_chart(fig_pr, use_container_width=True, key="div_payout_ratio_chart")
                    if _fcf_coverage:
                        with pr_cols[1]:
                            _fc_df = pd.DataFrame(_fcf_coverage[::-1])
                            fig_fc = go.Figure(go.Bar(x=_fc_df["Year"], y=_fc_df["FCF Coverage"],
                                marker_color=["#10B981" if v > 2 else "#F59E0B" if v > 1 else "#EF4444" for v in _fc_df["FCF Coverage"]]))
                            fig_fc.update_layout(**_CHART_LAYOUT_BASE, height=220, margin=dict(t=25, b=25, l=40, r=15),
                                title=dict(text="FCF Coverage (x)", font=dict(size=11, color="#60A5FA")),
                                yaxis=dict(ticksuffix="x", tickfont=dict(size=9, color="#9CA3AF")),
                                xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")), showlegend=False)
                            _apply_space_grid(fig_fc)
                            st.plotly_chart(fig_fc, use_container_width=True, key="div_fcf_coverage_chart")

                # â”€â”€ Dividend Discount Model (DDM) â”€â”€
                st.markdown(
                    '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
                    'letter-spacing:0.5px; margin:1.2rem 0 0.5rem;">ğŸ§® Dividend Discount Model (Gordon Growth)</div>',
                    unsafe_allow_html=True,
                )
                _current_div = info_dd.get("dividendRate", 0) or 0
                _growth_default = cagr_5 if cagr_5 and cagr_5 > 0 else 0.03
                _price_now = cd.current_price or info_dd.get("currentPrice", 0) or 0

                ddm_c1, ddm_c2 = st.columns(2)
                with ddm_c1:
                    ddm_req_return = st.slider("Required Return (%)", 5.0, 20.0, 10.0, 0.5, key="ddm_req_return") / 100
                with ddm_c2:
                    ddm_growth = st.slider("Dividend Growth (%)", 0.0, 15.0, min(float(_growth_default * 100), 14.0), 0.5, key="ddm_growth") / 100

                if _current_div > 0 and ddm_req_return > ddm_growth:
                    d1 = _current_div * (1 + ddm_growth)
                    ddm_value = d1 / (ddm_req_return - ddm_growth)
                    _updown = ((ddm_value / _price_now) - 1) * 100 if _price_now > 0 else 0
                    _ud_color = "#10B981" if _updown > 0 else "#EF4444"

                    ddm_m1, ddm_m2, ddm_m3 = st.columns(3)
                    with ddm_m1:
                        st.markdown(f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); border-radius:10px;">'
                            f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600;">DDM INTRINSIC VALUE</div>'
                            f'<div style="font-size:1.3rem; font-weight:800; color:#2563EB;">{cs}{ddm_value:.2f}</div></div>', unsafe_allow_html=True)
                    with ddm_m2:
                        st.markdown(f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); border-radius:10px;">'
                            f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600;">CURRENT PRICE</div>'
                            f'<div style="font-size:1.3rem; font-weight:800; color:#F9FAFB;">{cs}{_price_now:.2f}</div></div>', unsafe_allow_html=True)
                    with ddm_m3:
                        st.markdown(f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); border-radius:10px;">'
                            f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600;">UPSIDE / DOWNSIDE</div>'
                            f'<div style="font-size:1.3rem; font-weight:800; color:{_ud_color};">{_updown:+.1f}%</div></div>', unsafe_allow_html=True)

                    # Sensitivity table
                    st.markdown('<div style="font-size:0.72rem; font-weight:700; color:#9CA3AF; margin:0.8rem 0 0.3rem;">Sensitivity: DDM Value by Required Return vs Growth Rate</div>', unsafe_allow_html=True)
                    _rr_range = [0.06, 0.08, 0.10, 0.12, 0.14, 0.16]
                    _gr_range = [0.01, 0.02, 0.03, 0.04, 0.05, 0.06]
                    sens_data = {}
                    for gr in _gr_range:
                        row = {}
                        for rr in _rr_range:
                            if rr > gr:
                                row[f"{rr*100:.0f}%"] = f"{cs}{_current_div * (1+gr) / (rr - gr):.1f}"
                            else:
                                row[f"{rr*100:.0f}%"] = "âˆ"
                        sens_data[f"{gr*100:.0f}%"] = row
                    sens_df = pd.DataFrame(sens_data).T
                    sens_df.index.name = "Growth \\ Req Return"
                    st.dataframe(sens_df, use_container_width=True)
                elif _current_div == 0:
                    st.info("Company does not currently pay dividends â€” DDM not applicable.")

                # â”€â”€ Yield Comparison â”€â”€
                st.markdown(
                    '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
                    'letter-spacing:0.5px; margin:1.2rem 0 0.5rem;">ğŸ“Š Yield Comparison</div>',
                    unsafe_allow_html=True,
                )
                dy_val = (cd.dividend_yield or 0) * 100
                _yield_data = {
                    f"{cd.ticker}": dy_val,
                    "10Y Treasury": 4.25,
                    "S&P 500 Avg": 1.3,
                    "Sector Avg": dy_val * 0.85,  # approximate
                }
                fig_yc = go.Figure(go.Bar(
                    x=list(_yield_data.keys()), y=list(_yield_data.values()),
                    marker_color=["#2563EB", "#3B82F6", "#F59E0B", "#8B5CF6"],
                    text=[f"{v:.2f}%" for v in _yield_data.values()],
                    textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
                ))
                fig_yc.update_layout(**_CHART_LAYOUT_BASE, height=250, margin=dict(t=20, b=30, l=40, r=20),
                    yaxis=dict(ticksuffix="%", tickfont=dict(size=9, color="#9CA3AF")),
                    xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")), showlegend=False)
                _apply_space_grid(fig_yc)
                st.plotly_chart(fig_yc, use_container_width=True, key="div_yield_comparison")

        _divider()
    else:
        # No dividend data available
        _section("Dividend Analysis")
        st.markdown(
            '<div style="text-align:center; padding:2rem; background:rgba(37,99,235,0.05); '
            'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
            '<div style="font-size:1rem; color:#9CA3AF;">ğŸ“Š No dividend data available for this company</div>'
            '</div>',
            unsafe_allow_html=True,
        )
        _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10d. FINANCIAL HEALTH SCORECARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Financial Health Scorecard")
    
    # Helper to safely extract scalar from Series or scalar
    def _safe_val(v):
        if v is None:
            return None
        if hasattr(v, 'iloc'):
            try:
                return float(v.iloc[0]) if len(v) > 0 else None
            except Exception:
                return None
        try:
            return float(v)
        except (TypeError, ValueError):
            return None
    
    _ni = _safe_val(getattr(cd, 'net_income', None))
    _ocf = _safe_val(getattr(cd, 'operating_cashflow_series', getattr(cd, 'operating_cash_flow', None)))
    _fcf = _safe_val(getattr(cd, 'free_cashflow_series', getattr(cd, 'free_cash_flow', None)))
    _roa = _safe_val(getattr(cd, 'return_on_assets', getattr(cd, 'roa', None)))
    _cr = _safe_val(getattr(cd, 'current_ratio', None))
    _gm = _safe_val(getattr(cd, 'gross_margins', getattr(cd, 'gross_margin', None)))
    _rg = _safe_val(getattr(cd, 'revenue_growth', None))
    
    # Calculate a simplified Piotroski-inspired score
    score_items = []
    total_score = 0
    
    # 1. Profitability: Net Income > 0
    if _ni is not None and _ni > 0:
        score_items.append(("Net Income Positive", True, "Profitability"))
        total_score += 1
    else:
        score_items.append(("Net Income Positive", False, "Profitability"))
    
    # 2. ROA > 0
    if _roa is not None and _roa > 0:
        score_items.append(("ROA Positive", True, "Profitability"))
        total_score += 1
    else:
        score_items.append(("ROA Positive", False, "Profitability"))
    
    # 3. Operating Cash Flow > 0
    if _ocf is not None and _ocf > 0:
        score_items.append(("Operating Cash Flow Positive", True, "Profitability"))
        total_score += 1
    else:
        score_items.append(("Operating Cash Flow Positive", False, "Profitability"))
    
    # 4. Cash Flow > Net Income (quality of earnings)
    if _ocf is not None and _ni is not None and _ocf > _ni:
        score_items.append(("Cash Flow > Net Income", True, "Profitability"))
        total_score += 1
    else:
        score_items.append(("Cash Flow > Net Income", False, "Profitability"))
    
    # 5. Current Ratio > 1
    if _cr is not None and _cr > 1:
        score_items.append(("Current Ratio > 1", True, "Leverage"))
        total_score += 1
    else:
        score_items.append(("Current Ratio > 1", False, "Leverage"))
    
    # 6. Gross Margin Positive
    if _gm is not None and _gm > 0:
        score_items.append(("Gross Margin Positive", True, "Efficiency"))
        total_score += 1
    else:
        score_items.append(("Gross Margin Positive", False, "Efficiency"))
    
    # 7. Revenue Growth
    if _rg is not None and _rg > 0:
        score_items.append(("Revenue Growing", True, "Efficiency"))
        total_score += 1
    else:
        score_items.append(("Revenue Growing", False, "Efficiency"))
    
    # 8. Positive Free Cash Flow
    if _fcf is not None and _fcf > 0:
        score_items.append(("Free Cash Flow Positive", True, "Profitability"))
        total_score += 1
    else:
        score_items.append(("Free Cash Flow Positive", False, "Profitability"))
    
    max_score = len(score_items) if score_items else 8
    score_pct = (total_score / max_score * 100) if max_score > 0 else 0
    
    if score_pct >= 75:
        grade = "A"
        grade_color = "#10B981"
        grade_label = "Strong"
    elif score_pct >= 50:
        grade = "B"
        grade_color = "#34D399"
        grade_label = "Good"
    elif score_pct >= 25:
        grade = "C"
        grade_color = "#F59E0B"
        grade_label = "Fair"
    else:
        grade = "D"
        grade_color = "#EF4444"
        grade_label = "Weak"
    
    # Score display
    sc_col1, sc_col2 = st.columns([1, 2])
    
    with sc_col1:
        st.markdown(
            f'<div style="text-align:center; padding:1.5rem; background:rgba(37,99,235,0.05); '
            f'border-radius:16px; border:1px solid rgba(37,99,235,0.15);">'
            f'<div style="font-size:3rem; font-weight:900; color:{grade_color};">{grade}</div>'
            f'<div style="font-size:0.85rem; font-weight:700; color:{grade_color};">{grade_label}</div>'
            f'<div style="font-size:0.7rem; color:#9CA3AF; margin-top:0.3rem;">{total_score}/{max_score} criteria met</div>'
            f'<div style="margin-top:0.8rem; background:rgba(255,255,255,0.05); border-radius:8px; '
            f'height:8px; overflow:hidden;">'
            f'<div style="width:{score_pct}%; height:100%; background:{grade_color}; border-radius:8px;"></div>'
            f'</div>'
            f'</div>',
            unsafe_allow_html=True,
        )
    
    with sc_col2:
        for item_name, passed, category in score_items:
            icon = "âœ…" if passed else "âŒ"
            st.markdown(
                f'<div style="display:flex; align-items:center; gap:0.5rem; padding:0.25rem 0; '
                f'border-bottom:1px solid rgba(255,255,255,0.03);">'
                f'<span style="font-size:0.8rem;">{icon}</span>'
                f'<span style="color:#F9FAFB; font-size:0.78rem; flex:1;">{item_name}</span>'
                f'<span style="color:#9CA3AF; font-size:0.65rem; font-weight:600;">{category}</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
    
    # â”€â”€ Piotroski F-Score (from data_engine) â”€â”€
    try:
        pio_result = calculate_piotroski_score(cd)
        if pio_result and pio_result.get("score") is not None:
            pio_score = pio_result["score"]
            pio_max = pio_result.get("max_score", 9)
            if pio_score >= 7:
                pio_color, pio_label = "#10B981", "Strong"
            elif pio_score >= 4:
                pio_color, pio_label = "#F59E0B", "Moderate"
            else:
                pio_color, pio_label = "#EF4444", "Weak"
            st.markdown(
                f'<div style="text-align:center; padding:0.8rem; margin-top:0.5rem; '
                f'background:rgba(37,99,235,0.05); border-radius:12px; '
                f'border:1px solid rgba(37,99,235,0.15);">'
                f'<span style="font-size:0.75rem; color:#9CA3AF;">Piotroski F-Score</span><br>'
                f'<span style="font-size:1.8rem; font-weight:900; color:{pio_color};">{pio_score}</span>'
                f'<span style="font-size:0.8rem; color:#9CA3AF;">/{pio_max}</span>'
                f'<span style="font-size:0.75rem; color:{pio_color}; margin-left:0.5rem;">{pio_label}</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
    except Exception:
        pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10d-i-b. DEBT COVENANT MONITOR
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Debt Covenant Monitor"):
        _section("Debt Covenant Monitor", "ğŸ“‹")
        try:
            _cov_ebitda = _safe_val(getattr(cd, 'ebitda', None))
            _cov_ebit = _safe_val(getattr(cd, 'ebit', None))
            _cov_interest = _safe_val(getattr(cd, 'interest_expense', None))
            _cov_total_debt = _safe_val(getattr(cd, 'total_debt', None))
            _cov_cash = _safe_val(getattr(cd, 'total_cash', getattr(cd, 'cash', None)))
            _cov_cr = _safe_val(getattr(cd, 'current_ratio', None))
            _cov_capex = _safe_val(getattr(cd, 'capital_expenditures', getattr(cd, 'capex', None)))
            if _cov_capex and _cov_capex < 0:
                _cov_capex = abs(_cov_capex)
            if _cov_interest and _cov_interest < 0:
                _cov_interest = abs(_cov_interest)

            _cov_net_debt = (((_cov_total_debt or 0) - (_cov_cash or 0))) if _cov_total_debt else None
            _cov_metrics = []

            # 1. Net Debt / EBITDA (leverage)
            if _cov_net_debt is not None and _cov_ebitda and _cov_ebitda > 0:
                _lev = _cov_net_debt / _cov_ebitda
                if _lev < 2.0:
                    _lev_status, _lev_color, _lev_icon = "Safe", "#10B981", "ğŸŸ¢"
                elif _lev < 3.5:
                    _lev_status, _lev_color, _lev_icon = "Watch", "#F59E0B", "ğŸŸ¡"
                else:
                    _lev_status, _lev_color, _lev_icon = "Breach Risk", "#EF4444", "ğŸ”´"
                _cov_metrics.append(("Net Debt / EBITDA", f"{_lev:.2f}x", "< 3.5x", _lev_status, _lev_color, _lev_icon, _lev, 3.5))

            # 2. Interest Coverage = EBIT / Interest Expense
            if _cov_ebit and _cov_interest and _cov_interest > 0:
                _icr = _cov_ebit / _cov_interest
                if _icr > 5.0:
                    _icr_status, _icr_color, _icr_icon = "Safe", "#10B981", "ğŸŸ¢"
                elif _icr > 3.0:
                    _icr_status, _icr_color, _icr_icon = "Watch", "#F59E0B", "ğŸŸ¡"
                else:
                    _icr_status, _icr_color, _icr_icon = "Breach Risk", "#EF4444", "ğŸ”´"
                _cov_metrics.append(("Interest Coverage", f"{_icr:.2f}x", "> 3.0x", _icr_status, _icr_color, _icr_icon, _icr, 3.0))

            # 3. Current Ratio
            if _cov_cr is not None:
                if _cov_cr > 1.5:
                    _cr_status, _cr_color, _cr_icon = "Safe", "#10B981", "ğŸŸ¢"
                elif _cov_cr > 1.0:
                    _cr_status, _cr_color, _cr_icon = "Watch", "#F59E0B", "ğŸŸ¡"
                else:
                    _cr_status, _cr_color, _cr_icon = "Breach Risk", "#EF4444", "ğŸ”´"
                _cov_metrics.append(("Current Ratio", f"{_cov_cr:.2f}x", "> 1.0x", _cr_status, _cr_color, _cr_icon, _cov_cr, 1.0))

            # 4. Debt Service Coverage = (EBITDA - CapEx) / (Interest + Principal estimate)
            if _cov_ebitda and _cov_ebitda > 0 and _cov_interest and _cov_interest > 0:
                _capex_use = _cov_capex if _cov_capex else 0
                _principal_est = (_cov_total_debt or 0) * 0.05  # assume 5% annual principal
                _dscr_denom = _cov_interest + _principal_est
                if _dscr_denom > 0:
                    _dscr = (_cov_ebitda - _capex_use) / _dscr_denom
                    if _dscr > 2.0:
                        _dscr_status, _dscr_color, _dscr_icon = "Safe", "#10B981", "ğŸŸ¢"
                    elif _dscr > 1.2:
                        _dscr_status, _dscr_color, _dscr_icon = "Watch", "#F59E0B", "ğŸŸ¡"
                    else:
                        _dscr_status, _dscr_color, _dscr_icon = "Breach Risk", "#EF4444", "ğŸ”´"
                    _cov_metrics.append(("Debt Service Coverage", f"{_dscr:.2f}x", "> 1.2x", _dscr_status, _dscr_color, _dscr_icon, _dscr, 1.2))

            if _cov_metrics:
                # Traffic light summary
                _tl_icons = " ".join(m[5] for m in _cov_metrics)
                st.markdown(
                    f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; margin-bottom:1rem; border:1px solid rgba(37,99,235,0.15);">'
                    f'<span style="font-size:1.5rem; letter-spacing:0.3rem;">{_tl_icons}</span>'
                    f'<div style="font-size:0.7rem; color:#9CA3AF; margin-top:0.3rem;">Covenant Health Summary</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

                # Gauge-style display for each metric
                _cov_gauge_cols = st.columns(len(_cov_metrics))
                for idx, (_name, _val_str, _thresh_str, _status, _color, _icon, _raw_val, _thresh) in enumerate(_cov_metrics):
                    with _cov_gauge_cols[idx]:
                        # Determine gauge fill (normalize to 0-100 for display)
                        if "Net Debt" in _name:
                            _fill_pct = max(0, min(100, (1 - _raw_val / 5.0) * 100))  # inverse - lower is better
                        else:
                            _fill_pct = max(0, min(100, (_raw_val / (_thresh * 2)) * 100))
                        st.markdown(
                            f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.04); '
                            f'border-radius:12px; border:1px solid {_color}33;">'
                            f'<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.3rem;">{_name}</div>'
                            f'<div style="font-size:1.5rem; font-weight:900; color:{_color};">{_val_str}</div>'
                            f'<div style="margin:0.5rem auto; width:80%; background:rgba(255,255,255,0.05); '
                            f'border-radius:6px; height:6px; overflow:hidden;">'
                            f'<div style="width:{_fill_pct}%; height:100%; background:{_color}; border-radius:6px;"></div>'
                            f'</div>'
                            f'<div style="font-size:0.65rem; color:#9CA3AF;">Threshold: {_thresh_str}</div>'
                            f'<div style="font-size:0.7rem; font-weight:700; color:{_color};">{_icon} {_status}</div>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )
            else:
                st.info("Insufficient financial data for covenant analysis.")
        except Exception:
            st.info("Could not compute covenant metrics.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10d-i-b. CREDIT RATING ESTIMATOR
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Credit Rating Estimator"):
        _section("Synthetic Credit Rating", "ğŸ›ï¸")
        try:
            _cr_ebitda = _safe_val(getattr(cd, 'ebitda', None))
            _cr_ebit = _safe_val(getattr(cd, 'operating_income', None))
            _cr_interest = _safe_val(getattr(cd, 'interest_expense', None))
            _cr_total_debt = _safe_val(getattr(cd, 'total_debt', None))
            _cr_op_margins = getattr(cd, 'operating_margins', None)
            _cr_mcap = getattr(cd, 'market_cap', 0) or 0

            _rating_scale = ["AAA", "AA+", "AA", "AA-", "A+", "A", "A-",
                             "BBB+", "BBB", "BBB-", "BB+", "BB", "BB-",
                             "B+", "B", "B-", "CCC+", "CCC", "CCC-", "CC", "C"]

            _cr_components = []

            # Interest Coverage Score
            if _cr_ebit and _cr_interest and abs(_cr_interest) > 0:
                _ic_ratio = abs(_cr_ebit / _cr_interest)
                if _ic_ratio > 8:
                    _ic_score = 2  # AAA-AA range
                    _ic_label = f"{_ic_ratio:.1f}x â€” Excellent"
                elif _ic_ratio > 4:
                    _ic_score = 6  # A-BBB range
                    _ic_label = f"{_ic_ratio:.1f}x â€” Adequate"
                elif _ic_ratio > 2:
                    _ic_score = 11  # BB-B range
                    _ic_label = f"{_ic_ratio:.1f}x â€” Weak"
                else:
                    _ic_score = 17  # CCC or below
                    _ic_label = f"{_ic_ratio:.1f}x â€” Distressed"
                _cr_components.append(("Interest Coverage", _ic_score, _ic_label))

            # Debt/EBITDA Score
            if _cr_total_debt is not None and _cr_ebitda and abs(_cr_ebitda) > 0:
                _de_ratio = abs(_cr_total_debt / _cr_ebitda)
                if _de_ratio < 1:
                    _de_score = 0
                    _de_label = f"{_de_ratio:.1f}x â€” Very Low Leverage"
                elif _de_ratio < 2:
                    _de_score = 4
                    _de_label = f"{_de_ratio:.1f}x â€” Conservative"
                elif _de_ratio < 4:
                    _de_score = 9
                    _de_label = f"{_de_ratio:.1f}x â€” Moderate"
                else:
                    _de_score = 14
                    _de_label = f"{_de_ratio:.1f}x â€” High Leverage"
                _cr_components.append(("Debt / EBITDA", _de_score, _de_label))

            # Operating Margin Score
            if _cr_op_margins is not None:
                _opm = _cr_op_margins * 100 if abs(_cr_op_margins) < 1 else _cr_op_margins
                if _opm > 25:
                    _om_score = 2
                    _om_label = f"{_opm:.1f}% â€” Premium"
                elif _opm > 15:
                    _om_score = 6
                    _om_label = f"{_opm:.1f}% â€” Solid"
                else:
                    _om_score = 12
                    _om_label = f"{_opm:.1f}% â€” Weaker"
                _cr_components.append(("Operating Margin", _om_score, _om_label))

            # Size Premium
            if _cr_mcap > 50e9:
                _sz_adj = -1
                _sz_label = f"{format_number(_cr_mcap, currency_symbol=cs)} â€” Large Cap (+1 notch)"
            elif _cr_mcap > 10e9:
                _sz_adj = 0
                _sz_label = f"{format_number(_cr_mcap, currency_symbol=cs)} â€” Mid Cap (neutral)"
            elif _cr_mcap > 1e9:
                _sz_adj = 0
                _sz_label = f"{format_number(_cr_mcap, currency_symbol=cs)} â€” Small-Mid Cap (neutral)"
            else:
                _sz_adj = 1
                _sz_label = f"{format_number(_cr_mcap, currency_symbol=cs)} â€” Small Cap (-1 notch)"

            if _cr_components:
                _avg_score = sum(c[1] for c in _cr_components) / len(_cr_components)
                _final_idx = max(0, min(len(_rating_scale) - 1, int(round(_avg_score)) + _sz_adj))
                _final_rating = _rating_scale[_final_idx]
                _cr_components.append(("Size Adjustment", _sz_adj, _sz_label))

                # Color mapping
                if _final_idx <= 3:
                    _badge_color = "#10B981"  # Green - Investment Grade High
                elif _final_idx <= 9:
                    _badge_color = "#2563EB"  # Purple - Investment Grade
                elif _final_idx <= 14:
                    _badge_color = "#F5A623"  # Orange - Speculative
                else:
                    _badge_color = "#EF4444"  # Red - Distressed

                _ig_label = "Investment Grade" if _final_idx <= 9 else ("Speculative Grade" if _final_idx <= 16 else "Distressed")

                st.markdown(
                    f'<div style="text-align:center; padding:1.5rem;">'
                    f'<div style="font-size:0.8rem; color:#9CA3AF; margin-bottom:0.3rem;">Estimated Synthetic Rating</div>'
                    f'<div style="display:inline-block; background:{_badge_color}; color:white; font-size:3rem; '
                    f'font-weight:900; padding:0.5rem 2rem; border-radius:12px; letter-spacing:2px; '
                    f'box-shadow: 0 4px 20px {_badge_color}66;">{_final_rating}</div>'
                    f'<div style="font-size:0.9rem; color:{_badge_color}; margin-top:0.5rem; font-weight:600;">{_ig_label}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

                # Component breakdown
                st.markdown("##### Component Breakdown")
                for _comp_name, _comp_score, _comp_label in _cr_components:
                    _comp_rating = _rating_scale[max(0, min(len(_rating_scale) - 1, int(round(_comp_score))))] if _comp_name != "Size Adjustment" else (f"{'+1' if _sz_adj < 0 else ('-1' if _sz_adj > 0 else '0')} notch")
                    st.markdown(
                        f'<div style="display:flex; justify-content:space-between; align-items:center; '
                        f'padding:0.5rem 0.8rem; margin:0.3rem 0; background:rgba(37,99,235,0.05); border-radius:8px;">'
                        f'<span style="color:#C4B5FD; font-weight:600;">{_comp_name}</span>'
                        f'<span style="color:#9CA3AF;">{_comp_label}</span>'
                        f'<span style="color:white; font-weight:700; background:rgba(37,99,235,0.2); padding:2px 10px; border-radius:6px;">{_comp_rating}</span>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

                st.caption("âš ï¸ This is a simplified model-based estimate, not an official credit agency rating.")
            else:
                st.info("Insufficient data to estimate credit rating.")
        except Exception:
            st.info("Could not compute synthetic credit rating.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10d-ii. EARNINGS QUALITY SCORE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Earnings Quality"):
        _section("Earnings Quality Score", "ğŸ”")
        try:
            _eq_ni = _safe_val(getattr(cd, 'net_income', None))
            _eq_ocf = _safe_val(getattr(cd, 'operating_cashflow_series', getattr(cd, 'operating_cash_flow', None)))
            _eq_ta = _safe_val(getattr(cd, 'total_assets', None))
            _eq_rev = getattr(cd, 'quarterly_revenue', getattr(cd, 'revenue', None))

            _eq_scores = []
            _eq_details = []

            # 1. Accruals Ratio
            if _eq_ni is not None and _eq_ocf is not None and _eq_ta is not None and _eq_ta > 0:
                _eq_accruals = (_eq_ni - _eq_ocf) / _eq_ta
                # Low accruals = high quality. Range: <-0.05 excellent, >0.1 poor
                if _eq_accruals < -0.05:
                    _eq_acr_score = 10
                elif _eq_accruals < 0:
                    _eq_acr_score = 8
                elif _eq_accruals < 0.05:
                    _eq_acr_score = 6
                elif _eq_accruals < 0.10:
                    _eq_acr_score = 4
                else:
                    _eq_acr_score = 2
                _eq_scores.append(_eq_acr_score)
                _eq_details.append(("Accruals Ratio", f"{_eq_accruals:.3f}", _eq_acr_score))

            # 2. Cash Conversion
            if _eq_ni is not None and _eq_ocf is not None and _eq_ni != 0:
                _eq_cc = _eq_ocf / _eq_ni
                if _eq_cc >= 1.2:
                    _eq_cc_score = 10
                elif _eq_cc >= 1.0:
                    _eq_cc_score = 8
                elif _eq_cc >= 0.8:
                    _eq_cc_score = 6
                elif _eq_cc >= 0.5:
                    _eq_cc_score = 4
                else:
                    _eq_cc_score = 2
                _eq_scores.append(_eq_cc_score)
                _eq_details.append(("Cash Conversion", f"{_eq_cc:.2f}x", _eq_cc_score))

            # 3. Revenue Consistency
            if _eq_rev is not None and hasattr(_eq_rev, '__len__') and len(_eq_rev) >= 4:
                try:
                    _eq_rev_vals = [float(v) for v in (list(_eq_rev) if not hasattr(_eq_rev, 'values') else _eq_rev.values) if v is not None and float(v) > 0]
                    if len(_eq_rev_vals) >= 4:
                        _eq_rev_mean = np.mean(_eq_rev_vals)
                        _eq_rev_std = np.std(_eq_rev_vals)
                        _eq_cv = _eq_rev_std / _eq_rev_mean if _eq_rev_mean > 0 else 1
                        if _eq_cv < 0.05:
                            _eq_rv_score = 10
                        elif _eq_cv < 0.10:
                            _eq_rv_score = 8
                        elif _eq_cv < 0.20:
                            _eq_rv_score = 6
                        elif _eq_cv < 0.35:
                            _eq_rv_score = 4
                        else:
                            _eq_rv_score = 2
                        _eq_scores.append(_eq_rv_score)
                        _eq_details.append(("Revenue Consistency", f"CV: {_eq_cv:.2%}", _eq_rv_score))
                except Exception:
                    pass

            if _eq_scores:
                _eq_total = round(np.mean(_eq_scores))
                _eq_color = "#10B981" if _eq_total >= 7 else "#F5A623" if _eq_total >= 5 else "#EF4444"
                _eq_label = "High Quality" if _eq_total >= 7 else "Moderate" if _eq_total >= 5 else "Low Quality"

                # Visual gauge
                _eq_pct = _eq_total * 10
                st.markdown(
                    f'<div style="text-align:center; padding:1rem; background:rgba(255,255,255,0.03); border-radius:12px; margin-bottom:0.8rem;">'
                    f'<div style="font-size:0.75rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Earnings Quality</div>'
                    f'<div style="font-size:2.5rem; font-weight:900; color:{_eq_color};">{_eq_total}<span style="font-size:1rem; color:#9CA3AF;">/10</span></div>'
                    f'<div style="font-size:0.8rem; font-weight:600; color:{_eq_color};">{_eq_label}</div>'
                    f'<div style="background:rgba(255,255,255,0.08); border-radius:8px; height:10px; margin:0.8rem 2rem 0 2rem; overflow:hidden;">'
                    f'<div style="background:{_eq_color}; height:100%; width:{_eq_pct}%; border-radius:8px;"></div></div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

                # Detail breakdown
                _eq_cols = st.columns(len(_eq_details))
                for _eq_col, (_eq_name, _eq_val, _eq_s) in zip(_eq_cols, _eq_details):
                    _eq_sc = "#10B981" if _eq_s >= 7 else "#F5A623" if _eq_s >= 5 else "#EF4444"
                    _eq_col.markdown(
                        f'<div style="text-align:center; padding:0.5rem; background:rgba(255,255,255,0.02); border-radius:8px;">'
                        f'<div style="font-size:0.65rem; color:#9CA3AF;">{_eq_name}</div>'
                        f'<div style="font-size:0.85rem; color:#D1D5DB;">{_eq_val}</div>'
                        f'<div style="font-size:1rem; font-weight:700; color:{_eq_sc};">{_eq_s}/10</div></div>',
                        unsafe_allow_html=True,
                    )
            else:
                st.info("Insufficient data to calculate Earnings Quality Score.")
        except Exception:
            st.info("Earnings Quality analysis unavailable.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10d-ii. ALTMAN Z-SCORE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Altman Z-Score"):
        _section("Altman Z-Score", "ğŸ”¬")
        
        _z_ta = _safe_val(getattr(cd, 'total_assets', None))
        _z_tl = _safe_val(getattr(cd, 'total_liabilities', None))
        _z_te = _safe_val(getattr(cd, 'total_equity', None))
        _z_rev = _safe_val(getattr(cd, 'revenue', None))
        _z_oi = _safe_val(getattr(cd, 'operating_income', None))
        _z_mcap = cd.market_cap or 0
        _z_td = _safe_val(getattr(cd, 'total_debt', None))
        _z_cash = _safe_val(getattr(cd, 'cash_and_equivalents', None))
        
        # Working Capital = Current Assets - Current Liabilities
        # Approximate: WC = (Total Assets - non-current) but simpler: TA - TL is net worth, not WC
        # Better: WC â‰ˆ (Cash + current_ratio proxy). Use balance sheet if available.
        _z_ca = None
        _z_cl = None
        if cd.balance_sheet is not None and not cd.balance_sheet.empty:
            bs = cd.balance_sheet
            _z_ca = float(bs.loc["Current Assets"].iloc[0]) if "Current Assets" in bs.index else None
            _z_cl = float(bs.loc["Current Liabilities"].iloc[0]) if "Current Liabilities" in bs.index else None
            _z_re = float(bs.loc["Retained Earnings"].iloc[0]) if "Retained Earnings" in bs.index else None
        else:
            _z_re = None
        
        # Fallback for WC if no current assets/liabilities
        if _z_ca is not None and _z_cl is not None:
            _z_wc = _z_ca - _z_cl
        elif cd.current_ratio and _z_tl:
            # rough approximation
            _z_wc = None
        else:
            _z_wc = None
        
        if _z_re is None:
            _z_re = (_z_te or 0) * 0.6 if _z_te else None  # rough fallback
        
        if _z_ta and _z_ta > 0 and _z_tl and _z_tl > 0 and _z_wc is not None:
            _z_a = (_z_wc / _z_ta) if _z_ta else 0
            _z_b = ((_z_re or 0) / _z_ta)
            _z_c = ((_z_oi or 0) / _z_ta)
            _z_d = (_z_mcap / _z_tl) if _z_tl > 0 else 0
            _z_e = ((_z_rev or 0) / _z_ta)
            
            z_score = 1.2 * _z_a + 1.4 * _z_b + 3.3 * _z_c + 0.6 * _z_d + 1.0 * _z_e
            
            if z_score > 2.99:
                z_zone = "Safe Zone"
                z_color = "#10B981"
                z_bg = "rgba(16,185,129,0.1)"
            elif z_score >= 1.81:
                z_zone = "Grey Zone"
                z_color = "#F59E0B"
                z_bg = "rgba(245,158,11,0.1)"
            else:
                z_zone = "Distress Zone"
                z_color = "#EF4444"
                z_bg = "rgba(239,68,68,0.1)"
            
            # Gauge visualization
            z_gauge = go.Figure(go.Indicator(
                mode="gauge+number",
                value=z_score,
                number=dict(font=dict(size=36, color="#F9FAFB"), suffix=""),
                title=dict(text=z_zone, font=dict(size=16, color=z_color)),
                gauge=dict(
                    axis=dict(range=[0, 5], tickfont=dict(size=10, color="#9CA3AF"),
                              tickcolor="rgba(255,255,255,0.1)"),
                    bar=dict(color=z_color, thickness=0.3),
                    bgcolor="rgba(0,0,0,0)",
                    bordercolor="rgba(37,99,235,0.2)",
                    steps=[
                        dict(range=[0, 1.81], color="rgba(239,68,68,0.15)"),
                        dict(range=[1.81, 2.99], color="rgba(245,158,11,0.15)"),
                        dict(range=[2.99, 5], color="rgba(16,185,129,0.15)"),
                    ],
                    threshold=dict(line=dict(color="#F9FAFB", width=2), thickness=0.8, value=z_score),
                ),
            ))
            z_gauge.update_layout(
                paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)",
                font=dict(family="Inter", color="#D1D5DB"),
                height=280, margin=dict(t=60, b=20, l=40, r=40),
            )
            
            z_col1, z_col2 = st.columns([1, 1])
            with z_col1:
                st.plotly_chart(z_gauge, use_container_width=True, key="altman_z_gauge")
            
            with z_col2:
                # Component breakdown
                z_components = [
                    ("1.2 Ã— WC/TA", 1.2 * _z_a, "Working Capital / Total Assets"),
                    ("1.4 Ã— RE/TA", 1.4 * _z_b, "Retained Earnings / Total Assets"),
                    ("3.3 Ã— EBIT/TA", 3.3 * _z_c, "Operating Income / Total Assets"),
                    ("0.6 Ã— MVE/TL", 0.6 * _z_d, "Market Cap / Total Liabilities"),
                    ("1.0 Ã— Sales/TA", 1.0 * _z_e, "Revenue / Total Assets"),
                ]
                
                st.markdown(
                    '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-bottom:0.5rem;">Component Breakdown</div>',
                    unsafe_allow_html=True,
                )
                for comp_label, comp_val, comp_desc in z_components:
                    comp_pct = (comp_val / z_score * 100) if z_score != 0 else 0
                    st.markdown(
                        f'<div style="display:flex; justify-content:space-between; align-items:center; '
                        f'padding:0.3rem 0; border-bottom:1px solid rgba(255,255,255,0.03); font-size:0.75rem;">'
                        f'<span style="color:#D1D5DB;">{comp_label}</span>'
                        f'<span style="color:#F9FAFB; font-weight:600;">{comp_val:.3f}</span>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
                
                st.markdown(
                    f'<div style="margin-top:0.5rem; padding:0.5rem; background:{z_bg}; border-radius:8px; text-align:center;">'
                    f'<span style="font-size:0.75rem; color:{z_color}; font-weight:700;">'
                    f'Z = {z_score:.2f} â†’ {z_zone}</span><br>'
                    f'<span style="font-size:0.6rem; color:#9CA3AF;">'
                    f'>2.99 Safe | 1.81-2.99 Grey | <1.81 Distress</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
        else:
            st.info("Insufficient balance sheet data for Altman Z-Score calculation.")
    
    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10d-iii. DUPONT ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("DuPont Analysis"):
        _section("DuPont Analysis", "ğŸ”")
        
        # Calculate DuPont components for available years
        _dp_years = []
        _dp_npm = []  # Net Profit Margin
        _dp_at = []   # Asset Turnover
        _dp_em = []   # Equity Multiplier
        _dp_tb = []   # Tax Burden (5-factor)
        _dp_ib = []   # Interest Burden (5-factor)
        _dp_roe3 = [] # 3-factor ROE
        _dp_roe5 = [] # 5-factor ROE
        
        _dp_rev_s = getattr(cd, 'revenue', None)
        _dp_ni_s = getattr(cd, 'net_income', None)
        _dp_ta_s = getattr(cd, 'total_assets', None)
        _dp_te_s = getattr(cd, 'total_equity', None)
        _dp_oi_s = getattr(cd, 'operating_income', None)
        _dp_ie_s = getattr(cd, 'interest_expense', None)
        _dp_tp_s = getattr(cd, 'tax_provision', None)
        
        _dp_n = min(4, *[len(s) for s in [_dp_rev_s, _dp_ni_s, _dp_ta_s, _dp_te_s] if s is not None and len(s) > 0]) if all(
            s is not None and len(s) > 0 for s in [_dp_rev_s, _dp_ni_s, _dp_ta_s, _dp_te_s]
        ) else 0
        
        for i in range(_dp_n):
            try:
                _rev = float(_dp_rev_s.iloc[i])
                _ni = float(_dp_ni_s.iloc[i])
                _ta = float(_dp_ta_s.iloc[i])
                _te = float(_dp_te_s.iloc[i])
                
                if _rev == 0 or _ta == 0 or _te == 0:
                    continue
                
                npm = _ni / _rev
                at = _rev / _ta
                em = _ta / _te
                roe3 = npm * at * em
                
                # Year label from index
                yr_label = str(_dp_rev_s.index[i])[:4] if hasattr(_dp_rev_s.index[i], 'year') else str(_dp_rev_s.index[i])[:4]
                
                _dp_years.append(yr_label)
                _dp_npm.append(npm)
                _dp_at.append(at)
                _dp_em.append(em)
                _dp_roe3.append(roe3)
                
                # 5-factor
                _oi = float(_dp_oi_s.iloc[i]) if _dp_oi_s is not None and len(_dp_oi_s) > i else None
                _ie = abs(float(_dp_ie_s.iloc[i])) if _dp_ie_s is not None and len(_dp_ie_s) > i else None
                _tp = abs(float(_dp_tp_s.iloc[i])) if _dp_tp_s is not None and len(_dp_tp_s) > i else None
                
                if _oi and _oi != 0:
                    _pretax = _oi - (_ie or 0)
                    _ib_val = _pretax / _oi if _oi != 0 else 1.0
                    _tb_val = _ni / _pretax if _pretax != 0 else 1.0
                else:
                    _ib_val = 1.0
                    _tb_val = 1.0
                
                _dp_tb.append(_tb_val)
                _dp_ib.append(_ib_val)
                _dp_roe5.append(_tb_val * _ib_val * ((_oi or 0) / _rev if _rev else 0) * at * em)
            except Exception:
                continue
        
        if _dp_years:
            _dp_years.reverse()
            _dp_npm.reverse()
            _dp_at.reverse()
            _dp_em.reverse()
            _dp_roe3.reverse()
            _dp_tb.reverse()
            _dp_ib.reverse()
            _dp_roe5.reverse()
            
            dp_tab1, dp_tab2 = st.tabs(["3-Factor DuPont", "5-Factor DuPont"])
            
            with dp_tab1:
                # 3-Factor: ROE = NPM Ã— AT Ã— EM
                st.markdown(
                    '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                    '<b>ROE = Net Profit Margin Ã— Asset Turnover Ã— Equity Multiplier</b></div>',
                    unsafe_allow_html=True,
                )
                
                fig_dp3 = go.Figure()
                fig_dp3.add_trace(go.Bar(
                    x=_dp_years, y=[v * 100 for v in _dp_npm], name="Net Profit Margin %",
                    marker_color="rgba(37,99,235,0.7)",
                ))
                fig_dp3.add_trace(go.Bar(
                    x=_dp_years, y=[v * 100 for v in _dp_at], name="Asset Turnover Ã— 100",
                    marker_color="rgba(16,185,129,0.7)",
                ))
                fig_dp3.add_trace(go.Bar(
                    x=_dp_years, y=[v * 100 for v in _dp_em], name="Equity Multiplier Ã— 100",
                    marker_color="rgba(16,185,129,0.7)",
                ))
                fig_dp3.add_trace(go.Scatter(
                    x=_dp_years, y=[v * 100 for v in _dp_roe3], name="ROE %",
                    mode="lines+markers", line=dict(color="#F5A623", width=3),
                    marker=dict(size=8),
                ))
                fig_dp3.update_layout(
                    **_CHART_LAYOUT_BASE, height=350, barmode="group",
                    margin=dict(t=30, b=40, l=50, r=30),
                    legend=dict(font=dict(size=9, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
                )
                _apply_space_grid(fig_dp3)
                st.plotly_chart(fig_dp3, use_container_width=True, key="dupont_3factor")
                
                # Current year metrics
                dp_mc1, dp_mc2, dp_mc3, dp_mc4 = st.columns(4)
                dp_mc1.metric("Net Profit Margin", f"{_dp_npm[-1]*100:.1f}%")
                dp_mc2.metric("Asset Turnover", f"{_dp_at[-1]:.2f}x")
                dp_mc3.metric("Equity Multiplier", f"{_dp_em[-1]:.2f}x")
                dp_mc4.metric("ROE (3-Factor)", f"{_dp_roe3[-1]*100:.1f}%")
            
            with dp_tab2:
                st.markdown(
                    '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                    '<b>ROE = Tax Burden Ã— Interest Burden Ã— Operating Margin Ã— AT Ã— EM</b></div>',
                    unsafe_allow_html=True,
                )
                
                if _dp_tb and _dp_ib:
                    fig_dp5 = go.Figure()
                    fig_dp5.add_trace(go.Bar(x=_dp_years, y=[v * 100 for v in _dp_tb], name="Tax Burden %",
                                             marker_color="rgba(37,99,235,0.7)"))
                    fig_dp5.add_trace(go.Bar(x=_dp_years, y=[v * 100 for v in _dp_ib], name="Interest Burden %",
                                             marker_color="rgba(16,185,129,0.7)"))
                    fig_dp5.add_trace(go.Scatter(x=_dp_years, y=[v * 100 for v in _dp_roe5], name="ROE %",
                                                  mode="lines+markers", line=dict(color="#F5A623", width=3),
                                                  marker=dict(size=8)))
                    fig_dp5.update_layout(
                        **_CHART_LAYOUT_BASE, height=350, barmode="group",
                        margin=dict(t=30, b=40, l=50, r=30),
                        legend=dict(font=dict(size=9, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
                    )
                    _apply_space_grid(fig_dp5)
                    st.plotly_chart(fig_dp5, use_container_width=True, key="dupont_5factor")
                    
                    dp5_c1, dp5_c2, dp5_c3 = st.columns(3)
                    dp5_c1.metric("Tax Burden", f"{_dp_tb[-1]*100:.1f}%")
                    dp5_c2.metric("Interest Burden", f"{_dp_ib[-1]*100:.1f}%")
                    dp5_c3.metric("ROE (5-Factor)", f"{_dp_roe5[-1]*100:.1f}%")
                else:
                    st.info("Insufficient data for 5-factor DuPont analysis.")
        else:
            st.info("Insufficient financial data for DuPont Analysis.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10d-iii. MANAGEMENT SCORECARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Management Scorecard"):
        _section("Management Effectiveness Scorecard", "ğŸ¯")
        try:
            _ms_oi = _safe_val(getattr(cd, 'operating_income', None))
            _ms_tax = _safe_val(getattr(cd, 'tax_provision', None))
            _ms_ni = _safe_val(getattr(cd, 'net_income', None))
            _ms_equity = _safe_val(getattr(cd, 'total_equity', None))
            _ms_debt = _safe_val(getattr(cd, 'total_debt', None))
            _ms_cash = _safe_val(getattr(cd, 'cash_and_equivalents', None))
            _ms_rev = _safe_val(getattr(cd, 'revenue', None))
            _ms_employees = getattr(cd, 'full_time_employees', None)
            _ms_mcap = getattr(cd, 'market_cap', 0) or 0
            _ms_roe_info = getattr(cd, 'return_on_equity', None)

            _ms_cards = []

            # ROIC
            if _ms_oi is not None and _ms_ni is not None and _ms_equity is not None:
                # Estimate effective tax rate
                _ms_ebt = _ms_oi  # approximate
                _ms_tax_rate = abs(_ms_tax / _ms_ebt) if _ms_tax and _ms_ebt and abs(_ms_ebt) > 0 else 0.25
                _ms_tax_rate = min(_ms_tax_rate, 0.5)  # cap at 50%
                _ms_nopat = _ms_oi * (1 - _ms_tax_rate)
                _ms_invested_cap = (_ms_equity or 0) + (_ms_debt or 0) - (_ms_cash or 0)
                if _ms_invested_cap and abs(_ms_invested_cap) > 0:
                    _ms_roic = (_ms_nopat / abs(_ms_invested_cap)) * 100
                    _ms_roic_color = "#10B981" if _ms_roic > 15 else ("#F5A623" if _ms_roic > 8 else "#EF4444")
                    _ms_cards.append(("ROIC", f"{_ms_roic:.1f}%", _ms_roic_color,
                                      "NOPAT / Invested Capital"))

                    # ROIC vs WACC spread (assume ~10% WACC as baseline)
                    _ms_wacc_est = 10.0
                    _ms_spread = _ms_roic - _ms_wacc_est
                    _ms_spread_color = "#10B981" if _ms_spread > 0 else "#EF4444"
                    _ms_spread_icon = "âœ… Value Creator" if _ms_spread > 0 else "âš ï¸ Value Destroyer"
                    _ms_cards.append(("ROIC-WACC Spread", f"{_ms_spread:+.1f}%", _ms_spread_color,
                                      _ms_spread_icon))

            # ROE
            if _ms_roe_info is not None:
                _ms_roe_pct = _ms_roe_info * 100 if abs(_ms_roe_info) < 1 else _ms_roe_info
                _ms_roe_color = "#10B981" if _ms_roe_pct > 15 else ("#F5A623" if _ms_roe_pct > 8 else "#EF4444")
                _ms_cards.append(("Return on Equity", f"{_ms_roe_pct:.1f}%", _ms_roe_color, "Net Income / Equity"))

            # Revenue per Employee
            if _ms_rev and _ms_employees and _ms_employees > 0:
                _ms_rev_per_emp = _ms_rev / _ms_employees
                _ms_cards.append(("Revenue / Employee", format_number(_ms_rev_per_emp, currency_symbol=cs),
                                  "#2563EB", f"{_ms_employees:,} employees"))

            if _ms_cards:
                _ms_cols = st.columns(len(_ms_cards))
                for i, (_ms_title, _ms_val_str, _ms_color, _ms_sub) in enumerate(_ms_cards):
                    _ms_cols[i].markdown(
                        f'<div style="background:rgba(37,99,235,0.05); border-radius:12px; padding:1rem; '
                        f'text-align:center; border-left:3px solid {_ms_color};">'
                        f'<div style="font-size:0.75rem; color:#9CA3AF;">{_ms_title}</div>'
                        f'<div style="font-size:1.8rem; font-weight:800; color:{_ms_color};">{_ms_val_str}</div>'
                        f'<div style="font-size:0.7rem; color:#9CA3AF;">{_ms_sub}</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

                # ROE Trend (3 years)
                if cd.income_stmt is not None and cd.balance_sheet is not None:
                    try:
                        _ni_series = getattr(cd, 'net_income', None)
                        _eq_series = getattr(cd, 'total_equity', None)
                        if _ni_series is not None and _eq_series is not None and len(_ni_series) >= 2 and len(_eq_series) >= 2:
                            _roe_years = []
                            _roe_vals = []
                            _n_years = min(len(_ni_series), len(_eq_series), 4)
                            for _yi in range(_n_years):
                                try:
                                    _ni_v = float(_ni_series.iloc[_yi])
                                    _eq_v = float(_eq_series.iloc[_yi])
                                    if _eq_v and abs(_eq_v) > 0:
                                        _roe_vals.append((_ni_v / abs(_eq_v)) * 100)
                                        _yr_label = _ni_series.index[_yi].strftime("%Y") if hasattr(_ni_series.index[_yi], "strftime") else str(_ni_series.index[_yi])
                                        _roe_years.append(_yr_label)
                                except Exception:
                                    pass
                            if len(_roe_vals) >= 2:
                                _roe_years.reverse()
                                _roe_vals.reverse()
                                fig_roe = go.Figure()
                                fig_roe.add_trace(go.Scatter(
                                    x=_roe_years, y=_roe_vals, mode="lines+markers+text",
                                    text=[f"{v:.1f}%" for v in _roe_vals], textposition="top center",
                                    textfont=dict(size=10, color="#C4B5FD"),
                                    line=dict(color="#2563EB", width=2),
                                    marker=dict(size=8, color="#2563EB"),
                                ))
                                fig_roe.update_layout(
                                    **_CHART_LAYOUT_BASE, height=250,
                                    margin=dict(t=30, b=30, l=50, r=30),
                                    xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                                    yaxis=dict(title="ROE %", tickfont=dict(size=9, color="#9CA3AF")),
                                )
                                _apply_space_grid(fig_roe)
                                st.plotly_chart(fig_roe, use_container_width=True, key="mgmt_roe_trend")
                    except Exception:
                        pass
            else:
                st.info("Insufficient data for management effectiveness analysis.")
        except Exception:
            st.info("Could not compute management scorecard.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10e. RISK METRICS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Risk Metrics")
    
    risk_col1, risk_col2, risk_col3, risk_col4 = st.columns(4)
    
    with risk_col1:
        beta_val = cd.beta or 0
        beta_color = "#EF4444" if beta_val > 1.5 else "#F59E0B" if beta_val > 1 else "#10B981"
        beta_label = "High" if beta_val > 1.5 else "Moderate" if beta_val > 1 else "Low"
        st.markdown(
            f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
            f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
            f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Beta</div>'
            f'<div style="font-size:1.4rem; font-weight:800; color:{beta_color};">{beta_val:.2f}</div>'
            f'<div style="font-size:0.6rem; color:{beta_color};">{beta_label} Volatility</div>'
            f'</div>',
            unsafe_allow_html=True,
        )
    
    # Calculate Sharpe, Max Drawdown, Volatility from 1Y data
    try:
        risk_hist = cd.hist_1y if cd.hist_1y is not None and not cd.hist_1y.empty else None
        if risk_hist is not None and len(risk_hist) > 20:
            returns = risk_hist["Close"].pct_change().dropna()
            
            # Annualized volatility
            ann_vol = returns.std() * np.sqrt(252) * 100
            vol_color = "#EF4444" if ann_vol > 40 else "#F59E0B" if ann_vol > 25 else "#10B981"
            
            with risk_col2:
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Volatility (1Y)</div>'
                    f'<div style="font-size:1.4rem; font-weight:800; color:{vol_color};">{ann_vol:.1f}%</div>'
                    f'<div style="font-size:0.6rem; color:#9CA3AF;">Annualized</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            
            # Sharpe ratio (assume 5% risk-free rate)
            ann_return = returns.mean() * 252 * 100
            sharpe = (ann_return - 5) / ann_vol if ann_vol > 0 else 0
            sharpe_color = "#10B981" if sharpe > 1 else "#F59E0B" if sharpe > 0.5 else "#EF4444"
            
            with risk_col3:
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Sharpe Ratio</div>'
                    f'<div style="font-size:1.4rem; font-weight:800; color:{sharpe_color};">{sharpe:.2f}</div>'
                    f'<div style="font-size:0.6rem; color:#9CA3AF;">Rf=5%</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            
            # Max Drawdown
            cum_returns = (1 + returns).cumprod()
            running_max = cum_returns.cummax()
            drawdown = (cum_returns / running_max - 1) * 100
            max_dd = drawdown.min()
            dd_color = "#EF4444" if max_dd < -30 else "#F59E0B" if max_dd < -15 else "#10B981"
            
            with risk_col4:
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">Max Drawdown</div>'
                    f'<div style="font-size:1.4rem; font-weight:800; color:{dd_color};">{max_dd:.1f}%</div>'
                    f'<div style="font-size:0.6rem; color:#9CA3AF;">1Y Period</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            
            # Drawdown chart
            fig_dd = go.Figure()
            fig_dd.add_trace(go.Scatter(
                x=drawdown.index, y=drawdown.values,
                mode="lines", fill="tozeroy",
                line=dict(color="#EF4444", width=1.5),
                fillcolor="rgba(239,68,68,0.1)",
                name="Drawdown",
            ))
            fig_dd.update_layout(
                **_CHART_LAYOUT_BASE, height=200,
                margin=dict(t=10, b=25, l=50, r=30),
                yaxis=dict(ticksuffix="%", tickfont=dict(size=9, color="#9CA3AF"),
                          title=dict(text="Drawdown", font=dict(size=10, color="#9CA3AF"))),
                xaxis=dict(showgrid=False, tickfont=dict(size=9, color="#9CA3AF")),
                showlegend=False,
            )
            _apply_space_grid(fig_dd)
            st.plotly_chart(fig_dd, use_container_width=True, key="drawdown_chart")
        else:
            with risk_col2:
                st.info("Insufficient data")
    except Exception:
        pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 10f. ESG SCORING DASHBOARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("ESG Scoring Dashboard"):
        _section("ESG Scoring Dashboard", "ğŸŒ±")

        _esg_has_data = False
        esg_total = esg_env = esg_social = esg_gov = None

        try:
            if cd.esg_scores is not None and not cd.esg_scores.empty:
                esg = cd.esg_scores
                for idx_name in esg.index:
                    idx_lower = str(idx_name).lower()
                    if "total" in idx_lower and "esg" in idx_lower:
                        esg_total = float(esg.loc[idx_name].iloc[0]) if pd.notna(esg.loc[idx_name].iloc[0]) else None
                    elif "environment" in idx_lower:
                        esg_env = float(esg.loc[idx_name].iloc[0]) if pd.notna(esg.loc[idx_name].iloc[0]) else None
                    elif "social" in idx_lower:
                        esg_social = float(esg.loc[idx_name].iloc[0]) if pd.notna(esg.loc[idx_name].iloc[0]) else None
                    elif "governance" in idx_lower:
                        esg_gov = float(esg.loc[idx_name].iloc[0]) if pd.notna(esg.loc[idx_name].iloc[0]) else None
                if esg_total is not None or esg_env is not None:
                    _esg_has_data = True
        except Exception:
            pass

        # Sector-average ESG benchmarks (Sustainalytics scale, lower = better)
        _esg_sector_avg = {
            "Technology": {"E": 8, "S": 12, "G": 8, "Total": 18},
            "Financial Services": {"E": 5, "S": 15, "G": 10, "Total": 22},
            "Healthcare": {"E": 10, "S": 14, "G": 9, "Total": 23},
            "Energy": {"E": 30, "S": 15, "G": 10, "Total": 32},
            "Consumer Cyclical": {"E": 14, "S": 13, "G": 9, "Total": 24},
            "Consumer Defensive": {"E": 16, "S": 14, "G": 8, "Total": 25},
            "Industrials": {"E": 18, "S": 13, "G": 9, "Total": 26},
            "Basic Materials": {"E": 25, "S": 14, "G": 9, "Total": 30},
            "Utilities": {"E": 22, "S": 12, "G": 8, "Total": 28},
            "Real Estate": {"E": 12, "S": 10, "G": 9, "Total": 20},
            "Communication Services": {"E": 6, "S": 14, "G": 10, "Total": 21},
        }
        _esg_sect = getattr(cd, 'sector', '') or ''
        _esg_bench = _esg_sector_avg.get(_esg_sect, {"E": 15, "S": 13, "G": 9, "Total": 24})

        def _esg_risk_level(score):
            if score is None: return ("N/A", "#9CA3AF")
            if score < 10: return ("Negligible", "#10B981")
            if score < 20: return ("Low", "#34D399")
            if score < 30: return ("Medium", "#F59E0B")
            if score < 40: return ("High", "#EF4444")
            return ("Severe", "#DC2626")

        def _esg_gauge(label, score, bench, icon, max_val=50):
            """Render a semicircular gauge for ESG score."""
            if score is None:
                return (
                    f'<div style="text-align:center; padding:1rem; background:rgba(37,99,235,0.05); border-radius:12px;">'
                    f'<div style="font-size:1.4rem;">{icon}</div>'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase;">{label}</div>'
                    f'<div style="color:#9CA3AF; font-size:0.8rem;">No Data</div>'
                    f'<div style="font-size:0.55rem; color:#5A567A;">Sector avg: {bench}</div>'
                    f'</div>'
                )
            pct = min(score / max_val * 100, 100)
            risk_label, color = _esg_risk_level(score)
            vs_sector = score - bench
            vs_str = f'{"+" if vs_sector > 0 else ""}{vs_sector:.0f} vs sector'
            vs_color = "#EF4444" if vs_sector > 0 else "#10B981"
            # Bar gauge
            return (
                f'<div style="text-align:center; padding:1rem; background:rgba(37,99,235,0.05); '
                f'border-radius:12px; border:1px solid rgba(37,99,235,0.1);">'
                f'<div style="font-size:1.4rem;">{icon}</div>'
                f'<div style="font-size:0.65rem; color:#9CA3AF; font-weight:600; text-transform:uppercase; margin-bottom:0.3rem;">{label}</div>'
                f'<div style="font-size:1.5rem; font-weight:800; color:{color};">{score:.1f}</div>'
                f'<div style="font-size:0.6rem; color:{color}; margin-bottom:0.4rem;">{risk_label}</div>'
                f'<div style="background:rgba(255,255,255,0.05); border-radius:4px; height:6px; width:100%; margin:0.3rem 0;">'
                f'<div style="background:{color}; height:100%; border-radius:4px; width:{pct:.0f}%;"></div></div>'
                f'<div style="font-size:0.55rem; color:{vs_color};">{vs_str}</div>'
                f'</div>'
            )

        if _esg_has_data:
            _eg1, _eg2, _eg3, _eg4 = st.columns(4)
            with _eg1:
                st.markdown(_esg_gauge("Environmental", esg_env, _esg_bench["E"], "ğŸŒ¿"), unsafe_allow_html=True)
            with _eg2:
                st.markdown(_esg_gauge("Social", esg_social, _esg_bench["S"], "ğŸ‘¥"), unsafe_allow_html=True)
            with _eg3:
                st.markdown(_esg_gauge("Governance", esg_gov, _esg_bench["G"], "âš–ï¸"), unsafe_allow_html=True)
            with _eg4:
                st.markdown(_esg_gauge("Overall ESG Risk", esg_total, _esg_bench["Total"], "ğŸŒ"), unsafe_allow_html=True)

            # ESG Risk Level classification
            _esg_rl, _esg_rc = _esg_risk_level(esg_total)
            st.markdown(
                f'<div style="text-align:center; margin:0.8rem 0; padding:0.5rem; background:rgba(37,99,235,0.04); border-radius:8px;">'
                f'<span style="font-size:0.75rem; color:#9CA3AF;">ESG Risk Level: </span>'
                f'<span style="font-size:0.85rem; font-weight:700; color:{_esg_rc};">{_esg_rl}</span>'
                f'<span style="font-size:0.65rem; color:#5A567A;"> Â· Lower scores = lower risk (Sustainalytics)</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
        else:
            # No ESG data - show industry typical ranges
            st.markdown(
                f'<div style="text-align:center; padding:0.8rem; background:rgba(245,166,35,0.06); border-radius:10px; '
                f'border:1px solid rgba(245,166,35,0.15); margin-bottom:0.5rem;">'
                f'<div style="font-size:0.8rem; color:#F5A623;">âš ï¸ ESG data not available for {cd.ticker}</div>'
                f'<div style="font-size:0.65rem; color:#9CA3AF; margin-top:0.3rem;">Showing typical ranges for {_esg_sect or "general market"}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
            _eg1, _eg2, _eg3, _eg4 = st.columns(4)
            with _eg1:
                st.markdown(_esg_gauge("Environmental", None, _esg_bench["E"], "ğŸŒ¿"), unsafe_allow_html=True)
            with _eg2:
                st.markdown(_esg_gauge("Social", None, _esg_bench["S"], "ğŸ‘¥"), unsafe_allow_html=True)
            with _eg3:
                st.markdown(_esg_gauge("Governance", None, _esg_bench["G"], "âš–ï¸"), unsafe_allow_html=True)
            with _eg4:
                st.markdown(_esg_gauge("Overall (Sector Avg)", _esg_bench["Total"], _esg_bench["Total"], "ğŸŒ"), unsafe_allow_html=True)

        # Carbon Footprint Proxy
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        _carbon_intensity = {
            "Technology": ("Low", "ğŸŸ¢", 15),
            "Communication Services": ("Low", "ğŸŸ¢", 18),
            "Financial Services": ("Low", "ğŸŸ¢", 12),
            "Healthcare": ("Low-Medium", "ğŸŸ¡", 30),
            "Consumer Cyclical": ("Medium", "ğŸŸ¡", 45),
            "Consumer Defensive": ("Medium", "ğŸŸ¡", 40),
            "Industrials": ("Medium-High", "ğŸŸ ", 60),
            "Real Estate": ("Medium", "ğŸŸ¡", 35),
            "Basic Materials": ("High", "ğŸ”´", 80),
            "Utilities": ("High", "ğŸ”´", 75),
            "Energy": ("Very High", "ğŸ”´", 95),
        }
        _ci = _carbon_intensity.get(_esg_sect, ("Medium", "ğŸŸ¡", 50))
        _ci_pct = _ci[2]
        st.markdown(
            f'<div style="padding:0.6rem 1rem; background:rgba(37,99,235,0.04); border-radius:10px; '
            f'display:flex; align-items:center; gap:0.8rem;">'
            f'<div style="font-size:1.3rem;">{_ci[1]}</div>'
            f'<div style="flex:1;">'
            f'<div style="font-size:0.7rem; color:#9CA3AF; font-weight:600;">Carbon Intensity Proxy ({_esg_sect or "N/A"})</div>'
            f'<div style="background:rgba(255,255,255,0.05); border-radius:4px; height:8px; width:100%; margin:0.3rem 0;">'
            f'<div style="background:linear-gradient(90deg, #10B981, #F59E0B, #EF4444); height:100%; border-radius:4px; width:{_ci_pct}%;"></div></div>'
            f'<div style="font-size:0.6rem; color:#D1D5DB;">{_ci[0]} relative carbon footprint</div>'
            f'</div></div>',
            unsafe_allow_html=True,
        )

        _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 11. M&A HISTORY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("M&A History")
    if cd.ma_deals:
        deal_count = len(cd.ma_deals)
        source_link = f' &middot; <a href="{cd.ma_source}" target="_blank" style="color:#2563EB; text-decoration:none; font-weight:500;">View on Wikipedia &rarr;</a>' if cd.ma_source else ""
        st.markdown(
            f'<div style="margin-bottom:0.8rem;">'
            f'<span class="pill pill-purple">{deal_count} Acquisitions</span>'
            f'{source_link}'
            f'</div>',
            unsafe_allow_html=True,
        )
        ma_df = pd.DataFrame([
            {
                "Date": d.get("date", ""),
                "Target": d.get("company", ""),
                "Business": d.get("business", ""),
                "Country": d.get("country", ""),
                "Value (USD)": d.get("value", "Undisclosed"),
            }
            for d in cd.ma_deals[:30]
        ])
        st.dataframe(ma_df, use_container_width=True, hide_index=True, height=400)
        if deal_count > 30:
            st.caption(f"Showing 30 of {deal_count} deals.")
    elif cd.ma_history:
        st.markdown(cd.ma_history)
    else:
        st.info("No public M&A history found for this company.")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 12. MANAGEMENT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Management Team")
    mgmt_col1, mgmt_col2 = st.columns([3, 2])
    with mgmt_col1:
        if cd.officers:
            mgmt_data = []
            for o in cd.officers[:10]:
                mgmt_data.append({
                    "Name": o.get("name", "N/A"),
                    "Title": o.get("title", "N/A"),
                    "Age": o.get("age", ""),
                    "Total Pay": format_number(o.get("totalPay"), currency_symbol=cs) if o.get("totalPay") else "\u2014",
                })
            st.dataframe(pd.DataFrame(mgmt_data), use_container_width=True, hide_index=True)
        else:
            st.info("Management data not available.")
    with mgmt_col2:
        if cd.mgmt_sentiment:
            st.markdown("<p style='font-size:0.85rem; font-weight:700; color:#F9FAFB; margin-bottom:0.3rem;'>Management Assessment</p>", unsafe_allow_html=True)
            for line in cd.mgmt_sentiment.split("\n"):
                line = line.strip()
                if line.startswith("- "):
                    line = line[2:]
                if line:
                    st.markdown(f"<div style='font-size:0.82rem; color:#D1D5DB; line-height:1.7; padding:0.15rem 0;'>&bull; {line}</div>", unsafe_allow_html=True)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 13. NEWS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("News & Events Timeline")

    # Key Events markers (earnings, dividends)
    _key_events = []
    try:
        _cal_tk = yf.Ticker(cd.ticker)
        _cal = _cal_tk.calendar
        if _cal is not None:
            if isinstance(_cal, dict):
                _earn_date = _cal.get("Earnings Date", [None])
                if isinstance(_earn_date, list) and _earn_date:
                    for ed in _earn_date[:2]:
                        if ed:
                            _key_events.append({"date": str(ed)[:10], "title": "ğŸ“… Earnings Date", "type": "earnings"})
                _ex_div = _cal.get("Ex-Dividend Date", None)
                if _ex_div:
                    _key_events.append({"date": str(_ex_div)[:10], "title": "ğŸ’° Ex-Dividend Date", "type": "dividend"})
            elif isinstance(_cal, pd.DataFrame) and not _cal.empty:
                for col in _cal.columns:
                    if "earning" in str(col).lower():
                        _key_events.append({"date": str(_cal[col].iloc[0])[:10], "title": "ğŸ“… Earnings Date", "type": "earnings"})
                    if "dividend" in str(col).lower():
                        _key_events.append({"date": str(_cal[col].iloc[0])[:10], "title": "ğŸ’° Ex-Dividend Date", "type": "dividend"})
    except Exception:
        pass

    # Render key events
    if _key_events:
        _ke_html = ""
        for ke in _key_events:
            _ke_color = "#2563EB" if ke["type"] == "earnings" else "#F59E0B"
            _ke_html += (
                f'<div style="display:inline-flex; align-items:center; gap:0.4rem; padding:0.3rem 0.7rem; '
                f'background:rgba({",".join(str(int(_ke_color[i:i+2], 16)) for i in (1,3,5))},0.1); '
                f'border:1px solid {_ke_color}33; border-radius:12px; margin-right:0.5rem; margin-bottom:0.3rem;">'
                f'<span style="font-size:0.65rem; font-weight:700; color:{_ke_color};">{ke["title"]}</span>'
                f'<span style="font-size:0.6rem; color:#9CA3AF;">{ke["date"]}</span></div>'
            )
        st.markdown(
            f'<div style="margin-bottom:0.8rem;">'
            f'<div style="font-size:0.65rem; font-weight:700; color:#9CA3AF; text-transform:uppercase; '
            f'letter-spacing:1px; margin-bottom:0.4rem;">ğŸ“Œ Upcoming Events</div>{_ke_html}</div>',
            unsafe_allow_html=True,
        )

    # News timeline
    if cd.news:
        _tl_html = '<div style="position:relative; padding-left:2rem; border-left:2px solid rgba(37,99,235,0.2); margin-left:1rem;">'
        for n in cd.news[:10]:
            title = n.get("title", "")
            publisher = n.get("publisher", "")
            link = n.get("link", "")
            _pub_ts = n.get("providerPublishTime", n.get("published", 0))
            try:
                if isinstance(_pub_ts, (int, float)) and _pub_ts > 1e9:
                    _news_date = datetime.fromtimestamp(_pub_ts).strftime("%b %d, %H:%M")
                else:
                    _news_date = str(_pub_ts)[:16]
            except Exception:
                _news_date = ""

            # Simple sentiment heuristic from title
            _title_lower = title.lower()
            _pos_words = {"surge", "jump", "rally", "gain", "rise", "beat", "upgrade", "bullish", "record", "growth", "profit", "soar"}
            _neg_words = {"fall", "drop", "crash", "decline", "loss", "miss", "downgrade", "bearish", "cut", "warning", "plunge", "slump"}
            _sentiment_color = "#9CA3AF"  # neutral
            _dot_color = "#5A567A"
            if any(w in _title_lower for w in _pos_words):
                _sentiment_color = "#10B981"
                _dot_color = "#10B981"
            elif any(w in _title_lower for w in _neg_words):
                _sentiment_color = "#EF4444"
                _dot_color = "#EF4444"

            _title_html = f'<a href="{link}" target="_blank" style="color:#F9FAFB; text-decoration:none; font-weight:600; font-size:0.8rem;">{title}</a>' if link else f'<span style="color:#F9FAFB; font-weight:600; font-size:0.8rem;">{title}</span>'
            _favicon = f'<img src="https://www.google.com/s2/favicons?sz=16&domain={publisher.lower().replace(" ", "")}.com" style="width:14px; height:14px; border-radius:2px; vertical-align:middle; margin-right:0.3rem;" onerror="this.style.display=\'none\'">' if publisher else ""

            _tl_html += (
                f'<div style="position:relative; margin-bottom:1rem; padding:0.5rem 0;">'
                f'<div style="position:absolute; left:-2.45rem; top:0.6rem; width:10px; height:10px; '
                f'border-radius:50%; background:{_dot_color}; border:2px solid #1A1730;"></div>'
                f'<div style="font-size:0.6rem; color:#9CA3AF; margin-bottom:0.2rem;">{_news_date}</div>'
                f'{_title_html}'
                f'<div style="font-size:0.65rem; color:#9CA3AF; margin-top:0.2rem;">{_favicon}{publisher}</div>'
                f'</div>'
            )
        _tl_html += '</div>'
        st.markdown(_tl_html, unsafe_allow_html=True)
    else:
        st.info("No recent news available.")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 13b. KEY EVENTS TIMELINE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Key Events Timeline"):
        _section("ğŸ“… Key Events Timeline")
        try:
            _tk_events = yf.Ticker(cd.ticker)
            _timeline_events = []

            # Earnings dates
            try:
                _earn_cal = _tk_events.earnings_dates
                if _earn_cal is not None and not _earn_cal.empty:
                    for _ed_idx, _ed_row in _earn_cal.head(5).iterrows():
                        _ed_date = _ed_idx
                        if hasattr(_ed_date, 'strftime'):
                            _ed_label = "Earnings"
                            _ed_color = "#2563EB"
                            _is_future = _ed_date > pd.Timestamp.now(tz=_ed_date.tzinfo) if _ed_date.tzinfo else _ed_date > pd.Timestamp.now()
                            if _is_future:
                                _ed_label = "ğŸ“¢ Next Earnings"
                                _ed_color = "#F59E0B"
                            _timeline_events.append(dict(date=_ed_date, label=_ed_label, color=_ed_color))
            except Exception:
                pass

            # Dividend dates
            try:
                _divs = _tk_events.dividends
                if _divs is not None and not _divs.empty:
                    for _dv_date in _divs.index[-4:]:
                        _timeline_events.append(dict(date=_dv_date, label="ğŸ’° Ex-Dividend", color="#10B981"))
            except Exception:
                pass

            # 52-week high/low dates
            try:
                _hist_1y = _tk_events.history(period="1y")
                if _hist_1y is not None and not _hist_1y.empty:
                    _52h_date = _hist_1y["Close"].idxmax()
                    _52l_date = _hist_1y["Close"].idxmin()
                    _timeline_events.append(dict(date=_52h_date, label=f"ğŸ”º 52w High ({cs}{_hist_1y['Close'].max():,.2f})", color="#10B981"))
                    _timeline_events.append(dict(date=_52l_date, label=f"ğŸ”» 52w Low ({cs}{_hist_1y['Close'].min():,.2f})", color="#EF4444"))
            except Exception:
                pass

            if _timeline_events:
                _timeline_events.sort(key=lambda x: x["date"])
                _tl_dates = [e["date"] for e in _timeline_events]
                _tl_labels = [e["label"] for e in _timeline_events]
                _tl_colors = [e["color"] for e in _timeline_events]

                fig_tl = go.Figure()
                # Timeline as scatter with text
                fig_tl.add_trace(go.Scatter(
                    x=_tl_dates,
                    y=[0] * len(_tl_dates),
                    mode="markers+text",
                    marker=dict(size=12, color=_tl_colors, symbol="diamond",
                                line=dict(width=1, color="rgba(255,255,255,0.2)")),
                    text=_tl_labels,
                    textposition="top center",
                    textfont=dict(size=9, color="#F9FAFB"),
                    hovertemplate="%{text}<br>%{x|%b %d, %Y}<extra></extra>",
                ))
                # Horizontal line
                fig_tl.add_shape(type="line", x0=min(_tl_dates), x1=max(_tl_dates), y0=0, y1=0,
                                 line=dict(color="rgba(138,133,173,0.3)", width=2))
                # Today marker
                fig_tl.add_vline(x=pd.Timestamp.now(), line_dash="dash", line_color="rgba(245,158,11,0.5)",
                                 annotation_text="Today", annotation_font=dict(size=8, color="#F59E0B"))

                fig_tl.update_layout(
                    **_CHART_LAYOUT_BASE, height=200,
                    margin=dict(t=40, b=20, l=30, r=30),
                    yaxis=dict(visible=False, range=[-1, 2]),
                    xaxis=dict(showgrid=False, tickfont=dict(size=9, color="#9CA3AF")),
                    showlegend=False,
                )
                st.plotly_chart(fig_tl, use_container_width=True, key="events_timeline")
            else:
                st.info("No event data available.")
        except Exception as _tl_err:
            st.info("Could not load event timeline.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 14a. EARNINGS SURPRISE CHART (Alpha Vantage)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if getattr(cd, "earnings_history", None) and len(cd.earnings_history) > 0:
        _section("Earnings Surprise")
        earnings = cd.earnings_history[:8]  # last 8 quarters, most recent first
        earnings = list(reversed(earnings))  # oldest first for chart
        eq_dates = [e.get("date", "")[:7] for e in earnings]
        eq_actual = [e.get("actual_eps") for e in earnings]
        eq_estimate = [e.get("estimated_eps") for e in earnings]

        # Build colors: green for beat, red for miss
        bar_colors = []
        for a, est in zip(eq_actual, eq_estimate):
            if a is not None and est is not None:
                bar_colors.append("#10B981" if a >= est else "#EF4444")
            else:
                bar_colors.append("#9CA3AF")

        fig_earn = go.Figure()
        # Ghost bar for estimates (transparent fill + outline)
        fig_earn.add_trace(go.Bar(
            x=eq_dates, y=eq_estimate, name="Estimate",
            marker=dict(
                color="rgba(138,133,173,0.08)",
                line=dict(color="rgba(138,133,173,0.5)", width=1.5),
            ),
            text=[f"{v:.2f}" if v is not None else "" for v in eq_estimate],
            textposition="outside", textfont=dict(size=9, color="#9CA3AF"),
        ))
        # Solid actuals with white outline
        fig_earn.add_trace(go.Bar(
            x=eq_dates, y=eq_actual, name="Actual",
            marker=dict(
                color=bar_colors,
                line=dict(color="rgba(255,255,255,0.2)", width=1),
            ),
            text=[f"{v:.2f}" if v is not None else "" for v in eq_actual],
            textposition="outside", textfont=dict(size=9, color="#D1D5DB"),
        ))
        fig_earn.update_layout(
            **_CHART_LAYOUT_BASE,
            height=500, barmode="group",
            margin=dict(t=40, b=40, l=60, r=40),
            xaxis=dict(tickfont=dict(size=12, color="#9CA3AF"), showgrid=False),
            yaxis=dict(title=dict(text="EPS", font=dict(size=13, color="#9CA3AF")),
                       tickfont=dict(size=12, color="#9CA3AF"),
                       tickprefix=cd.currency_symbol),
            legend=dict(font=dict(size=12, color="#D1D5DB"), orientation="h",
                        yanchor="bottom", y=1.02),
        )
        _apply_space_grid(fig_earn)
        st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
        st.plotly_chart(fig_earn, use_container_width=True, key="earnings_surprise_chart")
        st.markdown('</div>', unsafe_allow_html=True)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 14b. NEWS SENTIMENT (Alpha Vantage)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if getattr(cd, "news_sentiment", None) and len(cd.news_sentiment) > 0:
        _section("News Sentiment")
        for ns in cd.news_sentiment[:10]:
            title = ns.get("title", "")
            url = ns.get("url", "")
            source = ns.get("source", "")
            published = ns.get("published", "")
            sentiment = ns.get("overall_sentiment", "Neutral").lower()
            score = ns.get("overall_score")
            score_str = f"{score:.2f}" if score is not None else ""

            if "bullish" in sentiment or "positive" in sentiment:
                css_class = "news-sentiment-bullish"
                badge = '<span style="color:#10B981; font-weight:700; font-size:0.7rem;">BULLISH</span>'
            elif "bearish" in sentiment or "negative" in sentiment:
                css_class = "news-sentiment-bearish"
                badge = '<span style="color:#EF4444; font-weight:700; font-size:0.7rem;">BEARISH</span>'
            else:
                css_class = "news-sentiment-neutral"
                badge = '<span style="color:#9CA3AF; font-weight:700; font-size:0.7rem;">NEUTRAL</span>'

            link_html = f'<a href="{url}" target="_blank" style="color:#F9FAFB; text-decoration:none; font-weight:600; font-size:0.85rem;">{title}</a>' if url else f'<span style="color:#F9FAFB; font-weight:600; font-size:0.85rem;">{title}</span>'
            st.markdown(
                f'<div class="news-card {css_class}">'
                f'{link_html}'
                f'<div style="margin-top:0.3rem; display:flex; gap:0.8rem; align-items:center;">'
                f'{badge}'
                f'<span style="color:#9CA3AF; font-size:0.7rem;">{source} &middot; {published}</span>'
                f'</div></div>',
                unsafe_allow_html=True,
            )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 14c. INSIDER ACTIVITY (Alpha Vantage)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    av_insiders = getattr(cd, "av_insider_transactions", None)
    if av_insiders and len(av_insiders) > 0:
        _section("Insider Activity")
        rows_html = ""
        for t in av_insiders[:20]:
            date = t.get("date", "")
            insider = t.get("insider", "")
            title = t.get("title", "")
            txn_type = t.get("type", "")
            shares = t.get("shares")
            value = t.get("value")

            if txn_type == "A":
                type_label = '<span style="color:#10B981; font-weight:700;">Buy</span>'
                row_bg = "rgba(16,185,129,0.04)"
            elif txn_type == "D":
                type_label = '<span style="color:#EF4444; font-weight:700;">Sell</span>'
                row_bg = "rgba(239,68,68,0.04)"
            else:
                type_label = txn_type
                row_bg = "transparent"

            shares_str = f"{shares:,.0f}" if shares else "â€”"
            value_str = f"{cd.currency_symbol}{value:,.0f}" if value else "â€”"
            rows_html += (
                f'<tr style="background:{row_bg};">'
                f'<td>{date}</td><td>{insider}</td><td style="font-size:0.72rem;">{title}</td>'
                f'<td>{type_label}</td><td style="text-align:right;">{shares_str}</td>'
                f'<td style="text-align:right;">{value_str}</td></tr>'
            )
        st.markdown(
            f'<table class="insider-table">'
            f'<thead><tr><th>Date</th><th>Insider</th><th>Title</th>'
            f'<th>Type</th><th style="text-align:right;">Shares</th>'
            f'<th style="text-align:right;">Value</th></tr></thead>'
            f'<tbody>{rows_html}</tbody></table>'.replace("$", "&#36;"),
            unsafe_allow_html=True,
        )

        # â”€â”€ Insider Deep Dive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with _safe_section("Insider Deep Dive"):
            _ins_txns = av_insiders

            # Parse transactions with dates and values
            _parsed_ins = []
            for t in _ins_txns:
                _dt = t.get("date", "")
                _val = t.get("value") or 0
                _shares = t.get("shares") or 0
                _typ = t.get("type", "")
                _insider = t.get("insider", "")
                try:
                    _pdt = pd.to_datetime(_dt)
                except Exception:
                    continue
                _parsed_ins.append({"date": _pdt, "type": _typ, "value": float(_val), "shares": float(_shares), "insider": _insider})

            if _parsed_ins:
                _ins_df = pd.DataFrame(_parsed_ins)
                _ins_df = _ins_df.sort_values("date")

                # Timeline chart
                st.markdown(
                    '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
                    'letter-spacing:0.5px; margin:1rem 0 0.5rem;">ğŸ“… Insider Transaction Timeline</div>',
                    unsafe_allow_html=True,
                )
                _buys_df = _ins_df[_ins_df["type"] == "A"]
                _sells_df = _ins_df[_ins_df["type"] == "D"]

                fig_ins = go.Figure()
                if len(_buys_df) > 0:
                    _buy_sizes = np.clip(_buys_df["value"] / (_buys_df["value"].max() or 1) * 30 + 5, 5, 40)
                    fig_ins.add_trace(go.Scatter(
                        x=_buys_df["date"], y=_buys_df["value"],
                        mode="markers", name="Buys",
                        marker=dict(color="#10B981", size=_buy_sizes, opacity=0.7, line=dict(width=1, color="#0D9668")),
                        text=[f"{r['insider']}<br>{cs}{r['value']:,.0f}" for _, r in _buys_df.iterrows()],
                        hoverinfo="text+x",
                    ))
                if len(_sells_df) > 0:
                    _sell_sizes = np.clip(_sells_df["value"] / (_sells_df["value"].max() or 1) * 30 + 5, 5, 40)
                    fig_ins.add_trace(go.Scatter(
                        x=_sells_df["date"], y=_sells_df["value"],
                        mode="markers", name="Sells",
                        marker=dict(color="#EF4444", size=_sell_sizes, opacity=0.7, line=dict(width=1, color="#DC2626")),
                        text=[f"{r['insider']}<br>{cs}{r['value']:,.0f}" for _, r in _sells_df.iterrows()],
                        hoverinfo="text+x",
                    ))

                # Rolling 3-month net sentiment
                _ins_df["net_value"] = _ins_df.apply(lambda r: r["value"] if r["type"] == "A" else -r["value"], axis=1)
                _ins_df = _ins_df.set_index("date")
                _rolling_net = _ins_df["net_value"].resample("ME").sum().rolling(3, min_periods=1).sum()
                if len(_rolling_net) > 1:
                    fig_ins.add_trace(go.Scatter(
                        x=_rolling_net.index, y=_rolling_net.values,
                        mode="lines", name="3M Net Sentiment",
                        line=dict(color="#F5A623", width=2, dash="dash"),
                        yaxis="y2",
                    ))
                    fig_ins.update_layout(yaxis2=dict(title="Net Sentiment", overlaying="y", side="right",
                        tickfont=dict(size=9, color="#F5A623"), showgrid=False))

                fig_ins.update_layout(**_CHART_LAYOUT_BASE, height=300, margin=dict(t=20, b=30, l=50, r=60),
                    yaxis=dict(title="Transaction Value", tickprefix=cs, tickfont=dict(size=9, color="#9CA3AF")),
                    xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")), showlegend=True,
                    legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02))
                _apply_space_grid(fig_ins)
                st.plotly_chart(fig_ins, use_container_width=True, key="insider_timeline_chart")

                # Ownership summary
                st.markdown(
                    '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
                    'letter-spacing:0.5px; margin:1rem 0 0.5rem;">ğŸ“Š Insider Ownership Summary</div>',
                    unsafe_allow_html=True,
                )
                _ins_df_reset = _ins_df.reset_index()
                _now = pd.Timestamp.now()
                def _net_over_months(df, months):
                    cutoff = _now - pd.DateOffset(months=months)
                    subset = df[df["date"] >= cutoff]
                    buys = subset[subset["type"] == "A"]["value"].sum()
                    sells = subset[subset["type"] == "D"]["value"].sum()
                    return buys - sells

                _net3 = _net_over_months(_ins_df_reset, 3)
                _net6 = _net_over_months(_ins_df_reset, 6)
                _net12 = _net_over_months(_ins_df_reset, 12)

                # Largest transaction
                _largest_idx = _ins_df_reset["value"].idxmax()
                _largest = _ins_df_reset.loc[_largest_idx] if _largest_idx is not None else None

                ins_s1, ins_s2, ins_s3 = st.columns(3)
                for col, (label, val) in zip([ins_s1, ins_s2, ins_s3],
                    [("Net 3M", _net3), ("Net 6M", _net6), ("Net 12M", _net12)]):
                    with col:
                        _c = "#10B981" if val > 0 else "#EF4444" if val < 0 else "#9CA3AF"
                        _sign = "+" if val > 0 else ""
                        st.markdown(
                            f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); border-radius:10px;">'
                            f'<div style="font-size:0.6rem; color:#9CA3AF; font-weight:600;">{label}</div>'
                            f'<div style="font-size:1.1rem; font-weight:800; color:{_c};">{_sign}{cs}{abs(val):,.0f}</div></div>',
                            unsafe_allow_html=True,
                        )

                if _largest is not None and _largest["value"] > 0:
                    _lt = "Buy" if _largest.get("type") == "A" else "Sell"
                    st.markdown(
                        f'<div style="margin-top:0.5rem; padding:0.5rem; background:rgba(37,99,235,0.04); border-radius:8px; font-size:0.78rem; color:#D1D5DB;">'
                        f'<b>Largest Transaction:</b> {_largest.get("insider", "N/A")} â€” {_lt} â€” '
                        f'{cs}{_largest["value"]:,.0f} on {str(_largest["date"])[:10]}</div>',
                        unsafe_allow_html=True,
                    )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 14d. EARNINGS SURPRISE HISTORY (yfinance)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Earnings Surprise History (yfinance)"):
        try:
            _yf_ticker = yf.Ticker(cd.ticker)
            _eh = getattr(_yf_ticker, "earnings_history", None)
            if _eh is None or (isinstance(_eh, pd.DataFrame) and _eh.empty):
                _eh = getattr(_yf_ticker, "quarterly_earnings", None)
            if _eh is not None and isinstance(_eh, pd.DataFrame) and not _eh.empty:
                _section("Earnings Surprise History", "ğŸ“Š")
                _eh_df = _eh.tail(8).copy()
                _eh_df = _eh_df.reset_index()
                # Detect column names (varies by yfinance version)
                _actual_col = None
                _est_col = None
                for c in _eh_df.columns:
                    cl = str(c).lower()
                    if "actual" in cl or "reported" in cl:
                        _actual_col = c
                    elif "estim" in cl or "expected" in cl:
                        _est_col = c
                # quarterly_earnings uses "Actual" and "Estimate" or "Revenue"/"Earnings"
                if _actual_col is None:
                    for c in _eh_df.columns:
                        cl = str(c).lower()
                        if "earning" in cl and "surprise" not in cl:
                            _actual_col = c
                if _actual_col is not None:
                    _qtr_labels = [str(idx) for idx in _eh_df.iloc[:, 0]]
                    _actuals = pd.to_numeric(_eh_df[_actual_col], errors="coerce").tolist()
                    _estimates = pd.to_numeric(_eh_df[_est_col], errors="coerce").tolist() if _est_col else [None]*len(_actuals)

                    # Beat rate
                    _beats = sum(1 for a, e in zip(_actuals, _estimates) if a is not None and e is not None and a >= e)
                    _total_valid = sum(1 for a, e in zip(_actuals, _estimates) if a is not None and e is not None)
                    _beat_rate = (_beats / _total_valid * 100) if _total_valid > 0 else 0

                    _bar_colors = []
                    for a, e in zip(_actuals, _estimates):
                        if a is not None and e is not None:
                            _bar_colors.append("#10B981" if a >= e else "#EF4444")
                        else:
                            _bar_colors.append("#9CA3AF")

                    fig_esh = go.Figure()
                    if _est_col:
                        fig_esh.add_trace(go.Bar(
                            x=_qtr_labels, y=_estimates, name="Estimate",
                            marker=dict(color="rgba(138,133,173,0.15)", line=dict(color="rgba(138,133,173,0.5)", width=1.5)),
                            text=[f"{v:.2f}" if v is not None and not np.isnan(v) else "" for v in _estimates],
                            textposition="outside", textfont=dict(size=9, color="#9CA3AF"),
                        ))
                    fig_esh.add_trace(go.Bar(
                        x=_qtr_labels, y=_actuals, name="Actual",
                        marker=dict(color=_bar_colors, line=dict(color="rgba(255,255,255,0.2)", width=1)),
                        text=[f"{v:.2f}" if v is not None and not np.isnan(v) else "" for v in _actuals],
                        textposition="outside", textfont=dict(size=9, color="#D1D5DB"),
                    ))
                    fig_esh.update_layout(
                        **_CHART_LAYOUT_BASE, height=420, barmode="group",
                        margin=dict(t=40, b=40, l=60, r=40),
                        xaxis=dict(tickfont=dict(size=11, color="#9CA3AF"), showgrid=False),
                        yaxis=dict(title=dict(text="EPS", font=dict(size=12, color="#9CA3AF")),
                                   tickfont=dict(size=11, color="#9CA3AF"), tickprefix=cs),
                        legend=dict(font=dict(size=11, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
                    )
                    _apply_space_grid(fig_esh)
                    st.plotly_chart(fig_esh, use_container_width=True, key="yf_earnings_surprise_hist")

                    # Beat rate badge
                    _br_color = "#10B981" if _beat_rate >= 75 else "#F5A623" if _beat_rate >= 50 else "#EF4444"
                    st.markdown(
                        f'<div style="text-align:center; margin-top:0.5rem;">'
                        f'<span style="background:rgba(37,99,235,0.08); border:1px solid {_br_color}; '
                        f'border-radius:12px; padding:0.4rem 1.2rem; font-size:0.85rem; font-weight:700; color:{_br_color};">'
                        f'Beat Rate: {_beat_rate:.0f}% ({_beats}/{_total_valid} quarters)</span></div>',
                        unsafe_allow_html=True,
                    )
        except Exception:
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 14e. INSIDER TRANSACTION TIMELINE ON PRICE (yfinance)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Insider Transaction Timeline"):
        try:
            _yf_ticker2 = yf.Ticker(cd.ticker)
            _ins_txn = getattr(_yf_ticker2, "insider_transactions", None)
            if _ins_txn is None or (isinstance(_ins_txn, pd.DataFrame) and _ins_txn.empty):
                _ins_txn = getattr(_yf_ticker2, "insider_purchases", None)
            if _ins_txn is not None and isinstance(_ins_txn, pd.DataFrame) and not _ins_txn.empty:
                _section("Insider Transaction Timeline", "ğŸ•µï¸")
                _price_hist = cd.hist_1y if cd.hist_1y is not None and not cd.hist_1y.empty else None
                if _price_hist is not None and len(_price_hist) > 5:
                    fig_itp = go.Figure()
                    # Price line
                    fig_itp.add_trace(go.Scatter(
                        x=_price_hist.index, y=_price_hist["Close"],
                        mode="lines", name="Price",
                        line=dict(color="#2563EB", width=2),
                    ))
                    # Parse insider transactions
                    _itdf = _ins_txn.reset_index() if _ins_txn.index.name else _ins_txn.copy()
                    # Find date, shares, value, transaction type columns
                    _date_c = _val_c = _shares_c = _type_c = _insider_c = None
                    for c in _itdf.columns:
                        cl = str(c).lower()
                        if "date" in cl or "start" in cl:
                            _date_c = c
                        elif "value" in cl or "amount" in cl or "cost" in cl:
                            _val_c = c
                        elif "share" in cl:
                            _shares_c = c
                        elif "transaction" in cl or "type" in cl or "text" in cl:
                            _type_c = c
                        elif "insider" in cl or "name" in cl or "holder" in cl:
                            _insider_c = c

                    if _date_c:
                        _itdf["_dt"] = pd.to_datetime(_itdf[_date_c], errors="coerce")
                        _itdf = _itdf.dropna(subset=["_dt"])
                        if _val_c:
                            _itdf["_val"] = pd.to_numeric(_itdf[_val_c], errors="coerce").abs().fillna(0)
                        elif _shares_c:
                            _itdf["_val"] = pd.to_numeric(_itdf[_shares_c], errors="coerce").abs().fillna(0) * cd.current_price
                        else:
                            _itdf["_val"] = 1000  # default

                        # Classify buys vs sells
                        def _classify_txn(row):
                            if _type_c and pd.notna(row.get(_type_c)):
                                t = str(row[_type_c]).lower()
                                if any(w in t for w in ["buy", "purchase", "acquisition", "award"]):
                                    return "buy"
                                elif any(w in t for w in ["sell", "sale", "dispos"]):
                                    return "sell"
                            if _shares_c and pd.notna(row.get(_shares_c)):
                                return "buy" if float(row[_shares_c]) > 0 else "sell"
                            return "buy"

                        _itdf["_side"] = _itdf.apply(_classify_txn, axis=1)

                        # Get price at insider dates
                        _price_s = _price_hist["Close"]
                        for side, color, name in [("buy", "#10B981", "Insider Buy"), ("sell", "#EF4444", "Insider Sell")]:
                            _sub = _itdf[_itdf["_side"] == side]
                            if len(_sub) == 0:
                                continue
                            # Map to closest price
                            _y_vals = []
                            for dt in _sub["_dt"]:
                                idx = _price_s.index.get_indexer([dt], method="nearest")[0]
                                _y_vals.append(_price_s.iloc[idx] if 0 <= idx < len(_price_s) else cd.current_price)
                            _sizes = np.clip(_sub["_val"].values / (max(_sub["_val"].max(), 1)) * 25 + 6, 6, 35)
                            _hover = [f"{r.get(_insider_c, 'Insider') if _insider_c else 'Insider'}<br>{cs}{r['_val']:,.0f}" for _, r in _sub.iterrows()]
                            fig_itp.add_trace(go.Scatter(
                                x=_sub["_dt"], y=_y_vals, mode="markers", name=name,
                                marker=dict(color=color, size=_sizes, opacity=0.8,
                                            line=dict(width=1.5, color="rgba(255,255,255,0.3)"),
                                            symbol="circle"),
                                text=_hover, hoverinfo="text+x",
                            ))

                    fig_itp.update_layout(
                        **_CHART_LAYOUT_BASE, height=450,
                        margin=dict(t=20, b=30, l=60, r=40),
                        yaxis=dict(title="Price", tickprefix=cs, tickfont=dict(size=10, color="#9CA3AF")),
                        xaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
                        legend=dict(font=dict(size=11, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
                    )
                    _apply_space_grid(fig_itp)
                    st.plotly_chart(fig_itp, use_container_width=True, key="insider_price_timeline")
        except Exception:
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 14f. RISK-ADJUSTED RETURNS TABLE (Stock vs S&P 500)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Risk-Adjusted Returns"):
        try:
            _ra_hist = cd.hist_1y if cd.hist_1y is not None and not cd.hist_1y.empty else None
            if _ra_hist is not None and len(_ra_hist) > 60:
                _section("Risk-Adjusted Returns", "ğŸ“")
                _spy_hist = yf.Ticker("SPY").history(period="1y")

                def _calc_risk_metrics(prices):
                    """Calculate Sharpe, Sortino, Max Drawdown, Calmar for a price series."""
                    rets = prices.pct_change().dropna()
                    if len(rets) < 20:
                        return {"sharpe": None, "sortino": None, "max_dd": None, "calmar": None, "ann_ret": None}
                    ann_ret = rets.mean() * 252
                    ann_vol = rets.std() * np.sqrt(252)
                    rf = 0.05
                    sharpe = (ann_ret - rf) / ann_vol if ann_vol > 0 else 0
                    # Sortino
                    neg_rets = rets[rets < 0]
                    downside_vol = neg_rets.std() * np.sqrt(252) if len(neg_rets) > 0 else ann_vol
                    sortino = (ann_ret - rf) / downside_vol if downside_vol > 0 else 0
                    # Max drawdown
                    cum = (1 + rets).cumprod()
                    max_dd = (cum / cum.cummax() - 1).min()
                    # Calmar
                    calmar = ann_ret / abs(max_dd) if max_dd != 0 else 0
                    return {"sharpe": sharpe, "sortino": sortino, "max_dd": max_dd * 100, "calmar": calmar, "ann_ret": ann_ret * 100}

                _stock_m = _calc_risk_metrics(_ra_hist["Close"])
                _spy_m = _calc_risk_metrics(_spy_hist["Close"]) if _spy_hist is not None and not _spy_hist.empty else {}

                _metrics_list = [
                    ("Annualized Return", "ann_ret", "%", True),
                    ("Sharpe Ratio", "sharpe", "", True),
                    ("Sortino Ratio", "sortino", "", True),
                    ("Max Drawdown", "max_dd", "%", False),
                    ("Calmar Ratio", "calmar", "", True),
                ]

                _rows = ""
                for label, key, suffix, higher_better in _metrics_list:
                    sv = _stock_m.get(key)
                    spv = _spy_m.get(key)
                    sv_str = f"{sv:.2f}{suffix}" if sv is not None else "N/A"
                    spv_str = f"{spv:.2f}{suffix}" if spv is not None else "N/A"
                    # Color: compare stock vs S&P
                    if sv is not None and spv is not None:
                        if key == "max_dd":
                            better = sv > spv  # less negative = better
                        else:
                            better = sv > spv if higher_better else sv < spv
                        s_color = "#10B981" if better else "#EF4444"
                    else:
                        s_color = "#F9FAFB"
                    _rows += (
                        f'<tr>'
                        f'<td style="font-weight:600; color:#D1D5DB;">{label}</td>'
                        f'<td style="text-align:center; color:{s_color}; font-weight:700;">{sv_str}</td>'
                        f'<td style="text-align:center; color:#F9FAFB;">{spv_str}</td>'
                        f'</tr>'
                    )

                st.markdown(
                    f'<table style="width:100%; border-collapse:collapse; background:rgba(37,99,235,0.04); border-radius:12px; overflow:hidden;">'
                    f'<thead><tr style="border-bottom:2px solid rgba(37,99,235,0.2);">'
                    f'<th style="text-align:left; padding:0.7rem 1rem; color:#60A5FA; font-size:0.75rem; text-transform:uppercase;">Metric</th>'
                    f'<th style="text-align:center; padding:0.7rem 1rem; color:#60A5FA; font-size:0.75rem; text-transform:uppercase;">{cd.ticker}</th>'
                    f'<th style="text-align:center; padding:0.7rem 1rem; color:#60A5FA; font-size:0.75rem; text-transform:uppercase;">S&P 500</th>'
                    f'</tr></thead>'
                    f'<tbody style="font-size:0.85rem;">{_rows}</tbody></table>',
                    unsafe_allow_html=True,
                )
        except Exception:
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 14g. SECTOR PERFORMANCE CONTEXT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Sector Performance Context"):
        try:
            _SECTOR_ETF_MAP = {
                "Technology": "XLK", "Communication Services": "XLC", "Healthcare": "XLV",
                "Financials": "XLF", "Consumer Cyclical": "XLY", "Consumer Defensive": "XLP",
                "Industrials": "XLI", "Energy": "XLE", "Utilities": "XLU",
                "Real Estate": "XLRE", "Basic Materials": "XLB",
            }
            _sector_etf = _SECTOR_ETF_MAP.get(cd.sector)
            if _sector_etf:
                _section("Sector Relative Performance", "ğŸ“Š")
                _periods = {"1M": 21, "3M": 63, "6M": 126, "1Y": 252}
                _stock_hist_full = yf.Ticker(cd.ticker).history(period="1y")
                _etf_hist_full = yf.Ticker(_sector_etf).history(period="1y")

                if not _stock_hist_full.empty and not _etf_hist_full.empty:
                    _perf_data = []
                    for plabel, pdays in _periods.items():
                        try:
                            _sh = _stock_hist_full["Close"]
                            _eh = _etf_hist_full["Close"]
                            if len(_sh) >= pdays and len(_eh) >= pdays:
                                s_ret = (_sh.iloc[-1] / _sh.iloc[-pdays] - 1) * 100
                                e_ret = (_eh.iloc[-1] / _eh.iloc[-pdays] - 1) * 100
                                _perf_data.append({"period": plabel, "stock": s_ret, "etf": e_ret, "relative": s_ret - e_ret})
                        except Exception:
                            pass

                    if _perf_data:
                        fig_sp = go.Figure()
                        _p_labels = [d["period"] for d in _perf_data]
                        _s_vals = [d["stock"] for d in _perf_data]
                        _e_vals = [d["etf"] for d in _perf_data]
                        _r_vals = [d["relative"] for d in _perf_data]
                        _r_colors = ["#10B981" if v >= 0 else "#EF4444" for v in _r_vals]

                        fig_sp.add_trace(go.Bar(x=_p_labels, y=_s_vals, name=cd.ticker,
                            marker=dict(color="#2563EB", line=dict(width=0)), width=0.25, offset=-0.15))
                        fig_sp.add_trace(go.Bar(x=_p_labels, y=_e_vals, name=_sector_etf,
                            marker=dict(color="rgba(138,133,173,0.4)", line=dict(color="#9CA3AF", width=1)), width=0.25, offset=0.15))
                        # Relative performance markers
                        fig_sp.add_trace(go.Scatter(x=_p_labels, y=_r_vals, name="Relative",
                            mode="markers+text", marker=dict(color=_r_colors, size=12, symbol="diamond"),
                            text=[f"{v:+.1f}%" for v in _r_vals], textposition="top center",
                            textfont=dict(size=10, color="#F9FAFB")))

                        fig_sp.update_layout(
                            **_CHART_LAYOUT_BASE, height=380, barmode="group",
                            margin=dict(t=40, b=40, l=60, r=40),
                            yaxis=dict(title="Return %", ticksuffix="%", tickfont=dict(size=11, color="#9CA3AF")),
                            xaxis=dict(tickfont=dict(size=12, color="#9CA3AF")),
                            legend=dict(font=dict(size=11, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
                        )
                        _apply_space_grid(fig_sp)
                        st.plotly_chart(fig_sp, use_container_width=True, key="sector_rel_perf")
        except Exception:
            pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 15. INSIGHTS â€” 7 Rich Tabs
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Insights")
    ai_tab1, ai_tab2, ai_tab3, ai_tab4, ai_tab5, ai_tab6, ai_tab7 = st.tabs([
        "Executive Summary", "Financial Trends", "SWOT Analysis",
        "Growth Outlook", "Capital Allocation", "Industry Analysis", "Risk Factors"
    ])

    # â”€â”€ Tab 1: Executive Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with ai_tab1:
        es_left, es_right = st.columns([3, 2])
        with es_left:
            if cd.executive_summary_bullets:
                for b in cd.executive_summary_bullets:
                    st.markdown(f"<div style='font-size:0.88rem; color:#D1D5DB; line-height:1.7; padding:0.2rem 0;'>&bull; {b}</div>", unsafe_allow_html=True)
            else:
                st.info("Executive summary not available.")
            if cd.product_overview:
                st.markdown('<div style="margin-top:1rem;"><div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem;">Product Overview</div></div>', unsafe_allow_html=True)
                for line in cd.product_overview.split("\n"):
                    line = line.strip()
                    if line.startswith("- "):
                        line = line[2:]
                    if line:
                        st.markdown(f"<div style='font-size:0.84rem; color:#D1D5DB; line-height:1.7; padding:0.15rem 0;'>&bull; {line}</div>", unsafe_allow_html=True)
        with es_right:
            st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
            _build_peer_valuation_chart(cd)
            _build_earnings_surprise_chart(cd)
            st.markdown('</div>', unsafe_allow_html=True)

    # â”€â”€ Tab 2: Financial Trends â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with ai_tab2:
        ft_c1, ft_c2 = st.columns(2)
        with ft_c1:
            st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem;">Revenue & Margins</div>', unsafe_allow_html=True)
            st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
            _build_revenue_margin_chart(cd)
            st.markdown('</div>', unsafe_allow_html=True)
        with ft_c2:
            st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem;">Cash Flow</div>', unsafe_allow_html=True)
            st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
            _build_cashflow_chart(cd)
            st.markdown('</div>', unsafe_allow_html=True)
        st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem; margin-top:0.5rem;">Balance Sheet</div>', unsafe_allow_html=True)
        st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
        _build_balance_sheet_chart(cd)
        st.markdown('</div>', unsafe_allow_html=True)

    # â”€â”€ Tab 3: SWOT Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with ai_tab3:
        _render_swot_grid(cd.swot_analysis)

    # â”€â”€ Tab 4: Growth Outlook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with ai_tab4:
        go_left, go_right = st.columns([3, 2])
        with go_left:
            _render_growth_outlook(cd.growth_outlook, cd)
        with go_right:
            st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem;">Revenue & Margin Trends</div>', unsafe_allow_html=True)
            st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
            _build_revenue_margin_chart(cd, key="rev_margin_growth")
            st.markdown('</div>', unsafe_allow_html=True)

    # â”€â”€ Tab 5: Capital Allocation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with ai_tab5:
        ca_left, ca_right = st.columns([3, 2])
        with ca_left:
            _render_capital_allocation(cd.capital_allocation_analysis, cd)
        with ca_right:
            st.markdown('<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.3rem;">Cash Flow Trends</div>', unsafe_allow_html=True)
            st.markdown('<div class="profile-chart-wrapper">', unsafe_allow_html=True)
            _build_cashflow_chart(cd, key="cashflow_capalloc")
            st.markdown('</div>', unsafe_allow_html=True)

    # â”€â”€ Tab 6: Industry Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with ai_tab6:
        if cd.industry_analysis:
            for line in cd.industry_analysis.split("\n"):
                line = line.strip()
                if line.startswith("- "):
                    line = line[2:]
                if line:
                    st.markdown(f"<div style='font-size:0.88rem; color:#D1D5DB; line-height:1.7; padding:0.2rem 0;'>&bull; {line}</div>", unsafe_allow_html=True)
        else:
            st.info("Industry analysis not available.")

    # â”€â”€ Tab 7: Risk Factors (color-coded severity) â”€â”€â”€
    with ai_tab7:
        if cd.risk_factors:
            for line in cd.risk_factors.split("\n"):
                line = line.strip()
                if line.startswith("- "):
                    line = line[2:]
                if not line:
                    continue
                # Detect severity tag
                severity_color = "#9CA3AF"
                severity_bg = "rgba(138,133,173,0.05)"
                severity_border = "rgba(138,133,173,0.2)"
                if line.startswith("[HIGH]"):
                    line = line[6:].strip()
                    severity_color = "#EF4444"
                    severity_bg = "rgba(239,68,68,0.06)"
                    severity_border = "rgba(239,68,68,0.3)"
                elif line.startswith("[MEDIUM]"):
                    line = line[8:].strip()
                    severity_color = "#F5A623"
                    severity_bg = "rgba(245,166,35,0.06)"
                    severity_border = "rgba(245,166,35,0.3)"
                elif line.startswith("[LOW]"):
                    line = line[5:].strip()
                    severity_color = "#10B981"
                    severity_bg = "rgba(16,185,129,0.06)"
                    severity_border = "rgba(16,185,129,0.3)"
                st.markdown(
                    f'<div style="border-left:3px solid {severity_border}; background:{severity_bg}; '
                    f'padding:0.5rem 0.8rem; margin-bottom:0.4rem; border-radius:0 8px 8px 0;">'
                    f'<div style="font-size:0.86rem; color:#D1D5DB; line-height:1.7;">{line}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
        else:
            st.info("Risk factors not available.")

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 15. DOWNLOAD PPTX
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    st.markdown("")
    st.markdown("")
    _section("Download Tear Sheet")

    if not os.path.exists("assets/template.pptx"):
        with st.spinner("Creating template..."):
            from create_template import build
            build()

    _pptx_confidential = st.checkbox("ğŸ”’ Add Confidential Watermark", value=False, key="pptx_confidential")

    with st.spinner("Building 7-slide PowerPoint presentation..."):
        pptx_buf = generate_presentation(cd, confidential=_pptx_confidential)

    dl1, dl2, dl3 = st.columns([1, 2, 1])
    with dl2:
        st.download_button(
            label=f"Download {cd.ticker} Orbital Profile  (7 slides)",
            data=pptx_buf,
            file_name=f"{cd.ticker}_Orbital_Profile.pptx",
            mime="application/vnd.openxmlformats-officedocument.presentationml.presentation",
            use_container_width=True,
        )
        st.markdown(
            "<p style='text-align:center; font-size:0.72rem; color:#9CA3AF; margin-top:0.3rem;'>"
            "Professional IB-grade presentation &middot; Dark theme &middot; Purple accents &middot; 7 slides"
            "</p>",
            unsafe_allow_html=True,
        )

        # PDF / HTML Export
        try:
            pdf_html = _generate_pdf_html(cd)
            st.download_button(
                label=f"ğŸ“„ Download {cd.ticker} Summary (PDF-Ready HTML)",
                data=pdf_html,
                file_name=f"{cd.ticker}_Orbital_Summary.html",
                mime="text/html",
                use_container_width=True,
            )
            st.markdown(
                "<p style='text-align:center; font-size:0.72rem; color:#9CA3AF; margin-top:0.3rem;'>"
                "Open in browser â†’ Print â†’ Save as PDF &middot; Dark + print-friendly themes"
                "</p>",
                unsafe_allow_html=True,
            )
        except Exception:
            pass

    # Excel Export
    _divider()
    _section("Export Financial Data", "ğŸ“Š")
    
    ex1, ex2, ex3 = st.columns([1, 2, 1])
    with ex2:
        try:
            excel_data = _export_to_excel(cd)
            st.download_button(
                label=f"ğŸ“¥ Download {cd.ticker} Financial Data (Excel)",
                data=excel_data,
                file_name=f"{cd.ticker}_Financial_Data.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                use_container_width=True,
            )
            st.markdown(
                "<p style='text-align:center; font-size:0.72rem; color:#9CA3AF; margin-top:0.3rem;'>"
                "Multi-sheet Excel workbook &middot; Income Statement &middot; Balance Sheet &middot; Cash Flow &middot; Peer Data"
                "</p>",
                unsafe_allow_html=True,
            )
        except Exception as e:
            st.warning(f"Excel export not available: {e}")
        
        # CSV Quick Export
        csv_data = _export_to_csv(cd)
        st.download_button(
            label=f"ğŸ“„ Quick Export (CSV)",
            data=csv_data,
            file_name=f"{cd.ticker}_Summary.csv",
            mime="text/csv",
            use_container_width=True,
        )
        
        # JSON Export
        try:
            json_export = {
                "ticker": cd.ticker,
                "name": cd.name,
                "sector": cd.sector,
                "industry": cd.industry,
                "market_cap": cd.market_cap,
                "enterprise_value": cd.enterprise_value,
                "current_price": cd.current_price,
                "currency": cd.currency_code,
                "trailing_pe": cd.trailing_pe,
                "forward_pe": cd.forward_pe,
                "ev_to_ebitda": cd.ev_to_ebitda,
                "ev_to_revenue": cd.ev_to_revenue,
                "price_to_book": cd.price_to_book,
                "gross_margins": cd.gross_margins,
                "operating_margins": cd.operating_margins,
                "profit_margins": cd.profit_margins,
                "return_on_equity": cd.return_on_equity,
                "return_on_assets": getattr(cd, 'return_on_assets', None),
                "revenue_growth": cd.revenue_growth,
                "dividend_yield": cd.dividend_yield,
                "beta": cd.beta,
                "52w_high": cd.fifty_two_week_high,
                "52w_low": cd.fifty_two_week_low,
                "analyst_price_targets": cd.analyst_price_targets,
                "employees": cd.full_time_employees,
                "export_date": datetime.now().isoformat(),
            }
            json_str = json.dumps(json_export, indent=2, default=str)
            st.download_button(
                label=f"ğŸ”— Export as JSON (API-Ready)",
                data=json_str,
                file_name=f"{cd.ticker}_data.json",
                mime="application/json",
                use_container_width=True,
            )
        except Exception:
            pass
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”” INTELLIGENCE FEED
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Intelligence Feed"):
        _divider()
        st.markdown(
            '<div style="font-size:1.1rem; font-weight:800; color:#F9FAFB; margin-bottom:0.8rem;">'
            'ğŸ”” Intelligence</div>',
            unsafe_allow_html=True,
        )
        try:
            _intel_ticker = yf.Ticker(cd.ticker)
            _intel_info = _intel_ticker.info or {}

            _intel_cols = st.columns(2)

            # Unusual Volume
            with _intel_cols[0]:
                try:
                    _vol_today = _intel_info.get("volume", 0) or 0
                    _vol_avg = _intel_info.get("averageVolume", 1) or 1
                    _vol_ratio = _vol_today / _vol_avg if _vol_avg > 0 else 0
                    _vol_flag = "ğŸ”´ UNUSUAL" if _vol_ratio > 2.0 else "ğŸŸ¡ ELEVATED" if _vol_ratio > 1.5 else "ğŸŸ¢ NORMAL"
                    st.markdown(
                        f'<div style="background:rgba(37,99,235,0.06); border-radius:10px; padding:0.8rem; margin-bottom:0.5rem;">'
                        f'<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-bottom:0.4rem;">ğŸ“Š Volume Analysis</div>'
                        f'<div style="font-size:0.78rem; color:#D1D5DB;">Today: <b>{_vol_today:,.0f}</b></div>'
                        f'<div style="font-size:0.78rem; color:#D1D5DB;">30d Avg: <b>{_vol_avg:,.0f}</b></div>'
                        f'<div style="font-size:0.78rem; color:#D1D5DB;">Ratio: <b>{_vol_ratio:.2f}x</b> {_vol_flag}</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
                except Exception:
                    pass

            # Short Interest
            with _intel_cols[1]:
                try:
                    _short_pct = _intel_info.get("shortPercentOfFloat", None)
                    _short_ratio = _intel_info.get("shortRatio", None)
                    _si_html = ""
                    if _short_pct is not None:
                        _sp = _short_pct * 100 if _short_pct < 1 else _short_pct
                        _si_level = "ğŸ”´ HIGH" if _sp > 20 else "ğŸŸ¡ MODERATE" if _sp > 10 else "ğŸŸ¢ LOW"
                        _si_html += f'<div style="font-size:0.78rem; color:#D1D5DB;">Short % Float: <b>{_sp:.1f}%</b> {_si_level}</div>'
                    if _short_ratio is not None:
                        _si_html += f'<div style="font-size:0.78rem; color:#D1D5DB;">Days to Cover: <b>{_short_ratio:.1f}</b></div>'
                    if _si_html:
                        st.markdown(
                            f'<div style="background:rgba(37,99,235,0.06); border-radius:10px; padding:0.8rem; margin-bottom:0.5rem;">'
                            f'<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-bottom:0.4rem;">ğŸ“‰ Short Interest</div>'
                            f'{_si_html}</div>',
                            unsafe_allow_html=True,
                        )
                    else:
                        st.markdown(
                            '<div style="background:rgba(37,99,235,0.06); border-radius:10px; padding:0.8rem;">'
                            '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA;">ğŸ“‰ Short Interest</div>'
                            '<div style="font-size:0.78rem; color:#9CA3AF;">Data not available</div></div>',
                            unsafe_allow_html=True,
                        )
                except Exception:
                    pass

            # Insider Transactions
            try:
                _insider_txns = _intel_ticker.insider_transactions
                if _insider_txns is not None and not _insider_txns.empty:
                    _buys = len(_insider_txns[_insider_txns.get("Text", _insider_txns.columns[0] if len(_insider_txns.columns) > 0 else "").str.contains("Buy|Purchase", case=False, na=False)] if "Text" in _insider_txns.columns else [])
                    _sells = len(_insider_txns) - _buys
                    _sentiment = "ğŸŸ¢ BULLISH" if _buys > _sells else "ğŸ”´ BEARISH" if _sells > _buys else "ğŸŸ¡ NEUTRAL"
                    st.markdown(
                        f'<div style="background:rgba(37,99,235,0.06); border-radius:10px; padding:0.8rem; margin-bottom:0.5rem;">'
                        f'<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-bottom:0.4rem;">ğŸ‘¤ Insider Activity</div>'
                        f'<div style="font-size:0.78rem; color:#D1D5DB;">Buys: <b style="color:#10B981;">{_buys}</b> | Sells: <b style="color:#EF4444;">{_sells}</b></div>'
                        f'<div style="font-size:0.78rem; color:#D1D5DB;">Net Sentiment: <b>{_sentiment}</b></div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
                else:
                    st.markdown(
                        '<div style="background:rgba(37,99,235,0.06); border-radius:10px; padding:0.8rem; margin-bottom:0.5rem;">'
                        '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA;">ğŸ‘¤ Insider Activity</div>'
                        '<div style="font-size:0.78rem; color:#9CA3AF;">No recent insider transactions</div></div>',
                        unsafe_allow_html=True,
                    )
            except Exception:
                st.markdown(
                    '<div style="background:rgba(37,99,235,0.06); border-radius:10px; padding:0.8rem; margin-bottom:0.5rem;">'
                    '<div style="font-size:0.75rem; font-weight:700; color:#60A5FA;">ğŸ‘¤ Insider Activity</div>'
                    '<div style="font-size:0.78rem; color:#9CA3AF;">Data not available</div></div>',
                    unsafe_allow_html=True,
                )

            # Earnings Surprise
            try:
                _earnings = _intel_ticker.earnings_dates
                if _earnings is not None and not _earnings.empty:
                    _recent = _earnings.head(4)
                    _earn_html = ""
                    for _idx, _row in _recent.iterrows():
                        _est = _row.get("EPS Estimate", None)
                        _act = _row.get("Reported EPS", None)
                        if _est is not None and _act is not None:
                            try:
                                _est_f = float(_est)
                                _act_f = float(_act)
                                _surprise = ((_act_f - _est_f) / abs(_est_f) * 100) if _est_f != 0 else 0
                                _s_color = "#10B981" if _surprise >= 0 else "#EF4444"
                                _s_icon = "âœ…" if _surprise >= 0 else "âŒ"
                                _date_str = str(_idx.date()) if hasattr(_idx, 'date') else str(_idx)[:10]
                                _earn_html += (
                                    f'<div style="display:flex; justify-content:space-between; font-size:0.72rem; padding:0.15rem 0;">'
                                    f'<span style="color:#9CA3AF;">{_date_str}</span>'
                                    f'<span style="color:#D1D5DB;">Est: ${_est_f:.2f}</span>'
                                    f'<span style="color:#D1D5DB;">Act: ${_act_f:.2f}</span>'
                                    f'<span style="color:{_s_color};">{_s_icon} {_surprise:+.1f}%</span>'
                                    f'</div>'
                                )
                            except (ValueError, TypeError):
                                pass
                    if _earn_html:
                        st.markdown(
                            f'<div style="background:rgba(37,99,235,0.06); border-radius:10px; padding:0.8rem;">'
                            f'<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-bottom:0.4rem;">ğŸ“… Earnings Surprises (Last 4)</div>'
                            f'{_earn_html}</div>',
                            unsafe_allow_html=True,
                        )
            except Exception:
                pass

        except Exception:
            st.markdown(
                '<div style="font-size:0.8rem; color:#9CA3AF; padding:0.5rem;">Intelligence data temporarily unavailable.</div>',
                unsafe_allow_html=True,
            )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âš ï¸ RISK MATRIX
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Risk Matrix"):
        _divider()
        _section("Risk Matrix", "âš ï¸")
        try:
            _rm_scores = {}
            _rm_commentary = []

            # 1. Market Risk (Beta-based)
            _rm_beta = getattr(cd, 'beta', None)
            if _rm_beta is not None:
                if _rm_beta >= 1.8:
                    _rm_scores["Market Risk"] = 5
                elif _rm_beta >= 1.5:
                    _rm_scores["Market Risk"] = 4
                elif _rm_beta >= 1.2:
                    _rm_scores["Market Risk"] = 3
                elif _rm_beta >= 0.8:
                    _rm_scores["Market Risk"] = 2
                else:
                    _rm_scores["Market Risk"] = 1
                _rm_commentary.append(f"Beta of {_rm_beta:.2f} indicates {'high' if _rm_beta > 1.5 else 'moderate' if _rm_beta > 0.8 else 'low'} market sensitivity.")
            else:
                _rm_scores["Market Risk"] = 3

            # 2. Financial Risk (D/E based)
            _rm_de = getattr(cd, 'debt_to_equity', None)
            if _rm_de is not None:
                _rm_de_val = float(_rm_de) if not hasattr(_rm_de, 'iloc') else float(_rm_de.iloc[0])
                if _rm_de_val > 200:
                    _rm_scores["Financial Risk"] = 5
                elif _rm_de_val > 100:
                    _rm_scores["Financial Risk"] = 4
                elif _rm_de_val > 50:
                    _rm_scores["Financial Risk"] = 3
                elif _rm_de_val > 20:
                    _rm_scores["Financial Risk"] = 2
                else:
                    _rm_scores["Financial Risk"] = 1
                _rm_commentary.append(f"Debt/Equity of {_rm_de_val:.0f}% â€” {'highly leveraged' if _rm_de_val > 100 else 'moderate leverage' if _rm_de_val > 50 else 'conservative balance sheet'}.")
            else:
                _rm_scores["Financial Risk"] = 3

            # 3. Valuation Risk
            _rm_price = getattr(cd, 'current_price', None) or 0
            _rm_52hi = getattr(cd, 'fifty_two_week_high', None) or 0
            _rm_pe = getattr(cd, 'trailing_pe', None)
            _rm_val_score = 3
            if _rm_52hi > 0 and _rm_price > 0:
                _rm_pct_from_hi = (_rm_52hi - _rm_price) / _rm_52hi
                if _rm_pct_from_hi < 0.05:
                    _rm_val_score = 4  # Near high = more valuation risk
                elif _rm_pct_from_hi > 0.30:
                    _rm_val_score = 2  # Well below high
            if _rm_pe is not None and _rm_pe > 40:
                _rm_val_score = min(_rm_val_score + 1, 5)
            elif _rm_pe is not None and _rm_pe < 15:
                _rm_val_score = max(_rm_val_score - 1, 1)
            _rm_scores["Valuation Risk"] = _rm_val_score
            if _rm_52hi > 0:
                _rm_commentary.append(f"Trading {((_rm_52hi - _rm_price) / _rm_52hi * 100):.0f}% below 52-week high{f', P/E {_rm_pe:.0f}x' if _rm_pe else ''}.")

            # 4. Liquidity Risk
            _rm_cr = getattr(cd, 'current_ratio', None)
            _rm_cr_val = float(_rm_cr) if _rm_cr is not None and not hasattr(_rm_cr, 'iloc') else (float(_rm_cr.iloc[0]) if _rm_cr is not None else None)
            _rm_liq_score = 3
            if _rm_cr_val is not None:
                if _rm_cr_val >= 2.0:
                    _rm_liq_score = 1
                elif _rm_cr_val >= 1.5:
                    _rm_liq_score = 2
                elif _rm_cr_val >= 1.0:
                    _rm_liq_score = 3
                elif _rm_cr_val >= 0.5:
                    _rm_liq_score = 4
                else:
                    _rm_liq_score = 5
                _rm_commentary.append(f"Current ratio of {_rm_cr_val:.2f} â€” {'strong' if _rm_cr_val >= 1.5 else 'adequate' if _rm_cr_val >= 1.0 else 'weak'} liquidity.")
            _rm_scores["Liquidity Risk"] = _rm_liq_score

            # 5. Concentration Risk
            _rm_inst = getattr(cd, 'institutional_holders_pct', None) or getattr(cd, 'held_percent_institutions', None)
            _rm_conc_score = 3
            if _rm_inst is not None:
                _rm_inst_val = float(_rm_inst) * 100 if float(_rm_inst) <= 1 else float(_rm_inst)
                if _rm_inst_val > 80:
                    _rm_conc_score = 4
                elif _rm_inst_val > 60:
                    _rm_conc_score = 3
                elif _rm_inst_val > 30:
                    _rm_conc_score = 2
                else:
                    _rm_conc_score = 2
                _rm_commentary.append(f"Institutional ownership at {_rm_inst_val:.0f}%.")
            _rm_scores["Concentration Risk"] = _rm_conc_score

            if _rm_scores:
                _rm_categories = list(_rm_scores.keys())
                _rm_values = list(_rm_scores.values())
                _rm_total = sum(_rm_values)
                _rm_total_color = "#10B981" if _rm_total <= 10 else "#F5A623" if _rm_total <= 17 else "#EF4444"
                _rm_total_label = "LOW RISK" if _rm_total <= 10 else "MODERATE RISK" if _rm_total <= 17 else "HIGH RISK"

                # Radar chart
                fig_rm = go.Figure()
                fig_rm.add_trace(go.Scatterpolar(
                    r=_rm_values + [_rm_values[0]],  # close the polygon
                    theta=_rm_categories + [_rm_categories[0]],
                    fill='toself',
                    fillcolor='rgba(37,99,235,0.15)',
                    line=dict(color='#2563EB', width=2),
                    marker=dict(size=6, color='#2563EB'),
                    name='Risk Profile',
                ))
                fig_rm.update_layout(
                    **_CHART_LAYOUT_BASE, height=380,
                    margin=dict(t=40, b=40, l=80, r=80),
                    polar=dict(
                        radialaxis=dict(visible=True, range=[0, 5], tickfont=dict(size=8, color="#9CA3AF"),
                                       gridcolor="rgba(138,133,173,0.15)"),
                        angularaxis=dict(tickfont=dict(size=10, color="#D1D5DB"),
                                        gridcolor="rgba(138,133,173,0.15)"),
                        bgcolor="rgba(0,0,0,0)",
                    ),
                    showlegend=False,
                )
                st.plotly_chart(fig_rm, use_container_width=True, key="risk_matrix_radar")

                # Overall score
                st.markdown(
                    f'<div style="text-align:center; padding:1rem; background:rgba(255,255,255,0.03); border-radius:12px; margin:0.5rem 0;">'
                    f'<div style="font-size:0.75rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Overall Risk Score</div>'
                    f'<div style="font-size:2.5rem; font-weight:900; color:{_rm_total_color};">{_rm_total}<span style="font-size:1rem; color:#9CA3AF;">/25</span></div>'
                    f'<div style="font-size:0.85rem; font-weight:700; color:{_rm_total_color};">{_rm_total_label}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

                # Commentary
                if _rm_commentary:
                    _rm_comm_html = "".join(f'<div style="font-size:0.78rem; color:#D1D5DB; margin:0.2rem 0;">â€¢ {c}</div>' for c in _rm_commentary)
                    st.markdown(
                        f'<div style="background:rgba(37,99,235,0.04); border-radius:10px; padding:0.8rem; margin-top:0.5rem;">'
                        f'<div style="font-size:0.75rem; font-weight:700; color:#60A5FA; margin-bottom:0.4rem;">Risk Commentary</div>'
                        f'{_rm_comm_html}</div>',
                        unsafe_allow_html=True,
                    )
        except Exception:
            st.info("Risk matrix analysis unavailable.")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # EXPORT SUMMARY (copy-paste friendly)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Export Summary"):
        _divider()
        with st.expander("ğŸ“‹ Export Summary (copy-paste friendly)", expanded=False):
            _ex_lines = []
            _ex_lines.append(f"{getattr(cd, 'name', 'N/A')} ({getattr(cd, 'ticker', 'N/A')})")
            _ex_lines.append(f"{'='*50}")
            _ex_price = getattr(cd, 'current_price', None)
            _ex_cs = getattr(cd, 'currency_symbol', '$')
            _ex_lines.append(f"Price: {_ex_cs}{_ex_price:,.2f}" if _ex_price else "Price: N/A")
            _ex_mcap = getattr(cd, 'market_cap', None)
            _ex_lines.append(f"Market Cap: {format_number(_ex_mcap, currency_symbol=_ex_cs)}" if _ex_mcap else "Market Cap: N/A")
            _ex_lines.append(f"Sector: {getattr(cd, 'sector', 'N/A')} | Industry: {getattr(cd, 'industry', 'N/A')}")
            _ex_lines.append("")
            _ex_lines.append("KEY MULTIPLES")
            _ex_lines.append(f"-" * 30)
            _ex_pe = getattr(cd, 'trailing_pe', None)
            _ex_lines.append(f"P/E Ratio: {_ex_pe:.1f}x" if _ex_pe else "P/E Ratio: N/A")
            _ex_fpe = getattr(cd, 'forward_pe', None)
            _ex_lines.append(f"Forward P/E: {_ex_fpe:.1f}x" if _ex_fpe else "Forward P/E: N/A")
            _ex_ps = getattr(cd, 'price_to_sales', None)
            _ex_lines.append(f"P/S: {_ex_ps:.1f}x" if _ex_ps else "P/S: N/A")
            # EV/EBITDA
            _ex_ev = getattr(cd, 'enterprise_value', None) or 0
            _ex_ebitda_s = getattr(cd, 'ebitda', None)
            _ex_ebitda_v = None
            try:
                _ex_ebitda_v = float(_ex_ebitda_s.iloc[0]) if hasattr(_ex_ebitda_s, 'iloc') and len(_ex_ebitda_s) > 0 else (float(_ex_ebitda_s) if _ex_ebitda_s is not None else None)
            except Exception:
                pass
            if _ex_ebitda_v and _ex_ebitda_v > 0:
                _ex_lines.append(f"EV/EBITDA: {_ex_ev/_ex_ebitda_v:.1f}x")
            else:
                _ex_lines.append("EV/EBITDA: N/A")
            _ex_lines.append("")
            # Valuation assessment
            _ex_lines.append("VALUATION ASSESSMENT")
            _ex_lines.append(f"-" * 30)
            if _ex_pe and _ex_pe > 0:
                if _ex_pe < 15:
                    _ex_lines.append("Appears undervalued relative to historical P/E norms.")
                elif _ex_pe < 25:
                    _ex_lines.append("Valuation appears fair relative to market averages.")
                else:
                    _ex_lines.append("Trading at a premium valuation; priced for strong growth.")
            else:
                _ex_lines.append("Insufficient data for valuation assessment.")
            _ex_lines.append("")
            # Key risks
            _ex_lines.append("KEY RISKS")
            _ex_lines.append(f"-" * 30)
            _ex_risks = []
            _ex_dte = getattr(cd, 'debt_to_equity', None)
            if _ex_dte and _ex_dte > 150:
                _ex_risks.append(f"High leverage (D/E: {_ex_dte:.0f}%)")
            _ex_pm = getattr(cd, 'profit_margins', None)
            if _ex_pm is not None and _ex_pm < 0.05:
                _pm_d = _ex_pm * 100 if abs(_ex_pm) < 5 else _ex_pm
                _ex_risks.append(f"Thin/declining margins ({_pm_d:.1f}%)")
            _ex_rg = getattr(cd, 'revenue_growth', None)
            if _ex_rg is not None and _ex_rg < 0:
                _rg_d = _ex_rg * 100 if abs(_ex_rg) < 5 else _ex_rg
                _ex_risks.append(f"Revenue declining ({_rg_d:.1f}% YoY)")
            _ex_beta = getattr(cd, 'beta', None)
            if _ex_beta and _ex_beta > 1.5:
                _ex_risks.append(f"High volatility (beta: {_ex_beta:.2f})")
            if not _ex_risks:
                _ex_risks.append("No major red flags identified.")
            for r in _ex_risks:
                _ex_lines.append(f"- {r}")
            _ex_text = "\n".join(_ex_lines)
            st.code(_ex_text, language=None)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # AI INVESTMENT MEMO
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _divider()
    with _safe_section("AI Investment Memo"):
        _memo_key = f"ai_memo_{cd.ticker}"
        if st.button("ğŸ“ Generate AI Investment Memo", key="gen_ai_memo", use_container_width=True):
            with st.spinner("Generating investment memo..."):
                _memo_text = None
                try:
                    import os as _os_memo
                    if _os_memo.environ.get("OPENROUTER_API_KEY") or _os_memo.environ.get("OPENAI_API_KEY"):
                        from ai_insights import _call_llm, format_number, format_pct
                        _memo_prompt = f"""You are a senior equity research analyst. Write a concise investment memo for {cd.name} ({cd.ticker}).

Key Data:
- Price: {cs}{cd.current_price:.2f} | Market Cap: {format_number(cd.market_cap, currency_symbol=cs)}
- EV/EBITDA: {cd.ev_to_ebitda or 'N/A'} | P/E: {cd.trailing_pe or 'N/A'} | Forward P/E: {cd.forward_pe or 'N/A'}
- Revenue Growth: {f'{cd.revenue_growth:.1f}%' if cd.revenue_growth else 'N/A'}
- Gross Margin: {format_pct(cd.gross_margins)} | Operating Margin: {format_pct(cd.operating_margins)} | Net Margin: {format_pct(cd.profit_margins)}
- ROE: {format_pct(cd.return_on_equity)} | D/E: {cd.debt_to_equity or 'N/A'}
- Beta: {cd.beta or 'N/A'} | Dividend Yield: {format_pct(cd.dividend_yield) if cd.dividend_yield else 'None'}
- Sector: {cd.sector} | Industry: {cd.industry}

Write in this format:
## Investment Thesis
[2-3 sentences on why this is or isn't a good investment]

## Key Risks
[3 bullet points of specific risks with data]

## Catalysts
[3 bullet points of potential positive catalysts]

## Recommendation
[1-2 sentences: BUY/HOLD/SELL with price context]
"""
                        _memo_text = _call_llm(_memo_prompt, max_tokens=1500)
                except Exception as _memo_e:
                    _memo_text = None

                if not _memo_text:
                    # Rule-based fallback memo with actual data
                    _m_growth = cd.revenue_growth or 0
                    _m_pe = cd.trailing_pe or 0
                    _m_fpe = cd.forward_pe or 0
                    _m_de = cd.debt_to_equity or 0
                    _m_gm = (cd.gross_margins or 0) * 100
                    _m_om = (cd.operating_margins or 0) * 100
                    _m_roe = (cd.return_on_equity or 0) * 100
                    _m_beta = cd.beta or 1.0
                    _m_div = (cd.dividend_yield or 0) * 100
                    _m_fcf = cd.free_cashflow_series.iloc[0] if cd.free_cashflow_series is not None and len(cd.free_cashflow_series) > 0 else 0

                    _m_thesis_tone = "attractive" if (_m_growth > 5 and _m_roe > 15) else "fairly valued" if _m_roe > 10 else "challenging"
                    _m_val = "premium" if _m_pe > 25 else "reasonable" if _m_pe > 12 else "value"

                    _memo_text = f"""## Investment Thesis
{cd.name} presents a {_m_thesis_tone} investment opportunity in the {cd.industry} space. The company generates {cs}{format_number(cd.market_cap, currency_symbol='') if cd.market_cap else 'N/A'} in market cap with {'positive' if _m_growth > 0 else 'negative'} revenue momentum ({_m_growth:.1f}% YoY) and {_m_gm:.0f}% gross margins. Trading at {_m_pe:.1f}x trailing earnings ({'forward P/E of ' + f'{_m_fpe:.1f}x suggests earnings growth' if _m_fpe < _m_pe and _m_fpe > 0 else 'valuation appears ' + _m_val}).

## Key Risks
- **Leverage:** D/E ratio of {_m_de:.0f}% {'is elevated and may constrain flexibility' if _m_de > 150 else 'is manageable' if _m_de > 50 else 'indicates a conservative balance sheet'}
- **Margin Pressure:** Operating margin of {_m_om:.1f}% {'leaves limited buffer against cost inflation' if _m_om < 10 else 'provides reasonable cushion' if _m_om < 20 else 'demonstrates strong pricing power'}
- **Volatility:** Beta of {_m_beta:.2f} implies {'above-market' if _m_beta > 1.2 else 'near-market' if _m_beta > 0.8 else 'below-market'} risk â€” {'potential for sharp drawdowns in risk-off environments' if _m_beta > 1.2 else 'relatively stable price action'}

## Catalysts
- {'Revenue acceleration beyond ' + f'{_m_growth:.0f}% could drive multiple expansion' if _m_growth > 0 else 'Revenue stabilization and return to growth'}
- {'Margin expansion from operating leverage on ' + f'{_m_gm:.0f}% gross margins' if _m_gm > 40 else 'Cost optimization initiatives to improve profitability'}
- {'Strong FCF generation (' + format_number(_m_fcf, currency_symbol=cs) + ') enables buybacks/dividends' if _m_fcf > 0 else 'Improving cash flow conversion as business scales'}

## Recommendation
{'**BUY** â€” ' + cd.name + ' offers compelling growth at a reasonable valuation with strong fundamentals (ROE: ' + f'{_m_roe:.0f}%, growing at {_m_growth:.0f}%).' if _m_thesis_tone == 'attractive' else '**HOLD** â€” ' + cd.name + ' is fairly valued at current levels. Wait for a better entry point or positive catalyst.' if _m_thesis_tone == 'fairly valued' else '**SELL/AVOID** â€” Fundamentals are under pressure. Monitor for improvement before initiating a position.'}"""

                st.session_state[_memo_key] = _memo_text

        if _memo_key in st.session_state:
            st.markdown(
                f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
                f'border-radius:12px; padding:1.2rem; margin-top:0.5rem;">'
                f'<div style="font-size:0.65rem; color:#9CA3AF; margin-bottom:0.5rem;">ğŸ¤– AI-GENERATED MEMO â€” NOT FINANCIAL ADVICE</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
            st.markdown(st.session_state[_memo_key])

    # Add to Watchlist
    _divider()
    if not _is_in_watchlist(cd.ticker):
        wl1, wl2, wl3 = st.columns([1, 2, 1])
        with wl2:
            if st.button(f"â­ Add {cd.ticker} to Watchlist", use_container_width=True):
                _add_to_watchlist(cd.ticker)
                st.success(f"Added {cd.ticker} to watchlist!")
                st.rerun()
    else:
        st.markdown(
            f'<div style="text-align:center; padding:0.5rem; background:rgba(16,185,129,0.1); '
            f'border-radius:10px; color:#10B981; font-size:0.85rem;">'
            f'â­ {cd.ticker} is in your watchlist</div>',
            unsafe_allow_html=True,
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # QUICK ACTIONS BAR (Fixed Bottom)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    st.markdown('<div style="height:2rem;"></div>', unsafe_allow_html=True)
    st.markdown(
        '<div style="background:linear-gradient(135deg, rgba(37,99,235,0.08), rgba(16,185,129,0.06)); '
        'border-radius:16px; border:1px solid rgba(37,99,235,0.15); padding:0.8rem 1.2rem; '
        'backdrop-filter:blur(10px); position:sticky; bottom:0; z-index:100;">'
        '<div style="font-size:0.6rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px; '
        'text-align:center; margin-bottom:0.4rem;">Quick Actions</div></div>',
        unsafe_allow_html=True,
    )
    _qa1, _qa2, _qa3, _qa4, _qa5 = st.columns(5)
    with _qa1:
        # PPTX Download
        try:
            if not os.path.exists("assets/template.pptx"):
                from create_template import build
                build()
            _qa_pptx = generate_presentation(cd)
            st.download_button(
                label="ğŸ“¥ PPTX",
                data=_qa_pptx,
                file_name=f"{cd.ticker}_Profile.pptx",
                mime="application/vnd.openxmlformats-officedocument.presentationml.presentation",
                use_container_width=True,
                key="qa_pptx_dl",
            )
        except Exception:
            st.button("ğŸ“¥ PPTX", disabled=True, use_container_width=True, key="qa_pptx_na")
    with _qa2:
        # Excel Export
        try:
            _qa_excel = _export_to_excel(cd)
            st.download_button(
                label="ğŸ“Š Excel",
                data=_qa_excel,
                file_name=f"{cd.ticker}_Data.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                use_container_width=True,
                key="qa_excel_dl",
            )
        except Exception:
            st.button("ğŸ“Š Excel", disabled=True, use_container_width=True, key="qa_excel_na")
    with _qa3:
        # Copy Summary
        _qa_summary = (
            f"{cd.name} ({cd.ticker}) | {cd.sector or 'N/A'} | "
            f"Price: {getattr(cd, 'currency_symbol', '$')}{cd.current_price:,.2f} | "
            f"MCap: {format_number(cd.market_cap)} | "
            f"P/E: {cd.trailing_pe:.1f}x" if cd.trailing_pe else f"{cd.name} ({cd.ticker})"
        )
        st.markdown(
            f'<button onclick="navigator.clipboard.writeText(\'{_qa_summary.replace(chr(39), "")}\').then(()=>{{this.textContent=\'âœ… Copied!\';setTimeout(()=>this.textContent=\'ğŸ“‹ Copy Summary\',1500)}})" '
            f'style="width:100%; padding:0.4rem; background:rgba(37,99,235,0.1); border:1px solid rgba(37,99,235,0.2); '
            f'border-radius:8px; color:#D1D5DB; cursor:pointer; font-size:0.8rem;">ğŸ“‹ Copy Summary</button>',
            unsafe_allow_html=True,
        )
    with _qa4:
        # Add to Watchlist
        if not _is_in_watchlist(cd.ticker):
            if st.button("ğŸ”– Watchlist", use_container_width=True, key="qa_watchlist_add"):
                _add_to_watchlist(cd.ticker)
                st.rerun()
        else:
            st.button("âœ… Saved", disabled=True, use_container_width=True, key="qa_watchlist_done")
    with _qa5:
        # Generate Memo
        _qa_memo = (
            f"INVESTMENT MEMO: {cd.name} ({cd.ticker})\n"
            f"{'='*50}\n"
            f"Sector: {cd.sector or 'N/A'} | Industry: {cd.industry or 'N/A'}\n"
            f"Price: {getattr(cd, 'currency_symbol', '$')}{cd.current_price:,.2f} | Market Cap: {format_number(cd.market_cap)}\n"
            f"EV/EBITDA: {format_multiple(cd.ev_to_ebitda)} | P/E: {format_multiple(cd.trailing_pe)}\n"
            f"Gross Margin: {format_pct(cd.gross_margins)} | Op Margin: {format_pct(cd.operating_margins)}\n"
            f"ROE: {format_pct(cd.return_on_equity)} | Revenue Growth: {format_pct(cd.revenue_growth)}\n"
            f"\nBusiness: {(cd.business_summary or 'N/A')[:200]}\n"
            f"\nGenerated by Orbital ProfileBuilder"
        )
        st.download_button(
            label="ğŸ“‘ Memo",
            data=_qa_memo,
            file_name=f"{cd.ticker}_Memo.txt",
            mime="text/plain",
            use_container_width=True,
            key="qa_memo_dl",
        )

    # â”€â”€ Additional Quick Action Row â”€â”€
    st.markdown('<div style="height:0.3rem;"></div>', unsafe_allow_html=True)
    _qa6, _qa7, _qa8 = st.columns(3)
    with _qa6:
        # Compare with S&P 500
        if st.button("ğŸ“ˆ vs S&P 500", use_container_width=True, key="qa_sp500_cmp"):
            st.session_state["_qa_show_sp500"] = True
    with _qa7:
        # Export All (PPTX + HTML + Excel)
        try:
            _qa_all_buf = io.BytesIO()
            import zipfile as _qa_zf
            with _qa_zf.ZipFile(_qa_all_buf, 'w', _qa_zf.ZIP_DEFLATED) as _qa_zip:
                # PPTX
                try:
                    if not os.path.exists("assets/template.pptx"):
                        from create_template import build
                        build()
                    _qa_pptx_data = generate_presentation(cd)
                    _qa_zip.writestr(f"{cd.ticker}_Profile.pptx", _qa_pptx_data)
                except Exception:
                    pass
                # Excel
                try:
                    _qa_xl_data = _export_to_excel(cd)
                    _qa_zip.writestr(f"{cd.ticker}_Data.xlsx", _qa_xl_data)
                except Exception:
                    pass
                # HTML summary
                _qa_html_content = (
                    f"<html><head><title>{cd.name} ({cd.ticker}) Analysis</title>"
                    f"<style>body{{font-family:Arial,sans-serif;background:#0F0E1A;color:#F9FAFB;padding:2rem;}}"
                    f"h1{{color:#2563EB;}}h2{{color:#60A5FA;}}table{{border-collapse:collapse;width:100%;}}"
                    f"td,th{{border:1px solid #333;padding:8px;text-align:right;}}th{{background:#111827;}}</style></head><body>"
                    f"<h1>{cd.name} ({cd.ticker})</h1>"
                    f"<p>Sector: {cd.sector or 'N/A'} | Industry: {cd.industry or 'N/A'}</p>"
                    f"<h2>Key Metrics</h2><table><tr><th>Metric</th><th>Value</th></tr>"
                    f"<tr><td>Price</td><td>{cs}{cd.current_price:,.2f}</td></tr>"
                    f"<tr><td>Market Cap</td><td>{format_number(cd.market_cap)}</td></tr>"
                    f"<tr><td>P/E (TTM)</td><td>{format_multiple(cd.trailing_pe)}</td></tr>"
                    f"<tr><td>EV/EBITDA</td><td>{format_multiple(cd.ev_to_ebitda)}</td></tr>"
                    f"<tr><td>Gross Margin</td><td>{format_pct(cd.gross_margins)}</td></tr>"
                    f"<tr><td>Op Margin</td><td>{format_pct(cd.operating_margins)}</td></tr>"
                    f"<tr><td>ROE</td><td>{format_pct(cd.return_on_equity)}</td></tr>"
                    f"<tr><td>Revenue Growth</td><td>{format_pct(cd.revenue_growth)}</td></tr>"
                    f"</table><p style='color:#9CA3AF;font-size:0.8rem;margin-top:2rem;'>Generated by Orbital ProfileBuilder</p></body></html>"
                )
                _qa_zip.writestr(f"{cd.ticker}_Summary.html", _qa_html_content)
            _qa_all_buf.seek(0)
            st.download_button(
                label="ğŸ“¦ Export All",
                data=_qa_all_buf.getvalue(),
                file_name=f"{cd.ticker}_Complete.zip",
                mime="application/zip",
                use_container_width=True,
                key="qa_export_all_dl",
            )
        except Exception:
            st.button("ğŸ“¦ Export All", disabled=True, use_container_width=True, key="qa_export_all_na")
    with _qa8:
        # Share Analysis â€” base64 encoded summary URL
        import base64 as _qa_b64
        _qa_share_data = json.dumps({
            "t": cd.ticker, "n": cd.name, "p": round(cd.current_price, 2) if cd.current_price else 0,
            "mc": format_number(cd.market_cap), "pe": round(cd.trailing_pe, 1) if cd.trailing_pe else None,
            "ev": round(cd.ev_to_ebitda, 1) if cd.ev_to_ebitda else None,
            "gm": round(cd.gross_margins * 100, 1) if cd.gross_margins else None,
            "rg": round(cd.revenue_growth * 100, 1) if cd.revenue_growth else None,
            "s": cd.sector,
        })
        _qa_share_encoded = _qa_b64.b64encode(_qa_share_data.encode()).decode()
        _qa_share_url = f"?shared={_qa_share_encoded}"
        st.markdown(
            f'<button onclick="navigator.clipboard.writeText(window.location.origin + window.location.pathname + \'{_qa_share_url}\').then(()=>{{this.textContent=\'âœ… Copied!\';setTimeout(()=>this.textContent=\'ğŸ”— Share Analysis\',1500)}})" '
            f'style="width:100%; padding:0.4rem; background:rgba(37,99,235,0.1); border:1px solid rgba(37,99,235,0.2); '
            f'border-radius:8px; color:#D1D5DB; cursor:pointer; font-size:0.8rem;">ğŸ”— Share Analysis</button>',
            unsafe_allow_html=True,
        )

    # â”€â”€ S&P 500 Comparison Chart (shown when button clicked) â”€â”€
    if st.session_state.get("_qa_show_sp500", False):
        try:
            _sp_ticker = yf.Ticker("^GSPC")
            _sp_hist = _sp_ticker.history(period="1y")
            _co_hist = yf.Ticker(cd.ticker).history(period="1y")
            if _sp_hist is not None and len(_sp_hist) > 10 and _co_hist is not None and len(_co_hist) > 10:
                _sp_norm = (_sp_hist['Close'] / _sp_hist['Close'].iloc[0] - 1) * 100
                _co_norm = (_co_hist['Close'] / _co_hist['Close'].iloc[0] - 1) * 100
                _sp_fig = go.Figure()
                _sp_fig.add_trace(go.Scatter(x=_co_norm.index, y=_co_norm.values, name=cd.ticker, line=dict(color="#2563EB", width=2.5)))
                _sp_fig.add_trace(go.Scatter(x=_sp_norm.index, y=_sp_norm.values, name="S&P 500", line=dict(color="#9CA3AF", width=1.5, dash="dash")))
                _sp_fig.add_hline(y=0, line_dash="dot", line_color="rgba(255,255,255,0.15)")
                _sp_fig.update_layout(
                    **_CHART_LAYOUT_BASE, height=350,
                    title=dict(text=f"{cd.ticker} vs S&P 500 â€” 1Y Relative Performance", font=dict(size=12, color="#D1D5DB")),
                    yaxis=dict(title=dict(text="Return (%)", font=dict(size=10, color="#9CA3AF")), ticksuffix="%", tickfont=dict(size=9, color="#9CA3AF")),
                    xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                    legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=-0.2, xanchor="center", x=0.5),
                )
                _apply_space_grid(_sp_fig)
                st.plotly_chart(_sp_fig, use_container_width=True, key="qa_sp500_chart")

                # Performance summary
                _co_ret = _co_norm.iloc[-1] if len(_co_norm) > 0 else 0
                _sp_ret = _sp_norm.iloc[-1] if len(_sp_norm) > 0 else 0
                _alpha = _co_ret - _sp_ret
                _alpha_color = "#10B981" if _alpha > 0 else "#EF4444"
                st.markdown(
                    f'<div style="display:flex; gap:1rem; justify-content:center; margin:0.5rem 0;">'
                    f'<div style="background:rgba(37,99,235,0.08); border-radius:10px; padding:0.5rem 1rem; text-align:center;">'
                    f'<div style="font-size:0.6rem; color:#9CA3AF;">{cd.ticker}</div>'
                    f'<div style="font-size:1rem; font-weight:700; color:{"#10B981" if _co_ret > 0 else "#EF4444"};">{_co_ret:+.1f}%</div></div>'
                    f'<div style="background:rgba(138,133,173,0.08); border-radius:10px; padding:0.5rem 1rem; text-align:center;">'
                    f'<div style="font-size:0.6rem; color:#9CA3AF;">S&P 500</div>'
                    f'<div style="font-size:1rem; font-weight:700; color:{"#10B981" if _sp_ret > 0 else "#EF4444"};">{_sp_ret:+.1f}%</div></div>'
                    f'<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px; padding:0.5rem 1rem; text-align:center;">'
                    f'<div style="font-size:0.6rem; color:#9CA3AF;">Alpha (1Y)</div>'
                    f'<div style="font-size:1rem; font-weight:700; color:{_alpha_color};">{_alpha:+.1f}%</div></div></div>',
                    unsafe_allow_html=True,
                )
            else:
                st.info("Insufficient data for S&P 500 comparison.")
        except Exception as _sp_e:
            st.info(f"S&P 500 comparison unavailable: {_sp_e}")

elif analysis_mode == "Company Profile" and generate_btn and not ticker_input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # LANDING PAGE - Professional splash when no ticker entered
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Clean Orbital Logo (no spinning rings)
    st.markdown(
        '<div style="text-align:center; margin:3rem 0 2rem;">'
        '<div style="font-size:3rem; font-weight:900; letter-spacing:4px; color:#F9FAFB; '
        'text-shadow:0 0 20px rgba(37,99,235,0.6), 0 0 40px rgba(37,99,235,0.3);">ORBITAL</div>'
        '<div style="font-size:1.1rem; color:#9CA3AF; margin-top:0.75rem; font-weight:500;">M&A Intelligence Platform</div>'
        '</div>',
        unsafe_allow_html=True,
    )
    
    # Prominent ticker search reminder
    st.markdown(
        '<div style="text-align:center; margin:2rem auto; max-width:600px;">'
        '<div style="background:rgba(37,99,235,0.08); border:2px solid rgba(37,99,235,0.3); '
        'border-radius:12px; padding:2rem;">'
        '<div style="font-size:1rem; color:#60A5FA; margin-bottom:0.5rem;">ğŸ‘ˆ Enter a ticker symbol in the sidebar to begin</div>'
        '<div style="font-size:0.85rem; color:#9CA3AF;">Examples: AAPL, MSFT, GOOGL, TSLA</div>'
        '</div>'
        '</div>',
        unsafe_allow_html=True,
    )
    
    # Market Pulse - clean pill format in frosted glass container
    st.markdown('<div style="text-align:center; font-size:1.25rem; font-weight:700; color:#F9FAFB; margin:3rem 0 1.5rem; '
               'letter-spacing:-0.02em;">Market Pulse</div>', unsafe_allow_html=True)
    
    try:
        import yfinance as yf
        market_indices = {
            "S&P 500": "^GSPC",
            "NASDAQ": "^IXIC",
            "DOW": "^DJI",
            "TSX": "^GSPTSE",
            "VIX": "^VIX",
        }
        
        market_data = {}
        for name, symbol in market_indices.items():
            try:
                ticker = yf.Ticker(symbol)
                info = ticker.info or {}
                price = info.get("regularMarketPrice") or info.get("currentPrice", 0)
                change = info.get("regularMarketChangePercent", 0)
                market_data[name] = {"price": price, "change": change}
            except Exception:
                market_data[name] = {"price": 0, "change": 0}
        
        # Display market pills in a frosted glass container with better spacing
        pills_html = (
            '<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); '
            'border:1px solid rgba(255,255,255,0.06); border-radius:12px; '
            'padding:2rem 1.5rem; margin:0 auto 3rem; max-width:900px;">'
            '<div style="display:flex; gap:1.25rem; justify-content:center; flex-wrap:wrap;">'
        )
        for name, data in market_data.items():
            price = data["price"]
            change = data["change"]
            color = "#10B981" if change >= 0 else "#EF4444"
            arrow = "â†‘" if change >= 0 else "â†“"
            pills_html += (
                f'<div style="background:rgba(11,14,26,0.6); border:1px solid rgba(255,255,255,0.04); '
                f'border-radius:10px; padding:0.9rem 1.4rem; min-width:150px; '
                f'transition:all 0.2s ease;">'
                f'<div style="font-size:0.7rem; color:#9CA3AF; font-weight:600; text-transform:uppercase; '
                f'letter-spacing:0.05em; margin-bottom:0.4rem;">{name}</div>'
                f'<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:0.3rem;">{price:,.2f}</div>'
                f'<div style="font-size:0.85rem; color:{color}; font-weight:600;">{arrow} {abs(change):.2f}%</div>'
                f'</div>'
            )
        pills_html += '</div></div>'
        st.markdown(pills_html, unsafe_allow_html=True)
    except Exception:
        pass
    
    # Quick Actions Grid
    st.markdown('<div style="text-align:center; font-size:1.25rem; font-weight:700; color:#F9FAFB; margin:3rem 0 1.5rem; '
               'letter-spacing:-0.02em;">Quick Actions</div>', unsafe_allow_html=True)
    
    # Add CSS for hover effects on Quick Actions
    st.markdown("""
    <style>
    .qa-card {
        background: rgba(17,24,39,0.7);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        cursor: pointer;
    }
    .qa-card:hover {
        transform: translateY(-4px) scale(1.02);
        border-color: rgba(37,99,235,0.3);
        box-shadow: 0 8px 32px rgba(37,99,235,0.25), 0 0 0 1px rgba(37,99,235,0.1);
    }
    .qa-card-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        transition: transform 0.3s ease;
    }
    .qa-card:hover .qa-card-icon {
        transform: scale(1.1);
    }
    </style>
    """, unsafe_allow_html=True)
    
    qa_col1, qa_col2, qa_col3, qa_col4 = st.columns(4)
    
    with qa_col1:
        st.markdown(
            '<div class="qa-card">'
            '<div class="qa-card-icon">ğŸ”</div>'
            '<div style="font-size:1rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;">Company Profile</div>'
            '<div style="font-size:0.75rem; color:#9CA3AF;">Deep dive into any public company</div>'
            '</div>',
            unsafe_allow_html=True,
        )
    
    with qa_col2:
        st.markdown(
            '<div class="qa-card">'
            '<div class="qa-card-icon">ğŸ“ˆ</div>'
            '<div style="font-size:1rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;">Comps Analysis</div>'
            '<div style="font-size:0.75rem; color:#9CA3AF;">Compare with industry peers</div>'
            '</div>',
            unsafe_allow_html=True,
        )
    
    with qa_col3:
        st.markdown(
            '<div class="qa-card">'
            '<div class="qa-card-icon">ğŸ’¹</div>'
            '<div style="font-size:1rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;">DCF Model</div>'
            '<div style="font-size:0.75rem; color:#9CA3AF;">Intrinsic value analysis</div>'
            '</div>',
            unsafe_allow_html=True,
        )
    
    with qa_col4:
        st.markdown(
            '<div class="qa-card">'
            '<div class="qa-card-icon">ğŸ¤</div>'
            '<div style="font-size:1rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;">M&A Simulator</div>'
            '<div style="font-size:0.75rem; color:#9CA3AF;">Model merger scenarios</div>'
            '</div>',
            unsafe_allow_html=True,
        )
    
    # Top Movers section (if we can fetch data)
    st.markdown('<div style="text-align:center; font-size:1.25rem; font-weight:700; color:#F9FAFB; margin:3rem 0 1.5rem; '
               'letter-spacing:-0.02em;">Top Movers</div>', unsafe_allow_html=True)
    
    # Add CSS for movers cards
    st.markdown("""
    <style>
    .movers-card {
        background: rgba(17,24,39,0.7);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .movers-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .movers-card-gainers:hover {
        border-color: rgba(16,185,129,0.3);
        box-shadow: 0 8px 24px rgba(16,185,129,0.15);
    }
    .movers-card-losers:hover {
        border-color: rgba(239,68,68,0.3);
        box-shadow: 0 8px 24px rgba(239,68,68,0.15);
    }
    </style>
    """, unsafe_allow_html=True)
    
    try:
        # Sample top gainers and losers
        movers_col1, movers_col2 = st.columns(2)
        
        with movers_col1:
            st.markdown(
                '<div class="movers-card movers-card-gainers">'
                '<div style="font-size:0.9rem; font-weight:700; color:#10B981; margin-bottom:1rem; '
                'text-transform:uppercase; letter-spacing:0.05em;">Gainers</div>'
                '<div style="font-size:0.75rem; color:#9CA3AF;">Market data updates in real-time</div>'
                '</div>',
                unsafe_allow_html=True,
            )
        
        with movers_col2:
            st.markdown(
                '<div class="movers-card movers-card-losers">'
                '<div style="font-size:0.9rem; font-weight:700; color:#EF4444; margin-bottom:1rem; '
                'text-transform:uppercase; letter-spacing:0.05em;">Losers</div>'
                '<div style="font-size:0.75rem; color:#9CA3AF;">Market data updates in real-time</div>'
                '</div>',
                unsafe_allow_html=True,
            )
    except Exception:
        pass
    
    # Clean, minimal footer
    st.markdown(
        '<div style="text-align:center; margin-top:4rem; padding:2rem 0; border-top:1px solid rgba(255,255,255,0.06);">'
        '<div style="font-size:0.75rem; color:#6B7280;">Powered by live market data Â· Built for M&A professionals</div>'
        '</div>',
        unsafe_allow_html=True,
    )

elif analysis_mode == "Comps Analysis" and comps_btn and comps_ticker_input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # COMPARABLE COMPANY ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Loading animation
    progress_placeholder = st.empty()
    status_placeholder = st.empty()
    
    def update_progress(pct, msg):
        progress_placeholder.progress(pct, text=msg)
    
    with st.spinner(f"ğŸ”­ Scanning the universe for {comps_ticker_input}... Finding comparable companies"):
        comps_analysis = run_comps_analysis(
            ticker=comps_ticker_input,
            max_peers=max_peers,
            include_saas=include_saas,
            progress_callback=update_progress
        )
    
    progress_placeholder.empty()
    status_placeholder.empty()
    
    if not comps_analysis.target_comps or not comps_analysis.target_comps.valid:
        st.error(f"ğŸ˜• Could not fetch data for **{comps_ticker_input}**. Please check the ticker symbol and try again.")
        st.info("ğŸ’¡ Make sure the ticker exists on Yahoo Finance (e.g., AAPL, CRM, SHOP.TO)", icon="ğŸ”§")
    elif not comps_analysis.peers:
        st.warning(f"ğŸ” No comparable companies found for **{comps_ticker_input}**. Try a larger-cap company or increase the number of peers in settings.")
    else:
        tc = comps_analysis.target_comps
        
        # Header
        st.markdown(
            f'<div style="text-align:center; padding:1.5rem 0;">'
            f'<div style="font-size:2.5rem; font-weight:800; color:#F9FAFB; margin-bottom:0.3rem;">'
            f'{tc.name}</div>'
            f'<div style="font-size:1rem; color:#9CA3AF;">'
            f'{tc.sector} Â· {tc.industry}</div>'
            f'</div>',
            unsafe_allow_html=True,
        )
        
        # Key metrics cards
        col1, col2, col3, col4 = st.columns(4)
        
        def format_num(x, prefix="$", suffix=""):
            if x is None or x == 0:
                return "â€”"
            if abs(x) >= 1e12:
                return f"{prefix}{x/1e12:.1f}T{suffix}"
            if abs(x) >= 1e9:
                return f"{prefix}{x/1e9:.1f}B{suffix}"
            if abs(x) >= 1e6:
                return f"{prefix}{x/1e6:.0f}M{suffix}"
            return f"{prefix}{x:,.0f}{suffix}"
        
        def format_mult(x):
            if x is None or x == 0:
                return "â€”"
            return f"{x:.1f}x"
        
        with col1:
            st.markdown(
                f'<div style="background:rgba(37,99,235,0.1); border:1px solid rgba(37,99,235,0.3); '
                f'border-radius:12px; padding:1rem; text-align:center;">'
                f'<div style="font-size:0.75rem; color:#9CA3AF; text-transform:uppercase;">Market Cap</div>'
                f'<div style="font-size:1.5rem; font-weight:700; color:#F9FAFB;">{format_num(tc.market_cap)}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        with col2:
            st.markdown(
                f'<div style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); '
                f'border-radius:12px; padding:1rem; text-align:center;">'
                f'<div style="font-size:0.75rem; color:#9CA3AF; text-transform:uppercase;">EV/EBITDA</div>'
                f'<div style="font-size:1.5rem; font-weight:700; color:#F9FAFB;">{format_mult(tc.ev_ebitda)}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        with col3:
            st.markdown(
                f'<div style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); '
                f'border-radius:12px; padding:1rem; text-align:center;">'
                f'<div style="font-size:0.75rem; color:#9CA3AF; text-transform:uppercase;">EV/Revenue</div>'
                f'<div style="font-size:1.5rem; font-weight:700; color:#F9FAFB;">{format_mult(tc.ev_revenue)}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        with col4:
            st.markdown(
                f'<div style="background:rgba(245,166,35,0.1); border:1px solid rgba(245,166,35,0.3); '
                f'border-radius:12px; padding:1rem; text-align:center;">'
                f'<div style="font-size:0.75rem; color:#9CA3AF; text-transform:uppercase;">P/E Ratio</div>'
                f'<div style="font-size:1.5rem; font-weight:700; color:#F9FAFB;">{format_mult(tc.pe_ratio)}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        st.markdown('<div style="height:1.5rem;"></div>', unsafe_allow_html=True)
        
        # Peer Median Comparison
        st.markdown(
            '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:1rem;">'
            'ğŸ“Š Valuation vs Peer Median</div>',
            unsafe_allow_html=True,
        )
        
        comp_col1, comp_col2, comp_col3 = st.columns(3)
        
        with comp_col1:
            target_val = tc.ev_ebitda or 0
            median_val = comps_analysis.median_ev_ebitda or 0
            if median_val > 0:
                diff_pct = ((target_val - median_val) / median_val) * 100
                diff_color = "#10B981" if diff_pct < 0 else "#EF4444"
                diff_text = f"{diff_pct:+.1f}%"
            else:
                diff_color = "#9CA3AF"
                diff_text = "â€”"
            st.markdown(
                f'<div style="background:rgba(255,255,255,0.03); border-radius:12px; padding:1rem;">'
                f'<div style="font-size:0.8rem; color:#9CA3AF;">EV/EBITDA vs Median</div>'
                f'<div style="font-size:1.3rem; font-weight:700; color:{diff_color};">{diff_text}</div>'
                f'<div style="font-size:0.7rem; color:#6B6B80;">Target: {format_mult(target_val)} Â· Median: {format_mult(median_val)}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        with comp_col2:
            target_val = tc.ev_revenue or 0
            median_val = comps_analysis.median_ev_revenue or 0
            if median_val > 0:
                diff_pct = ((target_val - median_val) / median_val) * 100
                diff_color = "#10B981" if diff_pct < 0 else "#EF4444"
                diff_text = f"{diff_pct:+.1f}%"
            else:
                diff_color = "#9CA3AF"
                diff_text = "â€”"
            st.markdown(
                f'<div style="background:rgba(255,255,255,0.03); border-radius:12px; padding:1rem;">'
                f'<div style="font-size:0.8rem; color:#9CA3AF;">EV/Revenue vs Median</div>'
                f'<div style="font-size:1.3rem; font-weight:700; color:{diff_color};">{diff_text}</div>'
                f'<div style="font-size:0.7rem; color:#6B6B80;">Target: {format_mult(target_val)} Â· Median: {format_mult(median_val)}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        with comp_col3:
            target_val = tc.pe_ratio or 0
            median_val = comps_analysis.median_pe or 0
            if median_val > 0:
                diff_pct = ((target_val - median_val) / median_val) * 100
                diff_color = "#10B981" if diff_pct < 0 else "#EF4444"
                diff_text = f"{diff_pct:+.1f}%"
            else:
                diff_color = "#9CA3AF"
                diff_text = "â€”"
            st.markdown(
                f'<div style="background:rgba(255,255,255,0.03); border-radius:12px; padding:1rem;">'
                f'<div style="font-size:0.8rem; color:#9CA3AF;">P/E vs Median</div>'
                f'<div style="font-size:1.3rem; font-weight:700; color:{diff_color};">{diff_text}</div>'
                f'<div style="font-size:0.7rem; color:#6B6B80;">Target: {format_mult(target_val)} Â· Median: {format_mult(median_val)}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        st.markdown('<div style="height:1.5rem;"></div>', unsafe_allow_html=True)
        
        # Implied Valuation
        if comps_analysis.implied_ev_from_ebitda or comps_analysis.implied_ev_from_revenue:
            st.markdown(
                '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:1rem;">'
                'ğŸ’° Implied Enterprise Value (at Peer Median Multiples)</div>',
                unsafe_allow_html=True,
            )
            
            iv_col1, iv_col2, iv_col3 = st.columns(3)
            
            with iv_col1:
                st.markdown(
                    f'<div style="background:rgba(37,99,235,0.1); border:1px solid rgba(37,99,235,0.3); '
                    f'border-radius:12px; padding:1rem; text-align:center;">'
                    f'<div style="font-size:0.75rem; color:#9CA3AF;">Current EV</div>'
                    f'<div style="font-size:1.3rem; font-weight:700; color:#F9FAFB;">{format_num(tc.enterprise_value)}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            
            with iv_col2:
                st.markdown(
                    f'<div style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); '
                    f'border-radius:12px; padding:1rem; text-align:center;">'
                    f'<div style="font-size:0.75rem; color:#9CA3AF;">Implied EV (EBITDA)</div>'
                    f'<div style="font-size:1.3rem; font-weight:700; color:#F9FAFB;">{format_num(comps_analysis.implied_ev_from_ebitda)}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            
            with iv_col3:
                st.markdown(
                    f'<div style="background:rgba(245,166,35,0.1); border:1px solid rgba(245,166,35,0.3); '
                    f'border-radius:12px; padding:1rem; text-align:center;">'
                    f'<div style="font-size:0.75rem; color:#9CA3AF;">Implied EV (Revenue)</div>'
                    f'<div style="font-size:1.3rem; font-weight:700; color:#F9FAFB;">{format_num(comps_analysis.implied_ev_from_revenue)}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
        
        # Implied Valuation Football Field
        try:
            ff_methods = []
            current_ev = tc.enterprise_value or 0
            
            if comps_analysis.implied_ev_from_ebitda and comps_analysis.implied_ev_from_ebitda > 0:
                ff_methods.append(("EV/EBITDA\n(Peer Median)", comps_analysis.implied_ev_from_ebitda))
            if comps_analysis.implied_ev_from_revenue and comps_analysis.implied_ev_from_revenue > 0:
                ff_methods.append(("EV/Revenue\n(Peer Median)", comps_analysis.implied_ev_from_revenue))
            
            # Add 25th/75th percentile valuations if we can calculate
            if comps_analysis.peers and tc.ev_ebitda:
                peer_ebitda_mults = [p.ev_ebitda for p in comps_analysis.peers if p.ev_ebitda and p.ev_ebitda > 0]
                if peer_ebitda_mults and tc.ev_ebitda > 0:
                    base_ebitda = current_ev / tc.ev_ebitda if tc.ev_ebitda > 0 else 0
                    if base_ebitda > 0:
                        p25 = np.percentile(peer_ebitda_mults, 25) * base_ebitda
                        p75 = np.percentile(peer_ebitda_mults, 75) * base_ebitda
                        ff_methods.append(("EV/EBITDA\n(25th pctile)", p25))
                        ff_methods.append(("EV/EBITDA\n(75th pctile)", p75))
            
            if len(ff_methods) >= 2:
                fig_ff = go.Figure()
                
                names = [m[0] for m in ff_methods]
                values = [m[1] for m in ff_methods]
                colors = ["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6"][:len(ff_methods)]
                
                fig_ff.add_trace(go.Bar(
                    y=names, x=values, orientation="h",
                    marker_color=colors,
                    text=[f"{n.replace(chr(10),' ')}: {format_num(v)}" for n, v in zip(names, values)],
                    textposition="outside",
                    textfont=dict(size=10, color="#D1D5DB"),
                ))
                
                # Current EV line
                if current_ev > 0:
                    fig_ff.add_vline(x=current_ev, line_dash="dash", line_color="#F59E0B", line_width=2)
                    fig_ff.add_annotation(
                        x=current_ev, y=names[0], text=f"Current EV: {format_num(current_ev)}",
                        showarrow=False, font=dict(size=9, color="#F59E0B"),
                        yshift=30,
                    )
                
                fig_ff.update_layout(
                    **_CHART_LAYOUT_BASE, height=250,
                    margin=dict(t=30, b=30, l=100, r=80),
                    xaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
                    yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                    showlegend=False,
                )
                _apply_space_grid(fig_ff)
                st.plotly_chart(fig_ff, use_container_width=True, key="comps_football_field")
        except Exception:
            pass
        
        st.markdown('<div style="height:1.5rem;"></div>', unsafe_allow_html=True)
        
        # Full Comps Table
        st.markdown(
            '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:1rem;">'
            f'ğŸ“‹ Comparable Companies ({len(comps_analysis.peers)} peers)</div>',
            unsafe_allow_html=True,
        )
        
        comps_df = generate_comps_table(comps_analysis)

        # Conditional formatting on raw numeric data before display formatting
        _val_cols = ["EV/Rev", "EV/EBITDA", "P/E"]

        def _comps_highlight(df_raw):
            """Apply green (cheapest) to red (most expensive) gradient on valuation cols."""
            styles = pd.DataFrame("", index=df_raw.index, columns=df_raw.columns)
            # Only style peer rows (skip target row 0, and summary rows at end)
            _peer_start = 1
            _peer_end = len(df_raw) - 2  # last 2 are median/mean
            for col in _val_cols:
                if col not in df_raw.columns:
                    continue
                vals = pd.to_numeric(df_raw[col].iloc[_peer_start:_peer_end], errors="coerce")
                if vals.dropna().empty:
                    continue
                _min, _max = vals.min(), vals.max()
                if _min == _max:
                    continue
                for i in range(_peer_start, _peer_end):
                    v = vals.get(i)
                    if pd.isna(v):
                        continue
                    # Normalize 0-1 (0=cheapest=green, 1=expensive=red)
                    pct = (v - _min) / (_max - _min)
                    if pct < 0.33:
                        styles.iloc[i, df_raw.columns.get_loc(col)] = "background-color: rgba(16,185,129,0.2)"
                    elif pct > 0.66:
                        styles.iloc[i, df_raw.columns.get_loc(col)] = "background-color: rgba(239,68,68,0.2)"
            # Bold summary rows
            for i in range(max(0, len(df_raw) - 2), len(df_raw)):
                styles.iloc[i] = ["font-weight:700; background-color: rgba(37,99,235,0.08)"] * len(df_raw.columns)
            return styles

        display_df = format_comps_for_display(comps_df)
        styled_comps = comps_df.style.apply(_comps_highlight, axis=None)

        # Format for display while keeping sort capability
        display_df = format_comps_for_display(comps_df)

        # Sort option
        _comps_sort_col = st.selectbox(
            "Sort by", ["Default", "EV/Rev â†‘", "EV/Rev â†“", "EV/EBITDA â†‘", "EV/EBITDA â†“",
                        "P/E â†‘", "P/E â†“", "Market Cap â†‘", "Market Cap â†“"],
            key="comps_sort_col", label_visibility="collapsed",
        )
        if _comps_sort_col != "Default":
            _sort_map = {
                "EV/Rev â†‘": ("EV/Rev", True), "EV/Rev â†“": ("EV/Rev", False),
                "EV/EBITDA â†‘": ("EV/EBITDA", True), "EV/EBITDA â†“": ("EV/EBITDA", False),
                "P/E â†‘": ("P/E", True), "P/E â†“": ("P/E", False),
                "Market Cap â†‘": ("Market Cap", True), "Market Cap â†“": ("Market Cap", False),
            }
            _scol, _sasc = _sort_map[_comps_sort_col]
            if _scol in comps_df.columns:
                # Separate target (row 0), peers, and summary rows (last 2)
                _target_row = comps_df.iloc[:1]
                _summary_rows = comps_df.iloc[-2:]
                _peer_rows = comps_df.iloc[1:-2].copy()
                _peer_rows["_sort_key"] = pd.to_numeric(_peer_rows[_scol], errors="coerce")
                _peer_rows = _peer_rows.sort_values("_sort_key", ascending=_sasc, na_position="last").drop(columns=["_sort_key"])
                comps_df = pd.concat([_target_row, _peer_rows, _summary_rows], ignore_index=True)
                display_df = format_comps_for_display(comps_df)

        # Re-apply highlight on potentially re-sorted data
        styled_comps = comps_df.style.apply(_comps_highlight, axis=None)
        # Apply display formatting on styled object
        def _fmt_m(x):
            if pd.isna(x) or x == 0: return "â€”"
            if abs(x) >= 1e12: return f"${x/1e12:.1f}T"
            if abs(x) >= 1e9: return f"${x/1e9:.1f}B"
            if abs(x) >= 1e6: return f"${x/1e6:.0f}M"
            return f"${x:,.0f}"
        def _fmt_x(x):
            if pd.isna(x) or x == 0: return "â€”"
            return f"{x:.1f}x"
        def _fmt_pct(x):
            if pd.isna(x): return "â€”"
            return f"{x*100:.1f}%"
        def _fmt_r40(x):
            if pd.isna(x): return "â€”"
            return f"{x:.0f}"
        _comps_formatters = {}
        for c in ["Market Cap", "EV", "Revenue", "EBITDA"]:
            if c in comps_df.columns: _comps_formatters[c] = _fmt_m
        for c in ["EV/Rev", "EV/EBITDA", "P/E"]:
            if c in comps_df.columns: _comps_formatters[c] = _fmt_x
        for c in ["Rev Growth", "EBITDA Margin"]:
            if c in comps_df.columns: _comps_formatters[c] = _fmt_pct
        if "Rule of 40" in comps_df.columns:
            _comps_formatters["Rule of 40"] = _fmt_r40
        styled_comps = styled_comps.format(_comps_formatters)

        st.dataframe(
            styled_comps,
            use_container_width=True,
            hide_index=True,
            column_config={
                "Company": st.column_config.TextColumn("Company", width="medium"),
                "Ticker": st.column_config.TextColumn("Ticker", width="small"),
                "Market Cap": st.column_config.TextColumn("Mkt Cap", width="small"),
                "EV": st.column_config.TextColumn("EV", width="small"),
                "Revenue": st.column_config.TextColumn("Revenue", width="small"),
                "EBITDA": st.column_config.TextColumn("EBITDA", width="small"),
                "EV/Rev": st.column_config.TextColumn("EV/Rev", width="small"),
                "EV/EBITDA": st.column_config.TextColumn("EV/EBITDA", width="small"),
                "P/E": st.column_config.TextColumn("P/E", width="small"),
                "Rev Growth": st.column_config.TextColumn("Growth", width="small"),
                "EBITDA Margin": st.column_config.TextColumn("Margin", width="small"),
                "Rule of 40": st.column_config.TextColumn("Ro40", width="small"),
            }
        )
        
        st.markdown(
            '<div style="font-size:0.7rem; color:#6B6B80; margin-top:0.5rem;">'
            'Note: Peers selected based on sector, industry, and market cap proximity. '
            'Multiples based on LTM financials from Yahoo Finance.</div>',
            unsafe_allow_html=True,
        )

        # â”€â”€ Outlier Flagging & Trimmed Mean â”€â”€
        with _safe_section("Comps Outlier Analysis"):
            st.markdown(
                '<div style="font-size:1rem; font-weight:700; color:#F9FAFB; margin:1rem 0 0.5rem 0;">'
                'âš ï¸ Outlier Detection & Trimmed Statistics</div>',
                unsafe_allow_html=True,
            )
            _outlier_cols = ["EV/Rev", "EV/EBITDA", "P/E"]
            _peer_start_idx = 1
            _peer_end_idx = len(comps_df) - 2  # exclude summary rows
            _outlier_report = []

            for _oc in _outlier_cols:
                if _oc not in comps_df.columns:
                    continue
                _vals = pd.to_numeric(comps_df[_oc].iloc[_peer_start_idx:_peer_end_idx], errors="coerce").dropna()
                if len(_vals) < 3:
                    continue
                _med = _vals.median()
                _std = _vals.std()
                _mean = _vals.mean()
                _flagged = []
                _clean_vals = []
                for _i in _vals.index:
                    _v = _vals[_i]
                    if abs(_v - _med) > 2 * _std:
                        _ticker_name = comps_df.iloc[_i].get("Ticker", comps_df.iloc[_i].get("Company", "?"))
                        _flagged.append(f"{_ticker_name} ({_v:.1f}x)")
                    else:
                        _clean_vals.append(_v)
                _trimmed_mean = np.mean(_clean_vals) if _clean_vals else _mean
                _outlier_report.append({
                    "metric": _oc, "mean": _mean, "median": _med, "std": _std,
                    "trimmed_mean": _trimmed_mean, "flagged": _flagged, "n_flagged": len(_flagged),
                })

            if _outlier_report:
                _out_html = '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem;">'
                for _or in _outlier_report:
                    _flag_html = ""
                    if _or["flagged"]:
                        _flag_html = f'<div style="font-size:0.65rem; color:#F59E0B; margin-top:0.3rem;">âš ï¸ Outliers: {", ".join(_or["flagged"])}</div>'
                    _out_html += (
                        f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
                        f'border-radius:10px; padding:0.8rem;">'
                        f'<div style="font-size:0.72rem; font-weight:700; color:#60A5FA;">{_or["metric"]}</div>'
                        f'<div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; margin-top:0.3rem; font-size:0.7rem;">'
                        f'<div style="color:#9CA3AF;">Mean: <b style="color:#F9FAFB;">{_or["mean"]:.1f}x</b></div>'
                        f'<div style="color:#9CA3AF;">Median: <b style="color:#F9FAFB;">{_or["median"]:.1f}x</b></div>'
                        f'<div style="color:#10B981;">Trimmed Mean: <b>{_or["trimmed_mean"]:.1f}x</b></div>'
                        f'<div style="color:#9CA3AF;">Std Dev: <b style="color:#F9FAFB;">{_or["std"]:.1f}x</b></div>'
                        f'</div>'
                        f'{_flag_html}</div>'
                    )
                _out_html += '</div>'
                st.markdown(_out_html, unsafe_allow_html=True)

        # â”€â”€ Export Comps Table â”€â”€
        try:
            _comps_excel = _export_comps_to_excel(comps_analysis)
            st.download_button(
                label=f"ğŸ“¥ Export Comps Table (.xlsx)",
                data=_comps_excel,
                file_name=f"{comps_ticker_input}_Comps_Analysis.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                key="export_comps_xlsx",
            )
        except Exception:
            pass

        # â”€â”€ Peer Intelligence Cards â”€â”€
        with _safe_section("Peer Intelligence Cards"):
            try:
                st.markdown(
                    '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin:1.5rem 0 1rem 0;">'
                    'ğŸƒ Peer Intelligence Cards</div>',
                    unsafe_allow_html=True,
                )
                # Calculate group medians for relative valuation
                _pic_ev_ebitda_vals = [p.ev_ebitda for p in comps_analysis.peers if p.ev_ebitda and p.ev_ebitda > 0]
                _pic_ev_rev_vals = [p.ev_revenue for p in comps_analysis.peers if p.ev_revenue and p.ev_revenue > 0]
                _pic_med_ebitda = np.median(_pic_ev_ebitda_vals) if _pic_ev_ebitda_vals else 0
                _pic_med_rev = np.median(_pic_ev_rev_vals) if _pic_ev_rev_vals else 0

                # Industry keywords for differentiators
                _pic_diff_map = {
                    "software": "Enterprise software platform",
                    "cloud": "Cloud-native infrastructure",
                    "semiconductor": "Chip design & fabrication",
                    "payment": "Payment processing network",
                    "bank": "Full-service banking",
                    "insurance": "Risk management & underwriting",
                    "pharma": "Drug discovery pipeline",
                    "biotech": "Biological therapeutics",
                    "retail": "Omnichannel retail distribution",
                    "media": "Content & advertising platform",
                    "auto": "Vehicle manufacturing & EV",
                    "energy": "Energy production & distribution",
                    "telecom": "Telecommunications infrastructure",
                    "health": "Healthcare services & solutions",
                }

                _pic_cols = st.columns(min(3, len(comps_analysis.peers)))
                for _pic_idx, _pic_peer in enumerate(comps_analysis.peers):
                    with _pic_cols[_pic_idx % len(_pic_cols)]:
                        # Relative valuation
                        _pic_prem = ""
                        _pic_prem_color = "#9CA3AF"
                        if _pic_peer.ev_ebitda and _pic_med_ebitda > 0:
                            _pic_prem_pct = ((_pic_peer.ev_ebitda - _pic_med_ebitda) / _pic_med_ebitda) * 100
                            if _pic_prem_pct > 5:
                                _pic_prem = f"+{_pic_prem_pct:.0f}% premium"
                                _pic_prem_color = "#EF4444"
                            elif _pic_prem_pct < -5:
                                _pic_prem = f"{_pic_prem_pct:.0f}% discount"
                                _pic_prem_color = "#10B981"
                            else:
                                _pic_prem = "At median"
                                _pic_prem_color = "#F59E0B"

                        # Key differentiator
                        _pic_diff = "Diversified operations"
                        _pic_ind = (_pic_peer.industry or "").lower()
                        for _dk, _dv in _pic_diff_map.items():
                            if _dk in _pic_ind:
                                _pic_diff = _dv
                                break

                        # 1-line description
                        _pic_desc = f"{_pic_peer.sector} Â· {_pic_peer.industry}" if _pic_peer.industry else _pic_peer.sector or "â€”"

                        # Logo placeholder (first letter)
                        _pic_initial = (_pic_peer.name or _pic_peer.ticker)[0].upper()

                        _pic_mcap_str = ""
                        if _pic_peer.market_cap and _pic_peer.market_cap > 0:
                            if _pic_peer.market_cap >= 1e12:
                                _pic_mcap_str = f"${_pic_peer.market_cap/1e12:.1f}T"
                            elif _pic_peer.market_cap >= 1e9:
                                _pic_mcap_str = f"${_pic_peer.market_cap/1e9:.1f}B"
                            else:
                                _pic_mcap_str = f"${_pic_peer.market_cap/1e6:.0f}M"

                        st.markdown(
                            f'<div style="background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border:1px solid rgba(37,99,235,0.15); '
                            f'border-radius:14px; padding:1.2rem; margin-bottom:0.8rem; position:relative; overflow:hidden;">'
                            f'<div style="display:flex; align-items:center; gap:0.7rem; margin-bottom:0.6rem;">'
                            f'<div style="width:38px; height:38px; border-radius:10px; background:linear-gradient(135deg, #2563EB, #10B981); '
                            f'display:flex; align-items:center; justify-content:center; font-weight:800; color:white; font-size:1rem;">{_pic_initial}</div>'
                            f'<div>'
                            f'<div style="font-size:0.85rem; font-weight:700; color:#F9FAFB;">{_pic_peer.name or _pic_peer.ticker}</div>'
                            f'<div style="font-size:0.65rem; color:#9CA3AF;">{_pic_peer.ticker} Â· {_pic_mcap_str}</div>'
                            f'</div></div>'
                            f'<div style="font-size:0.7rem; color:#D1D5DB; margin-bottom:0.4rem; line-height:1.4;">{_pic_desc}</div>'
                            f'<div style="font-size:0.68rem; color:#60A5FA; font-weight:600; margin-bottom:0.5rem;">ğŸ’¡ {_pic_diff}</div>'
                            f'<div style="display:flex; justify-content:space-between; align-items:center; '
                            f'padding-top:0.5rem; border-top:1px solid rgba(255,255,255,0.06);">'
                            f'<div style="font-size:0.68rem; color:#9CA3AF;">EV/EBITDA: {_pic_peer.ev_ebitda:.1f}x</div>'
                            f'<div style="font-size:0.72rem; font-weight:700; color:{_pic_prem_color};">{_pic_prem}</div>'
                            f'</div></div>',
                            unsafe_allow_html=True,
                        )
            except Exception:
                pass

        # â”€â”€ Comps Intelligence: Relative Value Map â”€â”€
        with _safe_section("Relative Value Map"):
            st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
            st.markdown(
                '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:1rem;">'
                'ğŸ—ºï¸ Relative Value Map</div>',
                unsafe_allow_html=True,
            )

            _rvm_data = []
            # Target
            if tc.ev_ebitda and tc.revenue_growth is not None and tc.market_cap:
                _rvm_data.append({
                    "ticker": tc.ticker, "ev_ebitda": tc.ev_ebitda,
                    "rev_growth": (tc.revenue_growth or 0) * 100,
                    "mcap": tc.market_cap, "is_target": True,
                })
            # Peers
            for p in comps_analysis.peers:
                if p.ev_ebitda and p.revenue_growth is not None and p.market_cap:
                    _rvm_data.append({
                        "ticker": p.ticker, "ev_ebitda": p.ev_ebitda,
                        "rev_growth": (p.revenue_growth or 0) * 100,
                        "mcap": p.market_cap, "is_target": False,
                    })

            if len(_rvm_data) >= 2:
                _rvm_df = pd.DataFrame(_rvm_data)
                _med_ev = _rvm_df["ev_ebitda"].median()
                _med_gr = _rvm_df["rev_growth"].median()
                _max_mcap = _rvm_df["mcap"].max()
                _rvm_df["bubble_size"] = (_rvm_df["mcap"] / _max_mcap * 40).clip(lower=8)

                fig_rvm = go.Figure()

                # Peers
                _peers = _rvm_df[~_rvm_df["is_target"]]
                fig_rvm.add_trace(go.Scatter(
                    x=_peers["ev_ebitda"], y=_peers["rev_growth"],
                    mode="markers+text", text=_peers["ticker"],
                    textposition="top center", textfont=dict(size=8, color="#9CA3AF"),
                    marker=dict(size=_peers["bubble_size"], color="rgba(37,99,235,0.6)",
                                line=dict(color="rgba(255,255,255,0.2)", width=1)),
                    name="Peers", hovertemplate="%{text}<br>EV/EBITDA: %{x:.1f}x<br>Rev Growth: %{y:.1f}%<extra></extra>",
                ))

                # Target
                _tgt = _rvm_df[_rvm_df["is_target"]]
                if len(_tgt) > 0:
                    fig_rvm.add_trace(go.Scatter(
                        x=_tgt["ev_ebitda"], y=_tgt["rev_growth"],
                        mode="markers+text", text=_tgt["ticker"],
                        textposition="top center", textfont=dict(size=10, color="#FFD700", family="Inter"),
                        marker=dict(size=_tgt["bubble_size"] * 1.3, color="rgba(16,185,129,0.8)",
                                    line=dict(color="#FFD700", width=2), symbol="star"),
                        name=tc.ticker, hovertemplate="%{text}<br>EV/EBITDA: %{x:.1f}x<br>Rev Growth: %{y:.1f}%<extra></extra>",
                    ))

                # Quadrant lines
                fig_rvm.add_hline(y=_med_gr, line_dash="dot", line_color="rgba(255,255,255,0.15)")
                fig_rvm.add_vline(x=_med_ev, line_dash="dot", line_color="rgba(255,255,255,0.15)")

                # Quadrant labels
                x_range = _rvm_df["ev_ebitda"]
                y_range = _rvm_df["rev_growth"]
                _quad_labels = [
                    (x_range.min(), y_range.max(), "Growth at<br>Reasonable Price", "bottom left"),
                    (x_range.max(), y_range.max(), "Expensive<br>Growth", "bottom right"),
                    (x_range.min(), y_range.min(), "Cheap for<br>a Reason", "top left"),
                    (x_range.max(), y_range.min(), "Value<br>Trap", "top right"),
                ]
                for qx, qy, qlabel, _anchor in _quad_labels:
                    fig_rvm.add_annotation(
                        x=qx, y=qy, text=qlabel, showarrow=False,
                        font=dict(size=8, color="rgba(184,179,215,0.4)"),
                        xanchor="left" if "left" in _anchor else "right",
                        yanchor="top" if "top" in _anchor else "bottom",
                    )

                fig_rvm.update_layout(
                    **_CHART_LAYOUT_BASE, height=450,
                    margin=dict(t=30, b=50, l=60, r=30),
                    xaxis=dict(title="EV/EBITDA", tickfont=dict(size=9, color="#9CA3AF"), ticksuffix="x"),
                    yaxis=dict(title="Revenue Growth %", tickfont=dict(size=9, color="#9CA3AF"), ticksuffix="%"),
                    showlegend=True,
                    legend=dict(orientation="h", yanchor="bottom", y=1.02, font=dict(size=9, color="#9CA3AF")),
                )
                _apply_space_grid(fig_rvm, show_x_grid=True)
                st.plotly_chart(fig_rvm, use_container_width=True, key="comps_relative_value_map")

                st.markdown(
                    '<div style="font-size:0.7rem; color:#6B6B80; margin-top:0.3rem;">'
                    'Bubble size = Market Cap. Star = Target company. Dashed lines = Peer medians.</div>',
                    unsafe_allow_html=True,
                )

        # â”€â”€ Comps Intelligence: Peer Percentile Dashboard â”€â”€
        with _safe_section("Peer Percentile Dashboard"):
            st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
            st.markdown(
                '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:1rem;">'
                'ğŸ“Š Peer Percentile Dashboard</div>',
                unsafe_allow_html=True,
            )

            _ppd_metrics = []

            def _ppd_add(name, target_val, peer_vals, lower_is_better=False):
                if target_val is not None:
                    valid = sorted([v for v in peer_vals if v is not None])
                    if valid:
                        pctile = sum(1 for v in valid if v < target_val) / len(valid) * 100
                        _ppd_metrics.append((name, target_val, pctile, lower_is_better))

            _ppd_add("P/E Ratio", tc.pe_ratio,
                      [p.pe_ratio for p in comps_analysis.peers if p.pe_ratio], lower_is_better=True)
            _ppd_add("EV/EBITDA", tc.ev_ebitda,
                      [p.ev_ebitda for p in comps_analysis.peers if p.ev_ebitda], lower_is_better=True)
            _ppd_add("Revenue Growth", (tc.revenue_growth or 0) * 100 if tc.revenue_growth is not None else None,
                      [(p.revenue_growth or 0) * 100 for p in comps_analysis.peers if p.revenue_growth is not None])
            _ppd_add("EBITDA Margin", (tc.ebitda_margin or 0) * 100 if tc.ebitda_margin is not None else None,
                      [(p.ebitda_margin or 0) * 100 for p in comps_analysis.peers if p.ebitda_margin is not None])
            _ppd_add("ROE", (tc.roe or 0) * 100 if tc.roe is not None else None,
                      [(p.roe or 0) * 100 for p in comps_analysis.peers if p.roe is not None])

            if _ppd_metrics:
                for metric_name, val, pctile, lower_better in _ppd_metrics:
                    # For lower_is_better: low percentile = green (cheap)
                    if lower_better:
                        bar_color = "#10B981" if pctile <= 40 else "#F59E0B" if pctile <= 70 else "#EF4444"
                        label = "Attractive" if pctile <= 40 else "Fair" if pctile <= 70 else "Expensive"
                    else:
                        bar_color = "#10B981" if pctile >= 60 else "#F59E0B" if pctile >= 30 else "#EF4444"
                        label = "Strong" if pctile >= 60 else "Average" if pctile >= 30 else "Weak"

                    val_str = f"{val:.1f}x" if metric_name in ("P/E Ratio", "EV/EBITDA") else f"{val:.1f}%"
                    st.markdown(
                        f'<div style="margin-bottom:0.8rem;">'
                        f'<div style="display:flex; justify-content:space-between; margin-bottom:0.3rem;">'
                        f'<span style="font-size:0.8rem; font-weight:600; color:#F9FAFB;">{metric_name}</span>'
                        f'<span style="font-size:0.75rem; color:{bar_color};">{val_str} Â· {label} ({pctile:.0f}th pctile)</span>'
                        f'</div>'
                        f'<div style="position:relative; background:rgba(255,255,255,0.05); border-radius:6px; height:12px; overflow:visible;">'
                        f'<div style="width:100%; height:100%; border-radius:6px; background:linear-gradient(90deg, #10B981 0%, #F59E0B 50%, #EF4444 100%); opacity:0.2;"></div>'
                        f'<div style="position:absolute; left:{pctile:.0f}%; top:-2px; width:4px; height:16px; '
                        f'background:{bar_color}; border-radius:2px; transform:translateX(-2px); '
                        f'box-shadow:0 0 6px {bar_color};"></div>'
                        f'</div></div>',
                        unsafe_allow_html=True,
                    )

        # â”€â”€ Enhanced: Implied Valuation Range (Football Field by Share Price) â”€â”€
        with _safe_section("Implied Valuation Range"):
            st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
            st.markdown(
                '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:1rem;">'
                'ğŸˆ Implied Share Price â€” Football Field</div>',
                unsafe_allow_html=True,
            )

            shares_out = tc.market_cap / tc.pe_ratio / (tc.net_income_ltm / tc.market_cap * tc.pe_ratio) if tc.pe_ratio and tc.pe_ratio > 0 and tc.net_income_ltm else None
            # Simpler: shares = market_cap / price_per_share. Use price_to_sales as proxy if available
            if tc.market_cap and tc.pe_ratio and tc.net_income_ltm and tc.net_income_ltm > 0:
                _eps = tc.net_income_ltm / (tc.market_cap / (tc.pe_ratio * (tc.net_income_ltm / tc.market_cap * tc.pe_ratio))) if tc.pe_ratio else 0
            # Actually: shares_outstanding = market_cap / (EV/Revenue * Revenue / EV * market_cap)... let's just derive from PE
            # Current price = market_cap / shares => shares = market_cap / current_price
            # We don't have current_price in CompanyComps directly, but we can infer:
            # P/E = price / EPS => price = P/E * EPS; EPS = net_income / shares => price = P/E * net_income / shares
            # market_cap = price * shares = P/E * net_income => shares = market_cap / (P/E * EPS) = market_cap^2 / (P/E * net_income * market_cap)
            # Simpler: if we have P/S = price/sales_per_share, then price = P/S * revenue / shares
            # Let's try to get current price from yfinance for the target
            _target_price = None
            _target_shares = None
            try:
                _tk_comps = yf.Ticker(tc.ticker)
                _tk_info = _tk_comps.info or {}
                _target_price = _tk_info.get("currentPrice") or _tk_info.get("regularMarketPrice")
                _target_shares = _tk_info.get("sharesOutstanding")
                if not _target_shares and _target_price and _target_price > 0:
                    _target_shares = tc.market_cap / _target_price
            except Exception:
                pass

            if _target_price and _target_shares and _target_shares > 0:
                ff_price_data = {}
                _net_debt = (tc.enterprise_value - tc.market_cap) if tc.enterprise_value and tc.market_cap else 0

                # P/E implied
                if comps_analysis.median_pe and tc.net_income_ltm and tc.net_income_ltm > 0:
                    _pe_vals = [p.pe_ratio for p in comps_analysis.peers if p.pe_ratio and p.pe_ratio > 0]
                    if _pe_vals:
                        _eps = tc.net_income_ltm / _target_shares
                        _low = np.percentile(_pe_vals, 25) * _eps
                        _high = np.percentile(_pe_vals, 75) * _eps
                        _med = comps_analysis.median_pe * _eps
                        if _low > 0 and _high > 0:
                            ff_price_data["P/E"] = {"low": _low, "high": _high, "mid": _med}

                # EV/EBITDA implied
                if comps_analysis.median_ev_ebitda and tc.ebitda_ltm and tc.ebitda_ltm > 0:
                    _ev_ebitda_vals = [p.ev_ebitda for p in comps_analysis.peers if p.ev_ebitda and p.ev_ebitda > 0]
                    if _ev_ebitda_vals:
                        _low_ev = np.percentile(_ev_ebitda_vals, 25) * tc.ebitda_ltm
                        _high_ev = np.percentile(_ev_ebitda_vals, 75) * tc.ebitda_ltm
                        _med_ev = comps_analysis.median_ev_ebitda * tc.ebitda_ltm
                        _low_p = (_low_ev - _net_debt) / _target_shares
                        _high_p = (_high_ev - _net_debt) / _target_shares
                        _med_p = (_med_ev - _net_debt) / _target_shares
                        if _low_p > 0 and _high_p > 0:
                            ff_price_data["EV/EBITDA"] = {"low": _low_p, "high": _high_p, "mid": _med_p}

                # EV/Revenue implied
                if comps_analysis.median_ev_revenue and tc.revenue_ltm and tc.revenue_ltm > 0:
                    _ev_rev_vals = [p.ev_revenue for p in comps_analysis.peers if p.ev_revenue and p.ev_revenue > 0]
                    if _ev_rev_vals:
                        _low_ev = np.percentile(_ev_rev_vals, 25) * tc.revenue_ltm
                        _high_ev = np.percentile(_ev_rev_vals, 75) * tc.revenue_ltm
                        _med_ev = comps_analysis.median_ev_revenue * tc.revenue_ltm
                        _low_p = (_low_ev - _net_debt) / _target_shares
                        _high_p = (_high_ev - _net_debt) / _target_shares
                        _med_p = (_med_ev - _net_debt) / _target_shares
                        if _low_p > 0 and _high_p > 0:
                            ff_price_data["EV/Revenue"] = {"low": _low_p, "high": _high_p, "mid": _med_p}

                # P/S implied
                _ps_vals = [p.price_to_sales for p in comps_analysis.peers if p.price_to_sales and p.price_to_sales > 0]
                if _ps_vals and tc.revenue_ltm and tc.revenue_ltm > 0:
                    _rev_per_share = tc.revenue_ltm / _target_shares
                    _low = np.percentile(_ps_vals, 25) * _rev_per_share
                    _high = np.percentile(_ps_vals, 75) * _rev_per_share
                    _med = np.median(_ps_vals) * _rev_per_share
                    if _low > 0 and _high > 0:
                        ff_price_data["P/S"] = {"low": _low, "high": _high, "mid": _med}

                if ff_price_data:
                    fig_ff2 = go.Figure()
                    labels = list(ff_price_data.keys())
                    colors_ff = ["#2563EB", "#10B981", "#10B981", "#F5A623"]

                    for i, label in enumerate(labels):
                        d = ff_price_data[label]
                        fig_ff2.add_trace(go.Bar(
                            y=[label], x=[d["high"] - d["low"]],
                            base=[d["low"]], orientation="h",
                            marker=dict(color=colors_ff[i % len(colors_ff)], opacity=0.85,
                                        line=dict(color="rgba(255,255,255,0.15)", width=1)),
                            name=label,
                            text=[f"${d['low']:,.0f} â€” ${d['high']:,.0f}"],
                            textposition="inside",
                            textfont=dict(size=9, color="#fff"),
                            showlegend=False,
                        ))
                        # Median marker
                        fig_ff2.add_trace(go.Scatter(
                            x=[d["mid"]], y=[label], mode="markers",
                            marker=dict(color="#fff", size=8, symbol="diamond",
                                        line=dict(color=colors_ff[i % len(colors_ff)], width=2)),
                            showlegend=False, hovertext=f"Median: ${d['mid']:,.0f}",
                        ))

                    # Current price line
                    fig_ff2.add_vline(x=_target_price, line_dash="dash", line_color="#F59E0B", line_width=2)
                    fig_ff2.add_annotation(
                        x=_target_price, y=labels[0], text=f"Current: ${_target_price:,.2f}",
                        showarrow=False, font=dict(size=9, color="#F59E0B"), yshift=25,
                    )

                    fig_ff2.update_layout(
                        **_CHART_LAYOUT_BASE, height=250,
                        margin=dict(t=30, b=30, l=80, r=60),
                        xaxis=dict(tickprefix="$", tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
                        yaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                        showlegend=False, barmode="stack",
                    )
                    _apply_space_grid(fig_ff2, show_x_grid=True)
                    st.plotly_chart(fig_ff2, use_container_width=True, key="comps_implied_price_ff")

                    st.markdown(
                        '<div style="font-size:0.7rem; color:#6B6B80; margin-top:0.3rem;">'
                        'Range = 25thâ€“75th percentile of peer multiples applied to target financials. '
                        'Diamond = peer median implied price.</div>',
                        unsafe_allow_html=True,
                    )

        # â”€â”€ Enhanced: Percentile Ranking Within Peer Group â”€â”€
        with _safe_section("Percentile Ranking"):
            st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
            st.markdown(
                '<div style="font-size:1.2rem; font-weight:700; color:#F9FAFB; margin-bottom:1rem;">'
                'ğŸ“Š Percentile Ranking vs Peers</div>',
                unsafe_allow_html=True,
            )

            _pctile_metrics = {}
            def _calc_pctile(metric_name, target_val, peer_vals):
                if target_val is not None and peer_vals:
                    valid = [v for v in peer_vals if v is not None]
                    if valid:
                        pctile = sum(1 for v in valid if v < target_val) / len(valid) * 100
                        _pctile_metrics[metric_name] = pctile

            _calc_pctile("EV/Revenue", tc.ev_revenue, [p.ev_revenue for p in comps_analysis.peers if p.ev_revenue])
            _calc_pctile("EV/EBITDA", tc.ev_ebitda, [p.ev_ebitda for p in comps_analysis.peers if p.ev_ebitda])
            _calc_pctile("P/E Ratio", tc.pe_ratio, [p.pe_ratio for p in comps_analysis.peers if p.pe_ratio])
            _calc_pctile("Revenue Growth", tc.revenue_growth, [p.revenue_growth for p in comps_analysis.peers if p.revenue_growth is not None])
            _calc_pctile("Gross Margin", tc.gross_margin, [p.gross_margin for p in comps_analysis.peers if p.gross_margin is not None])
            _calc_pctile("EBITDA Margin", tc.ebitda_margin, [p.ebitda_margin for p in comps_analysis.peers if p.ebitda_margin is not None])
            _calc_pctile("Net Margin", tc.net_margin, [p.net_margin for p in comps_analysis.peers if p.net_margin is not None])

            if _pctile_metrics:
                for metric_name, pctile in _pctile_metrics.items():
                    bar_color = "#10B981" if pctile >= 50 else "#F59E0B" if pctile >= 25 else "#EF4444"
                    # For valuation multiples, lower percentile is better (cheaper)
                    if metric_name in ("EV/Revenue", "EV/EBITDA", "P/E Ratio"):
                        bar_color = "#10B981" if pctile <= 50 else "#F59E0B" if pctile <= 75 else "#EF4444"
                    st.markdown(
                        f'<div style="margin-bottom:0.6rem;">'
                        f'<div style="display:flex; justify-content:space-between; margin-bottom:0.2rem;">'
                        f'<span style="font-size:0.75rem; color:#D1D5DB;">{metric_name}</span>'
                        f'<span style="font-size:0.75rem; font-weight:700; color:{bar_color};">{pctile:.0f}th percentile</span>'
                        f'</div>'
                        f'<div style="background:rgba(255,255,255,0.05); border-radius:4px; height:8px; overflow:hidden;">'
                        f'<div style="width:{pctile:.0f}%; height:100%; background:{bar_color}; border-radius:4px;"></div>'
                        f'</div></div>',
                        unsafe_allow_html=True,
                    )

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # AI PEER ANALYSIS NARRATIVE
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        with _safe_section("AI Peer Analysis"):
            _peer_key = f"ai_peer_{tc.ticker}"
            if st.button("ğŸ¤– Generate AI Peer Analysis", key="gen_ai_peer", use_container_width=True):
                with st.spinner("Analyzing peers..."):
                    _peer_narrative = None
                    try:
                        import os as _os_peer
                        if _os_peer.environ.get("OPENROUTER_API_KEY") or _os_peer.environ.get("OPENAI_API_KEY"):
                            from ai_insights import _call_llm
                            _peer_data_lines = []
                            for _p in comps_analysis.peers[:8]:
                                _peer_data_lines.append(
                                    f"- {_p.ticker} ({_p.name}): Mkt Cap {format_num(_p.market_cap)}, "
                                    f"EV/EBITDA {_p.ev_ebitda or 'N/A':.1f}x, P/E {_p.pe_ratio or 'N/A'}, "
                                    f"Rev Growth {(_p.revenue_growth or 0)*100:.1f}%, "
                                    f"Gross Margin {(_p.gross_margin or 0)*100:.1f}%, "
                                    f"EBITDA Margin {(_p.ebitda_margin or 0)*100:.1f}%"
                                )
                            _peer_prompt = f"""Compare {tc.name} ({tc.ticker}) against its peer group. Write a 4-paragraph narrative:
1. How {tc.ticker} compares on valuation (EV/EBITDA, P/E) - is it cheap or expensive vs peers?
2. Growth comparison - who's growing faster and why it matters
3. Profitability comparison - margin advantages/disadvantages
4. Overall relative value conclusion - is {tc.ticker} attractively positioned?

Target: {tc.ticker} ({tc.name}): EV/EBITDA {tc.ev_ebitda or 'N/A'}, P/E {tc.pe_ratio or 'N/A'}, Rev Growth {(tc.revenue_growth or 0)*100:.1f}%, Gross Margin {(tc.gross_margin or 0)*100:.1f}%, EBITDA Margin {(tc.ebitda_margin or 0)*100:.1f}%

Peers:
{chr(10).join(_peer_data_lines)}

Be specific with numbers. Keep it concise."""
                            _peer_narrative = _call_llm(_peer_prompt, max_tokens=1200)
                    except Exception:
                        _peer_narrative = None

                    if not _peer_narrative:
                        # Rule-based narrative
                        _pr_peers = [p for p in comps_analysis.peers if p.ev_ebitda]
                        _pr_avg_ev = sum(p.ev_ebitda for p in _pr_peers) / len(_pr_peers) if _pr_peers else 0
                        _pr_pe_peers = [p for p in comps_analysis.peers if p.pe_ratio and p.pe_ratio > 0]
                        _pr_avg_pe = sum(p.pe_ratio for p in _pr_pe_peers) / len(_pr_pe_peers) if _pr_pe_peers else 0
                        _pr_gm_peers = [p for p in comps_analysis.peers if p.gross_margin is not None]
                        _pr_avg_gm = sum(p.gross_margin for p in _pr_gm_peers) / len(_pr_gm_peers) * 100 if _pr_gm_peers else 0
                        _pr_rg_peers = [p for p in comps_analysis.peers if p.revenue_growth is not None]
                        _pr_avg_rg = sum(p.revenue_growth for p in _pr_rg_peers) / len(_pr_rg_peers) * 100 if _pr_rg_peers else 0

                        _tc_ev = tc.ev_ebitda or 0
                        _tc_pe = tc.pe_ratio or 0
                        _tc_gm = (tc.gross_margin or 0) * 100
                        _tc_rg = (tc.revenue_growth or 0) * 100

                        _val_comp = "at a premium to" if _tc_ev > _pr_avg_ev * 1.1 else "at a discount to" if _tc_ev < _pr_avg_ev * 0.9 else "in line with"
                        _growth_comp = "outpacing" if _tc_rg > _pr_avg_rg * 1.1 else "lagging" if _tc_rg < _pr_avg_rg * 0.9 else "tracking"
                        _margin_comp = "superior" if _tc_gm > _pr_avg_gm * 1.1 else "inferior" if _tc_gm < _pr_avg_gm * 0.9 else "comparable"

                        _peer_narrative = f"""**Valuation:** {tc.name} trades at {_tc_ev:.1f}x EV/EBITDA and {_tc_pe:.1f}x P/E, {_val_comp} the peer median of {_pr_avg_ev:.1f}x EV/EBITDA and {_pr_avg_pe:.1f}x P/E. {'The premium may be justified by superior growth or margins.' if _val_comp == 'at a premium to' else 'The discount may present an opportunity if fundamentals are intact.' if _val_comp == 'at a discount to' else 'Valuation is roughly in line with comparable companies.'}

**Growth:** Revenue growth of {_tc_rg:.1f}% is {_growth_comp} the peer average of {_pr_avg_rg:.1f}%. {'This faster growth trajectory supports a premium valuation.' if _growth_comp == 'outpacing' else 'Slower growth relative to peers may warrant a valuation discount.' if _growth_comp == 'lagging' else 'Growth is tracking the peer group average.'}

**Profitability:** Gross margins of {_tc_gm:.1f}% are {_margin_comp} to the peer average of {_pr_avg_gm:.1f}%. {'Higher margins indicate pricing power or cost advantages that enhance earnings quality.' if _margin_comp == 'superior' else 'Lower margins suggest competitive pressure or a different business model mix.' if _margin_comp == 'inferior' else 'Margin profile is consistent with the peer group.'}

**Relative Value:** {'**Attractively positioned** â€” {}'.format(tc.name) + ' combines competitive growth and margins at a reasonable valuation relative to peers.' if (_val_comp != 'at a premium to' and _growth_comp != 'lagging') else '**Fairly valued** â€” ' + tc.name + ' is priced appropriately given its growth and margin profile relative to peers.' if _val_comp == 'in line with' else '**Premium valuation** â€” ' + tc.name + ' commands a higher multiple which requires continued execution on growth and margins to sustain.'}"""

                    st.session_state[_peer_key] = _peer_narrative

            if _peer_key in st.session_state:
                st.markdown(
                    f'<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
                    f'border-radius:12px; padding:1.2rem; margin-top:0.5rem;">'
                    f'<div style="font-size:0.65rem; color:#9CA3AF; margin-bottom:0.5rem;">ğŸ¤– AI-GENERATED ANALYSIS â€” NOT FINANCIAL ADVICE</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
                st.markdown(st.session_state[_peer_key])

elif analysis_mode == "Comps Analysis" and comps_btn and not comps_ticker_input:
    st.warning("âš ï¸ Please enter a ticker symbol in the sidebar to run comparable company analysis.")

elif analysis_mode == "Merger Analysis" and merger_btn and acquirer_input and target_input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # MERGER ANALYSIS DASHBOARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # â”€â”€ Mission Control animated loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    mission = st.empty()
    acq_label = acquirer_input.upper()
    tgt_label = target_input.upper()

    # Phase 0 â†’ fetch acquirer
    mission.markdown(_render_mission_control(acq_label, tgt_label, 0), unsafe_allow_html=True)
    try:
        acq_cd = fetch_company_data(acquirer_input)
    except Exception as e:
        mission.empty()
        st.error(f"ğŸ˜• Failed to fetch data for acquirer **{acquirer_input}**: {e}")
        st.info("ğŸ’¡ Check the ticker symbol and your internet connection. Try a different acquirer.", icon="ğŸ”§")
        st.stop()

    # Ensure acquirer has shares_outstanding (calculate from market_cap/price if needed)
    if not acq_cd.shares_outstanding:
        if acq_cd.market_cap and acq_cd.current_price and acq_cd.current_price > 0:
            acq_cd.shares_outstanding = acq_cd.market_cap / acq_cd.current_price
        elif acq_cd.enterprise_value and acq_cd.current_price and acq_cd.current_price > 0:
            # Rough estimate from EV
            acq_cd.shares_outstanding = acq_cd.enterprise_value / acq_cd.current_price
    if not acq_cd.shares_outstanding:
        mission.empty()
        st.error(f"ğŸ˜• Unable to determine shares outstanding for **{acquirer_input}**. This company may not have sufficient financial data for merger analysis.")
        st.info("ğŸ’¡ Try a publicly traded company with available market cap data.", icon="ğŸ”§")
        st.stop()

    # Phase 1 â†’ fetch target (with rate limit delay)
    mission.markdown(_render_mission_control(acq_label, tgt_label, 1), unsafe_allow_html=True)
    time.sleep(1)
    try:
        tgt_cd = fetch_company_data(target_input)
    except Exception as e:
        mission.empty()
        st.error(f"ğŸ˜• Failed to fetch data for target **{target_input}**: {e}")
        st.info("ğŸ’¡ Check the ticker symbol and your internet connection. Try a different target.", icon="ğŸ”§")
        st.stop()

    # Ensure target has shares_outstanding (calculate from market_cap/price if needed)
    if not tgt_cd.shares_outstanding:
        if tgt_cd.market_cap and tgt_cd.current_price and tgt_cd.current_price > 0:
            tgt_cd.shares_outstanding = tgt_cd.market_cap / tgt_cd.current_price
        elif tgt_cd.enterprise_value and tgt_cd.current_price and tgt_cd.current_price > 0:
            tgt_cd.shares_outstanding = tgt_cd.enterprise_value / tgt_cd.current_price
    if not tgt_cd.shares_outstanding:
        mission.empty()
        st.error(f"ğŸ˜• Unable to determine shares outstanding for **{target_input}**. This company may not have sufficient financial data for merger analysis.")
        st.info("ğŸ’¡ Try a publicly traded company with available market cap data.", icon="ğŸ”§")
        st.stop()

    # Phase 2 â†’ fetch peers
    mission.markdown(_render_mission_control(acq_label, tgt_label, 2), unsafe_allow_html=True)
    try:
        tgt_cd = fetch_peer_data(tgt_cd)
    except Exception:
        pass

    # Phase 3 â†’ compute pro forma + precedent transactions
    mission.markdown(_render_mission_control(acq_label, tgt_label, 3), unsafe_allow_html=True)
    try:
        pro_forma = calculate_pro_forma(acq_cd, tgt_cd, merger_assumptions)
    except Exception as e:
        mission.empty()
        st.error(f"ğŸ˜• Failed to calculate pro forma: {e}. Try different companies or check that both have complete financial data.")
        import traceback
        st.code(traceback.format_exc())
        st.stop()

    # Fetch precedent transactions
    precedent = None
    try:
        from precedent_deals import fetch_precedent_transactions
        precedent = fetch_precedent_transactions(
            target_input, getattr(tgt_cd, "cik", ""), tgt_cd.sector
        )
    except Exception as e:
        print(f"Precedent transactions fetch failed: {e}")

    try:
        pro_forma.football_field = build_football_field(acq_cd, tgt_cd, pro_forma, precedent)
    except Exception as e:
        st.warning(f"Football field build failed: {e}")
        pro_forma.football_field = {}

    # Phase 4 â†’ generate insights
    mission.markdown(_render_mission_control(acq_label, tgt_label, 4), unsafe_allow_html=True)
    try:
        merger_insights = generate_merger_insights(acq_cd, tgt_cd, pro_forma, merger_assumptions)
    except Exception as e:
        st.warning(f"Merger insights generation failed: {e}")
        from ai_insights import MergerInsights
        merger_insights = MergerInsights()

    # Phase 5 â†’ mission complete, rocket launches
    mission.markdown(_render_mission_control(acq_label, tgt_label, 5), unsafe_allow_html=True)
    time.sleep(1.5)
    mission.empty()

    acq_cs = acq_cd.currency_symbol
    tgt_cs = tgt_cd.currency_symbol

    # â”€â”€ Warnings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for warn in pro_forma.warnings:
        st.warning(warn)

    # Helper: escape $ to prevent Streamlit LaTeX rendering in markdown
    def _mhtml(html_str):
        """Render HTML via st.markdown with $ escaped to prevent LaTeX."""
        st.markdown(html_str.replace("$", "&#36;"), unsafe_allow_html=True)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M1. DEAL HEADER
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    acq_logo = ""
    if acq_cd.logo_url:
        _ald = getattr(acq_cd, 'logo_domain', '')
        acq_fallback = f"this.onerror=null; this.src='https://logo.clearbit.com/{_ald}';" if _ald else "this.style.display='none';"
        acq_logo = (
            f'<img src="{acq_cd.logo_url}" '
            f'style="width:48px; height:48px; border-radius:10px; object-fit:contain; '
            f'background:white; padding:4px;" onerror="{acq_fallback}">'
        )
    tgt_logo = ""
    if tgt_cd.logo_url:
        _tld = getattr(tgt_cd, 'logo_domain', '')
        tgt_fallback = f"this.onerror=null; this.src='https://logo.clearbit.com/{_tld}';" if _tld else "this.style.display='none';"
        tgt_logo = (
            f'<img src="{tgt_cd.logo_url}" '
            f'style="width:48px; height:48px; border-radius:10px; object-fit:contain; '
            f'background:white; padding:4px;" onerror="{tgt_fallback}">'
        )

    st.markdown(
        f'<div class="company-card">'
        f'<div style="display:flex; align-items:center; gap:1.2rem; position:relative;">'
        f'{acq_logo}'
        f'<div>'
        f'<p class="company-name" style="font-size:1.5rem;">{acq_cd.name}</p>'
        f'<p class="company-meta"><span>{acq_cd.ticker}</span> &middot; {acq_cd.sector}</p>'
        f'</div>'
        f'<div style="font-size:2rem; font-weight:300; color:#2563EB; margin:0 1rem;">+</div>'
        f'{tgt_logo}'
        f'<div>'
        f'<p class="company-name" style="font-size:1.5rem;">{tgt_cd.name}</p>'
        f'<p class="company-meta"><span>{tgt_cd.ticker}</span> &middot; {tgt_cd.sector}</p>'
        f'</div>'
        f'</div>'
        f'</div>',
        unsafe_allow_html=True,
    )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M2. COMPANY COMPARISON
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Company Comparison")

    cc1, cc2, cc3, cc4, cc5, cc6 = st.columns(6)
    cc1.metric(f"{acq_cd.ticker} Mkt Cap", format_number(acq_cd.market_cap, currency_symbol=acq_cs))
    cc2.metric(f"{tgt_cd.ticker} Mkt Cap", format_number(tgt_cd.market_cap, currency_symbol=tgt_cs))
    cc3.metric(f"{acq_cd.ticker} Revenue", format_number(pro_forma.acq_revenue, currency_symbol=acq_cs))
    cc4.metric(f"{tgt_cd.ticker} Revenue", format_number(pro_forma.tgt_revenue, currency_symbol=tgt_cs))
    cc5.metric(f"{acq_cd.ticker} EBITDA", format_number(pro_forma.acq_ebitda, currency_symbol=acq_cs))
    cc6.metric(f"{tgt_cd.ticker} EBITDA", format_number(pro_forma.tgt_ebitda, currency_symbol=tgt_cs))

    # Company comparison bars
    _mhtml('<div class="merger-chart-wrapper">')
    _build_company_comparison_bars(acq_cd, tgt_cd)
    _mhtml('</div>')

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M3. DEAL TERMS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Deal Terms")

    dt1, dt2, dt3, dt4, dt5 = st.columns(5)
    dt1.metric("Purchase Price", format_number(pro_forma.purchase_price, currency_symbol=acq_cs))
    dt2.metric("Offer Premium", f"{merger_assumptions.offer_premium_pct:.0f}%")
    dt3.metric("Implied EV/EBITDA", f"{pro_forma.implied_ev_ebitda:.1f}x" if pro_forma.implied_ev_ebitda else "N/A")
    dt4.metric("Implied P/E", f"{pro_forma.implied_pe:.1f}x" if pro_forma.implied_pe else "N/A")
    dt5.metric("Transaction Fees", format_number(pro_forma.transaction_fees, currency_symbol=acq_cs))

    # Deal structure donut + enhanced consideration detail
    deal_col1, deal_col2 = st.columns([2, 3])
    with deal_col1:
        _build_deal_structure_donut(merger_assumptions)
    with deal_col2:
        cash_pct = merger_assumptions.pct_cash
        stock_pct = 100 - cash_pct
        premium_pct = ((pro_forma.offer_price_per_share / tgt_cd.current_price) - 1) * 100 if tgt_cd.current_price else 0
        _mhtml(
            f'<div class="deal-consideration-card">'
            f'<div class="deal-header"><span class="deal-header-icon">ğŸ’°</span> Consideration Structure</div>'
            f'<div class="deal-consideration-row cash" style="animation-delay:0.1s;">'
            f'<div><div class="deal-label"><span class="emoji">ğŸ’µ</span> Cash Component</div>'
            f'<div class="deal-sub">Debt-funded â€¢ {cash_pct:.0f}% of deal</div></div>'
            f'<div class="deal-value">{format_number(pro_forma.cash_consideration, currency_symbol=acq_cs)}</div>'
            f'</div>'
            f'<div class="deal-consideration-row stock" style="animation-delay:0.2s;">'
            f'<div><div class="deal-label"><span class="emoji">ğŸ“ˆ</span> Stock Component</div>'
            f'<div class="deal-sub">{pro_forma.new_shares_issued / 1e6:,.1f}M shares @ {acq_cs}{acq_cd.current_price:,.2f} â€¢ {stock_pct:.0f}% of deal</div></div>'
            f'<div class="deal-value">{format_number(pro_forma.stock_consideration, currency_symbol=acq_cs)}</div>'
            f'</div>'
            f'<div class="deal-consideration-row offer" style="animation-delay:0.3s;">'
            f'<div><div class="deal-label"><span class="emoji">ğŸ¯</span> Offer Price</div>'
            f'<div class="deal-sub">+{premium_pct:.1f}% premium vs. current {tgt_cs}{tgt_cd.current_price:,.2f}</div></div>'
            f'<div class="deal-value">{acq_cs}{pro_forma.offer_price_per_share:,.2f}</div>'
            f'</div>'
            f'</div>'
        )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M3a-NEW. SOURCES & USES TABLE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Sources & Uses"):
        _section("Sources & Uses", "ğŸ¦")
        st.markdown(
            '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
            'Standard M&A sources & uses of funds breakdown.</div>',
            unsafe_allow_html=True,
        )
        _su_purchase = pro_forma.purchase_price or 0
        _su_fees = pro_forma.transaction_fees or 0
        _su_total_uses = _su_purchase + _su_fees
        _su_cash = pro_forma.cash_consideration or 0
        _su_new_debt = _su_cash  # cash portion funded by new debt
        _su_stock = pro_forma.stock_consideration or 0
        _su_total_sources = _su_new_debt + _su_stock

        _su_table = (
            '<div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">'
            '<div>'
            '<div style="font-size:0.75rem; font-weight:700; color:#10B981; text-transform:uppercase; '
            'letter-spacing:1px; border-bottom:2px solid #10B981; padding-bottom:0.3rem; margin-bottom:0.5rem;">Sources</div>'
        )
        _su_sources = [
            ("New Debt / Cash on Hand", _su_new_debt),
            ("New Equity (Stock Issued)", _su_stock),
        ]
        for _sl, _sv in _su_sources:
            _su_table += (
                f'<div style="display:flex; justify-content:space-between; padding:0.35rem 0; '
                f'border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.78rem;">'
                f'<span style="color:#D1D5DB;">{_sl}</span>'
                f'<span style="color:#F9FAFB; font-weight:600;">{format_number(_sv, currency_symbol=acq_cs)}</span>'
                f'</div>'
            )
        _su_table += (
            f'<div style="display:flex; justify-content:space-between; padding:0.5rem 0; '
            f'border-top:2px solid rgba(16,185,129,0.4); margin-top:0.3rem; font-size:0.82rem;">'
            f'<span style="color:#10B981; font-weight:700;">Total Sources</span>'
            f'<span style="color:#10B981; font-weight:700;">{format_number(_su_total_sources, currency_symbol=acq_cs)}</span>'
            f'</div></div>'
        )

        _su_table += (
            '<div>'
            '<div style="font-size:0.75rem; font-weight:700; color:#10B981; text-transform:uppercase; '
            'letter-spacing:1px; border-bottom:2px solid #10B981; padding-bottom:0.3rem; margin-bottom:0.5rem;">Uses</div>'
        )
        _su_uses = [
            ("Equity Purchase Price", _su_purchase),
            ("Transaction Fees & Expenses", _su_fees),
        ]
        for _ul, _uv in _su_uses:
            _su_table += (
                f'<div style="display:flex; justify-content:space-between; padding:0.35rem 0; '
                f'border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.78rem;">'
                f'<span style="color:#D1D5DB;">{_ul}</span>'
                f'<span style="color:#F9FAFB; font-weight:600;">{format_number(_uv, currency_symbol=acq_cs)}</span>'
                f'</div>'
            )
        _su_table += (
            f'<div style="display:flex; justify-content:space-between; padding:0.5rem 0; '
            f'border-top:2px solid rgba(16,185,129,0.4); margin-top:0.3rem; font-size:0.82rem;">'
            f'<span style="color:#10B981; font-weight:700;">Total Uses</span>'
            f'<span style="color:#10B981; font-weight:700;">{format_number(_su_total_uses, currency_symbol=acq_cs)}</span>'
            f'</div></div></div>'
        )
        _mhtml(_su_table)

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M3b. IMPLIED MULTIPLES AT OFFER PRICE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Implied Multiples at Offer Price", "ğŸ“")
    
    # Calculate implied multiples
    offer_equity_value = pro_forma.purchase_price if pro_forma.purchase_price else 0
    tgt_net_debt = (getattr(tgt_cd, 'total_debt', 0) or 0) - (getattr(tgt_cd, 'total_cash', 0) or 0)
    offer_ev = offer_equity_value + tgt_net_debt
    
    tgt_revenue_val = pro_forma.tgt_revenue or 0
    tgt_ebitda_val = pro_forma.tgt_ebitda or 0
    tgt_ni_val = pro_forma.tgt_net_income or 0
    
    implied_ev_rev = offer_ev / tgt_revenue_val if tgt_revenue_val > 0 else 0
    implied_ev_ebitda = offer_ev / tgt_ebitda_val if tgt_ebitda_val > 0 else 0
    implied_pe = offer_equity_value / tgt_ni_val if tgt_ni_val > 0 else 0
    
    # Current multiples
    curr_ev = tgt_cd.enterprise_value or 0
    curr_ev_rev = curr_ev / tgt_revenue_val if tgt_revenue_val > 0 else 0
    curr_ev_ebitda = curr_ev / tgt_ebitda_val if tgt_ebitda_val > 0 else 0
    curr_pe = tgt_cd.trailing_pe or 0
    
    mult_table = (
        '<table class="pf-table">'
        '<thead><tr><th>Multiple</th><th>Current</th><th>At Offer Price</th><th>Premium Paid</th></tr></thead>'
        '<tbody>'
    )
    
    multiples_data = [
        ("EV / Revenue", curr_ev_rev, implied_ev_rev),
        ("EV / EBITDA", curr_ev_ebitda, implied_ev_ebitda),
        ("P / E", curr_pe, implied_pe),
    ]
    
    for name, curr, implied in multiples_data:
        prem = ((implied / curr - 1) * 100) if curr > 0 and implied > 0 else 0
        prem_color = "#EF4444" if prem > 50 else "#F59E0B" if prem > 20 else "#10B981"
        mult_table += (
            f'<tr>'
            f'<td style="font-weight:600;">{name}</td>'
            f'<td>{curr:.1f}x</td>'
            f'<td style="color:#2563EB; font-weight:700;">{implied:.1f}x</td>'
            f'<td style="color:{prem_color}; font-weight:700;">+{prem:.0f}%</td>'
            f'</tr>'
        )
    
    mult_table += '</tbody></table>'
    _mhtml(f'<div class="pf-table-wrapper">{mult_table}</div>')
    
    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M3c. CONTRIBUTION ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Contribution Analysis", "ğŸ“Š")
    st.markdown(
        '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
        'What percentage does each company contribute to the combined entity?</div>',
        unsafe_allow_html=True,
    )
    
    acq_rev = pro_forma.acq_revenue or 0
    tgt_rev = pro_forma.tgt_revenue or 0
    acq_ebitda = pro_forma.acq_ebitda or 0
    tgt_ebitda = pro_forma.tgt_ebitda or 0
    acq_ni = pro_forma.acq_net_income or 0
    tgt_ni = pro_forma.tgt_net_income or 0
    
    contrib_metrics = []
    for label, acq_v, tgt_v in [
        ("Revenue", acq_rev, tgt_rev),
        ("EBITDA", acq_ebitda, tgt_ebitda),
        ("Net Income", acq_ni, tgt_ni),
        ("Market Cap", acq_cd.market_cap or 0, tgt_cd.market_cap or 0),
    ]:
        total = acq_v + tgt_v
        acq_pct = (acq_v / total * 100) if total > 0 else 0
        tgt_pct = 100 - acq_pct
        contrib_metrics.append((label, acq_pct, tgt_pct))
    
    # Ownership split
    acq_own_pct = (pro_forma.acq_shares / pro_forma.pf_shares_outstanding * 100) if pro_forma.pf_shares_outstanding else 0
    tgt_own_pct = 100 - acq_own_pct
    contrib_metrics.append(("Pro Forma Ownership", acq_own_pct, tgt_own_pct))
    
    contrib_html = '<div style="display:grid; gap:0.8rem;">'
    for label, acq_pct, tgt_pct in contrib_metrics:
        contrib_html += (
            f'<div>'
            f'<div style="display:flex; justify-content:space-between; margin-bottom:0.2rem;">'
            f'<span style="font-size:0.72rem; color:#9CA3AF; font-weight:600;">{label}</span>'
            f'<span style="font-size:0.65rem; color:#9CA3AF;">'
            f'{acq_cd.ticker}: {acq_pct:.0f}% | {tgt_cd.ticker}: {tgt_pct:.0f}%</span>'
            f'</div>'
            f'<div style="display:flex; height:24px; border-radius:6px; overflow:hidden; '
            f'border:1px solid rgba(255,255,255,0.05);">'
            f'<div style="width:{acq_pct}%; background:linear-gradient(90deg, #2563EB, #60A5FA); '
            f'display:flex; align-items:center; justify-content:center; font-size:0.6rem; color:#fff; font-weight:700;">'
            f'{acq_pct:.0f}%</div>'
            f'<div style="width:{tgt_pct}%; background:linear-gradient(90deg, #10B981, #F5A0B8); '
            f'display:flex; align-items:center; justify-content:center; font-size:0.6rem; color:#fff; font-weight:700;">'
            f'{tgt_pct:.0f}%</div>'
            f'</div></div>'
        )
    contrib_html += '</div>'
    _mhtml(contrib_html)
    
    _divider()
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M3d. GOODWILL & PURCHASE PRICE ALLOCATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Purchase Price Allocation", "ğŸ·ï¸")
    
    tgt_book_value = getattr(tgt_cd, 'book_value', None)
    tgt_total_equity = None
    if tgt_cd.balance_sheet is not None and not tgt_cd.balance_sheet.empty:
        for idx_name in tgt_cd.balance_sheet.index:
            if "stockholder" in str(idx_name).lower() or "total equity" in str(idx_name).lower():
                try:
                    tgt_total_equity = float(tgt_cd.balance_sheet.loc[idx_name].iloc[0])
                except Exception:
                    pass
                break
    
    if not tgt_total_equity and tgt_book_value and tgt_cd.shares_outstanding:
        tgt_total_equity = tgt_book_value * tgt_cd.shares_outstanding
    
    if tgt_total_equity and offer_equity_value:
        goodwill = offer_equity_value - tgt_total_equity
        goodwill_pct = (goodwill / offer_equity_value * 100) if offer_equity_value > 0 else 0
        
        ppa_col1, ppa_col2, ppa_col3 = st.columns(3)
        ppa_col1.metric("Purchase Price", format_number(offer_equity_value, currency_symbol=acq_cs))
        ppa_col2.metric("Target Book Value", format_number(tgt_total_equity, currency_symbol=acq_cs))
        ppa_col3.metric("Implied Goodwill", format_number(goodwill, currency_symbol=acq_cs))
        
        # Goodwill waterfall
        fig_gw = go.Figure(go.Waterfall(
            x=["Book Value", "Intangibles &<br>Goodwill", "Purchase Price"],
            y=[tgt_total_equity, goodwill, 0],
            measure=["absolute", "relative", "total"],
            connector=dict(line=dict(color="rgba(37,99,235,0.3)")),
            increasing=dict(marker_color="#10B981"),
            totals=dict(marker_color="#2563EB"),
            text=[format_number(tgt_total_equity, currency_symbol=acq_cs),
                  format_number(goodwill, currency_symbol=acq_cs),
                  format_number(offer_equity_value, currency_symbol=acq_cs)],
            textposition="outside",
            textfont=dict(size=10, color="#D1D5DB"),
        ))
        fig_gw.update_layout(
            **_CHART_LAYOUT_BASE, height=300,
            margin=dict(t=30, b=30, l=50, r=30),
            yaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), visible=False),
            xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
            showlegend=False,
        )
        _apply_space_grid(fig_gw)
        st.plotly_chart(fig_gw, use_container_width=True, key="goodwill_waterfall")
        
        st.markdown(
            f'<div style="text-align:center; font-size:0.75rem; color:#9CA3AF;">'
            f'Goodwill represents {goodwill_pct:.0f}% of total purchase price</div>',
            unsafe_allow_html=True,
        )
    else:
        st.info("Insufficient balance sheet data for purchase price allocation.")
    
    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M3e. SYNERGY NPV ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Synergy Value Analysis", "âš¡")
    
    total_syn = pro_forma.total_synergies or 0
    cost_syn_val = pro_forma.cost_synergies or 0
    rev_syn_val = pro_forma.revenue_synergies or 0
    tax_rate = merger_assumptions.tax_rate / 100
    wacc = merger_assumptions.cost_of_debt / 100  # Using cost of debt as proxy
    
    # Assume synergies phase in over 3 years (33%, 66%, 100%)
    phase_in = [0.33, 0.66, 1.0, 1.0, 1.0]
    syn_pv = 0
    syn_timeline = []
    for yr, pct in enumerate(phase_in, 1):
        yr_syn = total_syn * pct * (1 - tax_rate)
        pv = yr_syn / (1 + wacc) ** yr
        syn_pv += pv
        syn_timeline.append({"year": yr, "synergy": yr_syn, "pv": pv, "phase_pct": pct * 100})
    
    syn_col1, syn_col2, syn_col3, syn_col4 = st.columns(4)
    syn_col1.metric("Cost Synergies (Annual)", format_number(cost_syn_val, currency_symbol=acq_cs))
    syn_col2.metric("Revenue Synergies (Annual)", format_number(rev_syn_val, currency_symbol=acq_cs))
    syn_col3.metric("Total AT Synergies", format_number(total_syn * (1 - tax_rate), currency_symbol=acq_cs))
    syn_col4.metric("NPV of Synergies (5Y)", format_number(syn_pv, currency_symbol=acq_cs))
    
    # Synergy phase-in chart
    fig_syn = go.Figure()
    fig_syn.add_trace(go.Bar(
        x=[f"Year {s['year']}" for s in syn_timeline],
        y=[s["synergy"] for s in syn_timeline],
        name="AT Synergies",
        marker_color="rgba(16,185,129,0.6)",
        text=[f"{s['phase_pct']:.0f}%" for s in syn_timeline],
        textposition="outside",
        textfont=dict(size=10, color="#10B981"),
    ))
    fig_syn.add_trace(go.Scatter(
        x=[f"Year {s['year']}" for s in syn_timeline],
        y=[s["pv"] for s in syn_timeline],
        mode="lines+markers",
        name="PV of Synergies",
        line=dict(color="#2563EB", width=2),
        marker=dict(size=8, color="#2563EB"),
    ))
    fig_syn.update_layout(
        **_CHART_LAYOUT_BASE, height=300,
        margin=dict(t=20, b=30, l=50, r=30),
        yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
        xaxis=dict(tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
        legend=dict(orientation="h", yanchor="bottom", y=1.02, font=dict(size=9, color="#D1D5DB")),
        barmode="group",
    )
    _apply_space_grid(fig_syn)
    st.plotly_chart(fig_syn, use_container_width=True, key="synergy_phasing")
    
    # Premium paid vs synergy value
    if syn_pv > 0 and offer_equity_value > 0:
        premium_paid = offer_equity_value - (tgt_cd.market_cap or 0)
        syn_coverage = (syn_pv / premium_paid * 100) if premium_paid > 0 else 0
        cov_color = "#10B981" if syn_coverage > 100 else "#F59E0B" if syn_coverage > 60 else "#EF4444"
        st.markdown(
            f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
            f'border-radius:12px; margin-top:0.5rem;">'
            f'<span style="font-size:0.7rem; color:#9CA3AF;">Premium Paid: {format_number(premium_paid, currency_symbol=acq_cs)} | '
            f'Synergy NPV covers </span>'
            f'<span style="font-size:1.2rem; font-weight:800; color:{cov_color};">{syn_coverage:.0f}%</span>'
            f'<span style="font-size:0.7rem; color:#9CA3AF;"> of premium</span>'
            f'</div>',
            unsafe_allow_html=True,
        )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M4. PRO FORMA FINANCIALS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Pro Forma Financials")

    tax_r = merger_assumptions.tax_rate / 100
    ats = pro_forma.total_synergies * (1 - tax_r)
    ati = pro_forma.incremental_interest * (1 - tax_r)

    # Enhanced visual Pro Forma table
    pf_rows = [
        ("ğŸ“Š Revenue",
         format_number(pro_forma.acq_revenue, currency_symbol=acq_cs),
         format_number(pro_forma.tgt_revenue, currency_symbol=tgt_cs),
         format_number(pro_forma.revenue_synergies, currency_symbol=acq_cs),
         format_number(pro_forma.pf_revenue, currency_symbol=acq_cs)),
        ("ğŸ’¹ EBITDA",
         format_number(pro_forma.acq_ebitda, currency_symbol=acq_cs),
         format_number(pro_forma.tgt_ebitda, currency_symbol=tgt_cs),
         format_number(pro_forma.total_synergies, currency_symbol=acq_cs),
         format_number(pro_forma.pf_ebitda, currency_symbol=acq_cs)),
        ("ğŸ’° Net Income",
         format_number(pro_forma.acq_net_income, currency_symbol=acq_cs),
         format_number(pro_forma.tgt_net_income, currency_symbol=tgt_cs),
         format_number(ats - ati, currency_symbol=acq_cs),
         format_number(pro_forma.pf_net_income, currency_symbol=acq_cs)),
        ("ğŸ“ˆ Shares (M)",
         f"{pro_forma.acq_shares / 1e6:,.0f}" if pro_forma.acq_shares else "N/A",
         "â€”",
         f"+{pro_forma.new_shares_issued / 1e6:,.0f}" if pro_forma.new_shares_issued else "â€”",
         f"{pro_forma.pf_shares_outstanding / 1e6:,.0f}" if pro_forma.pf_shares_outstanding else "N/A"),
        ("ğŸ¯ EPS",
         f"{acq_cs}{pro_forma.acq_eps:.2f}" if pro_forma.acq_eps else "N/A",
         "â€”",
         "â€”",
         f"{acq_cs}{pro_forma.pf_eps:.2f}" if pro_forma.pf_eps else "N/A"),
    ]

    pf_table_html = (
        f'<div class="pf-table-wrapper">'
        f'<table class="pf-table">'
        f'<thead><tr>'
        f'<th>Metric</th>'
        f'<th>{acq_cd.ticker}</th>'
        f'<th>{tgt_cd.ticker}</th>'
        f'<th>Adjustments</th>'
        f'<th>âœ¨ Pro Forma</th>'
        f'</tr></thead>'
        f'<tbody>'
    )
    for metric, acq_val, tgt_val, adj_val, pf_val in pf_rows:
        adj_class = ' class="pf-adj"' if adj_val not in ["â€”", "N/A"] else ''
        pf_table_html += (
            f'<tr>'
            f'<td>{metric}</td>'
            f'<td>{acq_val}</td>'
            f'<td>{tgt_val}</td>'
            f'<td{adj_class}>{adj_val}</td>'
            f'<td>{pf_val}</td>'
            f'</tr>'
        )
    pf_table_html += '</tbody></table></div>'
    _mhtml(pf_table_html)

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M5. ACCRETION / DILUTION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Accretion / Dilution Analysis")

    acc_color = "#10B981" if pro_forma.is_accretive else "#EF4444"
    acc_word = "ACCRETIVE" if pro_forma.is_accretive else "DILUTIVE"
    acc_bg = "rgba(16,185,129,0.08)" if pro_forma.is_accretive else "rgba(239,68,68,0.08)"

    _mhtml(
        f'<div style="text-align:center; padding:1rem; background:{acc_bg}; border-radius:14px; margin-bottom:1rem;">'
        f'<div style="font-size:0.7rem; font-weight:600; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">EPS Impact</div>'
        f'<div style="font-size:2.5rem; font-weight:800; color:{acc_color};">{pro_forma.accretion_dilution_pct:+.1f}%</div>'
        f'<div style="font-size:1rem; font-weight:700; color:{acc_color};">{acc_word}</div>'
        f'<div style="font-size:0.8rem; color:#D1D5DB; margin-top:0.3rem;">'
        f'Standalone: {acq_cs}{pro_forma.acq_eps:.2f} &rarr; Pro Forma: {acq_cs}{pro_forma.pf_eps:.2f}</div>'
        f'</div>'
    )

    _mhtml('<div class="merger-chart-wrapper">')
    _build_accretion_waterfall(pro_forma)
    _mhtml('</div>')

    # Premium Sensitivity on Accretion/Dilution
    try:
        _section("Premium Sensitivity", "ğŸšï¸")
        st.markdown(
            '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
            'How does the offer premium affect EPS accretion/dilution?</div>',
            unsafe_allow_html=True,
        )
        
        premiums = [10, 15, 20, 25, 30, 35, 40, 50, 60]
        ad_results = []
        for p in premiums:
            test_assumptions = MergerAssumptions(
                offer_premium_pct=p,
                pct_cash=merger_assumptions.pct_cash,
                pct_stock=merger_assumptions.pct_stock,
                cost_synergies_pct=merger_assumptions.cost_synergies_pct,
                revenue_synergies_pct=merger_assumptions.revenue_synergies_pct,
                transaction_fees_pct=merger_assumptions.transaction_fees_pct,
                tax_rate=merger_assumptions.tax_rate,
                cost_of_debt=merger_assumptions.cost_of_debt,
            )
            try:
                test_pf = calculate_pro_forma(acq_cd, tgt_cd, test_assumptions)
                ad_results.append({"premium": p, "ad_pct": test_pf.accretion_dilution_pct or 0})
            except Exception:
                ad_results.append({"premium": p, "ad_pct": 0})
        
        if ad_results:
            fig_prem = go.Figure()
            colors = ["#10B981" if r["ad_pct"] >= 0 else "#EF4444" for r in ad_results]
            fig_prem.add_trace(go.Bar(
                x=[f"{r['premium']}%" for r in ad_results],
                y=[r["ad_pct"] for r in ad_results],
                marker_color=colors,
                text=[f"{r['ad_pct']:+.1f}%" for r in ad_results],
                textposition="outside",
                textfont=dict(size=9, color="#D1D5DB"),
            ))
            # Highlight current premium
            curr_idx = None
            for i, r in enumerate(ad_results):
                if r["premium"] == merger_assumptions.offer_premium_pct:
                    curr_idx = i
                    break
            if curr_idx is not None:
                fig_prem.add_annotation(
                    x=f"{merger_assumptions.offer_premium_pct}%", y=ad_results[curr_idx]["ad_pct"],
                    text="Current", showarrow=True, arrowhead=2, arrowcolor="#F59E0B",
                    font=dict(size=10, color="#F59E0B"), ax=0, ay=-30,
                )
            
            fig_prem.add_hline(y=0, line_dash="dash", line_color="rgba(255,255,255,0.2)", line_width=1)
            fig_prem.update_layout(
                **_CHART_LAYOUT_BASE, height=300,
                margin=dict(t=30, b=30, l=50, r=30),
                xaxis=dict(title=dict(text="Offer Premium", font=dict(size=11, color="#9CA3AF")),
                          tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
                yaxis=dict(title=dict(text="EPS Accretion/Dilution %", font=dict(size=11, color="#9CA3AF")),
                          ticksuffix="%", tickfont=dict(size=9, color="#9CA3AF")),
                showlegend=False,
            )
            _apply_space_grid(fig_prem)
            st.plotly_chart(fig_prem, use_container_width=True, key="premium_sensitivity")
    except Exception:
        pass  # Premium sensitivity is non-critical

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M5a-NEW. PRO FORMA EPS ACCRETION/DILUTION SENSITIVITY TABLE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Pro Forma EPS Sensitivity Table"):
        _section("Pro Forma EPS Sensitivity", "ğŸ“Š")
        st.markdown(
            '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
            'EPS accretion/dilution across purchase price premiums and cash/stock mix.</div>',
            unsafe_allow_html=True,
        )
        _eps_premiums = [10, 20, 30, 40]
        _eps_cash_splits = [0, 25, 50, 75, 100]

        _eps_header = '<table style="width:100%; border-collapse:collapse; font-size:0.75rem;">'
        _eps_header += '<thead><tr><th style="padding:0.4rem; color:#9CA3AF; text-align:left; border-bottom:2px solid rgba(37,99,235,0.3);">Cash %</th>'
        for _ep in _eps_premiums:
            _eps_header += f'<th style="padding:0.4rem; color:#2563EB; text-align:center; border-bottom:2px solid rgba(37,99,235,0.3);">{_ep}% Premium</th>'
        _eps_header += '</tr></thead><tbody>'

        for _ec in _eps_cash_splits:
            _eps_header += f'<tr><td style="padding:0.35rem; color:#D1D5DB; font-weight:600; border-bottom:1px solid rgba(255,255,255,0.05);">{_ec}% Cash / {100-_ec}% Stock</td>'
            for _ep in _eps_premiums:
                try:
                    _test_a = MergerAssumptions(
                        offer_premium_pct=_ep, pct_cash=_ec, pct_stock=100 - _ec,
                        cost_synergies_pct=merger_assumptions.cost_synergies_pct,
                        revenue_synergies_pct=merger_assumptions.revenue_synergies_pct,
                        transaction_fees_pct=merger_assumptions.transaction_fees_pct,
                        tax_rate=merger_assumptions.tax_rate, cost_of_debt=merger_assumptions.cost_of_debt,
                    )
                    _test_pf = calculate_pro_forma(acq_cd, tgt_cd, _test_a)
                    _ad = _test_pf.accretion_dilution_pct or 0
                    _pf_eps_val = _test_pf.pf_eps or 0
                    _ad_color = "#10B981" if _ad >= 0 else "#EF4444"
                    _cell = f'{acq_cs}{_pf_eps_val:.2f} <span style="color:{_ad_color};">({_ad:+.1f}%)</span>'
                except Exception:
                    _cell = "â€”"
                _eps_header += f'<td style="padding:0.35rem; text-align:center; color:#F9FAFB; border-bottom:1px solid rgba(255,255,255,0.05);">{_cell}</td>'
            _eps_header += '</tr>'
        _eps_header += '</tbody></table>'
        _mhtml(f'<div style="overflow-x:auto;">{_eps_header}</div>')

        st.markdown(
            f'<div style="font-size:0.65rem; color:#9CA3AF; margin-top:0.5rem;">'
            f'Standalone EPS: {acq_cs}{pro_forma.acq_eps:.2f} Â· Synergies held constant at '
            f'{merger_assumptions.cost_synergies_pct:.0f}% cost / {merger_assumptions.revenue_synergies_pct:.0f}% revenue</div>',
            unsafe_allow_html=True,
        )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M5b. DEAL FINANCING MIX SENSITIVITY
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Deal Financing Mix"):
        _section("Deal Financing Mix Sensitivity", "ğŸ’¸")
        st.markdown(
            '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
            'Explore how different cash/debt/stock mixes and synergy levels affect EPS accretion/dilution.</div>',
            unsafe_allow_html=True,
        )

        fmix_c1, fmix_c2, fmix_c3 = st.columns(3)
        with fmix_c1:
            fm_cash = st.slider("% Cash", 0, 100, int(merger_assumptions.pct_cash), 5, key="fm_cash_slider")
        with fmix_c2:
            fm_debt = st.slider("% Debt", 0, 100 - fm_cash, min(100 - fm_cash, 0), 5, key="fm_debt_slider")
        with fmix_c3:
            fm_stock = 100 - fm_cash - fm_debt
            st.markdown(
                f'<div style="text-align:center; padding:1.5rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px;">'
                f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Stock (remainder)</div>'
                f'<div style="font-size:2rem; font-weight:800; color:#2563EB;">{fm_stock}%</div></div>',
                unsafe_allow_html=True,
            )

        # Financing mix vs Synergies sensitivity matrix
        synergy_levels = [0, 5, 10, 15, 20, 25]
        cash_levels = [0, 25, 50, 75, 100]

        matrix_data = []
        for cash_pct_test in cash_levels:
            row = {"Cash %": f"{cash_pct_test}%"}
            for syn_pct in synergy_levels:
                try:
                    test_a = MergerAssumptions(
                        offer_premium_pct=merger_assumptions.offer_premium_pct,
                        pct_cash=cash_pct_test,
                        pct_stock=100 - cash_pct_test,
                        cost_synergies_pct=syn_pct,
                        revenue_synergies_pct=merger_assumptions.revenue_synergies_pct,
                        transaction_fees_pct=merger_assumptions.transaction_fees_pct,
                        tax_rate=merger_assumptions.tax_rate,
                        cost_of_debt=merger_assumptions.cost_of_debt,
                    )
                    test_pf = calculate_pro_forma(acq_cd, tgt_cd, test_a)
                    row[f"Syn {syn_pct}%"] = f"{test_pf.accretion_dilution_pct:+.1f}%"
                except Exception:
                    row[f"Syn {syn_pct}%"] = "â€”"
            matrix_data.append(row)

        if matrix_data:
            fm_df = pd.DataFrame(matrix_data)
            # Build styled HTML table
            fm_th = "".join(
                f'<th style="padding:0.4rem 0.5rem; font-weight:700; color:#2563EB; font-size:0.7rem; '
                f'text-align:center; border-bottom:2px solid rgba(37,99,235,0.3);">{c}</th>'
                for c in fm_df.columns
            )
            fm_tbody = ""
            for _, r in fm_df.iterrows():
                cells = ""
                for j, c in enumerate(fm_df.columns):
                    val = r[c]
                    if j == 0:
                        cells += f'<td style="padding:0.35rem 0.5rem; font-size:0.75rem; color:#D1D5DB; font-weight:600; text-align:center;">{val}</td>'
                    else:
                        _c = "#10B981" if val.startswith("+") else "#EF4444" if val.startswith("-") else "#9CA3AF"
                        cells += f'<td style="padding:0.35rem 0.5rem; font-size:0.75rem; color:{_c}; font-weight:600; text-align:center;">{val}</td>'
                fm_tbody += f'<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">{cells}</tr>'

            _mhtml(
                f'<div style="background:rgba(255,255,255,0.02); border:1px solid rgba(37,99,235,0.1); '
                f'border-radius:10px; overflow:hidden; margin-bottom:1rem;">'
                f'<div style="padding:0.6rem 0.8rem; background:rgba(37,99,235,0.06); '
                f'border-bottom:1px solid rgba(37,99,235,0.1);">'
                f'<span style="font-size:0.7rem; font-weight:700; color:#2563EB; text-transform:uppercase; '
                f'letter-spacing:1px;">Cash % vs Cost Synergy % â†’ EPS Accretion/Dilution</span></div>'
                f'<table style="width:100%; border-collapse:collapse;">'
                f'<thead><tr>{fm_th}</tr></thead>'
                f'<tbody>{fm_tbody}</tbody></table></div>'
            )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M5c. COMPARABLE TRANSACTIONS (from M&A history)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Comparable Transactions"):
        # Show acquirer/target M&A history as comparable transactions if available
        acq_ma = getattr(acq_cd, 'ma_history', None) or []
        tgt_ma = getattr(tgt_cd, 'ma_history', None) or []
        all_ma = acq_ma + tgt_ma
        if all_ma:
            _section("Comparable Transactions (M&A History)", "ğŸ”„")
            ct_rows = ""
            for deal in all_ma[:20]:
                d_date = deal.get("date", deal.get("year", ""))
                d_acquirer = deal.get("acquirer", deal.get("buyer", ""))
                d_target = deal.get("target", deal.get("name", ""))
                d_value = deal.get("deal_value", deal.get("value", None))
                d_ev_ebitda = deal.get("ev_ebitda", None)
                d_ev_rev = deal.get("ev_revenue", None)
                d_premium = deal.get("premium", None)
                val_str = format_number(d_value, currency_symbol=tgt_cs) if d_value else "â€”"
                ev_eb_str = f"{d_ev_ebitda:.1f}x" if d_ev_ebitda else "â€”"
                ev_rev_str = f"{d_ev_rev:.1f}x" if d_ev_rev else "â€”"
                prem_str = f"{d_premium:.0f}%" if d_premium else "â€”"
                ct_rows += (
                    f"<tr><td>{d_date}</td><td>{d_acquirer}</td><td>{d_target}</td>"
                    f"<td>{val_str}</td><td>{ev_eb_str}</td><td>{ev_rev_str}</td><td>{prem_str}</td></tr>"
                )
            if ct_rows:
                _mhtml(
                    f'<table class="precedent-table">'
                    f'<thead><tr><th>Date</th><th>Acquirer</th><th>Target</th>'
                    f'<th>Deal Value</th><th>EV/EBITDA</th><th>EV/Revenue</th><th>Premium</th></tr></thead>'
                    f'<tbody>{ct_rows}</tbody></table>'
                )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M6. FOOTBALL FIELD VALUATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if pro_forma.football_field and len([k for k in pro_forma.football_field if not k.startswith("_")]) > 0:
        _section("Football Field Valuation")
        _mhtml('<div class="merger-chart-wrapper">')
        _build_football_field_chart(pro_forma.football_field, acq_cs)
        _mhtml('</div>')
        _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M6b. PRECEDENT TRANSACTIONS TABLE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if precedent and precedent.deals:
        _section("Precedent Transactions")
        rows_html = ""
        for d in precedent.deals[:15]:
            name = d.get("name", d.get("target", ""))
            date = d.get("date", "")
            ev_eb = d.get("ev_ebitda")
            ev_rev = d.get("ev_revenue")
            dval = d.get("deal_value")
            ev_eb_str = f"{ev_eb:.1f}x" if ev_eb else "â€”"
            ev_rev_str = f"{ev_rev:.1f}x" if ev_rev else "â€”"
            dval_str = format_number(dval, currency_symbol=tgt_cs) if dval else "â€”"
            rows_html += (
                f"<tr><td>{date}</td><td>{name}</td>"
                f"<td>{dval_str}</td><td>{ev_eb_str}</td><td>{ev_rev_str}</td></tr>"
            )
        source_note = ""
        if precedent.source_url:
            source_note = f'<div style="font-size:0.7rem; color:#9CA3AF; margin-top:0.5rem;">Source: {precedent.source} â€” <a href="{precedent.source_url}" style="color:#60A5FA;" target="_blank">Filing</a></div>'
        elif precedent.source:
            source_note = f'<div style="font-size:0.7rem; color:#9CA3AF; margin-top:0.5rem;">Source: {precedent.source}</div>'
        _mhtml(
            f'<table class="precedent-table">'
            f'<thead><tr><th>Date</th><th>Transaction</th>'
            f'<th>Deal Value</th><th>EV/EBITDA</th><th>EV/Revenue</th></tr></thead>'
            f'<tbody>{rows_html}</tbody></table>'
            f'{source_note}'
        )
        _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M6c. TRANSACTION MULTIPLES TREND
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Transaction Multiples Trend"):
        _all_deals_for_trend = []
        if precedent and precedent.deals:
            _all_deals_for_trend.extend(precedent.deals)
        _all_deals_for_trend.extend(all_ma if all_ma else [])
        # Filter deals with dates and at least one multiple
        _trend_deals = []
        for _td in _all_deals_for_trend:
            _td_date = _td.get("date", _td.get("year", ""))
            _td_ev_eb = _td.get("ev_ebitda")
            _td_ev_rev = _td.get("ev_revenue")
            if _td_date and (_td_ev_eb or _td_ev_rev):
                try:
                    import dateutil.parser as _dp
                    _parsed = _dp.parse(str(_td_date))
                    _trend_deals.append({"date": _parsed, "ev_ebitda": _td_ev_eb, "ev_revenue": _td_ev_rev,
                                         "name": _td.get("name", _td.get("target", ""))})
                except Exception:
                    pass
        if len(_trend_deals) >= 3:
            _section("Transaction Multiples Trend", "ğŸ“ˆ")
            st.markdown(
                '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                'Are sector deal multiples compressing or expanding over time?</div>',
                unsafe_allow_html=True,
            )
            _trend_deals.sort(key=lambda x: x["date"])
            _t_dates = [d["date"] for d in _trend_deals]
            _t_ev_eb = [d["ev_ebitda"] for d in _trend_deals]
            _t_ev_rev = [d["ev_revenue"] for d in _trend_deals]
            _t_names = [d["name"] for d in _trend_deals]

            fig_trend = go.Figure()
            _has_eb = any(v is not None for v in _t_ev_eb)
            _has_rev = any(v is not None for v in _t_ev_rev)
            if _has_eb:
                _valid_eb = [(d, v, n) for d, v, n in zip(_t_dates, _t_ev_eb, _t_names) if v is not None]
                fig_trend.add_trace(go.Scatter(
                    x=[d for d, v, n in _valid_eb], y=[v for d, v, n in _valid_eb],
                    mode="markers+lines", name="EV/EBITDA",
                    text=[n for d, v, n in _valid_eb], hovertemplate="%{text}<br>%{x|%Y-%m}<br>%{y:.1f}x",
                    marker=dict(color="#2563EB", size=8), line=dict(color="#2563EB", width=1, dash="dot"),
                ))
                # Trendline
                if len(_valid_eb) >= 3:
                    import numpy as np
                    _eb_x_num = np.array([(d - _valid_eb[0][0]).days for d, v, n in _valid_eb], dtype=float)
                    _eb_y_vals = np.array([v for d, v, n in _valid_eb])
                    _eb_coeffs = np.polyfit(_eb_x_num, _eb_y_vals, 1)
                    _eb_trend_y = np.polyval(_eb_coeffs, _eb_x_num)
                    fig_trend.add_trace(go.Scatter(
                        x=[d for d, v, n in _valid_eb], y=_eb_trend_y,
                        mode="lines", name="EV/EBITDA Trend",
                        line=dict(color="#2563EB", width=2), showlegend=True,
                    ))
            if _has_rev:
                _valid_rev = [(d, v, n) for d, v, n in zip(_t_dates, _t_ev_rev, _t_names) if v is not None]
                fig_trend.add_trace(go.Scatter(
                    x=[d for d, v, n in _valid_rev], y=[v for d, v, n in _valid_rev],
                    mode="markers+lines", name="EV/Revenue",
                    text=[n for d, v, n in _valid_rev], hovertemplate="%{text}<br>%{x|%Y-%m}<br>%{y:.1f}x",
                    marker=dict(color="#10B981", size=8), line=dict(color="#10B981", width=1, dash="dot"),
                ))
                if len(_valid_rev) >= 3:
                    _rv_x_num = np.array([(d - _valid_rev[0][0]).days for d, v, n in _valid_rev], dtype=float)
                    _rv_y_vals = np.array([v for d, v, n in _valid_rev])
                    _rv_coeffs = np.polyfit(_rv_x_num, _rv_y_vals, 1)
                    _rv_trend_y = np.polyval(_rv_coeffs, _rv_x_num)
                    fig_trend.add_trace(go.Scatter(
                        x=[d for d, v, n in _valid_rev], y=_rv_trend_y,
                        mode="lines", name="EV/Revenue Trend",
                        line=dict(color="#10B981", width=2), showlegend=True,
                    ))
            fig_trend.update_layout(
                **_CHART_LAYOUT_BASE, height=350,
                margin=dict(t=30, b=40, l=50, r=30),
                yaxis=dict(title=dict(text="Multiple (x)", font=dict(size=11, color="#9CA3AF")),
                          tickfont=dict(size=10, color="#9CA3AF")),
                xaxis=dict(tickfont=dict(size=10, color="#D1D5DB")),
                legend=dict(font=dict(size=10, color="#D1D5DB")),
            )
            _apply_space_grid(fig_trend)
            st.plotly_chart(fig_trend, use_container_width=True, key="txn_multiples_trend")
            _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M6d. DEAL STRUCTURE ANALYSIS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Deal Structure Analysis"):
        _section("Deal Structure Analysis", "ğŸ’¼")
        st.markdown(
            '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
            'Typical M&A deal structure breakdown in the sector â€” Cash vs Stock vs Mixed consideration.</div>',
            unsafe_allow_html=True,
        )
        _ds_sector = getattr(tgt_cd, 'sector', 'Technology')
        # Industry-average deal structure approximations by sector
        _deal_structures = {
            "Technology": {"Cash": 55, "Stock": 30, "Mixed": 15},
            "Healthcare": {"Cash": 60, "Stock": 25, "Mixed": 15},
            "Financial Services": {"Cash": 50, "Stock": 35, "Mixed": 15},
            "Consumer Cyclical": {"Cash": 45, "Stock": 35, "Mixed": 20},
            "Industrials": {"Cash": 50, "Stock": 30, "Mixed": 20},
            "Energy": {"Cash": 40, "Stock": 40, "Mixed": 20},
            "Communication Services": {"Cash": 50, "Stock": 35, "Mixed": 15},
            "Consumer Defensive": {"Cash": 55, "Stock": 30, "Mixed": 15},
            "Basic Materials": {"Cash": 45, "Stock": 35, "Mixed": 20},
            "Real Estate": {"Cash": 35, "Stock": 45, "Mixed": 20},
            "Utilities": {"Cash": 50, "Stock": 35, "Mixed": 15},
        }
        _ds = _deal_structures.get(_ds_sector, {"Cash": 50, "Stock": 35, "Mixed": 15})
        _ds_c1, _ds_c2 = st.columns([1, 1])
        with _ds_c1:
            fig_ds = go.Figure(data=[go.Pie(
                labels=list(_ds.keys()), values=list(_ds.values()),
                hole=0.45, textinfo="label+percent",
                marker=dict(colors=["#2563EB", "#10B981", "#F59E0B"]),
                textfont=dict(size=11, color="#F9FAFB"),
            )])
            fig_ds.update_layout(
                **_CHART_LAYOUT_BASE, height=280,
                margin=dict(t=20, b=20, l=20, r=20),
                showlegend=False,
                annotations=[dict(text=_ds_sector[:12], x=0.5, y=0.5, font_size=11,
                                 font_color="#9CA3AF", showarrow=False)],
            )
            st.plotly_chart(fig_ds, use_container_width=True, key="deal_structure_pie")
        with _ds_c2:
            st.markdown(
                f'<div style="padding:1rem; background:rgba(37,99,235,0.05); border-radius:12px; '
                f'border:1px solid rgba(37,99,235,0.15);">'
                f'<div style="font-size:0.85rem; font-weight:700; color:#F9FAFB; margin-bottom:0.5rem;">'
                f'Sector: {_ds_sector}</div>'
                f'<div style="font-size:0.78rem; color:#D1D5DB; line-height:1.7;">'
                f'ğŸ’µ <b>Cash deals</b> ({_ds["Cash"]}%) â€” Faster close, taxable to target shareholders<br>'
                f'ğŸ“Š <b>Stock deals</b> ({_ds["Stock"]}%) â€” Tax-deferred, shared upside/downside<br>'
                f'ğŸ”€ <b>Mixed</b> ({_ds["Mixed"]}%) â€” Balance of certainty and upside participation<br><br>'
                f'<span style="font-size:0.72rem; color:#9CA3AF;">'
                f'ğŸ’¡ <b>Earnouts & Contingent Consideration:</b> Common in {_ds_sector.lower()} deals where '
                f'future performance is uncertain. Typically 10-30% of deal value tied to milestones '
                f'(revenue targets, product approvals, customer retention). Bridges valuation gaps between '
                f'buyer and seller expectations.</span>'
                f'</div></div>',
                unsafe_allow_html=True,
            )
        _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M7. SOURCES & USES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Sources & Uses")

    # Calculate totals for bar percentages
    sources_total = sum(v for k, v in pro_forma.sources.items() if not k.startswith("Total") and v)
    uses_total = sum(v for k, v in pro_forma.uses.items() if not k.startswith("Total") and v)

    def _build_su_rows(items, total):
        rows_html = ""
        delay = 0.1
        for k, v in items.items():
            is_total = k.startswith("Total")
            pct = (v / total * 100) if total and v else 0
            total_class = " total" if is_total else ""
            val_str = format_number(v, currency_symbol=acq_cs)
            rows_html += (
                f'<div class="su-row{total_class}" style="animation-delay:{delay:.2f}s;">'
                f'<div class="su-row-header">'
                f'<span class="su-row-label">{k}</span>'
                f'<span class="su-row-value">{val_str}</span>'
                f'</div>'
                f'<div class="su-bar">'
                f'<div class="su-bar-fill" style="width:{pct:.1f}%; animation-delay:{delay + 0.2:.2f}s;"></div>'
                f'</div>'
                f'</div>'
            )
            delay += 0.08
        return rows_html

    sources_rows = _build_su_rows(pro_forma.sources, sources_total)
    uses_rows = _build_su_rows(pro_forma.uses, uses_total)

    su_html = (
        f'<div class="su-container">'
        f'<div class="su-panel sources">'
        f'<div class="su-panel-header"><span class="su-icon">ğŸ’µ</span> Sources of Funds</div>'
        f'{sources_rows}'
        f'</div>'
        f'<div class="su-panel uses">'
        f'<div class="su-panel-header"><span class="su-icon">ğŸ’¸</span> Uses of Funds</div>'
        f'{uses_rows}'
        f'</div>'
        f'</div>'
    )
    _mhtml(su_html)

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M8. PRO FORMA CREDIT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Pro Forma Credit Profile")

    cr1, cr2, cr3, cr4 = st.columns(4)

    def _lev_color(val):
        if val is None: return "#9CA3AF"
        if val < 2: return "#10B981"
        if val < 4: return "#F5A623"
        return "#EF4444"

    def _cov_color(val):
        if val is None: return "#9CA3AF"
        if val > 5: return "#10B981"
        if val > 2.5: return "#F5A623"
        return "#EF4444"

    lev_c = _lev_color(pro_forma.pf_leverage_ratio)
    cov_c = _cov_color(pro_forma.pf_interest_coverage)

    cr1.metric("PF Debt / EBITDA", f"{pro_forma.pf_leverage_ratio:.1f}x" if pro_forma.pf_leverage_ratio else "N/A")
    cr2.metric("PF Interest Coverage", f"{pro_forma.pf_interest_coverage:.1f}x" if pro_forma.pf_interest_coverage else "N/A")
    cr3.metric("PF Total Debt", format_number(pro_forma.pf_total_debt, currency_symbol=acq_cs))
    cr4.metric("PF Net Debt", format_number(pro_forma.pf_net_debt, currency_symbol=acq_cs))

    _mhtml(
        f'<div style="display:flex; gap:1rem; margin-top:0.5rem;">'
        f'<div style="flex:1; text-align:center; padding:0.6rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px; border-left:3px solid {lev_c};">'
        f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Leverage</div>'
        f'<div style="font-size:1.1rem; font-weight:700; color:{lev_c};">'
        f'{"Conservative" if (pro_forma.pf_leverage_ratio or 0) < 2 else "Moderate" if (pro_forma.pf_leverage_ratio or 0) < 4 else "Aggressive"}</div></div>'
        f'<div style="flex:1; text-align:center; padding:0.6rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px; border-left:3px solid {cov_c};">'
        f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Coverage</div>'
        f'<div style="font-size:1.1rem; font-weight:700; color:{cov_c};">'
        f'{"Strong" if (pro_forma.pf_interest_coverage or 0) > 5 else "Adequate" if (pro_forma.pf_interest_coverage or 0) > 2.5 else "Tight"}</div></div>'
        f'<div style="flex:1; text-align:center; padding:0.6rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px;">'
        f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Goodwill</div>'
        f'<div style="font-size:1.1rem; font-weight:700; color:#F9FAFB;">{format_number(pro_forma.goodwill, currency_symbol=acq_cs)}</div></div>'
        f'</div>'
    )

    # Debt Paydown Visualization
    try:
        if pro_forma.cash_consideration and pro_forma.pf_ebitda and pro_forma.pf_ebitda > 0:
            new_debt = pro_forma.cash_consideration
            annual_fcf = pro_forma.pf_ebitda * 0.4  # Assume 40% of EBITDA available for debt paydown
            
            if annual_fcf > 0:
                years_data = []
                remaining = new_debt
                for yr in range(1, 11):
                    remaining = max(0, remaining - annual_fcf)
                    years_data.append({"year": yr, "remaining": remaining})
                    if remaining == 0:
                        break
                
                payoff_years = next((d["year"] for d in years_data if d["remaining"] == 0), 10)
                py_color = "#10B981" if payoff_years <= 4 else "#F59E0B" if payoff_years <= 7 else "#EF4444"
                
                st.markdown(
                    f'<div style="text-align:center; padding:0.5rem; margin-top:0.5rem;">'
                    f'<span style="font-size:0.75rem; color:#9CA3AF;">Est. Debt Paydown: </span>'
                    f'<span style="font-size:1.1rem; font-weight:800; color:{py_color};">'
                    f'~{payoff_years} years</span>'
                    f'<span style="font-size:0.65rem; color:#9CA3AF;"> (assuming 40% EBITDA allocation)</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
    except Exception:
        pass

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M8b. SYNERGY REALIZATION SCHEDULE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Synergy Realization"):
        _section("Synergy Realization Schedule", "ğŸ“…")

        if hasattr(pro_forma, 'synergy_schedule') and pro_forma.synergy_schedule:
            syn_cols = st.columns(3)
            for i, s in enumerate(pro_forma.synergy_schedule):
                with syn_cols[i]:
                    pct_color = "#EF4444" if s["pct"] < 50 else "#F5A623" if s["pct"] < 100 else "#10B981"
                    st.markdown(
                        f'<div style="text-align:center; padding:0.8rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px;">'
                        f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Year {s["year"]}</div>'
                        f'<div style="font-size:1.5rem; font-weight:800; color:{pct_color};">{s["pct"]}%</div>'
                        f'<div style="font-size:0.8rem; color:#D1D5DB;">{format_number(s["amount"], currency_symbol=acq_cs)}</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

            # Synergy ramp chart
            fig_syn = go.Figure()
            years = [f"Year {s['year']}" for s in pro_forma.synergy_schedule]
            amounts = [s["amount"] for s in pro_forma.synergy_schedule]
            fig_syn.add_trace(go.Bar(
                x=years, y=amounts,
                marker_color=["#EF4444", "#F5A623", "#10B981"],
                text=[format_number(a, currency_symbol=acq_cs) for a in amounts],
                textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
            ))
            fig_syn.add_hline(y=pro_forma.total_synergies, line_dash="dash",
                             line_color="rgba(37,99,235,0.5)", annotation_text="Full Run-Rate",
                             annotation_font=dict(size=10, color="#9CA3AF"))
            fig_syn.update_layout(**_CHART_LAYOUT_BASE, height=250,
                                  margin=dict(t=30, b=30, l=50, r=30), showlegend=False,
                                  xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                                  yaxis=dict(tickfont=dict(size=9, color="#9CA3AF")))
            _apply_space_grid(fig_syn)
            st.plotly_chart(fig_syn, use_container_width=True, key="synergy_ramp")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M8c. DEBT PAYDOWN SCHEDULE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Debt Paydown Schedule"):
        if hasattr(pro_forma, 'debt_paydown_schedule') and pro_forma.debt_paydown_schedule:
            _section("Debt Paydown Schedule", "ğŸ“‰")

            fig_dp = go.Figure()
            dp_years = [f"Year {d['year']}" for d in pro_forma.debt_paydown_schedule]
            dp_remaining = [d["remaining"] for d in pro_forma.debt_paydown_schedule]
            dp_leverage = [d["leverage"] for d in pro_forma.debt_paydown_schedule]

            fig_dp.add_trace(go.Bar(
                x=dp_years, y=dp_remaining, name="Remaining Debt",
                marker_color="#2563EB",
                text=[format_number(r, currency_symbol=acq_cs) for r in dp_remaining],
                textposition="outside", textfont=dict(size=9, color="#D1D5DB"),
            ))
            fig_dp.add_trace(go.Scatter(
                x=dp_years, y=dp_leverage, name="Leverage (Debt/EBITDA)",
                yaxis="y2", mode="lines+markers",
                line=dict(color="#F5A623", width=2),
                marker=dict(size=8, color="#F5A623"),
            ))
            fig_dp.update_layout(
                **_CHART_LAYOUT_BASE, height=300,
                margin=dict(t=30, b=30, l=60, r=60), showlegend=True,
                legend=dict(orientation="h", yanchor="bottom", y=1.02, font=dict(size=9, color="#9CA3AF")),
                xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                yaxis=dict(title=dict(text="Debt Remaining", font=dict(size=10, color="#9CA3AF")),
                          tickfont=dict(size=9, color="#9CA3AF")),
                yaxis2=dict(title=dict(text="Leverage (x)", font=dict(size=10, color="#9CA3AF")),
                           tickfont=dict(size=9, color="#9CA3AF"), overlaying="y", side="right",
                           tickformat=".1f", ticksuffix="x"),
            )
            _apply_space_grid(fig_dp)
            st.plotly_chart(fig_dp, use_container_width=True, key="debt_paydown")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M8d. BREAK-EVEN SYNERGIES & DEAL IRR
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Break-Even & IRR"):
        _section("Break-Even Analysis & Deal IRR", "ğŸ¯")

        be_cols = st.columns(3)
        with be_cols[0]:
            be_syn = getattr(pro_forma, 'breakeven_synergies', 0)
            be_pct = getattr(pro_forma, 'breakeven_synergies_pct_of_target_rev', 0)
            achievable = be_syn <= pro_forma.total_synergies if be_syn else True
            be_color = "#10B981" if achievable else "#EF4444"
            st.markdown(
                f'<div style="text-align:center; padding:0.8rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px;">'
                f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Break-Even Synergies</div>'
                f'<div style="font-size:1.3rem; font-weight:800; color:{be_color};">{format_number(be_syn, currency_symbol=acq_cs)}</div>'
                f'<div style="font-size:0.75rem; color:#9CA3AF;">{be_pct:.1f}% of target revenue</div>'
                f'<div style="font-size:0.7rem; color:{be_color}; margin-top:0.3rem;">{"âœ“ Below assumed synergies" if achievable else "âš  Above assumed synergies"}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        with be_cols[1]:
            st.markdown(
                f'<div style="text-align:center; padding:0.8rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px;">'
                f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Synergy Cushion</div>'
                f'<div style="font-size:1.3rem; font-weight:800; color:{"#10B981" if achievable else "#EF4444"};">'
                f'{format_number(pro_forma.total_synergies - be_syn, currency_symbol=acq_cs)}</div>'
                f'<div style="font-size:0.75rem; color:#9CA3AF;">{"Margin of safety" if achievable else "Shortfall"}</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        with be_cols[2]:
            deal_irr = getattr(pro_forma, 'deal_irr', None)
            if deal_irr is not None:
                irr_color = "#10B981" if deal_irr > 0.15 else "#F5A623" if deal_irr > 0.08 else "#EF4444"
                irr_label = "Attractive" if deal_irr > 0.15 else "Acceptable" if deal_irr > 0.08 else "Below Hurdle"
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px;">'
                    f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF; text-transform:uppercase;">Est. Deal IRR (5yr)</div>'
                    f'<div style="font-size:1.3rem; font-weight:800; color:{irr_color};">{deal_irr:.1%}</div>'
                    f'<div style="font-size:0.75rem; color:{irr_color};">{irr_label}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
            else:
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); border-radius:10px;">'
                    f'<div style="font-size:0.65rem; font-weight:600; color:#9CA3AF;">Est. Deal IRR</div>'
                    f'<div style="font-size:1.1rem; color:#9CA3AF;">N/A</div></div>',
                    unsafe_allow_html=True,
                )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M9. AI STRATEGIC RATIONALE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Strategic Rationale")

    _sr_tag_config = [
        ("[DEAL LOGIC]", "Deal Logic", "#2563EB", "rgba(37,99,235,0.06)", "rgba(37,99,235,0.3)"),
        ("[FINANCIAL MERIT]", "Financial Merit", "#10B981", "rgba(16,185,129,0.06)", "rgba(16,185,129,0.3)"),
        ("[STRATEGIC FIT]", "Strategic Fit", "#10B981", "rgba(16,185,129,0.06)", "rgba(16,185,129,0.3)"),
        ("[COMPETITIVE POSITIONING]", "Competitive Positioning", "#F5A623", "rgba(245,166,35,0.06)", "rgba(245,166,35,0.3)"),
    ]

    for line in merger_insights.strategic_rationale.split("\n"):
        line = line.strip()
        if line.startswith("- "):
            line = line[2:]
        if not line:
            continue
        matched_tag = False
        for tag, label, color, bg, border in _sr_tag_config:
            if line.startswith(tag):
                line = line[len(tag):].strip().replace("$", "&#36;")
                st.markdown(
                    f'<div style="border-left:3px solid {border}; background:{bg}; '
                    f'padding:0.5rem 0.8rem; margin-bottom:0.5rem; border-radius:0 8px 8px 0;">'
                    f'<div style="font-size:0.7rem; font-weight:700; color:{color}; text-transform:uppercase; '
                    f'letter-spacing:0.5px; margin-bottom:0.2rem;">{label}</div>'
                    f'<div style="font-size:0.86rem; color:#D1D5DB; line-height:1.7;">{line}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
                matched_tag = True
                break
        if not matched_tag and line:
            line = line.replace("$", "&#36;")
            st.markdown(f"<div style='font-size:0.88rem; color:#D1D5DB; line-height:1.7; padding:0.2rem 0;'>&bull; {line}</div>", unsafe_allow_html=True)

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M10. AI DEAL RISKS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Deal Risk Assessment")

    _risk_tag_config = [
        ("[VALUATION]", "Valuation", "#EF4444", "rgba(239,68,68,0.06)", "rgba(239,68,68,0.3)"),
        ("[FINANCIAL]", "Financial", "#10B981", "rgba(16,185,129,0.06)", "rgba(16,185,129,0.3)"),
        ("[INTEGRATION]", "Integration", "#F5A623", "rgba(245,166,35,0.06)", "rgba(245,166,35,0.3)"),
        ("[EXECUTION]", "Execution", "#2563EB", "rgba(37,99,235,0.06)", "rgba(37,99,235,0.3)"),
        ("[MARKET]", "Market", "#10B981", "rgba(16,185,129,0.06)", "rgba(16,185,129,0.3)"),
        # Legacy tag support
        ("[ANTITRUST]", "Antitrust", "#EF4444", "rgba(239,68,68,0.06)", "rgba(239,68,68,0.3)"),
    ]

    # Severity keyword tinting â€” override base colors for high-severity language
    _high_severity_words = {"distressed", "unsustainable", "aggressive", "concerning", "substantial", "significant", "elevated", "transformative"}
    _low_severity_words = {"manageable", "adequate", "comfortable", "low", "conservative", "modest", "contained"}

    for line in merger_insights.deal_risks.split("\n"):
        line = line.strip()
        if line.startswith("- "):
            line = line[2:]
        if not line:
            continue

        tag_label = ""
        tag_color = "#9CA3AF"
        tag_bg = "rgba(138,133,173,0.05)"
        tag_border = "rgba(138,133,173,0.2)"

        for tag, label, color, bg, border in _risk_tag_config:
            if line.startswith(tag):
                line = line[len(tag):].strip()
                tag_label = label
                tag_color = color
                tag_bg = bg
                tag_border = border
                break

        # Severity-based tint adjustment (before escaping)
        line_lower = line.lower()
        has_high = any(w in line_lower for w in _high_severity_words)
        has_low = any(w in line_lower for w in _low_severity_words)

        if has_high and not has_low:
            severity_indicator = '<span style="color:#EF4444; font-size:0.7rem; margin-left:0.4rem;">&#9650; ELEVATED</span>'
        elif has_low and not has_high:
            severity_indicator = '<span style="color:#10B981; font-size:0.7rem; margin-left:0.4rem;">&#9660; LOW</span>'
        else:
            severity_indicator = ""

        header_html = ""
        if tag_label:
            header_html = (
                f'<div style="font-size:0.7rem; font-weight:700; color:{tag_color}; text-transform:uppercase; '
                f'letter-spacing:0.5px; margin-bottom:0.2rem;">{tag_label}{severity_indicator}</div>'
            )

        line = line.replace("$", "&#36;")
        st.markdown(
            f'<div style="border-left:3px solid {tag_border}; background:{tag_bg}; '
            f'padding:0.5rem 0.8rem; margin-bottom:0.5rem; border-radius:0 8px 8px 0;">'
            f'{header_html}'
            f'<div style="font-size:0.86rem; color:#D1D5DB; line-height:1.7;">{line}</div>'
            f'</div>',
            unsafe_allow_html=True,
        )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M11. AI DEAL VERDICT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Deal Verdict")

    grade_colors = {"A": "#10B981", "B": "#2563EB", "C": "#F5A623", "D": "#EF4444", "F": "#EF4444"}
    grade_c = grade_colors.get(merger_insights.deal_grade, "#9CA3AF")
    grade_bg = {"A": "rgba(16,185,129,0.12)", "B": "rgba(37,99,235,0.12)",
                "C": "rgba(245,166,35,0.12)", "D": "rgba(239,68,68,0.12)", "F": "rgba(239,68,68,0.12)"}

    st.markdown(
        f'<div style="display:inline-block; background:{grade_bg.get(merger_insights.deal_grade, "rgba(138,133,173,0.12)")}; '
        f'color:{grade_c}; padding:0.5rem 1.5rem; border-radius:12px; font-weight:800; '
        f'font-size:1.2rem; letter-spacing:1px; margin-bottom:1rem;">Deal Grade: {merger_insights.deal_grade}</div>',
        unsafe_allow_html=True,
    )

    _verdict_tag_config = {
        "[OVERALL]": ("Overall Assessment", None, "rgba(255,255,255,0.04)", "rgba(138,133,173,0.3)"),
        "[BULL CASE]": ("Bull Case", "#10B981", "rgba(16,185,129,0.06)", "rgba(16,185,129,0.35)"),
        "[BEAR CASE]": ("Bear Case", "#EF4444", "rgba(239,68,68,0.06)", "rgba(239,68,68,0.35)"),
        "[KEY CONDITION]": ("Key Condition", "#F5A623", "rgba(245,166,35,0.08)", "rgba(245,166,35,0.35)"),
    }

    for line in merger_insights.deal_verdict.split("\n"):
        line = line.strip()
        if line.startswith("- "):
            line = line[2:]
        if not line:
            continue

        matched_tag = False
        for tag, (label, color, bg, border) in _verdict_tag_config.items():
            if line.startswith(tag):
                line = line[len(tag):].strip().replace("$", "&#36;")
                header_color = color or "#D1D5DB"
                st.markdown(
                    f'<div style="border-left:3px solid {border}; background:{bg}; '
                    f'padding:0.6rem 0.8rem; margin-bottom:0.5rem; border-radius:0 8px 8px 0;">'
                    f'<div style="font-size:0.7rem; font-weight:700; color:{header_color}; text-transform:uppercase; '
                    f'letter-spacing:0.5px; margin-bottom:0.2rem;">{label}</div>'
                    f'<div style="font-size:0.86rem; color:#D1D5DB; line-height:1.7;">{line}</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
                matched_tag = True
                break

        if not matched_tag and line:
            line = line.replace("$", "&#36;")
            st.markdown(f"<div style='font-size:0.88rem; color:#D1D5DB; line-height:1.7; padding:0.2rem 0;'>&bull; {line}</div>", unsafe_allow_html=True)

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M11b. QUANTITATIVE DEAL SCORECARD
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Deal Scorecard", "ğŸ“‹")
    
    # Compute quantitative deal metrics
    deal_scores = []
    
    # 1. Accretion/Dilution
    if pro_forma.accretion_dilution_pct:
        ad = pro_forma.accretion_dilution_pct
        if ad > 5: deal_scores.append(("EPS Accretion", 10, "#10B981", f"+{ad:.1f}%"))
        elif ad > 0: deal_scores.append(("EPS Accretion", 7, "#34D399", f"+{ad:.1f}%"))
        elif ad > -5: deal_scores.append(("EPS Accretion", 4, "#F59E0B", f"{ad:.1f}%"))
        else: deal_scores.append(("EPS Accretion", 2, "#EF4444", f"{ad:.1f}%"))
    
    # 2. Premium reasonableness
    prem = merger_assumptions.offer_premium_pct
    if prem < 20: deal_scores.append(("Premium", 9, "#10B981", f"{prem:.0f}%"))
    elif prem < 35: deal_scores.append(("Premium", 7, "#34D399", f"{prem:.0f}%"))
    elif prem < 50: deal_scores.append(("Premium", 5, "#F59E0B", f"{prem:.0f}%"))
    else: deal_scores.append(("Premium", 2, "#EF4444", f"{prem:.0f}%"))
    
    # 3. Synergy coverage of premium
    if 'syn_pv' in dir() and 'premium_paid' in dir() and premium_paid > 0:
        syn_cov = syn_pv / premium_paid * 100
        if syn_cov > 100: deal_scores.append(("Synergy Coverage", 10, "#10B981", f"{syn_cov:.0f}%"))
        elif syn_cov > 60: deal_scores.append(("Synergy Coverage", 7, "#34D399", f"{syn_cov:.0f}%"))
        elif syn_cov > 30: deal_scores.append(("Synergy Coverage", 4, "#F59E0B", f"{syn_cov:.0f}%"))
        else: deal_scores.append(("Synergy Coverage", 2, "#EF4444", f"{syn_cov:.0f}%"))
    
    # 4. Strategic fit (same sector?)
    same_sector = (acq_cd.sector or "").lower() == (tgt_cd.sector or "").lower()
    if same_sector:
        deal_scores.append(("Strategic Fit", 8, "#10B981", "Same Sector"))
    else:
        deal_scores.append(("Strategic Fit", 5, "#F59E0B", "Cross-Sector"))
    
    # 5. Size ratio (target should be <50% of acquirer for clean integration)
    if acq_cd.market_cap and tgt_cd.market_cap:
        size_ratio = tgt_cd.market_cap / acq_cd.market_cap * 100
        if size_ratio < 15: deal_scores.append(("Size Ratio", 9, "#10B981", f"{size_ratio:.0f}%"))
        elif size_ratio < 30: deal_scores.append(("Size Ratio", 7, "#34D399", f"{size_ratio:.0f}%"))
        elif size_ratio < 50: deal_scores.append(("Size Ratio", 5, "#F59E0B", f"{size_ratio:.0f}%"))
        else: deal_scores.append(("Size Ratio", 3, "#EF4444", f"{size_ratio:.0f}%"))
    
    # 6. Financing mix (balanced is better)
    cash_pct_score = merger_assumptions.pct_cash
    if 30 <= cash_pct_score <= 70: deal_scores.append(("Financing Mix", 8, "#10B981", f"{cash_pct_score}% Cash"))
    elif 20 <= cash_pct_score <= 80: deal_scores.append(("Financing Mix", 6, "#F59E0B", f"{cash_pct_score}% Cash"))
    else: deal_scores.append(("Financing Mix", 4, "#EF4444", f"{cash_pct_score}% Cash"))
    
    if deal_scores:
        avg_score = sum(s[1] for s in deal_scores) / len(deal_scores)
        overall_color = "#10B981" if avg_score >= 7 else "#F59E0B" if avg_score >= 5 else "#EF4444"
        overall_label = "Strong" if avg_score >= 7 else "Moderate" if avg_score >= 5 else "Weak"
        
        # Overall score
        sc_left, sc_right = st.columns([1, 3])
        with sc_left:
            st.markdown(
                f'<div style="text-align:center; padding:1.5rem; background:rgba(37,99,235,0.05); '
                f'border-radius:16px; border:1px solid rgba(37,99,235,0.15);">'
                f'<div style="font-size:2.5rem; font-weight:900; color:{overall_color};">{avg_score:.1f}</div>'
                f'<div style="font-size:0.75rem; font-weight:700; color:{overall_color};">{overall_label}</div>'
                f'<div style="font-size:0.6rem; color:#9CA3AF; margin-top:0.2rem;">out of 10</div>'
                f'</div>',
                unsafe_allow_html=True,
            )
        
        with sc_right:
            for name, score, color, detail in deal_scores:
                bar_width = score * 10
                st.markdown(
                    f'<div style="display:flex; align-items:center; gap:0.5rem; padding:0.3rem 0; '
                    f'border-bottom:1px solid rgba(255,255,255,0.03);">'
                    f'<span style="color:#9CA3AF; font-size:0.72rem; width:120px; flex-shrink:0;">{name}</span>'
                    f'<div style="flex:1; background:rgba(255,255,255,0.05); border-radius:4px; height:16px; overflow:hidden;">'
                    f'<div style="width:{bar_width}%; height:100%; background:{color}; border-radius:4px; '
                    f'transition:width 0.5s ease;"></div></div>'
                    f'<span style="color:{color}; font-size:0.72rem; font-weight:700; width:80px; text-align:right;">{detail}</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M11b. GENERATE DEAL BOOK (HTML EXPORT)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    with _safe_section("Deal Book Export"):
        _section("ğŸ“‘ Generate Deal Book", "ğŸ“‹")

        if st.button("ğŸ“‘ Generate Deal Book", key="gen_deal_book_btn", type="secondary", use_container_width=True):
            acq_name = acq_cd.name or acquirer_input.upper()
            tgt_name = tgt_cd.name or target_input.upper()
            acq_ticker = acq_cd.ticker or acquirer_input.upper()
            tgt_ticker = tgt_cd.ticker or target_input.upper()

            _deal_premium = f"{merger_assumptions.offer_premium_pct:.0f}%"
            _deal_ev = format_number(getattr(pro_forma, 'transaction_value', 0), currency_symbol=acq_cs)
            _pct_cash = f"{merger_assumptions.pct_cash:.0f}%"
            _pct_stock = f"{100 - merger_assumptions.pct_cash:.0f}%"
            _total_syn = format_number(getattr(pro_forma, 'total_synergies', 0), currency_symbol=acq_cs)
            _rev_syn = format_number(getattr(pro_forma, 'revenue_synergies', 0), currency_symbol=acq_cs)
            _cost_syn = format_number(getattr(pro_forma, 'cost_synergies', 0), currency_symbol=acq_cs)
            _pf_rev = format_number(getattr(pro_forma, 'pro_forma_revenue', 0), currency_symbol=acq_cs)
            _pf_ebitda = format_number(getattr(pro_forma, 'pro_forma_ebitda', 0), currency_symbol=acq_cs)
            _eps_accretion = f"{getattr(pro_forma, 'eps_accretion_pct', 0):+.1f}%"
            _eps_status = "Accretive âœ…" if getattr(pro_forma, 'eps_accretion_pct', 0) >= 0 else "Dilutive âš ï¸"

            # Merger insights
            _mi_exec = getattr(merger_insights, 'executive_summary', 'N/A') if merger_insights else 'N/A'
            _mi_risks = getattr(merger_insights, 'risk_factors', []) if merger_insights else []
            _mi_strategic = getattr(merger_insights, 'strategic_rationale', 'N/A') if merger_insights else 'N/A'

            _risk_html = ""
            if isinstance(_mi_risks, list) and _mi_risks:
                for r in _mi_risks[:6]:
                    _risk_html += f"<li>{r}</li>"
            elif isinstance(_mi_risks, str) and _mi_risks:
                _risk_html = f"<li>{_mi_risks}</li>"
            else:
                _risk_html = "<li>Integration execution risk</li><li>Regulatory approval uncertainty</li><li>Key talent retention</li>"

            _deal_book_html = f"""<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>{acq_ticker} + {tgt_ticker} Deal Book</title>
<style>
body {{ font-family: 'Inter', 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; color: #1a1a2e; line-height: 1.6; }}
h1 {{ color: #1a1a2e; border-bottom: 3px solid #2563EB; padding-bottom: 0.5rem; font-size: 1.8rem; }}
h2 {{ color: #2563EB; margin-top: 2rem; font-size: 1.3rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.3rem; }}
.header {{ text-align: center; padding: 2rem; background: linear-gradient(135deg, #2563EB, #10B981); color: white; border-radius: 12px; margin-bottom: 2rem; }}
.header h1 {{ color: white; border: none; font-size: 2rem; margin: 0; }}
.header p {{ margin: 0.3rem 0; opacity: 0.9; }}
.metric-grid {{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; }}
.metric {{ background: #f8f9fa; border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid #e9ecef; }}
.metric .label {{ font-size: 0.75rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }}
.metric .value {{ font-size: 1.3rem; font-weight: 700; color: #1a1a2e; }}
.section {{ margin: 1.5rem 0; }}
table {{ width: 100%; border-collapse: collapse; margin: 1rem 0; }}
th, td {{ padding: 0.6rem 1rem; text-align: left; border-bottom: 1px solid #e9ecef; }}
th {{ background: #f8f9fa; font-weight: 600; color: #495057; font-size: 0.85rem; }}
ul {{ padding-left: 1.5rem; }}
li {{ margin-bottom: 0.4rem; }}
.footer {{ text-align: center; color: #adb5bd; font-size: 0.75rem; margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #e9ecef; }}
.accretive {{ color: #10B981; font-weight: 700; }}
.dilutive {{ color: #EF4444; font-weight: 700; }}
</style></head><body>
<div class="header">
<h1>{acq_ticker} + {tgt_ticker}</h1>
<p>Confidential Deal Book â€” M&A Analysis</p>
<p style="font-size:0.8rem;">Generated by Orbital M&A Intelligence Platform</p>
</div>

<h2>1. Executive Summary</h2>
<div class="section">
<p>{_mi_exec}</p>
<div class="metric-grid">
<div class="metric"><div class="label">Transaction Value</div><div class="value">{_deal_ev}</div></div>
<div class="metric"><div class="label">Offer Premium</div><div class="value">{_deal_premium}</div></div>
<div class="metric"><div class="label">EPS Impact</div><div class="value {'accretive' if getattr(pro_forma, 'eps_accretion_pct', 0) >= 0 else 'dilutive'}">{_eps_accretion} ({_eps_status})</div></div>
</div>
</div>

<h2>2. Transaction Overview</h2>
<div class="section">
<table>
<tr><th>Acquirer</th><td>{acq_name} ({acq_ticker})</td></tr>
<tr><th>Target</th><td>{tgt_name} ({tgt_ticker})</td></tr>
<tr><th>Transaction Value</th><td>{_deal_ev}</td></tr>
<tr><th>Offer Premium</th><td>{_deal_premium}</td></tr>
<tr><th>Cash Component</th><td>{_pct_cash}</td></tr>
<tr><th>Stock Component</th><td>{_pct_stock}</td></tr>
<tr><th>Cost of Debt</th><td>{merger_assumptions.cost_of_debt:.1f}%</td></tr>
<tr><th>Tax Rate</th><td>{merger_assumptions.tax_rate:.1f}%</td></tr>
</table>
</div>

<h2>3. Valuation Analysis</h2>
<div class="section">
<p>The transaction implies an offer premium of {_deal_premium} over the target's current market price.
The combined enterprise represents a strategic combination in the {acq_cd.sector or 'N/A'} sector.</p>
<div class="metric-grid">
<div class="metric"><div class="label">Acquirer Mkt Cap</div><div class="value">{format_number(acq_cd.market_cap, currency_symbol=acq_cs)}</div></div>
<div class="metric"><div class="label">Target Mkt Cap</div><div class="value">{format_number(tgt_cd.market_cap, currency_symbol=acq_cs)}</div></div>
<div class="metric"><div class="label">Combined Revenue</div><div class="value">{_pf_rev}</div></div>
</div>
</div>

<h2>4. Synergy Assessment</h2>
<div class="section">
<div class="metric-grid">
<div class="metric"><div class="label">Total Synergies</div><div class="value">{_total_syn}</div></div>
<div class="metric"><div class="label">Revenue Synergies</div><div class="value">{_rev_syn}</div></div>
<div class="metric"><div class="label">Cost Synergies</div><div class="value">{_cost_syn}</div></div>
</div>
<p>{_mi_strategic}</p>
</div>

<h2>5. Pro Forma Impact</h2>
<div class="section">
<table>
<tr><th>Pro Forma Revenue</th><td>{_pf_rev}</td></tr>
<tr><th>Pro Forma EBITDA</th><td>{_pf_ebitda}</td></tr>
<tr><th>EPS Accretion / Dilution</th><td class="{'accretive' if getattr(pro_forma, 'eps_accretion_pct', 0) >= 0 else 'dilutive'}">{_eps_accretion}</td></tr>
</table>
</div>

<h2>6. Risk Factors</h2>
<div class="section">
<ul>{_risk_html}</ul>
</div>

<div class="footer">
<p>This document is for informational purposes only and does not constitute investment advice.<br>
Generated by Orbital M&A Intelligence Platform</p>
</div>
</body></html>"""

            # Display in Streamlit
            st.markdown(
                f'<div style="background:rgba(255,255,255,0.03); border:1px solid rgba(37,99,235,0.2); '
                f'border-radius:12px; padding:1.5rem; margin:1rem 0;">'
                f'<div style="text-align:center; font-size:1.4rem; font-weight:800; color:#F9FAFB; margin-bottom:0.3rem;">'
                f'{acq_ticker} + {tgt_ticker} â€” Deal Book</div>'
                f'<div style="text-align:center; font-size:0.8rem; color:#9CA3AF; margin-bottom:1.5rem;">'
                f'Confidential Â· M&A Analysis Summary</div>'
                f'<div style="font-size:0.9rem; font-weight:700; color:#2563EB; margin-bottom:0.5rem;">Executive Summary</div>'
                f'<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:1rem;">{_mi_exec}</div>'
                f'<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:0.8rem; margin-bottom:1rem;">'
                f'<div style="background:rgba(37,99,235,0.1); border-radius:8px; padding:0.8rem; text-align:center;">'
                f'<div style="font-size:0.65rem; color:#9CA3AF;">Transaction Value</div>'
                f'<div style="font-size:1.1rem; font-weight:700; color:#F9FAFB;">{_deal_ev}</div></div>'
                f'<div style="background:rgba(16,185,129,0.1); border-radius:8px; padding:0.8rem; text-align:center;">'
                f'<div style="font-size:0.65rem; color:#9CA3AF;">Total Synergies</div>'
                f'<div style="font-size:1.1rem; font-weight:700; color:#F9FAFB;">{_total_syn}</div></div>'
                f'<div style="background:rgba(16,185,129,0.1); border-radius:8px; padding:0.8rem; text-align:center;">'
                f'<div style="font-size:0.65rem; color:#9CA3AF;">EPS Impact</div>'
                f'<div style="font-size:1.1rem; font-weight:700; color:{"#10B981" if getattr(pro_forma, "eps_accretion_pct", 0) >= 0 else "#EF4444"};">'
                f'{_eps_accretion}</div></div></div>'
                f'<div style="font-size:0.7rem; color:#6B6B80; text-align:center;">Full deal book available for download below â†“</div>'
                f'</div>',
                unsafe_allow_html=True,
            )

            st.download_button(
                label="ğŸ“¥ Download Deal Book (HTML)",
                data=_deal_book_html,
                file_name=f"{acq_ticker}_{tgt_ticker}_Deal_Book.html",
                mime="text/html",
                use_container_width=True,
                key="deal_book_html_download",
            )

    _divider()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # M12. DOWNLOAD DEAL BOOK
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    _section("Download Deal Book")

    if not os.path.exists("assets/template.pptx"):
        with st.spinner("Creating template..."):
            from create_template import build
            build()

    with st.spinner("Building 10-slide Deal Book..."):
        deal_book_buf = generate_deal_book(acq_cd, tgt_cd, pro_forma, merger_insights, merger_assumptions)

    dl1, dl2, dl3 = st.columns([1, 2, 1])
    with dl2:
        st.download_button(
            label=f"Download {acq_cd.ticker}+{tgt_cd.ticker} Deal Book  (3 slides)",
            data=deal_book_buf,
            file_name=f"{acq_cd.ticker}_{tgt_cd.ticker}_Deal_Book.pptx",
            mime="application/vnd.openxmlformats-officedocument.presentationml.presentation",
            use_container_width=True,
        )
        st.markdown(
            "<p style='text-align:center; font-size:0.72rem; color:#9CA3AF; margin-top:0.3rem;'>"
            "Professional deal book &middot; Pro forma analysis &middot; AI-powered insights"
            "</p>",
            unsafe_allow_html=True,
        )

elif analysis_mode == "Merger Analysis" and merger_btn and (not acquirer_input or not target_input):
    st.warning("âš ï¸ Please enter both **Acquirer** and **Target** ticker symbols in the sidebar to run merger analysis.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DCF VALUATION MODE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
elif analysis_mode == "DCF Valuation" and dcf_btn and dcf_ticker_input:
    st.markdown(
        '<div class="hero-header">'
        '<div class="orbital-brand">'
        f'{_orbital_logo()}'
        '<p class="orbital-tagline">DCF Valuation Analysis</p>'
        '</div>'
        '<span class="hero-tagline">Discounted Cash Flow Model</span>'
        '</div>',
        unsafe_allow_html=True,
    )
    
    with st.status(f"Analyzing {dcf_ticker_input}... Fetching 150+ data points", expanded=True) as _dcf_status:
        st.write("ğŸ“¡ Connecting to market data feeds...")
        try:
            dcf_cd = fetch_company_data(dcf_ticker_input)
            st.write("âœ… Company data loaded")
        except Exception as e:
            _dcf_status.update(label="âŒ Data fetch failed", state="error")
            st.error(f"ğŸ˜• Failed to fetch data for **{dcf_ticker_input}**: {e}")
            st.info("ğŸ’¡ Check the ticker symbol is correct and try again. DCF works best with companies that have positive free cash flow.", icon="ğŸ”§")
            st.stop()
        st.write("ğŸ§® Preparing DCF model inputs...")
        _dcf_status.update(label=f"âœ… {dcf_ticker_input} data ready â€” Building DCF model", state="complete")
    
    cs = dcf_cd.currency_symbol
    
    # Company Header
    st.markdown(
        f'<div class="company-card">'
        f'<div><p class="company-name">{dcf_cd.name}</p>'
        f'<p class="company-meta"><span>{dcf_cd.ticker}</span> &nbsp;&middot;&nbsp; {dcf_cd.sector} &rarr; {dcf_cd.industry}</p></div>'
        f'<div style="margin-top:0.8rem;">'
        f'<span style="font-size:1.5rem; font-weight:700; color:#F9FAFB;">{cs}{dcf_cd.current_price:,.2f}</span>'
        f'</div></div>',
        unsafe_allow_html=True,
    )
    
    # Calculate DCF
    dcf_result = _calculate_dcf(
        dcf_cd,
        growth_rate=dcf_growth_rate,
        terminal_growth=dcf_terminal_growth,
        discount_rate=dcf_discount_rate,
        projection_years=dcf_years
    )
    
    if "error" in dcf_result:
        st.error(f"ğŸ˜• {dcf_result['error']}")
        st.info("ğŸ’¡ DCF requires positive free cash flow data. Try a profitable company or adjust growth assumptions.", icon="ğŸ”§")
    else:
        # DCF Results Summary
        _section("DCF Valuation Results", "ğŸ’°")
        
        # Key metrics
        r1, r2, r3, r4 = st.columns(4)
        r1.metric("Base FCF", format_number(dcf_result["base_fcf"], currency_symbol=cs), help="Starting Free Cash Flow used as the base for projections")
        r2.metric("DCF Enterprise Value", format_number(dcf_result["enterprise_value"], currency_symbol=cs), help="Sum of discounted projected FCFs + terminal value")
        r3.metric("DCF Equity Value", format_number(dcf_result["equity_value"], currency_symbol=cs), help="Enterprise Value minus net debt â€” value attributable to shareholders")
        
        # Implied share price with upside/downside
        upside = dcf_result["upside_pct"]
        upside_color = "#10B981" if upside >= 0 else "#EF4444"
        upside_text = f"+{upside:.1f}%" if upside >= 0 else f"{upside:.1f}%"
        r4.metric("Implied Share Price", f"{cs}{dcf_result['implied_share_price']:,.2f}", delta=upside_text)
        
        _divider()
        
        # Valuation Summary Card
        st.markdown(
            f'<div style="background:linear-gradient(135deg, rgba(37,99,235,0.1), rgba(16,185,129,0.05)); '
            f'border:1px solid rgba(37,99,235,0.25); border-radius:16px; padding:1.5rem; margin:1rem 0;">'
            f'<div style="display:flex; justify-content:space-between; align-items:center;">'
            f'<div>'
            f'<div style="font-size:0.7rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Current Price</div>'
            f'<div style="font-size:1.8rem; font-weight:700; color:#F9FAFB;">{cs}{dcf_result["current_price"]:,.2f}</div>'
            f'</div>'
            f'<div style="font-size:2rem; color:#9CA3AF;">â†’</div>'
            f'<div>'
            f'<div style="font-size:0.7rem; color:#9CA3AF; text-transform:uppercase; letter-spacing:1px;">Implied Value</div>'
            f'<div style="font-size:1.8rem; font-weight:700; color:{upside_color};">{cs}{dcf_result["implied_share_price"]:,.2f}</div>'
            f'</div>'
            f'<div style="background:{"rgba(16,185,129,0.15)" if upside >= 0 else "rgba(239,68,68,0.15)"}; '
            f'padding:0.8rem 1.5rem; border-radius:12px; text-align:center;">'
            f'<div style="font-size:0.7rem; color:#9CA3AF; text-transform:uppercase;">{"Upside" if upside >= 0 else "Downside"}</div>'
            f'<div style="font-size:1.5rem; font-weight:800; color:{upside_color};">{upside_text}</div>'
            f'</div></div></div>',
            unsafe_allow_html=True,
        )
        
        _divider()
        
        # Assumptions Used
        _section("Model Assumptions", "ğŸ“Š")
        a1, a2, a3, a4 = st.columns(4)
        a1.metric("FCF Growth Rate", f"{dcf_result['growth_rate']*100:.1f}%")
        a2.metric("Terminal Growth", f"{dcf_result['terminal_growth']*100:.1f}%")
        a3.metric("Discount Rate (WACC)", f"{dcf_result['discount_rate']*100:.1f}%")
        a4.metric("Projection Years", f"{dcf_result['projection_years']}")

        # â”€â”€ WACC Build-Up Detail â”€â”€
        with _safe_section("WACC Build-Up Detail"):
            _dcf_wacc_data = st.session_state.get("_auto_wacc_data", None)
            if _dcf_wacc_data is None:
                # Calculate from scratch for display
                _dw_beta = dcf_cd.beta if dcf_cd.beta else 1.0
                _dw_rf = 0.0425
                _dw_erp = 0.055
                _dw_ke = _dw_rf + _dw_beta * _dw_erp
                _dw_ie = abs(float(dcf_cd.interest_expense.iloc[0])) if dcf_cd.interest_expense is not None and len(dcf_cd.interest_expense) > 0 else 0
                _dw_td = float(dcf_cd.total_debt.iloc[0]) if dcf_cd.total_debt is not None and len(dcf_cd.total_debt) > 0 else 0
                _dw_kd = (_dw_ie / _dw_td) if _dw_td > 0 else 0.05
                _dw_tp = abs(float(dcf_cd.tax_provision.iloc[0])) if dcf_cd.tax_provision is not None and len(dcf_cd.tax_provision) > 0 else 0
                _dw_oi = float(dcf_cd.operating_income.iloc[0]) if dcf_cd.operating_income is not None and len(dcf_cd.operating_income) > 0 else 0
                _dw_pretax = _dw_oi - _dw_ie
                _dw_tax = (abs(_dw_tp) / abs(_dw_pretax)) if abs(_dw_pretax) > 0 else 0.21
                _dw_tax = max(0, min(_dw_tax, 0.50))
                _dw_mcap = dcf_cd.market_cap or 0
                _dw_ev_calc = _dw_mcap + _dw_td
                _dw_we = (_dw_mcap / _dw_ev_calc) if _dw_ev_calc > 0 else 0.7
                _dw_wd = (_dw_td / _dw_ev_calc) if _dw_ev_calc > 0 else 0.3
                _dw_wacc = _dw_we * _dw_ke + _dw_wd * _dw_kd * (1 - _dw_tax)
                _dcf_wacc_data = {"rf": _dw_rf, "beta": _dw_beta, "erp": _dw_erp, "ke": _dw_ke,
                                  "kd": _dw_kd, "tax_rate": _dw_tax, "we": _dw_we, "wd": _dw_wd,
                                  "wacc": _dw_wacc, "mcap": _dw_mcap, "debt": _dw_td}

            _wacc_build_html = (
                '<div style="background:rgba(37,99,235,0.05); border:1px solid rgba(37,99,235,0.15); '
                'border-radius:12px; padding:1rem; margin-top:0.5rem;">'
                '<div style="font-size:0.72rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
                'letter-spacing:1px; margin-bottom:0.5rem;">WACC Build-Up</div>'
                '<div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3rem 2rem;">'
            )
            _wacc_rows = [
                ("Risk-Free Rate (Rf)", f"{_dcf_wacc_data['rf']*100:.2f}%"),
                ("Equity Risk Premium (ERP)", f"{_dcf_wacc_data['erp']*100:.2f}%"),
                ("Beta (Î²)", f"{_dcf_wacc_data['beta']:.2f}"),
                ("Cost of Equity (Ke = Rf + Î²Ã—ERP)", f"{_dcf_wacc_data['ke']*100:.2f}%"),
                ("Pre-tax Cost of Debt (Kd)", f"{_dcf_wacc_data['kd']*100:.2f}%"),
                ("Effective Tax Rate", f"{_dcf_wacc_data['tax_rate']*100:.1f}%"),
                ("D/E Ratio", f"{(_dcf_wacc_data['wd']/_dcf_wacc_data['we']*100):.0f}%" if _dcf_wacc_data['we'] > 0 else "N/A"),
                ("Equity Weight (E/V)", f"{_dcf_wacc_data['we']*100:.1f}%"),
                ("Debt Weight (D/V)", f"{_dcf_wacc_data['wd']*100:.1f}%"),
            ]
            for _wl, _wv in _wacc_rows:
                _wacc_build_html += (
                    f'<div style="display:flex; justify-content:space-between; padding:0.2rem 0; '
                    f'border-bottom:1px solid rgba(255,255,255,0.03); font-size:0.72rem;">'
                    f'<span style="color:#D1D5DB;">{_wl}</span>'
                    f'<span style="color:#F9FAFB; font-weight:600;">{_wv}</span></div>'
                )
            _wacc_build_html += '</div>'
            _wacc_build_html += (
                f'<div style="display:flex; justify-content:space-between; padding:0.5rem 0; margin-top:0.3rem; '
                f'border-top:2px solid rgba(37,99,235,0.3); font-size:0.82rem;">'
                f'<span style="color:#2563EB; font-weight:700;">WACC = E/VÃ—Ke + D/VÃ—KdÃ—(1-t)</span>'
                f'<span style="color:#2563EB; font-weight:700;">{_dcf_wacc_data["wacc"]*100:.2f}%</span></div>'
                f'</div>'
            )
            st.markdown(_wacc_build_html, unsafe_allow_html=True)
        
        _divider()
        
        # Projected FCF Chart
        _section("Projected Free Cash Flow", "ğŸ“ˆ")
        _build_dcf_chart(dcf_result, currency_symbol=cs, key="dcf_main_chart")
        
        _divider()
        
        # Value Bridge
        _section("Value Bridge", "ğŸŒ‰")
        st.markdown(
            f'<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:1rem;">'
            f'<div style="background:rgba(37,99,235,0.1); border-radius:12px; padding:1rem; text-align:center;">'
            f'<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.3rem;">Sum of PV (FCF)</div>'
            f'<div style="font-size:1.2rem; font-weight:700; color:#2563EB;">{format_number(sum(dcf_result["pv_fcf"]), currency_symbol=cs)}</div></div>'
            f'<div style="background:rgba(16,185,129,0.1); border-radius:12px; padding:1rem; text-align:center;">'
            f'<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.3rem;">PV of Terminal Value</div>'
            f'<div style="font-size:1.2rem; font-weight:700; color:#10B981;">{format_number(dcf_result["pv_terminal"], currency_symbol=cs)}</div></div>'
            f'<div style="background:rgba(245,166,35,0.1); border-radius:12px; padding:1rem; text-align:center;">'
            f'<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.3rem;">Less: Net Debt</div>'
            f'<div style="font-size:1.2rem; font-weight:700; color:#F5A623;">({format_number(abs(dcf_result["net_debt"]), currency_symbol=cs)})</div></div>'
            f'<div style="background:rgba(16,185,129,0.1); border-radius:12px; padding:1rem; text-align:center;">'
            f'<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.3rem;">= Equity Value</div>'
            f'<div style="font-size:1.2rem; font-weight:700; color:#10B981;">{format_number(dcf_result["equity_value"], currency_symbol=cs)}</div></div>'
            f'</div>',
            unsafe_allow_html=True,
        )

        # â”€â”€ Terminal Value % of TEV + Warning â”€â”€
        _tv_pct_of_ev = (dcf_result["pv_terminal"] / dcf_result["enterprise_value"] * 100) if dcf_result["enterprise_value"] > 0 else 0
        _tv_warn = " âš ï¸ TV >75% of TEV â€” model is heavily dependent on terminal assumptions" if _tv_pct_of_ev > 75 else ""
        _tv_color = "#EF4444" if _tv_pct_of_ev > 75 else "#F59E0B" if _tv_pct_of_ev > 60 else "#10B981"
        st.markdown(
            f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); '
            f'border-radius:10px; margin-top:0.8rem; border:1px solid {"rgba(239,68,68,0.3)" if _tv_pct_of_ev > 75 else "rgba(37,99,235,0.15)"};">'
            f'<span style="font-size:0.75rem; color:#9CA3AF;">Terminal Value as % of Enterprise Value: </span>'
            f'<span style="font-size:1.3rem; font-weight:800; color:{_tv_color};">{_tv_pct_of_ev:.1f}%</span>'
            f'<div style="font-size:0.65rem; color:{_tv_color}; margin-top:0.2rem;">{_tv_warn}</div>'
            f'</div>',
            unsafe_allow_html=True,
        )

        # â”€â”€ Implied Perpetuity Growth from Exit Multiple â”€â”€
        try:
            _last_fcf = dcf_result["projected_fcf"][-1]
            _exit_mult = dcf_result["terminal_value"] / _last_fcf if _last_fcf > 0 else 0
            # TV = FCF*(1+g)/(WACC-g) => g = (TV*WACC - FCF) / (TV + FCF)  simplified via algebra
            # From exit multiple: TV = FCF * mult, so mult = (1+g)/(r-g) => g = (mult*r - 1)/(mult + 1)
            _r = dcf_result["discount_rate"]
            if _exit_mult > 0:
                _implied_g = (_exit_mult * _r - 1) / (_exit_mult + 1)
                _ig_reasonable = -0.05 < _implied_g < 0.10
                _ig_color = "#10B981" if _ig_reasonable else "#EF4444"
                st.markdown(
                    f'<div style="text-align:center; padding:0.5rem; margin-top:0.5rem;">'
                    f'<span style="font-size:0.72rem; color:#9CA3AF;">Implied Perpetuity Growth Rate (from terminal multiple {_exit_mult:.1f}x): </span>'
                    f'<span style="font-size:1.1rem; font-weight:700; color:{_ig_color};">{_implied_g*100:.2f}%</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
        except Exception:
            pass

        # â”€â”€ Enterprise Value â†’ Equity Value Waterfall Chart â”€â”€
        with _safe_section("EV to Equity Bridge"):
            _dcf_gross_debt = 0
            _dcf_cash = 0
            if dcf_cd.total_debt is not None and len(dcf_cd.total_debt) > 0:
                _dcf_gross_debt = float(dcf_cd.total_debt.iloc[0])
            if dcf_cd.cash_and_equivalents is not None and len(dcf_cd.cash_and_equivalents) > 0:
                _dcf_cash = float(dcf_cd.cash_and_equivalents.iloc[0])
            fig_ev_bridge = go.Figure(go.Waterfall(
                x=["Enterprise Value", "Less: Gross Debt", "Plus: Cash", "Equity Value"],
                y=[dcf_result["enterprise_value"], -_dcf_gross_debt, _dcf_cash, 0],
                measure=["absolute", "relative", "relative", "total"],
                connector=dict(line=dict(color="rgba(37,99,235,0.3)", width=1)),
                increasing=dict(marker_color="#10B981"),
                decreasing=dict(marker_color="#EF4444"),
                totals=dict(marker_color="#2563EB"),
                text=[format_number(dcf_result["enterprise_value"], currency_symbol=cs),
                      f"({format_number(_dcf_gross_debt, currency_symbol=cs)})",
                      format_number(_dcf_cash, currency_symbol=cs),
                      format_number(dcf_result["equity_value"], currency_symbol=cs)],
                textposition="outside",
                textfont=dict(size=10, color="#D1D5DB"),
            ))
            fig_ev_bridge.update_layout(
                **_CHART_LAYOUT_BASE, height=350,
                margin=dict(t=30, b=40, l=50, r=30),
                yaxis=dict(tickprefix=cs, tickfont=dict(size=9, color="#9CA3AF"), showgrid=True,
                           gridcolor="rgba(255,255,255,0.05)"),
                xaxis=dict(tickfont=dict(size=10, color="#D1D5DB")),
                showlegend=False,
            )
            _apply_space_grid(fig_ev_bridge)
            st.plotly_chart(fig_ev_bridge, use_container_width=True, key="dcf_ev_bridge_waterfall")
        
        _divider()
        
        # Sensitivity Analysis
        _section("Sensitivity Analysis", "ğŸ“")
        st.markdown(
            '<div style="font-size:0.85rem; color:#D1D5DB; margin-bottom:1rem;">'
            'How does the implied share price change with different growth and discount rate assumptions?'
            '</div>',
            unsafe_allow_html=True,
        )
        
        st.markdown("**DCF Sensitivity Heatmap â€” Discount Rate vs Terminal Growth**")
        _build_dcf_sensitivity(dcf_cd, dcf_result, key="dcf_sens_matrix")
        
        st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
        st.markdown("**Terminal Growth Impact (Line Chart)**")
        _build_terminal_value_sensitivity(dcf_cd, dcf_result, key="dcf_tv_sens")
        
        _divider()
        
        # DCF Assumptions Audit
        with _safe_section("DCF Assumptions Audit"):
            _build_dcf_assumptions_audit(dcf_cd, dcf_result)
        
        _divider()
        
        # Reverse DCF
        _section("Reverse DCF â€” Implied Growth Rate", "ğŸ”„")
        st.markdown(
            '<div style="font-size:0.85rem; color:#D1D5DB; margin-bottom:1rem;">'
            'What FCF growth rate does the market currently imply at the current share price?'
            '</div>',
            unsafe_allow_html=True,
        )
        
        try:
            target_price = dcf_result["current_price"]
            shares = dcf_result.get("shares_outstanding", 1)
            target_equity = target_price * shares
            net_debt = dcf_result["net_debt"]
            target_ev = target_equity + net_debt
            base_fcf = dcf_result["base_fcf"]
            wacc = dcf_result["discount_rate"]
            tg = dcf_result["terminal_growth"]
            years = dcf_result["projection_years"]
            
            # Binary search for implied growth rate
            low_g, high_g = -0.10, 0.40
            implied_growth = None
            for _ in range(50):  # Binary search iterations
                mid_g = (low_g + high_g) / 2
                fcf = base_fcf
                pv_sum = 0
                for yr in range(1, years + 1):
                    fcf = fcf * (1 + mid_g)
                    pv_sum += fcf / (1 + wacc) ** yr
                
                if wacc > tg:
                    tv = (fcf * (1 + tg)) / (wacc - tg)
                    pv_tv = tv / (1 + wacc) ** years
                else:
                    pv_tv = 0
                
                calc_ev = pv_sum + pv_tv
                
                if calc_ev < target_ev:
                    low_g = mid_g
                else:
                    high_g = mid_g
                
                if abs(calc_ev - target_ev) / target_ev < 0.001:
                    implied_growth = mid_g
                    break
            
            if implied_growth is None:
                implied_growth = (low_g + high_g) / 2
            
            ig_pct = implied_growth * 100
            model_g_pct = dcf_result["growth_rate"] * 100
            
            ig_color = "#10B981" if ig_pct < model_g_pct else "#EF4444"
            verdict = "Market expects LESS growth than your model â†’ potentially undervalued" if ig_pct < model_g_pct else "Market expects MORE growth than your model â†’ potentially overvalued"
            
            rdcf_c1, rdcf_c2, rdcf_c3 = st.columns(3)
            rdcf_c1.metric("Your Growth Assumption", f"{model_g_pct:.1f}%")
            rdcf_c2.metric("Market-Implied Growth", f"{ig_pct:.1f}%")
            rdcf_c3.metric("Difference", f"{ig_pct - model_g_pct:+.1f}%")
            
            st.markdown(
                f'<div style="text-align:center; padding:0.6rem; background:rgba(37,99,235,0.05); '
                f'border-radius:10px; margin-top:0.5rem;">'
                f'<span style="font-size:0.8rem; color:{ig_color}; font-weight:600;">{verdict}</span>'
                f'</div>',
                unsafe_allow_html=True,
            )
        except Exception:
            st.info("Could not calculate reverse DCF.")
        
        _divider()
        
        # Monte Carlo Simulation
        _section("Monte Carlo Simulation", "ğŸ²")
        st.markdown(
            '<div style="font-size:0.85rem; color:#D1D5DB; margin-bottom:1rem;">'
            '1,000 simulations with randomized growth rate, WACC, and terminal multiple to generate a probability distribution of fair value.'
            '</div>',
            unsafe_allow_html=True,
        )
        
        if st.button("â–¶ Run Monte Carlo Simulation", key="mc_run_btn", type="primary"):
          _mc_status_slot = st.empty()
          _mc_status_slot.info("ğŸ² Running 1,000 simulations â€” randomizing growth, WACC & terminal multiples...")
          try:
            n_sims = 1000
            base_growth = dcf_result["growth_rate"]
            base_wacc = dcf_result["discount_rate"]
            base_fcf = dcf_result["base_fcf"]
            term_growth = dcf_result["terminal_growth"]
            years = dcf_result["projection_years"]
            shares = dcf_result.get("shares_outstanding", 1)
            net_debt = dcf_result["net_debt"]
            
            mc_results = []
            for _ in range(n_sims):
                sim_growth = np.random.normal(base_growth, 0.03)  # Â±3% std
                sim_wacc = np.random.normal(base_wacc, 0.015)  # Â±1.5% std
                sim_wacc = max(sim_wacc, 0.04)  # Floor at 4%
                sim_terminal_multiple = np.random.normal(15, 3)  # Terminal EV/FCF multiple
                sim_terminal_multiple = max(sim_terminal_multiple, 5)  # Floor at 5x
                
                # Project FCF
                sim_fcfs = []
                fcf = base_fcf
                for yr in range(1, years + 1):
                    fcf = fcf * (1 + sim_growth)
                    sim_fcfs.append(fcf / (1 + sim_wacc) ** yr)
                
                # Terminal value using exit multiple approach
                tv = fcf * sim_terminal_multiple
                pv_tv = tv / (1 + sim_wacc) ** years
                
                ev = sum(sim_fcfs) + pv_tv
                eq = ev - net_debt
                price = eq / shares if shares > 0 else 0
                mc_results.append(price)
            
            mc_results = [p for p in mc_results if 0 < p < dcf_result["implied_share_price"] * 5]
            _mc_status_slot.success(f"âœ… {len(mc_results):,} simulations complete")
            
            if mc_results:
                mc_arr = np.array(mc_results)
                p5 = np.percentile(mc_arr, 5)
                p10 = np.percentile(mc_arr, 10)
                p25 = np.percentile(mc_arr, 25)
                p50 = np.percentile(mc_arr, 50)
                p75 = np.percentile(mc_arr, 75)
                p90 = np.percentile(mc_arr, 90)
                
                # Stats
                mc_c1, mc_c2, mc_c3, mc_c4, mc_c5 = st.columns(5)
                mc_c1.metric("10th %ile", f"{cs}{p10:,.2f}")
                mc_c2.metric("25th %ile", f"{cs}{p25:,.2f}")
                mc_c3.metric("Median", f"{cs}{p50:,.2f}")
                mc_c4.metric("75th %ile", f"{cs}{p75:,.2f}")
                mc_c5.metric("90th %ile", f"{cs}{p90:,.2f}")
                
                # Histogram
                fig_mc = go.Figure()
                fig_mc.add_trace(go.Histogram(
                    x=mc_results, nbinsx=50,
                    marker_color="rgba(37,99,235,0.5)",
                    marker_line=dict(color="rgba(37,99,235,0.8)", width=1),
                ))
                # Add current price line
                fig_mc.add_vline(x=dcf_result["current_price"], line_dash="dash",
                                line_color="#EF4444", line_width=2,
                                annotation_text=f"Current: {cs}{dcf_result['current_price']:,.2f}",
                                annotation_font=dict(size=10, color="#EF4444"))
                # Add median line
                fig_mc.add_vline(x=p50, line_dash="dash",
                                line_color="#10B981", line_width=2,
                                annotation_text=f"Median: {cs}{p50:,.2f}",
                                annotation_font=dict(size=10, color="#10B981"),
                                annotation_position="top left")
                
                fig_mc.update_layout(
                    **_CHART_LAYOUT_BASE, height=350,
                    margin=dict(t=30, b=40, l=50, r=30),
                    xaxis=dict(title=dict(text="Implied Share Price", font=dict(size=11, color="#9CA3AF")),
                              tickprefix=cs, tickfont=dict(size=10, color="#9CA3AF"), showgrid=False),
                    yaxis=dict(title=dict(text="Frequency", font=dict(size=11, color="#9CA3AF")),
                              tickfont=dict(size=10, color="#9CA3AF")),
                    showlegend=False,
                    bargap=0.05,
                )
                _apply_space_grid(fig_mc)
                st.plotly_chart(fig_mc, use_container_width=True, key="mc_simulation")
                
                # Probability of upside
                upside_prob = sum(1 for p in mc_results if p > dcf_result["current_price"]) / len(mc_results) * 100
                prob_color = "#10B981" if upside_prob > 60 else "#EF4444" if upside_prob < 40 else "#F59E0B"
                st.markdown(
                    f'<div style="text-align:center; padding:0.8rem; background:rgba(37,99,235,0.05); '
                    f'border-radius:12px; margin-top:0.5rem;">'
                    f'<span style="font-size:0.75rem; color:#9CA3AF;">Probability stock is undervalued: </span>'
                    f'<span style="font-size:1.3rem; font-weight:800; color:{prob_color};">{upside_prob:.0f}%</span>'
                    f'<div style="font-size:0.6rem; color:#9CA3AF; margin-top:0.2rem;">'
                    f'Based on {len(mc_results):,} simulations (growth Â±3%, WACC Â±1.5%, terminal multiple ~15xÂ±3)</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
                
                # VaR-style metric
                st.markdown(
                    f'<div style="text-align:center; padding:0.6rem; background:rgba(16,185,129,0.06); '
                    f'border-radius:10px; margin-top:0.5rem; border:1px solid rgba(16,185,129,0.15);">'
                    f'<span style="font-size:0.75rem; color:#9CA3AF;">95% confidence the intrinsic value is above </span>'
                    f'<span style="font-size:1.2rem; font-weight:800; color:#10B981;">{cs}{p5:,.2f}</span>'
                    f'</div>',
                    unsafe_allow_html=True,
                )
          except Exception:
            st.info("Could not run Monte Carlo simulation.")
        
        _divider()

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # LBO MODEL (Leveraged Buyout)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        with _safe_section("LBO Model"):
            _section("Simple LBO Model", "ğŸ¦")
            st.markdown(
                '<div style="font-size:0.85rem; color:#D1D5DB; margin-bottom:1rem;">'
                'Leveraged buyout returns analysis â€” estimate equity IRR and MOIC under an LBO scenario.'
                '</div>',
                unsafe_allow_html=True,
            )
            try:
                _lbo_ebitda_val = None
                if dcf_result.get("base_fcf") and dcf_result["base_fcf"] > 0:
                    _lbo_ebitda_val = dcf_result["base_fcf"]
                if hasattr(cd, 'ebitda'):
                    _eb = cd.ebitda
                    if hasattr(_eb, 'iloc') and len(_eb) > 0:
                        _lbo_ebitda_val = float(_eb.iloc[0])
                    elif isinstance(_eb, (int, float)) and _eb > 0:
                        _lbo_ebitda_val = float(_eb)

                if _lbo_ebitda_val and _lbo_ebitda_val > 0:
                    with st.expander("ğŸ¦ LBO Analysis", expanded=False):
                        _lbo_c1, _lbo_c2, _lbo_c3 = st.columns(3)
                        with _lbo_c1:
                            lbo_entry_mult = st.number_input("Entry EV/EBITDA", 4.0, 25.0, 10.0, 0.5, key="lbo_entry_mult")
                            lbo_hold = st.number_input("Hold Period (yrs)", 3, 10, 5, 1, key="lbo_hold")
                        with _lbo_c2:
                            lbo_debt_pct = st.slider("Debt %", 30, 80, 60, 5, key="lbo_debt_pct") / 100.0
                            lbo_int_rate = st.number_input("Interest Rate (%)", 2.0, 15.0, 6.0, 0.5, key="lbo_int_rate") / 100.0
                        with _lbo_c3:
                            lbo_exit_mult = st.number_input("Exit EV/EBITDA", 4.0, 25.0, lbo_entry_mult, 0.5, key="lbo_exit_mult")
                            lbo_ebitda_growth = st.number_input("EBITDA Growth (%/yr)", -5.0, 20.0, 5.0, 1.0, key="lbo_ebitda_gr") / 100.0

                        # LBO Calculations
                        lbo_entry_ev = _lbo_ebitda_val * lbo_entry_mult
                        lbo_entry_debt = lbo_entry_ev * lbo_debt_pct
                        lbo_entry_equity = lbo_entry_ev * (1 - lbo_debt_pct)

                        # Annual projection: EBITDA grows, FCF pays down debt
                        _lbo_debt_remaining = lbo_entry_debt
                        _lbo_ebitda_yr = _lbo_ebitda_val
                        _lbo_annual = []
                        for yr in range(1, lbo_hold + 1):
                            _lbo_ebitda_yr *= (1 + lbo_ebitda_growth)
                            _lbo_interest = _lbo_debt_remaining * lbo_int_rate
                            _lbo_fcf = _lbo_ebitda_yr * 0.5 - _lbo_interest  # assume ~50% EBITDA-to-FCF conversion
                            _lbo_paydown = max(0, _lbo_fcf)
                            _lbo_debt_remaining = max(0, _lbo_debt_remaining - _lbo_paydown)
                            _lbo_annual.append({
                                "year": yr, "ebitda": _lbo_ebitda_yr, "interest": _lbo_interest,
                                "fcf": _lbo_fcf, "paydown": _lbo_paydown, "debt": _lbo_debt_remaining
                            })

                        lbo_exit_ev = _lbo_ebitda_yr * lbo_exit_mult
                        lbo_exit_equity = lbo_exit_ev - _lbo_debt_remaining
                        lbo_moic = lbo_exit_equity / lbo_entry_equity if lbo_entry_equity > 0 else 0
                        lbo_total_debt_paydown = lbo_entry_debt - _lbo_debt_remaining

                        # IRR calculation
                        try:
                            _lbo_cashflows = [-lbo_entry_equity] + [0] * (lbo_hold - 1) + [lbo_exit_equity]
                            lbo_irr = np.irr(_lbo_cashflows) if hasattr(np, 'irr') else None
                            if lbo_irr is None:
                                import numpy_financial as npf
                                lbo_irr = npf.irr(_lbo_cashflows)
                        except Exception:
                            lbo_irr = (lbo_moic ** (1.0 / lbo_hold) - 1) if lbo_moic > 0 and lbo_hold > 0 else 0

                        # Display metrics
                        _lm1, _lm2, _lm3, _lm4 = st.columns(4)
                        _lm1.metric("Entry Equity", f"{cs}{lbo_entry_equity / 1e9:.2f}B" if lbo_entry_equity > 1e9 else f"{cs}{lbo_entry_equity / 1e6:.0f}M")
                        _lm2.metric("Exit Equity", f"{cs}{lbo_exit_equity / 1e9:.2f}B" if lbo_exit_equity > 1e9 else f"{cs}{lbo_exit_equity / 1e6:.0f}M")
                        _lm3.metric("MOIC", f"{lbo_moic:.2f}x")
                        _irr_color = "#10B981" if lbo_irr and lbo_irr > 0.20 else "#F59E0B" if lbo_irr and lbo_irr > 0.10 else "#EF4444"
                        _lm4.metric("IRR", f"{lbo_irr * 100:.1f}%" if lbo_irr else "N/A")

                        # Waterfall chart
                        _lbo_wf_labels = ["Entry Equity", "EBITDA Growth", "Multiple Expansion", "Debt Paydown", "Exit Equity"]
                        _ebitda_growth_val = (lbo_exit_mult * (_lbo_ebitda_yr - _lbo_ebitda_val))
                        _mult_expansion_val = (_lbo_ebitda_yr * (lbo_exit_mult - lbo_entry_mult))
                        _lbo_wf_values = [lbo_entry_equity, _ebitda_growth_val, _mult_expansion_val, lbo_total_debt_paydown, 0]
                        _lbo_wf_measures = ["absolute", "relative", "relative", "relative", "total"]

                        fig_lbo_wf = go.Figure(go.Waterfall(
                            x=_lbo_wf_labels, y=_lbo_wf_values, measure=_lbo_wf_measures,
                            connector=dict(line=dict(color="rgba(138,133,173,0.3)", width=1)),
                            increasing=dict(marker=dict(color="#10B981")),
                            decreasing=dict(marker=dict(color="#EF4444")),
                            totals=dict(marker=dict(color="#2563EB")),
                            textposition="outside",
                            text=[f"{cs}{v / 1e9:.2f}B" if abs(v) > 1e9 else f"{cs}{v / 1e6:.0f}M" for v in
                                  [lbo_entry_equity, _ebitda_growth_val, _mult_expansion_val, lbo_total_debt_paydown, lbo_exit_equity]],
                            textfont=dict(size=10, color="#F9FAFB"),
                        ))
                        fig_lbo_wf.update_layout(
                            **_CHART_LAYOUT_BASE, height=350,
                            margin=dict(t=30, b=40, l=50, r=30),
                            yaxis=dict(tickprefix=cs, tickfont=dict(size=10, color="#9CA3AF"), showgrid=True,
                                      gridcolor="rgba(255,255,255,0.05)"),
                            xaxis=dict(tickfont=dict(size=10, color="#D1D5DB")),
                            showlegend=False,
                        )
                        _apply_space_grid(fig_lbo_wf)
                        st.plotly_chart(fig_lbo_wf, use_container_width=True, key="lbo_waterfall")

                        # Sensitivity matrix: IRR vs Entry Multiple vs Exit Multiple
                        st.markdown(
                            '<div style="font-size:0.8rem; color:#D1D5DB; margin-top:1rem; margin-bottom:0.5rem;">'
                            '<b>IRR Sensitivity Matrix</b> â€” Entry Multiple vs Exit Multiple</div>',
                            unsafe_allow_html=True,
                        )
                        _entry_range = [lbo_entry_mult + d for d in [-2, -1, 0, 1, 2]]
                        _exit_range = [lbo_exit_mult + d for d in [-2, -1, 0, 1, 2]]
                        _irr_matrix = []
                        for em in _entry_range:
                            row = []
                            for xm in _exit_range:
                                _e_ev = _lbo_ebitda_val * em
                                _e_eq = _e_ev * (1 - lbo_debt_pct)
                                _e_debt = _e_ev * lbo_debt_pct
                                _d_rem = _e_debt
                                _eb_y = _lbo_ebitda_val
                                for _ in range(lbo_hold):
                                    _eb_y *= (1 + lbo_ebitda_growth)
                                    _int = _d_rem * lbo_int_rate
                                    _fcf_y = _eb_y * 0.5 - _int
                                    _d_rem = max(0, _d_rem - max(0, _fcf_y))
                                _x_ev = _eb_y * xm
                                _x_eq = _x_ev - _d_rem
                                _m = _x_eq / _e_eq if _e_eq > 0 else 0
                                _i = (_m ** (1.0 / lbo_hold) - 1) if _m > 0 and lbo_hold > 0 else -1
                                row.append(_i * 100)
                            _irr_matrix.append(row)

                        fig_irr_heat = go.Figure(data=go.Heatmap(
                            z=_irr_matrix,
                            x=[f"{x:.1f}x" for x in _exit_range],
                            y=[f"{e:.1f}x" for e in _entry_range],
                            text=[[f"{v:.1f}%" for v in row] for row in _irr_matrix],
                            texttemplate="%{text}", textfont=dict(size=10, color="#F9FAFB"),
                            colorscale=[[0, "#EF4444"], [0.5, "#F59E0B"], [1, "#10B981"]],
                            colorbar=dict(title=dict(text="IRR %", font=dict(size=10, color="#9CA3AF")),
                                         tickfont=dict(size=9, color="#9CA3AF")),
                        ))
                        fig_irr_heat.update_layout(
                            **_CHART_LAYOUT_BASE, height=320,
                            margin=dict(t=30, b=50, l=60, r=30),
                            xaxis=dict(title=dict(text="Exit Multiple", font=dict(size=11, color="#9CA3AF")),
                                      tickfont=dict(size=10, color="#D1D5DB")),
                            yaxis=dict(title=dict(text="Entry Multiple", font=dict(size=11, color="#9CA3AF")),
                                      tickfont=dict(size=10, color="#D1D5DB")),
                        )
                        st.plotly_chart(fig_irr_heat, use_container_width=True, key="lbo_irr_sensitivity")
            except Exception as e:
                st.info(f"LBO model requires EBITDA data. {str(e)[:80]}")

        _divider()

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # SCENARIO ANALYSIS (Bull / Base / Bear)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        with _safe_section("Scenario Analysis"):
            _section("Scenario Analysis", "ğŸ“Š")

            st.markdown(
                '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                'Three scenarios with different growth and discount rate assumptions.</div>',
                unsafe_allow_html=True,
            )

            scenarios = {
                "ğŸ» Bear": {"growth": max(dcf_growth_rate - 0.03, 0.0), "wacc": dcf_discount_rate + 0.015, "weight": 0.25},
                "ğŸ“Š Base": {"growth": dcf_growth_rate, "wacc": dcf_discount_rate, "weight": 0.50},
                "ğŸ‚ Bull": {"growth": dcf_growth_rate + 0.03, "wacc": max(dcf_discount_rate - 0.01, dcf_terminal_growth + 0.01), "weight": 0.25},
            }

            scen_results = {}
            for name, params in scenarios.items():
                try:
                    scen_dcf = _calculate_dcf(dcf_cd, growth_rate=params["growth"],
                                               terminal_growth=dcf_terminal_growth,
                                               discount_rate=params["wacc"],
                                               projection_years=dcf_years)
                    scen_results[name] = {**scen_dcf, "weight": params["weight"],
                                          "growth": params["growth"], "wacc": params["wacc"]}
                except Exception:
                    pass

            if scen_results:
                scen_cols = st.columns(len(scen_results))
                for col, (name, res) in zip(scen_cols, scen_results.items()):
                    with col:
                        if "error" not in res:
                            price = res["implied_share_price"]
                            upside = res["upside_pct"]
                            color = "#10B981" if upside > 0 else "#EF4444"
                            st.markdown(
                                f'<div style="text-align:center; padding:0.8rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); '
                                f'border-radius:10px; border-top:3px solid {color};">'
                                f'<div style="font-size:0.7rem; font-weight:700; color:#9CA3AF;">{name}</div>'
                                f'<div style="font-size:1.5rem; font-weight:800; color:{color};">{cs}{price:,.2f}</div>'
                                f'<div style="font-size:0.8rem; color:{color};">{upside:+.1f}%</div>'
                                f'<div style="font-size:0.65rem; color:#9CA3AF; margin-top:0.4rem;">'
                                f'Growth: {res["growth"]:.0%} | WACC: {res["wacc"]:.0%}</div>'
                                f'<div style="font-size:0.6rem; color:#9CA3AF;">Weight: {res["weight"]:.0%}</div>'
                                f'</div>',
                                unsafe_allow_html=True,
                            )

                # Probability-weighted fair value
                weighted_price = sum(
                    r.get("implied_share_price", 0) * r.get("weight", 0)
                    for r in scen_results.values() if "error" not in r
                )
                weighted_upside = ((weighted_price / dcf_cd.current_price) - 1) * 100 if dcf_cd.current_price else 0
                w_color = "#10B981" if weighted_upside > 0 else "#EF4444"

                st.markdown(
                    f'<div style="text-align:center; padding:1rem; margin-top:0.8rem; '
                    f'background:rgba(37,99,235,0.06); border:1px solid rgba(37,99,235,0.15); border-radius:12px;">'
                    f'<div style="font-size:0.65rem; font-weight:700; color:#2563EB; text-transform:uppercase; '
                    f'letter-spacing:1.5px;">Probability-Weighted Fair Value</div>'
                    f'<div style="font-size:2rem; font-weight:800; color:{w_color};">{cs}{weighted_price:,.2f}</div>'
                    f'<div style="font-size:0.9rem; color:{w_color};">{weighted_upside:+.1f}% vs Current ({cs}{dcf_cd.current_price:,.2f})</div>'
                    f'</div>',
                    unsafe_allow_html=True,
                )

                # Scenario comparison bar chart
                fig_scen = go.Figure()
                scen_names = list(scen_results.keys())
                scen_prices = [scen_results[n].get("implied_share_price", 0) for n in scen_names if "error" not in scen_results[n]]
                scen_colors = ["#EF4444", "#2563EB", "#10B981"][:len(scen_prices)]
                fig_scen.add_trace(go.Bar(
                    x=scen_names[:len(scen_prices)], y=scen_prices,
                    marker_color=scen_colors,
                    text=[f"{cs}{p:,.2f}" for p in scen_prices],
                    textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
                ))
                fig_scen.add_hline(y=dcf_cd.current_price, line_dash="dash",
                                   line_color="rgba(255,255,255,0.3)",
                                   annotation_text=f"Current: {cs}{dcf_cd.current_price:,.2f}",
                                   annotation_font=dict(size=10, color="#9CA3AF"))
                fig_scen.update_layout(**_CHART_LAYOUT_BASE, height=300,
                                       margin=dict(t=30, b=30, l=50, r=30), showlegend=False,
                                       xaxis=dict(tickfont=dict(size=10, color="#9CA3AF")),
                                       yaxis=dict(tickprefix=cs, tickfont=dict(size=9, color="#9CA3AF")))
                _apply_space_grid(fig_scen)
                st.plotly_chart(fig_scen, use_container_width=True, key="scenario_chart")

            # â”€â”€ Custom Scenario Builder â”€â”€
            st.markdown(
                '<div style="font-size:1rem; font-weight:700; color:#F9FAFB; margin:1.5rem 0 0.8rem 0;">'
                'ğŸ”§ Custom Scenario Builder</div>'
                '<div style="font-size:0.78rem; color:#D1D5DB; margin-bottom:1rem;">'
                'Input your own assumptions to calculate an implied share price.</div>',
                unsafe_allow_html=True,
            )
            _cs_c1, _cs_c2, _cs_c3 = st.columns(3)
            with _cs_c1:
                _cs_growth = st.number_input("Revenue Growth (%)", min_value=-30.0, max_value=50.0,
                                              value=round(dcf_growth_rate * 100, 1), step=0.5, key="custom_scen_growth") / 100
            with _cs_c2:
                _cs_margin = st.number_input("EBITDA Margin (%)", min_value=0.0, max_value=80.0,
                                              value=20.0, step=1.0, key="custom_scen_margin") / 100
            with _cs_c3:
                _cs_multiple = st.number_input("Exit EV/EBITDA", min_value=1.0, max_value=50.0,
                                                value=float(dcf_cd.ev_to_ebitda or 12), step=0.5, key="custom_scen_mult")
            _cs_c4, _cs_c5, _cs_c6 = st.columns(3)
            with _cs_c4:
                _cs_wacc = st.number_input("Discount Rate (%)", min_value=1.0, max_value=25.0,
                                            value=round(dcf_discount_rate * 100, 1), step=0.5, key="custom_scen_wacc") / 100
            with _cs_c5:
                _cs_years = st.number_input("Projection Years", min_value=1, max_value=10,
                                             value=dcf_years, step=1, key="custom_scen_years")
            with _cs_c6:
                _cs_prob = st.number_input("Probability (%)", min_value=0, max_value=100,
                                            value=100, step=5, key="custom_scen_prob")

            # Calculate custom scenario
            try:
                _cs_result = _calculate_dcf(
                    dcf_cd,
                    growth_rate=_cs_growth,
                    terminal_growth=dcf_terminal_growth,
                    discount_rate=_cs_wacc,
                    projection_years=_cs_years,
                )
                if "error" not in _cs_result:
                    _cs_price = _cs_result["implied_share_price"]
                    _cs_upside = _cs_result["upside_pct"]
                    _cs_ev = _cs_price * (dcf_cd.shares_outstanding or (dcf_cd.market_cap / dcf_cd.current_price if dcf_cd.current_price else 1))
                    _cs_u_color = "#10B981" if _cs_upside >= 0 else "#EF4444"
                    _cs_exp_val = _cs_price * (_cs_prob / 100)

                    _csr1, _csr2, _csr3 = st.columns(3)
                    _csr1.metric("Implied Price", f"{cs}{_cs_price:,.2f}", delta=f"{_cs_upside:+.1f}%")
                    _csr2.metric("Probability-Weighted", f"{cs}{_cs_exp_val:,.2f}")
                    _csr3.metric("Upside/Downside", f"{_cs_upside:+.1f}%")

                    # Compare all scenarios including custom
                    if scen_results:
                        _all_scen_names = list(scen_results.keys()) + ["ğŸ”§ Custom"]
                        _all_scen_prices = [scen_results[n].get("implied_share_price", 0) for n in scen_results if "error" not in scen_results[n]] + [_cs_price]
                        _all_scen_colors = ["#EF4444", "#2563EB", "#10B981", "#F59E0B"][:len(_all_scen_prices)]
                        _cs_fig = go.Figure()
                        _cs_fig.add_trace(go.Bar(
                            x=_all_scen_names[:len(_all_scen_prices)], y=_all_scen_prices,
                            marker_color=_all_scen_colors,
                            text=[f"{cs}{p:,.2f}" for p in _all_scen_prices],
                            textposition="outside", textfont=dict(size=10, color="#D1D5DB"),
                        ))
                        _cs_fig.add_hline(y=dcf_cd.current_price, line_dash="dash",
                                          line_color="#F59E0B", line_width=2,
                                          annotation_text=f"Current: {cs}{dcf_cd.current_price:,.2f}",
                                          annotation_font=dict(size=9, color="#F59E0B"))
                        _cs_fig.update_layout(**_CHART_LAYOUT_BASE, height=280,
                                              margin=dict(t=30, b=30, l=50, r=30), showlegend=False,
                                              xaxis=dict(tickfont=dict(size=9, color="#9CA3AF")),
                                              yaxis=dict(tickprefix=cs, tickfont=dict(size=9, color="#9CA3AF")))
                        _apply_space_grid(_cs_fig)
                        st.plotly_chart(_cs_fig, use_container_width=True, key="custom_scenario_chart")
            except Exception:
                pass

        _divider()
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # WACC CALCULATOR BREAKDOWN
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        with _safe_section("WACC Calculator"):
            _section("WACC Calculator", "ğŸ§®")
            
            _wacc_data = st.session_state.get("_auto_wacc_data", None)
            
            # Calculate WACC components from dcf_cd
            if _wacc_data is None:
                # Compute from scratch
                _wc_beta = dcf_cd.beta if dcf_cd.beta else 1.0
                _wc_rf = 0.0425
                _wc_erp = 0.055
                _wc_ke = _wc_rf + _wc_beta * _wc_erp
                
                _wc_ie = abs(float(dcf_cd.interest_expense.iloc[0])) if dcf_cd.interest_expense is not None and len(dcf_cd.interest_expense) > 0 else 0
                _wc_td = float(dcf_cd.total_debt.iloc[0]) if dcf_cd.total_debt is not None and len(dcf_cd.total_debt) > 0 else 0
                _wc_kd = (_wc_ie / _wc_td) if _wc_td > 0 else 0.05
                
                _wc_tp = abs(float(dcf_cd.tax_provision.iloc[0])) if dcf_cd.tax_provision is not None and len(dcf_cd.tax_provision) > 0 else 0
                _wc_oi = float(dcf_cd.operating_income.iloc[0]) if dcf_cd.operating_income is not None and len(dcf_cd.operating_income) > 0 else 0
                _wc_pretax = _wc_oi - _wc_ie
                _wc_tax = (abs(_wc_tp) / abs(_wc_pretax)) if abs(_wc_pretax) > 0 else 0.21
                _wc_tax = max(0, min(_wc_tax, 0.50))
                
                _wc_mcap = dcf_cd.market_cap or 0
                _wc_ev = _wc_mcap + _wc_td
                _wc_we = (_wc_mcap / _wc_ev) if _wc_ev > 0 else 0.7
                _wc_wd = (_wc_td / _wc_ev) if _wc_ev > 0 else 0.3
                _wc_wacc = _wc_we * _wc_ke + _wc_wd * _wc_kd * (1 - _wc_tax)
                
                _wacc_data = {
                    "rf": _wc_rf, "beta": _wc_beta, "erp": _wc_erp, "ke": _wc_ke,
                    "kd": _wc_kd, "tax_rate": _wc_tax, "we": _wc_we, "wd": _wc_wd,
                    "wacc": _wc_wacc, "mcap": _wc_mcap, "debt": _wc_td,
                }
            
            # Breakdown table
            wacc_items = [
                ("Risk-Free Rate (Rf)", f"{_wacc_data['rf']*100:.2f}%"),
                ("Beta (Î²)", f"{_wacc_data['beta']:.2f}"),
                ("Equity Risk Premium", f"{_wacc_data['erp']*100:.2f}%"),
                ("Cost of Equity (Ke)", f"{_wacc_data['ke']*100:.2f}%"),
                ("Cost of Debt (Kd)", f"{_wacc_data['kd']*100:.2f}%"),
                ("Tax Rate", f"{_wacc_data['tax_rate']*100:.1f}%"),
                ("Equity Weight (E/V)", f"{_wacc_data['we']*100:.1f}%"),
                ("Debt Weight (D/V)", f"{_wacc_data['wd']*100:.1f}%"),
                ("WACC", f"{_wacc_data['wacc']*100:.2f}%"),
            ]
            
            wc_c1, wc_c2 = st.columns([1, 1])
            
            with wc_c1:
                for label, val in wacc_items:
                    is_wacc = label == "WACC"
                    bg = "rgba(37,99,235,0.15)" if is_wacc else "transparent"
                    fw = "800" if is_wacc else "600"
                    fc = "#60A5FA" if is_wacc else "#F9FAFB"
                    st.markdown(
                        f'<div style="display:flex; justify-content:space-between; padding:0.35rem 0.5rem; '
                        f'background:{bg}; border-radius:6px; border-bottom:1px solid rgba(255,255,255,0.03);">'
                        f'<span style="font-size:0.78rem; color:#D1D5DB;">{label}</span>'
                        f'<span style="font-size:0.78rem; font-weight:{fw}; color:{fc};">{val}</span>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )
            
            with wc_c2:
                # Waterfall chart
                _wf_labels = ["Ke Ã— E/V", "Kd Ã— D/V Ã— (1-T)", "WACC"]
                _wf_ke_contrib = _wacc_data["we"] * _wacc_data["ke"] * 100
                _wf_kd_contrib = _wacc_data["wd"] * _wacc_data["kd"] * (1 - _wacc_data["tax_rate"]) * 100
                _wf_wacc = _wacc_data["wacc"] * 100
                
                fig_wf = go.Figure(go.Waterfall(
                    x=_wf_labels,
                    y=[_wf_ke_contrib, _wf_kd_contrib, 0],
                    measure=["relative", "relative", "total"],
                    text=[f"{_wf_ke_contrib:.2f}%", f"{_wf_kd_contrib:.2f}%", f"{_wf_wacc:.2f}%"],
                    textposition="outside",
                    textfont=dict(size=11, color="#F9FAFB"),
                    connector=dict(line=dict(color="rgba(37,99,235,0.3)", width=1)),
                    increasing=dict(marker=dict(color="rgba(37,99,235,0.7)")),
                    totals=dict(marker=dict(color="rgba(16,185,129,0.7)")),
                ))
                fig_wf.update_layout(
                    **_CHART_LAYOUT_BASE, height=300,
                    margin=dict(t=30, b=40, l=40, r=30),
                    showlegend=False,
                )
                _apply_space_grid(fig_wf)
                st.plotly_chart(fig_wf, use_container_width=True, key="wacc_waterfall")
            
            _divider()
            
            # Sensitivity: WACC vs Beta vs ERP
            st.markdown(
                '<div style="font-size:0.85rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                '<b>WACC Sensitivity â€” Beta vs. Equity Risk Premium</b></div>',
                unsafe_allow_html=True,
            )
            
            _s_betas = [0.6, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8]
            _s_erps = [0.04, 0.045, 0.05, 0.055, 0.06, 0.065, 0.07]
            
            _sens_rows = []
            for b in _s_betas:
                row = {"Beta": f"{b:.1f}"}
                for erp in _s_erps:
                    ke = _wacc_data["rf"] + b * erp
                    wacc = _wacc_data["we"] * ke + _wacc_data["wd"] * _wacc_data["kd"] * (1 - _wacc_data["tax_rate"])
                    row[f"ERP {erp*100:.1f}%"] = f"{wacc*100:.1f}%"
                _sens_rows.append(row)
            
            import pandas as _pd_wacc
            _sens_df = _pd_wacc.DataFrame(_sens_rows).set_index("Beta")
            
            # Highlight the cell closest to actual values
            st.dataframe(_sens_df, use_container_width=True)
        
        _divider()

        # â”€â”€ Scenario Analysis (Bull / Base / Bear) â”€â”€
        _section("Scenario Analysis", "ğŸ¯")
        with _safe_section("Scenario Analysis"):
            st.markdown(
                '<div style="font-size:0.85rem; color:#D1D5DB; margin-bottom:1rem;">'
                'Three scenarios varying growth rate and discount rate assumptions.</div>',
                unsafe_allow_html=True,
            )

            _base_gr = dcf_result["growth_rate"]
            _base_dr = dcf_result["discount_rate"]

            _scenarios = {
                "ğŸ‚ Bull Case": {"growth_rate": _base_gr + 0.03, "discount_rate": max(_base_dr - 0.01, 0.03)},
                "ğŸ“Š Base Case": {"growth_rate": _base_gr, "discount_rate": _base_dr},
                "ğŸ» Bear Case": {"growth_rate": max(_base_gr - 0.03, -0.05), "discount_rate": _base_dr + 0.015},
            }

            _scenario_results = {}
            for _sname, _sparams in _scenarios.items():
                _sr = _calculate_dcf(
                    dcf_cd,
                    growth_rate=_sparams["growth_rate"],
                    terminal_growth=dcf_result["terminal_growth"],
                    discount_rate=_sparams["discount_rate"],
                    projection_years=dcf_result["projection_years"],
                )
                _scenario_results[_sname] = _sr

            # Three column display
            _sc1, _sc2, _sc3 = st.columns(3)
            _sc_cols = [_sc1, _sc2, _sc3]
            _sc_colors = ["#10B981", "#2563EB", "#EF4444"]
            _sc_bg = ["rgba(16,185,129,0.1)", "rgba(37,99,235,0.1)", "rgba(239,68,68,0.1)"]
            _sc_border = ["rgba(16,185,129,0.3)", "rgba(37,99,235,0.3)", "rgba(239,68,68,0.3)"]

            for _idx_sc, (_sname, _sr) in enumerate(_scenario_results.items()):
                with _sc_cols[_idx_sc]:
                    if "error" in _sr:
                        st.markdown(f'<div style="padding:1rem; text-align:center; color:#9CA3AF;">{_sname}<br>N/A</div>', unsafe_allow_html=True)
                    else:
                        _sp = _sr["implied_share_price"]
                        _su = _sr["upside_pct"]
                        _su_text = f"+{_su:.1f}%" if _su >= 0 else f"{_su:.1f}%"
                        _sc_params = _scenarios[_sname]
                        st.markdown(
                            f'<div style="background:{_sc_bg[_idx_sc]}; border:1px solid {_sc_border[_idx_sc]}; '
                            f'border-radius:12px; padding:1.2rem; text-align:center;">'
                            f'<div style="font-size:0.85rem; font-weight:700; color:{_sc_colors[_idx_sc]}; margin-bottom:0.5rem;">{_sname}</div>'
                            f'<div style="font-size:1.6rem; font-weight:800; color:#F9FAFB;">{cs}{_sp:,.2f}</div>'
                            f'<div style="font-size:1rem; font-weight:700; color:{_sc_colors[_idx_sc]}; margin:0.3rem 0;">{_su_text}</div>'
                            f'<div style="font-size:0.65rem; color:#9CA3AF; line-height:1.4;">'
                            f'Growth: {_sc_params["growth_rate"]*100:.1f}% Â· WACC: {_sc_params["discount_rate"]*100:.1f}%</div>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )

            # Probability-weighted price
            st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
            _weight_cols = st.columns([1, 1, 1, 2])
            with _weight_cols[0]:
                _w_bull = st.number_input("Bull Weight %", min_value=0, max_value=100, value=25, step=5, key="scenario_w_bull")
            with _weight_cols[1]:
                _w_base = st.number_input("Base Weight %", min_value=0, max_value=100, value=50, step=5, key="scenario_w_base")
            with _weight_cols[2]:
                _w_bear = st.number_input("Bear Weight %", min_value=0, max_value=100, value=25, step=5, key="scenario_w_bear")

            _w_total = _w_bull + _w_base + _w_bear
            _sr_list = list(_scenario_results.values())
            if _w_total > 0 and all("error" not in _sr_item for _sr_item in _sr_list):
                _weighted_price = (
                    _sr_list[0]["implied_share_price"] * _w_bull +
                    _sr_list[1]["implied_share_price"] * _w_base +
                    _sr_list[2]["implied_share_price"] * _w_bear
                ) / _w_total
                _weighted_upside = ((_weighted_price / dcf_result["current_price"]) - 1) * 100 if dcf_result["current_price"] > 0 else 0
                _wu_color = "#10B981" if _weighted_upside >= 0 else "#EF4444"
                _wu_text = f"+{_weighted_upside:.1f}%" if _weighted_upside >= 0 else f"{_weighted_upside:.1f}%"

                with _weight_cols[3]:
                    st.markdown(
                        f'<div style="background:rgba(37,99,235,0.08); border:1px solid rgba(37,99,235,0.2); '
                        f'border-radius:12px; padding:1rem; text-align:center; margin-top:0.5rem;">'
                        f'<div style="font-size:0.7rem; color:#9CA3AF; text-transform:uppercase;">Probability-Weighted Price</div>'
                        f'<div style="font-size:1.5rem; font-weight:800; color:#F9FAFB;">{cs}{_weighted_price:,.2f}</div>'
                        f'<div style="font-size:0.9rem; font-weight:700; color:{_wu_color};">{_wu_text} vs current</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

            # Grouped bar chart
            if all("error" not in _sr_item for _sr_item in _sr_list):
                fig_scenario = go.Figure()
                _snames = list(_scenario_results.keys())
                fig_scenario.add_trace(go.Bar(
                    x=_snames,
                    y=[_sr_item["implied_share_price"] for _sr_item in _sr_list],
                    marker_color=_sc_colors,
                    text=[f"{cs}{_sr_item['implied_share_price']:,.2f}" for _sr_item in _sr_list],
                    textposition="outside",
                    textfont=dict(size=11, color="#D1D5DB"),
                ))
                fig_scenario.add_hline(
                    y=dcf_result["current_price"], line_dash="dash", line_color="#F59E0B", line_width=2,
                    annotation_text=f"Current: {cs}{dcf_result['current_price']:,.2f}",
                    annotation_font=dict(size=10, color="#F59E0B"),
                )
                fig_scenario.update_layout(
                    **_CHART_LAYOUT_BASE, height=300,
                    margin=dict(t=30, b=30, l=50, r=30),
                    xaxis=dict(tickfont=dict(size=11, color="#D1D5DB")),
                    yaxis=dict(tickprefix=cs, tickfont=dict(size=9, color="#9CA3AF"), showgrid=False),
                    showlegend=False,
                )
                _apply_space_grid(fig_scenario)
                st.plotly_chart(fig_scenario, use_container_width=True, key="scenario_bar_chart")

        _divider()

        # â”€â”€ Export DCF Model â”€â”€
        try:
            _dcf_assumptions = {
                "growth_rate": dcf_growth_rate,
                "terminal_growth": dcf_terminal_growth,
                "discount_rate": dcf_discount_rate,
                "years": dcf_years,
            }
            _dcf_excel = _export_dcf_to_excel(dcf_cd, dcf_result, _dcf_assumptions)
            st.download_button(
                label=f"ğŸ“¥ Export DCF Model (.xlsx)",
                data=_dcf_excel,
                file_name=f"{dcf_ticker_input}_DCF_Model.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                key="export_dcf_xlsx",
            )
        except Exception:
            pass
        
        st.markdown(
            '<div style="background:rgba(245,166,35,0.1); border:1px solid rgba(245,166,35,0.3); '
            'border-radius:12px; padding:1rem; margin-top:1rem;">'
            '<div style="font-size:0.75rem; font-weight:700; color:#F5A623; margin-bottom:0.3rem;">âš ï¸ DCF Disclaimer</div>'
            '<div style="font-size:0.8rem; color:#D1D5DB; line-height:1.6;">'
            'This DCF model uses simplified assumptions and historical data. Actual valuations depend on many factors '
            'including future growth trajectories, capital structure changes, and market conditions. '
            'This tool is for educational and research purposes only â€” not investment advice.'
            '</div></div>',
            unsafe_allow_html=True,
        )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# QUICK COMPARE MODE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
elif analysis_mode == "Quick Compare" and compare_btn and compare_tickers:
    st.markdown(
        '<div class="hero-header">'
        '<div class="orbital-brand">'
        f'{_orbital_logo()}'
        '<p class="orbital-tagline">Company Comparison Analysis</p>'
        '</div>'
        '<span class="hero-tagline">Side-by-Side Intelligence</span>'
        '</div>',
        unsafe_allow_html=True,
    )
    
    with st.spinner(f"Fetching data for {len(compare_tickers)} companies..."):
        companies = _fetch_comparison_data(compare_tickers[:10])  # Max 10
    
    if not companies:
        st.error("ğŸ˜• Could not fetch data for any of the specified tickers. Please verify the ticker symbols and your internet connection.")
        st.info("ğŸ’¡ Try common tickers like AAPL, MSFT, GOOGL or use one of the preset comparisons.", icon="ğŸ”§")
    else:
        st.success(f"âœ… Loaded {len(companies)} companies: {', '.join([c.ticker for c in companies])}")
        
        _divider()
        
        # Comparison Table
        _section("Key Metrics Comparison", "ğŸ“Š")
        
        comp_df = _build_comparison_table(companies)
        
        # Style the dataframe
        st.dataframe(
            comp_df,
            use_container_width=True,
            hide_index=True,
            height=400,
        )
        
        # Download as CSV
        csv_data = comp_df.to_csv(index=False)
        st.download_button(
            "ğŸ“¥ Download Comparison (CSV)",
            data=csv_data,
            file_name=f"comparison_{'_'.join([c.ticker for c in companies[:5]])}.csv",
            mime="text/csv",
        )
        
        _divider()
        
        # Radar Chart Comparison
        if len(companies) >= 2:
            _section("Valuation Radar", "ğŸ¯")
            _build_comparison_radar(companies, key="compare_radar")
        
        _divider()
        
        # Price Performance Comparison
        _section("Market Cap Comparison", "ğŸ’°")
        
        mc_data = [(c.ticker, c.market_cap or 0) for c in companies]
        mc_data.sort(key=lambda x: x[1], reverse=True)
        
        fig = go.Figure(go.Bar(
            x=[d[0] for d in mc_data],
            y=[d[1] for d in mc_data],
            marker=dict(
                color=["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6", 
                       "#8B5CF6", "#EC4899", "#14B8A6", "#F59E0B", "#6366F1"][:len(mc_data)],
                line=dict(color="rgba(255,255,255,0.15)", width=1),
            ),
            text=[format_number(d[1], currency_symbol="$") for d in mc_data],
            textposition="outside",
            textfont=dict(size=10, color="#D1D5DB"),
        ))
        
        fig.update_layout(
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            font=dict(family="Inter", size=14, color="#D1D5DB"),
            height=400,
            margin=dict(t=40, b=40, l=60, r=60),
            xaxis=dict(tickfont=dict(size=11, color="#9CA3AF"), showgrid=False),
            yaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), gridcolor="rgba(37,99,235,0.1)", griddash="dot"),
        )
        
        st.plotly_chart(fig, use_container_width=True, key="mc_comparison")
        
        _divider()
        
        # Profitability Comparison
        _section("Profitability Comparison", "ğŸ“ˆ")
        
        prof_metrics = ["Gross Margin", "Op Margin", "Net Margin", "ROE"]
        prof_data = []
        for c in companies:
            prof_data.append({
                "Company": c.ticker,
                "Gross Margin": (c.gross_margins or 0) * 100,
                "Op Margin": (c.operating_margins or 0) * 100,
                "Net Margin": (c.profit_margins or 0) * 100,
                "ROE": (c.return_on_equity or 0) * 100,
            })
        
        prof_df = pd.DataFrame(prof_data)
        
        fig2 = go.Figure()
        colors = ["#2563EB", "#10B981", "#10B981", "#F5A623"]
        for i, metric in enumerate(prof_metrics):
            fig2.add_trace(go.Bar(
                x=prof_df["Company"],
                y=prof_df[metric],
                name=metric,
                marker=dict(color=colors[i], line=dict(color="rgba(255,255,255,0.15)", width=1)),
            ))
        
        fig2.update_layout(
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            font=dict(family="Inter", size=14, color="#D1D5DB"),
            height=400,
            margin=dict(t=40, b=40, l=60, r=60),
            xaxis=dict(tickfont=dict(size=11, color="#9CA3AF"), showgrid=False),
            yaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), gridcolor="rgba(37,99,235,0.1)", 
                      griddash="dot", ticksuffix="%"),
            legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
            barmode="group",
        )
        
        st.plotly_chart(fig2, use_container_width=True, key="prof_comparison")
        
        _divider()
        
        # Price Performance
        _section("Price Performance (1 Year)", "ğŸ“‰")
        
        perf_period = st.selectbox(
            "Select Period",
            ["1mo", "3mo", "6mo", "1y", "2y", "5y"],
            index=3,
            label_visibility="collapsed",
            key="perf_period"
        )
        
        _build_price_performance_chart([c.ticker for c in companies], period=perf_period, key="price_perf_chart")
        
        _divider()
        
        # Valuation Multiples Comparison
        _section("Valuation Multiples", "ğŸ’¹")
        
        val_metrics = ["P/E", "EV/EBITDA", "EV/Revenue", "P/B"]
        val_data = []
        for c in companies:
            val_data.append({
                "Company": c.ticker,
                "P/E": c.trailing_pe if c.trailing_pe and c.trailing_pe > 0 else 0,
                "EV/EBITDA": c.ev_to_ebitda if c.ev_to_ebitda and c.ev_to_ebitda > 0 else 0,
                "EV/Revenue": c.ev_to_revenue if c.ev_to_revenue and c.ev_to_revenue > 0 else 0,
                "P/B": c.price_to_book if c.price_to_book and c.price_to_book > 0 else 0,
            })
        
        val_df = pd.DataFrame(val_data)
        
        fig3 = go.Figure()
        colors_val = ["#2563EB", "#10B981", "#10B981", "#F5A623"]
        for i, metric in enumerate(val_metrics):
            fig3.add_trace(go.Bar(
                x=val_df["Company"],
                y=val_df[metric],
                name=metric,
                marker=dict(color=colors_val[i], line=dict(color="rgba(255,255,255,0.15)", width=1)),
                text=[f"{v:.1f}x" if v > 0 else "N/A" for v in val_df[metric]],
                textposition="outside",
                textfont=dict(size=9, color="#D1D5DB"),
            ))
        
        fig3.update_layout(
            paper_bgcolor="rgba(0,0,0,0)",
            plot_bgcolor="rgba(0,0,0,0)",
            font=dict(family="Inter", size=14, color="#D1D5DB"),
            height=400,
            margin=dict(t=40, b=40, l=60, r=60),
            xaxis=dict(tickfont=dict(size=11, color="#9CA3AF"), showgrid=False),
            yaxis=dict(tickfont=dict(size=9, color="#9CA3AF"), gridcolor="rgba(37,99,235,0.1)", 
                      griddash="dot", ticksuffix="x"),
            legend=dict(font=dict(size=10, color="#D1D5DB"), orientation="h", yanchor="bottom", y=1.02),
            barmode="group",
        )
        
        st.plotly_chart(fig3, use_container_width=True, key="val_comparison")
        
        _divider()
        
        # Correlation Matrix
        if len(companies) >= 2:
            _section("Price Correlation Matrix", "ğŸ”—")
            
            st.markdown(
                '<div style="font-size:0.75rem; color:#9CA3AF; margin-bottom:0.5rem;">'
                'Shows how closely stock prices move together (1Y daily returns)</div>',
                unsafe_allow_html=True,
            )
            
            try:
                corr_data = {}
                for c in companies:
                    try:
                        tk_c = yf.Ticker(c.ticker)
                        h = tk_c.history(period="1y")
                        if not h.empty:
                            corr_data[c.ticker] = h["Close"].pct_change().dropna()
                    except Exception:
                        pass
                
                if len(corr_data) >= 2:
                    corr_df = pd.DataFrame(corr_data)
                    corr_matrix = corr_df.corr()
                    
                    fig_corr = go.Figure(data=go.Heatmap(
                        z=corr_matrix.values,
                        x=corr_matrix.columns,
                        y=corr_matrix.index,
                        colorscale=[
                            [0, "#EF4444"],
                            [0.5, "#1a1625"],
                            [1, "#10B981"]
                        ],
                        zmin=-1, zmax=1,
                        text=np.round(corr_matrix.values, 2),
                        texttemplate="%{text}",
                        textfont=dict(size=12, color="#F9FAFB"),
                        hovertemplate="%{x} vs %{y}: %{z:.3f}<extra></extra>",
                    ))
                    
                    fig_corr.update_layout(
                        paper_bgcolor="rgba(0,0,0,0)",
                        plot_bgcolor="rgba(0,0,0,0)",
                        font=dict(family="Inter", color="#D1D5DB"),
                        height=400,
                        margin=dict(t=20, b=40, l=60, r=30),
                        xaxis=dict(tickfont=dict(size=11, color="#9CA3AF")),
                        yaxis=dict(tickfont=dict(size=11, color="#9CA3AF")),
                    )
                    
                    st.plotly_chart(fig_corr, use_container_width=True, key="corr_matrix")
            except Exception:
                st.info("Could not generate correlation matrix.")

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # MULTI-DIMENSIONAL RADAR + WINNER SUMMARY
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if len(companies) >= 2:
            _divider()
            with _safe_section("Multi-Dimensional Radar"):
                _section("Multi-Dimensional Comparison", "ğŸ•¸ï¸")
                st.markdown(
                    '<div style="font-size:0.8rem; color:#D1D5DB; margin-bottom:0.8rem;">'
                    'Companies scored 0â€“100 across five dimensions: Valuation, Growth, Profitability, Leverage, Size.</div>',
                    unsafe_allow_html=True,
                )

                dimensions = ["Valuation", "Growth", "Profitability", "Leverage", "Size"]
                company_scores = {}

                for c in companies[:5]:
                    scores = {}
                    # Valuation (lower P/E = better, invert & normalize)
                    pe = c.trailing_pe if c.trailing_pe and 0 < c.trailing_pe < 200 else 50
                    scores["Valuation"] = max(0, min(100, 100 - (pe / 50 * 50)))

                    # Growth (revenue growth)
                    rg = (c.revenue_growth or 0) * 100
                    scores["Growth"] = max(0, min(100, rg * 2 + 50))

                    # Profitability (net margin)
                    nm = (c.profit_margins or 0) * 100
                    scores["Profitability"] = max(0, min(100, nm * 2.5 + 25))

                    # Leverage (lower D/E = better)
                    de = c.debt_to_equity if c.debt_to_equity and c.debt_to_equity > 0 else 50
                    scores["Leverage"] = max(0, min(100, 100 - min(de / 2, 100)))

                    # Size (log market cap normalized)
                    mc = c.market_cap or 1e9
                    import math
                    scores["Size"] = max(0, min(100, (math.log10(max(mc, 1)) - 8) / 5 * 100))

                    company_scores[c.ticker] = scores

                # Build radar chart
                fig_radar = go.Figure()
                radar_colors = ["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6"]

                for i, (ticker, scores) in enumerate(company_scores.items()):
                    vals = [scores[d] for d in dimensions]
                    color = radar_colors[i % len(radar_colors)]
                    fig_radar.add_trace(go.Scatterpolar(
                        r=vals + [vals[0]],
                        theta=dimensions + [dimensions[0]],
                        fill='toself',
                        name=ticker,
                        fillcolor=f"rgba({int(color[1:3], 16)},{int(color[3:5], 16)},{int(color[5:7], 16)},0.1)",
                        line=dict(color=color, width=2),
                        marker=dict(size=6),
                    ))

                fig_radar.update_layout(
                    paper_bgcolor="rgba(0,0,0,0)",
                    plot_bgcolor="rgba(0,0,0,0)",
                    font=dict(family="Inter", size=12, color="#D1D5DB"),
                    polar=dict(
                        radialaxis=dict(visible=True, range=[0, 100], tickfont=dict(size=8, color="#9CA3AF"),
                                       gridcolor="rgba(37,99,235,0.1)"),
                        angularaxis=dict(tickfont=dict(size=11, color="#9CA3AF"),
                                        gridcolor="rgba(37,99,235,0.08)"),
                        bgcolor="rgba(0,0,0,0)",
                    ),
                    showlegend=True,
                    height=500,
                    margin=dict(t=50, b=50, l=80, r=80),
                    legend=dict(font=dict(size=11, color="#D1D5DB")),
                )
                st.plotly_chart(fig_radar, use_container_width=True, key="multi_dim_radar")

                # Winner summary
                _section("ğŸ† Winner Summary")
                total_scores = {t: sum(s.values()) for t, s in company_scores.items()}
                sorted_companies = sorted(total_scores.items(), key=lambda x: x[1], reverse=True)
                winner = sorted_companies[0]

                winner_cols = st.columns(min(len(sorted_companies), 5))
                for i, (ticker, total) in enumerate(sorted_companies[:5]):
                    with winner_cols[i]:
                        medal = "ğŸ¥‡" if i == 0 else "ğŸ¥ˆ" if i == 1 else "ğŸ¥‰" if i == 2 else f"#{i+1}"
                        border_c = radar_colors[i % len(radar_colors)]
                        # Find which dimension this company leads in
                        best_dim = max(company_scores[ticker].items(), key=lambda x: x[1])
                        st.markdown(
                            f'<div style="text-align:center; padding:0.8rem; background:rgba(17,24,39,0.7); backdrop-filter:blur(16px); '
                            f'border-radius:10px; border-top:3px solid {border_c};">'
                            f'<div style="font-size:1.2rem;">{medal}</div>'
                            f'<div style="font-size:1rem; font-weight:800; color:#F9FAFB;">{ticker}</div>'
                            f'<div style="font-size:1.5rem; font-weight:800; color:{border_c};">{total:.0f}</div>'
                            f'<div style="font-size:0.65rem; color:#9CA3AF; text-transform:uppercase;">Total Score</div>'
                            f'<div style="font-size:0.7rem; color:#D1D5DB; margin-top:0.3rem;">Best: {best_dim[0]} ({best_dim[1]:.0f})</div>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )

                # Per-dimension winners
                dim_winners_html = ""
                for dim in dimensions:
                    dim_best = max(company_scores.items(), key=lambda x: x[1][dim])
                    dim_winners_html += (
                        f'<span style="display:inline-block; padding:0.3rem 0.6rem; margin:0.2rem; '
                        f'background:rgba(37,99,235,0.08); border-radius:6px; font-size:0.75rem;">'
                        f'<span style="color:#9CA3AF;">{dim}:</span> '
                        f'<span style="color:#F9FAFB; font-weight:700;">{dim_best[0]}</span> '
                        f'<span style="color:#2563EB;">({dim_best[1][dim]:.0f})</span></span>'
                    )
                st.markdown(
                    f'<div style="text-align:center; margin-top:0.8rem;">{dim_winners_html}</div>',
                    unsafe_allow_html=True,
                )

        # â”€â”€ Comparison Summary Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with _safe_section("Comparison Summary Cards"):
            _section("Comparison Summary Cards", "ğŸ“‹")
            # Determine metrics for strength/weakness analysis
            _comp_metrics = {}
            for c in companies:
                _comp_metrics[c.ticker] = {
                    "pe": c.pe_ratio or 999,
                    "revenue_growth": c.revenue_growth or 0,
                    "profit_margin": c.profit_margin or 0,
                    "roe": c.roe or 0,
                    "dividend_yield": c.dividend_yield or 0,
                    "price": c.current_price or 0,
                    "market_cap": c.market_cap or 0,
                }

            # For each metric, rank companies
            metric_labels = {
                "pe": ("Lowest P/E", True),  # lower is better
                "revenue_growth": ("Highest Growth", False),
                "profit_margin": ("Best Margins", False),
                "roe": ("Best ROE", False),
                "dividend_yield": ("Best Yield", False),
            }

            _card_cols = st.columns(min(len(companies), 5))
            for i, c in enumerate(companies[:5]):
                with _card_cols[i]:
                    _m = _comp_metrics[c.ticker]
                    # Find strength (where this company ranks #1)
                    _strength = "N/A"
                    _weakness = "N/A"
                    for mk, (mlabel, lower_better) in metric_labels.items():
                        vals = [(t, _comp_metrics[t][mk]) for t in _comp_metrics]
                        vals.sort(key=lambda x: x[1], reverse=not lower_better)
                        if vals[0][0] == c.ticker:
                            _strength = mlabel
                        if vals[-1][0] == c.ticker:
                            _weakness = mlabel.replace("Lowest", "Highest").replace("Highest", "Lowest").replace("Best", "Weakest")

                    # Verdict
                    if _m["pe"] < 15 and _m["pe"] > 0:
                        _verdict = "ğŸ’° Best value play"
                    elif _m["revenue_growth"] > 0.15:
                        _verdict = "ğŸš€ Growth leader"
                    elif _m["profit_margin"] > 0.20:
                        _verdict = "âœ¨ Highest quality"
                    elif _m["dividend_yield"] > 0.03:
                        _verdict = "ğŸ’µ Income favorite"
                    else:
                        _verdict = "ğŸ“Š Balanced profile"

                    _mc_str = f"${_m['market_cap']/1e9:.1f}B" if _m['market_cap'] >= 1e9 else f"${_m['market_cap']/1e6:.0f}M" if _m['market_cap'] >= 1e6 else "N/A"
                    _border_c = ["#2563EB", "#10B981", "#10B981", "#F5A623", "#3B82F6"][i % 5]
                    st.markdown(
                        f'<div style="padding:0.8rem; background:rgba(255,255,255,0.03); border-radius:10px; '
                        f'border-left:3px solid {_border_c}; margin-bottom:0.5rem;">'
                        f'<div style="font-size:1rem; font-weight:800; color:#F9FAFB;">{c.ticker}</div>'
                        f'<div style="font-size:0.72rem; color:#9CA3AF;">{c.company_name or c.ticker}</div>'
                        f'<div style="font-size:0.85rem; color:#D1D5DB; margin:0.3rem 0;">${_m["price"]:,.2f} Â· {_mc_str}</div>'
                        f'<div style="font-size:0.7rem; margin:0.2rem 0;">'
                        f'<span style="color:#10B981;">ğŸ’ª {_strength}</span></div>'
                        f'<div style="font-size:0.7rem; margin:0.2rem 0;">'
                        f'<span style="color:#F59E0B;">âš ï¸ {_weakness}</span></div>'
                        f'<div style="font-size:0.75rem; font-weight:700; color:{_border_c}; margin-top:0.4rem;">{_verdict}</div>'
                        f'</div>',
                        unsafe_allow_html=True,
                    )

elif analysis_mode == "VMS Screener" and vms_screen_btn:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # VMS SCREENER RESULTS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    import pandas as pd

    st.markdown(
        '<div class="hero-header">'
        '<div class="orbital-brand">'
        f'{_orbital_logo()}'
        '<p class="orbital-subtitle" style="font-size:1.1rem;">VMS Acquisition Screener</p>'
        '</div></div>',
        unsafe_allow_html=True,
    )

    with _safe_section("VMS Screening Philosophy"):
        st.markdown(
            '<div style="background:rgba(37,99,235,0.06); border-radius:12px; padding:1.2rem; '
            'border-left:4px solid #2563EB; margin-bottom:1rem;">'
            '<div style="font-size:0.85rem; font-weight:700; color:#60A5FA; margin-bottom:0.5rem;">ğŸ›ï¸ Constellation Software Philosophy</div>'
            '<div style="font-size:0.78rem; color:#D1D5DB; line-height:1.6;">'
            'Vertical Market Software (VMS) companies serve niche industries with mission-critical software. '
            'These businesses exhibit high switching costs, recurring revenue, and durable competitive moats. '
            'Ideal acquisition targets have: <b>stable revenue ($5M-$200M)</b>, <b>healthy EBITDA margins (15%+)</b>, '
            '<b>low churn</b>, and <b>dominant positions</b> in their vertical. '
            'This screener identifies public VMS companies matching your criteria.</div></div>',
            unsafe_allow_html=True,
        )

    with _safe_section("Screening Results"):
        with st.spinner("Fetching data for VMS universe..."):
            # Convert to tuple of tuples for caching
            _vms_tuple = tuple(tuple(sorted(d.items())) for d in VMS_UNIVERSE)
            raw_results = _fetch_vms_screening_data(tuple(dict(t) for t in _vms_tuple))

        if raw_results:
            df = pd.DataFrame(raw_results)

            # Apply filters (including Rule of 40 and profile-specific)
            mask = (
                (df["Revenue ($M)"] >= vms_rev_min) &
                (df["Revenue ($M)"] <= vms_rev_max) &
                (df["EBITDA Margin (%)"] >= vms_ebitda_min) &
                (df["Revenue Growth (%)"] >= vms_growth_min) &
                (df["Rule of 40"] >= vms_rule40_min)
            )
            # Profile-specific extra filters
            if vms_target_profile == "Classic CSU Target":
                mask &= (df["Revenue Growth (%)"] < 10) & (df["EV/Revenue"] < 3)
            elif vms_target_profile == "Turnaround Opportunity":
                mask &= (df["Revenue Growth (%)"] < 0)
            elif vms_target_profile == "Cash Cow":
                mask &= (df["Revenue Growth (%)"] < 5)

            if vms_industries:
                mask &= df["Vertical"].isin(vms_industries)
            if vms_geographies:
                mask &= df["Geography"].isin(vms_geographies)

            df["Pass"] = mask
            df_display = df[["Company", "Ticker", "Vertical", "Revenue ($M)", "EBITDA Margin (%)",
                             "Revenue Growth (%)", "Rule of 40", "Attractiveness", "EV/Revenue", "EV/EBITDA", "Pass"]].copy()

            # Summary
            n_pass = mask.sum()
            st.markdown(
                f'<div style="text-align:center; margin-bottom:1rem;">'
                f'<span style="font-size:1.5rem; font-weight:800; color:#2563EB;">{n_pass}</span>'
                f'<span style="font-size:0.85rem; color:#9CA3AF;"> / {len(df)} companies pass your criteria</span></div>',
                unsafe_allow_html=True,
            )

            # Attractiveness score tooltip
            st.markdown(
                '<div style="font-size:0.7rem; color:#9CA3AF; margin-bottom:0.5rem;">'
                'ğŸ’¡ <b>Attractiveness Score</b> (0-100): Recurring revenue characteristics (SaaS premium), '
                'Rule of 40, revenue size sweet spot ($5-200M), and market cap relative to revenue (cheaper = better).</div>',
                unsafe_allow_html=True,
            )

            def _color_vms_row(row):
                styles = [""] * len(row)
                cols = list(row.index)
                # Pass row background
                if row["Pass"]:
                    styles = ["background-color: rgba(16,185,129,0.08)"] * len(row)
                # Rule of 40 coloring
                if "Rule of 40" in cols:
                    r40_idx = cols.index("Rule of 40")
                    r40 = row["Rule of 40"]
                    if r40 > 40:
                        styles[r40_idx] = "background-color: rgba(16,185,129,0.25); color: #10B981; font-weight:700"
                    elif r40 >= 30:
                        styles[r40_idx] = "background-color: rgba(245,166,35,0.25); color: #F5A623; font-weight:700"
                    else:
                        styles[r40_idx] = "background-color: rgba(239,68,68,0.2); color: #EF4444; font-weight:700"
                # Attractiveness coloring
                if "Attractiveness" in cols:
                    a_idx = cols.index("Attractiveness")
                    a_val = row["Attractiveness"]
                    if a_val >= 70:
                        styles[a_idx] = "background-color: rgba(16,185,129,0.25); color: #10B981; font-weight:700"
                    elif a_val >= 50:
                        styles[a_idx] = "background-color: rgba(245,166,35,0.25); color: #F5A623; font-weight:700"
                    else:
                        styles[a_idx] = "background-color: rgba(239,68,68,0.15); color: #EF4444"
                return styles

            styled = df_display.style.apply(_color_vms_row, axis=1).format({
                "Revenue ($M)": "${:,.1f}M",
                "EBITDA Margin (%)": "{:.1f}%",
                "Revenue Growth (%)": "{:.1f}%",
                "Rule of 40": "{:.1f}",
                "Attractiveness": "{:.0f}",
                "EV/Revenue": "{:.2f}x",
                "EV/EBITDA": "{:.1f}x",
            })
            st.dataframe(styled, use_container_width=True, height=500)

            # Download CSV
            csv_data = df_display[df_display["Pass"]].drop(columns=["Pass"]).to_csv(index=False)
            st.download_button(
                "ğŸ“„ Generate Target List (CSV)",
                data=csv_data,
                file_name="vms_target_list.csv",
                mime="text/csv",
                use_container_width=True,
            )

            # Add to watchlist button
            if n_pass > 0:
                if st.button("â­ Add Passing Companies to Watchlist", use_container_width=True):
                    for _, row in df_display[df_display["Pass"]].iterrows():
                        _add_to_watchlist(row["Ticker"])
                    st.success(f"Added {n_pass} companies to watchlist!")
                    st.rerun()
        else:
            st.warning("ğŸ˜• Could not fetch data for VMS universe. Please check your internet connection and try again in a few moments.")

elif analysis_mode == "VMS Screener" and not vms_screen_btn:
    # VMS Screener splash/landing
    st.markdown(
        '<div class="splash-hero">'
        '<div class="star-layer-1">&#8203;</div>'
        '<div class="star-layer-2">&#8203;</div>'
        '<div class="star-layer-3">&#8203;</div>'
        '<div class="nebula-overlay">&#8203;</div>'
        '<div class="orb orb-1">&#8203;</div>'
        '<div class="orb orb-2">&#8203;</div>'
        '<div class="orb orb-3">&#8203;</div>'
        '<div class="orb orb-4">&#8203;</div>'
        '<div class="orb orb-5">&#8203;</div>'
        '<div class="shooting-star shooting-star-1">&#8203;</div>'
        '<div class="shooting-star shooting-star-2">&#8203;</div>'
        '<div class="noise-overlay">&#8203;</div>'
        '<div class="title-glow">&#8203;</div>'
        '<div class="splash-content">'
        '<div class="orbital-logo orbital-logo-lg">'
        '<span class="orbital-text">ORBITAL</span>'
        '<div class="orbital-ring orbital-ring-1"></div>'
        '<div class="orbital-ring orbital-ring-2"></div>'
        '<div class="orbital-ring orbital-ring-3"></div>'
        '<div class="orbital-particle orbital-particle-1"></div>'
        '<div class="orbital-particle orbital-particle-2"></div>'
        '<div class="orbital-particle orbital-particle-3"></div>'
        '</div>'
        '<p class="splash-subtitle" style="font-size:1.4rem; margin-top:1rem;">VMS Acquisition Screener</p>'
        '<div class="pill-row">'
        '<span class="feature-pill">Constellation Style</span>'
        '<span class="feature-pill">Vertical Market Software</span>'
        '<span class="feature-pill">Niche Dominators</span>'
        '<span class="feature-pill">Recurring Revenue</span>'
        '</div>'
        '<div class="splash-stats">'
        '<div class="splash-stat"><div class="splash-stat-value">20</div><div class="splash-stat-label">VMS Companies</div></div>'
        '<div class="splash-stat"><div class="splash-stat-value">10</div><div class="splash-stat-label">Industry Verticals</div></div>'
        '<div class="splash-stat"><div class="splash-stat-value">7</div><div class="splash-stat-label">Screening Metrics</div></div>'
        '</div>'
        '</div>'
        '</div>',
        unsafe_allow_html=True,
    )

    st.markdown(
        '<div class="space-section">'
        '<div class="space-section-title">How It Works</div>'
        '<div class="step-grid">'
        '<div class="step-card"><div class="step-num">1</div><div class="step-label">Set Criteria</div><div class="step-detail">Revenue, margins, growth thresholds</div></div>'
        '<div class="step-card"><div class="step-num">2</div><div class="step-label">Filter Verticals</div><div class="step-detail">Healthcare IT, GovTech, and more</div></div>'
        '<div class="step-card"><div class="step-num">3</div><div class="step-label">Run Screen</div><div class="step-detail">Scan 20 public VMS companies</div></div>'
        '<div class="step-card"><div class="step-num">4</div><div class="step-label">Export Targets</div><div class="step-detail">Download CSV target list</div></div>'
        '</div>'
        '<div class="space-section-title">VMS Verticals Covered</div>'
        '<div class="feature-grid">'
        '<div class="feature-card"><div class="feature-icon">&#127973;</div><div class="feature-title">Healthcare IT</div><div class="feature-desc">EHR, clinical, billing systems</div></div>'
        '<div class="feature-card"><div class="feature-icon">&#127963;</div><div class="feature-title">GovTech</div><div class="feature-desc">Municipal, courts, public safety</div></div>'
        '<div class="feature-card"><div class="feature-icon">&#9878;</div><div class="feature-title">Legal Tech</div><div class="feature-desc">Case management, e-discovery</div></div>'
        '<div class="feature-card"><div class="feature-icon">&#127979;</div><div class="feature-title">Education Tech</div><div class="feature-desc">LMS, SIS, campus management</div></div>'
        '<div class="feature-card"><div class="feature-icon">&#127968;</div><div class="feature-title">Real Estate Tech</div><div class="feature-desc">Property, lease, facilities mgmt</div></div>'
        '<div class="feature-card"><div class="feature-icon">&#128679;</div><div class="feature-title">Construction Tech</div><div class="feature-desc">Project, BIM, field management</div></div>'
        '<div class="feature-card"><div class="feature-icon">&#9889;</div><div class="feature-title">Utilities</div><div class="feature-desc">Grid, metering, asset management</div></div>'
        '<div class="feature-card"><div class="feature-icon">&#128666;</div><div class="feature-title">Transportation</div><div class="feature-desc">Fleet, logistics, routing</div></div>'
        '</div>'
        '<p style="font-size:0.72rem; color:#9CA3AF; margin-top:2rem; text-align:center;">'
        'Set your screening criteria in the sidebar and click Run Screen<br>'
        'Inspired by Constellation Software&#39;s acquisition philosophy'
        '</p>'
        '</div>',
        unsafe_allow_html=True,
    )

elif analysis_mode == "Options P/L" and options_pl_btn and options_pl_ticker:
    render_options_pl_page(options_pl_ticker)

elif analysis_mode == "Options P/L" and options_pl_btn and not options_pl_ticker:
    st.warning("âš ï¸ Please enter a ticker symbol to analyze options P/L.")

elif analysis_mode == "Sector Rotation" and sector_rotation_btn:
    render_sector_rotation_page()

elif analysis_mode == "Options P/L" and not options_pl_btn:
    # Options P/L splash
    st.markdown(
        '<div class="splash-hero">'
        '<div class="star-layer-1">&#8203;</div><div class="star-layer-2">&#8203;</div><div class="star-layer-3">&#8203;</div>'
        '<div class="nebula-overlay">&#8203;</div>'
        '<div class="orb orb-1">&#8203;</div><div class="orb orb-2">&#8203;</div>'
        '<div class="splash-content">'
        '<div class="orbital-logo orbital-logo-lg"><span class="orbital-text">ORBITAL</span>'
        '<div class="orbital-ring orbital-ring-1"></div><div class="orbital-ring orbital-ring-2"></div><div class="orbital-ring orbital-ring-3"></div>'
        '</div>'
        '<p class="splash-subtitle" style="font-size:1.4rem; margin-top:1rem;">Options P/L Analyzer</p>'
        '<div class="pill-row">'
        '<span class="feature-pill">Options Chains</span>'
        '<span class="feature-pill">P/L Visualization</span>'
        '<span class="feature-pill">IV Analysis</span>'
        '</div>'
        '</div></div>',
        unsafe_allow_html=True,
    )

elif analysis_mode == "Sector Rotation" and not sector_rotation_btn:
    # Sector Rotation splash
    _render_modern_splash(
        "Sector Rotation Analysis",
        "Analyze momentum and rotation patterns across S&P 500 sectors",
        stats=[
            {"value": "11", "label": "S&P Sectors"},
            {"value": "Live", "label": "Market Data"},
            {"value": "5", "label": "Time Periods"}
        ],
        pills=["Momentum Heatmap", "Rotation Signals", "Performance Trends"]
    )

# â”€â”€ NEW M&A MODES â”€â”€
elif analysis_mode == "Due Diligence" and dd_btn and dd_ticker:
    render_due_diligence_page(dd_ticker)

elif analysis_mode == "Due Diligence" and not dd_btn:
    _render_modern_splash(
        "Due Diligence Tracker",
        "Comprehensive M&A due diligence checklist workflow",
        stats=[
            {"value": "6", "label": "DD Categories"},
            {"value": "40+", "label": "Checkpoints"},
            {"value": "100%", "label": "Coverage"}
        ],
        pills=["Financial", "Legal", "Commercial", "Operational", "IT", "HR"]
    )

elif analysis_mode == "Synergy Model" and syn_btn and syn_acquirer and syn_target:
    render_synergy_model_page(syn_acquirer, syn_target)

elif analysis_mode == "Synergy Model" and not syn_btn:
    _render_modern_splash(
        "Synergy Model",
        "Revenue and cost synergy estimation with waterfall analysis",
        stats=[
            {"value": "2", "label": "Synergy Types"},
            {"value": "Live", "label": "Financial Data"},
            {"value": "$MM", "label": "Value Creation"}
        ],
        pills=["Cost Synergies", "Revenue Synergies", "Bridge Chart"]
    )

elif analysis_mode == "Integration Plan" and int_btn and int_acquirer and int_target:
    render_integration_plan_page(int_acquirer, int_target)

elif analysis_mode == "Integration Plan" and not int_btn:
    _render_modern_splash(
        "100-Day Integration Plan",
        "Post-merger integration roadmap with milestones and owners",
        stats=[
            {"value": "3", "label": "Phases"},
            {"value": "100", "label": "Days"},
            {"value": "20+", "label": "Milestones"}
        ],
        pills=["Foundation", "Execution", "Optimization"]
    )

elif analysis_mode == "Deal Structure" and ds_btn and ds_acquirer and ds_target:
    render_deal_structure_page(ds_acquirer, ds_target, ds_equity_val)

elif analysis_mode == "Deal Structure" and not ds_btn:
    _render_modern_splash(
        "Deal Structure Optimizer",
        "Stock vs cash vs mixed consideration analysis",
        stats=[
            {"value": "3", "label": "Structures"},
            {"value": "100%", "label": "Flexibility"},
            {"value": "Real-time", "label": "Analysis"}
        ],
        pills=["100% Cash", "50/50 Mixed", "100% Stock", "Tax Implications"]
    )

elif analysis_mode == "Fairness Opinion" and fo_btn and fo_ticker:
    render_fairness_opinion_page(fo_ticker, fo_offer_price)

elif analysis_mode == "Fairness Opinion" and not fo_btn:
    _render_modern_splash(
        "Fairness Opinion Generator",
        "Valuation summary across multiple methodologies",
        stats=[
            {"value": "4", "label": "Methodologies"},
            {"value": "Live", "label": "Market Data"},
            {"value": "Fair?", "label": "Opinion"}
        ],
        pills=["DCF", "Public Comps", "Precedent Transactions", "Football Field"]
    )

else:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SPLASH / LANDING PAGE â€” Immersive space experience
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # DCF Valuation Splash
    if analysis_mode == "DCF Valuation":
        st.markdown(
            '<div class="splash-hero">'
            '<div class="star-layer-1">&#8203;</div>'
            '<div class="star-layer-2">&#8203;</div>'
            '<div class="star-layer-3">&#8203;</div>'
            '<div class="nebula-overlay">&#8203;</div>'
            '<div class="orb orb-1">&#8203;</div>'
            '<div class="orb orb-2">&#8203;</div>'
            '<div class="orb orb-3">&#8203;</div>'
            '<div class="orb orb-4">&#8203;</div>'
            '<div class="orb orb-5">&#8203;</div>'
            '<div class="shooting-star shooting-star-1">&#8203;</div>'
            '<div class="shooting-star shooting-star-2">&#8203;</div>'
            '<div class="noise-overlay">&#8203;</div>'
            '<div class="title-glow">&#8203;</div>'
            '<div class="splash-content">'
            '<div class="orbital-logo orbital-logo-lg">'
            '<span class="orbital-text">ORBITAL</span>'
            '<div class="orbital-ring orbital-ring-1"></div>'
            '<div class="orbital-ring orbital-ring-2"></div>'
            '<div class="orbital-ring orbital-ring-3"></div>'
            '<div class="orbital-particle orbital-particle-1"></div>'
            '<div class="orbital-particle orbital-particle-2"></div>'
            '<div class="orbital-particle orbital-particle-3"></div>'
            '</div>'
            '<p class="splash-subtitle" style="font-size:1.4rem; margin-top:1rem;">DCF Valuation Engine</p>'
            '<div class="pill-row">'
            '<span class="feature-pill">Free Cash Flow Projection</span>'
            '<span class="feature-pill">Terminal Value</span>'
            '<span class="feature-pill">Sensitivity Analysis</span>'
            '<span class="feature-pill">WACC Modeling</span>'
            '<span class="feature-pill">Monte Carlo</span>'
            '</div>'
            '<div class="splash-stats">'
            '<div class="splash-stat"><div class="splash-stat-value">5-10</div><div class="splash-stat-label">Projection Years</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">25</div><div class="splash-stat-label">Sensitivity Scenarios</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">âˆ</div><div class="splash-stat-label">Terminal Value</div></div>'
            '</div>'
            '</div>'
            '</div>',
            unsafe_allow_html=True,
        )
        
        st.markdown(
            '<div class="space-section">'
            '<div class="space-section-title">How It Works</div>'
            '<div class="step-grid">'
            '<div class="step-card"><div class="step-num">1</div><div class="step-label">Enter Ticker</div><div class="step-detail">Company with positive free cash flow</div></div>'
            '<div class="step-card"><div class="step-num">2</div><div class="step-label">Set Assumptions</div><div class="step-detail">Growth rate, WACC, terminal growth</div></div>'
            '<div class="step-card"><div class="step-num">3</div><div class="step-label">Calculate DCF</div><div class="step-detail">Project FCF &amp; discount to present value</div></div>'
            '<div class="step-card"><div class="step-num">4</div><div class="step-label">Sensitivity</div><div class="step-detail">Test different scenarios</div></div>'
            '</div>'
            '<div class="space-section-title">Model Features</div>'
            '<div class="feature-grid">'
            '<div class="feature-card"><div class="feature-icon">&#128200;</div><div class="feature-title">FCF Projection</div><div class="feature-desc">Project free cash flows based on growth assumptions</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128202;</div><div class="feature-title">Terminal Value</div><div class="feature-desc">Gordon Growth Model for perpetuity value</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127919;</div><div class="feature-title">Present Value</div><div class="feature-desc">Discount future cash flows at WACC</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128176;</div><div class="feature-title">Equity Bridge</div><div class="feature-desc">Enterprise value to equity value</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128161;</div><div class="feature-title">Implied Price</div><div class="feature-desc">Per-share intrinsic value estimate</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#9888;</div><div class="feature-title">Sensitivity Matrix</div><div class="feature-desc">Growth vs. WACC scenario analysis</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127942;</div><div class="feature-title">Upside/Downside</div><div class="feature-desc">Compare to current market price</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128196;</div><div class="feature-title">Visual Charts</div><div class="feature-desc">Interactive valuation visualizations</div></div>'
            '</div>'
            '<p style="font-size:0.72rem; color:#9CA3AF; margin-top:2rem; text-align:center;">'
            'Enter a ticker and set your DCF assumptions in the sidebar<br>'
            'Works best for companies with positive, predictable free cash flow'
            '</p>'
            '</div>',
            unsafe_allow_html=True,
        )
    
    # Quick Compare Splash
    elif analysis_mode == "Quick Compare":
        st.markdown(
            '<div class="splash-hero">'
            '<div class="star-layer-1">&#8203;</div>'
            '<div class="star-layer-2">&#8203;</div>'
            '<div class="star-layer-3">&#8203;</div>'
            '<div class="nebula-overlay">&#8203;</div>'
            '<div class="orb orb-1">&#8203;</div>'
            '<div class="orb orb-2">&#8203;</div>'
            '<div class="orb orb-3">&#8203;</div>'
            '<div class="orb orb-4">&#8203;</div>'
            '<div class="orb orb-5">&#8203;</div>'
            '<div class="shooting-star shooting-star-1">&#8203;</div>'
            '<div class="shooting-star shooting-star-2">&#8203;</div>'
            '<div class="noise-overlay">&#8203;</div>'
            '<div class="title-glow">&#8203;</div>'
            '<div class="splash-content">'
            '<div class="orbital-logo orbital-logo-lg">'
            '<span class="orbital-text">ORBITAL</span>'
            '<div class="orbital-ring orbital-ring-1"></div>'
            '<div class="orbital-ring orbital-ring-2"></div>'
            '<div class="orbital-ring orbital-ring-3"></div>'
            '<div class="orbital-particle orbital-particle-1"></div>'
            '<div class="orbital-particle orbital-particle-2"></div>'
            '<div class="orbital-particle orbital-particle-3"></div>'
            '</div>'
            '<p class="splash-subtitle" style="font-size:1.4rem; margin-top:1rem;">Company Comparison Tool</p>'
            '<div class="pill-row">'
            '<span class="feature-pill">Side-by-Side Analysis</span>'
            '<span class="feature-pill">Multiple Metrics</span>'
            '<span class="feature-pill">Price Performance</span>'
            '<span class="feature-pill">Radar Charts</span>'
            '</div>'
            '<div class="splash-stats">'
            '<div class="splash-stat"><div class="splash-stat-value">10</div><div class="splash-stat-label">Max Companies</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">15+</div><div class="splash-stat-label">Comparison Metrics</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">6</div><div class="splash-stat-label">Preset Groups</div></div>'
            '</div>'
            '</div>'
            '</div>',
            unsafe_allow_html=True,
        )
        
        st.markdown(
            '<div class="space-section">'
            '<div class="space-section-title">How It Works</div>'
            '<div class="step-grid">'
            '<div class="step-card"><div class="step-num">1</div><div class="step-label">Enter Tickers</div><div class="step-detail">Comma-separated list or load preset</div></div>'
            '<div class="step-card"><div class="step-num">2</div><div class="step-label">Compare</div><div class="step-detail">Side-by-side metrics comparison</div></div>'
            '<div class="step-card"><div class="step-num">3</div><div class="step-label">Visualize</div><div class="step-detail">Radar charts, bar charts, price performance</div></div>'
            '<div class="step-card"><div class="step-num">4</div><div class="step-label">Export</div><div class="step-detail">Download comparison as CSV</div></div>'
            '</div>'
            '<div class="space-section-title">Preset Comparisons</div>'
            '<div class="feature-grid">'
            '<div class="feature-card"><div class="feature-icon">&#128187;</div><div class="feature-title">FAANG</div><div class="feature-desc">META, AAPL, AMZN, NFLX, GOOGL</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127760;</div><div class="feature-title">Big Tech</div><div class="feature-desc">AAPL, MSFT, GOOGL, AMZN, META, NVDA</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127464;</div><div class="feature-title">Canadian Banks</div><div class="feature-desc">RY.TO, TD.TO, BNS.TO, BMO.TO, CM.TO</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128187;</div><div class="feature-title">Software/SaaS</div><div class="feature-desc">CRM, ADBE, NOW, WDAY, TEAM</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#9889;</div><div class="feature-title">Semiconductors</div><div class="feature-desc">NVDA, AMD, INTC, QCOM, AVGO</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128138;</div><div class="feature-title">Healthcare Giants</div><div class="feature-desc">JNJ, UNH, PFE, ABBV, MRK</div></div>'
            '</div>'
            '<p style="font-size:0.72rem; color:#9CA3AF; margin-top:2rem; text-align:center;">'
            'Enter multiple tickers separated by commas or select a preset in the sidebar<br>'
            'Compare up to 10 companies at once'
            '</p>'
            '</div>',
            unsafe_allow_html=True,
        )
    
    elif analysis_mode == "Merger Analysis":
        # Merger-specific splash
        st.markdown(
            '<div class="splash-hero">'
            '<div class="star-layer-1">&#8203;</div>'
            '<div class="star-layer-2">&#8203;</div>'
            '<div class="star-layer-3">&#8203;</div>'
            '<div class="nebula-overlay">&#8203;</div>'
            '<div class="orb orb-1">&#8203;</div>'
            '<div class="orb orb-2">&#8203;</div>'
            '<div class="orb orb-3">&#8203;</div>'
            '<div class="orb orb-4">&#8203;</div>'
            '<div class="orb orb-5">&#8203;</div>'
            '<div class="shooting-star shooting-star-1">&#8203;</div>'
            '<div class="shooting-star shooting-star-2">&#8203;</div>'
            '<div class="shooting-star shooting-star-3">&#8203;</div>'
            '<div class="shooting-star shooting-star-4">&#8203;</div>'
            '<div class="shooting-star shooting-star-5">&#8203;</div>'
            '<div class="noise-overlay">&#8203;</div>'
            '<div class="title-glow">&#8203;</div>'
            '<div class="splash-content">'
            '<div class="orbital-logo orbital-logo-lg">'
            '<span class="orbital-text">ORBITAL</span>'
            '<div class="orbital-ring orbital-ring-1"></div>'
            '<div class="orbital-ring orbital-ring-2"></div>'
            '<div class="orbital-ring orbital-ring-3"></div>'
            '<div class="orbital-particle orbital-particle-1"></div>'
            '<div class="orbital-particle orbital-particle-2"></div>'
            '<div class="orbital-particle orbital-particle-3"></div>'
            '</div>'
            '<p class="splash-subtitle" style="font-size:1.4rem; margin-top:1rem;">M&amp;A Simulator &amp; Deal Intelligence</p>'
            '<div class="pill-row">'
            '<span class="feature-pill">Pro Forma Analysis</span>'
            '<span class="feature-pill">Accretion/Dilution</span>'
            '<span class="feature-pill">Football Field</span>'
            '<span class="feature-pill">AI Insights</span>'
            '<span class="feature-pill">Risk Analysis</span>'
            '<span class="feature-pill">Deal Book PPTX</span>'
            '</div>'
            '<div class="splash-stats">'
            '<div class="splash-stat"><div class="splash-stat-value">12</div><div class="splash-stat-label">Dashboard Sections</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">10</div><div class="splash-stat-label">Deal Book Slides</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">4</div><div class="splash-stat-label">AI Analyses</div></div>'
            '</div>'
            '</div>'
            '</div>',
            unsafe_allow_html=True,
        )

        st.markdown(
            '<div class="space-section">'
            '<div class="space-section-title">How It Works</div>'
            '<div class="step-grid">'
            '<div class="step-card"><div class="step-num">1</div><div class="step-label">Enter Tickers</div><div class="step-detail">Acquirer + Target company tickers</div></div>'
            '<div class="step-card"><div class="step-num">2</div><div class="step-label">Set Assumptions</div><div class="step-detail">Premium, cash/stock mix, synergies</div></div>'
            '<div class="step-card"><div class="step-num">3</div><div class="step-label">Analyze Deal</div><div class="step-detail">Pro forma financials &amp; AI insights</div></div>'
            '<div class="step-card"><div class="step-num">4</div><div class="step-label">Download Book</div><div class="step-detail">10-slide deal book PowerPoint</div></div>'
            '</div>'
            '<div class="space-section-title">Analysis Features</div>'
            '<div class="feature-grid">'
            '<div class="feature-card"><div class="feature-icon">&#128200;</div><div class="feature-title">Pro Forma P&amp;L</div><div class="feature-desc">Combined income statement with synergy adjustments</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128202;</div><div class="feature-title">Accretion/Dilution</div><div class="feature-desc">Waterfall chart showing EPS bridge</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127919;</div><div class="feature-title">Football Field</div><div class="feature-desc">Multi-method valuation range analysis</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128176;</div><div class="feature-title">Sources &amp; Uses</div><div class="feature-desc">Classic IB deal structure breakdown</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128161;</div><div class="feature-title">AI Rationale</div><div class="feature-desc">Strategic fit and synergy assessment</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#9888;</div><div class="feature-title">Risk Analysis</div><div class="feature-desc">Antitrust, integration, financial risks</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127942;</div><div class="feature-title">Deal Grade</div><div class="feature-desc">AI-powered A-F deal verdict</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128196;</div><div class="feature-title">Deal Book</div><div class="feature-desc">10-slide professional PPTX export</div></div>'
            '</div>'
            '<p style="font-size:0.72rem; color:#9CA3AF; margin-top:2rem; text-align:center;">'
            'Enter Acquirer &amp; Target tickers in the sidebar to begin<br>'
            'Set <code style="color:#60A5FA;">OPENAI_API_KEY</code> for AI-powered deal insights'
            '</p>'
            '</div>',
            unsafe_allow_html=True,
        )
    else:
        st.markdown(
            '<div class="splash-hero">'
            '<div class="star-layer-1">&#8203;</div>'
            '<div class="star-layer-2">&#8203;</div>'
            '<div class="star-layer-3">&#8203;</div>'
            '<div class="nebula-overlay">&#8203;</div>'
            '<div class="orb orb-1">&#8203;</div>'
            '<div class="orb orb-2">&#8203;</div>'
            '<div class="orb orb-3">&#8203;</div>'
            '<div class="orb orb-4">&#8203;</div>'
            '<div class="orb orb-5">&#8203;</div>'
            '<div class="shooting-star shooting-star-1">&#8203;</div>'
            '<div class="shooting-star shooting-star-2">&#8203;</div>'
            '<div class="shooting-star shooting-star-3">&#8203;</div>'
            '<div class="shooting-star shooting-star-4">&#8203;</div>'
            '<div class="shooting-star shooting-star-5">&#8203;</div>'
            '<div class="noise-overlay">&#8203;</div>'
            '<div class="title-glow">&#8203;</div>'
            '<div class="splash-content">'
            '<div class="orbital-logo orbital-logo-lg">'
            '<span class="orbital-text">ORBITAL</span>'
            '<div class="orbital-ring orbital-ring-1"></div>'
            '<div class="orbital-ring orbital-ring-2"></div>'
            '<div class="orbital-ring orbital-ring-3"></div>'
            '<div class="orbital-particle orbital-particle-1"></div>'
            '<div class="orbital-particle orbital-particle-2"></div>'
            '<div class="orbital-particle orbital-particle-3"></div>'
            '</div>'
            '<p class="splash-subtitle" style="font-size:1.4rem; margin-top:1rem;">Company Intelligence &amp; Tear Sheet Generator</p>'
            '<div class="pill-row">'
            '<span class="feature-pill">Live Market Data</span>'
            '<span class="feature-pill">Wikipedia M&amp;A</span>'
            '<span class="feature-pill">Peer Analysis</span>'
            '<span class="feature-pill">AI Powered</span>'
            '<span class="feature-pill">Monte Carlo</span>'
            '<span class="feature-pill">LBO Model</span>'
            '<span class="feature-pill">Risk Matrix</span>'
            '<span class="feature-pill">Sum-of-Parts</span>'
            '<span class="feature-pill">Global Exchanges</span>'
            '</div>'
            '<div class="splash-stats">'
            '<div class="splash-stat"><div class="splash-stat-value">200+</div><div class="splash-stat-label">Data Points</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">9</div><div class="splash-stat-label">PPTX Slides</div></div>'
            '<div class="splash-stat"><div class="splash-stat-value">20+</div><div class="splash-stat-label">Exchanges</div></div>'
            '</div>'
            '</div>'
            '</div>',
            unsafe_allow_html=True,
        )

        # Step cards and feature grid in dark space-section
        st.markdown(
            '<div class="space-section">'
            '<div class="space-section-title">How It Works</div>'
            '<div class="step-grid">'
            '<div class="step-card"><div class="step-num">1</div><div class="step-label">Enter Ticker</div><div class="step-detail">Any global exchange &mdash; AAPL, RY.TO, NVDA.L</div></div>'
            '<div class="step-card"><div class="step-num">2</div><div class="step-label">Generate Profile</div><div class="step-detail">200+ data points pulled in real-time</div></div>'
            '<div class="step-card"><div class="step-num">3</div><div class="step-label">Explore Dashboard</div><div class="step-detail">Charts, peer comparison &amp; insights</div></div>'
            '<div class="step-card"><div class="step-num">4</div><div class="step-label">Download PPTX</div><div class="step-detail">9-slide IB-grade PowerPoint</div></div>'
            '</div>'
            '<div class="space-section-title">Platform Features</div>'
            '<div class="feature-grid">'
            '<div class="feature-card"><div class="feature-icon">&#128200;</div><div class="feature-title">Price &amp; Valuation</div><div class="feature-desc">Live prices, multiples, and historical charts</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128101;</div><div class="feature-title">Peer Comparison</div><div class="feature-desc">Side-by-side valuation vs industry peers</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128202;</div><div class="feature-title">Financial Statements</div><div class="feature-desc">Income, balance sheet, cash flow analysis</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#129309;</div><div class="feature-title">M&amp;A History</div><div class="feature-desc">Deal history scraped from Wikipedia</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127919;</div><div class="feature-title">Analyst Consensus</div><div class="feature-desc">Recommendations &amp; price targets</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128161;</div><div class="feature-title">AI Insights</div><div class="feature-desc">Powered by GPT (optional API key)</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#127760;</div><div class="feature-title">Global Exchanges</div><div class="feature-desc">TSX, LSE, JPX and more with local currencies</div></div>'
            '<div class="feature-card"><div class="feature-icon">&#128196;</div><div class="feature-title">PowerPoint Export</div><div class="feature-desc">8-slide professional presentation</div></div>'
            '</div>'
            '<p style="font-size:0.72rem; color:#9CA3AF; margin-top:2rem; text-align:center;">'
            'M&amp;A history scraped from Wikipedia &mdash; no API key needed<br>'
            'Set <code style="color:#60A5FA;">OPENAI_API_KEY</code> for enhanced insights'
            '</p>'
            '</div>',
            unsafe_allow_html=True,
        )
        
        # Market Overview Section
        st.markdown('<div style="height:1rem;"></div>', unsafe_allow_html=True)
        
        # Fetch indices once (cached)
        try:
            indices = _fetch_market_indices()
        except Exception:
            indices = None
        
        # Scrolling Market Ticker
        try:
            if indices:
                _render_market_ticker(indices)
        except Exception:
            pass
        
        st.markdown('<div style="height:0.5rem;"></div>', unsafe_allow_html=True)
        
        # Market Overview Cards
        try:
            if indices:
                st.markdown(
                    '<div style="background:rgba(37,99,235,0.05); border-radius:16px; padding:1.5rem; '
                    'border:1px solid rgba(37,99,235,0.15);">'
                    '<div style="font-size:0.8rem; font-weight:700; color:#60A5FA; text-transform:uppercase; '
                    'letter-spacing:1.5px; margin-bottom:1rem; text-align:center;">ğŸ“Š Market Overview</div>',
                    unsafe_allow_html=True,
                )
                
                idx_cols = st.columns(len(indices))
                for i, idx in enumerate(indices):
                    with idx_cols[i]:
                        color = "#10B981" if idx["change_pct"] >= 0 else "#EF4444"
                        arrow = "â–²" if idx["change_pct"] >= 0 else "â–¼"
                        st.markdown(
                            f'<div style="text-align:center;">'
                            f'<div style="font-size:0.7rem; color:#9CA3AF; font-weight:600;">{idx["name"]}</div>'
                            f'<div style="font-size:1.1rem; font-weight:700; color:#F9FAFB;">{idx["price"]:,.2f}</div>'
                            f'<div style="font-size:0.8rem; color:{color};">{arrow} {idx["change_pct"]:+.2f}%</div>'
                            f'</div>',
                            unsafe_allow_html=True,
                        )
                
                st.markdown('</div>', unsafe_allow_html=True)
        except Exception:
            pass  # Market overview is non-critical
        
        # Top Movers Section
        try:
            movers = _fetch_top_movers()
            if movers and (movers.get("gainers") or movers.get("losers")):
                _render_movers_cards(movers)
        except Exception:
            pass  # Top movers is non-critical
        
        # Sentiment Gauge + Earnings Calendar (side by side)
        sent_col, earn_col = st.columns(2)
        
        with sent_col:
            try:
                sentiment = _calculate_market_sentiment()
                _render_sentiment_gauge(sentiment)
            except Exception:
                pass
        
        with earn_col:
            try:
                earnings = _fetch_earnings_calendar()
                _render_earnings_calendar(earnings)
            except Exception:
                pass
        
        # Sector Heatmap + News Feed (side by side)
        heatmap_col, news_col = st.columns(2)
        
        with heatmap_col:
            try:
                sector_perf = _fetch_sector_performance()
                _render_sector_heatmap(sector_perf)
            except Exception:
                pass
        
        with news_col:
            try:
                news = _fetch_news_feed()
                _render_news_feed(news)
            except Exception:
                pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FOOTER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.markdown(
    '<div class="orbital-footer">'
    '<div class="orbital-footer-brand">ORBITAL</div>'
    '<div style="font-size:0.7rem; color:#9CA3AF; margin-top:0.2rem;">M&A Intelligence Platform</div>'
    '<div class="orbital-footer-links">'
    '<a href="https://github.com/rajkcho/profilebuilder" target="_blank">GitHub</a>'
    '<a href="#">Documentation</a>'
    '<a href="#">API</a>'
    '</div>'
    '<div class="orbital-footer-version">v6.0 Â· Built with Streamlit Â· Data from Yahoo Finance & Alpha Vantage</div>'
    '<div style="font-size:0.6rem; color:#6B7280; margin-top:0.5rem; max-width:600px; margin-left:auto; margin-right:auto;">'
    'This tool is for educational and research purposes only. Not financial advice. Data sourced from Yahoo Finance.'
    '</div>'
    '</div>',
    unsafe_allow_html=True,
)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NEW M&A FUNCTIONALITY - Due Diligence, Synergy, Integration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def render_due_diligence_page(ticker):
    """Due diligence checklist tracker."""
    import yfinance as yf
    
    st.markdown('<h2 style="text-align:center; margin-bottom:2rem;">ğŸ“‹ Due Diligence Tracker</h2>', unsafe_allow_html=True)
    
    # Fetch company data
    try:
        tk = yf.Ticker(ticker)
        info = tk.info or {}
        name = info.get("shortName", ticker)
    except:
        name = ticker
    
    st.markdown(f'<h3 style="text-align:center; color:#2563EB;">{name} ({ticker})</h3>', unsafe_allow_html=True)
    
    # DD Categories
    dd_categories = {
        "Financial": [
            "Revenue quality and sustainability",
            "EBITDA margins and trends",
            "Working capital requirements",
            "Debt structure and covenants",
            "Tax positions and exposures",
            "Historical financial statement audit",
            "Quality of earnings analysis"
        ],
        "Legal": [
            "Material contracts review",
            "Litigation and disputes",
            "Intellectual property ownership",
            "Regulatory compliance status",
            "Environmental liabilities",
            "Employment agreements",
            "Corporate structure and governance"
        ],
        "Commercial": [
            "Customer concentration analysis",
            "Market position and competitive dynamics",
            "Product/service differentiation",
            "Pricing power and trends",
            "Sales pipeline and backlog",
            "Customer churn and retention",
            "Go-to-market strategy"
        ],
        "Operational": [
            "Key personnel and retention risk",
            "Organizational structure",
            "Supplier relationships and dependencies",
            "Manufacturing/delivery capabilities",
            "Real estate and facilities",
            "Insurance coverage",
            "Business continuity planning"
        ],
        "Technology/IT": [
            "IT infrastructure and architecture",
            "Software systems and licenses",
            "Cybersecurity posture",
            "Data privacy compliance",
            "Technology debt assessment",
            "Integration complexity",
            "IT personnel and skills"
        ],
        "Human Resources": [
            "Organization chart and headcount",
            "Compensation and benefits",
            "Labor relations and union contracts",
            "Retention and severance obligations",
            "Cultural assessment",
            "HR policies and compliance",
            "Post-close staffing plan"
        ]
    }
    
    # Render checklist
    st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
    
    for category, items in dd_categories.items():
        with st.expander(f"**{category}** ({len(items)} items)", expanded=False):
            st.markdown(
                f'<div style="background:rgba(17, 24, 39, 0.6); padding:1rem; border-radius:8px; '
                f'border-left:3px solid #2563EB;">',
                unsafe_allow_html=True
            )
            
            for item in items:
                col1, col2, col3 = st.columns([3, 1, 1])
                with col1:
                    st.markdown(f'<div style="padding:0.5rem 0;">{item}</div>', unsafe_allow_html=True)
                with col2:
                    st.checkbox("Complete", key=f"dd_{category}_{item}", label_visibility="collapsed")
                with col3:
                    st.selectbox("Status", ["Not Started", "In Progress", "Complete", "N/A"], 
                                key=f"dd_status_{category}_{item}", label_visibility="collapsed")
            
            st.markdown('</div>', unsafe_allow_html=True)
    
    # Summary metrics
    st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
    
    total_items = sum(len(items) for items in dd_categories.values())
    st.markdown(
        f'<div style="background:rgba(16, 185, 129, 0.1); border:1px solid rgba(16, 185, 129, 0.3); '
        f'border-radius:12px; padding:1.5rem; text-align:center;">'
        f'<div style="font-size:0.875rem; color:#9CA3AF; margin-bottom:0.5rem;">Total DD Items</div>'
        f'<div style="font-size:2rem; font-weight:700; color:#10B981;">{total_items}</div>'
        f'<div style="font-size:0.75rem; color:#9CA3AF; margin-top:0.5rem;">Across {len(dd_categories)} categories</div>'
        f'</div>',
        unsafe_allow_html=True
    )


def render_synergy_model_page(acquirer, target):
    """Revenue and cost synergy estimation with bridge chart."""
    import yfinance as yf
    import plotly.graph_objects as go
    
    st.markdown('<h2 style="text-align:center; margin-bottom:2rem;">ğŸ”— Synergy Model</h2>', unsafe_allow_html=True)
    
    try:
        # Fetch data
        acq_tk = yf.Ticker(acquirer)
        tgt_tk = yf.Ticker(target)
        acq_info = acq_tk.info or {}
        tgt_info = tgt_tk.info or {}
        
        acq_name = acq_info.get("shortName", acquirer)
        tgt_name = tgt_info.get("shortName", target)
        
        # Financial metrics
        tgt_rev = tgt_info.get("totalRevenue", 0) / 1e9  # in billions
        tgt_ebitda = tgt_info.get("ebitda", 0) / 1e9
        tgt_opex = (tgt_rev * 0.3) if tgt_rev > 0 else 0  # Estimate if not available
        
        st.markdown(f'<h3 style="text-align:center; color:#2563EB;">{acq_name} acquiring {tgt_name}</h3>', unsafe_allow_html=True)
        
        # Synergy inputs
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### Cost Synergies")
            st.markdown(
                '<div style="background:rgba(17, 24, 39, 0.6); padding:1rem; border-radius:8px;">',
                unsafe_allow_html=True
            )
            cost_syn_pct = st.slider("OpEx Reduction (%)", 0, 40, 15, 1, key="syn_cost")
            cost_syn_years = st.slider("Realization Period (years)", 1, 5, 3, 1, key="syn_cost_years")
            
            cost_syn_annual = tgt_opex * (cost_syn_pct / 100)
            
            st.markdown(
                f'<div style="margin-top:1rem; padding:1rem; background:rgba(16, 185, 129, 0.1); '
                f'border-radius:8px; text-align:center;">'
                f'<div style="font-size:0.75rem; color:#9CA3AF;">Annual Run-Rate Savings</div>'
                f'<div style="font-size:1.5rem; font-weight:700; color:#10B981;">${cost_syn_annual:.2f}B</div>'
                f'</div>',
                unsafe_allow_html=True
            )
            st.markdown('</div>', unsafe_allow_html=True)
        
        with col2:
            st.markdown("### Revenue Synergies")
            st.markdown(
                '<div style="background:rgba(17, 24, 39, 0.6); padding:1rem; border-radius:8px;">',
                unsafe_allow_html=True
            )
            rev_syn_pct = st.slider("Revenue Uplift (%)", 0, 15, 3, 1, key="syn_rev")
            rev_syn_margin = st.slider("Incremental Margin (%)", 20, 80, 50, 5, key="syn_margin")
            rev_syn_years = st.slider("Realization Period (years)", 1, 5, 4, 1, key="syn_rev_years")
            
            rev_syn_annual = (tgt_rev * (rev_syn_pct / 100)) * (rev_syn_margin / 100)
            
            st.markdown(
                f'<div style="margin-top:1rem; padding:1rem; background:rgba(37, 99, 235, 0.1); '
                f'border-radius:8px; text-align:center;">'
                f'<div style="font-size:0.75rem; color:#9CA3AF;">Annual Run-Rate EBITDA</div>'
                f'<div style="font-size:1.5rem; font-weight:700; color:#2563EB;">${rev_syn_annual:.2f}B</div>'
                f'</div>',
                unsafe_allow_html=True
            )
            st.markdown('</div>', unsafe_allow_html=True)
        
        # Total synergies
        total_syn = cost_syn_annual + rev_syn_annual
        
        st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
        st.markdown(
            f'<div style="background:rgba(17, 24, 39, 0.7); backdrop-filter:blur(16px); '
            f'border:2px solid #2563EB; border-radius:12px; padding:2rem; text-align:center;">'
            f'<div style="font-size:1rem; color:#9CA3AF; margin-bottom:0.5rem;">Total Annual Run-Rate Synergies</div>'
            f'<div style="font-size:3rem; font-weight:900; color:#F9FAFB;">${total_syn:.2f}B</div>'
            f'<div style="font-size:0.875rem; color:#9CA3AF; margin-top:0.5rem;">'
            f'Cost: ${cost_syn_annual:.2f}B | Revenue: ${rev_syn_annual:.2f}B</div>'
            f'</div>',
            unsafe_allow_html=True
        )
        
        # Bridge Chart
        st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
        st.markdown("### Synergy Bridge")
        
        categories = ["Target<br>Standalone<br>EBITDA", "Cost<br>Synergies", "Revenue<br>Synergies", "Pro Forma<br>EBITDA"]
        values = [tgt_ebitda, cost_syn_annual, rev_syn_annual, tgt_ebitda + total_syn]
        
        fig = go.Figure()
        fig.add_trace(go.Waterfall(
            x=categories,
            y=[tgt_ebitda, cost_syn_annual, rev_syn_annual, total_syn],
            measure=["absolute", "relative", "relative", "total"],
            text=[f"${v:.2f}B" for v in [tgt_ebitda, cost_syn_annual, rev_syn_annual, tgt_ebitda + total_syn]],
            textposition="outside",
            connector={"line": {"color": "rgba(255, 255, 255, 0.2)"}},
            increasing={"marker": {"color": "#10B981"}},
            decreasing={"marker": {"color": "#EF4444"}},
            totals={"marker": {"color": "#2563EB"}}
        ))
        
        fig.update_layout(
            title="EBITDA Synergy Bridge",
            paper_bgcolor='rgba(0,0,0,0)',
            plot_bgcolor='rgba(0,0,0,0)',
            font=dict(color='#E5E7EB', size=12),
            height=500,
            showlegend=False
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
    except Exception as e:
        st.error(f"Error loading synergy model: {e}")


def render_integration_plan_page(acquirer, target):
    """100-day integration timeline with milestones."""
    import plotly.graph_objects as go
    from datetime import datetime, timedelta
    
    st.markdown('<h2 style="text-align:center; margin-bottom:2rem;">ğŸ“… 100-Day Integration Plan</h2>', unsafe_allow_html=True)
    
    st.markdown(f'<h3 style="text-align:center; color:#2563EB;">{acquirer} + {target}</h3>', unsafe_allow_html=True)
    
    # Integration phases
    phases = {
        "Day 1-30: Foundation": [
            "Announce deal to employees",
            "Establish integration management office (IMO)",
            "Identify and protect key talent",
            "Communicate customer retention plan",
            "Freeze hiring at target (except critical roles)",
            "Assess IT systems and data migration needs",
            "Align on combined organizational structure"
        ],
        "Day 31-60: Execution": [
            "Begin IT systems integration",
            "Consolidate facilities where appropriate",
            "Harmonize compensation and benefits",
            "Launch cross-functional integration teams",
            "Execute customer migration/retention plan",
            "Realize quick-win cost synergies",
            "Align on combined sales strategy"
        ],
        "Day 61-100: Optimization": [
            "Complete core IT system integrations",
            "Achieve full organizational alignment",
            "Launch combined product/service offerings",
            "Realize revenue synergy initiatives",
            "Complete facility consolidations",
            "Sunset redundant systems and processes",
            "Measure synergy achievement vs. plan"
        ]
    }
    
    # Render phases
    for phase, milestones in phases.items():
        with st.expander(f"**{phase}**", expanded=True):
            st.markdown(
                '<div style="background:rgba(17, 24, 39, 0.6); padding:1rem; border-radius:8px;">',
                unsafe_allow_html=True
            )
            
            for milestone in milestones:
                col1, col2, col3 = st.columns([3, 1, 1])
                with col1:
                    st.markdown(f'<div style="padding:0.5rem 0; color:#E5E7EB;">{milestone}</div>', unsafe_allow_html=True)
                with col2:
                    st.selectbox("Owner", ["IMO", "Finance", "HR", "IT", "Ops", "Sales"], 
                                key=f"owner_{milestone}", label_visibility="collapsed")
                with col3:
                    st.selectbox("Status", ["Not Started", "On Track", "At Risk", "Complete"], 
                                key=f"status_{milestone}", label_visibility="collapsed")
            
            st.markdown('</div>', unsafe_allow_html=True)
    
    # Timeline Gantt
    st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
    st.markdown("### Integration Timeline")
    
    today = datetime.now()
    
    fig = go.Figure()
    
    fig.add_trace(go.Bar(
        y=["Phase 1: Foundation", "Phase 2: Execution", "Phase 3: Optimization"],
        x=[30, 30, 40],
        orientation='h',
        marker=dict(
            color=['#2563EB', '#10B981', '#F59E0B'],
            line=dict(color='rgba(255,255,255,0.2)', width=1)
        ),
        text=["Days 1-30", "Days 31-60", "Days 61-100"],
        textposition='inside',
        hovertemplate='%{y}<br>Duration: %{x} days<extra></extra>'
    ))
    
    fig.update_layout(
        title="100-Day Integration Roadmap",
        xaxis_title="Days Post-Close",
        paper_bgcolor='rgba(0,0,0,0)',
        plot_bgcolor='rgba(0,0,0,0)',
        font=dict(color='#E5E7EB', size=12),
        height=400,
        showlegend=False,
        xaxis=dict(gridcolor='rgba(255,255,255,0.1)'),
        yaxis=dict(gridcolor='rgba(255,255,255,0.1)')
    )
    
    st.plotly_chart(fig, use_container_width=True)


def render_deal_structure_page(acquirer, target, equity_value):
    """Deal structuring optimizer - stock vs cash vs mixed."""
    import plotly.graph_objects as go
    
    st.markdown('<h2 style="text-align:center; margin-bottom:2rem;">ğŸ’¼ Deal Structure Optimizer</h2>', unsafe_allow_html=True)
    
    st.markdown(f'<h3 style="text-align:center; color:#2563EB;">{acquirer} acquiring {target}</h3>', unsafe_allow_html=True)
    st.markdown(f'<p style="text-align:center; color:#9CA3AF;">Target Equity Value: ${equity_value:,.0f}M</p>', unsafe_allow_html=True)
    
    # Structure options
    st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns(3)
    
    structures = []
    
    with col1:
        st.markdown(
            '<div style="background:rgba(17, 24, 39, 0.6); border:1px solid rgba(16, 185, 129, 0.3); '
            'border-radius:12px; padding:1.5rem;">'
            '<h4 style="color:#10B981; text-align:center;">100% Cash</h4>',
            unsafe_allow_html=True
        )
        cash_pct_1 = 100
        stock_pct_1 = 0
        st.markdown(f'<p style="text-align:center; font-size:0.875rem; color:#9CA3AF;">Cash: ${equity_value:.0f}M</p>', unsafe_allow_html=True)
        st.markdown(f'<p style="text-align:center; font-size:0.875rem; color:#9CA3AF;">Stock: $0M</p>', unsafe_allow_html=True)
        
        st.markdown("**Pros:**", unsafe_allow_html=True)
        st.markdown("âœ“ Certainty for sellers<br>âœ“ No dilution<br>âœ“ Clean transaction", unsafe_allow_html=True)
        st.markdown("**Cons:**", unsafe_allow_html=True)
        st.markdown("âœ— Requires financing<br>âœ— Higher immediate cost<br>âœ— Tax inefficient for sellers", unsafe_allow_html=True)
        
        st.markdown('</div>', unsafe_allow_html=True)
        structures.append({"name": "100% Cash", "cash": cash_pct_1, "stock": stock_pct_1})
    
    with col2:
        st.markdown(
            '<div style="background:rgba(17, 24, 39, 0.6); border:1px solid rgba(37, 99, 235, 0.3); '
            'border-radius:12px; padding:1.5rem;">'
            '<h4 style="color:#2563EB; text-align:center;">50/50 Mixed</h4>',
            unsafe_allow_html=True
        )
        cash_pct_2 = 50
        stock_pct_2 = 50
        st.markdown(f'<p style="text-align:center; font-size:0.875rem; color:#9CA3AF;">Cash: ${equity_value * 0.5:.0f}M</p>', unsafe_allow_html=True)
        st.markdown(f'<p style="text-align:center; font-size:0.875rem; color:#9CA3AF;">Stock: ${equity_value * 0.5:.0f}M</p>', unsafe_allow_html=True)
        
        st.markdown("**Pros:**", unsafe_allow_html=True)
        st.markdown("âœ“ Balanced approach<br>âœ“ Shares risk/reward<br>âœ“ Moderate dilution", unsafe_allow_html=True)
        st.markdown("**Cons:**", unsafe_allow_html=True)
        st.markdown("âœ— Complex structuring<br>âœ— Some dilution<br>âœ— Market risk on stock portion", unsafe_allow_html=True)
        
        st.markdown('</div>', unsafe_allow_html=True)
        structures.append({"name": "50/50 Mixed", "cash": cash_pct_2, "stock": stock_pct_2})
    
    with col3:
        st.markdown(
            '<div style="background:rgba(17, 24, 39, 0.6); border:1px solid rgba(245, 158, 11, 0.3); '
            'border-radius:12px; padding:1.5rem;">'
            '<h4 style="color:#F59E0B; text-align:center;">100% Stock</h4>',
            unsafe_allow_html=True
        )
        cash_pct_3 = 0
        stock_pct_3 = 100
        st.markdown(f'<p style="text-align:center; font-size:0.875rem; color:#9CA3AF;">Cash: $0M</p>', unsafe_allow_html=True)
        st.markdown(f'<p style="text-align:center; font-size:0.875rem; color:#9CA3AF;">Stock: ${equity_value:.0f}M</p>', unsafe_allow_html=True)
        
        st.markdown("**Pros:**", unsafe_allow_html=True)
        st.markdown("âœ“ Preserve cash<br>âœ“ Tax-deferred for sellers<br>âœ“ Aligns interests", unsafe_allow_html=True)
        st.markdown("**Cons:**", unsafe_allow_html=True)
        st.markdown("âœ— Dilutive<br>âœ— Market risk<br>âœ— Potential for seller resistance", unsafe_allow_html=True)
        
        st.markdown('</div>', unsafe_allow_html=True)
        structures.append({"name": "100% Stock", "cash": cash_pct_3, "stock": stock_pct_3})
    
    # Comparison chart
    st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
    st.markdown("### Structure Comparison")
    
    fig = go.Figure()
    
    for struct in structures:
        fig.add_trace(go.Bar(
            name=struct["name"],
            x=["Cash", "Stock"],
            y=[struct["cash"], struct["stock"]],
            text=[f"{struct['cash']}%", f"{struct['stock']}%"],
            textposition='inside',
            marker=dict(
                color=['#10B981', '#2563EB'] if struct["cash"] > struct["stock"] 
                      else ['#2563EB', '#F59E0B'] if struct["cash"] == struct["stock"]
                      else ['#F59E0B', '#2563EB']
            )
        ))
    
    fig.update_layout(
        barmode='group',
        paper_bgcolor='rgba(0,0,0,0)',
        plot_bgcolor='rgba(0,0,0,0)',
        font=dict(color='#E5E7EB', size=12),
        height=400,
        xaxis=dict(gridcolor='rgba(255,255,255,0.1)'),
        yaxis=dict(gridcolor='rgba(255,255,255,0.1)', title="Percentage")
    )
    
    st.plotly_chart(fig, use_container_width=True)


def render_fairness_opinion_page(ticker, offer_price):
    """Fairness opinion summary with valuation ranges."""
    import yfinance as yf
    import plotly.graph_objects as go
    
    st.markdown('<h2 style="text-align:center; margin-bottom:2rem;">ğŸ“Š Fairness Opinion</h2>', unsafe_allow_html=True)
    
    try:
        tk = yf.Ticker(ticker)
        info = tk.info or {}
        name = info.get("shortName", ticker)
        current_price = info.get("currentPrice") or info.get("regularMarketPrice", 0)
        
        st.markdown(f'<h3 style="text-align:center; color:#2563EB;">{name} ({ticker})</h3>', unsafe_allow_html=True)
        st.markdown(f'<p style="text-align:center; color:#9CA3AF;">Offer Price: ${offer_price:.2f} | Current: ${current_price:.2f}</p>', unsafe_allow_html=True)
        
        # Valuation methodologies
        st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
        
        # Simplified valuation ranges (in reality would use DCF, comps, etc.)
        methodologies = {
            "DCF Analysis": (current_price * 0.85, current_price * 1.25),
            "Public Comps": (current_price * 0.90, current_price * 1.15),
            "Precedent Transactions": (current_price * 1.10, current_price * 1.40),
            "52-Week Range": (current_price * 0.80, current_price * 1.10),
        }
        
        # Football field chart
        fig = go.Figure()
        
        y_pos = 0
        for method, (low, high) in methodologies.items():
            # Determine color based on if offer is in range
            if low <= offer_price <= high:
                color = '#10B981'  # Green if in range
            elif offer_price < low:
                color = '#EF4444'  # Red if below
            else:
                color = '#2563EB'  # Blue if above
            
            fig.add_trace(go.Scatter(
                x=[low, high],
                y=[y_pos, y_pos],
                mode='lines+markers',
                name=method,
                line=dict(color=color, width=8),
                marker=dict(size=10, color=color),
                text=[f"${low:.2f}", f"${high:.2f}"],
                textposition="top center",
                hovertemplate=f'{method}<br>Low: ${low:.2f}<br>High: ${high:.2f}<extra></extra>'
            ))
            
            y_pos += 1
        
        # Add offer price line
        fig.add_vline(x=offer_price, line_dash="dash", line_color="#F59E0B", line_width=3, 
                     annotation_text=f"Offer: ${offer_price:.2f}", annotation_position="top")
        
        fig.update_layout(
            title="Valuation Football Field",
            xaxis_title="Price per Share ($)",
            yaxis=dict(
                tickmode='array',
                tickvals=list(range(len(methodologies))),
                ticktext=list(methodologies.keys())
            ),
            paper_bgcolor='rgba(0,0,0,0)',
            plot_bgcolor='rgba(0,0,0,0)',
            font=dict(color='#E5E7EB', size=12),
            height=500,
            showlegend=False,
            xaxis=dict(gridcolor='rgba(255,255,255,0.1)'),
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
        # Fairness conclusion
        st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
        
        # Calculate if fair
        avg_low = sum(v[0] for v in methodologies.values()) / len(methodologies)
        avg_high = sum(v[1] for v in methodologies.values()) / len(methodologies)
        
        is_fair = avg_low <= offer_price <= avg_high
        
        if is_fair:
            st.markdown(
                f'<div style="background:rgba(16, 185, 129, 0.15); border:2px solid #10B981; '
                f'border-radius:12px; padding:2rem; text-align:center;">'
                f'<h3 style="color:#10B981;">âœ“ Opinion: FAIR</h3>'
                f'<p style="color:#E5E7EB; font-size:1rem;">The offer price of <strong>${offer_price:.2f}</strong> '
                f'falls within the range of valuation methodologies applied and is considered '
                f'<strong>fair from a financial point of view</strong> to the shareholders.</p>'
                f'</div>',
                unsafe_allow_html=True
            )
        else:
            st.markdown(
                f'<div style="background:rgba(239, 68, 68, 0.15); border:2px solid #EF4444; '
                f'border-radius:12px; padding:2rem; text-align:center;">'
                f'<h3 style="color:#EF4444;">âœ— Opinion: REQUIRES REVIEW</h3>'
                f'<p style="color:#E5E7EB; font-size:1rem;">The offer price of <strong>${offer_price:.2f}</strong> '
                f'falls outside the typical range suggested by valuation methodologies. '
                f'<strong>Further analysis recommended.</strong></p>'
                f'</div>',
                unsafe_allow_html=True
            )
        
        # Key assumptions
        st.markdown('<div style="margin-top:2rem;"></div>', unsafe_allow_html=True)
        with st.expander("**Key Assumptions & Limitations**"):
            st.markdown("""
            - **DCF Analysis**: 5-year projection period, WACC 8-10%, terminal growth 3%
            - **Public Comps**: Selected based on industry, size, and business model similarity  
            - **Precedent Transactions**: Transactions within last 3 years in same sector
            - **Market Conditions**: Based on current market multiples and trading levels
            - **Limitations**: This is a simplified analysis. Full fairness opinions include extensive due diligence, management interviews, and detailed financial modeling.
            """)
    
    except Exception as e:
        st.error(f"Error generating fairness opinion: {e}")

